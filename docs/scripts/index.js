var i=document.getElementById("Identifiant"),r=document.getElementById("Code"),e=document.getElementById("remarque"),t=document.getElementById("connect"),n=!0,a=Number(recuperer("nb_clics")?recuperer("nb_clics"):0);function s(){return a>1&&(n=!1),a+=1,stocker("nb_clics",a),recuperer("date_heure_depassement")?(date_heure_delai_attente_ok=moment(recuperer("date_heure_depassement")).add(30,"seconds"),date_heure_maintenant=moment(maintenant()),delai_attente_ok=date_heure_maintenant>date_heure_delai_attente_ok):delai_attente_ok=a<=5,n||delai_attente_ok?(recuperer("date_heure_depassement")&&(a=0),effacer("date_heure_depassement"),f(""),chargement(!0),""===I()||""===r.value?(f("L'identifiant et le code d'accès ne peuvent pas être vides pour vous connecter.","",""),!1):void o("Administration").then(t=>{null!==t&&t.length>0?c(t)?est_en_maintenance().then(e=>{if("oui"===e){if("non"===renvoyer_resultat(t).droit_hors_maintenance)return f("La plateforme SEKOOLY est actuellement en maintenance: veuillez réessayer plus tard.",_(t,"Classe"),""),0;d(t)}else d(t)}):f("Code d'accès erroné: veuillez réessayer. <br> Si vous avez perdu votre code d'accès merci de contacter l'Administration de votre établissement.",_(t,"Role"),"Administration"):est_en_maintenance().then(e=>{if("oui"===e)return f("La plateforme SEKOOLY est actuellement en maintenance: veuillez réessayer plus tard.","introuvable",""),!0;o("Profs").then(e=>{null!==e&&e.length>0?c(e)?d(e):f("Code d'accès erroné: veuillez réessayer. <br> Si vous avez perdu votre code d'accès merci de contacter l'Administration de votre établissement.","Prof","Profs"):o("Eleves").then(e=>{null!==e&&e.length>0?l(e)?c(e)?d(e):f("Code d'accès erroné: veuillez réessayer. <br> Si vous avez perdu votre code d'accès merci de contacter l'Administration de votre établissement.",_(e,"Classe"),"Eleves"):(contact_economat=data_etablissement.contact_economat?" au "+data_etablissement.contact_economat:"",f("Frais de scolarité non régularisés. <br> Veuillez contacter l'Économat ou de l'Administration de votre établissement"+contact_economat+".",_(e,"Classe"),"Eleves")):f("Identifiant '"+I()+"' non reconnu: veuillez réessayer. <br> Si vous avez perdu votre identifiant merci de contacter l'Administration de votre établissement.","introuvable","introuvable")})})})})):(stocker("date_heure_depassement",maintenant()),date_heure_delai_attente_ok=moment(recuperer("date_heure_depassement")).add(30,"seconds"),affichage_date_heure_depassement=moment(date_heure_delai_attente_ok._d).format("DD/MM/YYYY HH:mm:ss"),chargement(!1),f("Vous avez cliqué trop de fois le bouton de connexion.<br>Merci de réessayer dans 30 secondes, soit le "+affichage_date_heure_depassement+".<br><br><i>NB: Changer l'heure de votre système ne vous permettra PAS d'accéder plus tôt à la plateforme.</i>","","",!0),!1)}function o(e){return rechercher(e,"Identifiant",i.value)}function c(e){var t=renvoyer_resultat(e),n=(hasher(t.Code),hasher(r.value));return"ok"===t.code_hash?n===t.Code:t.Code===r.value}function l(e){return"oui"===renvoyer_resultat(e).Ecolage_OK}function _(e,t){return renvoyer_resultat(e)[t]}function u(e,t,n,r,a){return url=racine_initiale+e+"?"+t+"=eq."+n+"&"+api_initial+ordonner(e),url=r?url+"&select="+r:url,url=a?url+"&limit="+a:url,get_resultat_asynchrone(url)}function d(e){var t=renvoyer_resultat(e),n=(t.Classe,t.type),r=t.Cycle,a=t.Classe,s=t.code_hash,o=hasher(t.Code);null!=s&&"nok"!==s||m(n,i,o,s),v(n,r,a).then(e=>{lignes_matieres=e,null!==lignes_matieres&&"object"==typeof lignes_matieres&&(lignes_matieres=Object.values(lignes_matieres)),stocker("identifiant_courant",I()),stocker("mes_donnees",JSON.stringify(t)),stocker("mes_matieres",JSON.stringify(lignes_matieres)),stocker("mon_type",n),u("API","id","1").then(e=>{les_API=renvoyer_resultat(e),"Eleves"===n?stocker("API_KEY_DEVOIR",les_API.API_KEY_DEVOIR):(stocker("API_KEY_DELETE",les_API.API_KEY_DELETE),stocker("API_KEY_RENAME",les_API.API_KEY_RENAME),stocker("API_KEY_UPLOAD",les_API.API_KEY_UPLOAD)),rechercher("ID_RENDUS","Cycle",r,"dossier_rendus_cycle").then(e=>{stocker("dossier_rendus_cycle",e[0].dossier_rendus_cycle)}),mon_role=init_mon_role(),envoyer_log(t.Identifiant,"Connexion valide",a,mon_role,!0)})}),chargement(!1)}function m(e,t,n,r){if(void 0===r||"nok"===r||null===r){var a=e,s=I(),o={Code:n,code_hash:"ok"};console.log(o),actualiser(a,"Identifiant",s,o)}}function f(e,t,n,r){$("#remarque")[0].innerHTML=e,chargement(!1),""!==e&&(mon_role=init_mon_role(),r||envoyer_log(I(),e,t,mon_role))}async function v(e,t,n){if("Administration"===e)return rechercher("Matieres","Cycle",t).then(e=>e);if("Profs"===e){les_classes_matieres=n.split(";"),un_retour=[];for(var r=0;r<les_classes_matieres.length;r++)await rechercher_contenant_motif("Matieres","Classe_Matiere",les_classes_matieres[r],"",1).then(e=>{e.length>0&&(e=renvoyer_resultat(e),un_retour.push(e))});return un_retour}return"Eleves"===e?(un_retour=await rechercher("Matieres","Classe",n),console.log(un_retour),un_retour):void 0}function h(){chargement(!1),mettre_mon_mode(),f(""),g(),A(),mettre_le_contact_etablissement(),y(),p(),E()}function E(){"null"===$("#logo_etablissement")[0].src.split("/").pop()&&$("#logo_etablissement").remove()}function p(){effacer("API_KEY_DELETE"),effacer("API_KEY_DEVOIR"),effacer("API_KEY_RENAME"),effacer("API_KEY_UPLOAD"),effacer("dossier_chargé"),effacer("dossier_rendus_cycle")}function y(){document.addEventListener("keydown",function(e){13===e.keyCode&&s()})}function g(){stocker("mes_donnees",""),stocker("mes_matieres",""),effacer("mes_calendriers")}function A(){i.value=recuperer("identifiant_courant"),""!==i.value?r.focus():i.focus()}function I(){return i.value.trim().toLowerCase()}$("#connect").on("click",function(e){s()}),h();