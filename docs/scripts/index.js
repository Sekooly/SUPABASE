var identifiant=document.getElementById("Identifiant"),code=document.getElementById("Code"),remarque=document.getElementById("remarque"),connect=document.getElementById("connect"),est_premier_clic=!0,nb_clics=Number(recuperer("nb_clics")?recuperer("nb_clics"):0);function se_connecter(){return nb_clics>1&&(est_premier_clic=!1),nb_clics+=1,stocker("nb_clics",nb_clics),recuperer("date_heure_depassement")?(date_heure_delai_attente_ok=moment(recuperer("date_heure_depassement")).add(30,"seconds"),date_heure_maintenant=moment(maintenant()),delai_attente_ok=date_heure_maintenant>date_heure_delai_attente_ok):delai_attente_ok=nb_clics<=5,est_premier_clic||delai_attente_ok?(recuperer("date_heure_depassement")&&(nb_clics=0),effacer("date_heure_depassement"),actualiser_remarque(""),chargement(!0),""===valeur_identifiant()||""===code.value?(actualiser_remarque("L'identifiant et le code d'accès ne peuvent pas être vides pour vous connecter.","",""),!1):void me_chercher_dans_la_table("Administration").then(e=>{null!==e&&e.length>0?bon_mdp(e)?est_en_maintenance().then(r=>{if("oui"===r){if("non"===renvoyer_resultat(e).droit_hors_maintenance)return actualiser_remarque("La plateforme SEKOOLY est actuellement en maintenance: veuillez réessayer plus tard.",recuperer_donnee(e,"Classe"),""),0;recuperer_mes_donnees(e)}else recuperer_mes_donnees(e)}):actualiser_remarque("Code d'accès erroné: veuillez réessayer. <br> Si vous avez perdu votre code d'accès merci de contacter l'Administration de votre établissement.",recuperer_donnee(e,"Role"),"Administration"):est_en_maintenance().then(e=>{if("oui"===e)return actualiser_remarque("La plateforme SEKOOLY est actuellement en maintenance: veuillez réessayer plus tard.","introuvable",""),!0;me_chercher_dans_la_table("Profs").then(e=>{null!==e&&e.length>0?bon_mdp(e)?recuperer_mes_donnees(e):actualiser_remarque("Code d'accès erroné: veuillez réessayer. <br> Si vous avez perdu votre code d'accès merci de contacter l'Administration de votre établissement.","Prof","Profs"):me_chercher_dans_la_table("Eleves").then(e=>{null!==e&&e.length>0?bon_ecolage(e)?bon_mdp(e)?recuperer_mes_donnees(e):actualiser_remarque("Code d'accès erroné: veuillez réessayer. <br> Si vous avez perdu votre code d'accès merci de contacter l'Administration de votre établissement.",recuperer_donnee(e,"Classe"),"Eleves"):(contact_economat=data_etablissement.contact_economat?" au "+data_etablissement.contact_economat:"",actualiser_remarque("Frais de scolarité non régularisés. <br> Veuillez contacter l'Économat ou de l'Administration de votre établissement"+contact_economat+".",recuperer_donnee(e,"Classe"),"Eleves")):actualiser_remarque("Identifiant '"+valeur_identifiant()+"' non reconnu: veuillez réessayer. <br> Si vous avez perdu votre identifiant merci de contacter l'Administration de votre établissement.","introuvable","introuvable")})})})})):(stocker("date_heure_depassement",maintenant()),date_heure_delai_attente_ok=moment(recuperer("date_heure_depassement")).add(30,"seconds"),affichage_date_heure_depassement=moment(date_heure_delai_attente_ok._d).format("DD/MM/YYYY HH:mm:ss"),chargement(!1),actualiser_remarque("Vous avez cliqué trop de fois le bouton de connexion.<br>Merci de réessayer dans 30 secondes, soit le "+affichage_date_heure_depassement+".<br><br><i>NB: Changer l'heure de votre système ne vous permettra PAS d'accéder plus tôt à la plateforme.</i>","","",!0),!1)}function me_chercher_dans_la_table(e){return rechercher(e,"Identifiant",identifiant.value)}function bon_mdp(e){var r=renvoyer_resultat(e),n=(hasher(r.Code),hasher(code.value));return"ok"===r.code_hash?n===r.Code:r.Code===code.value}function bon_ecolage(e){return"oui"===renvoyer_resultat(e).Ecolage_OK}function recuperer_donnee(e,r){return renvoyer_resultat(e)[r]}function rechercher_dans_gestionnaire(e,r,n,t,a){return url=racine_initiale+e+"?"+r+"=eq."+n+"&"+api_initial+ordonner(e),url=t?url+"&select="+t:url,url=a?url+"&limit="+a:url,get_resultat_asynchrone(url)}function recuperer_mes_donnees(e){var r=renvoyer_resultat(e),n=(r.Classe,r.type),t=r.Cycle,a=r.Classe,s=r.code_hash,i=hasher(r.Code);null!=s&&"nok"!==s||actualiser_en_hash_code(n,identifiant,i,s),chercher_mes_matieres(n,t,a).then(e=>{lignes_matieres=e,null!==lignes_matieres&&"object"==typeof lignes_matieres&&(lignes_matieres=Object.values(lignes_matieres)),stocker("identifiant_courant",valeur_identifiant()),stocker("mes_donnees",JSON.stringify(r)),stocker("mes_matieres",JSON.stringify(lignes_matieres)),stocker("mon_type",n),rechercher_dans_gestionnaire("API","id","1").then(e=>{les_API=renvoyer_resultat(e),"Eleves"===n?stocker("API_KEY_DEVOIR",les_API.API_KEY_DEVOIR):(stocker("API_KEY_DELETE",les_API.API_KEY_DELETE),stocker("API_KEY_RENAME",les_API.API_KEY_RENAME),stocker("API_KEY_UPLOAD",les_API.API_KEY_UPLOAD)),rechercher("ID_RENDUS","Cycle",t,"dossier_rendus_cycle").then(e=>{stocker("dossier_rendus_cycle",e[0].dossier_rendus_cycle)}),mon_role=init_mon_role(),envoyer_log(r.Identifiant,"Connexion valide",a,mon_role,!0)})}),chargement(!1)}function actualiser_en_hash_code(e,r,n,t){if(void 0===t||"nok"===t||null===t){var a=e,s=valeur_identifiant(),i={Code:n,code_hash:"ok"};console.log(i),actualiser(a,"Identifiant",s,i)}}function actualiser_remarque(e,r,n,t){$("#remarque")[0].innerHTML=e,chargement(!1),""!==e&&(mon_role=init_mon_role(),t||envoyer_log(valeur_identifiant(),e,r,mon_role))}async function chercher_mes_matieres(e,r,n){if("Administration"===e)return rechercher("Matieres","Cycle",r).then(e=>e);if("Profs"===e){les_classes_matieres=n.split(";"),un_retour=[];for(var t=0;t<les_classes_matieres.length;t++)await rechercher_contenant_motif("Matieres","Classe_Matiere",les_classes_matieres[t],"",1).then(e=>{e.length>0&&(e=renvoyer_resultat(e),un_retour.push(e))});return un_retour}return"Eleves"===e?(un_retour=await rechercher("Matieres","Classe",n),console.log(un_retour),un_retour):void 0}function initialisation(){chargement(!1),mettre_mon_mode(),actualiser_remarque(""),sans_donnees_initiales(),mettre_le_bon_focus(),mettre_le_contact_etablissement(),sur_valider_se_connecter(),aucun_API(),sans_logo_vide()}function sans_logo_vide(){"null"===$("#logo_etablissement")[0].src.split("/").pop()&&$("#logo_etablissement").remove()}function aucun_API(){effacer("API_KEY_DELETE"),effacer("API_KEY_DEVOIR"),effacer("API_KEY_RENAME"),effacer("API_KEY_UPLOAD"),effacer("dossier_chargé"),effacer("dossier_rendus_cycle")}function sur_valider_se_connecter(){document.addEventListener("keydown",function(e){13===e.keyCode&&se_connecter()})}function sans_donnees_initiales(){stocker("mes_donnees",""),stocker("mes_matieres",""),effacer("mes_calendriers")}function mettre_le_bon_focus(){identifiant.value=recuperer("identifiant_courant"),""!==identifiant.value?code.focus():identifiant.focus()}function valeur_identifiant(){return identifiant.value.trim().toLowerCase()}$("#connect").on("click",function(e){se_connecter()}),initialisation();