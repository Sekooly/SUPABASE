var elements_menu_haut=["Infos établissement","Cycles","Classes","Matieres","Eleves","Profs","Administration","Maintenance","Programme","Alerte","Logs","Conversations","Visio","Notifs","Fichiers","Quiz","Questions","Reponses","Rendus","Topic","Coms","Espace etablissement restant"];var elements_menu_analyses=["Analyses des connexions"];var elements_menu_preferences=["Images","Couleurs","Formes","Police"];var img_dynamiques=["logo-no-background-128x128.png","img_retour.png","default-user.svg","img_reset.png","img_import.png","img_download.png","img_dupliquer.png","img_redtrash.png","img_previz.png","img_pleinecran.png","img_petitecran.png"];img_dynamiques=img_dynamiques.concat(liste_img_extensions());var parametres_automatiques=["Classe_bis","Classe_Matiere","ID_URL","URL","URL_Mapping","URL_agenda","id_googlecalendar","nb_avis_donnés","nb_avis_max","nom_fiche","taux_conseil","Matiere_bis","classe_id","classe_bis","type","Derniere_consultation_notifs","id_formulaire_remediation","id_fiche","URL_Mapping","niveau","classe_bis","id_dossier_cycle","dossier_rendus_cycle","liste_notifs_lues","nombre_avis","Numero_telephone","id","Id_classe_matiere","id_notif","Id_source","id_fichier","id_dossier","id_devoir","id_dossier_sujetdevoir","id_fichier_sujetdevoir","Id_topic","id_com","ID_FICHIER","id_msg","id_conv","id_chapitre","id_quiz","id_question","id_reponse"];var elements_menu_haut_avec_modifs=["Classes","Matieres","Eleves","Profs","Administration"];var elements_menu_haut_avec_reset=["Eleves","Profs","Administration"];nom_etablissement=data_etablissement["i"];var champs_avec_listes_dynamiques=["Classe","classe_bis","Classe_principale","Cycle","cycle","Matiere","Matiere_bis"];var champs_oui_ou_non=["Est_délégué","Reponse_sondage","Ecolage_OK","Droits_modifs","Droit_acces_anticipe_examen","Droit_changer_ecolage","commun_au_cycle","droit_hors_maintenance","Est_délégué"];var liste_couleurs=["blanc","bleu ciel","bleu foncé","gris","jaune","marron","noir","orange","rose","rouge","vert clair","vert foncé","violet"];var numero_etape=recuperer("numero_etape")?Number(recuperer("numero_etape")):0;var nb_etapes=8;var nouveau_prof=[];var image_temporaire="";var nom_image_temporaire="";var mes_devoirs_a_faire=[];var mes_devoirs_rendus=[];var tous_les_eleves_de_mon_cycle=[];var mes_discussions=[];var mes_coms=[];var mes_visios=[];var mes_fichiers=[];var liste_notifs_lues="";var mySubscription_notif=null;var mySubscription_conv=null;var ma_tentative={};var mes_reponses={};const{createClient}=supabase;supabase=createClient(racine_data.replace("/rest/v1/",""),data_etablissement["t"]);supabaseInit=createClient(racine_initiale.replace("/rest/v1/",""),api_initial.split("=")[1]);function afficher_conseil_de_classe(e){if(e){element_DOM("conseil_de_classes").style.display=""}else{charger_classe_conseil(false);element_DOM("conseil_de_classes").style.display="none"}}function charger_classe_conseil(e){if(impossible_de_cliquer())return-1;if(e){var r=la_matiere_chargee("Classe");var i=recuperer("mon_type").split("_")[0];if(i.includes("Eleves")){var r=JSON.parse(recuperer("mes_donnees"))["o"];var t=JSON.parse(recuperer("mes_donnees"))["_"]?JSON.parse(recuperer("mes_donnees"))["_"]==="oui":false;var n=moment().format("yyyy-MM-DD");if(n==="2020-07-31")t=true}if(r){if(i.includes("Admin")||i.includes("Prof")||i.includes("Eleves")&&t){recuperer_la_fiche_conseil(r)}else{recuperer_MA_fiche_conseil()}}}else{quitter_previsualisation()}}function recuperer_la_fiche_conseil(r){var i="Conseil de classe - "+r;vider_fenetre(i);afficher_fenetre(true);chargement(true);var e=racine_data+"Eleves?Classe=eq."+r+"&"+apikey;liste_eleves=get_resultat(e);liste_eleves=liste_eleves.sort(function(e,r){if(e.u<r.u){return-1}if(e.u>r.u){return 1}return 0});var t=JSON.parse(recuperer("mes_matieres")).find(e=>e["o"]===r)["l"];e=racine_data+"Fiches?id_classe=eq."+t+"&"+apikey;$.m({url:e,type:"GET",p:function(e){chargement(false);e=e[0];afficher_fenetre_conseil_de_classe([[e["v"],e["h"]],liste_eleves],i,r)},error:function(e){chargement(false);alert("Vérifiez que vous êtes toujours connecté à internet.")}})}function afficher_fenetre_conseil_de_classe(e,r,i){afficher_visualisation_fiche(e[0],r);lister_les_eleves(e[1],i)}function afficher_visualisation_fiche(e,r){if(e){visualiser(e[1],e[0],"",r,recuperer("mon_type").includes("Eleves"));$("#previsualisation")[0].style.height="50%"}}function lister_les_eleves(e,l){var r='<div id="liste_eleves" class="liste_eleves_conseil"></div>';$("#liste_eleves").remove();$("#fenetre").append(r);$("#liste_eleves")[0].scrollTo(0,0);e.forEach(function(e,r){var i=e["u"].toUpperCase();$("#liste_eleves").append('<b style="color: #FF6C00;margin-bottom: 5px;" id="'+i+'">'+i+" </b>");var t=element_DOM(i);var n='<span><img alt="voir" class="envoi_remarque mini-image" src="'+prefixe_image+'/img_previz.png" onclick="recuperer_details_plateforme(\''+i+"')\"></span>";var a=document.createElement("div");a.innerHTML=n;while(a.firstChild)t.appendChild(a.firstChild);var s=recuperer("mon_type").split("_")[0];if(s!=="Eleves"){var o='<span><img alt="remarque" class="envoi_remarque mini-image" src="'+prefixe_image+'/img_remarque.png" onclick="emettre_avis(\''+i+"','"+l+"')\"></span>";var _=document.createElement("div");_.innerHTML=o;while(_.firstChild)t.appendChild(_.firstChild)}if(e["g"]>0){var u='<span><img alt="autres avis" class="envoi_remarque mini-image" src="'+prefixe_image+'/img_details.png" onclick="recuperer_autres_avis(\''+i+"')\"></span>";var c=document.createElement("div");c.innerHTML=u;while(c.firstChild)t.appendChild(c.firstChild)}})}function recuperer_details_plateforme(e){dupliquer_visualisation(e);ajouter_bilan_a_la_fenetre();actualiser_bilan(e)}function dupliquer_visualisation(e){var r='<div class="ma_fenetre" id="fenetre_bis" style="visibility: visible; opacity:95%; top: 0px; left: 0px; width: 99%; height: 99%;"><div id="entete-fenetre" style="display: inline-flex;float: right;"><img alt="X" src="'+prefixe_image+'/quitter.png" id="bye_prev_bis" onclick="quitter_previsualisation_bis()" style="width: 30px; height: 30px; cursor: pointer; position: fixed; z-index: 3; top: 0px; left: 673px;"></div><div class="titre_fenetre" id="titre_fenetre_bis">Détails sur '+e+'</div><div class="fullscreen-btn" id="conteneur_plein_ecran_bis"> <img alt="plein écran" style="position: fixed;" id="pleinecran_bis" src="'+prefixe_image+'/img_petitecran.png" onclick="switch_mode_bis()" class="pleinecran"> </div></div>';var i=document.createElement("div");i.innerHTML=r;while(i.firstChild){document.body.appendChild(i.firstChild)}ajuster_boutons_fenetre(true);initialisation_bouton(true);choisir_height_viz_si_pdf()}function ajouter_bilan_a_la_fenetre(){$("#viz1595565163988").remove();var e="<div class='tableauPlaceholder previz'  id='viz1595565163988' style='position: relative;'>    <noscript>        <a href='#'>            <img alt=' ' src='https:&#47;&#47;public.tableau.com&#47;static&#47;images&#47;H4&#47;H4GNP92BT&#47;1_rss.png' style='border: none' />        </a>    </noscript>    <object class='tableauViz'  style='display:none;'>        <param name='host_url' value='https%3A%2F%2Fpublic.tableau.com%2F' />        <param name='embed_code_version' value='3' />         <param name='site_root' value='' />        <param name='name' value='Bilanplateforme&#47lve' />        <param name='tabs' value='yes' />        <param name='toolbar' value='yes' />=        <param name='animate_transition' value='yes' />        <param name='display_static_image' value='no' />        <param name='display_spinner' value='yes' />        <param name='display_overlay' value='yes' />        <param name='display_count' value='yes' />        <param name='language' value='fr' />        <param id='filtre_identifiant' name='filter'/>    </object></div>   ";var r=document.createElement("div");r.innerHTML=e;var i=element_DOM("fenetre_bis");i.appendChild(r.firstChild)}function actualiser_bilan(e){var r=element_DOM("viz1595565163988");var i=r.getElementsByTagName("object")[0];element_DOM("filtre_identifiant").value="Identifiant="+e;i.style.width="100%";i.style.height="100%";var t=document.createElement("script");t.src="https://public.tableau.com/javascripts/api/viz_v1.js";i.parentNode.insertBefore(t,i);$("#fenetre_bis")[0].style.display=""}function emettre_avis(e,r){var i='<div id="mini_popup"><div id="entete-fenetre" style="display: inline-flex;float: right;"><img alt="X"  src="'+prefixe_image+'/quitter.png" id="bye_prev" onclick="$(\'#mini_popup\').remove()" style="width: 30px; height: 30px;cursor:pointer;position:fixed;z-index:3;transform: translate(-50%, -50%);"> </div><div>Vos observations sur <b>'+e+'</b>:</div><textarea id="observation" style="width: 80%;resize: none;font-size: 13px;margin-bottom: 5%;"></textarea><div style="">Passage de <b>'+e+'</b> en classe supérieure:</div><select style="width: 80%;border-color: red;border-style: solid;margin-bottom: 5%;" id="avis_passage" value=""><option value=""></option><option value="Favorable">Favorable</option><option value="Non favorable">Non favorable</option></select><button type="button" class="rendre" onclick="envoyer_avis_conseil(\''+e+"','"+r+"')\">Envoyer l'avis</button></div>";var t=document.createElement("div");t.innerHTML=i;while(t.firstChild)document.body.appendChild(t.firstChild);$("#avis_passage").$("change",function(e){if(e.target.value==="Favorable"){$("#avis_passage")[0].style.borderColor="green"}else{$("#avis_passage")[0].style.borderColor="red"}})}function envoyer_avis_conseil(e,i){var r=$("#avis_passage")[0].value;var t=$("#observation")[0].value;if(r==="")return-1;var n=JSON.parse(recuperer("mes_matieres"));var a=recuperer("mon_type").split("_")[0];if(a.includes("Eleves"))var i=JSON.parse(recuperer("mes_donnees"))["o"];var s="";var o="";n.some(function(e,r){if(e["o"]===i){s=e["l"];o=e["q"];return-1}});var _=recuperer("identifiant_courant").toLowerCase().trim();e=e.toLowerCase().trim();nouvel_avis_conseil={o:i,O:s,M:r,D:_,k:e,j:t,S:o,I:maintenant()};ajouter_un_element("Conseil",nouvel_avis_conseil).then(()=>{url=racine_data+"Eleves?Identifiant=eq."+e+"&"+apikey;nb_actuel=get_resultat(url)[0]["g"];nouvelle_donnee_eleve={g:nb_actuel+1};actualiser("Eleves","Identifiant",e,nouvelle_donnee_eleve).then(()=>{$("#mini_popup").remove();recuperer_la_fiche_conseil(i);chargement(false)})})}async function recuperer_autres_avis(e){var r=await rechercher("Conseil","identifiant_eleve",e.toLowerCase(),"");if(r.length>0)afficher_toutes_les_observations(r,e)}function afficher_toutes_les_observations(e,r){$("#ensemble_observations").remove();var i="<div id='ensemble_observations'></div>";var t=document.createElement("div");t.innerHTML=i;element_DOM(r).appendChild(t.firstChild);e=e.sort(function tri_ordre_chrono_decroissant(e,r){return convertir_en_date(e.I)-convertir_en_date(r.I)});e.forEach(function(e,r){var i=e["M"]==="Favorable"?"✅":"❌";var t=e["D"].toUpperCase()===recuperer("identifiant_courant").toUpperCase()?" (Vous)":e["S"]?" ("+e["S"]+")":"";une_observation='<div style="color:black;font-size:10px;padding:5px;">'+i+'<b style="color:#FF6C00;">'+e["D"].toUpperCase()+t+": </b>"+e["j"]+'<i style="color: #bfbfbf;"> '+afficher_date(e["I"])+"  </i></div>";$("#ensemble_observations").append(une_observation)})}function recuperer_MA_fiche_conseil(){var e=recuperer("identifiant_courant").trim().toUpperCase();element_DOM("fenetre").style.overflowY="auto";vider_fenetre("Vos résultats");$("#fenetre").append('<div style="text-align:center;margin-top: 20px;margin-left: 20px;"><b style="color: #FF6C00;margin-bottom: 5px;" id="'+e+'">'+e+" </b></div>");var r=element_DOM(e);var i='<span><img alt="voir"  class="envoi_remarque mini-image" src="'+prefixe_image+'/img_previz.png" onclick="recuperer_details_plateforme(\''+e+"')\"></span>";var t=document.createElement("div");t.innerHTML=i;while(t.firstChild)r.appendChild(t.firstChild);recuperer_autres_avis(e);afficher_fenetre(true)}function aide_devoirs(){alerte="CONSIGNES POUR METTRE EN LIGNE UN DEVOIR: \n";alerte=alerte+"• Pour un quiz, il suffit dy répondre en ligne et d'enregistrer vos réponses. Une fois tout validé, vous ne pourrez plus modifier vos réponses.\n";alerte=alerte+'• Vous pouvez rendre uniquement un devoir lorsque l\'enseignant a catégorisé un fichier de "Devoir" ou "Examen".\n';alerte=alerte+"• Pour rendre un devoir, choisissez le sujet que l'enseignant aura mis en ligne.\n";alerte=alerte+"• Pour un même devoir, si vous avez plusieurs images, cliquez sur 'Ajouter une page' et choissisez le fichier IMAGE à rajouter.\n";alerte=alerte+"• Vérifiez bien l'ordre des images car cela sera pris en compte dans l'image finale générée, que pouvez voir en aperçu ci-dessous.\n";alerte=alerte+"• Si vous êtes sur ordinateur, vous pouvez également créer un fichier word et y coller toutes vos images. Les fichiers word (doc / docx) sont également supportés par Sekooly.";alert(alerte)}function afficher_tous_les_fichiers_deja_recup(){$("#alerte_vide").remove();afficher_le_drive(true);Array.from($(".span_un_fichier")).forEach(function(e,r,i){element_DOM(e.id).style.display="grid"});Array.from(document.getElementsByClassName("ma_liste")).forEach(function(e,r,i){element_DOM(e.id).style.display="grid"});Array.from($(".titre_drive")).forEach(function(e,r,i){element_DOM(e.id).style.display="initial"});return 0}function afficher_fenetre_rendudevoir(e){if(e){element_DOM("rendu_devoir").style.visibility="visible";initialisation_choix_devoir()}else{element_DOM("rendu_devoir").style.visibility="hidden"}}function initialisation_choix_devoir(){supprimer_div_devoir_choisi();supprimer_rendus_devoirs_affiches();element_DOM("soumettre_devoir").style.display="none";$("#remarque_prof").remove();$("#note_rendu").remove();les_devoirs=element_DOM("drive_devoirs").childNodes;les_examens=element_DOM("drive_examens").childNodes;les_quiz=element_DOM("drive_quiz").childNodes;la_liste_devoirs=element_DOM("devoir_choisi");la_liste_devoirs.innerHTML='<option value="--">--</option>';element_DOM("devoir_choisi").style.borderColor="";for(var e=0;e<les_devoirs.length;e++){var r=les_devoirs[e]["id"];var i=$("span#"+r+".span_un_fichier").N().filter(function(){return this.nodeType==3})[0].nodeValue;var t='<option value="'+r+'">'+i+"</option>";var n=document.createElement("div");n.innerHTML=t;la_liste_devoirs.appendChild(n.firstChild)}for(var e=0;e<les_examens.length;e++){var a=les_examens[e]["id"];var i=$("span#"+a+".span_un_fichier").N().filter(function(){return this.nodeType==3})[0].nodeValue;var s='<option value="'+a+'" examen="oui">'+i+"</option>";var o=document.createElement("div");o.innerHTML=s;la_liste_devoirs.appendChild(o.firstChild)}for(var e=0;e<les_quiz.length;e++){var _=les_quiz[e]["id"];var i=$("span#"+_+".span_un_fichier").N().filter(function(){return this.nodeType==3})[0].nodeValue;var s='<option value="'+_+'">'+i+"</option>";var o=document.createElement("div");o.innerHTML=s;la_liste_devoirs.appendChild(o.firstChild)}$("#devoir_choisi").$("change",function(e){supprimer_div_devoir_choisi();supprimer_rendus_devoirs_affiches();afficher_soumettre_devoir(false);changer_couleur_devoir("");$("#remarque_prof").remove();$("#note_rendu").remove();if(recuperer("mon_type")==="Eleves"){if(e.target.value!=="--"){var r=e.target.options[e.target.selectedIndex].getAttribute("examen");var i=$("[id="+e.target.value+"].span_un_fichier")[0].attributes["C"].value;var t=$("[id="+e.target.value+"].span_un_fichier")[0].attributes["A"].value;nb_heures_delai_examen=data_etablissement["R"]||12;var n=moment(i+" "+t,"yyyy-MM-DD hh:mm").add(nb_heures_delai_examen,"hours").T;var a=r&&moment(maintenant())>n;if(r==="oui"&&fichier_ouvrable(e.target.value,false)===false&&a===false){alert("Vous ne pouvez pas encore rendre cet examen dont la date d'effet est le "+afficher_date_old(i,true));e.target.value="--"}else{recuperer_mon_devoir(e.target.value,recuperer("identifiant_courant"),a,n)}$("#bouton_rendre_devoir")[0].innerText=r==="oui"?"Rendre l'examen":"Rendre le devoir"}}else{if(e.target.value!=="--"){recuperer_mon_devoir(e.target.value,"")}}})}function recuperer_mon_devoir(o,e,_,u){chargement(true);supprimer_div_devoir_choisi();supprimer_rendus_devoirs_affiches();afficher_soumettre_devoir(false);changer_couleur_devoir("");$("#remarque_prof").remove();$("#note_rendu").remove();if(recuperer("mon_type")==="Eleves"){element_DOM("rendu_devoir").style.height="";rechercher("Rendus","id_devoir",o+suite_notif(),"").then(e=>{chargement(false);donnees_initiales=e[0];if($("#devoir_choisi")[0].value!==o)return-1;if(donnees_initiales!==undefined){data=donnees_initiales["P"];extension=data.split(".").pop();remarque=donnees_initiales["J"];id_fichier=extension==="quiz"?donnees_initiales["U"]:donnees_initiales["V"];changer_couleur_devoir("green");afficher_soumettre_devoir(false);supprimer_div_devoir_choisi();supprimer_rendus_devoirs_affiches();var r=document.createElement("div");var i=rfc3986EncodeURIComponent(data);var t=_?"":'<img alt="supprimer"  id="'+data+'" src="'+prefixe_image+'/img_trash.png" style="width:15px;height:15px;cursor:pointer;" onclick="supprimer_devoir(this)">';var n=donnees_initiales["L"]===null?"  <i><gris>non terminé</gris></i>  ":"";r.innerHTML+='<div id="mon_devoir_rendu"> <div id="'+id_fichier+'">'+data+'<img class="mini-image" onclick="visualiser(\''+i+"','"+id_fichier+'\')" src="'+prefixe_image+'/img_previz.png" style="padding-left:1%">'+t+n+"</div></div>";$("#rendu_devoir").append(r.innerHTML);note_rendu=donnees_initiales["F"];if(note_rendu!==null){$("#note_rendu").remove();remarque=decodeURIComponent(remarque);var a='<div id="note_rendu" style="text-align: justify;padding: 2%;"><b style="color: #cc3a22;">Note attribuée:</b><br>'+note_rendu+"</div>";var s=document.createElement("div");s.innerHTML=a;element_DOM("rendu_devoir").appendChild(s.firstChild)}if(remarque.length>0){$("#remarque_prof").remove();remarque=decodeURIComponent(remarque);var a='<div id="remarque_prof" style="text-align: justify;padding: 2%;"><b style="color: #cc3a22;">Remarque du professeur:</b><br>'+remarque+"</div>";var s=document.createElement("div");s.innerHTML=a;element_DOM("rendu_devoir").appendChild(s.firstChild)}}else{if(_){alert("Rendre cet examen n'est plus possible depuis le "+moment(u).format("DD/MM/YYYY HH:mm")+".")}else{changer_couleur_devoir("red");supprimer_div_devoir_choisi();supprimer_rendus_devoirs_affiches();gerer_affichage_quiz_devoir(o)}}})["catch"](e=>{console.error(e);alert("Sujet de devoir introuvable.");chargement(false)})}else{rechercher("Rendus","id_fichier_sujetdevoir",o,"").then(e=>{e=e.filter(e=>e["L"]);chargement(false);afficher_rendus_devoirs(e)})}$("#recuperer_devoir").remove()}function gerer_affichage_quiz_devoir(e){var r=$('[value="'+e+'"]').text().split(".").pop()==="quiz";if(r&&!element_DOM("mon_devoir_rendu")){element_DOM("soumettre_devoir").style.display="none";element_DOM("soumettre_quiz").style.display="block"}else{element_DOM("soumettre_quiz").style.display="none";element_DOM("soumettre_devoir").style.display=""}}function nom_du_devoir_choisi(){return $('[value="'+element_DOM("devoir_choisi").value+'"]').text()}function afficher_rendus_devoirs(e){if(!element_DOM("liste_des_devoirs_rendus")){var r=document.createElement("div");r.id="liste_des_devoirs_rendus";element_DOM("rendu_devoir").appendChild(r)}else{var r=element_DOM("liste_des_devoirs_rendus")}if(e.length===0)element_DOM("rendu_devoir").style.height="auto";if(e.length===0)return r.innerHTML='<i style="color: #bfbfbf;">Pas encore de rendus pour ce devoir/examen/quiz.</i>';e.sort(function tri_ordre_chrono_decroissant(e,r){return new Date(e[0]).getTime()-new Date(r[0]).getTime()});r.innerHTML="";var i=nom_du_devoir_choisi().split(".").pop()==="quiz";for(var t=0;t<e.length;t++){var n=document.createElement("div");n.id=e[t]["V"];n.style="padding: 0.5%;";n.innerHTML="Devoir de ";n.innerHTML+='<b style="color: #FF6C00;" id="proprietaire'+e[t]["V"]+'">'+e[t]["K"].toUpperCase()+" </b>";var a=decodeURIComponent(e[t]["J"]);a=JSON.stringify(a).replace(/&/,"&amp;").replace(/"/g,"");a=a.replace(/'/g,"\\'");if(a.length>0){note_si_existante=e[t]["F"]?e[t]["F"]+"\n\n":"";n.innerHTML+='<span id="correction_ok"><span class="correction_ok" style="font-size: 8px;color: #5ac55a;font-weight: bold;font-style: italic;" onmouseover="afficher_mon_indication(this)" onmouseout="masquer_mon_indication(this)">Corrigé</span><span class="indication" style="margin-top:5%;">'+note_si_existante+a+"</span></span>"}var s=rfc3986EncodeURIComponent(e[t]["P"].trim());var o=" ("+e[t]["K"].trim().toUpperCase()+")";var _=e[t]["Y"];var u=e[t]["F"];n.innerHTML+='<img alt="voir"  class="mini-image" src="'+prefixe_image+'/img_previz.png" onclick="visualiser(\''+s+"','"+n.id+"', '"+o+"')\">";n.innerHTML+='<img alt="remarque" class="mini-image envoi_remarque" onclick="mettre_remarque_devoir(this,\''+a+"',"+_+","+u+');" src="'+prefixe_image+'/img_remarque.png">';n.innerHTML+=i?"":'<a   id="telechargement" href = "https://drive.google.com/uc?export=download&id='+n.id+'" download="mon_fichier.txt"><img alt="télécharger" class="mini-image" src="'+prefixe_image+'/img_download.png"></a>';n.innerHTML+='<i style="color: #bfbfbf;">'+afficher_date(e[t]["L"])+"  </i>";r.appendChild(n)}if(element_DOM("rendu_devoir").offsetHeight>screen.height){element_DOM("rendu_devoir").offsetHeight="90%"}}function mettre_remarque_et_note(t,e,n,a){$("#remarque_et_note").remove();html_a_ajouter=fenetre_remarque_note(t,a?a:0,e);$("body").append(html_a_ajouter);if(Number(n)===0){$("#champ_note").remove()}$("#envoyer_note").$("click",function(e){if(Number(n)>0)a=$("#note_rendu")[0].value;remarque_prof=$("#remarque")[0].value;$("#remarque_et_note").remove();chargement(true);remarque_prof=encodeURIComponent(remarque_prof);nom_table="Rendus";nom_champ_reference="id_fichier";valeur_champ_reference=t;if(Number(n)>0){nouvelle_remarque={F:a,J:remarque_prof}}else{nouvelle_remarque={J:remarque_prof}}actualiser(nom_table,nom_champ_reference,valeur_champ_reference,nouvelle_remarque);if(remarque_prof.length>0){nouvelles_donnees_notif={B:maintenant(),H:recuperer("identifiant_courant"),X:mon_role};var r=$("#proprietaire"+t)[0].innerText;var i=$("#devoir_choisi")[0].value+"-"+r.trim().toLowerCase().replace(".","");actualiser("Notifs","id_notif",i,nouvelles_donnees_notif)}setTimeout(function(){quitter_previsualisation();quitter_previsualisation_bis();recuperer_mon_devoir(element_DOM("devoir_choisi").value)},2e3);chargement(false)})}function fenetre_remarque_note(e,r,i){nom_proprio_devoir=$("#proprietaire"+e)[0].innerText.trim().toUpperCase();return'<div class="ma_fenetre" id="remarque_et_note" style="visibility: visible;height: 33%;width: 280px;height: 300px;top: 35%;left: 10%;"><b style="text-align: center;"><div id="titre_fenetre" class="">Note et remarque de '+nom_proprio_devoir+' </div></b><span style=""><form id="mon_formulaire" autocomplete="off" class="edition">\t<div id="champ_note"><label id="label" for="note_rendu">Note (sur 20)</label><input type="number" min=0 max=20 step=0.125 id="note_rendu" maxlength="2" style="width: 100%;" value="'+r+'"></div><br><label id="label" for="remarque">Votre remarque</label><textarea id="remarque" maxlength="300" style="width: 100%;resize: none;font-size: 13px;height: 50%;">'+i+'</textarea><div id="mes_boutons" style="text-align: center;padding: 1%;display: block ruby;"><button class="bouton_sekooly" type="button" id="Annuler" onclick="$(\'#remarque_et_note\').remove()"> Annuler </button><button  class="bouton_sekooly" type="button" id="envoyer_note">Valider</button></div></form></span></div>'}function mettre_remarque_devoir(e,r,i,t){var n=r.replace(/&quot;/g,'"');n=decodeURIComponent(n);var a=e.parentNode.id;var s=recuperer("identifiant_courant");var o=mettre_remarque_et_note(a,n,i,t)}async function supprimer_devoir(e,r,i){if(r){var t=r}else{var t=e.parentNode.id}var n=$("#devoir_choisi")[0].value+suite_notif();if(i)n=i;if(r||i){var a=true}else{var a=window.confirm("Êtes vous sûr de vouloir supprimer ce rendu de devoir?")}if(!a)return-1;stocker("id_devoir",n);chargement(true);if(nom_du_devoir_choisi().split(".").pop()==="quiz"){return await suppression_devoir_sur_db("Votre tentative du quiz a été supprimée.")}var s="https://script.google.com/macros/s/AKfycbw_04bdiepfQ0P9Ddtn6nyRPjxzxumORN4J8xm7bnmu7yO3HvQ/exec";var o=r||i?"API_KEY_DELETE":"API_KEY_DEVOIR";var _='<form method="post"  action="'+s+'" id="supprimer_devoir" style="display: none;" >';_+='<input type="hidden" name="'+o+'" value="'+recuperer(o)+'" >';_+='<input type="hidden" name="id_fichier" value="'+t+'" >';_+="</form>";$("body").append(_);var u=$("#supprimer_devoir");$.m({type:"POST",url:s,data:u.W(),p:suppression_devoir_sur_db,error:erreur_suppression_devoir});$("#supprimer_devoir").remove()}async function suppression_devoir_sur_db(e){var r=recuperer("id_devoir");await supprimer("Rendus","id_devoir",r);await supprimer("Notifs","id_notif",r);effacer("id_devoir");afficher_alerte(e);setTimeout(function(){return recuperer_mon_devoir(element_DOM("devoir_choisi").value,recuperer("identifiant_courant"));chargement(false)},2e3)}function supprimer_div_devoir_choisi(){$(".mon_file_devoir").G(function(e,r){r.value=""});if(element_DOM("mon_devoir_rendu"))element_DOM("mon_devoir_rendu").remove()}function erreur_suppression_devoir(e){console.error(e);alert("Impossible de supprimer le rendu: vérifiez que vous êtes toujours connecté.");chargement(false)}function supprimer_rendus_devoirs_affiches(){if(element_DOM("liste_des_devoirs_rendus"))element_DOM("liste_des_devoirs_rendus").remove();vider_previz_devoir_rendu();$(".fichier_supplementaire").remove()}function afficher_soumettre_devoir(e){if(e){element_DOM("soumettre_devoir").style.display=""}else{element_DOM("soumettre_devoir").style.display="none";element_DOM("soumettre_quiz").style.display="none"}}function changer_couleur_devoir(e){element_DOM("devoir_choisi").style.borderColor=e}function rendre_devoir(){if(impossible_de_cliquer())return-1;var t=$("#devoir_choisi")[0].value;var e=$("#file_devoir")[0].value;if(t!=="--"&&e!==""){var n=$("#file_devoir")[0].files[0];var r=new FileReader;r.onprogress=function(e){chargement(true)};chargement(true);r.onload=async function(e){var r=await chercher_lien_script(4);var i={};if($("#soumettre_devoir > input").length>1){img_finale=await telecharger_tout(true);img_finale=img_finale.replace(/^.*,/,"");if(!img_finale){chargement(false);return false}else{i.file=img_finale}}else{i.file=e.target.result.replace(/^.*,/,"")}nom_fichier=n.name;coefficient_rendu=Number($("#"+t)[0].getAttribute("coefficient_rendu"));taille_fichier=n.size;extension=nom_fichier.split(".").pop().toUpperCase();id_dossier_sujetdevoir=recuperer("dossier_chargé");id_fichier_sujetdevoir=t;proprietaire=recuperer("identifiant_courant");mettre_devoir_en_ligne(r,i,nom_fichier,extension,id_dossier_sujetdevoir,id_fichier_sujetdevoir,proprietaire,coefficient_rendu,taille_fichier)};r.readAsDataURL(n)}}function mettre_devoir_en_ligne(e,r,t,i,n,a,s,o,_){var u='<form method="post"  action="'+e+'" id="form_rendu_devoir" style="display: none;" >';u+='<input type="hidden" name="API_KEY_DEVOIR" value="'+recuperer("API_KEY_DEVOIR")+'" >';u+='<input type="hidden" name="nom_fichier" value="'+t+'" >';u+='<input type="hidden" name="extension" value="'+i+'" >';u+='<input type="hidden" name="file" value="'+r.file+'" >';u+='<input type="hidden" name="dossier_rendus_cycle" value="'+recuperer("dossier_rendus_cycle")+'" >';u+='<input type="hidden" name="proprietaire" value="'+s+'" >';u+="</form>";$("body").append(u);$("#form_rendu_devoir").submit(function(e){e.preventDefault();var r=$(this);var i=r.Z("action");$.m({type:"POST",timeout:6e5,url:i,data:r.W(),p:function(e){if(e.includes("ERREUR")){afficher_alerte(e,false);return-1}setTimeout(function(){recuperer_mon_devoir(element_DOM("devoir_choisi").value,recuperer("identifiant_courant"))},2e3);date_heure_actuelle=maintenant();nom_table="Rendus";id_devoir=a+suite_notif();la_matiere=la_matiere_chargee("Matiere");nouveau_devoir={ee:id_devoir,L:date_heure_actuelle,re:n,U:a,V:e,P:t,K:recuperer("identifiant_courant"),J:"",ie:la_matiere,Y:o,te:_};ajouter_un_element(nom_table,nouveau_devoir,id_devoir);nom_table="Notifs";mes_donnees=JSON.parse(recuperer("mes_donnees"));nouvelle_notif={ne:id_devoir,ae:date_heure_actuelle,se:"devoir",oe:a,_e:t,ue:recuperer("identifiant_courant"),ce:"Eleve",H:recuperer("identifiant_courant"),X:"Eleve",o:mes_donnees["o"],le:"("+mes_donnees["o"]+"|"+la_matiere+")",de:recuperer("dossier_chargé"),B:date_heure_actuelle,me:mes_donnees["me"]};ajouter_un_element(nom_table,nouvelle_notif,id_devoir);afficher_alerte("Votre rendu a bien été mis en ligne.",false);chargement(false)},error:function(e){chargement(false);e=JSON.parse(e);console.error(e);afficher_alerte("Votre fichier est trop lourd à mettre en ligne, merci de réduire leur taille avant de les mettre en ligne.",false)},done:function(e){chargement(false)}})});$("#form_rendu_devoir").submit();$("#form_rendu_devoir").remove()}function retourner_site(){vider_fenetre("Sekooly");visualiser("Tutoriels d'utilisation.docx","1HnsoX5_NQGhJ34WZ68p9SPvZ30jn4gKpf_cQjz2ZyUo",false,"Tutoriels d'utilisation");$("#telechargement").remove();afficher_fenetre(true)}function afficher_alerte(e,r){var i=element_DOM("snackbar");i.innerHTML=e;i.className="show";setTimeout(function(){i.className="";if(r)location.reload()},3e3)}function afficher_modif_profil(){quitter_previsualisation();vider_fenetre("Votre profil");var e=JSON.parse(recuperer("mes_donnees"));var r=mon_detail("Photo de profil",ma_photo());var i=mon_detail("Niveau XP",calculer_mes_XP());var t=mon_detail("Identifiant",e["u"]);var n=mon_detail("Nom",e["fe"]);var a=mon_detail("Prénom(s)",e["pe"]);var s=recuperer("mon_type");var o=s.includes("Admin")?e["ve"]:s.substring(0,s.length-1);var _=mon_detail("Rôle du profil",o);var u=e["o"].replace(/;/g,"<br>");u=u.replace(/\(/g,"");u=u.replace(/\)/g,"");u=u.replace(/\|/g,", ");var c=mon_detail("Classe(s)",u);var l=mon_detail("Telephone",e["he"]);var d=mon_detail("Code d'accès",e["ge"],true);var m='<span id="les_boutons" style="text-align: center;position: relative;display: block;"><button type="button" id="annuler_modifs" onclick="quitter_previsualisation()"> Annuler </button><button type="button" id="valider_modifs" onclick="switch_edition()">Enregistrer</button></span>';var f='<div id="mes_details" class="mes_details">'+r+i+t+n+a+_+c+l+d+"</div>"+m;var p=document.createElement("div");p.innerHTML=f;while(p.firstChild)element_DOM("fenetre").appendChild(p.firstChild);mode_edition(false,true);afficher_fenetre(true)}function bouton_supprimer_pp(e){e=e?e:recuperer("identifiant_courant");return'<img id="suppr_pp" onclick="supprimer_pp(\''+e+'\')" class="editer" src="'+prefixe_image+'/img_trash.png" alt="supprimer">'}function bouton_modifier_pp(e){e=e?e:recuperer("identifiant_courant");return'<span class="pp-upload"><label for="pp-'+e+'"><img src="'+prefixe_image+'/img_edit.png" alt="MODIFIER" class="editer"></label><input onchange="changer_pp(\''+e+'\')" accept=".png,.jpeg,.jpg,.bmp,.svg,.gif" id="pp-'+e+'" type="file"/> </span>'}function ma_photo(e,r){chargement(true);var i="Fichiers";url=racine_data+i;url+="?proprietaire=eq."+(e||recuperer("identifiant_courant"));url+="&categorie_fichier=eq.Profil";url+="&"+apikey;id_pp=get_resultat(url)[0];if(id_pp)id_pp=id_pp["V"];le_lien_pp=lien_pp(id_pp);supprimer_si_pp_existante=id_pp?r?"":bouton_supprimer_pp():"";bouton_modifier=r?"":bouton_modifier_pp();chargement(false);return"<img class='pp' id='pp_"+(e||recuperer("identifiant_courant"))+"' src="+le_lien_pp+">"+bouton_modifier+supprimer_si_pp_existante}var basic_croppie;var donnees_pp;var extension_pp="";async function url_pp(){var e=await chercher_lien_script(8);return e}async function supprimer_pp(i,t){if(!t)var e=confirm("⚠️Voulez-vous supprimer cette photo de profil ? Cette action est irréversible.");if(e||t){chargement(true);i=i?i:recuperer("identifiant_courant");var r=await url_pp();r+="?supp_mon_id_pp=true";r+="&nom_etablissement="+data_etablissement["i"];r+="&identifiant="+i;r+="&supp_mon_id_pp=true";return get_resultat_asynchrone(r).then(function(e){if(!t)afficher_alerte(e);nom_table="Fichiers";var r=racine_data+nom_table+"?proprietaire=eq."+i;r+="&categorie_fichier=eq.Profil";r+="&"+apikey;return delete_resultat_asynchrone(r).then(function(){$("[id='pp_"+i+"']")[0].src=prefixe_image+"/default-user.svg";$("#suppr_pp").remove();if(!t)chargement(false)})})}}function changer_pp(e){var r=new FileReader;e=e?e:"";creer_mini_popup("","<div id='nouvelle_pp' style='overflow: hidden;width: 300px;height:300px;'></div>","Valider la photo","envoyer_pp('"+e+"')");basic_croppie=$("#nouvelle_pp").be({viewport:{width:200,height:200,type:"circle"},ye:{width:300,height:200},$e:true});r.onload=function(e){chargement(false);donnees=r.result;basic_croppie.be("bind",{url:donnees,points:[77,469,280,739]})};extension_pp=$("[id='pp-"+e+"']")[0].files[0].name.split(".").pop();chargement(true);r.readAsDataURL($("[id='pp-"+e+"']")[0].files[0])}async function envoyer_pp(t){chargement(true);url=await url_pp();t=t?t:recuperer("identifiant_courant");supprimer_pp(t,true).then(function(){basic_croppie.be("result",{type:"canvas",size:"viewport"}).then(function(i){$("#mini_popup").remove();data={i:data_etablissement["i"],qe:t,xe:recuperer("API_KEY_UPLOAD"),Oe:recuperer("API_KEY_DEVOIR"),Me:extension_pp,file:i.replace(/^.*,/,"")};post_resultat_asynchrone(url,data).then(function(e){afficher_alerte(e.split("|")[0]);id_pp=e.split("|")[1].trim();date_heure_aujourdhui=maintenant();nom_table="Fichiers";mes_donnees={V:id_pp,De:"Profil",K:t,P:t+"."+extension_pp,ze:moment(date_heure_aujourdhui).format("YYYY-MM-DD"),ke:"pp",we:"non",L:date_heure_aujourdhui,te:$("[id='pp-"+t+"']")[0].files[0].size};var r=racine_data+nom_table+"?"+apikey;post_resultat_asynchrone(r,mes_donnees).then(function(){$("[id='pp_"+t+"']")[0].src=i;if($("#suppr_pp").length===0)$("#Photo").append(bouton_supprimer_pp())});chargement(false)})})})}function calculer_mes_XP(){return"En cours de construction."}async function switch_edition(){var e=$("#valider_modifs")[0].innerText==="💾";if(!e){var r=await recuperer_mes_donnees();var i=prompt("Indiquez votre code d'accès ACTUEL:");if(!i)return afficher_alerte("Modification du profil annulée.");if(!r)return afficher_alerte("Vous devez être connecté à internet pour modifier votre profil.");if(code_ok(r,i)){mode_edition(true)}else{if(i!==null)afficher_alerte("Le code d'accès est erroné, impossible de modifier votre profil.")}}else{nom_champ="Code";valeur_champ=hasher($("#Code")[0].value);nouveau_data={[nom_champ]:valeur_champ,je:"ok"};mettre_a_jour(nom_champ,valeur_champ)}}function mettre_a_jour(e,i){actualiser(recuperer("mon_type"),"Identifiant",recuperer("identifiant_courant"),nouveau_data);var t=JSON.parse(recuperer("mes_donnees"));e.split(",").forEach(function(e,r){t[e]=i.split(",")[r]});stocker("mes_donnees",JSON.stringify(t));afficher_alerte("Votre profil a été mis à jour.");mode_edition(false);chargement(false)}function mode_edition(e,r){if(!r){var i=e?"input":"";changer_element("Code",i,true)}var t=e?"Enregistrer":"Modifier";$("#valider_modifs")[0].innerText=t}function changer_element(e,r,i){var t=r==="input"?$("#"+e)[0].innerText:i?"•".repeat($("#"+e)[0].value.length):$("#"+e)[0].value;var n=i?'type="password"':"";var a=r==="input"?'<input id="'+e+'" value="'+t+'" '+n+">":'<span id="'+e+'">'+t+"</span>";var s=document.createElement("div");s.innerHTML=a;var o=$("#"+e)[0].parentNode;$("#"+e).remove();while(s.firstChild)o.appendChild(s.firstChild);if(r==="input"){$("#"+e)[0].value=JSON.parse(recuperer("mes_donnees"))["ge"];$("#"+e)[0].select();$("#"+e)[0].value="";$("#Code").Ee(function(e){if(e.charCode===13)switch_edition();if(e.charCode===38||e.charCode===44||e.charCode===39||e.charCode===34||e.charCode===32){afficher_alerte("Le symbole ' "+String.fromCharCode(e.charCode)+" ' est interdit.");return false}})}}function mon_detail(e,r,i){if(i)r="•".repeat(r.length);var t='<div class="un_detail"><b style="color:#FF6C00">'+e+': </b><br><span id="'+e.split(" ")[0]+'">'+r+"</span></div>";return t}function sur_mobile_ou_tablette(){return window.innerWidth<=750||window.innerHeight<=750}function filtrer_date_effet(){afficher_tous_les_fichiers_deja_recup();var t=element_DOM("la_date_effet").value;$(".span_un_fichier").filter(function(e){var r=$(this)[0].attributes["C"].value;var i=r.includes(t);$(this)[0].style.display=i||t==="Tous"?"grid":"none";return $(this)[0].innerHTML.includes(t)});afficher_le_drive(true);garder_les_manuels();masquer_drive_vide()}function filtrer_chapitre(){afficher_tous_les_fichiers_deja_recup();var a=element_DOM("filtre_id_chapitre").value;$(".span_un_fichier").filter(function(e,r){var i=$(this)[0].attributes["Se"].value;var t=i.includes(a);var n=t||a==="Tous"?"grid":"none";r.style.display=n;return r.innerHTML.includes(a)});afficher_le_drive(true);garder_les_manuels();masquer_drive_vide()}function rfc3986EncodeURIComponent(e){return encodeURIComponent(e).replace(/[!'()*]/g,escape)}function afficher_tri_fichiers(e){element_DOM("span_date_effet").style.display=e?"block":"none"}function afficher_visio(e){element_DOM("visioconference").style.display=e?"block":"none"}function afficher_choix_date(e){if(e){element_DOM("choix_date").style.display="grid"}else{element_DOM("choix_date").style.display="none"}}function afficher_choix_coef(e){if(e){element_DOM("coef_rendu").style.display=""}else{element_DOM("coef_rendu").style.display="none"}}function afficher_ou_non_choix_fichier(e,r){if(impossible_de_cliquer()&&!r)return-1;if(e&&!recuperer("mon_type").includes("Admin")&&element_DOM("accueil_utilisateur").innerText.includes("Vie scolaire")){alert("Vous n'avez pas les droits pour publier un fichier dans la Vie Scolaire.");return-1}image_temporaire="";nom_image_temporaire="";est_deja_affiche=element_DOM("choix_popup").style.visibility==="visible";if(est_deja_affiche||!e){element_DOM("choix_popup").style.visibility="hidden";if(!r){afficher_choix_date(false);afficher_choix_coef(false)}}else{var i=true;if(!i){alert("Impossible de mettre en ligne des fichiers du lundi 1er au dimanche 7 Juin 2020.");return-1}afficher_fenetre(false);afficher_ou_non_choix_fichier(false);mode_bulletin(false);element_DOM("choix_popup").style.visibility="visible";element_DOM("file").value="";element_DOM("categorie_choisie").value="--";element_DOM("la_date_limite").value="";element_DOM("date_effet_fichier").value=moment().format("yyyy-MM-DD");element_DOM("heure_effet").value="";element_DOM("lheure_limite").value="";element_DOM("id_chapitre").value="--";element_DOM("est_video_youtube").checked=false;element_DOM("est_extrait_manuel").checked=false;element_DOM("est_telechargeable").checked=true;afficher_checkbox("choix_extrait_manuel",les_manuels_de_la_matiere()!=="");mode_fichier_initialement();element_DOM("coef").value=0;element_DOM("mode-non-quiz").style.display="grid";element_DOM("mode-quiz").style.display="none";afficher_choix_date(false);afficher_choix_coef(false)}}function afficher_mon_indication(e){e.parentNode.childNodes[1].style.visibility="visible"}function masquer_mon_indication(e){e.parentNode.childNodes[1].style.visibility="hidden"}function impossible_de_cliquer(){return element_DOM("img_chargement").style.visibility==="visible"}function deconnexion(){chargement(true);var e="";mon_role=init_mon_role();tout_effacer_sauf(["identifiant_courant","mode_nuit_oui","notifs_sans_actualiser","date_heure_depassement"]);image_temporaire="";nom_image_temporaire="";supprimer_tous_les_parametres();setTimeout(function(){location.href="/"},1e3);envoyer_log(recuperer("identifiant_courant"),"Deconnexion",e,mon_role)}function recuperer_devoirs(e){if(!recuperer("dossier_chargé"))return-1;if(impossible_de_cliquer())return-1;afficher_fenetre(false);var r=element_DOM("rendu_devoir").style.visibility==="visible";if(e)r=false;afficher_fenetre_rendudevoir(!r)}function afficher_devoirs(e){if(e){element_DOM("a-rendre").style.visibility="visible"}else{element_DOM("a-rendre").style.visibility="hidden"}}function trier_par_identifiant(e,r){var i=e.u.toLowerCase();var t=r.u.toLowerCase();return i<t?-1:i>t?1:0}function recuperer_profs(t){var n=JSON.parse(recuperer("mes_matieres")).map(e=>e["Ie"]).sort();var a=[];url=racine_data+"Trombinoscope_profs"+"?"+apikey;return get_resultat_asynchrone(url).then(function(e){var r=e.sort(trier_par_identifiant);if(recuperer("mon_type")==="Eleves"){n.forEach(function(i,e){le_prof=r.filter(e=>e["o"].includes(i));if(le_prof.length>0){le_prof.forEach(function(r){a_ajouter=a.filter(e=>e["u"]===r["u"]).length===0;r["o"]=i;if(a_ajouter)a.push(r)})}})}else{a=r}if(t){chargement(false);return a}else{var i="Liste de vos professeurs";vider_fenetre(i);traitement_trombino(a,true);afficher_fenetre(true)}})}function recuperer_admin(i){if(impossible_de_cliquer())return-1;chargement(true);var e=JSON.parse(recuperer("mes_donnees"))["me"];nom_table="Trombinoscope_admin";nom_champ_reference="Cycle";valeur_champ_reference=e;nom_champ_a_chercher="";return rechercher(nom_table,nom_champ_reference,valeur_champ_reference,nom_champ_a_chercher).then(e=>{if(i){chargement(false);return e}else{var r="Membres de l'Administration - "+valeur_champ_reference;vider_fenetre(r);afficher_fenetre(true);traitement_trombino(e,true,true);chargement(false)}})["catch"](e=>{console.error(e);alert("Cycle introuvable, veuillez réessayer.");chargement(false)})}function recuperer_eleves(i){if(impossible_de_cliquer())return-1;if(!recuperer("mon_type").includes("Admin")&&element_DOM("accueil_utilisateur").innerText.includes("Vie scolaire")){alert("Vous n'avez pas les droits pour consulter cette liste.");return-1}chargement(true);var e=recuperer("mon_type").includes("Eleves")?JSON.parse(recuperer("mes_donnees"))["o"]:la_matiere_chargee("Classe");if(recuperer("mon_type")==="Administration"&&e==="classe_matiere_introuvable")e="Tous";var r=JSON.parse(recuperer("mes_donnees"))["me"];nom_table="Trombinoscope";nom_champ_reference=e==="Tous"?"Cycle":"Classe";valeur_champ_reference=e==="Tous"?r:e;nom_champ_a_chercher="";return rechercher(nom_table,nom_champ_reference,valeur_champ_reference,nom_champ_a_chercher).then(e=>{if(i){chargement(false);return e}else{var r="Liste des élèves en "+valeur_champ_reference;vider_fenetre(r);afficher_fenetre(true);traitement_trombino(e,false);chargement(false)}})["catch"](e=>{console.error(e);alert("Classe introuvable, veuillez réessayer.");chargement(false)})}function recuperer_logs(){chargement(true);if(recuperer("mon_type")!=="Profs"){var e=JSON.parse(recuperer("mes_donnees"))["o"];var r="logs_classe";var i="Historique des connexions"}else{var e=la_matiere_chargee("Classe");var r="classe";var i="Liste des élèves en "+e}vider_fenetre(i);var t='<a id="telechargement" style="position: fixed;z-index:3;" href = "#"><img alt="télécharger" class="window-btn" id="telechargement" src="'+prefixe_image+'/img_download.png""></a>';var n=document.createElement("div");n.innerHTML=t;while(n.firstChild)element_DOM("entete-fenetre").appendChild(n.firstChild);ajuster_boutons_fenetre();ajuster_boutons_fenetre(true);choisir_height_viz_si_pdf();afficher_fenetre(true);var a="https://script.google.com/macros/s/AKfycbzEamQPPrrqUl-_ac8Ddqf0cfWq3hPqF1Z-5qJ0JI95w2ybULd8/exec";var s='<form method="post"  action="'+a+'" id="recuperer_logs" style="display: none;" >';s+='<input type="hidden" name="'+r+'" value="'+e+'" >';s+="</form>";$("body").append(s);var o=$("#recuperer_logs");$.m({type:"POST",url:a,data:o.W(),p:function(i){traitement_logs(i["Ne"]);if(element_DOM("telechargement")){element_DOM("telechargement").onclick=function(e){var r=convertir_csv(i["Ne"]);r=encodeURIComponent(r);console.log(r);telecharger("Historique_des_connexions",r)}}$("#recuperer_logs").remove()},error:function(e){console.log("erreur! "+e);alert("Vérifiez que vous êtes toujours connecté à internet.");chargement(false)}})}function telecharger(e,r){var i=document.createElement("a");i.style.display="none";i.setAttribute("href","data:text/csv;charset=utf-8,%EF%BB%BF"+r);i.setAttribute("download",e+".csv");document.body.appendChild(i);i.click();document.body.removeChild(i)}var nombre_changement_ecolage=0;function traitement_trombino(e,l,d){var m=document.createElement("div");m.id="liste_des_eleves";m.className="liste_des_eleves";element_DOM("fenetre").appendChild(m);e=e.filter(function(e,r){return e["me"]===JSON.parse(recuperer("mes_donnees"))["me"]});e.forEach(function(e,r){var i="";var t=JSON.parse(recuperer("mes_donnees"))["Ce"]==="oui"&&recuperer("mon_type").includes("Admin");if(t&&!l)i='<span class="toggle"><label class="switch"><input class="ecolage" id="'+e["u"]+'" type="checkbox"><span class="slider round"></span>\t</label></span>';var n=lien_pp(e["V"]);var a=recuperer("mon_type").includes("Admin")?bouton_modifier_pp(e["u"]):"";var s=recuperer("mon_type").includes("Admin")&&!n.includes("default-user.svg")?bouton_supprimer_pp(e["u"]):"";var o=!l?e["o"]:e["o"].split("|")[1].split(")")[0];if(d)o=e["ve"];var _='<div class="un_eleve"><img class="pp" id="pp_'+e["u"]+'" src='+n+">"+a+s+'<div><span class="element_eleve">'+e["fe"]+" "+e["pe"]+" <b>"+o+"</b></span></div>"+i+"</div>";var u=document.createElement("div");u.innerHTML=_;while(u.firstChild)m.appendChild(u.firstChild);if(t&&!l){var c=e["Ae"]==="oui";element_DOM(e["u"]).checked=c}});if(!l){$(".ecolage").$("change",function(e){nombre_changement_ecolage=nombre_changement_ecolage+1;chargement(true);var r=e.target.checked?"oui":"non";var i={Ae:r};var t="Eleves";var n="Identifiant";var a=e.target.id;actualiser(t,n,a,i);chargement(false)})}element_DOM("titre_fenetre").innerHTML+=" ("+e.length+")";if(!recuperer("mon_type").includes("Administration")&&(recuperer("dossier_chargé")===""||recuperer("dossier_chargé")===null)&&!l)decharger_dossier_final()}function tri_ordre_chrono_decroissant(e,r){return new Date(r.ae).getTime()-new Date(e.ae).getTime()}function traitement_logs(e){var a=document.createElement("div");a.style.position="relative";a.style.overflowX="hidden";a.style.overflowY="auto";a.id="liste_des_logs";a.style.height="90%";element_DOM("fenetre").appendChild(a);e.sort(tri_ordre_chrono_decroissant);e.forEach(function(e,r){var i=afficher_date(e["ae"]);var t='<div style="padding-left: 2%;padding-bottom: 2%;">'+e["Re"]+" le "+i+" "+e["u"]+" </div>";var n=document.createElement("div");n.innerHTML=t;while(n.firstChild)a.appendChild(n.firstChild)});if(element_DOM("titre_fenetre")==="Historique des connexions")element_DOM("titre_fenetre").innerHTML+=" ("+e.length+")";chargement(false)}function CreateTableFromJSON(e){var r=[];for(var i=0;i<e.length;i++){for(var t in e[i]){if(r.indexOf(t)===-1){r.push(t)}}}var n=document.createElement("table");var a=n.insertRow(-1);for(var i=0;i<r.length;i++){var s=document.createElement("th");s.innerHTML=r[i];a.appendChild(s)}for(var i=0;i<e.length;i++){a=n.insertRow(-1);for(var o=0;o<r.length;o++){var _=a.insertCell(-1);_.innerHTML=e[i][r[o]]}}var u=element_DOM("fenetre");u.appendChild(n)}function initialisation(){chargement(true);attribuer_les_clics();mettre_mon_mode();appliquer_preferences();document.title="Sekooly | "+nom_etablissement.toUpperCase();effacer("date_heure_depassement");if(recuperer("mes_donnees")===""||recuperer("mon_type")===""||recuperer("mes_donnees")===null||recuperer("mon_type")===null){tout_quitter()}else{configurer_profil();mon_role=init_mon_role();return chargement_a_larrivee()}chargement(false)}function tout_quitter(){document.body.style.display="none";deconnexion()}function afficher_fenetre(e){if(e){element_DOM("fenetre").style.visibility="visible"}else{element_DOM("fenetre").style.visibility="hidden"}}function afficher_logs(e){if(element_DOM("recup_logs")){if(e)element_DOM("recup_logs").style.visibility="hidden";if(!e)element_DOM("recup_logs").style.visibility="hidden"}}function afficher_edt(e){if(e){element_DOM("recup_edt").style.display="block";if(JSON.parse(recuperer("mes_donnees"))["me"]==="Primaire")element_DOM("recup_edt").style.display="none"}else{element_DOM("recup_edt").style.display="none"}}function afficher_liste_eleves(e){if(e)element_DOM("recup_eleves").style.display="";if(!e)element_DOM("recup_eleves").style.display="none"}function check_maintenance(){var e="https://script.google.com/macros/s/AKfycbxgtxDhZ9g8-lo5e4aux1otiYyWsgg38TXmZunQ1VnPZ7JpjzA/exec";var r=recuperer("identifiant_courant");var i=recuperer("mon_type").split("_")[0];var t=r&&i?"&moi="+r+"&mon_type="+i:"";var n=e+"?check_maintenance=oui"+t;return $.m({url:n})}function mettre_le_contact_etablissement(){var e=contact_etablissement;if($("#contact_etablissement")[0]){$("#contact_etablissement")[0].href="mailto:"+e;$("#contact_etablissement")[0].innerText=e;stocker("contact_etablissement",e)}if($("#logo_etablissement")[0])$("#logo_etablissement")[0].src=prefixe_image+"/"+nom_fichier_logo;if($("#site_etablissement")[0])$("#site_etablissement")[0].href=site_etablissement}function attribuer_les_clics(){au_clic("#a2hs","ajouter_a_laccueil()");au_clic('[class="haut_droite dropdown"]',"switch_side_bar_top()");au_clic("#recup_notifs, #bulle_notif","switch_pannel_notifs()");au_clic("#recup_msgs, #bulle_notif_msg","recuperer_msgs(true)");au_clic("#rechercher_element","faire_la_recherche_fichier()");au_clic("#menu","switch_side_bar()");au_clic('[class="sidebar left"]',"fermer_si_non_recherche(event)");au_clic("#side-bar-profil","afficher_modif_profil()");au_clic("#side-bar-edt","edt()");au_clic("#side-bar-day","ma_journee()");au_clic("#dashboard","tableau_de_bord()");au_clic("#side-bar-prog","recuperer_programme()");au_clic("#side-bar-conseil","conseils_de_classe()");au_clic("#side-bar-remed","remediations()");au_clic("#side-bar-bulletins","clic_bulletin()");au_clic("#side-bar-irl","gerer_notifs_irl()");au_clic("#side-bar-help","retourner_site()");au_clic("#side-bar-night","changer_mode()");au_clic("#side-bar-review","emettre_avis_sekooly()");au_clic("#side-bar-top-right","fermer_side_bar()");au_clic("#recup_eleves","recuperer_eleves()");au_clic("#recup_profs","recuperer_profs()");au_clic("#recup_admin","recuperer_admin()");au_clic("#recup_params","recuperer_parametres()");au_clic("#recup_pref","recuperer_preferences()");au_clic("#recup_analyses","recuperer_analyses()");au_clic("#disconnect","deconnexion()");au_clic("#afficher","charger_les_topics()");au_clic("#a-rendre","recuperer_devoirs()");au_clic("#visioconference","rejoindre_visio()");au_clic("#gerer-bulletins","clic_bulletin()");au_clic("#img_ajout","afficher_ou_non_choix_fichier(true)");au_clic("#par_la_date_effet, #par_filtre_id_chapitre","choisir_ce_mode(this)");au_clic("#config-date-prog","switch_config_mode()");au_clic("#est_video_youtube","switch_affichage_youtube()");au_clic("#est_extrait_manuel","switch_extrait_manuel()");au_clic("#bye_prev_upload","afficher_ou_non_choix_fichier(false)");au_clic("#bye_prev_rendu","afficher_fenetre_rendudevoir(false)");au_clic("#helper-categ","alert('Si vous attendez un rendu de la part des élèves, catégorisez votre fichier en Devoirs/Examens/Quiz.')");au_clic("#helper-prog","help_chapitre()");au_clic("#helper-coef","alert('Si ce rendu est noté et compte dans le bulletin scolaire, merci de mettre un coefficient > 0.')");au_clic("#helper-dev","aide_devoirs()");au_clic("#supprimer_page","supprimer_derniere_page_devoir()");au_clic("#ajouter_page","ajouter_page_devoir()");au_clic("#bouton_rendre_devoir","rendre_devoir()");au_clic("#run-quiz-dev","$('#'+element_DOM('devoir_choisi').value).click()")}function help_chapitre(){alert("Choisir le chapitre permet de mieux retrouver votre fichier.\nPour gérer les chapitres de votre matière, vous pouvez aller en haut à gauche -> Programme scolaire.")}function chargement_a_larrivee(){chargement(true);fermer_side_bar();mettre_le_contact_etablissement();rendre_td_modifiable();mettre_les_soons();ajouter_multi_visio_si_non_eleve();notifs_reelles_ou_non();var e=JSON.parse(recuperer("mes_donnees"))["me"];est_en_maintenance().then(function(e){var r=JSON.parse(recuperer("mes_donnees"))["Te"];if(e==="oui"&&(!window.location.href.includes("file:///")&&!window.location.href.includes("http://localhost:8000"))&&r!=="oui"){deconnexion()}});if(!mon_ecolage_est_ok())deconnexion();if(!plateforme_prete()){return initialisation_de_la_plateforme()}effacer("nb_clics");effacer("numero_etape");mettre_en_place_les_notifications();var r=JSON.parse(recuperer("mes_donnees"))["Pe"];afficher_logs(r==="oui");if(recuperer("mon_type").includes("Administration")&&r==="oui"){n=get_resultat(racine_data+"/Matieres?Cycle=eq."+e+"&"+apikey);n=n.sort(function(e,r){return e.Ie>r.Ie});stocker("mes_matieres",JSON.stringify(n))}var i=recuperer("dossier_chargé")||recuperer("mon_type")==="Eleves";affichage_liste=recuperer("mon_type").includes("Administration")||recuperer("mon_type")==="Profs"&&recuperer("dossier_chargé")!==null&&recuperer("dossier_chargé")!=="";afficher_liste_eleves(affichage_liste);afficher_bulletins(false);if(recuperer("mon_type").includes("Eleve"))afficher_bulletins(true);if(recuperer("mon_type").includes("Prof"))supprimer_bulle_bulletins();afficher_params_si_droits_et_admin();window.scrollTo(0,0);calcul_grid_gap_barre_verticale();gerer_sondage();if((recuperer("dossier_chargé")===""||recuperer("dossier_chargé")===null)&&recuperer("mes_donnees")!==""){configurer_profil();afficher_ajout(false);afficher_discussions(false);afficher_devoirs(false);afficher_tri_fichiers(false);afficher_visio(false);if(recuperer("mon_type").includes("Administration"))stocker("mon_type","Administration");ajouter_les_dossiers_dynamiques();afficher_alerte_etablissement()}else{var t=recuperer("dossier_chargé");var n=JSON.parse(recuperer("mes_matieres"));var a=n.filter(function(e){if(e!==null)return e["Je"]===t});var s=a[0].o+"\n"+a[0].q;if(recuperer("mon_type")==="Eleves")s=a[0].q;afficher_alerte_etablissement();return charger_dossier(t,true,s).then(function(){if(recuperer("fichier_ouvert")){var e=recuperer("fichier_ouvert");element_DOM(e).click()}})}valider_suppression_via_mail_si_besoin();appliquer_preferences();chargement(false)}function afficher_params_si_droits_et_admin(){if(recuperer("mes_donnees")&&recuperer("mon_type")){var e=JSON.parse(recuperer("mes_donnees"))["Pe"];var r=recuperer("mon_type").includes("Admin")&&e==="oui";afficher_parametres(r)}else{afficher_parametres(false)}}function afficher_alerte_etablissement(){$("#texte_alerte")[0].innerText=recuperer_alerte_etablissement()}function afficher_alerte_etablissement_old(){alerte_etablissement().then(e=>{$("#texte_alerte")[0].innerText=e})}function calcul_grid_gap_barre_verticale(){la_barre=element_DOM("barre_verticale");if(la_barre){la_barre.style.gridGap=$(window).height()/(element_DOM("barre_verticale").childElementCount+1)+"px"}}function valeursUniquesDeCetteKey(e,r){if(e!=="null"&&e!==null){const s=[r];var i=[],t=[],n=e.length,a;for(a=0;a<n;a++){if(e[a]!==null){if(i[e[a][s]])continue;i[e[a][s]]=true;t.push(e[a][s])}}}else{t=[]}return t}function ajouter_les_dossiers_dynamiques(){if($("#liste_matieres")[0].children.length>0)return true;afficher_le_drive(false);var e=JSON.parse(recuperer("mes_matieres"));if(recuperer("mon_type")==="Administration"){var r=valeursUniquesDeCetteKey(e,"Classe").sort();var i=[];r.forEach(function(r){i.push(e.find(e=>e["o"]===r)["l"])});r.some(function(e,r){if(e===undefined||r===undefined)return-1;if(e!=="Tous")ajouter_le_dossier(e,i[r],recuperer("mon_type"))})}else{ajout_dossiers_matieres(e)}stocker_temp("dossier_chargé","");stocker("les_fichiers","");stocker("fichier_ouvert","");stocker("les_topics","");stocker("les_coms","")}function ajout_dossiers_matieres(e){e.some(function(e){if(e!==null){var r=e.o;var i=e.q;var t=prefixe_image+"/img_dossier_"+e.Ue.replace(/ /g,"")+".png";if(r!==undefined&&i!==undefined){var n=e.URL;var a=n.split("/").pop();if(recuperer("mon_type")==="Profs"||recuperer("mon_type")==="Administration_bis"){i=e.Ie}ajouter_le_dossier(i,a,recuperer("mon_type"),t)}else{return-1}}})}function ajouter_le_dossier(e,r,i,t){if($(".une_matiere_en_dossier#"+r).length>0)return-1;if(i==="Profs"||i==="Administration_bis"){var n=e.substring(e.lastIndexOf("(")+1,e.lastIndexOf("|"));var a=e.substring(e.lastIndexOf("|")+1,e.lastIndexOf(")"))}else{var n="";var a=e}var s=creer_nouveau_dossier();creer_span_div(s,r,n,a,t);if(i!=="Administration"&&i!=="Administration_final"){ajouter_listener_dossier(r)}else{ajouter_listener_dossier_non_final(r)}}function ajouter_listener_dossier_non_final(e){element_DOM(e).addEventListener("click",function(r){$("#accueil_utilisateur").Ve("click");if(element_DOM(r.target.id)){element_DOM("accueil_utilisateur").innerHTML=element_DOM(r.target.id).innerText;mettre_infos_matiere(false)}element_DOM("liste_matieres").innerHTML="";stocker("mon_type","Administration_bis");var e=JSON.parse(recuperer("mes_matieres"));var i=e.filter(function(e){if(e!==null)return e["l"]===r.target.id});ajout_dossiers_matieres(i);avec_bouton_back(true);window.scrollTo(0,0)})}function ajouter_listener_dossier(e){element_DOM(e).addEventListener("click",function(e){$("#pannel_notif")[0].innerHTML="";var r=$("span[id='"+e.target.id+"']").text().trim();charger_dossier(e.target.id,true,r)})}function creer_nouveau_dossier(){var e=document.createElement("div");element_DOM("liste_matieres").appendChild(e);return e}function creer_span_div(e,r,i,t,n){if(i!==""){var a=i+"<br> "}else{var a=""}if(recuperer("mon_type")!=="Administration"){var s=n}else{var s=prefixe_image+"/dossier_drive.png"}e.innerHTML='<a class="une_matiere_en_dossier" id="'+r+'" href="javascript:void(0)" > <span id="'+r+'"> <img class = image_centre id="'+r+'" src="'+s+'">  '+a+t+" </a> </span>"}function mettre_aujourdhui(){element_DOM("la_date_effet").innerHTML="";var e=moment();var r=e.format("yyyy-MM-DD");var i="Aujourd'hui";ajouter_date_filtre(r,i,true)}function ajouter_date_filtre(e,r,i){if(e===moment().format("yyyy-MM-DD")&&!i)return-1;var t='<option value="'+e+'">'+r+"</option>";var n=document.createElement("div");n.innerHTML=t;element_DOM("la_date_effet").appendChild(n.firstChild)}async function infos_matiere(){id_matiere=recuperer("dossier_chargé");la_matiere=la_matiere_chargee("Matiere");description=await rechercher("Matieres","ID_URL",id_matiere,"description");if(description){description=description[0]["description"];lire_description(id_matiere,la_matiere,description)}}function lire_description(e,r,i){elements_html='<div class="description_matiere" id="content">'+i+"</div>";intitule_bouton=recuperer("mon_type")==="Eleves"?"Fermer":"Editer la description";fonction_bouton=recuperer("mon_type")==="Eleves"?"$('#mini_popup').remove()":"editer_description_matiere('"+e+"','"+r+"')";creer_mini_popup(r,elements_html,intitule_bouton,fonction_bouton,false,false,false,false,"25")}function editer_description_matiere(e,r){$("#foot_modifs").remove();description=element_DOM("content").innerHTML;vider_fenetre("Description de "+r,false,"sauvegarder_description()");afficher_fenetre(true);$("#mini_popup").remove();$("#fenetre").append('<div class="edition"><div id="description_matiere">'+description+"</div></div>");rendre_riche("description_matiere",true)}function saisie_vide(){return'<br data-cke-filler="true">'}function pied_modifs(){var e="<div id='foot_modifs'><br><br><gris><i>Dernière modification: "+afficher_date(maintenant());e+="<br>Par: "+recuperer("identifiant_courant").toUpperCase()+"</i></gris></div>";return e}async function sauvegarder_description(){console.log("Enregistrement de la description...");nouvelle_description=recuperer_html_saisie_riche().includes(saisie_vide())?"Aucune description fournie":recuperer_html_saisie_riche();nouvelle_description+=pied_modifs();await supabase.from("Matieres").update({description:nouvelle_description}).match({Je:recuperer("dossier_chargé")});afficher_alerte("Description de la matière sauvegardée.")}function charger_dossier(e,r,i){$("#barre_verticale")[0].style.display="grid";if(e!==""&&e!==null){stocker_temp("dossier_chargé",e);var t=recuperer("mode_prefere")||"par_la_date_effet";choisir_ce_mode($("#"+t)[0]);chercher_mes_chapitres(true);$("#accueil_utilisateur").Ve("click");$("#la_date_effet").$("change click",function(e){filtrer_date_effet()});$("#filtre_id_chapitre").$("change click",function(e){filtrer_chapitre()});stocker("les_topics","");stocker("topic_chargé","");stocker("nb_com_actuel","");stocker("les_coms","");chargement(true);afficher_les_dossiers_dynamiques(false);element_DOM("accueil_utilisateur").innerHTML=i;mettre_infos_matiere(true);avec_bouton_back(true);afficher_devoirs(true);afficher_discussions(true);afficher_tri_fichiers(true);afficher_visio(true);if(recuperer("mon_type")==="Profs"){afficher_ajout(true);afficher_liste_eleves(true);afficher_bulletins(false)}else if(recuperer("mon_type").includes("Administration")){var n=JSON.parse(recuperer("mes_donnees"))["Pe"];afficher_ajout(n==="oui");afficher_liste_eleves(true);afficher_bulletins(true)}else{afficher_ajout(false);afficher_liste_eleves(false);afficher_bulletins(true)}if(recuperer("mon_type")==="Administration_bis")stocker("mon_type","Administration_final");afficher_discussions(true);afficher_le_drive(true);return recuperer_les_fichiers(e)}}function chercher_mes_chapitres(e){if(e)stocker("mes_chapitres","[]");var r=JSON.parse(recuperer("mes_chapitres"));var i=recuperer("dossier_chargé");if(!r||!r[i]){var t=racine_data+"Programme?ID_URL=eq."+i+"&limit=150&order=intitule_chapitre.asc"+"&"+apikey;r=get_resultat(t);mes_chapitres_str=JSON.stringify(r);chapitre_a_rajouter={[i]:mes_chapitres_str};chapitre_a_rajouter_str=JSON.stringify(chapitre_a_rajouter);if(r.length>0)stocker("mes_chapitres",chapitre_a_rajouter_str)}var n=recuperer_chapitres_locaux(i);mettre_la_liste_de_chapitres();return n}function recuperer_chapitres_locaux(e){try{var r=JSON.parse(JSON.parse(recuperer("mes_chapitres"))[e])}catch(i){var r=[]}return r}function mettre_la_liste_de_chapitres(e){var r=recuperer("dossier_chargé");var i=recuperer_chapitres_locaux(r);var t="";i.forEach(function(e){t+=un_chapitre_liste(e)});if(e){return'<option value="--">(Aucun chapitre)</option>'+t}else{$(".un_chapitre_dans_la_liste").remove();liste_de_mes_chapitres_filtre=t+'<option class="un_chapitre_dans_la_liste" value="Tous">Tous les fichiers</option>';t+='<option class="un_chapitre_dans_la_liste" value="new" style="font-style: oblique;">Nouveau chapitre</option>';$("select#id_chapitre").append(t);$("select#filtre_id_chapitre").append(liste_de_mes_chapitres_filtre);$("select#id_chapitre").Ve("change");$("select#id_chapitre").$("change",function(e){if(e.target.value==="new")creer_chapitre()})}}function un_chapitre_liste(e){return'<option class="un_chapitre_dans_la_liste" value='+e["Se"]+">"+e["Le"]+"</option>"}function recuperer_les_fichiers(e){chargement(true);enlever_alerte_vide(false);nom_table="Fichiers";nom_champ_reference="id_dossier";valeur_champ_reference=recuperer("dossier_chargé");nom_champ_a_chercher="";return rechercher(nom_table,nom_champ_reference,valeur_champ_reference,nom_champ_a_chercher).then(e=>{les_fichiers="[]";if(e.length>0)les_fichiers=JSON.stringify(e);stocker("les_fichiers",les_fichiers);traitement_fichiers_recus();chargement(false)})["catch"](e=>{console.error(e);alert("Erreur : fichiers impossibles à récupérer pour cette classe.");chargement(false)})}function enlever_alerte_vide(e){if(element_DOM("alerte_vide"))element_DOM("alerte_vide").remove();if(e===false){Array.from(document.getElementsByClassName("ma_liste")).forEach(function(e,r,i){e.innerHTML="";element_DOM("titre_"+e.id).style.display="none"})}}function dossier_vide(e){enlever_alerte_vide(e);var r=document.createElement("div");r.id="alerte_vide";r.style.top="100px";r.style.position="relative";var i=$("#la_date_effet").find(":selected").text();var t=$("#filtre_id_chapitre").find(":selected").text();var n=$(".mode_choisi").length>0?$(".mode_choisi")[0].id==="par_la_date_effet":true;var a=n?i:t;r.innerHTML='<i style="width: max-content;color: #d9d8db;">Il n\'y a pas encore de fichiers pour '+a+".</i>";afficher_le_drive(false);document.body.insertBefore(r,element_DOM("gros_conteneur"))}function la_date_yyyy_mm_dd(e){var r=new Date(Date.parse(e));var i=r.getDate();var t=r.getMonth()+1;var n=r.getFullYear();return""+n+"-"+(t<=9?"0"+t:t)+"-"+(i<=9?"0"+i:i)}function initialisation_date_tri(e){mettre_aujourdhui();var r=valeursUniquesDeCetteKey(e,"date_effet");var r=r.sort();var i=r.map(e=>afficher_date(e,true));for(var t=0;t<r.length;t++){var n=la_date_yyyy_mm_dd(r[t]);var a=i[t];ajouter_date_filtre(n,a)}ajouter_date_filtre("Tous","Tous les fichiers");var s=moment().format("yyyy-MM-DD");element_DOM("la_date_effet").value=s}function traitement_fichiers_recus(){var e=recuperer("les_fichiers");var r=JSON.parse(e);initialisation_date_tri(r);if(!recuperer("mon_type").includes("Administration")){r=r.filter(e=>e["De"]!=="Bulletins")}if(e===""||r.length===0){dossier_vide(false)}else{enlever_alerte_vide(false);r.sort(function(e,r){if(e.P<r.P){return-1}if(e.P>r.P){return 1}return 0});r.forEach(function(e){ma_categorie=e["De"].toLowerCase();var r=e["P"];var i=r.split(".").pop().toLowerCase();var t=afficher_date(e["Fe"],true);var n=e["Ke"]?" à "+e["Ke"]:"";if(ma_categorie==="examens"&&e["Fe"].length===0){date_debut=la_date_yyyy_mm_dd(e["ze"]);date_debut=moment(date_debut+" "+e["Ye"]);t=date_debut;nb_heures_delai_examen=data_etablissement["R"]||12;t=t.add(nb_heures_delai_examen,"hours");n=" à "+t.format("YYYY-MM-DD HH:mm").split(" ")[1];t=afficher_date(t,true)}valeur_coef=e["Y"]>0?"<b>Coeff. "+e["Y"]+"</b>":"";if(ma_categorie==="devoirs"||ma_categorie==="examens")r=e["P"]+"<rouge><i>(à rendre avant le "+t+n+")<br>"+valeur_coef+"</i></rouge>";var a="drive_"+ma_categorie;ajouter_un_fichier(e["V"],r,a,i,e["ze"],e["Ye"],e["we"],e["Y"],e["Fe"],e["Ke"],e["Be"],e["He"],e["Se"])});var i=id_mode_affichage();filtrer_avec_le_bon_filtre(i);chargement(false)}if(recuperer("dossier_chargé")===""||recuperer("dossier_chargé")===null)decharger_dossier_final();chargement(false)}function id_mode_affichage(){return recuperer("mode_prefere")?recuperer("mode_prefere").replace("par_",""):"la_date_effet"}function garder_les_manuels(){if($("#drive_manuels")[0].children.length>0){$("#titre_drive_manuels")[0].style.display="initial";$("#drive_manuels")[0].style.display="";for(var e=$("#drive_manuels")[0].children.length-1;e>=0;e--){$("#drive_manuels")[0].children[e].style.display=""}}}function highlightDays(e,r){for(var i=0;i<e.length;i++){if(e[i]==r){return[true,"highlight"]}}return[true,""]}function masquer_drive_vide(){Array.from(document.getElementsByClassName("ma_liste")).forEach(function(e,r,i){var t=$("#"+e["id"]).find(".span_un_fichier:visible").length;if(t===0){element_DOM(e.id).style.display="none";element_DOM("titre_"+e.id).style.display="none"}else{element_DOM(e.id).style.display="grid";element_DOM("titre_"+e.id).style.display="initial"}});if($("#gros_conteneur").find(".span_un_fichier:visible").length===0)dossier_vide(true)}function ajouter_un_fichier(r,e,i,t,n,a,s,o,_,u,c,l,d){var m=prefixe_image+"/img_icone_"+t+".png";var f=s==="oui"?"":' style="padding-top: 25%;" ';var p=s==="oui"?'<img alt="télécharger" src="'+prefixe_image+'/img_download.png" onclick="telecharger_fichier(event,this)" id="telecharger" class="download_fichier">':"";var c=c?" periode_bulletin='"+c+"'":"";var l=l?" destinataire_par_page='"+l+"'":"";var d=d?" id_chapitre='"+d+"'":"";var v='<span oncontextmenu="autoriser_clic_droit_supprimer_et_renommer(event,this)" onclick="ouvrir_fichier(this)" class="span_un_fichier" id="'+r+'" ma_date_effet="'+la_date_yyyy_mm_dd(n)+'" mon_heure_effet="'+a+'" ma_date_limite="'+la_date_yyyy_mm_dd(_)+'" mon_heure_limite="'+u+'" est_telechargeable="'+s+'"    coefficient_rendu='+o+c+l+d+"    >"+p+'<img id="'+r+'" src="'+m+'" class="un_fichier" '+f+">"+e+"</span>";var h=document.createElement("div");h.innerHTML=v;while(h.firstChild){element_DOM(i).appendChild(h.firstChild)}$("#"+r+" .un_fichier").Qe("error",function(e){$("#"+r+" .un_fichier").Z("src",prefixe_image+"/img_fichier.png")});ajouter_cadenas_examen(r,i)}function ajouter_cadenas_examen(e,r){if(r==="drive_examens"){var i=fichier_ouvrable(e,false)===false;if(i){$(".span_un_fichier#"+e).append('<img alt="verrouillé" id="locked" src="'+prefixe_image+'/img_cadenas.png" class="locked">')}}}function bool_examen_terminé(e,r){var i=r.getAttribute("ma_date_effet");var t=r.getAttribute("mon_heure_effet").value;nb_heures_delai_examen=data_etablissement["R"]||12;var n=moment(i+" "+t,"yyyy-MM-DD hh:mm").add(nb_heures_delai_examen,"hours").T;var a=e==="drive_examens";var s=a&&moment(maintenant())>n;return s}function fichier_ouvrable(e,r,i){var t=recuperer("mon_type").split("_")[0];if(r){e=i.parentNode.id}var n=$("span#"+e+".span_un_fichier")[0];var a=n.parentNode.id;var s=n.getAttribute("mon_heure_effet")?n.getAttribute("mon_heure_effet"):"07:30";var o=moment(n.getAttribute("ma_date_effet")+" "+s);var _=moment(maintenant());if(a==="drive_corrections"&&(!t.includes("Admin")&&!t.includes("Prof"))&&o>_){return false}var u=JSON.parse(recuperer("mes_donnees"));var c=u["Xe"]?u["Xe"]==="oui":t==="Profs";var l=bool_examen_terminé(a,n);if(a==="drive_examens"&&!c&&(o>_||l)){return false}else{}return true}function ouvrir_fichier(e){var r=e.id;var i=$("[id="+r+"].span_un_fichier")[0];if(!fichier_ouvrable(r)){var t=i.getAttribute("mon_heure_effet")?i.getAttribute("mon_heure_effet"):"07:30";var n=i.parentNode.id;if(bool_examen_terminé(n,i)){alert("Ce sujet d'examen n'est plus disponible.")}else{date_heure_fichier=e.attributes["C"].value+" "+t;alert("Ce fichier n'est pas disponible avant "+afficher_date_old(moment(date_heure_fichier).format("DD/MM/YYYY HH:mm"))+".")}return-1}else{stocker("fichier_ouvert",r);var a=$("span#"+r+".span_un_fichier").N().filter(function(){return this.nodeType==3})[0].nodeValue;a=rfc3986EncodeURIComponent(a);visualiser(a,r,"","",i.getAttribute("est_telechargeable")!=="oui")}}function telecharger_fichier(e,r){if(!fichier_ouvrable(t,true,r)){le_span_un_fichier=$("[id="+t+"].span_un_fichier")[0];var i=le_span_un_fichier.getAttribute("mon_heure_effet")?le_span_un_fichier.getAttribute("mon_heure_effet"):"07:30";alert("Ce fichier n'est pas disponible avant "+afficher_date(r.parentNode.attributes["C"].value+" "+i));return-1}chargement(true);e.stopPropagation();var t=r.parentNode.id;window.location.href="https://drive.google.com/uc?export=download&id="+t;chargement(false)}function autoriser_clic_droit_supprimer_et_renommer(e,r){if(recuperer("mon_type")==="Eleves")return-1;if(recuperer("mon_type").includes("Administration")){var i=JSON.parse(recuperer("mes_donnees"))["Pe"];if(i!=="oui")return-1}if(!recuperer("mon_type").includes("Admin")&&element_DOM("accueil_utilisateur").innerText.includes("Vie scolaire")){return-1}if($("#"+r.id)[0].parentNode.id==="drive_manuels"){if(!recuperer("mon_type").includes("Admin")){return-1}else{if(JSON.parse(recuperer("mes_donnees"))["Pe"]!=="oui")return-1}}e.preventDefault();e.stopPropagation();var t=r.id;$(".clic_droit").remove();ajouter_fonction_clic_droit(e,r,0,"renommer_fichier","Renommer",t);ajouter_fonction_clic_droit(e,r,1,"changer_chapitre_fichier","Assigner un chapitre",t);ajouter_fonction_clic_droit(e,r,2,"recategoriser_fichier","Recatégoriser",t);ajouter_fonction_clic_droit(e,r,3,"changer_date_effet","Date d'effet",t);if($("#"+r.id)[0].parentNode.id==="drive_devoirs"){ajouter_fonction_clic_droit(e,r,4,"changer_date_limite_rendu","Date limite de rendu",t);mon_offset=1}else{mon_offset=0}if($("#"+r.id)[0].parentNode.id==="drive_bulletins"){ajouter_fonction_clic_droit(e,r,4,"changer_periode_bulletin","Période du bulletin",t);mon_offset=mon_offset===1?2:1}ajouter_fonction_clic_droit(e,r,4+mon_offset,"changer_coef","Coefficient",t,null,$("#"+t)[0].getAttribute("coefficient_rendu"));ajouter_fonction_clic_droit(e,r,5+mon_offset,"changer_telechargeable","Téléchargeable ou non",t);ajouter_fonction_clic_droit(e,r,6+mon_offset,"supprimer_fichier","Supprimer",t);$(document).click(function(){$(".clic_droit").remove();$("#clic_droit_titres_param").remove()})}function changer_chapitre_fichier(e,r){var i='<select id="nouveau_chapitre">';i+=mettre_la_liste_de_chapitres(true);i+="</select>";var t=$(".span_un_fichier[id='"+e+"']")[0].getAttribute("id_chapitre");creer_mini_popup("Chapitre de <b>"+r+"</b>",i,"Assigner le chapitre","changer_chapitre('"+e+"')",t,"nouveau_chapitre")}function changer_chapitre(e){nouveau_chapitre=$("#nouveau_chapitre")[0].value;nouvelle_donnee={V:e,Se:nouveau_chapitre};var r=racine_data+"Fichiers?id_fichier=eq."+e+"&"+apikey;patch_resultat_asynchrone(r,nouvelle_donnee);afficher_alerte("Le chapitre du fichier a bien été actualisé.",true)}function changer_eleve_par_page_bulletin(e,r){chargement(true);nb_pages=recuperer_nb_pages_pdf(e);chargement(false);r='{"nouveau":"1","test":"2"}';elements_html=modif_attribution_page_eleve(nb_pages,r);creer_mini_popup("Re-attribuez chaque page:",elements_html,"Attribuer","envoyer_modif_destinataires_bulletins('"+r+"')")}function envoyer_modif_destinataires_bulletins(e){chargement(true);nouveau_destinataire_par_page={1:"truc"};if(nouveau_destinataire_par_page===e)return-1;nom_table="Fichiers";nom_champ_reference="id_fichier";valeur_champ_reference=id_fichier;nouveau_data={He:nouveau_destinataire_par_page};actualiser(nom_table,nom_champ_reference,valeur_champ_reference,nouveau_data);setTimeout(function(){location.reload()},1e3);chargement(false)}function modif_attribution_page_eleve(e,r){liste_eleves=JSON.parse(r);console.log(liste_eleves);select_liste_eleves='<select style="width: 80%;" name="numero_page" id="numero_page"><option value="eleve_de_cette_page">eleve_de_cette_page</option></select>';attribution='<form id="attribution" style="margin-top: 20px;">';for(numero_page=1;numero_page<=e;numero_page++){nom_eleve=Object.keys(liste_eleves).find(e=>liste_eleves[e]===numero_page.toString());attribution=attribution+'<div><label for="'+numero_page+'">Page n°'+numero_page+":"+select_liste_eleves.replace(/"numero_page"/g,numero_page).replace(/"eleve_de_cette_page"/g,nom_eleve)+"</label></div>"}attribution=attribution+"</form>";return attribution}function changer_periode_bulletin(e,r){r=$("[id='"+e+"']")[0].getAttribute("periode_bulletin");var i=`<div><label for="periode_bulletin"><select style="width: 60%;" id="periode_bulletin" name="periode_bulletin"><option value="PREMIER TRIMESTRE">PREMIER TRIMESTRE</option><option value="DEUXIEME TRIMESTRE">DEUXIEME TRIMESTRE</option><option value="TROISIEME TRIMESTRE">TROISIEME TRIMESTRE</option><option value="ANNUEL">ANNUEL</option></select></label></div>`;creer_mini_popup("Choisissez la nouvelle période de ce bulletin:",i,"Modifier la période","changer_periode('"+e+"','"+r+"')");$("#periode_bulletin")[0].value=r}function changer_periode(e,r){nouvelle_periode=$("#periode_bulletin")[0].value;if(nouvelle_periode===r)return-1;chargement(true);nom_table="Fichiers";nom_champ_reference="id_fichier";valeur_champ_reference=e;nouveau_data={Be:nouvelle_periode};actualiser(nom_table,nom_champ_reference,valeur_champ_reference,nouveau_data);setTimeout(function(){location.reload()},1e3);chargement(false)}function changer_telechargeable(e,r){var i=$("[id='"+e+"'].span_un_fichier")[0].parentNode.id.split("_")[1];var t=$("[id='"+e+"']")[0].innerText.split(".")[1].split("\n")[0];if(i.includes("manuels")||i.includes("quiz")){alert("Impossible de rendre un manuel ou un quiz téléchargeable.");return-1}else if(i.includes("bulletins")){alert("Impossible de rendre un fichier de bulletins téléchargeable.");return-1}else if(t==="youtube"){alert("Impossible de rendre une vidéo youtube téléchargeable.");return-1}var r=$(".span_un_fichier[id='"+e+"']")[0].children[0].id==="telecharger"?"oui":"non";var n=prompt("Indiquez si 'oui' ou 'non' vous voulez que ce fichier soit téléchargeable:",r);if(n===null)return-1;chargement(true);n=n==="oui"?"oui":"non";if(n===r)return-1;nom_table="Fichiers";nom_champ_reference="id_fichier";valeur_champ_reference=e;nouveau_data={we:n};actualiser(nom_table,nom_champ_reference,valeur_champ_reference,nouveau_data);setTimeout(function(){location.reload()},1e3);chargement(false)}function changer_coef(e,r){var i=$("[id="+e+"].span_un_fichier")[0].parentNode.id.split("_")[1];if(!i.includes("devoirs")&&!i.includes("examens")&&!i.includes("quiz")){alert("Impossible de changer le coefficient d'un fichier différent d'un sujet de devoir/examen.");return-1}var t=prompt("Indiquez le nouveau coefficient du rendu:",r);if(t===null)return-1;t=Number(t);if(!(t>=0)){alert("Impossible de changer le coefficient : merci de saisir un coefficient valide (>0).");return-1}if(t===r)return-1;chargement(true);nom_table="Fichiers";nom_champ_reference="id_fichier";valeur_champ_reference=e;nouveau_data={Y:t};actualiser(nom_table,nom_champ_reference,valeur_champ_reference,nouveau_data);setTimeout(function(){location.reload()},1e3);chargement(false)}function ajouter_fonction_clic_droit(e,r,i,t,n,a,s,o){if(!o)o=decodeURI(encodeURIComponent(r.innerText).split("%0A")[0]);var _=document.createElement("span");if(!s)s="clic_droit";_.setAttribute("class",s);_.setAttribute("id",t);_.setAttribute("onclick","event.stopPropagation();"+t+'("'+a+'","'+o+'")');var u=i*40;_.style.top=Number(e.clientY+u)+"px";_.style.left=e.clientX+"px";_.innerHTML=n;r.appendChild(_);$(_).$("mouseover",function(e){_.style.filter="invert(100%)"});$(_).$("mouseout",function(e){_.style.filter=""});$(_).$("click",function(e){$(".clic_droit").remove()});return _}function recategoriser_fichier(e,r){var i=$("[id="+e+"].span_un_fichier")[0].parentNode.id.split("_")[1];if(i.includes("devoirs")){alert("Impossible de recatégoriser un devoir.");return-1}else if(i.includes("examen")){alert("Impossible de recatégoriser un examen.");return-1}else if(i.includes("quiz")){alert("Impossible de recatégoriser un quiz.");return-1}else{i=i.charAt(0).toUpperCase()+i.slice(1);var t=Array.from($("#categorie_choisie")[0].children).map(e=>e.value);var n=t.map(e=>'<option value="'+e+'">'+e+"</option>");var a='<select id="ma_liste_categories" style="width: 80%;">'+n+"</select>";creer_mini_popup(r,a,"Recatégoriser","mettre_a_jour_categorie('"+e+"')",i,"ma_liste_categories")}}function creer_mini_popup(e,r,i,t,n,a,s,o,_,u){$("#mini_popup").remove();var c='<div id="entete-fenetre" style="display: inline-flex;float: right;"><img  alt="X" src="'+prefixe_image+'/quitter.png" id="bye_prev" onclick="$(\'#mini_popup\').remove()" class="bye_prev"> </div>';var l=_?'style="border-bottom-style: ridge;font-size: '+_+'px;"':"";var d="<div "+l+" >"+e+"</div>";var m=u?"id='"+u+"'":"";var f='<button type="button"  '+m+'  class="rendre" onclick="'+t+'">'+i+"</button>";var p='<div id="mini_popup">'+c+d+r+f+"</div>";var v=document.createElement("div");v.innerHTML=p;document.body.appendChild(v.firstChild);if($("#"+a)[0])$("#"+a)[0].value=n;if($("#"+o)[0])$("#"+o)[0].value=s;ajuster_boutons_fenetre();ajuster_boutons_fenetre(true);choisir_height_viz_si_pdf()}function mettre_a_jour_categorie(e){var r=$("#ma_liste_categories")[0].value;if(impossible_de_cliquer())return-1;if(r==="--")return-1;if(r==="Devoirs"||r==="Examens"){alert("Il est pour l'instant impossible de recatégoriser un fichier en Devoirs/Examens.");return-1}chargement(true);nom_table="Fichiers";nom_champ_reference="id_fichier";valeur_champ_reference=e;nouveau_data={De:r};actualiser(nom_table,nom_champ_reference,valeur_champ_reference,nouveau_data);setTimeout(function(){location.reload()},1e3)}function changer_date_limite_rendu(e,r){var i='<input type="date" id="nouvelle_date_effet" class="date_effet_fichier">';var t='<input type="time" id="nouvelle_heure_effet" class="la_date_limite">';var n=$("[id="+e+"].span_un_fichier")[0].attributes["We"].value;var a=$("[id="+e+"].span_un_fichier")[0].attributes["Ge"].value?$("[id="+e+"].span_un_fichier")[0].attributes["Ge"].value:"07:30";creer_mini_popup(r,i+t,"Appliquer date limite de rendu","mettre_a_jour_date_limite_rendu('"+e+"')",n,"nouvelle_date_effet",a,"nouvelle_heure_effet");$("#nouvelle_date_effet").$("change",function(){if($("#nouvelle_date_effet")[0].value==="")$("#nouvelle_date_effet")[0].value=n});$("#nouvelle_heure_effet").$("change",function(){if($("#nouvelle_heure_effet")[0].value==="")$("#nouvelle_heure_effet")[0].value=a})}function changer_date_effet(e,r){var i='<input type="date" id="nouvelle_date_effet" class="date_effet_fichier">';var t='<input type="time" id="nouvelle_heure_effet" class="la_date_limite">';var n=$("[id="+e+"].span_un_fichier")[0].attributes["C"].value;var a=$("[id="+e+"].span_un_fichier")[0].attributes["A"].value?$("[id="+e+"].span_un_fichier")[0].attributes["A"].value:"07:30";creer_mini_popup(r,i+t,"Appliquer date d'effet","mettre_a_jour_date_effet('"+e+"')",n,"nouvelle_date_effet",a,"nouvelle_heure_effet");$("#nouvelle_date_effet").$("change",function(){if($("#nouvelle_date_effet")[0].value==="")$("#nouvelle_date_effet")[0].value=n});$("#nouvelle_heure_effet").$("change",function(){if($("#nouvelle_heure_effet")[0].value==="")$("#nouvelle_heure_effet")[0].value=a})}function mettre_a_jour_date_limite_rendu(e){var r=$("#nouvelle_date_effet")[0].value;var i=$("#nouvelle_heure_effet")[0]?$("#nouvelle_heure_effet")[0].value:"";if(impossible_de_cliquer())return-1;if(r==="")return-1;chargement(true);nom_table="Fichiers";nom_champ_reference="id_fichier";valeur_champ_reference=e;nouveau_data={Fe:r,Ke:i};actualiser(nom_table,nom_champ_reference,valeur_champ_reference,nouveau_data);setTimeout(function(){location.reload()},1e3)}function mettre_a_jour_date_effet(e){var r=$("#nouvelle_date_effet")[0].value;var i=$("#nouvelle_heure_effet")[0]?$("#nouvelle_heure_effet")[0].value:"";if(impossible_de_cliquer())return-1;if(r==="")return-1;chargement(true);nom_table="Fichiers";nom_champ_reference="id_fichier";valeur_champ_reference=e;nouveau_data={ze:r,Ye:i};actualiser(nom_table,nom_champ_reference,valeur_champ_reference,nouveau_data);setTimeout(function(){location.reload()},1e3)}function renommer_fichier(i,e){e=decodeURIComponent(e);extension_fichier=e.split(".").pop();e=e.split(".").slice(0,-1).join(".");var t=prompt("Indiquez le nouveau nom: ",e);if(t===null||t.length===0)return-1;chargement(true);t=t.trim();t=t+"."+extension_fichier;if(t.length>0){var r=recuperer("identifiant_courant");var n="https://script.google.com/macros/s/AKfycbzUiqqvttFoMV0SJEjizhDj_vQQdkAYN0ZwS4Yiy3TMgK1ucb8e/exec";var a=n+"?method=POST&id_fichier="+i;var a=a+"&nouveau_nom="+t;var a=a+"&API_KEY_RENAME="+recuperer("API_KEY_RENAME");$.m({url:a,type:"POST",p:function(e){console.log(e);var r=element_DOM("snackbar");r.innerText=e;r.className="show";nom_table="Fichiers";nom_champ_reference="id_fichier";valeur_champ_reference=i;nouveau_data={P:t};actualiser(nom_table,nom_champ_reference,valeur_champ_reference,nouveau_data);nom_table="Quiz";nom_champ_reference="id_quiz";valeur_champ_reference=i;nouveau_data={Ze:t};actualiser(nom_table,nom_champ_reference,valeur_champ_reference,nouveau_data);nom_table="Notifs";nom_champ_reference="id_notif";valeur_champ_reference=i+suite_notif();nouveau_data={_e:t};actualiser(nom_table,nom_champ_reference,valeur_champ_reference,nouveau_data);setTimeout(function(){r.className="";location.reload()},3e3)},error:function(e){console.log(e)}})}}async function visualiser(e,r,i,t,n,a,s){chargement(true);e=decodeURIComponent(e);vider_fenetre(t?t:e+(i?i:""));afficher_fenetre(true);var o=a?'<a id="telechargement" class="download-btn" download="Bulletin.png" onclick="telecharger_canvas()"><img alt="télécharger" class="window-btn"  id="'+r+'" src="'+prefixe_image+'/img_download.png"></a>':n?"":'<a id="telechargement" class="download-btn" href = "https://drive.google.com/uc?export=download&id='+r+'"><img alt="télécharger" class="window-btn" id="'+r+'" src="'+prefixe_image+'/img_download.png"></a>';if(i){donnees_devoir_a_corriger=await rechercher("Rendus","id_fichier",r);remarque=donnees_devoir_a_corriger[0]["J"];coefficient_rendu=donnees_devoir_a_corriger[0]["Y"];note_rendu=donnees_devoir_a_corriger[0]["F"];remarque=decodeURIComponent(remarque);remarque=JSON.stringify(remarque).replace(/&/,"&amp;").replace(/"/g,"");remarque=remarque.replace(/'/g,"\\'");var _='<span id="'+r+'"><img id="corriger" src="'+prefixe_image+'/img_remarque.png" class="window-btn" style="right: 30px;" onclick="mettre_remarque_devoir(this,\''+remarque+"',"+coefficient_rendu+","+note_rendu+')"></span>'}else{var _=""}var u=document.createElement("div");u.innerHTML=_+o;while(u.firstChild)element_DOM("entete-fenetre").appendChild(u.firstChild);e=e.toLowerCase();var c=e.split(".").pop();if(c==="quiz"){chargement(false);var l=i?element_DOM("devoir_choisi").value:r;stocker("fichier_ouvert",l);i=i?i.toLowerCase().replace("(","").replace(")","").trim():recuperer("identifiant_courant");stocker("proprietaire_devoir",i);return accueil_quiz(l,recuperer("mon_type")!=="Eleves",i)}var d='<iframe id="previsualisation" class="previz"></iframe>';if(est_image(c))d='<div id="previsualisation" style="width: 100%;height: 85%;"></div>';if(est_youtube(c))$("#telechargement").remove();if(n&&est_youtube(c)===false&&est_image(c)===false||s)d='<div id=previsualisation class="responsive-container">';u=document.createElement("div");u.innerHTML=d;element_DOM("fenetre").appendChild(u.firstChild);lien_de_visu=calcul_lien_de_visu(c,r);if(est_image(c)&&!s){var m=OpenSeadragon({id:"previsualisation",er:"https://sekooly.github.io/SUPABASE/openseadragon/images/",rr:{type:"image",url:lien_de_visu},ir:true});chargement(true);m.tr("open",function(){chargement(false)})}else if(a){var f='<canvas id="vizcanva"> </canvas>';element_DOM("previsualisation").innerHTML=f;chargement(false)}else if(s){$("#previsualisation")[0].className="";chargement(false)}else{choisir_height_viz_si_pdf();if(n&&est_youtube(c)===false){var f='<iframe id="viz_frame" src="'+lien_de_visu+'"    frameborder="0" scrolling="no" seamless=""></iframe><div style="width: 80px; height: 80px; position: absolute; opacity: 0; right: 0px; top: 0px;"> </div>';element_DOM("previsualisation").innerHTML=f;chargement(false)}else{element_DOM("previsualisation").src=lien_de_visu}$("#previsualisation").$("load",function(){chargement(false)});$("#viz_frame").$("load",function(e){chargement(false)});setTimeout(function(){if(impossible_de_cliquer()&&element_DOM("titre_fenetre")===e){chargement(false);alert("L'aperçu du fichier "+e+" n'est peut-être pas disponible. Vous pouvez toutefois le télécharger.");chargement(false)}},1e4)}ajuster_boutons_fenetre();ajuster_boutons_fenetre(true);choisir_height_viz_si_pdf()}function est_youtube(e){return e==="youtube"}function est_image(e){return e.includes("bmp")||e.includes("gif")||e.includes("jpeg")||e.includes("jpg")||e.includes("png")||e.includes("svg")||e.includes("bmp")}function calcul_lien_de_visu(e,r){var i="https://drive.google.com/uc?id="+r;if(e.includes("xls")){i="https://docs.google.com/spreadsheets/preview?id="+r}else if(e.includes("doc")){i="https://docs.google.com/document/preview?id="+r}else if(e.includes("ppt")){i="https://docs.google.com/presentation/preview?id="+r}else if(e.includes("txt")||e.includes("wav")){i="https://docs.google.com/file/d/"+r+"/preview"}else if(e.includes("pdf")||e.includes("rtf")){i="https://docs.google.com/file/d/"+r+"/preview"}else if(e.includes("mp4")){i="https://docs.google.com/file/d/"+r+"/preview"}else if(est_image(e)){i="https://drive.google.com/uc?export=preview&id="+r}else if(est_youtube(e)){i="https://www.youtube.com/embed/"+r}return i}function quitter_previsualisation_bis(){$("#fenetre_bis").remove();if(element_DOM("fenetre_bis"))element_DOM("fenetre_bis").style.overflowY=""}function quitter_previsualisation(){if(element_DOM("previsualisation"))element_DOM("previsualisation").src="";if(element_DOM("viz_frame"))element_DOM("viz_frame").src="";if($("#visio")[0])$("#visio")[0].remove();if($(".ecolage"))$(".toggle").remove();stocker("fichier_ouvert","");element_DOM("fenetre").style.overflowY="";if(element_DOM("previsualisation"))element_DOM("previsualisation").setAttribute("style","");afficher_fenetre(false);ma_tentative={};effacer("tmp_quiz");effacer("proprietaire_devoir")}function initialisation_bouton(e){element_DOM("pleinecran"+(e?"_bis":"")).src=prefixe_image+"/img_pleinecran.png";if(element_DOM("fenetre"+(e?"_bis":"")).style.width==="99%")element_DOM("pleinecran"+(e?"_bis":"")).src=prefixe_image+"/img_petitecran.png"}function switch_mode(e){if(!element_DOM("pleinecran"))return-1;var r=element_DOM("pleinecran").src.includes(prefixe_image+"/img_pleinecran.png");if(r||e){element_DOM("pleinecran").src=prefixe_image+"/img_petitecran.png";element_DOM("fenetre").style.top=0;element_DOM("fenetre").style.left=0;element_DOM("fenetre").style.width="99%";element_DOM("fenetre").style.height="99%"}else{element_DOM("pleinecran").src=prefixe_image+"/img_pleinecran.png";element_DOM("fenetre").style.top="";element_DOM("fenetre").style.left="";element_DOM("fenetre").style.width="";element_DOM("fenetre").style.height=""}ajuster_boutons_fenetre();choisir_height_viz_si_pdf()}function switch_mode_bis(e){if(!element_DOM("pleinecran_bis"))return-1;var r=element_DOM("pleinecran_bis").src.includes(prefixe_image+"/img_pleinecran.png");if(r||e){element_DOM("pleinecran_bis").src=prefixe_image+"/img_petitecran.png";element_DOM("fenetre_bis").style.top=0;element_DOM("fenetre_bis").style.left=0;element_DOM("fenetre_bis").style.width="99%";element_DOM("fenetre_bis").style.height="99%"}else{element_DOM("pleinecran_bis").src=prefixe_image+"/img_pleinecran.png";element_DOM("fenetre_bis").style.top="";element_DOM("fenetre_bis").style.left="";element_DOM("fenetre_bis").style.width="";element_DOM("fenetre_bis").style.height=""}ajuster_boutons_fenetre(true);initialisation_bouton(true);choisir_height_viz_si_pdf()}function ajuster_boutons_fenetre(e){nom_bouton_plein_ecran="conteneur_plein_ecran";if(e)nom_bouton_plein_ecran=nom_bouton_plein_ecran+"_bis";nom_fenetre="fenetre";if(e)nom_fenetre=nom_fenetre+"_bis";nom_bouton_quittter="bye_prev";if(e)nom_bouton_quittter=nom_bouton_quittter+"_bis";nom_bouton_telecharger="telechargement";if(e)nom_bouton_telecharger=nom_bouton_telecharger+"_bis";le_bouton_plein_ecran=element_DOM(nom_bouton_plein_ecran);la_fenetre=element_DOM(nom_fenetre);le_bouton_quittter=element_DOM(nom_bouton_quittter);le_bouton_telecharger=element_DOM(nom_bouton_telecharger);le_bouton_corriger=element_DOM("corriger");if(la_fenetre){if(le_bouton_plein_ecran){var r=la_fenetre.offsetTop+la_fenetre.offsetHeight-40+"px";var i=la_fenetre.offsetLeft+la_fenetre.offsetWidth-50+"px"}if(le_bouton_quittter){var r=la_fenetre.offsetTop+"px";var i=la_fenetre.offsetLeft+la_fenetre.offsetWidth-le_bouton_quittter.offsetWidth+"px"}if(le_bouton_telecharger){var r=la_fenetre.offsetTop+"px";var i=la_fenetre.offsetLeft+la_fenetre.offsetWidth-60+"px"}if(le_bouton_corriger){var r=la_fenetre.offsetTop+"px";var i=la_fenetre.offsetLeft+la_fenetre.offsetWidth-90+"px"}}}window.addEventListener("resize",function(){calcul_grid_gap_barre_verticale();if(element_DOM("conteneur_plein_ecran")||element_DOM("mini_popup")){ajuster_boutons_fenetre();ajuster_boutons_fenetre(true);choisir_height_viz_si_pdf()}});function afficher_discussions(e){if(e){element_DOM("afficher").style.display=""}else{element_DOM("afficher").style.display="none"}}function afficher_ajout(e){if(!e){element_DOM("img_ajout").style.display="none"}else{element_DOM("img_ajout").style.display=""}}function afficher_les_dossiers_dynamiques(e){afficher_le_drive(false);if(e){element_DOM("liste_matieres").style.display="grid"}else{element_DOM("liste_matieres").style.display="none"}}function avec_bouton_back(e){if(e){element_DOM("bouton_precedent").innerHTML='<img alt="<<" src="'+prefixe_image+'/img_retour.png" width = 25 height = 25>';element_DOM("bouton_precedent").addEventListener("click",function(e){decharger_dossier_final()})}else{element_DOM("bouton_precedent").innerHTML=""}if(recuperer("mon_type")==="Administration_bis"||recuperer("mon_type")==="Administration_final"){element_DOM("bouton_precedent").onclick=function(){element_DOM("liste_matieres").innerHTML="";stocker("mon_type","Administration");ajouter_les_dossiers_dynamiques();configurer_profil()}}}function decharger_dossier_final(){positionner_bulle_notif();positionner_pannel_notif();chargement(true);$("#barre_verticale")[0].style.display="";if(recuperer("mon_type").includes("Admin")){element_DOM("liste_matieres").innerHTML=""}ajouter_les_dossiers_dynamiques();afficher_les_dossiers_dynamiques(true);quitter_previsualisation();afficher_fenetre_rendudevoir(false);afficher_ou_non_choix_fichier(false,true);avec_bouton_back(false);afficher_ajout(false);afficher_devoirs(false);afficher_discussions(false);afficher_tri_fichiers(false);afficher_visio(false);enlever_alerte_vide(false);var e=JSON.parse(recuperer("mes_donnees"))["Pe"];afficher_logs(e==="oui");afficher_liste_eleves(recuperer("mon_type").includes("Administration"));afficher_bulletins(recuperer("mon_type").includes("Eleves"));afficher_discussions(false);afficher_params_si_droits_et_admin();stocker_temp("dossier_chargé","");stocker("les_fichiers","");afficher_discussions(false);stocker("les_topics","");stocker("topic_chargé","");stocker("nb_com_actuel","");stocker("les_coms","");configurer_profil();window.scrollTo(0,0);chargement(false);positionner_bulle_notif();positionner_pannel_notif()}function afficher_le_drive(e){if(e){element_DOM("gros_conteneur").style.display=""}else{element_DOM("gros_conteneur").style.display=""}}function renvoyer_lien_embedded(e,r){if(e==="")return"";if(r){var i="grid"}else{var i="list"}resultat="https://drive.google.com/embeddedfolderview?id="+e+"#"+i;return resultat}function configurer_profil(){$("#accueil_utilisateur").$("click",function(){afficher_modif_profil()});mes_donnees=JSON.parse(recuperer("mes_donnees"));var e="";if(recuperer("mon_type")==="Eleves"){e=mes_donnees["o"]}else if(recuperer("mon_type").includes("Administration")){e=mes_donnees["ve"]}else if(recuperer("mon_type")==="Profs"){e="Professeur"}element_DOM("accueil_utilisateur").innerHTML=mes_donnees["fe"]+" "+mes_donnees["pe"]+"  -  "+e;mettre_infos_matiere(false)}initialisation();function mettre_infos_matiere(e){if(e&&$(".matiere_description").length===0){$("#accueil_utilisateur").append('<div onclick="infos_matiere()" class="matiere_description sekooly-mode">Plus d\'informations</div>')}else{$(".matiere_description").remove()}}function switch_mode_livres(e,r){if(r){console.log("par défaut");var i=mode_livres()}else{var i=!e}element_DOM("choix_date_effet").style.visibility=i?"":"hidden";element_DOM("telechargeable").style.visibility=i?"":"hidden";element_DOM("est_telechargeable").checked=i}function mode_livres(){return element_DOM("choix_date_effet").style.visibility==="hidden"}function mode_fichier_initialement(){afficher_choix_youtube(false);afficher_choix_extrait_manuel(false)}function switch_affichage_youtube(){var e=element_DOM("est_video_youtube").checked;element_DOM("nom_youtube").value="";element_DOM("lien_youtube").value="";afficher_choix_youtube(e);afficher_choix_fichier(!e);afficher_checkbox("choix_extrait_manuel",!e);afficher_checkbox_fichier_telechargeable(!e);$("#est_telechargeable")[0].checked=!e;if(e){$("#mettre_fichier_en_ligne").$("click",function(e){if(!pre_validation("lien_youtube")){}else if(!$("#nom_youtube")[0].value){afficher_alerte("Vous devez fournir un titre représentatif de la vidéo youtube.");$("#nom_youtube")[0].focus()}else if(!est_un_lien_drive()&&!est_un_lien_yt()){afficher_alerte("Vous devez fournir un lien youtube valable.");$("#lien_youtube")[0].focus()}else{chargement(true);var r=id_youtube_video($("#lien_youtube")[0].value);var i=$("#nom_youtube")[0].value+(est_un_lien_drive()?"":".youtube");var t=element_DOM("categorie_choisie").value;var n=element_DOM("la_date_limite").value;var a=element_DOM("lheure_limite").value;var t=$("#categorie_choisie")[0].value;var s=$("#date_effet_fichier")[0].value;var o=$("#heure_effet")[0].value;date_heure_actuelle=maintenant();mes_donnees=JSON.parse(recuperer("mes_donnees"));la_classe=recuperer("mon_type")==="Eleves"?mes_donnees["o"]:la_matiere_chargee("Classe");la_matiere=recuperer("mon_type")==="Eleves"?$("#accueil_utilisateur")[0].innerText:la_matiere_chargee("Matiere");le_coef=Number($("#coef")[0].value);console.log("le_coef: "+le_coef);nouveau_fichier={L:date_heure_actuelle,V:r,P:i,ke:recuperer("dossier_chargé"),K:recuperer("identifiant_courant"),De:t,Fe:n,Ke:a,ze:s,Ye:o,we:"non",Y:le_coef,te:0,Se:$("select#id_chapitre")[0].value};ajouter_un_element("Fichiers",nouveau_fichier,r);id_notif=r+suite_notif();nouvelle_notif={ne:id_notif,ae:date_heure_actuelle,se:"fichier",oe:r,_e:i,ue:recuperer("identifiant_courant"),ce:mon_role,H:recuperer("identifiant_courant"),X:mon_role,o:la_classe,le:"("+la_classe+"|"+la_matiere+")",de:recuperer("dossier_chargé"),B:date_heure_actuelle,me:mes_donnees["me"]};ajouter_un_element("Notifs",nouvelle_notif,id_notif);var _=est_un_lien_drive()?"Le fichier drive a bien été rattaché à la plateforme.":"La vidéo youtube a bien été partagée.";afficher_alerte(_,true)}})}else{$("#mettre_fichier_en_ligne").Ve("click")}}function id_youtube_video(e){var r=/^.*(youtu\.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;var i=e.match(r);if(i&&i[2].length==11){return i[2]}else{return id_lien_drive(e)}}function id_lien_drive(e){var r=/[-\w]{25,}/;return e.match(r)===null?"ERREUR LIEN":e.match(r)[0]}function est_un_lien_yt(){var e=/^(?:https?:\/\/)?(?:m\.|www\.)?(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))((\w|-){11})(?:\S+)?$/;var r=$("#lien_youtube")[0].value;if(r!==""){return r.match(e)!==null}else{return false}}function est_un_lien_drive(){var e=$("#lien_youtube")[0].value;var r=/[-\w]{25,}/;if(e!==""){return e.match(r)!==null}else{return false}}function afficher_choix_youtube(e){element_DOM("youtube").style.display=e?"":"none"}function afficher_checkbox_fichier_telechargeable(e){element_DOM("telechargeable").style.display=e?"":"none"}function afficher_choix_fichier(e){element_DOM("file").style.display=e?"":"none"}function ne_rien_rendre(){$("#mettre_fichier_en_ligne")[0].disabled=true;$("#mettre_fichier_en_ligne").$("click","")}function activer_envoi_fichier(){$("#mettre_fichier_en_ligne")[0].disabled=false}function afficher_heure_effet_si_examens(){if($("#categorie_choisie")[0].value==="Examens"){$("#titre_date")[0].innerText="Date et heure de l'épreuve:";$("#heure_effet")[0].style.display="";$("#heure_effet")[0].value="07:30"}else{$("#titre_date")[0].innerText="Date d'effet:";$("#heure_effet")[0].style.display="none";$("#heure_effet")[0].value=""}}function pre_validation(e){if($("#categorie_choisie")[0].value==="--"){afficher_alerte("Merci de choisir la catégorie de votre fichier.");return false}else{}if(($("#"+e)[0].value===""||$("#"+e)[0].value==="--")&&!image_temporaire){afficher_alerte("Merci de choisir le fichier, l'extrait de manuel, ou le lien youtube que vous désirez partager.");return false}if($("#date_effet_fichier")[0].value===""||$("#date_effet_fichier")[0].value===null){afficher_alerte("Merci de choisir la date d'effet de votre fichier.");return false}else{}if($("#categorie_choisie")[0].value==="Examens"){if($("#heure_effet")[0].value===""||$("#heure_effet")[0].value===null){afficher_alerte("Merci de choisir l'heure d'effet de votre fichier d'Examen.");return false}else{}}if($("#categorie_choisie")[0].value==="Devoirs"&&element_DOM("la_date_limite").value===""){afficher_alerte("Merci de choisir la date limite du devoir.");return false}else{}if($("#categorie_choisie")[0].value==="Devoirs"&&element_DOM("lheure_limite").value.length<5){afficher_alerte("Merci de choisir l'heure du devoir.");return false}else{}if(impossible_de_cliquer()){afficher_alerte("Merci de patienter.");return false}return true}function base64toBlob(e,r){r=r||"";var i=1024;var t=atob(e.split(",")[1]);var n=t.length;var a=Math.ceil(n/i);var s=new Array(a);for(var o=0;o<a;++o){var _=o*i;var u=Math.min(_+i,n);var c=new Array(u-_);for(var l=_,d=0;l<u;++d,++l){c[d]=t[l].charCodeAt(0)}s[o]=new Uint8Array(c)}return new Blob(s,{type:r,name:nom_image_temporaire})}$(function charger_fichiers(e){var r="https://script.google.com/macros/s/AKfycbwKm1M_Hm2n8bAyqq3jAcDyL65EqKn1-3VMXIw4jMpzqnIeQQI/exec";var d={};var m;var f;$("#file").$("change",function(){var e=this.files;var r=e.length;var n=image_temporaire?base64toBlob(image_temporaire,"image/png"):e[0];m=nom_image_temporaire?nom_image_temporaire:n.name;f=m.split(".").pop().toUpperCase();le_coef=Number($("#coef")[0].value);$("#mettre_fichier_en_ligne").$("click",function(e){e.preventDefault();var r=$("#categorie_choisie")[0].value;var i=pre_validation("file");if(i===false){return-1}if(n.size>25e6){afficher_alerte("Votre fichier excède 25 MO: impossible de le mettre en ligne.");return-1}var t=new FileReader;t.onprogress=function(e){chargement(true)};t.onload=function(e){d.file=e.target.result.replace(/^.*,/,"");r=element_DOM("categorie_choisie").value;la_date_limite=element_DOM("la_date_limite").value;lheure_limite=element_DOM("lheure_limite").value;date_effet_fichier=$("#date_effet_fichier")[0].value;heure_effet=$("#heure_effet")[0].value;if(r==="Bulletins"){if(f.toLowerCase()!=="pdf"){afficher_alerte("Le fichier de bulletins doit être un fichier pdf.");chargement(false);return-1}liste_destinataires=$("#attribution").W().split("&");destinataire_par_page={};liste_destinataires.forEach(function(e,r){numero_page=e.split("=")[0];id_eleve=decodeURIComponent(e.split("=")[1]);if(destinataire_par_page[id_eleve]){destinataire_par_page[id_eleve]=destinataire_par_page[id_eleve]+","+numero_page}else{destinataire_par_page[id_eleve]=numero_page}});destinataire_par_page=JSON.stringify(destinataire_par_page);periode_bulletin=$("[name='periode_bulletin']")[0].value;a(r,la_date_limite,lheure_limite,date_effet_fichier,heure_effet,le_coef,n.size,destinataire_par_page,periode_bulletin)}else{a(r,la_date_limite,lheure_limite,date_effet_fichier,heure_effet,le_coef,n.size)}};t.readAsDataURL(n)});categorie_fichier=element_DOM("categorie_choisie").value;la_date_limite=element_DOM("la_date_limite").value;lheure_limite=element_DOM("lheure_limite").value;date_effet_fichier=$("#date_effet_fichier")[0].value;heure_effet=$("#heure_effet")[0].value;$("#attribution").remove();$("#trimestre").remove();if(categorie_fichier==="Bulletins"){if(f.toLowerCase()!=="pdf"){afficher_alerte("Le fichier de bulletins doit être un fichier pdf.");chargement(false);return-1}else{nombre_de_pages_pdf=-1;var i=new FileReader;i.onload=function(e){nombre_de_pages_pdf=0;pdf=new Uint8Array(e.target.result);try{PDFJS.nr({data:pdf}).then(function(e){nombre_de_pages_pdf=e.sr.ar;t(nombre_de_pages_pdf,$("#mettre_fichier_en_ligne"))})}catch(e){console.error(e);alert("Impossible de détecter le nombre de pages du pdf : merci de réessayer avec un autre fichier.");return 0}};i.readAsArrayBuffer(n)}}});$("#categorie_choisie").$("change",function(){afficher_eventuelle_alerte_effet();afficher_eventuelle_alerte_limite();if($("#categorie_choisie")[0].value==="Devoirs"){n(true)}else{n(false)}if($("#categorie_choisie")[0].value==="Devoirs"||$("#categorie_choisie")[0].value==="Examens"){afficher_choix_coef(true)}else{afficher_choix_coef(false)}changement_quiz_ou_non();if($("#categorie_choisie")[0].value==="Manuels"){switch_mode_livres(true)}else{switch_mode_livres(false)}afficher_heure_effet_si_examens()});$("#date_effet_fichier").$("change",function(){if($("#date_effet_fichier")[0].value==="")$("#date_effet_fichier")[0].value=moment().format("yyyy-MM-DD");afficher_eventuelle_alerte_effet()});$("#la_date_limite").$("change",function(){afficher_eventuelle_alerte_limite()});$("#heure_effet").$("change",function(){if($("#heure_effet")[0].value===""&&$("#categorie_choisie")[0].value==="Examens"){$("#heure_effet")[0].value="07:30"}});function t(e,r){toutes_les_classes=JSON.parse(recuperer("mes_matieres"));classe_chargee=toutes_les_classes.filter(e=>e["Je"]===recuperer("dossier_chargé"))[0]["o"];url=racine_data+"Eleves?Classe=eq."+classe_chargee+"&"+apikey;liste_eleves=get_resultat(url);liste_eleves=liste_eleves.sort(function(e,r){if(e.u<r.u){return-1}if(e.u>r.u){return 1}return 0});select_liste_eleves='<select style="width: 80%;" name="numero_page" id="numero_page">';select_liste_eleves=select_liste_eleves+i("--","--");liste_eleves.forEach(function(e,r){select_liste_eleves=select_liste_eleves+i(e["u"],e["fe"]+" "+e["pe"])});select_liste_eleves=select_liste_eleves+"</select>";attribution='<form id="trimestre" style=""><b><label for="periode_bulletin">Trimestre:<select style="width: 60%;" name="periode_bulletin"><option value="PREMIER TRIMESTRE">PREMIER TRIMESTRE</option><option value="DEUXIEME TRIMESTRE">DEUXIEME TRIMESTRE</option><option value="TROISIEME TRIMESTRE">TROISIEME TRIMESTRE</option><option value="ANNUEL">ANNUEL</option></select></label></b></form>';attribution=attribution+'<form id="attribution" style="margin-top: 20px;">';for(numero_page=1;numero_page<=e;numero_page++){attribution=attribution+'<div><label for="'+numero_page+'">Page n°'+numero_page+":"+select_liste_eleves.replace(/"numero_page"/g,numero_page)+"</label></div>"}attribution=attribution+"</form>";$(attribution).insertBefore(r);for(numero_page=1;numero_page<=e;numero_page++){$("#"+numero_page)[0].value=liste_eleves[numero_page-1]["u"]}}function i(e,r){return'<option value="'+e+'">'+r+"</option>"}function n(e){if(e){element_DOM("choix_date").style.display="grid"}else{element_DOM("choix_date").style.display="none"}}function a(t,n,a,s,o,_,u,c,l){var e='<form method="post"  action="'+r+'" id="envoyer_le_fichier" style="display: none;" >';e+='<input type="hidden" name="API_KEY_UPLOAD" value="'+recuperer("API_KEY_UPLOAD")+'" >';e+='<input type="hidden" name="nom_fichier" value="'+m+'" >';e+='<input type="hidden" name="extension" value="'+f+'" >';e+='<input type="hidden" name="file" value="'+d.file+'" >';e+='<input type="hidden" name="folderID" value="'+recuperer("dossier_chargé")+'" >';e+='<input type="hidden" name="proprietaire" value="'+recuperer("identifiant_courant")+'" >';e+='<input type="hidden" name="categorie_fichier" value="'+t+'" >';e+='<input type="hidden" name="la_date_limite" value="'+n+'" >';e+='<input type="hidden" name="lheure_limite" value="'+a+'" >';e+='<input type="hidden" name="date_effet_fichier" value="'+s+'" >';e+='<input type="hidden" name="heure_effet" value="'+o+'" >';e+='<input type="hidden" name="coefficient_rendu" value="'+_+'" >';e+='<input type="hidden" name="taille_fichier" value="'+u+'" >';e+='<input type="hidden" name="destinataire_par_page" value="'+c?c:""+'" >';e+='<input type="hidden" name="periode_bulletin" value="'+l?l:""+'" >';e+="</form>";$("body").append(e);$("#envoyer_le_fichier").submit(function(e){e.preventDefault();if(!extension_ok(f)){alert("L'extension du fichier n'est pas supporté par la plateforme, merci de réessayer avec l'un de ces formats: bmp, gif, jpeg, jpg, png, svg, pdf, bmp, xlsx, xls, xlsm, ppt, pptx, doc, docx, txt, html, csv, js, rtf, mp4, mp3, wav");chargement(false);activer_envoi_fichier();return-1}ne_rien_rendre();var r=$(this);var i=r.Z("action");$.m({type:"POST",url:i,data:r.W(),p:function(e){var r=element_DOM("snackbar");r.innerText="Votre fichier a bien été mis en ligne.";r.className="show";date_heure_actuelle=maintenant();mes_donnees=JSON.parse(recuperer("mes_donnees"));la_classe=recuperer("mon_type")==="Eleves"?mes_donnees["o"]:la_matiere_chargee("Classe");la_matiere=recuperer("mon_type")==="Eleves"?$("#accueil_utilisateur")[0].innerText:la_matiere_chargee("Matiere");est_telechargeable=$("#est_telechargeable")[0].checked?"oui":"non";nouveau_fichier={L:date_heure_actuelle,V:e,P:m,ke:recuperer("dossier_chargé"),K:recuperer("identifiant_courant"),De:t,Fe:n,Ke:a,ze:s,Ye:o,we:est_telechargeable,Y:_,te:u,He:c,Be:l};ajouter_un_element("Fichiers",nouveau_fichier,e);id_notif=e+suite_notif();nouvelle_notif={ne:id_notif,ae:date_heure_actuelle,se:"fichier",oe:e,_e:m,ue:recuperer("identifiant_courant"),ce:mon_role,H:recuperer("identifiant_courant"),X:mon_role,o:la_classe,le:"("+la_classe+"|"+la_matiere+")",de:recuperer("dossier_chargé"),B:date_heure_actuelle,me:mes_donnees["me"]};ajouter_un_element("Notifs",nouvelle_notif,id_notif);setTimeout(function(){r.className="";location.reload()},3e3);chargement(false)},error:function(e){var r=element_DOM("snackbar");r.innerText="Erreur interne du serveur, veuillez réessayer. Assurez-vous d'être toujours connecté à internet.";r.className="show";chargement(false)}})});$("#envoyer_le_fichier").submit();$("#envoyer_le_fichier").remove()}});function fichier_devoir_ou_examen(){var e=$("#categorie_choisie")[0].value;return e==="Devoirs"||e==="Examens"}function afficher_eventuelle_alerte_effet(){if(fichier_devoir_ou_examen()){afficher_les_devoirs_de_la_date("date_effet",$("#date_effet_fichier")[0].value,"mere_effet","nb_devoirs_effet")}else{$("#mere_effet")[0].style.display=""}}function afficher_eventuelle_alerte_limite(){if(fichier_devoir_ou_examen()){afficher_les_devoirs_de_la_date("la_date_limite",$("#la_date_limite")[0].value,"mere_limite","nb_devoirs_limite")}else{$("#mere_limite")[0].style.display=""}}async function afficher_les_devoirs_de_la_date(e,r,i,t){var n=JSON.parse(recuperer("mes_matieres")).find(e=>e["Je"]===recuperer("dossier_chargé"))["l"];var a=await rechercher("Matieres","classe_id",n,"ID_URL");les_id_dossier_classe='("'+a.map(e=>e["Je"]).join('","')+'")';url=racine_data+"Fichiers?"+apikey;url+='&categorie_fichier=in.("Devoirs","Examens")';url+="&"+e+"=eq."+r;url+="&id_dossier=in."+les_id_dossier_classe;var s=get_resultat(url).length;if(s>0){$("[id='"+t+"']")[0].innerText=s;$("#"+i)[0].style.display="block"}else{$("#"+i)[0].style.display=""}}document.onclick=function(e){if(e.target.id===""&&e.target.onclick===null&&e.target._r===""){quitter_previsualisation()}if(typeof e.target.className==="string"){if(e.target.id!=="bulle_notif"&&e.target.id!=="recup_notifs"&&!e.target.className.includes("notif")&&e.target.id!=="rien_lire"&&e.target.id!=="tout_lire"){virer_le_pannel_notifs()}}if(!e.target.id.toLowerCase().includes("devoir")&&!e.target)afficher_fenetre_rendudevoir(false);if(e.target.nodeName==="BODY"||e.target.id==="gros_conteneur"||e.target.id==="liste_matieres"||e.target.id.includes("drive_")){masquer_config_mode();fermer_side_bar()}};$(document).ur(function(e){if(e.key==="Escape"){quitter_previsualisation();afficher_fenetre_rendudevoir(false);virer_le_pannel_notifs();afficher_ou_non_choix_fichier(false);masquer_config_mode()}if(e.key==="¤"){mode_edition_sql()}});async function mode_edition_sql(){if(recuperer("identifiant_courant").includes("admin")){confirmation=prompt("Merci de saisir votre code d'accès.");if(confirmation){c=await recuperer_mes_donnees();if(!code_ok(c,confirmation)){afficher_alerte("Code d'accès erroné, mode administrateur non activé.")}else{zknrsbnfwz()}}}}function zknrsbnfwz(){vider_fenetre("Mode ADMIN - SQL");afficher_fenetre(true);$("#fenetre").append(contenu_admin());$("#query").focus()}function changer_alerte_exe(e,r,i,t){if(!element_DOM("remarque-exe"))return false;var n=document.createElement("div");n.id=e;n.innerHTML="<b>"+new Date+"</b> \t"+r;n.style.color=i;n.style.paddingBottom="10px";if(!t)$("#remarque-exe")[0].innerHTML="";element_DOM("remarque-exe").appendChild(n)}function contenu_admin(){return`
				<div id="mode-admin" class="mode-admin"><div id="attention-admin" class="attention-admin">
					<b>
						<rouge>ATTENTION, SI VOUS ÊTES ICI SANS LE VOULOIR, QUITTEZ DIRECTEMENT CETTE FENÊTRE.</rouge>
					</b>
					<div>VOUS ÊTES EN MODE ADMINISTRATEUR.</div>
					</div>
					  
					<div>
					  	<label for="query">Votre requête SQL:</label>
					  	<textarea name="query" id="query" class="query"></textarea>
				  	</div>
				</div>

				<div class="au-centre">
					<div>
					  <input type="checkbox" id="mode-select" name="mode-select" checked="">
					  <label for="mode-select">En mode SELECT</label> 
					</div>
					<button class="btn-exe" onclick="exe_sql()" id="exe">Exécuter le code SQL</button>

					<button style="display:none;" class="btn-exe" id="deploy">Continuer</button>
					<div id="remarque-exe"></div>
				</div>

			`}async function exe_sql(){var e=await recherche_initiale("Etablissements");var r=e.find(e=>e["i"]==="testo");await exe_sql_unitaire(r);$("#deploy").show();chargement(false);$("#deploy").Ve("click");$("#deploy").Qe("click",function(){$("#deploy").hide();$("#deploy").Ve("click");e=e.filter(e=>e["i"]!=="testo");e.forEach(async function(e){await exe_sql_unitaire(e,true)});chargement(false)})}async function exe_sql_unitaire(e,r){chargement(true);var i=element_DOM("query").value;var t=e["cr"];var n='<span class="affichage_etablissement">'+e["i"]+"</span>"+": ";try{var a=await execute_sql(e["lr"],i,element_DOM("mode-select").checked);n+=JSON.stringify(a);var s="green"}catch(o){n+=JSON.stringify(o);var s="red"}changer_alerte_exe(t,n,s,r)}function charger_les_topics(e){if(impossible_de_cliquer()&&!e)return-1;est_deja_ouvert=element_DOM("fenetre").style.visibility==="visible";if(e)est_deja_ouvert=false;afficher_fenetre(!est_deja_ouvert);return recuperer_les_topics(false)}function html_boutons_fenetre(e,r,i){return'<div id="entete-fenetre" style="text-align: center;"> <img alt="actualiser"  src="'+prefixe_image+'/img_actualiser.png" onclick="'+e+'" id="actu_topics" style="width: 30px; cursor: pointer;"> <img alt="ajouter" src="'+prefixe_image+'/img_ajout.png" onclick="'+r+'" id="nouvelle_discu" style="width: 30px; cursor: pointer;"></div><div id="entete-fenetre" style="text-align: center;color: #c1c1c1;font-size: 13px;border-bottom-width: 1px;border-bottom-style: ridge;">'+i+"</div>"}function ajouter_une_discu(){var e=false;if(e){alert("Impossible de créer une question/discussion pour le moment.");return-1}if(impossible_de_cliquer())return-1;if(!recuperer("mon_type").includes("Admin")&&element_DOM("accueil_utilisateur").innerText.includes("Vie scolaire")){alert("Vous n'avez pas les droits pour publier une discussion dans la Vie Scolaire. Pour tout problème constaté sur la plateforme, envoyez directement un mail à "+data_etablissement["dr"]+".");return-1}vider_fenetre("Nouvelle discussion");element_DOM("maquestion").src="";var r='<form id="mon_formulaire" autocomplete="off" class="edition"><label id="label" for="titre_question">Titre: </label><input type="text" id="titre_question" maxlength="50" style="width: 100%;">\t<br><br><label id="label" for="contenu_question">Votre message: </label><textarea id="contenu_question" maxlength="1700" style="width: 100%;height: 70%;resize: none;font-size: 13px;"></textarea><div id="nb_max_div" style="margin-left: 90%;margin-top: 0%;font-size: 10px; display:none;"> <font id="nb_max"> 0 / 1700</font> </div><div id="mes_boutons" style="text-align: center;padding: 1%;display: block ruby;"><button  class="bouton_sekooly" type="button" id="Annuler" onclick="recuperer_les_topics(false)"> Annuler </button><button  class="bouton_sekooly" type="button" id="envoi" onclick="envoyer_le_topic()"> Poster </button></div><div id="msg_erreur" style="text-align: center;padding: 1%;color: green;"> </div></form>';var i=document.createElement("span");i.innerHTML=r;element_DOM("fenetre").appendChild(i);rendre_riche("contenu_question",true);element_DOM("titre_question").focus()}function changer_nb_caracteres(){element_DOM("nb_max").innerText=element_DOM("contenu_question").textLength+" / 1700"}function actualiser_topics(){recuperer_les_topics(true)}function actualiser_coms(e){charger_question(e,true)}function envoyer_le_com(e,r,i,t,n){var a=t;var s=chercher_le_mot_interdit(a);if(s!==""){alert("Vous n'avez pas le droit d'utiliser le terme '"+s+"' dans le cadre des cours à "+nom_etablissement+" sur SEKOOLY.");return-1}element_DOM("envoicommentaire").disabled=true;chargement(true);nom_table="Topic";nb_com=nb_coms(e)+1;stocker("nb_com_actuel",nb_com);date_heure_actuelle=maintenant();nouveau_com={ae:date_heure_actuelle,mr:e,pr:recuperer_html_saisie_riche(),u:recuperer("identifiant_courant"),ve:i};ajouter_un_element("Coms",nouveau_com);actualiser("Topic","Id_topic",e,{vr:nb_com});nom_table="Notifs";nom_champ_reference="Id_source";valeur_champ_reference=e;nouvelles_donnees_notif={B:date_heure_actuelle,H:recuperer("identifiant_courant"),X:i};actualiser(nom_table,nom_champ_reference,e,nouvelles_donnees_notif);ajouter_un_commentaire(r,i,t,n,"nouveau_com");ajouter_bloc_commenter(false,"ajouter_mon_com()","Commenter");ajouter_bloc_commenter(true,"ajouter_mon_com()","Commenter");$("#retour").$("click",function(){recuperer_les_topics(true)});stocker("les_coms","");chargement(false)}function chercher_le_mot_interdit(r){if(!data_etablissement["hr"])return"";var e=data_etablissement["hr"].split(",");var i="";e.some(function(e){contient=r.toLowerCase().includes(e.toLowerCase());i=contient?e:"";return contient});return i}function envoyer_le_topic(){var e=encodeURIComponent(element_DOM("titre_question").value.trim());var r=recuperer_html_saisie_riche();var i=recuperer("identifiant_courant");var t=chercher_le_mot_interdit(r);if(t!==""){alert("Vous n'avez pas le droit d'utiliser le terme '"+t+"' dans le cadre des cours à "+nom_etablissement+" sur SEKOOLY.");return-1}var n=recuperer("dossier_chargé");if(e!==""&&r!==""&&!r.includes(saisie_vide())){element_DOM("envoi").disabled=true;nom_table="Topic";date_heure_actuelle=maintenant();id_topic=nouvel_id(nom_table,"Id_topic");nouveau_topic={mr:id_topic,ae:date_heure_actuelle,gr:$("#titre_question")[0].value,br:recuperer_html_saisie_riche(),u:recuperer("identifiant_courant"),de:recuperer("dossier_chargé"),ve:mon_role,vr:0};ajouter_un_element(nom_table,nouveau_topic,id_topic);nom_table="Notifs";mes_donnees=JSON.parse(recuperer("mes_donnees"));la_classe=recuperer("mon_type")==="Eleves"?mes_donnees["o"]:la_matiere_chargee("Classe");la_matiere=recuperer("mon_type")==="Eleves"?$("#accueil_utilisateur")[0].innerText:la_matiere_chargee("Matiere");id_notif=id_topic;nouvelle_notif={ne:id_notif,ae:date_heure_actuelle,se:"discussion",oe:id_topic,_e:$("#titre_question")[0].value,ue:recuperer("identifiant_courant"),ce:mon_role,H:recuperer("identifiant_courant"),X:mon_role,o:la_classe,le:"("+la_classe+"|"+la_matiere+")",de:recuperer("dossier_chargé"),B:date_heure_actuelle,me:mes_donnees["me"]};ajouter_un_element(nom_table,nouvelle_notif,id_notif);setTimeout(function(){actualiser_topics()},1500)}else{var a="Il faut un titre et un contenu de message.";changer_msg_erreur(a,true)}chargement(false);return false}function changer_msg_erreur(e,r){if(r)element_DOM("msg_erreur").style.color="red";if(!r){vider_fenetre();ajouter_div_msg_erreur();element_DOM("msg_erreur").style.marginTop="20%";element_DOM("msg_erreur").style.color="green";setTimeout(function(){stocker("les_topics","");window.location.href=window.location.href},3e3)}element_DOM("msg_erreur").innerText=e}function vider_fenetre(e,r,i){element_DOM("fenetre").innerHTML="";var t=r?"":'onclick="quitter_previsualisation()"';var n='<div id="entete-fenetre" style="display: inline-flex;float: right;"><img alt="X" src="'+prefixe_image+'/quitter.png" id="bye_prev" class="bye_prev" '+t+" > </div>";var a="";if(e)a='<div class="titre_fenetre" id="titre_fenetre">'+e+"</div>";var s='<div class="fullscreen-btn" id="conteneur_plein_ecran" > <img alt="plein écran" style="position: fixed;" id="pleinecran" src="'+prefixe_image+'/img_petitecran.png" onclick="switch_mode()" class="pleinecran"> </div>';var o=document.createElement("div");o.innerHTML=n+a+s;while(o.firstChild){element_DOM("fenetre").appendChild(o.firstChild)}avec_sauvegarde(i);ajuster_boutons_fenetre();initialisation_bouton()}function charger_question(e,r,i){if(e){stocker("topic_chargé",e);recuperer_les_coms(e,r,i)}return true}function recuperer_les_coms(e,r,i){chargement(true);var t=recuperer("topic_chargé");if(t===null)t="";var n=t.toString();var a=e.toString();stocker("nb_com_actuel",$("u#"+a+".nb_com_actuel")[0].innerText);ajouter_poste_initial(e);if(a!==n||r===true){stocker("les_coms","")}if(recuperer("les_coms")===null||recuperer("les_coms")===""||recuperer("les_coms")==="[]"||r){nom_table="Coms";nom_champ_reference="Id_topic";valeur_champ_reference=a;rechercher(nom_table,nom_champ_reference,valeur_champ_reference).then(e=>{les_coms=e;if(les_coms!==undefined&&les_coms!==null&&les_coms.length>0){stocker("topic_chargé",a.toString());stocker("les_coms",JSON.stringify(les_coms));traitement_coms(a,i)}})}else{traitement_coms(a,i)}chargement(false)}function ajouter_poste_initial(r){var e=JSON.parse(recuperer("les_topics"));var i=e.filter(function(e){return e["mr"].toString()===r.toString()});var t=i[0];vider_fenetre("");var n=t["gr"];var a=t["u"].toUpperCase();var s=t["ve"];var o=decodage(t["br"]);var _=afficher_date(t["ae"]);var u='\t<div id="entete_poste" style="display: flex;overflow-wrap: anywhere;"><img id="<<" src="'+prefixe_image+'/img_retour.png" style="width: 30px;margin: 2%;cursor:pointer;height: 30px;"  onclick="recuperer_les_topics(false)"> <div id="titre_du_poste" style="font-weight: bold;margin: 2%;font-size: 25px;">'+n+"</div></div>";var c=document.createElement("div");c.innerHTML=u;element_DOM("fenetre").appendChild(c);var l='<div id="bloc_poste" style="padding: 2%;display: block;overflow-wrap: anywhere;border-bottom-style: solid;"><div class="auteur_du_poste" >'+a+" ("+s+')</div><h id="contenu_poste" style=""> '+o+'</h><h style="color: #B5B3B8;" id="date_poste"> '+_+"</h></div>";var d='<div id="emplacement_commentaire"></div>';var m=document.createElement("div");m.id="liste_des_coms";m.style.overflow="hidden auto";m.style.height="85%";m.innerHTML=l+d;element_DOM("fenetre").appendChild(m);ajouter_bloc_commenter(true,"ajouter_mon_com()","Commenter")}function ajouter_bloc_commenter(e,r,i){if(e){var t='<div id="bloc_commenter"><textarea id="mon_com" style="display:inline-block; width:100%; resize: unset; min-height:200px; overflow-y:hidden;" placeholder="Votre commentaire..." maxlength="1500"></textarea><button id="envoicommentaire" onclick="'+r+'" style="height: 30px;background-color: #FF6C00;">'+i+"</button></div>";var n=document.createElement("div");n.innerHTML=t;while(n.firstChild){element_DOM("liste_des_coms").appendChild(n.firstChild)}rendre_riche("mon_com")}else{if(element_DOM("bloc_commenter")!==null)element_DOM("bloc_commenter").remove()}}function traitement_coms(e,r){chargement(true);var i=JSON.parse(recuperer("les_coms"));i=Object.keys(i).map(e=>i[e]);i=i.sort(function n(e,r){return convertir_en_date(e.ae)-convertir_en_date(r.ae)});var a=0;i.forEach(function(e){if(e!==null){var r=e["u"].toUpperCase();var i=e["ve"];var t=e["pr"];var n=afficher_date(e["ae"]);a=e["yr"];ajouter_un_commentaire(r,i,t,n,a)}});if(r){var t=$("#bloc_commenter")[0].offsetTop-$("#bloc_commenter")[0].offsetHeight;$("#liste_des_coms").scrollTop(t);changer_couleur_temporairement(a,"un_commentaire","#5e5e5e",700)}chargement(false)}function ajouter_un_commentaire(e,r,i,t,n){i=decodage(i);var a='<div id="'+n+'" class="un_commentaire"><div class="auteur_du_poste" style="font-weight: bold;color: #FF6C00;">'+e+" ("+r+')</div><h id="contenu_poste" style=""> '+i+'</h><h style="color: #B5B3B8;" id="date_poste"> '+t+"</h></div>";var s=document.createElement("div");s.innerHTML=a;if(element_DOM("emplacement_commentaire")){while(s.firstChild){element_DOM("emplacement_commentaire").appendChild(s.firstChild)}}}function ajouter_mon_com(){chargement(true);var e=recuperer_html_saisie_riche().trim();contenu_vide=e.includes(saisie_vide());if(e!==""&&!contenu_vide){var r=recuperer("identifiant_courant").toUpperCase();var i=afficher_date(maintenant());id_topic=recuperer("topic_chargé");envoyer_le_com(id_topic,r,mon_role,e,i)}else{alert("Votre commentaire ne peut pas être vide.")}chargement(false)}function recuperer_les_topics(e){chargement(true);vider_fenetre("");afficher_fenetre(true);element_DOM("fenetre").innerHTML+=html_boutons_fenetre("actualiser_topics()","ajouter_une_discu()","Pour commenter, cliquez sur une question/discussion");if(e||recuperer("les_topics")===null||recuperer("les_topics")===""){nom_table="Topic";nom_champ_reference="Id_classe_matiere";valeur_champ_reference=recuperer("dossier_chargé");nom_champ_a_chercher="";return rechercher(nom_table,nom_champ_reference,valeur_champ_reference,nom_champ_a_chercher).then(e=>{e.sort(function tri_ordre_chrono_decroissant(e,r){return convertir_en_date(r.ae)-convertir_en_date(e.ae)});stocker("les_topics",JSON.stringify(e));traitement_topics();chargement(false)})["catch"](e=>{console.error(e);alert("Impossible de récupérer les questions/discussions de cette matière. Vérifiez que vous êtes toujours connecté à internet, ou réessayer plus tard.");chargement(false)})}else{traitement_topics();chargement(false);return true}}function traitement_topics(){stocker("les_coms","");if(recuperer("les_topics").length===0||recuperer("les_topics")==="[]"){commentaire='<div id="vide" style="text-align: center;color: grey;margin: 10%;"> <i id="vide"> Il n\'y a pas encore de questions posées dans ce cours. </i> </div>';var e=document.createElement("div");e.innerHTML=commentaire;while(e.firstChild){element_DOM("fenetre").appendChild(e.firstChild)}}else{var r=JSON.parse(recuperer("les_topics"));if(!element_DOM("div_liste_topics")){var c=document.createElement("div");c.style.overflowX="hidden";c.style.overflowY="auto";c.id="div_liste_topics";c.style.height="90%";element_DOM("fenetre").appendChild(c)}else{var c=element_DOM("div_liste_topics")}r.forEach(function(e){var r=e["gr"];element_contenu=document.createElement("div");element_contenu.innerHTML=e["br"];var i=element_contenu.innerText;var t=afficher_date(e["ae"]);var n=e["u"]+" ("+e["ve"]+")";var a=e["mr"];var s=e["vr"];if(s===undefined)s=0;var o='<span id="bye'+a+'"><img alt="supprimer" class="byebye" onclick="event.stopPropagation(); clic_de_poubelle_topic(this)" src="'+prefixe_image+'/img_trash.png" style="width: 20px;position: relative;float: right;" id="bye'+a+'"></span>';if(!recuperer("mon_type").includes("Administration")&&e["u"]!==recuperer("identifiant_courant").trim())o="";var _='<ul class="bloc_topic" onclick="clic_de_topic(this)" id="'+a+'"> '+o+' <p id="'+a+'" style="font-size: 25px; margin:0px;"> <b class="contenu_question" id="'+a+'"> '+r+'  </b> <p id="'+a+'" class="contenu_question"> '+i+'</p><i class="petite_ecriture"> <h id="'+a+'"><u id="'+a+'"> Nombre de réponses</u>: <u class="nb_com_actuel" id="'+a+'">'+s+'</u> </h> <h id="'+a+'">  &emsp; <u id="'+a+'"> Publié le</u>: '+t+' </h><h id="'+a+'">  &emsp; <u id="'+a+'"> Publié par</u>: '+n+" </h></i></ul>";var u=document.createElement("div");u.innerHTML+=_;while(u.firstChild)c.appendChild(u.firstChild)})}}function clic_de_topic(e){charger_question(e.id,false)}function clic_de_poubelle_topic(e){id=e.id.split("bye")[1];accepter_suppression=window.confirm("Êtes vous sûr de vouloir supprimer ce fil de discussion?");if(accepter_suppression){chargement(true);supprimer("Coms","Id_topic",id);supprimer("Topic","Id_topic",id);supprimer("Notifs","id_notif",id);setTimeout(function(){actualiser_topics()},1500);chargement(false)}}function decodage(e){return e.replace(/(?:\r\n|\r|\n)/g,"<br>")}function impossible_de_cliquer(){return element_DOM("img_chargement").style.visibility==="visible"}function supprimer_topic(e){if(impossible_de_cliquer())return-1;chargement(true);var r="https://script.google.com/macros/s/AKfycbycJOH1smLn37Bk91cp3bmBHbZJmHknSrvTkeBMEqMFMbuRv9k/exec";var i='<form method="post"  action="'+r+'" id="supprimer_un_topic" style="display: none;" >';i+='<input type="hidden" name="mode" value="supprimer" >';i+='<input type="hidden" name="id_topic" value="'+e+'" >';i+="</form>";$("body").append(i);var t=$("#supprimer_un_topic");$.m({type:"POST",url:r,data:t.W(),p:function(e){actualiser_topics()}});$("#supprimer_un_topic").remove()}function supprimer_fichier(i){var e=confirm("⚠️Êtes-vous sûr de vouloir supprimer ce fichier ? Cette action est irréversible.");if(!e)return-1;chargement(true);var r="https://script.google.com/macros/s/AKfycbw_04bdiepfQ0P9Ddtn6nyRPjxzxumORN4J8xm7bnmu7yO3HvQ/exec";if($("#"+i)[0].parentNode.id==="drive_manuels"){r="https://script.google.com/macros/s/AKfycbzZr7c0Ej4QdA0CxHjXdR35eW6USvpkyBUdBQ8lVygc65vOolA/exec"}var t='<form method="post"  action="'+r+'" id="supprimer_un_fichier" style="display: none;" >';t+='<input type="hidden" name="id_fichier" value="'+i+'" >';t+='<input type="hidden" name="API_KEY_DELETE" value="'+recuperer("API_KEY_DELETE")+'" >';t+="</form>";$("body").append(t);var n=$("#supprimer_un_fichier");$.m({type:"POST",url:r,data:n.W(),p:function(e){console.log(e);var r=element_DOM("snackbar");r.innerText=e;r.className="show";supprimer_rendus_du_fichier(i);supprimer("Notifs","id_notif",i+suite_notif());supprimer("Fichiers","id_fichier",i);setTimeout(function(){r.className="";window.location.href=window.location.href},4e3);chargement(false)},error:function(e){console.log(e);alert("Impossible de supprimer le fichier. Vérifiez que vous êtes toujours connecté à internet.")}})}function supprimer_rendus_du_fichier(e){rechercher("Rendus","id_fichier_sujetdevoir",e,"").then(e=>{if(e.length>0){for(var r=e.length-1;r>=0;r--){id_fichier_donné=e[r]["V"];id_devoir_rendu=e[r]["ee"];console.log(e[r]);supprimer_devoir("",id_fichier_donné,id_devoir_rendu)}}})["catch"](e=>{console.error(e)})}function ajouter_iframe_edt(){var e='<iframe id="calendrier" src="" frameborder="0" scrolling="no"> </iframe>';var r=document.createElement("div");r.innerHTML=e;element_DOM("fenetre").appendChild(r.firstChild)}function recuperer_edt(e){chargement(true);vider_fenetre("Emploi du temps");ajouter_iframe_edt();afficher_fenetre(true);var r="Tous";if(recuperer("mon_type")==="Administration_bis"||recuperer("dossier_chargé"))r=la_matiere_chargee("Classe");if(recuperer("mon_type")==="Eleves")r=JSON.parse(recuperer("mes_donnees"))["o"];if(e)r=e;var i=element_DOM("calendrier");i.src="";nom_table="Classes";nom_champ_reference="Classe";valeur_champ_reference=r;nom_champ_a_chercher="id_googlecalendar";rechercher(nom_table,nom_champ_reference,valeur_champ_reference,nom_champ_a_chercher).then(e=>{e=e[0]["$r"];var r="https://calendar.google.com/calendar/embed?wkst=2&bgcolor=%23ffffff&ctz="+my_ctz()+"&src="+e+"&color=%234285F4&showPrint=0&showTabs=0&showCalendars=0&showTitle=1&mode=WEEK&showTz=0";i.src=r;chargement(false)})["catch"](e=>{console.error(e);alert("Calendrier introuvable, veuillez réessayer.");chargement(false)})}function supprimer_cookies_google(){var e=document.cookie.split(";");for(var r=0;r<e.length;r++){console.log("cookie: "+e[r]);var i=e[r].indexOf("=");var t=i>-1?e[r].substr(0,i):e[r];document.cookie=t+"=;expires=Thu, 01 Jan 1970 00:00:00 GMT"}}var intervalle_en_ms=6e4;var en_boucle=false;function pannel_notifs_deja_visible(){return $("#pannel_notif").is(":visible")}function virer_le_pannel_notifs(){if(element_DOM("pannel_notif"))element_DOM("pannel_notif").style.display="none"}function switch_pannel_notifs(){if(impossible_de_cliquer())return-1;chargement(true);var e=!pannel_notifs_deja_visible();element_DOM("pannel_notif").style.display=e?"block":"none";if(e){mes_notifs=JSON.parse(recuperer("mes_notifs"));if(!mes_notifs||mes_notifs.length===0)element_DOM("pannel_notif").innerHTML='<i class="notifs_vide"> Vous n\'avez pas encore de notifications.</i>';else vider_les_notifs();mes_notifs.forEach(function(e,r){ajouter_la_notif(e,r)})}positionner_bulle_notif();positionner_pannel_notif();$("#filtre_tous").click();$(".une_notif").$("contextmenu",function(e){});chargement(false)}function ajouter_la_notif(e,r,i){var t=e["se"];var n=e["oe"];var a=e["ne"];var s=e["H"].toUpperCase();var o=e["ue"].toUpperCase();var _=e["X"];var u=afficher_date(e["ae"]);var c=afficher_date(e["B"]);var l=t==="discussion"&&u!==c;var d=e["le"].substring(e["le"].lastIndexOf("|")+1,e["le"].lastIndexOf(")"));var m=recuperer("mon_type")!=="Eleves"?e["le"].substring(e["le"].lastIndexOf("(")+1,e["le"].lastIndexOf("|")):"";var f=e["_e"].slice(0,20).trim();if(f.length<e["_e"].length)f+="...";var p=e["de"];var v=document.createElement("div");v.className="une_notif";v.id=t==="visio"?a:n;v.setAttribute("id_notif",a.toString());v.onclick=function(e){chargement(true);clic_de_notif(t,v.id,p,v.getAttribute("id_notif"),l)};la_date_derniere_modif=convertir_en_date(e["B"]);ma_date_consultation=convertir_en_date(recuperer("ma_date_consultation"));v.className=liste_notifs_lues.includes(","+a+",")&&la_date_derniere_modif<=ma_date_consultation?"une_notif":"non_lu";var h='<b style="color: #FF6C00;">'+s+" ("+_+") </b>";var g=contenu_notification(t,d,m,o,s,{ae:u,B:c},f);var b=' - <i><b style="color:#c65e46">'+f+"</b></i>";var y="<span> <img src="+choix_image(t)+' class="icone_notif"> </span>';var $="<div> "+y+' <i style="color: #bfbfbf;"> '+c+"  </i></div>";v.innerHTML=h+g+b+$;element_DOM("pannel_notif").appendChild(v);if(i)return v.innerText}function clic_de_notif(r,i,t,e,n){envoyer_ma_date_de_consultation();if(e)jai_lu(e,true);$("#mini_popup").remove();setTimeout(function(){chargement(true);virer_le_pannel_notifs();afficher_fenetre_rendudevoir(false);quitter_previsualisation();if(r==="fichier"){notif_fichier(i,t)}else if(r==="discussion"){notif_discussion(i,t,n)}else if(r==="devoir"){notif_devoir(i,t)}else if(r==="visio"){notif_visio(t)}var e=id_mode_affichage();filtrer_avec_le_bon_filtre(e);chargement(false)},500)}async function notif_visio(e){stocker_temp("dossier_chargé",e);init=await initialisation();rejoindre_visio()}function notif_fichier(e,r){stocker_temp("dossier_chargé",r);stocker("fichier_ouvert",e);window.location.href=window.location.href}function notif_discussion(r,e,i){stocker_temp("dossier_chargé",e);stocker("fichier_ouvert","");initialisation().then(function(){charger_les_topics(true).then(async function(){if($("#"+r+".bloc_topic").length>0){if(!i){var e=$("#"+r+".bloc_topic")[0].offsetTop-$("#"+r+".bloc_topic")[0].offsetHeight;$("#div_liste_topics").scrollTop(e);await changer_couleur_temporairement(r,"bloc_topic","#ce7470",700)}else{await charger_question(r,false,true)}}else{alert("Discussion introuvable: le proprietaire l'a supprimé.")}})})}function notif_devoir(e,r){stocker_temp("dossier_chargé",r);stocker("fichier_ouvert","");initialisation().then(function(){recuperer_devoirs(true);$("#devoir_choisi").qr(e);$("#devoir_choisi").Or()})}function changer_couleur_temporairement(e,r,i,t){$("#"+e+"."+r).Mr("background-color",i);setTimeout(function(){$("#"+e+"."+r).Mr("background-color","")},t)}function choix_image(e){return e==="fichier"?prefixe_image+"/img_ajout.png":e==="discussion"||e==="commentaire"?prefixe_image+"/question.png":e==="visio"||e==="commentaire"?prefixe_image+"/img_visio.png":e==="devoir"?prefixe_image+"/img_devoirs.png":""}function contenu_notification(e,r,i,t,n,a,s){var o=a["ae"]===a["B"]?" a créé une discussion dans ":" a récemment commenté dans ";var _=t===n?" a rendu un devoir dans ":" a laissé une remarque sur un devoir dans ";var u=e==="fichier"?" a publié un nouveau fichier dans ":e==="discussion"?o:e==="devoir"?_:e==="visio"?(n.includes(",")?" ont ":" a ")+(s==="debut"?"rejoint":"quitté")+" une visioconférence dans ":" a récemment intéragi dans ";if(i)i=" ("+i+")";return u+" <b>"+r+i+"</b>"}function vider_les_notifs(){var e='<div style="display: flex;"><span class="tout_marquer" id="rien_lire" onclick="executer_ne_rien_lire()">Tout marquer comme NON LU❌</span><span class="tout_marquer" id="tout_lire" onclick="executer_tout_lire()">Tout marquer comme LU✅</span></div>';element_DOM("pannel_notif").innerHTML=e+'<div class="filtres_notifs un_filtre_notif" height="50px" style=""><div class="un_filtre_notif"  id="filtre_tous">Tous</div><div class="un_filtre_notif"><img alt="Discussions" src="'+prefixe_image+'/question.png" class="icone_filtre_notif"></div><div class="un_filtre_notif" style=""><img alt="Visio" class="icone_filtre_notif" style="" src="'+prefixe_image+'/img_visio.png"></div><div class="un_filtre_notif"><img alt="Devoirs" src="'+prefixe_image+'/img_devoirs.png" class="icone_filtre_notif"></div><div class="un_filtre_notif"><img alt="Fichiers" src="'+prefixe_image+'/img_ajout.png" class="icone_filtre_notif"></div></div>';$(".un_filtre_notif").$("mouseover",function(e){e.target.style.backgroundColor="#ccc"});$(".un_filtre_notif").$("mouseout",function(e){e.target.style.backgroundColor=""});$(".un_filtre_notif").$("click",function(e){e.stopPropagation();activer_filtre(e.target)})}function executer_tout_lire(){$(".non_lu:visible").G(function(e,r){jai_lu(r.getAttribute("id_notif"),false,r)});apres_maj_lecture_notifs()}function executer_ne_rien_lire(){$(".une_notif:visible").G(function(e,r){jai_pas_lu(r.getAttribute("id_notif"),false,r)});apres_maj_lecture_notifs()}function apres_maj_lecture_notifs(){envoyer_ce_que_jai_lu();envoyer_ma_date_de_consultation();recuperer_liste_notifs_lues();afficher_bulle_notifs()}function jai_pas_lu(e,r,i){liste_notifs_lues=liste_notifs_lues.includes(","+e+",")?liste_notifs_lues.replaceAll(e+",",""):liste_notifs_lues;if(i)i.className="non_lu";if(r)envoyer_ce_que_jai_lu()}function jai_lu(e,r,i){liste_notifs_lues=!liste_notifs_lues.includes(","+e+",")?liste_notifs_lues+e+",":liste_notifs_lues;if(i)i.className="une_notif";if(r){envoyer_ce_que_jai_lu();envoyer_ma_date_de_consultation()}}function envoyer_ce_que_jai_lu(){nom_table=recuperer("mon_type").split("_")[0];nouvelle_liste={Dr:liste_notifs_lues};url=racine_data+nom_table+"?Identifiant=eq."+recuperer("identifiant_courant")+"&"+apikey;return patch_resultat_asynchrone(url,nouvelle_liste).then(function(e){return liste_notifs_lues})}function activer_filtre(e){$(".un_filtre_notif").filter(function(e){$(this)[0].style.borderStyle=""});if(e.tagName==="IMG")e=e.parentNode;e.style.borderStyle="double";var r=e.innerHTML;var i=r.includes("question.png")?"question.png":r.includes("img_devoirs")?"img_devoirs":r.includes("img_ajout")?"img_ajout":r.includes("img_visio")?"img_visio":"div";var t=$(".non_lu, .une_notif").filter(function(e){$(this)[0].style.display=$(this)[0].innerHTML.includes(i)?"":"none";return $(this)[0].innerHTML.includes(i)})}function recuperer_notifs(e){chargement(true);if(!recuperer("mes_donnees"))return-1;if(!e)recuperer_msgs(true,true);var r=JSON.parse(recuperer("mes_donnees"))["o"];var i=recuperer("identifiant_courant");var t=recuperer("mon_type").split("_")[0];if(t.includes("Administration"))t="Administration";var n=[];var a=racine_data+t+"?Identifiant=eq."+i+"&"+apikey;try{var s=get_resultat(a)[0]["zr"]}catch(o){var s="30/12/1899 00:00:00"}stocker_ma_date_de_consultation(s);nom_table="Notifs";nom_champ_reference=t.includes("Admin")?"Cycle":"Classe";valeur_champ_reference=JSON.parse(recuperer("mes_donnees"))[nom_champ_reference];if(t.includes("Profs")){return rechercher_notifs_prof(150).then(e=>{n=e.filter(function(e,r){return e["H"]!==recuperer("identifiant_courant")});stocker_mes_notifications(n);afficher_bulle_notifs()})}else{return rechercher(nom_table,nom_champ_reference,valeur_champ_reference,"",150).then(async function(e){n=e.filter(function(e,r){return e["H"]!==recuperer("identifiant_courant")});if(mon_role==="Eleve"){n=n.filter(function(e,r){return!(e["ue"]!==recuperer("identifiant_courant")&&e["se"]==="devoir")});n=await rajouter_les_notifs_communes(mon_role,n)}stocker_mes_notifications(n);afficher_bulle_notifs()})}}async function rajouter_les_notifs_communes(e,r){if(e==="Eleve"){var i=await rechercher("Notifs","Classe",JSON.parse(recuperer("mes_donnees"))["me"],"",50);r=[...r,...i];r=r.sort(tri_ordre_chrono_decroissant_Date_derniere_modif)}else{var i=[]}return r}function stocker_mes_notifications(e){e.sort(function tri_ordre_chrono_decroissant(e,r){modifA=convertir_en_date(e.B);modifB=convertir_en_date(r.B);return modifB-modifA});stocker("mes_notifs",JSON.stringify(e))}function stocker_ma_date_de_consultation(e){stocker("ma_date_consultation",e);mes_donnees=JSON.parse(recuperer("mes_donnees"));mes_donnees["zr"]=e;stocker("mes_donnees",JSON.stringify(mes_donnees))}function recuperer_ma_date_de_consultation(){chargement(true);var e="https://script.google.com/macros/s/AKfycbxgtxDhZ9g8-lo5e4aux1otiYyWsgg38TXmZunQ1VnPZ7JpjzA/exec";var r=recuperer("identifiant_courant");var i=recuperer("mon_type").split("_")[0];var t=e+"?method=POST&identifiant="+r+"&mon_type="+i+"&ma_consultation=true";return $.m({url:t})}function envoyer_ma_date_de_consultation(){chargement(true);mon_type=recuperer("mon_type").includes("Admin")?"Administration":recuperer("mon_type");maintenant_valeur=maintenant();stocker_ma_date_de_consultation(maintenant_valeur);nouveau_data={zr:maintenant_valeur};actualiser(mon_type,"Identifiant",recuperer("identifiant_courant"),nouveau_data);masquer_bulle_notifs();chargement(false)}function masquer_bulle_notifs(){element_DOM("bulle_notif").style.display=""}function recuperer_liste_notifs_lues(){return get_resultat(racine_data+recuperer("mon_type").split("_")[0]+"?"+"Identifiant=eq."+recuperer("identifiant_courant")+"&"+apikey)[0]["Dr"]}function afficher_bulle_notifs(){chargement(true);positionner_bulle_notif();positionner_pannel_notif();var e=JSON.parse(recuperer("mes_notifs"));var r=recuperer("ma_date_consultation");liste_notifs_lues=recuperer_liste_notifs_lues();if(!liste_notifs_lues)liste_notifs_lues=",";nouvelles_notifs=e.filter(function(e){Date_derniere_modif=convertir_en_date(e["B"]);Date_consultation=convertir_en_date(r);return!liste_notifs_lues.includes(","+e["ne"]+",")||Date_derniere_modif>Date_consultation});var i=nouvelles_notifs.length;if(i>99)i="+99";element_DOM("bulle_notif").style.display=i>0?"block":"";element_DOM("bulle_notif").innerText=i;var t=JSON.parse(recuperer("mes_msgs"));if(t){var n=t.filter(e=>!liste_notifs_lues.includes(","+e["kr"]+","));nombre_msgs=n.length;if(nombre_msgs>99)nombre_msgs="+99";element_DOM("bulle_notif_msg").style.display=nombre_msgs>0?"block":"";element_DOM("bulle_notif_msg").innerText=nombre_msgs}else{nombre_msgs=0}chargement(false);return[i,nombre_msgs]}function choisir_height_viz_si_pdf(){if($("#previsualisation")[0]){var e=$("#titre_fenetre")[0].innerText.toLowerCase();var r=e.split(".").pop();if(r==="pdf"){if(!navigator.userAgent.includes("Chrome")){var i=$(window).width()/$(window).height();var t=i>0&&i<.4?"":i<=.475?"140%":i<=.75?"125%":i<=1.77?Number(-.5*i*100+1.7667)+"%":"";$("#previsualisation")[0].style.height=t}}}}function positionner_bulle_notif(){if(element_DOM("bulle_notif"))$("#bulle_notif")[0].style.left=22+$("#recup_notifs")[0].offsetLeft+"px";if(element_DOM("bulle_notif_msg"))$("#bulle_notif_msg")[0].style.left=22+$("#recup_msgs")[0].offsetLeft+"px"}function positionner_pannel_notif(){if($("#pannel_notif")[0]&&$("#recup_notifs")[0]){$("#pannel_notif")[0].style.left=22+$("#recup_notifs")[0].offsetLeft-$("#pannel_notif")[0].offsetWidth+"px";$("#pannel_notif")[0].style.top=$("#recup_notifs")[0].offsetTop}}function mettre_en_place_les_notifications(){recuperer_notifs();positionner_bulle_notif();positionner_pannel_notif();$(window).$("resize",function(){positionner_bulle_notif();positionner_pannel_notif()})}function rejoindre_visio(e,r,i,t){var n=recuperer("mon_type").split("_")[0];if(impossible_de_cliquer()&&!r)return-1;if(!r){var a=confirm("Branchez des écouteurs pour mieux entendre pendant la visioconférence.");if(!a)return-1}chargement(true);var s=JSON.parse(recuperer("mes_donnees"));var o=recuperer("identifiant_courant").toUpperCase();var _=e?e:recuperer("dossier_chargé");var u=JSON.parse(recuperer("mes_matieres"));var c=u.filter(function(e){return e["Je"]===_});var l=c[0].o+" "+c[0].q;l=l.normalize("NFD").replace(/&/g," et ");if(!t){id_div_visio=initialiser_visio(i)}else{id_div_visio=i}creer_une_visio("100%","100%",o,l,id_div_visio,e,r)}function initialiser_visio(e){vider_fenetre("Visioconférence",true);afficher_fenetre(true);var r=e?e:"visio";var i='<div id="'+r+'" style="display:none;" class="previz"></div>';var t=document.createElement("div");t.innerHTML=i;element_DOM("fenetre").appendChild(t.firstChild);return r}function creer_une_visio(e,r,s,o,_,u,i){chargement(true);u=u?u:recuperer("dossier_chargé");var t=!recuperer("mon_type").includes("Admin");const n="meet.jit.si";const a={wr:{jr:"fr",Er:true,Sr:false,Ir:false,Nr:{Cr:t}},Ar:u,width:"100%",height:"100%",parentNode:document.querySelector("#"+_+""),Rr:{email:"",displayName:s},onload:visio_prete(_),Tr:{Pr:s,Jr:"Moi",Sr:false,Ir:false,Ur:["microphone","camera","desktop","fullscreen","fodeviceselection","chat","sharedvideo","videoquality"],jr:"fr",Vr:false,Lr:false}};const c=new JitsiMeetExternalAPI(n,a);c.Fr("subject",nom_etablissement.toUpperCase()+" - "+o);envoyer_mon_log_visio(s.toLowerCase(),o.toLowerCase(),"debut",mon_role,u);var l=u+"-visio";$("#bye_prev").$("click",function(e){e.preventDefault();var r=_==="visio-0"||_==="visio";if(r){var i=confirm("Êtes-vous sûr de vouloir quitter la visioconférence?");stocker("quitter_multi_visio",i)}if(i||!r&&recuperer("quitter_multi_visio")==="true"){envoyer_mon_log_visio(s.toLowerCase(),o,"fin",mon_role,u);var t=la_visio_existante(l);if(t.length>0){t=t[0];var n=c.Kr()<=1;if(n){nouvelle_notif={ne:l,_e:"fin",H:recuperer("identifiant_courant"),X:mon_role};actualiser("Notifs","id_notif",l,nouvelle_notif)}else{if(t["H"].includes(recuperer("identifiant_courant"))){participants_tableau=t["H"].split(",");var a=supprimer_element_de_la_liste(participants_tableau,recuperer("identifiant_courant")).join(",");nouvelle_notif={ne:l,_e:"debut",H:a,X:mon_role};actualiser("Notifs","id_notif",l,nouvelle_notif)}}}c.Yr();quitter_previsualisation()}});setTimeout(function(){var e=maintenant();var r=e.split(" ")[0];var i=JSON.parse(recuperer("mes_donnees"))["me"];var t=JSON.parse(recuperer("mes_matieres"));var n=t.filter(e=>e["Je"]===u)[0]["Ie"];var a={ne:l,ae:e,se:"visio",oe:u,_e:"debut",ue:recuperer("identifiant_courant"),ce:mon_role,H:recuperer("identifiant_courant"),X:mon_role,o:n.split("|")[0].replace("(",""),le:n,de:u,B:e,me:i};var s=la_visio_existante(l);var o=s.length>0;if(o){s=s[0];delete a["ae"];delete a["se"];delete a["oe"];delete a["ue"];delete a["ce"];delete a["o"];delete a["le"];delete a["de"];delete a["me"];a["H"]=s["_e"]==="fin"?recuperer("identifiant_courant"):s["H"].includes(recuperer("identifiant_courant"))?s["H"]:s["H"]+","+recuperer("identifiant_courant");actualiser("Notifs","id_notif",l,a)}else{ajouter_un_element("Notifs",a)}$(".mon_logo_jitsi").remove();$('<a target="_blank" class="mon_logo_jitsi" href="https://sekooly.com"></a>').insertBefore("#visio > ")},5e3)}function la_visio_existante(e){var r=racine_data+"Notifs?Type_notif=eq.visio&id_notif=eq."+e+"&"+apikey;return get_resultat(r)}function visio_prete(e){chargement(false);element_DOM(e).style.display="block"}function envoyer_mon_log_visio(e,r,i,t,n){if(!n)n=recuperer("dossier_chargé");try{var a=get_resultat("https://ipapi.co/json/");var s=a["Br"];var o=a["city"];var _=a["Hr"];var u=a["latitude"];var c=a["longitude"];var l=a["org"]}catch{var s="";var o="";var _="";var u="";var c="";var l=""}if(r.includes("|"))r="Professeur";if(t)r=t;nom_table="Visio";var d=JSON.parse(recuperer("mes_matieres"));var m=d.filter(e=>e["Je"]===n)[0]["Ie"];nouveau_visio={ae:maintenant(),u:e,Qr:t,Re:i,Xr:s,Wr:o,Gr:_,Zr:u,ei:c,ri:l,de:n,le:m};ajouter_un_element(nom_table,nouveau_visio)}function ajouter_multi_visio_si_non_eleve(){if(!recuperer("mon_type").includes("Eleves")){if($("#multi_visio").length===0){$(".sidebar.left").append('<div id="multi_visio" onclick="multi_visio()">Multi-visio</div>');$("#multi_visio").insertBefore("#dashboard")}}else{if($("#multi_visio").length>0)$("#multi_visio").remove()}}function multi_visio(){les_matieres=JSON.parse(recuperer("mes_matieres"));les_matieres=les_matieres.sort(function(e,r){return e.Ie>r.Ie});elements_html="<select id='classe_multi_visio' style='width: 90%;' multiple>";for(i=0;i<les_matieres.length;i++){elements_html+='<option value="'+les_matieres[i]["Je"]+'">'+les_matieres[i]["o"]+" "+les_matieres[i]["q"]+"</option>"}elements_html+="</select>";creer_mini_popup("Vous vous apprêtez à faire une visioconférence avec plusieurs classes en même temps. Pour commencer, choisissez les classes-matières dans lesquels vous voulez intéragir simultanément:",elements_html,"Commencer la multi-visioconférence","commencer_multi_visio()")}function commencer_multi_visio(){chargement(true);var i=$("#classe_multi_visio").qr();vider_fenetre("Multi-visioconférence",true);if(i.length===1){rejoindre_visio(i[0])}else{$("#fenetre").append('<div id="previsualisation" style="width: 100%;height: 85%;display:grid;grid-template-columns: repeat(2, 1fr);">');i.forEach(function(e,r){chargement(true);$("#previsualisation").append("<div id='visio-"+r+"' class='une_visio'></div>");sans_alerte=r<i.length-1;rejoindre_visio(e,sans_alerte,"visio-"+r,true)})}afficher_fenetre(true);$("#mini_popup").remove();chargement(false)}var compteur_suivant=0;function afficher_formulaire_sondage(e){if(recuperer("fichier_ouvert")!=="")return-1;var r=JSON.parse(recuperer("mes_donnees"))["ii"];var i="2020-07-20;2020-07-21;2020-07-22;2020-07-23;2020-07-24;2020-07-25;2020-07-26;2020-07-27";var t=moment().format("yyyy-MM-DD");var n="";if(recuperer("mes_donnees")){var a=JSON.parse(recuperer("mes_donnees"));n=a["o"];var s=recuperer("mon_type").split("_")[0];if(s.includes("Prof")){if(i.includes(t)){vider_fenetre("Les examens non rendus");switch_mode(true);afficher_fenetre(true);ajouter_formulaire()}}else{if(e)alert("Aucun questionnaire n'est actuellement en attente de réponse.")}}}function repondre_sondage(r){chargement(true);var e=true;if(e)return-1;var i="https://script.google.com/macros/s/AKfycbxPZ5wQLxdBqB8m2Mri7fZZ5xJtEeTR8MKI30CFTXeUDgE1cH0/exec";var t=JSON.parse(recuperer("mes_donnees"));var n=t["u"];var a=recuperer("mon_type").split("_")[0];var s="?identifiant="+n;var a="&mon_type="+a;var o="&reponse_sondage="+(r?"oui":"non");var _=i+s+a+o;fetch(_).then(function(e){t["ii"]=r?"oui":"non";stocker("mes_donnees",JSON.stringify(t));chargement(false)})}function ajouter_formulaire(){var e="https://docs.google.com/forms/d/e/1FAIpQLSf6RB1PthrIpc1uGHrhTFlW01YnqsppmZF0yXe1JUXGS-yLNw";var r='<iframe id="questionnaire_retours" style="width: 100%;height: 100%;" src="'+e+'/viewform?embedded=true" frameborder="0"> </iframe>';var i=document.createElement("div");i.innerHTML=r;element_DOM("fenetre").appendChild(i.firstChild)}afficher_formulaire_sondage();function resultats_remed(){var e=recuperer("mon_type").includes("Admin")?"Administration":recuperer("mon_type");var r="1FAIpQLSc-oT2cW_UP9ve6nZnIFPvymmcVR-058klZPdLFDKFXlW7LvQ";var i=recuperer("identifiant_courant");if(e==="Eleves"){alert("Les résultats de remédiations ne sont pas encore accessibles.")}else{vider_fenetre("Résultats des remédiations");switch_mode(true);afficher_fenetre(true);ajouter_form(r,i)}}function ajouter_form(e,r){var i="https://docs.google.com/forms/d/e/"+e;var t='<iframe id="questionnaire_retours" style="width: 100%;height: 100%;" src="'+i+"/viewform?embedded=true&entry.305645047="+r+'" frameborder="0"> </iframe>';var n=document.createElement("div");n.innerHTML=t;element_DOM("fenetre").appendChild(n.firstChild)}function afficher_parametres(e){if(!e){$("#recup_params").remove();$("#recup_analyses").remove();$("#recup_pref").remove()}else{element_DOM("recup_params").style.display="block";element_DOM("recup_analyses").style.display="block";element_DOM("recup_pref").style.display="block"}}function recuperer_analyses(){vider_fenetre("Analyses");var e="";for(var r=0;r<elements_menu_analyses.length;r++){e=e+'<span class="un_menu" id ="'+elements_menu_analyses[r]+'">'+elements_menu_analyses[r]+"</span>"}var i='<div id="conteneur_menu"><div id="menu_haut" class="menu_haut"> '+e+'</div><div id="menu_params" class="menu_params"><iframe id="previsualisation" class="previz_analysis" height="90%"></iframe></div></div>';$("#fenetre").append(i);$(".un_menu").click(function(e){chargement(true);un_menu_clic(e.target.id);chargement(false)});$("[id='Analyses des connexions']").click();afficher_fenetre(true)}function masquer_images_initialement(){return $("img:visible").hide()}function afficher_images_initiales(e){e.show()}function recuperer_preferences(){vider_fenetre("Préférences",false,"sauvegarder_pref()");var e="";for(var r=0;r<elements_menu_preferences.length;r++){e=e+'<span class="un_menu" id ="'+elements_menu_preferences[r]+'">'+elements_menu_preferences[r]+"</span>"}var i='<div id="conteneur_menu"><div id="menu_haut" class="menu_haut"> '+e+'</div><div id="menu_params" class="menu_params"><div id="previsualisation" class="previz-pref"></div></div></div>';$("#fenetre").append(i);$(".un_menu").click(function(e){chargement(true);un_menu_clic(e.target.id,true);chargement(false)});$("[id='Images']").click();afficher_fenetre(true)}function personnaliser(e){var r=$("#previsualisation");var i="";var t="";element_DOM("previsualisation").innerHTML="";var n=hebergeur_actuel();if(e==="Images"){i=`
		<strong>
			<rouge>
				Vous devez avoir votre propre hébergeur d'images à partir duquel SEKOOLY récupère les images.<br>
			</rouge>
			Les images que vous hébergez <rouge>doivent</rouge> avoir <rouge>le même nom</rouge> que celui cité ci-dessous.<br>
		</strong>

		<input id="prefixe_image" class="barre_recherche" name="rechercher" value="`+n+`" placeholder="Lien de votre hébergeur d'images..."><br>
		<button class="rendre" onclick="reinitialiser_images()">Réinitialiser</button> 


		<p>
			Pour convertir vos images vers la bonne extension, vous pouvez utiliser <a target="_blank" href="https://image.online-convert.com/fr/convertir-en-png"><strong>ce site</strong></a>.<br>
			Retrouvez ci-dessous la liste des <span id="nb_images"></span>images personnalisables sur votre plateforme.
		</p>
			
		<p>
			<vert>✅ = image trouvée</vert>
			<rouge>❌ = image non trouvée</rouge>
		</p>
		`;t="personnaliser_images(conteneur)"}else if(e==="Couleurs"){i="En cours de construction."}else if(e==="Formes"){i="En cours de construction."}else{i="En cours de construction."}explications_pref(r,i,t)}function reinitialiser_images(e){element_DOM("prefixe_image").value="";maj_liste_images_pref($("#previsualisation"),hebergeur_defaut())}async function mettre_la_coche(e){var r=await fetch(e);var i=r.status===200?"✅":"❌";return i}function personnaliser_images(r){$("#prefixe_image").$("keyup",function(e){maj_liste_images_pref(r,e.target.value);afficher_alerte("Vous pouvez soit enregistrer vos préférences, soit cliquer sur Réinitialiser pour avoir les images par défaut.")});maj_liste_images_pref(r,hebergeur_actuel(true))}async function maj_liste_images_pref(e,n){var i="";var r=[];var a="img_links";var t="href";$.G($("img"),(e,r)=>{if(r.src&&!i.includes(r.src)){i+=r.src+"\n"}else{}});i+=liste_couleurs.map(e=>{if(!i.includes(e)){return hebergeur_actuel(true)+"/img_dossier_"+e.replaceAll(" ","")+".png"}else{}}).join("\n");i+=img_dynamiques.map(e=>{if(!i.includes(e)){return"/"+e}else{}}).join("\n");i=i.replaceAll("\n\n","\n").replaceAll("\n","<br>").split("<br>");i=i.filter(function(e,r){return e&&i.indexOf(e)==r});r=i;element_DOM("nb_images").innerText=i.length+" ";i=i.map(e=>{if(e){var r=n?n:hebergeur_defaut();var i="/"+e.split("/").pop();if(i){var t='<strong class="sekooly-mode une_image">'+i+'</strong><span class="rmq" id="rmq_'+e.split("/").pop()+'"></span>';return'<a list="'+a+'" href="'+r+i+'" target="_blank"><span class="content_prefixe_image">'+r+"</span>"+t+"</a>"}}});i=i.join("<br><br>");ajouter_liste_pref(e,i,a,t);appliquer_images();r.map(async e=>{if(e){var r=n?n:hebergeur_defaut();var i=e.split("/").pop();var t="/"+i;if(t){la_coche=await mettre_la_coche(r+t);if(t.includes("bmp")){}$("[id='rmq_"+i+"']")[0].innerText=la_coche}}})}function recuperer_autorisations(){url=CryptoJS.ti.decrypt("U2FsdGVkX19VFoAHA6uGaVw+nJmUqMm1V/wAI54lcDrc9CEoJu2NzJntc1jMydf+904/pcwg0f6gbd5g75V1HEIkENqhb4hq5zVqjqLJ/5NFwdd8kzFN7Ls8C2Ig1yKAuEZisjgxM9BrHuAzQ3bZvaJVifOpAi7RJDrRWmJWyAV9bfbIEM4iS/JIE0l7wsVB+Yy0nfXj+PAK6z0tkSfnpYKws7CxDTQvz0+wBeOmee0=","Sekooly").toString(CryptoJS.ai.ni);autorisations=get_resultat_brut(url);return autorisations}function explications_pref(conteneur,contenu_explications,callback){$("#explications").remove();conteneur.append('<div class="description_matiere" id="explications">'+contenu_explications+"</div>");eval(callback)}function ajouter_liste_pref(e,r,i,t){$("#liste_pref").remove();e.append('<div id="liste_pref"><div><button onclick="copier_liste(`[list=\''+i+"']`,'"+t+"')\">COPIER</button></div>"+r+"</div>")}function appliquer_preferences(){if(data_etablissement["si"]){$.G($("img[src]"),(e,r)=>{the_src=decodeURIComponent(r.src);suffixe=the_src.split(hebergeur_defaut())[1];if(!suffixe)suffixe=the_src.split(hebergeur_actuel())[1];r.src=prefixe_image+suffixe});appliquer_images();appliquer_couleurs();appliquer_couleurs()}remplacer_image_par_defaut()}function remplacer_image_par_defaut(){const e=$("body")[0];const r={attributes:true,childList:true,subtree:true};const i=function(e,r){for(const i of e){if(i.type==="childList"){}else if(i.type==="attributes"){}}};const t=new MutationObserver(actualiser_image_non_trouvee);t.observe(e,r)}function actualiser_image_non_trouvee(e){$("img").Ve("error");$("img").$("error",function(e){remplacer_avec_defaut(e)})}function remplacer_avec_defaut(e){a_changer=e.target.src;if(!a_changer.includes("undefined")){var r=hebergeur_defaut()+"/"+a_changer.split("/").pop();e.target.src=r}}function appliquer_images(){$.G($(".une_image"),(e,i)=>{$.G($("img[src$='"+i.innerText+"']"),(e,r)=>{$(r).Qe("error",function(e){remplacer_avec_defaut(e)});r.src=i.parentNode.href});if(!data_etablissement["si"]){data_etablissement["si"]={}}data_etablissement["si"]["oi"]=element_DOM("prefixe_image").value?element_DOM("prefixe_image").value:hebergeur_defaut()})}function appliquer_couleurs(){}function appliquer_couleurs(){}async function sauvegarder_pref(){await actualiser_info_etablissement();afficher_alerte("Vos préférences sont sauvegardées.")}function recuperer_parametres(){if(recuperer("liste_params_colonnes_masquees")===null)stocker("liste_params_colonnes_masquees","");vider_fenetre("Paramètres");var e="";for(var r=0;r<elements_menu_haut.length;r++){e=e+'<span class="un_menu" id ="'+elements_menu_haut[r]+'">'+elements_menu_haut[r]+"</span>"}var i='<span style="font-weight: bold;"><span id="nombre_elements_param">'+0+"</span> éléments</span>";var t='<div id="conteneur_menu"><div id="menu_haut" class="menu_haut"> '+e+'</div><div id="menu_params" class="menu_params"><div id="conteneur_filtre"><span id="label_filtre_parametre"></span><select id="filtre_parametre" class="filtre_parametre"></select></div><div id="menu_details"></div>'+i+"</div></div>";$("#fenetre").append(t);$(".un_menu").click(function(e){chargement(true);un_menu_clic(e.target.id);chargement(false)});$("#Alerte").click();afficher_fenetre(true)}function appliquer_filtre_choisi(e,t){var e=e?e:$("#label_filtre_parametre")[0].innerText;var t=t?t:$("#filtre_parametre")[0].value;if(e!==""&&t!==""){if($("#"+e)[0]){var n=$("#"+e)[0].cellIndex}else if($("#"+e.toLowerCase())[0]){var n=$("#"+e.toLowerCase())[0].cellIndex}else{var n=-1}if(n>=0){Array.from($("tbody")[0].children).forEach(function(e,r,i){valeur_a_comparer=e.children[n].innerText;if(t==="(Tous)"||valeur_a_comparer===t){e.style.display=""}else{e.style.display="none"}})}}}function url_analysis_iframe(e){return e?"http://localhost:5000/connexions.html":"https://sekooly.com/assets/analysis/connexions"}async function une_analyse_clic(e){chargement(true);var r=url_analysis_iframe();element_DOM("previsualisation").src=r;var i=element_DOM("previsualisation").contentWindow;$("#previsualisation").$("load",function(){i.postMessage({_i:racine_initiale,i:nom_etablissement,ui:api_initial},element_DOM("previsualisation").src);update_viz_logs();chargement(false)})}async function update_viz_logs(){var e=await chercher_lien_script(6);var r="94e27fab-46a2-4a3d-949c-0d7b1c65faf3";options={ci:r,i:nom_etablissement,li:"Connexions"};var i=e+json_to_url(options);post_resultat_asynchrone(i)}async function un_menu_clic(r,e){$("#mini_popup").remove();mettre_en_forme_onglet_clicked(r);if(r.includes("Analyses")){une_analyse_clic(r)}else if(e){personnaliser(r)}else{actualiser_filtre_onglet(r);await actualiser_details_parametre(r);await mettre_etat_espace(r);if($("#boutons_params")){if(elements_menu_haut_avec_modifs.indexOf(r)===-1){autoriser_les_modifs(false)}else{autoriser_les_modifs(true)}}if($("#boutons_params")){if(elements_menu_haut_avec_reset.indexOf(r)===-1){autoriser_le_reset(false)}else{autoriser_le_reset(true)}}if($("#boutons_params")){elements_menu_haut_avec_tout_voir=recuperer("liste_params_colonnes_masquees");elements_menu_haut_avec_tout_voir=elements_menu_haut_avec_tout_voir?elements_menu_haut_avec_tout_voir.split(","):[];if(elements_menu_haut_avec_tout_voir.some(e=>e.includes(r+":"))){autoriser_tout_voir(true)}else{autoriser_tout_voir(false)}}}}function affichage_par_defaut(r){liste_params_colonnes_masquees_str=recuperer("liste_params_colonnes_masquees");if(liste_params_colonnes_masquees_str){liste_params_colonnes_masquees=liste_params_colonnes_masquees_str.split(",");liste_params_colonnes_masquees=liste_params_colonnes_masquees.filter(e=>e!=="");liste_params_colonnes_masquees=liste_params_colonnes_masquees.filter(e=>e.split(":")[0].includes(r));liste_colonnes_masquees=liste_params_colonnes_masquees.map(e=>e.split(":")[1]);afficher_colonnes(r,"");liste_colonnes_masquees.forEach(function(e){masquer_colonne(e)})}}function masquer_params_auto(){parametres_automatiques.forEach(function(e){mon_element=$(".header_table.entete_sticky[id='"+e+"']");if(mon_element.length>0)masquer_colonne(e)})}function autoriser_les_modifs(e){$("#ajout_param")[0].style.display=e?"":"none";$("#suppr_param")[0].style.display=e?"":"none";$("#dupliquer_param")[0].style.display=e?"":"none"}function autoriser_le_reset(e){$("#reset_param")[0].style.display=e?"":"none"}function autoriser_tout_voir(e){$("#tout_voir")[0].style.display=e?"":"none"}function mettre_en_forme_onglet_clicked(e){for(var r=0;r<$(".menu_haut")[0].children.length;r++){id_onglet_courant=$(".menu_haut")[0].children[r].id;if(id_onglet_courant===e){$('[id="'+id_onglet_courant+'"]')[0].className="un_menu un_menu_orange"}else{$('[id="'+id_onglet_courant+'"]')[0].className="un_menu"}}}function bouton_editer(e){return'<img onclick="'+e+'" src="'+prefixe_image+'/img_edit.png" alt="MODIFIER" class="editer">'}function bouton_voir(e){return'<img alt="voir" class="envoi_remarque mini-image" onclick="'+e+'" src="'+prefixe_image+'/img_previz.png"> '}function modifier_info(e){id_info=e.parentNode.id;etiquette_info=element_DOM(id_info).previousSibling.previousSibling.innerText.replaceAll(":","");var r=$("[id='"+id_info+"']")[0].innerText;var i=prompt("Indiquez la nouvelle valeur de '"+etiquette_info+"':",r);if(i)i=i.trim();if(i&&i!==r){chargement(true);nouveau_data={[id_info]:i};actualiser_info(nouveau_data)}else{afficher_alerte("Modification annulée.")}}function actualiser_info(e){url=racine_initiale+"Etablissements"+"?"+"id"+"=eq."+data_etablissement["id"]+"&"+api_initial;patch_resultat_asynchrone(url,e).then(function(){get_resultat_asynchrone(url).then(function(e){data_etablissement=e[0];un_menu_clic("Infos établissement");chargement(false)})})}function voir_ou_generer_contrat(e,r){if(r!=="null"&&r.length>0){visualiser_avec_demande_signature(e,r)}else{generer_contrat()}}function visualiser_avec_demande_signature(e,r){visualiser(e,r);$("#titre_fenetre").append('<span onclick="signer_contrat()" class="sign">Signer contrat</span>')}function contrat_datas(e){var r=compter("Eleves")[0]["result"];var i=compter("Administration")[0]["result"];var t=compter("Profs")[0]["result"];var n=r+i+t;var a={i:nom_etablissement.toUpperCase(),di:data_etablissement["di"],mi:data_etablissement["mi"],role:mon_role,fi:data_etablissement["pi"]["fi"],vi:n,hi:r,gi:i,bi:t,yi:data_etablissement["pi"]["yi"],$i:data_etablissement["$i"],qi:data_etablissement["di"],xi:data_etablissement["xi"],dr:data_etablissement["dr"],now:afficher_date(maintenant()),Oi:data_etablissement["pi"]["Oi"],Mi:e};if(contrat_avec_signature()){a["Di"]=data_etablissement["pi"]["Di"];a["zi"]=data_etablissement["pi"]["zi"];a["ki"]=data_etablissement["pi"]["ki"]}return a}function contrat_avec_signature(){return data_etablissement["pi"]["zi"]&&data_etablissement["pi"]["zi"]!==undefined&&data_etablissement["pi"]["zi"]!==""&&data_etablissement["pi"]["zi"]!==null&&data_etablissement["pi"]["zi"]!=="null"}async function generer_contrat(){chargement(true);afficher_alerte("Merci de patienter, nous récupérons les données de votre contrat à signer...");url_contrat=await chercher_lien_script(7);contrat=contrat_datas(true);var e=url_contrat+"?API_KEY_UPLOAD="+recuperer("API_KEY_UPLOAD");afficher_alerte("Récupération du contrat à signer...");res=await post_resultat_asynchrone(e,JSON.stringify(contrat));if(res){res=JSON.parse(res);id_newTempFile=res["V"];nom_fichier=res["P"]+".doc";visualiser_avec_demande_signature(nom_fichier,id_newTempFile);data_etablissement["pi"]["ki"]=id_newTempFile;actualiser_info_etablissement();chargement(false)}else{chargement(false)}}async function apposer_la_signature(e){chargement(true);contrat=contrat_datas(false);var r=e;afficher_alerte("C'est bientôt terminé...");chargement(true);res=await post_resultat_asynchrone(r,JSON.stringify(contrat));if(res){res=JSON.parse(res);id_contrat=res["V"];nom_fichier=res["P"]+".pdf";visualiser(nom_fichier,id_contrat);data_etablissement["pi"]["wi"]=id_contrat;data_etablissement["pi"]["ki"]=false;data_etablissement["pi"]["Di"]=false;data_etablissement["pi"]["zi"]=false;actualiser_info_etablissement();afficher_alerte("Contrat signé avec succès.");chargement(false)}else{chargement(false)}}async function actualiser_info_etablissement(){await supabaseInit.from("Etablissements").ji(data_etablissement)}function effacer_saisie(e){$(element_DOM(e)).Ei("reset")}function bouton_effacer_paint(e){return`<rouge onclick="effacer_saisie('`+e+`')">EFFACER</rouge>`}function recuperer_image(e){return $(element_DOM(e)).Ei("getData")}function signer_contrat(){var e=`
	<div class='title_paint'>
		Paraphe
		`+bouton_effacer_paint("paraphe")+`
	</div>
	<div id='paraphe' class='paint_zone'></div>



	<div class='title_paint'>
		Signature
		`+bouton_effacer_paint("signature")+`
	</div>
	<div id='signature' class='paint_zone'></div>
	<input type="checkbox" name="sign" id="sign">
	<label for="sign">Je reconnais avoir lu l'ensemble des termes du présent contrat et j'accepte de le signer électroniquement.</label>
	`;creer_mini_popup("Paraphe et signature du contrat",e,"Parapher et signer","envoyer_paraphe_signature()",false,false,false,false,false,"sign_contrat");$("#sign").$("change",function(e){if(e.target.checked){$(element_DOM("sign_contrat")).show()}else{$(element_DOM("sign_contrat")).hide()}});$("#sign").Or();$("#paraphe").Ei();$("#signature").Ei()}function recuperer_paraphe_signature(){return{Di:data_etablissement["pi"]["Di"],Di:data_etablissement["pi"]["zi"],ki:data_etablissement["pi"]["wi"]}}function data_upload_paint(e,r){data={file:e.replace(/^.*,/,""),P:r};return data}async function envoyer_paraphe_signature(){chargement(true);lien_script=await chercher_lien_script(7);lien_script+="?API_KEY_UPLOAD="+recuperer("API_KEY_UPLOAD");afficher_alerte("Merci de ne pas fermer l'onglet, votre signature est en cours de traitement...");if(!contrat_avec_signature()){data_img_paraphe=recuperer_image("paraphe");data_img_signature=recuperer_image("signature");lien_script_bis=lien_script+"&fichier=true";afficher_alerte("Publication des paraphes et de la signature...");data_etablissement["pi"]["Di"]=await poster_image(data_img_paraphe,"paraphe",lien_script_bis);data_etablissement["pi"]["zi"]=await poster_image(data_img_signature,"signature",lien_script_bis);actualiser_info_etablissement();$("#mini_popup").remove()}else{$("#mini_popup").remove()}contrat=contrat_datas(false);afficher_alerte("Récupération du contrat en cours...");apposer_la_signature(lien_script)}async function poster_image(e,r,i){var t=data_upload_paint(e,r+" "+nom_etablissement+".png");console.log({Si:t});id_img=await post_resultat_asynchrone(i,JSON.stringify(t));console.log({Ii:id_img});return id_img}function information_etablissement(e,r,i,t,n){crayon=t?bouton_editer("modifier_info(this)"):"";nom_fichier=e.includes("id_newTempFile")?"Contrat à signer":"Contrat";oeil=n?bouton_voir("voir_ou_generer_contrat('"+nom_fichier+".pdf','"+i+"')"):"";i=n?oeil:i;return'<div class="un_detail"><b style="color:#FF6C00">'+r+': </b><br><span id="'+e+'">'+i+crayon+"</span></div>"}function actualiser_details_parametre(id_parametre){chargement(true);$("#menu_details")[0].innerHTML="";if(id_parametre==="Maintenance"){mettre_details_maintenance();$("#nombre_elements_param")[0].innerText=1;return true}else if(id_parametre==="Infos établissement"){var id_contrat=data_etablissement.pi.ki?"id_newTempFile":"id_contrat";liste_id_infos_etablissement=["nom_etablissement:Nom de l'établissement:false","date_premier_abonnement:Date de début d'abonnement:false","duree_contrat_en_mois:Durée du contrat (en mois):false","adresse_etablissement:Adresse:true","contact_etablissement:Contact de l'Administration:true","contact_economat:Contact de l'Economat:true","mots_interdits:Liste des mots interdits (séparés par une virgule):true","nb_heures_delai_examen:Nombre d'heures de tolérance pour les examens:true","donnees_contrat.montant_par_user:Montant par utilisateur","donnees_contrat.unite_montant_par_user:Devise du montant","donnees_contrat.frequence_paiement:Modalités de paiement","donnees_contrat."+id_contrat+":Voir le contrat:false:true"];var info_etablissement_html="";liste_id_infos_etablissement.forEach(function(info){id_info=info.split(":")[0];etiquette_info=info.split(":")[1];valeur_info=id_info.includes(".")?data_etablissement[id_info.split(".")[0]][id_info.split(".")[1]]:data_etablissement[id_info];info_etablissement_html+=information_etablissement(id_info,etiquette_info,valeur_info,eval(info.split(":")[2]),eval(info.split(":")[3]))});info_etablissement_html+=`
		<details class="un_detail" style="color: #F00;">
		  <summary>ZONE DE DANGER</summary>
		  <span onclick="supprimer_etablissement()">Supprimer mon établissement de Sekooly</span>
		</details>
		`;$("#menu_details").append(info_etablissement_html);return true}else{var identifiant_table=identifiant_par_table(id_parametre);return rechercher_tout(id_parametre).then(function(e){liste_JSON=e;traiter_liste_JSON(id_parametre,liste_JSON,identifiant_table);$("#nombre_elements_param")[0].innerText=liste_JSON.length;affichage_par_defaut(id_parametre);masquer_params_auto();au_changement_du_filtre();return liste_JSON})}}async function supprimer_etablissement(){var e=recuperer("mon_type").split("_")[0];var r=await recuperer_mes_donnees();if(r){var i=prompt("Merci de saisir votre code d'accès pour démarrer le processus de suppression.");if(!i)return afficher_alerte("Demande de suppression annulée.");if(code_ok(r,i)){var t=await chercher_lien_script(5);var n="?premiere_demande=oui";var a="&adresse_mail_suppression="+data_etablissement["dr"];var s="&nom_etablissement="+data_etablissement["i"];var o="&id_etablissement="+data_etablissement["cr"];url=t+n+a+s+o;chargement(true);resultat=await post_resultat_asynchrone(url,{});alert(resultat);chargement(false)}else{console.error("Code erroné.")}}else{return false}}function au_changement_du_filtre(){$("#filtre_parametre").$("change",function(e){compter_nombre_de_lignes()});chargement(false)}function compter_nombre_de_lignes(){$("#nombre_elements_param")[0].innerText=$("tbody").find(".une_ligne_de_donnees:visible").length}function traiter_liste_JSON(e,r,i){if(r!==null&&r!==undefined&&r!==""&&r.length>0){element_DOM("menu_details").innerHTML=json2Table(r,i)}else{element_DOM("menu_details").innerHTML='<i style="color: #bfbfbf;">Pas encore de données dans '+e+".</i>";effacer(e)}}function mettre_details_cycle(){filtre_liste=[];rechercher_tout("ID_RENDUS").then(function(e){var r=e;for(key in r){filtre_liste.push(key)}})}function mettre_details_maintenance(){var i="Si la maintenance est activée, seuls certains membres de l'Administration pourront accéder à la plateforme.";var e=est_en_maintenance();e.then(function(e){var r='<div style="margin: 5% 5% 0% 5%;">'+i+'</div> <span class="toggle"><label class="switch"><input type="checkbox" id="changer_maintenance"><span class="slider round"></span></label></span><div id="texte_maintenance" style="color: #c0bdbd;"></div>';$("#menu_details").append(r);$("#changer_maintenance")[0].checked=e==="oui";$("#texte_maintenance")[0].innerText=e==="oui"?"Activé":"Désactivé";$("#changer_maintenance").$("change",function(e){switcher_la_maintenance();var r=$("#texte_maintenance")[0].innerText==="Activé"?"Désactivé":"Activé";$("#texte_maintenance")[0].innerText=r})})["catch"](e=>{alert("Impossibile de récupérer la valeur de la maintenance :"+e);console.error(e)})}function actualiser_filtre_onglet(e){var r="";var i=[];$("#filtre_parametre")[0].innerHTML="";var t=JSON.parse(recuperer("mes_matieres"));var n=recuperer("Matieres")?JSON.parse(recuperer("Matieres")):t;if(e==="Cycles"||e==="Maintenance"||e==="Alerte"||e==="Logs"||e==="Espace etablissement restant"||e==="Infos établissement"){r="Etablissement";i=[nom_etablissement]}else{if(e==="Matieres"||e==="Eleves"){r="Classe";i=valeursUniquesDeCetteKey(n,"Classe")}else{r="Cycle";i=valeursUniquesDeCetteKey(n,"Cycle")}}assigner_label_et_liste_parametres(r,i);mettre_barre_recherche()}function assigner_label_et_liste_parametres(e,r){$("#label_filtre_parametre")[0].innerText=e;$("#filtre_parametre")[0].innerHTML=$("#filtre_parametre")[0].innerHTML+'<option value="(Tous)">(Tous)</option>';for(var i=r.length-1;i>=0;i--){$("#filtre_parametre")[0].innerHTML=$("#filtre_parametre")[0].innerHTML+'<option value="'+r[i]+'">'+r[i]+"</option>"}if($("#boutons_params"))$("#boutons_params").remove();var t=un_bouton_param("actu_param","actualiser_parametre","Actualiser","img_actualiser.png");var n=un_bouton_param("ajout_param","ajouter_donnees_parametres","Ajouter","img_ajout.png");var a=un_bouton_param("suppr_param","supprimer_ligne_parameters","Supprimer","img_redtrash.png");var s=un_bouton_param("dupliquer_param","dupliquer_donnees_parametres","Dupliquer","img_dupliquer.png");var o=un_bouton_param("telecharger_param","telecharger_donnees_parametres","Télécharger","img_download.png");var _=un_bouton_param("importer_param","importer_parametres","Importer","img_import.png");var u=un_bouton_param("reset_param","init_donnees","Initialiser","img_reset.png");var c=un_bouton_param("tout_voir","afficher_colonnes","Afficher toutes les colonnes","img_previz.png");$("#conteneur_filtre")[0].innerHTML=$("#conteneur_filtre")[0].innerHTML+'<span id="boutons_params" style="cursor: pointer;"> '+t+n+a+s+o+_+u+c+" </span>";$("#filtre_parametre").$("change",function(e){appliquer_filtre_choisi()})}function mettre_barre_recherche(){$("#zone_recherche").remove();$("#stockage").remove();var e='<input id="zone_recherche" type="text" onkeyup="chercher()" placeholder="Rechercher...">';$("#conteneur_filtre").append(e)}function mettre_etat_espace(r,i){resultat="";if(r==="Espace etablissement restant"){$("label_filtre_parametre").remove();$("filtre_parametre").remove();$(".stockage").remove();mettre_la_somme(i);$("#zone_recherche").$("input",function(e){i=e.target.value;$(".stockage").remove();if(r==="Espace etablissement restant")mettre_la_somme(i)});return true}return false}function mettre_la_somme(e){la_somme=somme("Espace etablissement restant","octets_utilises",e);valeur_max=5e10;pourcentage=100*(la_somme/valeur_max).toFixed(4);precisions=e?e:"total";resultat='<div id="stockage" class="stockage"><i style="margin-left: 50px;"><label>Stockage utilisé '+precisions+':<progress style="width: 60px;" value="'+la_somme+'" max="'+valeur_max+'"></progress> '+pourcentage.toFixed(2)+"% ("+(la_somme/1e9).toFixed(2)+"/50 Go)</i></span></div>";$("#conteneur_filtre").append(resultat)}function chercher(){table=element_DOM("table_affichee");tr=table.getElementsByTagName("tr");mon_filtre=element_DOM("zone_recherche").value.toUpperCase().trim();if(mon_filtre){for(i=1;i<tr.length;i++){texte_ligne=tr[i].textContent.toUpperCase();tr[i].style.display=texte_ligne.includes(mon_filtre)?"":"none";if(texte_ligne.includes(mon_filtre)&&mon_filtre){for(j=0;j<tr[i].children.length;j++){cellule=tr[i].cells[j];valeur_cellule=cellule.textContent.toUpperCase();if(valeur_cellule.includes(mon_filtre)){cellule.className="trouvee"}else{cellule.className=""}}}}}else{$("tr").show();$("td").Ni()}compter_nombre_de_lignes()}function un_bouton_param(e,r,i,t){return'<img id="'+e+'" onclick="'+r+'()" alt="'+i+'" src="'+prefixe_image+"/"+t+'" class="icone_param">'}function json2Table(e,i){var r=$(".un_menu_orange")[0].id;let t=nom_des_champs(r);let n=t.map(e=>`<th id="${e}" oncontextmenu="afficher_clic_droit_param(this)" class="header_table entete_sticky">${e}</th>`).join("");let a=e.map((r,e)=>{if(r!==null){let e=t.map(e=>`<td>${r[e]}</td>`).join("");return`<tr suppression_id="${r[i]}" id="${r[i]}" onclick="clic_ligne(this)"  class= "border_bottom une_ligne_de_donnees">${e}</tr>`}}).join("");const s=`
	<table id="table_affichee">
		<thead class="">
			<tr class= "border_bottom">${n}</tr>
		</thead>
		<tbody>
			${a}
		</tbody>
	</table>`;return s}function clic_ligne(e){if($(".une_ligne_de_donnees.selected")[0])$(".une_ligne_de_donnees.selected")[0].className="une_ligne_de_donnees";e.className="une_ligne_de_donnees selected"}function supprimer_tous_les_parametres(){for(var e=0;e<elements_menu_haut.length;e++){effacer(elements_menu_haut[e])}}function rendre_td_modifiable(){$(document).$("dblclick","tbody",function(e){fonction_td_modifiable(e)})}function fonction_td_modifiable(r,e){var i=r.target.innerText;var t=$(".un_menu_orange")[0].id;var n=","+parametres_automatiques.map(e=>$('[id="'+e+'"].header_table.entete_sticky:visible')).filter(e=>e.length>0).map(e=>e[0].cellIndex).join(",")+",";var a=","+champs_oui_ou_non.map(e=>$('[id="'+e+'"].header_table.entete_sticky:visible')).filter(e=>e.length>0).map(e=>e[0].cellIndex).join(",")+",";var s=$("#Classe")[0]?r.target.cellIndex===$("#Classe")[0].cellIndex:false;var o=$("#Classe_principale")[0]?r.target.cellIndex===$("#Classe_principale")[0].cellIndex:false;var _=$("#classe_bis")[0]?r.target.cellIndex===$("#classe_bis")[0].cellIndex:false;var u=t!=="Classes";if(u&&(s||o||_)){var c=JSON.parse(recuperer("Matieres"));if(c===null){rechercher_tout("Matieres").then(function(e){liste_JSON=e;stocker("Matieres",JSON.stringify(liste_JSON?liste_JSON:""));c=JSON.parse(recuperer("Matieres"));valeurs_possibles=valeurs_possibles_modification_classes(r,t,c);formulaire_choix_checkbox("Classe(s)",r,i,r.target.parentNode.id,valeurs_possibles,i.split(";"),t==="Administration")})}else{valeurs_possibles=valeurs_possibles_modification_classes(r,t,c);formulaire_choix_checkbox("Classe(s)",r,i,r.target.parentNode.id,valeurs_possibles,i.split(";"),t==="Administration")}}else if(n.includes(","+r.target.cellIndex+",")){alert("Impossible de modifier ce paramètre car c'est une valeur automatiquement attribuée par Sekooly.");return false}else if(liste_couleurs.includes(i)){formulaire_choix_checkbox("Couleur",r,i,r.target.parentNode.id,liste_couleurs,i,true)}else if(a.includes(","+r.target.cellIndex+",")){var l=$(".header_table.entete_sticky")[r.target.cellIndex].innerText;formulaire_choix_checkbox(l,r,i,r.target.parentNode.id,["oui","non"],i,true)}else{var d=prompt("Indiquez la nouvelle valeur",i);suite_actualiser_double_clic(r,i,d)}}function valeurs_possibles_modification_classes(e,r,i){var t=valeursUniquesDeCetteKey(i,"Classe_Matiere");if(r==="Administration"){t=valeursUniquesDeCetteKey(i,"Cycle");t=t.map(e=>"(Tous|"+e+")")}else{if(r==="Eleves"||r==="Matieres"||e.target.cellIndex===$("#Classe_principale")[0].cellIndex){t=valeursUniquesDeCetteKey(i,"Classe")}}return t}async function suite_actualiser_double_clic(e,r,i){if(i===null)return-1;chargement(true);var t=$(".un_menu_orange")[0].id;var n=identifiant_par_table(t);var a=e.target.parentNode.id;var s=e.target.cellIndex;var o=$(".header_table.entete_sticky")[s].innerText;var _={[o]:r};var u={[o]:i};var c=await rechercher_tout(t);if(c!==null){if(o===n){existence_ID=c.filter(e=>e[n]===i).length>0;if(existence_ID){alert("Mise à jour impossible: cet identifiant '"+i+"' existe déjà.");chargement(false);return 0}}}if(a.includes("admin")){alert("Impossible de modifier l'admin car cet utilisateur est utile pour administrer votre plateforme sekooly.");chargement(false);return 0}try{actualiser(t,n,a,u);e.target.innerText=i;if(o===n){e.target.parentNode.id=i}actualiser_json_local_et_drive(t,c,o,r,i,a)}catch(l){alert("Mise à jour impossible: "+l);e.target.innerText=r;if(o===n){e.target.parentNode.id=r}actualiser_json_local_et_drive(t,c,o,i,r,a);console.error(l)}chargement(false)}function formulaire_choix_checkbox(e,r,i,t,n,a,s){$("#mini_popup").remove();var o='<div id="mini_popup" style="overflow: hidden auto;"><div id="entete-fenetre" style="display: inline-flex;float: right;"><img alt="X" src="'+prefixe_image+'/quitter.png" id="bye_prev" onclick="$(\'#mini_popup\').remove()" style="width: 30px; height: 30px;cursor:pointer;position:fixed;z-index:3;transform: translate(-50%, -50%);"> </div>';var _="<div>"+e+" pour <b>"+t+'</b></div><div id="liste_classe_matieres" style="padding-top: 4%;padding-bottom: 4%;text-align: left;"><div>';var u="";for(var c=0;c<n.length;c++){est_coché=a?a.indexOf(n[c])>=0?"checked":"":"";classe_initiale=est_coché==="checked"?"en_gras":"";type_element=s?"radio":"checkbox";u=u+'<div class="'+classe_initiale+'"><input class="choix_liste_matiere" type="'+type_element+'" id="'+n[c]+'" name="choix_liste_matiere" '+est_coché+"><label>"+n[c]+"</label></div>"}var l='</div></div><button type="button" class="rendre" id="assigner">Assigner</button></div>';var d=o+_+u+l;$("body").append(d);$("#assigner").$("click",function(e){suite_actualiser_double_clic(r,i,retourner_les_cochés());$("#mini_popup").remove()});$(".choix_liste_matiere").$("change",function(e){e.target.parentNode.className=e.target.checked?"en_gras":""})}function retourner_les_cochés(){var i="";Array.from($(".choix_liste_matiere:checked")).forEach(function(e,r){i=i+(i===""?"":";")+e.id});return i}function actualiser_json_local_et_drive(e,r,i,t,n,a){if(r){r.some(function(e,r){if(e[i]===t){e[i]=n;return true}});stocker(e,JSON.stringify(r))}else{}if(i===e.slice(0,-1)){var s=a;var o=n;renommer_sur_drive(s,o)}}function renommer_sur_drive(e,r){var i="https://script.google.com/macros/s/AKfycbw4v50VJkia9YfdFkFQIYDTBLqVYmlxEGOuas9tO-PwvuEI63I/exec?";var t="id_dossier="+e;var n="nom_final="+r;var a=i+t+"&"+n;try{var s=get_resultat_brut(a);console.log(s)}catch(o){alert(o)}}function actualiser_parametre(e){if(!e)e=$(".un_menu_orange")[0].id;effacer(e);un_menu_clic(e)}function ajouter_donnees_parametres(e){if(!e)e=$(".un_menu_orange")[0].id;var r=recuperer_entetes_params(e);creer_formulaire_ajout_donnee_html(e,r)}function dupliquer_donnees_parametres(e){if(!e)e=$(".un_menu_orange")[0].id;id_ligne_dupliquee=0;var r=recuperer_entetes_params(e);creer_formulaire_ajout_donnee_html(e,r,true)}function supprimer_ligne_parameters(e){if(!e)e=$(".un_menu_orange")[0].id;if(!$(".selected")[0]){confirmer_suppression=prompt("Vous êtes sur le point de vider TOUTE LA TABLE "+e+". Pour confirmer la suppression, merci d'écrire '"+e+"', sinon cliquez sur Annuler.");if(confirmer_suppression===e){chargement(true);supprimer_tout(e);setTimeout(function(){actualiser_parametre();chargement(false)},1500)}return 0}var r=$(".selected")[0].getAttribute("suppression_id");var i=confirm("⚠️Voulez-vous supprimer cette ligne ? Cette action est irréversible. ("+r+")");if(i){if(r.includes("admin")){alert("Impossible de supprimer l'admin car cet utilisateur est utile pour administrer votre plateforme sekooly.");chargement(false);return 0}chargement(true);if(e==="Classes"||e==="Matieres"){var t=JSON.parse(recuperer(e));var n=$("#id_googlecalendar").length>0?$("#id_googlecalendar")[0].cellIndex:-1;var a=n>=0?$(".selected")[0].children[n].innerText:"";var s=$(".selected")[0].children[$("#commun_au_cycle")[0].cellIndex].innerText;if(s!=="oui"){var o=$(".selected")[0].children[$("#ID_URL")[0].cellIndex].innerText;supprimer_dossier(o,a);nom_champ_parent=e==="Classes"?"cycle":"classe_id";valeur_champ_parent=$(".selected")[0].children[$('[id="'+nom_champ_parent+'"]')[0].cellIndex].innerText;elements_similaires=t.filter(e=>e[nom_champ_parent]===valeur_champ_parent);est_le_dernier_dossier=elements_similaires.length===1;if(est_le_dernier_dossier){titre_parent_visible_user=e==="Classes"?"cycle":"Classe";nom_parent_visible_user=$(".selected")[0].children[$("#"+titre_parent_visible_user)[0].cellIndex].innerText;valeur_ligne_visible_user=$(".selected")[0].children[$("#"+e.slice(0,-1))[0].cellIndex].innerText;confirmation=confirm("'"+valeur_ligne_visible_user+"' était la seule "+e.slice(0,-1).toLowerCase()+" dans '"+nom_parent_visible_user+"' ("+titre_parent_visible_user+"). Voulez-vous également supprimer "+nom_parent_visible_user+" ? ("+titre_parent_visible_user+")");if(confirmation){donnees_cycle=e==="Classes"?get_resultat(racine_data+"Cycles?"+apikey+"&cycle=eq."+valeur_champ_parent):"";id_dossier_parent=e==="Classes"?donnees_cycle[0]!==undefined?donnees_cycle[0]["Ci"]:"":valeur_champ_parent;console.log("le parent à supprimer: "+id_dossier_parent);if(id_dossier_parent){supprimer_dossier(id_dossier_parent,a);nom_table_parent=e==="Classes"?"ID_RENDUS":"Classes";nom_table=nom_table_parent;nom_champ_reference=identifiant_par_table(nom_table_parent);valeur_champ_reference=valeur_champ_parent;if(nom_table_parent==="ID_RENDUS"){id_dossier_cycle=get_resultat(racine_data+"ID_RENDUS?Cycle=eq."+valeur_champ_parent+"&"+apikey)[0]["Ci"];console.log("on va supprimer le cycle: "+id_dossier_cycle);if(id_dossier_cycle)supprimer_dossier(id_dossier_cycle)}supprimer(nom_table,nom_champ_reference,valeur_champ_reference)}}}}}nom_table=e;nom_champ_reference=identifiant_par_table(e);valeur_champ_reference=r;supprimer(nom_table,nom_champ_reference,valeur_champ_reference);setTimeout(function(){actualiser_parametre();chargement(false)},1e3)}}function supprimer_dossier(e,r){var i="https://script.google.com/macros/s/AKfycbyGEGpbPE0WniCcBMbLCar_zGTNwKyABrnmfOE-zfb8TOUH4AY/exec";var e="&id_dossier="+e;var r=r?"&id_googlecalendar="+r:"";var t=i+"?suppr=true"+e+r;try{var n=get_resultat_brut(t);console.log(n)}catch(a){console.error(a);alert("Erreur survenue pendant la suppression sur le serveur: "+a)}}function telecharger_donnees_parametres(e){if(!e)e=$(".un_menu_orange")[0].id;var r='<div id="mini_popup">';r=r+'<div id="entete-fenetre" style="display: inline-flex;float: right;">';r=r+'<img alt="X" src="'+prefixe_image+'/quitter.png" id="bye_prev" onclick="$(\'#mini_popup\').remove()" style="width: 30px; height: 30px;cursor:pointer;position:fixed;z-index:3;transform: translate(-50%, -50%);"> </div>';r=r+"<div>Télécharger "+e+'</div><select style="width: 80%;" id="choix_download_param">';r=r+'<option value="En-têtes">En-têtes</option>';r=r+'<option value="Tout">Toutes les données</option></select>';r=r+'<button type="button" class="rendre" onclick="telecharger_parametre()">Télécharger</button></div>';$("#mini_popup").remove();$("body").append(r)}async function telecharger_parametre(e){if(!e)e=$(".un_menu_orange")[0].id;var r=$("#choix_download_param")[0].value==="En-têtes";var i=r?nom_des_champs(e):await rechercher_tout(e);var t=convertir_csv(i,r);var n=r?"-modele-":"";var a=e+n+maintenant_sans_caracteres_speciaux()+".csv";enregistrer_donnees_en_csv(t,a)}function enregistrer_donnees_en_csv(e,r){var i=document.createElement("a");document.body.appendChild(i);i.style="display: none";var t="\ufeff";var n=new Blob([t+e],{type:"text/csv;charset=utf-8;"});url=window.URL.createObjectURL(n);i.href=url;i.target="_blank";i.download=r;i.click();window.URL.revokeObjectURL(url);i.remove()}function importer_parametres(){$("#fichier_import").remove();var u=$(".un_menu_orange")[0].id;var c=nom_des_champs(u);var e='<input id="fichier_import" type="file" name="fichier_import" accept=".csv" style="display:none;">';$("body").append(e);$("#fichier_import").$("change",function(e){if(e.target.files[0].name.split(".").pop().trim().toLowerCase()!=="csv"){alert("Erreur: merci de choisir un fichier d'extension .csv");$("#fichier_import").remove();return 0}var _=new FileReader;_.onload=function(){var e=_.result;var r=csv_en_JSON(e);console.log(r);if(r.length===0){alert("Ce fichier .csv ne contient aucune donnée à importer.");$("#fichier_import").remove();return 0}var i="";var t=Object.keys(r[0]).some(e=>{i=e;return c.indexOf(e)<0});if(t){alert("Problème d'import: le champ '"+i+"' n'est pas reconnu dans la table '"+u+"'.");$("#fichier_import").remove();return 0}var n=Number(r.length);var a=c;var s=n>1?"s":"";confirmation=confirm("Nous avons détecté "+n+" ligne"+s+" avec "+Object.keys(r[0]).length+" champs. Voulez-vous importer ces données ?");if(confirmation){chargement(true);for(var o=0;o<r.length;o++){afficher_alerte("Progression de l'import: "+Number(100*o/r.length).toFixed(2)+"% ("+o+"/"+r.length+")");creer_formulaire_ajout_donnee_html(u,a,false,r[o]?r[o]:"");ajouter_donnees_saisies(u,o<r.length-1)}afficher_alerte("Import terminé.")}$("#fichier_import").remove()};_.readAsText(e.target.files[0])});$("#fichier_import").click()}function init_donnees(){id_parametre=$(".un_menu_orange")[0].id;if($(".selected")[0]){identifiant_a_init=$(".selected")[0].getAttribute("suppression_id");var e=confirm("Êtes-vous sûr de réinitialiser '"+identifiant_a_init+"' ? Cela remettra son mot de passe par défaut, et ignorera toute consultation de notifications.");if(!e)return-1;chargement(true);reinitialiser_unseul_mdp_datenotif(id_parametre,identifiant_a_init);setTimeout(function(){actualiser_parametre()},2e3);chargement(false)}else{var e=prompt("Êtes-vous sûr d'initialiser votre plateforme ? Cela remettra TOUS les mots de passe par défaut et ignorera toute consultation de notifications. Pour continuer, taper 'reinitialiser'.");if(e==="reinitialiser"){chargement(true);reinitialiser_mdp_datenotif();setTimeout(function(){actualiser_parametre()},2e3);chargement(false)}}}function recuperer_entetes_params(e){return nom_des_champs(e)}function creer_formulaire_ajout_donnee_html(e,r,i,t){var n='<div style="overflow:auto;" id="mini_popup"><div id="entete-fenetre" style="display: inline-flex;float: right;"><img alt="X" src="'+prefixe_image+'/quitter.png" id="bye_prev" onclick="$(\'#mini_popup\').remove()" style="width: 30px; height: 30px;cursor:pointer;position:fixed;z-index:3;transform: translate(-50%, -50%);"> </div><div>Nouvelle donnée dans '+e+'</div><form class="donnees_saisies" id="donnees_saisies" >';var a="";if(r.length>0){chargement(true);for(var s=0;s<r.length;s++){disabled=parametres_automatiques.indexOf(r[s])>=0?"disabled":"";donnee_dupliquee=i?$(".selected")?' value="'+$(".selected")[0].children[s].innerText+'" ':"":t?' value="'+(t[r[s]]?t[r[s]]:"")+'" ':"";html_du_input='<input class="donnee" '+donnee_dupliquee.replaceAll('"',"'")+' id="'+r[s]+'" name="'+r[s]+'" '+disabled+">";if(!t){if(r[s]==="Couleur_matiere"){html_du_input='<select class="donnee" id="'+r[s]+'" name="'+r[s]+'" >';for(j=0;j<liste_couleurs.length;j++){selectionner_la_donnee_dupliquee="";if($(".selected")[0])selectionner_la_donnee_dupliquee=liste_couleurs[j]===$(".selected")[0].children[s].innerText?" selected ":"";html_du_input=html_du_input+"<option "+selectionner_la_donnee_dupliquee+' value ="'+liste_couleurs[j]+'">'+liste_couleurs[j]+"</option>"}html_du_input=html_du_input+"</select>"}else if(champs_avec_listes_dynamiques.indexOf(r[s])>=0){toutes_les_matieres=get_resultat(racine_data+"Matieres"+"?"+apikey);choix_classe_dun_admin=(r[s]==="Classe"||r[s]==="classe_bis")&&$(".un_menu_orange")[0].innerText==="Administration";choix_classe_dun_prof=(r[s]==="Classe"||r[s]==="classe_bis")&&$(".un_menu_orange")[0].innerText==="Profs";nom_du_champ_clé=r[s]==="cycle"?"Cycle":r[s]==="classe_bis"||r[s]==="Classe_principale"?"Classe":choix_classe_dun_admin?"Cycle":choix_classe_dun_prof?"Classe_Matiere":r[s];valeurs_possibles=valeursUniquesDeCetteKey(toutes_les_matieres,nom_du_champ_clé);if(choix_classe_dun_admin)valeurs_possibles=valeurs_possibles.map(e=>"(Tous|"+e+")");multiple_choix_classes=choix_classe_dun_prof?"multiple":"";if(valeurs_possibles.length===0){html_du_input='<input class="donnee" '+donnee_dupliquee+' id="'+r[s]+'" name="'+r[s]+'" '+disabled+">"}else{html_du_input='<select class="donnee" id="'+r[s]+'" name="'+r[s]+'" '+multiple_choix_classes+" "+disabled+">";for(j=0;j<valeurs_possibles.length;j++){selectionner_la_donnee_dupliquee="";if($(".selected")[0])selectionner_la_donnee_dupliquee=valeurs_possibles[j]===$(".selected")[0].children[s].innerText?" selected ":"";html_du_input=html_du_input+"<option "+selectionner_la_donnee_dupliquee+' value ="'+valeurs_possibles[j]+'">'+valeurs_possibles[j]+"</option>"}html_du_input=html_du_input+'<option value="nouveau" style="font-style: oblique;" >Nouvelle valeur</option>'+"</select>"}}else if(champs_oui_ou_non.indexOf(r[s])>0){html_du_input='<select class="donnee" value="non" id="'+r[s]+'" name="'+r[s]+'" ><option value="non">non</option><option value="oui">oui</option></select>'}}var o=" style='display:"+(disabled?"none":"")+"';";a=a+'<div class="une_donnee_saisie" '+o+' id="'+r[s]+'"><label>'+r[s]+"</label>"+html_du_input+"</div>"}}var _='</form><button type="button" class="rendre" onclick="ajouter_donnees_saisies(\''+e+"')\">Ajouter</button>";_=_+'<button type="button" class="rendre" onclick="$(\'#mini_popup\').remove()">Annuler</button></div>';_=_;$("#mini_popup").remove();$("body").append(n+a+_);$("select.donnee").$("change",function(e){if(e.target.value==="nouveau"){transformer_en_simple_input(e.target.id)}});chargement(false)}function transformer_en_simple_input(e){nouvelle_valeur=prompt("Indiquez la nouvelle valeur de "+e+": ");if(nouvelle_valeur!==null){$("[id='"+e+"'].donnee")[0].outerHTML='<input class="donnee" value="'+nouvelle_valeur+'" id="'+e+'" name="'+e+'">'}else{$("[id='"+e+"'].donnee")[0].value=""}}function ajouter_donnees_saisies(e,r){nom_cycle=$(".donnee#cycle").length>0?$(".donnee#cycle")[0].value:$(".donnee#Cycle").length>0?$(".donnee#Cycle")[0].value:"";nom_classe=$(".donnee#Classe").length>0?$(".donnee#Classe")[0].value.includes("|")?"":$(".donnee#Classe")[0].value:"";nom_matiere=$(".donnee#Matiere").length>0?$(".donnee#Matiere")[0].value:"";if(e==="Classes"){var i=JSON.parse(recuperer("Classes"));if(i!==null){var t=i.some(e=>{if(e)return e["o"]===nom_classe&&e["Ai"]===nom_cycle});if(t){alert("Cette classe existe déjà dans ce cycle.");return-1}}}else if(e==="Matieres"){var n=JSON.parse(recuperer("Matieres"));if(n!==null){var a=n.some(e=>{if(e)return e["o"]===nom_classe&&e["q"]===nom_matiere+")"});if(a){alert("Cette matière existe déjà.");return-1}}}if(e==="Classes"||e==="Matieres"){if(formulaire_rempli("donnees_saisies")===false){if(plateforme_prete()===true){alert("Merci de remplir tous les champs.");return-1}}var s=nom_etablissement?"?nom_etablissement="+nom_etablissement:"";var o=nom_cycle?"&nom_cycle="+nom_cycle:"";var _=nom_classe?"&nom_classe="+nom_classe:"";var u=nom_matiere?"&nom_matiere="+nom_matiere:"";var c=$(".donnee#commun_au_cycle")[0]?"&commun_au_cycle="+$(".donnee#commun_au_cycle")[0].value:"non";id_rendu_actuel=get_resultat(racine_data+"ID_RENDUS?"+apikey+"&Cycle=eq."+nom_cycle);var l=id_rendu_actuel.length===0;var d="&initier="+l;var m="https://script.google.com/macros/s/AKfycbyGEGpbPE0WniCcBMbLCar_zGTNwKyABrnmfOE-zfb8TOUH4AY/exec";m=m+s;m=m+o;m=m+_;m=m+u;m=m+c;m=m+d;chargement(true);var f=get_resultat(m);var p=nom_classe;var v=get_valeur(f,p);var h=get_valeur(f,nom_cycle);var g=get_valeur(f,"id_googlecalendar");var b=nom_matiere;var y=get_valeur(f,b);var q=get_valeur(f,"Rendus de devoirs");if(l){nouveau_data={me:nom_cycle,Ri:q,Ci:h};post_resultat_asynchrone(racine_data+"ID_RENDUS?"+apikey,nouveau_data)}$(".donnee[id='commun_au_cycle']")[0].value=e==="Matieres"&&($(".donnee#Cycle")[0].value===$(".donnee#Matiere")[0].value||$(".donnee#Matiere")[0].value==="Vie scolaire")?"oui":"non";if(e==="Classes"){$(".donnee[id='Classe_bis']")[0].value=p;$(".donnee[id='ID_URL']")[0].value=v;$(".donnee[id='URL']")[0].value="https://drive.google.com/drive/folders/"+v;$(".donnee[id='URL_Mapping']")[0].value=v;$(".donnee[id='id_googlecalendar']")[0].value=g;$(".donnee[id='URL_agenda']")[0].value="https://calendar.google.com/calendar/embed?src="+g+"&ctz="+my_ctz()}else if(e==="Matieres"){$(".donnee[id='Classe_Matiere']")[0].value="("+p+"|"+b+")";$(".donnee[id='ID_URL']")[0].value=y;$(".donnee[id='Matiere_bis']")[0].value=b;$(".donnee[id='URL']")[0].value="https://drive.google.com/drive/folders/"+y;$(".donnee[id='URL_Mapping']")[0].value=y;$(".donnee[id='classe_id']")[0].value=v}}else if(e==="Eleves"||e==="Profs"||e==="Administration"){if(e.includes("Admin"))$(".donnee[id='Classe']")[0].value="(Tous|"+$(".donnee[id='Cycle']")[0].value+")";$(".donnee[id='Derniere_consultation_notifs']")[0].value="30/12/1899 00:00:00";$(".donnee[id='type']")[0].value=e.includes("Admin")?"Administration":e;$(".donnee[id='Droit_acces_anticipe_examen']")[0].value=e.includes("Eleves")?"non":"oui";if($(".donnee[id='Droit_changer_ecolage']")[0])$(".donnee[id='Droit_changer_ecolage']")[0].value="non";if($(".donnee[id='Droits_modifs']")[0])$(".donnee[id='Droits_modifs']")[0].value="non";$(".donnee[id='Ecolage_OK']")[0].value="oui";$(".donnee[id='code_hash']")[0].value="nok";$(".donnee[id='Reponse_sondage']")[0].value="non";$(".donnee[id='droit_hors_maintenance']")[0].value="non";$(".donnee[id='liste_notifs_lues']")[0].value=",";if($(".donnee[id='Numero_telephone']")[0])$(".donnee[id='Numero_telephone']")[0].value="123456"}var x=convertir_saisie_en_JSON("donnees_saisies",e);var O=recuperer(e)?JSON.parse(recuperer(e)).length:1;ajouter_un_element(e,JSON.parse(x),O);if(!r)actualiser_parametre(e);vider_les_input();chargement(false);return 0}function get_valeur(e,r){var i=e.findIndex(e=>e.includes(r+":"));return e[i].split(r+":")[1]}function convertir_saisie_en_JSON(e,r){var i="{";var t=$("#"+e)[0].children;r=r?r:$(".un_menu_orange")[0]?$(".un_menu_orange")[0].innerText:"";for(var n=0;n<t.length;n++){nom_champ=$("#"+e)[0].children[n].children[0].innerText;valeur_saisie=nom_champ==="Classe"&&r==="Profs"&&$("#Classe.donnee")[0].nodeName!=="INPUT"?$("#Classe.donnee").qr().join(";"):$(".donnee[id='"+nom_champ+"']")[0].value;i=i+'"'+[nom_champ]+'"'+":"+'"'+valeur_saisie+'"';virgule=n===t.length-1?"":",";i=i+virgule}i=i+"}";return i}function formulaire_rempli(e){return!Array.from($("#"+e)[0].children).some(function(e,r,i){est_actif=!$(".donnee[id='"+e.id+"']")[0].disabled;est_vide=$(".donnee[id='"+e.id+"']")[0].value==="";return est_actif&&est_vide})}function formulaire_rempli_ok(e){return!Array.from($("#"+e)[0].children).some(function(e,r,i){est_actif=!$("[name='"+e.name+"']")[0].disabled;est_vide=$("[name='"+e.name+"']")[0].value==="";return est_actif&&est_vide})}function vider_les_input(){Array.from($(".donnee.donnee")).forEach(e=>e.value="")}function afficher_bulletins(e){if(element_DOM("bulletin"))element_DOM("bulletin").style.display=e?"":"none"}function supprimer_bulle_bulletins(){if($("#bulletin")[0])$("#bulletin")[0].parentNode.remove();masquer_les_bulletins()}function masquer_les_bulletins(){$("#titre_drive_bulletins")[0].style.display="none";$("#drive_bulletins")[0].style.display="none"}function clic_bulletin(){chargement(true);if(recuperer("mon_type").includes("Administration")){if(recuperer("dossier_chargé")&&$("#accueil_utilisateur")[0].innerText.includes("Vie de classe")){afficher_ou_non_choix_fichier(true);mode_bulletin(true)}else{alert("Merci d'ouvrir un dossier Vie de classe avant de publier un bulletin.")}chargement(false)}else if(recuperer("mon_type").includes("Eleves")){choisir_periode_bulletin();chargement(false)}else{choisir_periode_et_classe_bulletin();chargement(false)}}function choisir_periode_et_classe_bulletin(){var e=valeursUniquesDeCetteKey(JSON.parse(recuperer("mes_matieres")),"Classe");var i="";e.forEach(function(e,r){i+='<option value="'+e+'">'+e+"</option>"});var r=`<div><label for="periode_bulletin"><select style="width: 60%;" id="periode_bulletin" name="periode_bulletin"><option value="PREMIER TRIMESTRE">PREMIER TRIMESTRE</option><option value="DEUXIEME TRIMESTRE">DEUXIEME TRIMESTRE</option><option value="TROISIEME TRIMESTRE">TROISIEME TRIMESTRE</option><option value="ANNUEL">ANNUEL</option></select></label>
		<label for="la_classe"><select style="width: 60%;" id="la_classe_bulletin" name="la_classe">`+i+`</select></label></div>`;creer_mini_popup("Choisissez la période et la classe du bulletin à consulter:",r,"Consulter","consulter_bulletin_de_la_classe()")}function id_vie_de_classe(e){url=racine_data+"Matieres?Classe=eq."+e+"&Matiere=eq.Vie de classe"+"&"+apikey;resultat=get_resultat(url);if(resultat)resultat=resultat[0]["Je"];return resultat}function consulter_bulletin_de_la_classe(){chargement(true);periode_bulletin=$("#periode_bulletin")[0].value;nom_classe=$("#la_classe_bulletin")[0].value;id_classe=id_vie_de_classe(nom_classe);url=racine_data+"Fichiers?categorie_fichier=eq.Bulletins&periode_bulletin=eq."+periode_bulletin+"&id_dossier=eq."+id_classe+"&"+apikey;resultat_bulletins=get_resultat(url);if(resultat_bulletins.length===0){alert("Aucun bulletin disponible sur la période '"+periode_bulletin.toLowerCase()+"' pour la classe de '"+nom_classe+"' pour l'instant.");chargement(false)}else{resultat_bulletins=resultat_bulletins[0];console.log(resultat_bulletins);visualiser(resultat_bulletins["P"],resultat_bulletins["V"],"","",true);$("#mini_popup").remove();chargement(false)}return"Consultation terminée.";chargement(false)}function choisir_periode_bulletin(){var e='<label for="periode_bulletin"><select style="width: 60%;" id="periode_bulletin" name="periode_bulletin"><option value="PREMIER TRIMESTRE">PREMIER TRIMESTRE</option><option value="DEUXIEME TRIMESTRE">DEUXIEME TRIMESTRE</option><option value="TROISIEME TRIMESTRE">TROISIEME TRIMESTRE</option><option value="ANNUEL">ANNUEL</option></select></label>';creer_mini_popup("Choisissez la période du bulletin à consulter:",e,"Consulter","consulter()")}function consulter(){chargement(true);consulter_mon_bulletin(recuperer("identifiant_courant"));chargement(false)}function choisir_clic_bulletin(){popup_choix='<div id="mini_popup"><div id="entete-fenetre" style="display: inline-flex;float: right;"><img alt="X" src="'+prefixe_image+'/quitter.png" id="bye_prev" onclick="$(\'#mini_popup\').remove()" style="width: 30px; height: 30px;cursor:pointer;position:fixed;z-index:3;transform: translate(-50%, -50%);"> </div><div>Que voulez-vous faire?</div><select style="width: 80%;" id="choix_bulletin"><option value="upload">Mettre en ligne les bulletins</option><option value="voir">Voir les bulletins en ligne</option></select><button type="button" class="rendre" onclick="choix_bulletin_ok()">Valider</button></div>';$("body").append(popup_choix)}function choix_bulletin_ok(){if($("#choix_bulletin")[0].value==="upload"){afficher_ou_non_choix_fichier(true);mode_bulletin(true)}else if($("#choix_bulletin")[0].value==="voir"){consulter_mon_bulletin()}$("#mini_popup").remove()}function consulter_mon_bulletin(e){motif='*"'+e+'"*';if(!e)motif="*";periode_bulletin=$("#periode_bulletin")[0].value;url=racine_data+"Fichiers?categorie_fichier=eq.Bulletins&periode_bulletin=eq."+periode_bulletin+"&destinataire_par_page=like."+motif+"&"+apikey;resultat_bulletins=get_resultat(url);if(resultat_bulletins.length===0){alert("Aucun bulletin disponible à votre nom sur la période '"+periode_bulletin.toLowerCase()+"' pour l'instant.");chargement(false)}else{for(numero_bulletin=0;numero_bulletin<resultat_bulletins.length;numero_bulletin++){id_fichier_bulletin=resultat_bulletins[numero_bulletin]["V"];mon_numero_page=Number(JSON.parse(resultat_bulletins[numero_bulletin]["He"])[e]);if(e){afficher_mon_bulletin(id_fichier_bulletin,mon_numero_page,e)}else{afficher_mon_bulletin(id_fichier_bulletin,1)}}$("#mini_popup").remove()}return"Consultation terminée."}function mode_bulletin(e){if(e){$("#categorie_choisie")[0].value="Bulletins";element_DOM("categorie_choisie").disabled=true;element_DOM("choix_youtube").style.display="none";element_DOM("choix_extrait_manuel").style.display="none";element_DOM("choix_date_effet").style.display="none";element_DOM("telechargeable").style.display="none";element_DOM("est_telechargeable").checked=false;element_DOM("file").setAttribute("accept","application/pdf");element_DOM("choix_popup").setAttribute("style","visibility: visible;overflow-y: scroll;width: 450px;max-width: 95%;overflow-x: hidden;");element_DOM("file").value="";$("[value='Bulletins']")[0].style.display=""}else{$("#attribution").remove();$("#trimestre").remove();element_DOM("categorie_choisie").disabled=false;element_DOM("choix_youtube").style.display="";element_DOM("choix_extrait_manuel").style.display="";element_DOM("choix_date_effet").style.display="";element_DOM("telechargeable").style.display="";element_DOM("est_telechargeable").checked=true;element_DOM("file").setAttribute("accept",".txt,.bmp,.gif,.jpeg,.jpg,.png,.png,.pdf,.bmp,.xlsx,.xls,.xlsm,.ppt,.pptx,.doc,.docx,.html,.csv,.js,.rtf,.mp4,.mp3,.wav");element_DOM("choix_popup").setAttribute("style","visibility: visible");$("[value='Bulletins']")[0].style.display="none";$("#categorie_choisie > [value='Manuels']")[0].style.display=!recuperer("mon_type").includes("Administration")?"none":""}}function afficher_mon_bulletin(e,r,i){var t="https://www.googleapis.com/drive/v2/files/"+e+"?key="+google_api_file_access+"&alt=media&source=downloadUrl";PDFJS.nr(t).then(function(e){visualiser("nom_fichier","","","Bulletin "+i||" ",true,true);e.Ti(r).then(function s(e){var r=2.5;var i=e.getViewport(r);var t=document.getElementById("vizcanva");var n=t.getContext("2d");t.height=i.height;t.width=i.width;$("#vizcanva").$("contextmenu",function(e){return false});var a=e.Pi({Ji:n,viewport:i});a.promise.then(function(){element_DOM("previsualisation").setAttribute("style","overflow: scroll;height:60%");chargement(false)})["catch"](e=>console.error(e))})})}function mon_ecolage_est_ok(){if(recuperer("mon_type").includes("Eleves")){identifiant_eleve=recuperer("identifiant_courant");url=racine_data+"Eleves"+"?Identifiant=eq."+identifiant_eleve+"&"+apikey;try{return get_resultat(url)[0]["Ae"]==="oui"}catch(e){return false}}else{return true}}function telecharger_canvas(){mon_ecolage_ok=mon_ecolage_est_ok();if(mon_ecolage_ok){var e=document.createElement("a");e.download="Bulletin-"+identifiant_eleve+".png";e.href=document.getElementById("vizcanva").toDataURL();e.click();e.remove()}else{alert("Vous devez régulariser vos frais de scolarité pour accéder à votre bulletin complet.")}}a_stocker=recuperer("a_stocker")?JSON.parse(recuperer("a_stocker")):{};function plateforme_prete(){return get_resultat(racine_initiale+"/Etablissements?nom_etablissement=eq."+nom_etablissement+"&"+api_initial)[0]["Ui"]}function initialisation_de_la_plateforme(){vider_fenetre(progression_initialisation());$("#bye_prev").remove();$("#barre_verticale").remove();$("#mynavbar").remove();$("#span_date_effet").remove();afficher_fenetre(true);contenu="Bonjour <span style='font-weight: bold;color: #FF6C00;'> "+recuperer("identifiant_courant").toUpperCase()+"</span>, et bienvenue sur la plateforme de télé-enseignement Sekooly!<br><br>";contenu+="Pour mettre en route la plateforme de l'établissement <b>"+nom_etablissement.toUpperCase()+"</b>, nous aurons besoin de quelques informations supplémentaires.<br><br><rouge>Toutes les informations que vous allez saisir seront modifiables plus tard.</rouge><br>";bouton="<button onclick='suivant()' id='bouton_suivant' class='mon_bouton' style='height: 50px;font-size: inherit;'>C'est parti!</button>";conteneur_texte_html='<div class="init" style="overflow: hidden auto;height: 90%;padding: 2%;text-align: center;font-size: 150%;"><div id="contenu_etape">'+contenu+"</div>"+bouton+"</div>";conteneur_texte=document.createElement("div");conteneur_texte.innerHTML=conteneur_texte_html;$("#fenetre")[0].appendChild(conteneur_texte.firstChild);if(numero_etape>0){suivant()}else{chargement(false)}}function suivant(){if(enregistrer_la_saisie()){numero_etape=numero_etape+1;if(numero_etape<nb_etapes){resultat=get_resultat(racine_initiale+"Etapes?id=eq."+numero_etape+"&"+api_initial)[0];changer_contenu_etape(resultat["Vi"]);changer_texte_bouton(resultat["Li"]);$("#titre_fenetre")[0].innerHTML=progression_initialisation()}else{chargement(true);changer_contenu_etape("Merci de patienter sans actualiser l'onglet, nous créons vos données!");$("#bouton_suivant").remove();$("#titre_fenetre")[0].innerHTML=progression_initialisation();proceder_a_linitialisation()}}else{alert("Vous devez saisir l'information pour continuer.")}chargement(false)}function proceder_a_linitialisation(){a_stocker=JSON.parse(recuperer("a_stocker"));var e={ve:a_stocker["ve"],he:a_stocker["he"],me:a_stocker["me"],o:"(Tous|"+a_stocker["me"]+")"};url=racine_data+"Administration?Identifiant=eq."+recuperer("identifiant_courant")+"&"+apikey;patch_resultat_asynchrone(url,e);chargement(true);var e={me:a_stocker["me"],o:"(Tous|"+a_stocker["me"]+")"};url=racine_data+"Administration?Identifiant=eq.admin&"+apikey;patch_resultat_asynchrone(url,e);chargement(true);nouvelle_classe={o:a_stocker["o"],me:a_stocker["me"],Ai:a_stocker["me"]};try{creer_formulaire_ajout_donnee_html("Classes",recuperer_entetes_params("Classes"),false,nouvelle_classe);$("#mini_popup")[0].style.display="none";ajouter_donnees_saisies("Classes",true)}catch(r){console.error(r);alert(r)}chargement(true);nouvelle_matiere={o:a_stocker["o"],me:a_stocker["me"],Ai:a_stocker["me"],q:a_stocker["q"],Fi:a_stocker["Fi"],Ue:"noir",Ki:"non"};try{creer_formulaire_ajout_donnee_html("Matieres",recuperer_entetes_params("Matieres"),false,nouvelle_matiere);$("#mini_popup")[0].style.display="none";ajouter_donnees_saisies("Matieres",true)}catch(r){console.error(r);alert(r)}chargement(true);nouveau_prof={fe:a_stocker["Yi"],pe:a_stocker["Bi"],u:a_stocker["Yi"].trim().toLowerCase()+"."+a_stocker["Bi"].trim().toLowerCase(),ge:"123456",me:a_stocker["me"],o:"("+a_stocker["o"]+"|"+a_stocker["q"]+")",Hi:a_stocker["Yi"]+" "+a_stocker["Bi"]};ajouter_un_element("Profs",nouveau_prof);chargement(true);nouveau_eleve={fe:a_stocker["fe"],pe:a_stocker["pe"],u:a_stocker["fe"].trim().toLowerCase()+"."+a_stocker["pe"].trim().toLowerCase(),ge:a_stocker["ge"],me:a_stocker["me"],o:a_stocker["o"]};ajouter_un_element("Eleves",nouveau_eleve);chargement(true);rechercher("Matieres","Cycle",a_stocker["me"]).then(e=>{stocker("mes_matieres",JSON.stringify(e))});rechercher("Administration","Identifiant",recuperer("identifiant_courant")).then(e=>{stocker("mes_donnees",JSON.stringify(e[0]))});e={Ui:true,xi:moment().format("DD/MM/YYYY")};patch_resultat_asynchrone(racine_initiale+"Etablissements?nom_etablissement=eq."+nom_etablissement+"&"+api_initial,e).then(function(e){console.log(e);var r=element_DOM("snackbar");r.innerText="Votre plateforme est prête.";r.className="show";setTimeout(function(){r.className="";window.location.href=window.location.href},3e3)})}function enregistrer_la_saisie(){if(numero_etape>0){tout_est_ok=$("#contenu_etape :input")[0]?$("#contenu_etape :input")[0].value.trim()!=="":true;if(tout_est_ok&&$("#contenu_etape :input")[0]){for(i=0;i<$("#contenu_etape :input").length;i++){id=$("#contenu_etape :input")[i].id;a_stocker[id]=$("#contenu_etape :input")[i].value.trim()}stocker("a_stocker",JSON.stringify(a_stocker));stocker("numero_etape",numero_etape)}}else{tout_est_ok=true}return tout_est_ok}function progression_initialisation(){reinit_init=numero_etape>0?'<img id="reset_param" onclick="reinitialiser_init()" alt="Recommencer" src="'+prefixe_image+'/img_reset.png" class="icone_param">':"";return'Bienvenue sur Sekooly <i><progress style="width: 60px;" value="'+numero_etape+'" max="'+nb_etapes+'"></progress>'+numero_etape+"/"+nb_etapes+"</i>"+reinit_init}function changer_contenu_etape(e){$("#contenu_etape")[0].innerHTML=e}function changer_texte_bouton(e){$("#bouton_suivant")[0].innerText=e}function reinitialiser_init(){confirmation=confirm("Êtes-vous sûr de réinitialiser toutes vos saisies et de revenir à l'étape 0 ?");if(confirmation){effacer("numero_etape");effacer("a_stocker");window.location.href=window.location.href}}function rendre_riche(e,r){ClassicEditor.create(document.querySelector('[id="'+e+'"]'),config_editor()).then(e=>{if(r){}})["catch"](e=>{console.error(e)})}function recuperer_html_saisie_riche(){return $("[contenteditable]")[0].innerHTML}function switch_side_bar(){ouvert=$(".sidebar.left")[0].isOpen;if(ouvert){fermer_side_bar()}else{ouvrir_side_bar()}}function switch_side_bar_top(){ouvert=$(".sidebar.top")[0].isOpen;if(ouvert){fermer_side_bar()}else{ouvrir_side_bar_top()}}function ouvrir_side_bar(){$(".sidebar.left")[0].style.display="block";$(".sidebar.left")[0].isOpen=true;$(".sidebar.left").Qi("sidebar:open")}function ouvrir_side_bar_top(){$(".sidebar.top")[0].style.display="block";$(".sidebar.top")[0].isOpen=true;$(".sidebar.top").Qi("sidebar:open")}function fermer_side_bar(){$(".sidebar.left")[0].style.display="none";$(".sidebar.left")[0].isOpen=false;$(".sidebar.left").Qi("sidebar:close");$(".sidebar.top")[0].style.display="none";$(".sidebar.top")[0].isOpen=false;$(".sidebar.top").Qi("sidebar:close")}function fermer_si_non_recherche(e){if(e.target.id!=="rechercher")fermer_side_bar()}function en_cours(){alert("Cette fonctionnalité est en cours de mise en place, merci de votre patience.")}function edt(){mon_type=recuperer("mon_type");if(mon_type==="Eleves"){recuperer_edt()}else{if(recuperer("dossier_chargé")||mon_type.includes("bis")){recuperer_edt()}else{choix_classe_edt()}}}function choix_classe_edt(){les_matieres=JSON.parse(recuperer("mes_matieres"));les_classes=valeursUniquesDeCetteKey(les_matieres,"Classe");les_classes.sort();elements_html="Classe:<select id='classe_edt'>";for(i=0;i<les_classes.length;i++){elements_html+='<option value="'+les_classes[i]+'">'+les_classes[i]+"</option>"}elements_html+="</select>";creer_mini_popup("Choisissez la classe à consulter",elements_html,"Voir l'emploi du temps","voir_edt_classe_choisie()");var e=JSON.parse(recuperer("mes_donnees"))["Pe"];if(recuperer("mon_type").includes("Admin")&&e==="oui"){$("#ask_edt").remove();$("#mini_popup").append('<div id="ask_edt">'+bouton_demander()+"</div></div>")}}function bouton_demander(){return data_etablissement["Xi"]?edt_deja_envoye():'<button id="bouton_ask_edt" onclick="demander_edt()" class="demander_edt">Demander l\'édition des emplois du temps</button>'}async function demander_edt(){if(!data_etablissement["Xi"]){var e=await rechercher_tout("Classes");liste_classes=e.map(e=>e["Ai"]+" "+e["o"]);liste_id_calendar=e.map(e=>e["$r"]);var r=await chercher_lien_script(1);r+="?ask_edt=true";r+="&nom_prenom_responsable="+data_etablissement["mi"];r+="&liste_classes="+JSON.stringify(liste_classes);r+="&liste_id_calendar="+JSON.stringify(liste_id_calendar);r+="&contact_etablissement="+data_etablissement["dr"];r+="&nom_etablissement="+data_etablissement["i"];envoyer_mail=get_resultat_asynchrone(r);data_etablissement["Xi"]=true;$("#ask_edt")[0].innerHTML=edt_deja_envoye()}else{$("#ask_edt")[0].innerHTML=edt_deja_envoye()}}function edt_deja_envoye(){return"<vert>✔La liste des liens pour éditer les emplois du temps a été envoyée par mail (<b>"+data_etablissement["dr"]+"</b>).</vert><br><br><i>Si vous n'avez plus accès à cette adresse mail, merci de mettre à jour l'adresse mail de votre établissement dans <b>Paramètres > Infos établissement > Contact de l'Administration</b>, puis re-demandez à nouveau ici votre liste.</i>"}function voir_edt_classe_choisie(){recuperer_edt($("#classe_edt")[0].value);$("#mini_popup")[0].style.zIndex=2}function ma_journee(){vider_fenetre("Ma journée");var e=recuperer("mon_type")==="Eleves";var r=e?section_journee("Fichiers"):"";var r=section_journee("Fichiers","Les fichiers affichés ont pour <b>date d'effet</b> (donc de consultation) la date de la journée choisie.");r+=section_journee("Devoirs","Les devoirs affichés ont pour <b>date limite de rendu</b> la date de la journée choisie.");r+=section_journee("Discussions","Les discussions affichées ont pour <b>date de publication</b> la date de la journée choisie.");var i='<div id="menu_journee_haut" style="text-align: center;" class="menu_haut">Date de la journée: <input type="date" id="date_journee" class="date_effet_fichier"></div><div class="section_journee">'+r+"</div>";$("#menu_journee_haut").remove();$(".section_journee").remove();$("#fenetre").append(i);$("#date_journee").$("change",maj_date_journee);$("#date_journee")[0].value=moment().format("YYYY-MM-DD");maj_date_journee();afficher_fenetre(true)}function section_journee(e,r){return'<div id="section_'+e+'" class="titre_section_journee bloc_topic"><span style="font-size: x-large;padding: 5px;">'+e+'<div class="subtitle">'+r+"</div></span></div>"}function maj_date_journee(){if($("#date_journee")[0].value==="")$("#date_journee")[0].value=moment().format("YYYY-MM-DD");chargement(true);$(".alerte_section_journee").remove();$(".contenu_section_journee").remove();mes_matieres=JSON.parse(recuperer("mes_matieres"));if(!recuperer("mon_type").includes("Admin")){les_id_dossier_classe='("'+mes_matieres.map(e=>e["Je"]).join('","')+'")';url=racine_data+"Fichiers?"+apikey;url+="&categorie_fichier=neq.Devoirs";url+="&categorie_fichier=neq.Examens";url+="&date_effet=eq."+$("#date_journee")[0].value;url+="&id_dossier=in."+les_id_dossier_classe}else{url=racine_data+"Fichiers?"+apikey;url+="&categorie_fichier=neq.Devoirs";url+="&categorie_fichier=neq.Examens";url+="&date_effet=eq."+$("#date_journee")[0].value}url+="&order=date_effet.asc,heure_effet.asc,id_dossier.asc";resultats=get_resultat(url);traiter_section(mes_matieres,"Fichiers",resultats,"date_effet","heure_effet","id_dossier","nom_fichier","id_fichier","fichier");if(!recuperer("mon_type").includes("Admin")){les_id_dossier_classe='("'+mes_matieres.map(e=>e["Je"]).join('","')+'")';url=racine_data+"Fichiers?"+apikey;url+='&categorie_fichier=in.("Devoirs","Examens")';url+="&la_date_limite=eq."+$("#date_journee")[0].value;url+="&id_dossier=in."+les_id_dossier_classe}else{url=racine_data+"Fichiers?"+apikey;url+='&categorie_fichier=in.("Devoirs","Examens")';url+="&la_date_limite=eq."+$("#date_journee")[0].value}url+="&order=la_date_limite.asc,lheure_limite.asc,id_dossier.asc";resultats=get_resultat(url);traiter_section(mes_matieres,"Devoirs",resultats,"la_date_limite","lheure_limite","id_dossier","nom_fichier","id_fichier","devoir",true);if(!recuperer("mon_type").includes("Admin")){url=racine_data+"Topic?"+apikey;url+="&Horodateur=like."+$("#date_journee")[0].value+"*";url+="&Id_classe_matiere=in."+les_id_dossier_classe}else{url=racine_data+"Topic?"+apikey;url+="&Horodateur=like."+$("#date_journee")[0].value+"*"}url+="&order=Horodateur.asc";resultats=get_resultat(url);traiter_section(mes_matieres,"Discussions",resultats,"Horodateur","Horodateur","Id_classe_matiere","Titre","Id_topic","discussion",false,true);chargement(false)}function traiter_section(r,e,i,t,n,a,s,o,_,u,c){if(i.length===0){$("#section_"+e).append(aucun_element_section())}else{$("#section_"+e).innerHTML="";if(recuperer("mon_type").includes("Admin")){i=i.filter(e=>JSON.stringify(r).includes(e[a]))}for(var l=0;l<i.length;l++){id_classe_matiere=i[l][a];if(id_classe_matiere!=="pp"){nom_classe=r.filter(e=>e["Je"]===id_classe_matiere)[0]["o"];nom_matiere=r.filter(e=>e["Je"]===id_classe_matiere)[0]["q"];nom_fichier=i[l][s];if(!recuperer("mon_type").includes("Eleves"))nom_matiere=nom_classe+" - "+nom_matiere;date_reference=i[l][t];heure_reference=i[l][n];if(date_reference===heure_reference&&date_reference.length>0){if(!c){date_reference=date_reference.split(" ")[0];heure_reference=heure_reference.split(" ")[1].split(".")[0]}}champ_id=i[l][o];if(u){deja_rendu=false;deja_corrigé=false;if(recuperer("mon_type")==="Eleves"){url=racine_data+"Rendus?proprietaire=eq."+recuperer("identifiant_courant").toLowerCase();url+="&id_fichier_sujetdevoir=eq."+champ_id;url+="&"+apikey;deja_rendu=get_resultat(url).length>0}else if(recuperer("mon_type")==="Profs"||recuperer("mon_type").includes("Admin")){url=racine_data+"Rendus?id_fichier_sujetdevoir=eq."+champ_id;url+="&"+apikey;rendus_recus=get_resultat(url);nb_corrigés=rendus_recus.filter(e=>e["J"]!=="").length;deja_corrigé=rendus_recus.length>0?'<progress style="width: 60px;" value="'+nb_corrigés+'" max="'+rendus_recus.length+'"></progress> <b><rouge>'+nb_corrigés+"/"+rendus_recus.length+"</rouge></b>":false}dejà_traité=deja_rendu||deja_corrigé}else{dejà_traité=false}element_journee=creer_element_journee(nom_matiere,nom_fichier,date_reference,heure_reference,champ_id,id_classe_matiere,_,dejà_traité,u,c);$("#section_"+e).append(element_journee)}}}ordonner_elements(".contenu_section_journee","innerText")}function creer_element_journee(e,r,i,t,n,a,s,o,_,u){if(t){t=" à "+t}else{t=""}if(recuperer("mon_type").includes("Eleves")){coche_traitement=o?'✅<i style="color: green;">Rendu</i>':_?"❌<i><rouge>Pas encore rendu</rouge></i>":""}else{coche_traitement=o?o:""}affichage_date=u?afficher_date(i):afficher_date(i,true)+t;return'<div class="contenu_section_journee"><b class="nom_matiere_journee">'+e+"</b> "+r+'<i style="color: #bfbfbf;"> '+affichage_date+' </i><span class="mini-image deja_traite">'+coche_traitement+'</span> <img id="'+n+'" src="'+prefixe_image+'/img_previz.png" alt="voir" onclick="clic_de_notif(\''+s+"','"+n+"','"+a+'\');" class="mini-image"></div>'}function aucun_element_section(){return'<div class="alerte_section_journee">Aucun élément n\'a été trouvé pour la date choisie.</div>'}function mettre_les_soons(){if($("#soon").length===0){$("[soon]").append(soon())}}function soon(){return'<rouge id="soon">BIENTÔT</rouge>'}function tableau_de_bord(){var e=maintenant();vider_fenetre('<span id="titre-tdb">Tableau de bord - '+afficher_date(e)+"</span>"+bouton_actualiser("tdb_tout_actualiser()",20));$("#fenetre").append('<div id="previsualisation" style="width: 100%;height: 85%;overflow-y:auto;text-align: center;"></div>');var r=recuperer("mon_type").split("_")[0];elements_tdb=r==="Eleves"?["Présence sur la plateforme","Devoirs rendus","Participations","Fichiers à consulter"]:r==="Profs"?["Présence sur la plateforme","Devoirs corrigés","Participations","Fichiers en ligne"]:r.includes("Admin")?["Présence sur la plateforme","Devoirs rendus et corrigés","Participations","Fichiers en ligne"]:[];for(compteur=1;compteur<=elements_tdb.length;compteur++){bouton_voir_details=compteur!==1?bouton_details(compteur):"";$("#previsualisation").append("<span class='element_tdb'><div class='element_tdb_titre'>"+elements_tdb[compteur-1]+bouton_actualiser(fonction_actualiser_du_tdb(compteur,e),15)+bouton_voir_details+"</div><div id='tdb-"+compteur+"' class='graphe_tdb'  style='width:99.9%; height:94%;'></div></span>")}tdb_tout_actualiser(e);afficher_fenetre(true)}function fonction_actualiser_du_tdb(e,r){resultat=e===1?"tdb_recuperer_mes_connexions(false,'"+r+"')":e===2?"tdb_recuperer_devoirs(false,'"+r+"')":e===3?"tdb_recuperer_participations(false,'"+r+"')":e===4?"tdb_recuperer_fichiers_a_consulter(false,'"+r+"')":"";return resultat}function bouton_details(e){return'<span style="padding-left: 10px;"><span onclick="details_tdb_'+e+'(this)" style="width: 15px; cursor: pointer;" class="voir_tdb">Voir les détails</span></span>'}function bouton_actualiser(e,r){return'<span style="padding-left: 10px;"><img alt="actualiser" src="'+prefixe_image+'/img_actualiser.png" onclick="'+e+'" style="width: '+r+'px; cursor: pointer;"></span>'}function tdb_tout_actualiser(){chargement(true);$("#titre-tdb")[0].innerText="Tableau de bord - "+afficher_date(maintenant());aujourdhui=maintenant();tdb_recuperer_mes_connexions(true,aujourdhui);tdb_recuperer_devoirs(true,aujourdhui);tdb_recuperer_participations(true,aujourdhui);tdb_recuperer_fichiers_a_consulter(true,aujourdhui);chargement(false)}function tdb_recuperer_mes_connexions(e,r){const i=document.getElementById("tdb-1");i.innerHTML="";var t=["Connexion","Deconnexion","Code","La","Frais"];var n=["Connexion","Deconnexion","Code erroné","Maintenance","Frais non payés"];var a=[];var s=racine_data+"Logs?Identifiant=eq."+recuperer("identifiant_courant")+"&"+apikey;var o=get_resultat(s);les_12_mois=les_12_derniers_mois_en_intervalles_semaines(r);var _=les_12_mois.map(e=>"semaine du "+e.split(" ")[0]);t.forEach(function(i,e){les_12_mois.forEach(function(e,r){debut=moment(e.split(" ")[0]);fin=moment(e.split(" ")[1]);logs_avec_ce_statut=o.filter(e=>e["Re"].split(" ")[0]===i&&moment(e["ae"]).Wi(debut,fin,"day","(]"));a.push({[i]:{[e]:logs_avec_ce_statut.length}})})});mes_series_finales=[];t.forEach(function(r,e){mes_series_finales.push({name:n[e],data:a.filter(e=>e[r]).map(e=>e[r]).map(e=>Object.values(e)[0]),Gi:true})});creer_chart(1,mes_series_finales,_,"Evolution des tentatives de connexions");return mes_series_finales;if(!e)chargement(false)}function tdb_recuperer_devoirs(e,r){document.getElementById("tdb-2").innerHTML="";t=JSON.parse(recuperer("mes_matieres"));les_id_dossier_classe='("'+t.map(e=>e["Je"]).join('","')+'")';if(!recuperer("mon_type").includes("Admin")){s=racine_data+"Fichiers?"+apikey;s+="&categorie_fichier=in.(Devoirs,Examens,Quiz)";s+="&id_dossier=in."+les_id_dossier_classe}else{s=racine_data+"Fichiers?"+apikey;s+="&categorie_fichier=in.(Devoirs,Examens,Quiz)"}s+="&order=date_effet.asc,heure_effet.asc,id_dossier.asc";mes_devoirs_a_faire=get_resultat(s);mes_devoirs_a_faire=mes_devoirs_a_faire.filter(e=>les_id_dossier_classe.includes(e["ke"]));mon_type=recuperer("mon_type");le_proprietaire=mon_type.includes("Admin")||mon_type.includes("Prof")?"":"proprietaire=eq."+recuperer("identifiant_courant");le_titre_moyen=mon_type.includes("Admin")||mon_type.includes("Prof")?"moyen":"";details_rendus=mon_type.includes("Admin")||mon_type.includes("Prof")?"":mes_devoirs_rendus.length+" devoirs rendus sur "+mes_devoirs_a_faire.length;s=racine_data+"Rendus?"+le_proprietaire+"&"+apikey;mes_devoirs_rendus=get_resultat(s);mes_devoirs_rendus=mes_devoirs_rendus.filter(function(e){return les_id_dossier_classe.includes(e["re"])&&e["L"]!==null});var i=0;if(mon_type.includes("Eleves")){i=100*mes_devoirs_rendus.length/mes_devoirs_a_faire.length}else{var t=JSON.parse(recuperer("mes_matieres"));var n=valeursUniquesDeCetteKey(t,"Classe");var a=JSON.parse(recuperer("mes_donnees"))["me"];var s=racine_data+"Eleves?Cycle=eq."+a+"&"+apikey;tous_les_eleves_de_mon_cycle=get_resultat(s);var o=tous_les_eleves_de_mon_cycle.length;nb_total_rendus_attendus=0;var _=[];mes_devoirs_a_faire.forEach(function(r,e){nom_classe_du_devoir=t.find(e=>e["Je"]===r["ke"])["o"];o=tous_les_eleves_de_mon_cycle.filter(e=>e["o"]===nom_classe_du_devoir).length;nb_rendus_ce_devoir=mes_devoirs_rendus.filter(e=>e["U"]===r["V"]).length;taux_actuel=100*nb_rendus_ce_devoir/o;if(!taux_actuel)taux_actuel=0;nb_total_rendus_attendus+=o;_.push(taux_actuel)});i=_.length>0?_.reduce((e,r)=>e+r)/_.length:0;details_rendus=mes_devoirs_rendus.length+" rendus sur "+nb_total_rendus_attendus+" attendus"}mes_series=[{name:"Taux de rendu",data:[i]}];creer_chart(2,mes_series,null,"Taux de rendu "+le_titre_moyen+" ("+parseFloat(i.toFixed(2))+"%) "+details_rendus);if(!e)chargement(false)}function details_tdb_2(e){elements_html="";var i="";mes_devoirs_a_faire.forEach(function(r,e){if(recuperer("mon_type")==="Eleves"){dejà_traité=mes_devoirs_rendus.filter(e=>e["U"]===r["V"]).length>0;nom_classe_du_devoir="";i="Devoirs à faire"}else{nb_corrigés=mes_devoirs_rendus.filter(e=>e["U"]===r["V"]&&e["J"]).length;nb_rendus=mes_devoirs_rendus.filter(e=>e["U"]===r["V"]).length;mes_matieres=JSON.parse(recuperer("mes_matieres"));nom_classe_du_devoir=mes_matieres.find(e=>e["Je"]===r["ke"])["o"]+" ";nb_eleves=tous_les_eleves_de_mon_cycle.filter(e=>e["o"]===nom_classe_du_devoir.trim()).length;dejà_traité=mes_devoirs_rendus.length>0?'<progress style="width: 60px;" value="'+nb_corrigés+'" max="'+nb_rendus+'"></progress> <b><rouge>'+nb_corrigés+" corrigés sur "+nb_rendus+" rendus, sur "+nb_eleves+" élèves</rouge></b>":false;nom_classe_du_devoir=nom_classe_du_devoir+" ";i="Devoirs à faire et corriger"}nom_matiere=nom_classe_du_devoir+JSON.parse(recuperer("mes_matieres")).filter(e=>e["Je"]===r["ke"])[0]["q"];elements_html=elements_html+creer_element_journee(nom_matiere,r["P"],r["Fe"],r["Ke"],r["V"],r["ke"],"devoir",dejà_traité,true)});if(!i)i="Devoirs à faire";creer_mini_popup(i,elements_html,"    OK    ","$('#mini_popup').remove();",null,null,null,null,25);$("#mini_popup")[0].style.overflow="auto"}function tdb_recuperer_participations(e,r){document.getElementById("tdb-3").innerHTML="";url=racine_data+"Topic?Identifiant=eq."+recuperer("identifiant_courant")+"&"+apikey;mes_discussions=get_resultat(url);url=racine_data+"Coms?Identifiant=eq."+recuperer("identifiant_courant")+"&"+apikey;mes_coms=get_resultat(url);url=racine_data+"Visio?Statut=eq.debut&Identifiant=eq."+recuperer("identifiant_courant")+"&"+apikey;mes_visios=get_resultat(url);var i=["Discussions créées","Commentaires envoyées","Clics sur visioconférence"];var t=[{name:"Nombre total",data:[mes_discussions.length,mes_coms.length,mes_visios.length]}];creer_chart(3,t,i,"Total des intéractions");if(!e)chargement(false)}function details_tdb_3(e){var i="";var t=JSON.parse(recuperer("mes_matieres"));i+='<br><br><b><div style="background: #bf8a6a;"> MES DISCUSSIONS </div></b><br>';mes_discussions.forEach(function(r,e){la_matiere=t.find(e=>e["Je"]===r["de"]);nom_matiere=la_matiere?la_matiere["o"]+" "+la_matiere["q"]:"Matière inconnue";i+=creer_element_journee(nom_matiere,r["br"],r["ae"],r["ae"],r["mr"],r["de"],"discussion",false,false,true)});i+='<br><br><b><div style="background: #bf8a6a;"> MES COMMENTAIRES </div></b><br>';liste_id_topics="("+mes_coms.map(e=>e["mr"]).join(",")+")";url=racine_data+"Topic?Id_topic=in."+liste_id_topics+"&order=Horodateur.asc"+"&"+apikey;liste_id_classe_matieres_des_coms=get_resultat(url);mes_coms.forEach(function(r,e){le_topic_source=liste_id_classe_matieres_des_coms.find(e=>e["mr"]===r["mr"]);id_classe_matiere=le_topic_source["de"];la_matiere=t.find(e=>e["Je"]===id_classe_matiere);nom_matiere=la_matiere?la_matiere["o"]+" "+la_matiere["q"]:"Matière inconnue";i+=creer_element_journee(nom_matiere,r["pr"],r["ae"],r["ae"],r["mr"],id_classe_matiere,"discussion",false,false,true)});creer_mini_popup("Discussions et commentaires",i,"    OK    ","$('#mini_popup').remove();",null,null,null,null,25);$("#mini_popup")[0].style.overflow="auto"}async function tdb_recuperer_fichiers_a_consulter(e,r){document.getElementById("tdb-4").innerHTML="";mes_fichiers=await recuperer_mes_fichiers(true);mes_series=[];categories_de_fichiers=valeursUniquesDeCetteKey(mes_fichiers,"categorie_fichier");categories_de_fichiers.forEach(function(r,e){part_de_la_categ=mes_fichiers.filter(e=>e["De"]===r).length/mes_fichiers.length;mes_series.push({name:r,data:part_de_la_categ})});creer_chart(4,mes_series,null,"Part des catégories sur "+mes_fichiers.length+" fichiers");if(!e)chargement(false)}function recuperer_mes_fichiers_old(e){if(e||!recuperer("mes_fichiers")){var r=JSON.parse(recuperer("mes_matieres"));var i='("'+r.map(e=>e["Je"]).join('","')+'")';if(!recuperer("mon_type").includes("Admin")){url=racine_data+"Fichiers_tout?"+apikey;url+="&id_dossier=in."+i}else{url=racine_data+"Fichiers_tout?"+apikey}url+="&order=date_effet.asc,heure_effet.asc,id_dossier.asc";mes_fichiers=get_resultat(url);mes_fichiers=mes_fichiers.filter(e=>i.includes(e["ke"]));return mes_fichiers}else{return JSON.parse(recuperer("mes_fichiers"))}}async function recuperer_mes_fichiers(e){if(e||!recuperer("mes_fichiers")){var r=JSON.parse(recuperer("mes_matieres"));var i="'"+r.map(e=>e["Je"]).join(",")+"'";nom_table='"Fichiers_tout"';url=nom_table;if(!recuperer("mon_type").includes("Admin")){url+="  WHERE "+i+" ~ id_dossier"}return rechercher_tout(url,true).then(function(e){e=e.filter(e=>i.includes(e["ke"]));return e})}else{return JSON.parse(recuperer("mes_fichiers"))}}function details_tdb_4(e){var i="";var t=JSON.parse(recuperer("mes_matieres"));var n=recuperer("mon_type").split("_")[0];mes_fichiers.forEach(function(e,r){id_classe_matiere=e["ke"];nom_classe=n==="Eleves"?"":t.filter(e=>e["Je"]===id_classe_matiere)[0]["o"]+" ";nom_matiere=t.filter(e=>e["Je"]===id_classe_matiere)[0]["q"]+" ("+e["De"]+")";i+=creer_element_journee(nom_classe+nom_matiere,e["P"],e["ze"],e["Ye"],e["V"],id_classe_matiere,"fichier",false,false,false)});creer_mini_popup("Fichiers en ligne",i,"    OK    ","$('#mini_popup').remove();",null,null,null,null,25);$("#mini_popup")[0].style.overflow="auto"}function creer_chart(e,r,i,t){const n=document.getElementById("tdb-"+e);mes_series_finales=r;if(e===1){reduction=reduire_serie(r,i);i=reduction[0];mes_series_finales=reduction[1]}else{i=i;mes_series_finales=r}const a={Zi:i,et:mes_series_finales};var s={rt:{width:"auto",height:"auto"}};if(t)s["rt"]["title"]=t;if(e===1){s["it"]={tt:true,title:{text:"Période"}};s["nt"]={title:"Nombre de tentatives de connexions"};const o=toastui.st.at({ot:n,data:a,options:s})}else if(e===3){s["et"]={_t:{fontFamily:"Arial",fontSize:13,fontWeight:500,color:"#FF6C00",ut:{visible:true,ct:{visible:true}}},stack:{type:"normal"}};const o=toastui.st.lt({ot:n,data:a,options:s})}else if(e===4){s["et"]={_t:{visible:true,dt:{visible:true}}};const o=toastui.st.ft({ot:n,data:a,options:s})}else{s["vt"]={scale:{min:0,max:100},title:"%"};s["et"]={ht:{start:270,end:90}};s["gt"]={bt:[{range:[0,20],color:"#df5353"},{range:[20,50],color:"#dddf0d"},{range:[50,100],color:"#55bf3b"}]};s["yt"]={gt:{bt:{$t:50}}};const o=toastui.st.qt({ot:n,data:a,options:s})}return s}function reduire_serie(i,e){mes_series_finales=i;var r=(e,i)=>e.map((e,r)=>i[r]+e);somme_series=i.map(e=>e["data"]).reduce(r);var t=somme_series.findIndex(e=>e)-1;if(t){e=e.slice(t);i.forEach(function(e,r){mes_series_finales[r]["data"]=i[r]["data"].slice(t)})}return[e,mes_series_finales]}function conseils_de_classe(){en_cours()}function remediations(){en_cours()}function langues(){en_cours()}function afficher_choix_extrait_manuel(e){element_DOM("extrait_manuel").style.display=e?"":"none"}function les_manuels_de_la_matiere(){resultat="";for(i=0;i<$("#drive_manuels > .span_un_fichier").length;i++){resultat+='<option value="'+$("#drive_manuels > .span_un_fichier")[i].id+'">'+$("#drive_manuels > .span_un_fichier")[i].innerText+"</option>"}return resultat}function afficher_checkbox(e,r){element_DOM(e).style.display=r?"":"none"}function switch_extrait_manuel(){var e=element_DOM("est_extrait_manuel").checked;element_DOM("manuel_choisi").value="";element_DOM("manuel_choisi").innerHTML='<option value="--">--</option>'+les_manuels_de_la_matiere();element_DOM("manuel_choisi").style.display=e?"":"none";afficher_choix_extrait_manuel(e);afficher_checkbox("choix_youtube",!e);afficher_choix_fichier(!e);if(e){$("#manuel_choisi").$("change",function(e){e.preventDefault();if(e.target.value==="--")return true;numeros_pages_str=prompt("Choisissez les numéros de pages (séparés de virgules et SANS ESPACES):","1,2,3");if(!numeros_pages_str){e.target.value="--";element_DOM("file").value="";element_DOM("file").style.display="none";return true}numeros_pages=numeros_pages_str.split(",").map(e=>Number(e));var r="https://www.googleapis.com/drive/v2/files/"+e.target.value+"?key="+google_api_file_access+"&alt=media&source=downloadUrl";var i=$("#manuel_choisi option:selected").text().split(".").pop();var t=$("#manuel_choisi option:selected").text().replace("."+i," (page "+numeros_pages_str+").png");visualiser("","","",t,false,false,true);$("#entete-fenetre")[0].style.display="none";chargement(true);var n=document.getElementById("previsualisation");n.style["float"]="left";n.style.overflow="scroll";n.style.textAlign="center";n.style.height="80%";n.style.maxWidth="100%";render_ces_pages(n,r,numeros_pages)});$("#mettre_fichier_en_ligne").$("click",function(e){if(!pre_validation("manuel_choisi")){}else{$("#file").Or()}})}else{$("#mettre_fichier_en_ligne").Ve("click")}}function render_ces_pages(i,e,t){i.innerHTML="";var r=pdfjsLib.nr(e);r.promise.then(function(e){t.forEach(function(r){if(r<=e.xt.ar){e.Ti(r).then(function(e){chargement(true);renderPage(i,e,r).then(function(){if(r===t[t.length-1]){$("#choix_pages_pdf").remove();var e='<div id="choix_pages_pdf" style="text-align: center;" class=""><rouge>Voici les pages que vous avez choisies. Voulez-vous valider ou annuler?</rouge><button class="mon_bouton" onclick="annuler_mon_choix()">Annuler</button><button class="mon_bouton" onclick="choisir_ces_pages(\''+t.toString()+"')\">Valider</button></div>";$("#fenetre").append(e);chargement(false)}})})}else{alert("Page "+r+" introuvable.")}})})}function choisir_ces_pages(e){numeros_pages=e.toString().split(",");mes_cnv=$("canvas");resultat=rendre_canvas_vertical(mes_cnv);image_temporaire=resultat;nom_image_temporaire=$("#titre_fenetre")[0].innerText;$("#nom_fichier_extrait")[0].innerText=$("#titre_fenetre")[0].innerText;$("#file").Or();quitter_previsualisation()}function annuler_mon_choix(){$("#manuel_choisi")[0].value="--";quitter_previsualisation()}function rendre_canvas_vertical(e){try{somme_des_hauteurs=0;liste_des_canvas_avec_position=[];for(i=0;i<e.length;i++){somme_des_hauteurs+=e[i].height;valeur_y=i===0?0:e[i-1].height*i;liste_des_canvas_avec_position.push({Ot:e[i],y:valeur_y})}var r=document.createElement("canvas"),t=r.getContext("2d"),n=e[0].width,a=somme_des_hauteurs;r.width=n;r.height=a;liste_des_canvas_avec_position.forEach(function(e){t.beginPath();t.drawImage(e.Ot,0,e.y,n,e.Ot.height)});return r.toDataURL()}catch(s){alert("Impossible de choisir les pages.");return false}}function verticalCanvases(e,r,i){var t=document.createElement("canvas"),n=t.getContext("2d"),a=e.width,s=e.height+r.height+i.height;t.width=a;t.height=s;[{Ot:e,y:0},{Ot:r,y:e.height},{Ot:i,y:e.height+r.height}].forEach(function(e){n.beginPath();n.drawImage(e.Ot,0,e.y,a,e.Ot.height)});return t.toDataURL()}async function renderPage(e,r,i){var t=1.25;var n=r.getViewport({scale:t});var a=document.createElement("canvas");a.id=$("#titre_fenetre")[0].innerText+"-"+i;e.appendChild(a);var s=a.getContext("2d");a.height=n.height;a.width=n.width;1;var o={Ji:s,viewport:n};return r.Pi(o)}function renderPDF(e,r){var r=r||{scale:1};pdfjsLib.Mt=true;var i=pdfjsLib.nr(e);i.promise.then(renderPages)}function canva_scrollable(e){var t=document.getElementById(e);var r=t.getContext("2d");var n=false;var a;var s=0;for(var i=0;i<1e3;i++){r.beginPath();r.arc(Math.random()*1e4,Math.random()*250,20,0,2*Math.PI,false);r.stroke()}t.addEventListener("mousedown",function(e){var r=e||event;n=true;a=r.clientX;e.preventDefault()},false);window.addEventListener("mousemove",function(e){var r=e||event;if(n){var i=r.clientX-a;a=r.clientX;s+=i;t.style.marginLeft=s+"px"}e.preventDefault()},false);window.addEventListener("mouseup",function(){n=false},false)}let deferredPrompt;const addBtn=$("#a2hs")[0];window.addEventListener("beforeinstallprompt",e=>{e.preventDefault();deferredPrompt=e;addBtn.style.display="block";$("#mynavbar")[0].style.top="20px";$(".alerte#alerte")[0].style.top="95px";if($("#alerte_vide")[0])$("#alerte_vide")[0].style.top="100px"});function ajouter_a_laccueil(){$("#a2hs")[0].style.display="none";$("#mynavbar")[0].style.top="";$(".alerte#alerte")[0].style.top="";deferredPrompt.prompt();deferredPrompt.userChoice.then(e=>{if(e.outcome==="accepted"){console.log("Accepté.")}else{console.log("Refusé.")}deferredPrompt=null})}if("serviceWorker"in navigator){window.addEventListener("load",function(){navigator.serviceWorker.register("../sw.js").then(function(e){},function(e){console.error("ServiceWorker registration failed: ",e)})})}function lien_pp(e){return e?"https://drive.google.com/uc?export=download&id="+e:prefixe_image+"/default-user.svg"}function recuperer_msgs(e,r){chargement(true);if(!r){vider_fenetre("");element_DOM("fenetre").innerHTML+=html_boutons_fenetre("recuperer_msgs(true)","ajouter_un_tout_nouveau_msg()","Pour répondre, cliquez sur le message en question.<br>"+alerte_conv())}else{}if(e||recuperer("mes_msgs")===null||recuperer("mes_msgs")===""){nom_table="Conversations";nom_champ_reference="id_conv";valeur_champ_reference="*"+ajouter_motif(recuperer("identifiant_courant"))+"*";nom_champ_a_chercher="";return rechercher_contenant_motif(nom_table,nom_champ_reference,valeur_champ_reference,nom_champ_a_chercher,"Horodateur","desc").then(e=>{stocker("mes_msgs",JSON.stringify(e));chargement(false);if(!r){return traitement_msgs()}else{return e}})["catch"](e=>{console.error(e);alert(e);alert("Impossible de récupérer vos messages. Vérifiez que vous êtes toujours connecté à internet, ou réessayer plus tard.");chargement(false);return false})}else{chargement(false);if(!r){return traitement_msgs()}else{return JSON.parse(recuperer("mes_msgs"))}}}function alerte_conv(){return""}function traitement_msgs(){afficher_fenetre(true);if(recuperer("mes_msgs").length===0||recuperer("mes_msgs")==="[]"){commentaire='<div id="vide" style="text-align: center;color: grey;margin: 10%;"> <i id="vide"> Vous n\'avez pas encore de messages privés.<br><br></i> </div>';var e=document.createElement("div");e.innerHTML=commentaire;while(e.firstChild){element_DOM("fenetre").appendChild(e.firstChild)}return commentaire}else{var r=JSON.parse(recuperer("mes_msgs"));if(!element_DOM("div_liste_msgs")){var i=document.createElement("div");i.style.overflowX="hidden";i.style.overflowY="auto";i.id="div_liste_msgs";i.style.height="90%";element_DOM("fenetre").appendChild(i)}else{var i=element_DOM("div_liste_msgs")}r.sort(function tri_ordre_chrono_decroissant(e,r){return convertir_en_date(r.ae)-convertir_en_date(e.ae)});r.forEach(function(e){ajouter_msg(r,i,e)});return r}}function ajouter_msg(e,r,i){var t=i["Dt"];var n=e.filter(e=>e["Dt"]===i["Dt"]&&!liste_notifs_lues.includes(","+e["kr"]+",")).length;if($("[id='"+t+"']").length>0)return true;var a=recuperer_destinataire(i["Dt"]);element_contenu=document.createElement("div");element_contenu.innerHTML=i["zt"];var s=element_contenu.innerText;var o=moment.max(e.filter(e=>e["Dt"]===i["Dt"]).map(e=>e.ae).map(e=>moment(e))).format("DD/MM/YYY HH:mm");var _=afficher_date(o);var u=e.filter(e=>e["Dt"]===i["Dt"]).length;if(u===undefined)u=0;var c="";if(!recuperer("mon_type").includes("Administration")&&i["u"]!==recuperer("identifiant_courant").trim())c="";var l=ma_photo(a.toLowerCase(),true);var d=n>0?'<div class="msg_non_lu">'+n+"</div>":"";var m='<ul class="bloc_msg" onclick="clic_de_msg(this.id)" id="'+t+'"> '+l+'<span id="details_conv">'+c+' <p id="'+t+'" style="font-size: 25px; margin:0px;"> <b class="contenu_question" id="'+t+'"> '+a+'  </b> <p id="'+t+'" class="contenu_question"> '+s+'</p><i class="petite_ecriture"> <h id="'+t+'"><u id="'+t+'"> Nombre de messages</u>: <u class="nb_com_actuel" id="'+t+'">'+u+'</u> </h> <h id="'+t+'">  &emsp; <u id="'+t+'"> Dernier message le</u>: '+_+' </h><h id="'+t+'"></h></i></span> '+d+" </ul>";var f=document.createElement("div");f.innerHTML+=m;while(f.firstChild)r.appendChild(f.firstChild)}function clic_de_msg(e){chargement(true);stocker("msg_chargé",e);recuperer_tous_les_msgs(e,false);chargement(false)}function recuperer_tous_les_msgs(r,e){var i=JSON.parse(recuperer("mes_msgs"));i=i.sort(function tri_ordre_chrono_decroissant(e,r){return convertir_en_date(e.ae)-convertir_en_date(r.ae)});var t=i.find(e=>e["Dt"].includes(r))["Dt"];t=recuperer_destinataire(t);try{var n=$("[id='pp_"+t.toLowerCase()+"']")[0].src}catch(u){var n=$("#entete_convo > .retour_msgs")[1].src}var a='<span id="entete_convo"><img id="<<" class="retour_msgs" src="'+prefixe_image+'/img_retour.png" onclick="recuperer_msgs(true)"> <img class="retour_msgs" src="'+n+'"><div id="Destinataire" class="titre_du_poste">'+t+"</div></span>";$("#div_liste_msgs").remove();vider_fenetre(a);var s='<div id="emplacement_des_msgs" class="emplacement_des_msgs"></div>';var o=document.createElement("div");o.innerHTML=s;element_DOM("fenetre").appendChild(o.firstChild);i=i.filter(e=>e["Dt"]===r);var _="<div id='conversation' class='conversation'>";i.forEach(function(e){msg_html=afficher_msg_conversation(e);_+=msg_html;jai_lu(e["kr"],false)});apres_maj_lecture_notifs();afficher_bulle_notifs();$("#emplacement_des_msgs").append(_);le_dernier_msg=i[i.length-1];element_DOM(le_dernier_msg["kr"]).scrollIntoView();$("#fenetre").append(zone_envoi(r))}function zone_envoi(e){return'<div id="nouveau_msg_convo"><textarea id="Message" name="Message" placeholder="Ecrivez votre message..."></textarea><button class="bouton_envoi" onclick="envoyer_mon_message(\''+e+'\')"><img alt="Envoyer" class="pp" src="'+prefixe_image+'/img_send.png" style="width: 30px;height: 30px;filter: invert(1);"></button></div>'}function afficher_msg_conversation(e){la_className="un_msg "+(e["kt"]===recuperer("identifiant_courant")?"msg_envoye":"msg_recu");Expediteur=e["kt"]===recuperer("identifiant_courant")?"MOI-MÊME":e["kt"].toUpperCase();return'<div class="'+la_className+'" id="'+e["kr"]+'"><div class="auteur_du_poste">'+Expediteur+'</div><h id="contenu_poste"><p data-placeholder="Votre commentaire...">'+e["zt"]+'</p></h><h id="date_poste">'+afficher_date(e["ae"])+"</h></div>"}async function liste_de_mes_destinataires(){var e=recuperer("mon_type").split("_")[0];var r=await recuperer_eleves(true);var i=await recuperer_profs(true);var t=await recuperer_admin(true);var n=[];n.push(r);n.push(i);n.push(t);n=[].concat.apply([],n);n=n.map(function(e){le_type=e["type"].includes("Admin")?e["ve"]:e["type"].substring(0,e["type"].length-1);return e["u"].toUpperCase()+" ("+le_type+")"});stocker("mes_destinataires",n);return n}function ajouter_un_tout_nouveau_msg(){liste_de_mes_destinataires();var e=false;if(e){alert("Impossible d'envoyer un nouveau message pour le moment.");return-1}if(impossible_de_cliquer())return-1;vider_fenetre("Nouveau message");element_DOM("maquestion").src="";var r='<div id="mon_formulaire" autocomplete="off" class="edition"><label id="label" for="Destinataire">Destinataire: </label><div id="div_autocompletion" class="autocompletion"> <input placeholder="Tapez pour chercher le destinataire..." autocomplete="on" onkeyup="validation_par_touche(event)" oninput="faire_autocompletion_input(this,\'Destinataire\')" type="text" name="Destinataire" id="Destinataire" maxlength="50" style="width: 100%;"></div><br><br><label id="label" for="Message">Votre message: </label><textarea id="Message" name="Message" placeholder="Saisissez votre message..." maxlength="1700" style="width: 100%;height: 70%;resize: none;font-size: 13px;"></textarea><div id="nb_max_div" style="margin-left: 90%;margin-top: 0%;font-size: 10px; display:none;"> <font id="nb_max"> 0 / 1700</font> </div><div id="mes_boutons" style="text-align: center;padding: 1%;display: block ruby;"><button class="bouton_sekooly" type="button" id="Annuler" onclick="recuperer_msgs(false)"> Annuler </button><button class="bouton_sekooly" type="button" id="envoi" onclick="envoyer_mon_message()"> Envoyer le message </button></div><div id="msg_erreur" style="text-align: center;padding: 1%;color: green;"> </div></div>';var i=document.createElement("span");i.innerHTML=r;element_DOM("fenetre").appendChild(i);$("#div_autocompletion").append('<div id="liste_destinataires"></div>');element_DOM("Destinataire").focus()}function validation_par_touche(e){if(e.keyCode===13)choisir("Destinataire",$("#liste_destinataires")[0].firstChild)}function faire_autocompletion_input(e,r){if(!recuperer("mes_destinataires"))liste_de_mes_destinataires();var i=recuperer("mes_destinataires").split(",");var t=$("[id='"+r+"']")[0].value.toUpperCase().replaceAll(" ","");liste_destinataires.innerHTML="";if(t){i=i.filter(function(e){return e.toUpperCase().replaceAll(" ","").includes(t)});i.forEach(function(e){$("#liste_destinataires").append("<div onclick=\"choisir('"+r+'\',this)" value="'+e+'">'+e+"</div>")})}}function choisir(e,r){$("[id='"+e+"']")[0].value=r.getAttribute("value");liste_destinataires.innerHTML="";destinataire=r.getAttribute("value").toLowerCase().split(" (")[0];id_conv1=ajouter_motif(destinataire)+ajouter_motif(recuperer("identifiant_courant"));id_conv2=ajouter_motif(recuperer("identifiant_courant"))+ajouter_motif(destinataire);mes_msgs=JSON.parse(recuperer("mes_msgs"));conv_initiale=mes_msgs.find(e=>e["Dt"]===id_conv1||e["Dt"]===id_conv2);if(conv_initiale){id_conv=conv_initiale["Dt"];charger_la_conv(id_conv)}}function charger_la_conv(r){recuperer_msgs(true).then(e=>$("ul[id='"+r+"']").click())}function le_destinataire(){return $("#Destinataire")[0].value||$("#Destinataire")[0].innerText}async function envoyer_mon_message(e){chargement(true);var r=e?true:false;if(!recuperer("mes_destinataires"))await liste_de_mes_destinataires();mes_destinataires=recuperer("mes_destinataires").split(",");var i=le_destinataire();if(!i||!mes_destinataires.find(e=>e.includes(i))){alert("Votre destinataire n'existe pas, merci de vérifier votre saisie.\nIl est possible que la personne ne soit plus inscrite sur la plateforme.");chargement(false);return false}var t=$("#Message")[0].value.replaceAll("\n","<br>").trim();if(t.length===0){alert("Merci de saisir un message avant de l'envoyer.");chargement(false);return false}var n=chercher_le_mot_interdit(t);if(n!==""){alert("Vous n'avez pas le droit d'utiliser le terme '"+n+"' dans le cadre des cours à "+nom_etablissement+" sur SEKOOLY.");return-1}i=i.split(" (")[0].toLowerCase();id_msg=creer_uuid();var a=e?e:create_id_conv(i,false);var s={ae:maintenant(),kt:recuperer("identifiant_courant"),wt:i,zt:t,kr:id_msg,Dt:a};ajouter_un_element("Conversations",s).then(function(e){if(r){$("#conversation").append(afficher_msg_conversation(s));element_DOM(id_msg).scrollIntoView();$("#Message")[0].value="";jai_lu(id_msg,true)}else{charger_la_conv(a)}chargement(false)})}function supprimer_conversation(e){id_convo=e.id.split("bye")[1];console.log(id_convo)}function recuperer_programme(){vider_fenetre("Programme scolaire");var e=JSON.parse(recuperer("mes_matieres"));var r=e.map(e=>e["Je"]);e=e.map(e=>e["o"]+" "+e["q"]);var i="";for(numero_matiere=0;numero_matiere<e.length;numero_matiere++){i+='<option value="'+r[numero_matiere]+'">'+e[numero_matiere]+"</option>"}var t='<div id="menu_programme" style="text-align: center;" class="menu_haut">Matière: <select id="ID_URL">'+i+"</select> </div>";$("#menu_programme").remove();$("#fenetre").append(t);$("#ID_URL").$("change",maj_matiere);maj_matiere();afficher_fenetre(true)}function maj_matiere(){chargement(true);var r=recuperer("mon_type")==="Eleves";var e=$("#ID_URL")[0].value;le_programme=donnees_programme(e);$("#programme_scolaire").remove();$(".conteneur_bouton_ajout_chapitre").remove();var i='<div id="programme_scolaire" class="programme_scolaire"></div>';$("#fenetre").append(i);if(!r){boutons_update_programme=liste_statuts(r)+bouton_renommer_chapitre()+bouton_supprimer_chapitre();bouton_ajouter_nouveau_chapitre='<div class="conteneur_bouton_ajout_chapitre"><button onclick="ajouter_un_chapitre()" class="bouton_ajout_chapitre">Ajouter un chapitre</button></div>'}else{boutons_update_programme="";bouton_ajouter_nouveau_chapitre=""}if(le_programme.length===0){$("#programme_scolaire").append('<div class="alerte_section_journee">Aucun chapitre n\'a été trouvé pour cette matière.</div>')}else{le_programme.forEach(function(e){if(r)boutons_update_programme=liste_statuts(true,e["jt"]);date_fin_chapitre=e["Et"]?'<div class="date_fin">le '+afficher_date(e["Et"])+"</div>":"";$("#programme_scolaire").append('<div class="un_chapitre" id="'+e["Se"]+'">\x3c!--<span class="titre_chapitre position_chapitre" id="position_chapitre">'+e["St"]+') </span>--\x3e<span class="titre_chapitre" id="'+e["Se"]+'">'+e["Le"]+"</span>"+"<br>"+boutons_update_programme+date_fin_chapitre+"</div>");if(!r){$("[id='"+e["Se"]+"'] > select").qr(e["jt"]);actualiser_couleurs($("[id='"+e["Se"]+"'] > select")[0])}});if(!r){$("#programme_scolaire").It({update:function t(){var e=[];$(".un_chapitre.ui-sortable-handle").G(function(e,r){nouvelle_position_chapitre_drag=e+1;modifier_chapitre(r.id,"position_chapitre",nouvelle_position_chapitre_drag,false)})}})}}if(bouton_ajouter_nouveau_chapitre){$("#fenetre").append(bouton_ajouter_nouveau_chapitre)}chargement(false);return true}function nouvelle_position_chapitre(){var e=$(".titre_chapitre.position_chapitre").text().replaceAll(")","").split(" ").map(e=>Number(e));return Math.max.apply(Math,e)+1}function bouton_renommer_chapitre(){return'<img onclick="renommer_chapitre(this)" src="'+prefixe_image+'/img_edit.png" alt="Renommer" class="editer">'}function bouton_supprimer_chapitre(){return'<img onclick="supprimer_ce_chapitre(this)" src="'+prefixe_image+'/img_trash.png" alt="Supprimer" class="editer">'}function liste_statuts(e,r){if(!e){resultat=`
			<select class="etat_chapitre" onchange="changer_statut_chapitre(this)">
				<option value="Non commencé" id="Non commencé">Non commencé</option>
				<option value="En cours" id="En cours">En cours</option>
				<option value="Terminé" id="Terminé">Terminé</option>
				<option value="Annulé" id="Annulé">Annulé</option>  
			</select>
			`}else{resultat='<span style="background: '+couleur_de_letat(r)+';" class="etat_chapitre">'+r+"</span>"}return resultat}function couleur_de_letat(e){var r=e==="Non commencé"?"#848484":e==="En cours"?"#ffae59":e==="Terminé"?"#5d9140":e==="Annulé"?"#df756a":"";return r}async function ajouter_un_chapitre(){intitule_chapitre=prompt("Indiquez le nom du nouveau chapitre: ");if(!intitule_chapitre)return false;donnees_chapitre={Se:creer_uuid(),Je:programme_ID_URL_actuel(),Ie:programme_classe_matiere_actuel(),Le:intitule_chapitre,St:nouvelle_position_chapitre(),jt:"Non commencé"};return await ajouter_un_element("Programme",donnees_chapitre).then(function(){maj_matiere();return donnees_chapitre})}function programme_ID_URL_actuel(){return $("#ID_URL")[0].value}function programme_classe_matiere_actuel(){return $("#ID_URL option:selected").text()}function donnees_programme(e){return get_resultat(racine_data+"Programme?ID_URL=eq."+e+"&order=position_chapitre.asc&"+apikey)}function renommer_chapitre(e){var r=le_id_chapitre(e);var i=$(".titre_chapitre[id='"+r+"']")[0].innerText;nouveau_nom=prompt("Indiquez le nouveau nom du chapitre: ",i);if(nouveau_nom&&nouveau_nom!==i)modifier_chapitre(r,"intitule_chapitre",nouveau_nom,maj_matiere)}function changer_statut_chapitre(e){actualiser_couleurs(e);var r=le_id_chapitre(e);modifier_chapitre(r,"etat",e.value);var i=e.value==="Terminé"||e.value==="Annulé"?maintenant():"";modifier_chapitre(r,"date_fin",i,maj_matiere)}function actualiser_couleurs(e){var r=couleur_de_letat($("[id='"+e.value+"']")[0].value);e.style.background=r}function supprimer_ce_chapitre(e){var r=le_id_chapitre(e);var i=confirm("⚠️Voulez-vous vraiment supprimer ce chapitre ? Cette action est irréversible. ("+r+")");if(i){supprimer("Programme","id_chapitre",r).then(()=>maj_matiere())}}function le_id_chapitre(e){return e.parentNode.id}function modifier_chapitre(e,r,i,t){var n={Se:e,[r]:i};actualiser("Programme","id_chapitre",e,n).then(()=>t?t():"")}function choisir_ce_mode(e){if($(".mode_affichage_fichiers")){$(".mode_affichage_fichiers")[0].className="mode_affichage_fichiers";$(".mode_affichage_fichiers")[1].className="mode_affichage_fichiers";var r=e.id.replace("par_","");var i=id_autre(r);$("#"+r)[0].style.display="";$("#"+i)[0].style.display="none";e.className="mode_affichage_fichiers mode_choisi";masquer_config_mode();stocker("mode_prefere",e.id);filtrer_avec_le_bon_filtre(r)}}function filtrer_avec_le_bon_filtre(e){if(e==="la_date_effet"){filtrer_date_effet()}else if(e==="filtre_id_chapitre"){filtrer_chapitre()}}function id_autre(e){var r=e==="la_date_effet"?"filtre_id_chapitre":"la_date_effet";return r}function afficher_config_mode(){if($(".gear-container")[0])$(".gear-container")[0].style.display="block"}function masquer_config_mode(){if($(".gear-container")[0])$(".gear-container")[0].style.display=""}function switch_config_mode(){if($(".gear-container")[0]){deja_visible=$(".gear-container")[0].style.display==="block";if(deja_visible){masquer_config_mode()}else{afficher_config_mode()}}}function creer_chapitre(){recuperer_programme();afficher_fenetre(false);$("select[id='ID_URL']")[0].value=recuperer("dossier_chargé");ajouter_un_chapitre().then(async function(e){if(e){await chercher_mes_chapitres(true);$("select#id_chapitre")[0].value=e["Se"]}else{element_DOM("id_chapitre").value="--"}})}function faire_la_recherche_fichier(){var e='<input id="rechercher" class="barre_recherche" name="rechercher" placeholder="Rechercher un fichier par mot(s)-clé(s)...">';$("#mini_popup").remove();var r=help("aide_recherche()");creer_mini_popup(r+"<b>Que recherchez-vous?</b>"+e,"<div class='liste_resultats' id='liste_resultats'></div>","Rechercher","afficher_resultats_recherche()")}function help(e){return'<rouge class="mini-image" onclick="'+e+"\">Besoin d'aide?</rouge>"}function aide_recherche(){var e="Un fichier peut être recherché par des mots-clés liés à :\n\t• la matière dans laquelle il est publié\n\t• le nom que l'enseignant lui a donné\n\t• son extension (pdf,png,youtube...)\n\t• sa catégorie (cours, devoir, ...)\n\t• l'intitulé de son chapitre.\nExemple: aucun chapitre";alert(e)}async function afficher_resultats_recherche(){chargement(true);var i=$("#rechercher")[0].value.trim().toLowerCase().replaceAll(" ","");if(!i){alert("Merci de d'abord saisir un mot-clé.");return false}mes_fichiers=await recuperer_mes_fichiers(true);var e=mes_fichiers.filter(e=>e["De"]!=="Profil");var t=JSON.parse(recuperer("mes_matieres"));mes_fichiers_intermediaires=e.map(r=>Object.assign({},...[r,t.find(e=>e["Je"]===r["ke"])]));var r=mes_fichiers_intermediaires.filter(function(e,r){dans_classe_matiere=e["Ie"].toLowerCase().replaceAll(" ","").includes(i);dans_categorie_fichier=e["De"].toLowerCase().replaceAll(" ","").includes(i);dans_nom_fichier=e["P"].toLowerCase().replaceAll(" ","").includes(i);intitule_chapitre=e["Le"]===null?"(Aucun chapitre)":e["Le"];dans_intitule_chapitre=intitule_chapitre.toLowerCase().replaceAll(" ","").includes(i);return dans_classe_matiere||dans_categorie_fichier||dans_nom_fichier||dans_intitule_chapitre});var n="";if(r.length===0){n='<div class="alerte_section_journee">Aucun résultat trouvé pour <b>'+i+"</b>.<br>Merci de réessayer.</div>"}else{r.forEach(function(e){n+=creer_element_journee(e["o"]+" "+e["q"],e["P"],e["ze"],e["Ye"],e["V"],e["Je"],"fichier",false,false,false)})}$("#nb_resultats").remove();$("#liste_resultats")[0].innerHTML="";$("#liste_resultats").append(n);$("#mini_popup").append('<div id="nb_resultats"><b>'+r.length+" résultats trouvés<b></div>");chargement(false)}async function emettre_avis_sekooly(){var e=await mon_avis_actuel();var r=e.length>0;var i=r?"Modifier mon avis":" Envoyer mon avis ";var t=r?"fermer_emettre_avis()":"envoyer_avis()";var n=r?'<div id="avis">'+afficher_avis(e[0])+"</div>":formulaire_avis();creer_mini_popup("Mon avis sur Sekooly",n,i,t,false,false,false,false,25);accepter_cgu_avis()}function avis_good(){return"❤️Ce que vous aimez le plus"}function avis_bad(){return"😕Ce que vous aimez moins<br>(ou une fonctionnalité que vous aimeriez avoir)"}function afficher_avis(e){return un_element_avis("Note globale",e["Nt"],"note_globale")+un_element_avis(avis_good(),e["Ct"],"commentaire")+un_element_avis(avis_bad(),e["At"],"ameliorations")}function un_element_avis(e,r,i){return'<div><b class="titre_chapitre">'+e+':</b><div class="element_avis" id="'+i+'">'+r+"</div></div>"}function formulaire_avis(){return`<div id="nouvel_avis"><br>		
		<p>Nous serions honorés de <span class="titre_chapitre">connaître en détails</span> ce qui vous plaît! (et même ce qui vous plaît moins 😉)</p>
		<form onsubmit="event.preventDefault();" id="avis">
			<div>Note globale pour Sekooly (sur 5):`+liste_notes_possibles()+`</div>
			<div>`+avis_good()+`:<textarea id="commentaire" class="texte_avis"></textarea></div>
			<div>`+avis_bad()+`:<textarea id="ameliorations" class="texte_avis"></textarea></div>
		</form>
		<div>
			<label for="cgu_avis"><input onchange="accepter_cgu_avis()" id="cgu_avis" type="checkbox" checked>J'accepte les <a class="titre_chapitre" onclick="alert(CGU_avis(event))">Conditions d'Utilisation</a> du système d'avis de la plateforme.</label>
		</div>
		</div>
		`}function CGU_avis(e){e.preventDefault();return`
	En cochant cette case, vous acceptez de:

	1° Mettre en avant votre avis sur sekooly.com sans aucune réserve
	2° Donner l'autorisation totale à Sekooly d'utiliser le nom de votre établissement, votre rôle et vos initiales pour la mise en avant de la plateforme
	3° Céder à Sekooly le droit de diffuser votre avis, dans les termes du point n°2
	4° Supprimer par vous-même votre avis en cas de besoin, depuis votre espace utilisateur.

	`}function liste_notes_possibles(e,r,i,t){var n=t?' onchange="'+t+'(this)"  ':"";var a=!i?'<select name="note_globale" id="note_globale" value=5>':'<select name="'+i+'"  '+n+"   >";var s=e?-5.1:0;for(la_note=5;la_note>s;la_note=la_note-.1){la_note=la_note.toFixed(2);selected=la_note===Number(r).toFixed(2)?" selected ":"";a+=une_note_possible(la_note,selected)}a+="</select>";return a}function une_note_possible(e,r){return'<option value="'+e+'"  '+r+"  >"+e+"</option>"}function fermer_emettre_avis(){var e=confirm("⚠️Cela supprimera votre ancien avis, et cette action est irréversible. Voulez-vous continuer ?");if(e){$("#mini_popup").remove();supprimer_initial("Avis","identifiant",recuperer("identifiant_courant")).then(()=>emettre_avis_sekooly())}}async function mon_avis_actuel(){return await get_resultat_asynchrone(racine_initiale+"Avis?identifiant=eq."+recuperer("identifiant_courant")+"&"+api_initial)}function accepter_cgu_avis(){if($("#cgu_avis").length>0){var e=$("#cgu_avis")[0].checked;afficher_bouton_envoyer_avis(e)}}function afficher_bouton_envoyer_avis(e){$("[onclick='envoyer_avis()']")[0].style.display=e?"":"none"}async function envoyer_avis(){var e=$("#note_globale")[0].value;var r={qe:recuperer("identifiant_courant"),i:data_etablissement["i"],Rt:mon_role,Nt:e,Ct:$("#commentaire")[0].value,At:$("#ameliorations")[0].value,Tt:false,I:maintenant()};return ajouter_un_element_racine("Avis",r).then(function(){afficher_alerte("Merci infiniment pour votre avis!");emettre_avis_sekooly()})}async function gerer_sondage(){var aujd=maintenant().split(" ")[0];var mes_sondages=get_resultat(racine_initiale+"Sondage?date_fin=gt."+aujd+"&"+api_initial);if(recuperer("identifiant_courant").includes("admin")){var sondages_non_majs=mes_sondages.filter(e=>e["Pt"]===false);if(sondages_non_majs.length>0){var confirmation=confirm("Mettre à jour tous les identifiants de tous les établissements Sekooly?");if(!confirmation)return false;var liste_etablissements=get_resultat(racine_initiale+"Etablissements?"+api_initial);liste_etablissements.forEach(function(r){console.log("\n\n\n\n");liste_tables=["Eleves","Profs","Administration"];liste_tables.forEach(function(e){nouvelle_donnee={ii:"non"};url=r["lr"]+e+"?apikey="+r["t"];console.log("\n");console.log({url:url,Jt:nouvelle_donnee});patch_resultat_asynchrone(url,nouvelle_donnee)})});url=racine_initiale+"Sondage?"+api_initial;patch_resultat_asynchrone(url,{Pt:true})}}else{var mon_type=recuperer("mon_type").split("_")[0];var mes_donnees=get_resultat(racine_data+mon_type+"?Identifiant=eq."+recuperer("identifiant_courant")+"&"+apikey)[0];var donnees_actuelles=JSON.parse(recuperer("mes_donnees"));if(!mes_donnees||mes_donnees["ge"]!==donnees_actuelles["ge"]&&mes_donnees["ge"]!==hasher(donnees_actuelles["ge"])){console.log("usurpation d'identité.");await tout_quitter()}else{stocker("mes_donnees",JSON.stringify(mes_donnees))}if(mes_donnees["ii"]==="non"){mes_sondages.forEach(async function(sondage){alert(sondage["description"]);await eval(sondage["Ut"]);var element_validation=eval(sondage["Vt"]);element_validation.$("click",function(){var e=racine_data+recuperer("mon_type")+"?Identifiant=eq."+recuperer("identifiant_courant")+"&"+apikey;patch_resultat_asynchrone(e,{ii:"oui"});modifier_donnee_locale("mes_donnees","Identifiant",recuperer("identifiant_courant"),"Reponse_sondage","oui")})})}}}function gerer_notifs_irl(e){var r=$("#notifs_sans_actualiser")[0].innerText;var i="";var t="";if(r.length>0){i="";t="Notifications et messages en temps réel <b><rouge>désactivés</rouge></b> sur cet appareil.";fermer_la_subscription()}else{var n=confirm("🔔 En activant les notifications et messages privés en temps réel sur cet appareil, vous risquez d'augmenter votre consommation de données.\n\nVoulez-vous continuer?");if(n){i=" ✓";t="Messages privés en temps réel <b><rouge>activés</rouge></b> sur cet appareil.";ouvrir_la_subscription()}}stocker("notifs_sans_actualiser",i);$("#notifs_sans_actualiser")[0].innerText=i;if(t)afficher_alerte(t)}function notifs_reelles_ou_non(){var e="";if(recuperer("notifs_sans_actualiser")){e=" ✓";ouvrir_la_subscription()}else{e="";fermer_la_subscription()}$("#notifs_sans_actualiser")[0].innerText=e}function la_notif_me_concerne(e,r){if(r.Lt==="UPDATE"||r.Lt==="INSERT"){var i=r.Ft;var t=JSON.parse(recuperer("mes_matieres"));var n=i["H"].includes(recuperer("identifiant_courant"));var a=e.includes("Profs")&&t.filter(e=>e["Je"]===i["de"]).length>0;var s=e.includes("Eleves")&&t.filter(e=>e["Je"]===i["de"]).length>0;var o=e.includes("Admin")&&i["me"]===JSON.parse(recuperer("mes_donnees"))["me"];return!n&&(a||s||o)}else{return false}}function ouvrir_la_subscription(){if(mySubscription_notif&&mySubscription_conv)return true;var t=recuperer("mon_type").split("_")[0];var e="Notifs";gerer_notifications_appareil();mySubscription_notif=supabase.from(e).$("*",function(e){console.log("nouvelle notif!",e);if(la_notif_me_concerne(t,e)){var r=ajouter_la_notif(e.Ft,null,true);var i=","+JSON.parse(recuperer("mes_notifs")).map(e=>e.ne).join(",")+",";la_date_derniere_modif=convertir_en_date(e.Ft["B"]).Yt(0).Kt(0).toISOString();ma_date_consultation=convertir_en_date(recuperer("ma_date_consultation")).Yt(0).Kt(0).toISOString();if(!(liste_notifs_lues.includes(","+e.Ft["ne"]+",")&&la_date_derniere_modif<=ma_date_consultation)){afficher_notif(r,e.Ft)}recuperer_notifs()}else{}}).subscribe();mySubscription_conv=supabase.from("Conversations:Destinataire=eq."+recuperer("identifiant_courant")).$("*",async function(e){var r=element_DOM("fenetre").style.visibility==="visible";var i=r?$("#div_liste_msgs").length>0?true:false:false;var t=$("#Destinataire.titre_du_poste").length>0?$("#Destinataire.titre_du_poste")[0].innerHTML===e.Ft["kt"].toUpperCase():false;if(t){ajouter_donnee_locale("mes_msgs",e.Ft,"id_msg");if($("[id='"+e.Ft.kr+"']").length===0){$("#conversation").append(afficher_msg_conversation(e.Ft));element_DOM(e.Ft.kr).scrollIntoView();jai_lu(e.Ft.kr,true)}}else if(!i){ajouter_donnee_locale("mes_msgs",e.Ft,"id_msg");afficher_bulle_notifs()}else{ajouter_donnee_locale("mes_msgs",e.Ft,"id_msg");recuperer_msgs(false);afficher_bulle_notifs()}}).subscribe();$(window).bind("beforeunload",function(){fermer_la_subscription()})}function fermer_la_subscription(){if(mySubscription_notif)supabase.Bt(mySubscription_notif);if(mySubscription_conv)supabase.Bt(mySubscription_conv)}function gerer_notifications_appareil(){if(mode_test_notif()){if(Notification.permission!=="granted"){Notification.requestPermission().then(function(e){afficher_notif()})}else{}}}function afficher_notif(e,r){if(Notification.permission==="granted"&&mode_test_notif()){popup_notification(e,r)}}function mode_test_notif(){return window.location.href.includes("testo")||window.location.href.includes("localhost")}function popup_notification(e,r){var i=e||"Vous avez activé les notifications Sekooly.";const t=new Notification("Sekooly | Nouvelle notification",{body:i,icon:prefixe_image+"/logo-no-background-128x128.png",vibrate:[100,50,100]});if(r){t.onclick=function(e){clic_de_notif(r["se"],r["oe"],r["de"],r["ne"],r["se"]==="discussion")}}else{}}function ajouter_page_devoir(){nb_pages_devoir=$(".mon_file_devoir").length;if(nb_pages_devoir<8){var e=element_DOM("file_devoir").cloneNode(true);e.id="file_devoir_"+nb_pages_devoir;e.value="";e.className="mon_file_devoir fichier_supplementaire";$("#soumettre_devoir")[0].insertBefore(e,$("#boutons_devoir")[0]);$(".mon_file_devoir").Ve("change");$(".mon_file_devoir").$("change",function(e){actualiser_rendu()})}else{alert("Vous ne pouvez pas envoyer un devoir de plus de 8 pages.")}}async function actualiser_rendu(e){await rassembler(e)}async function supprimer_derniere_page_devoir(){index_dernier_devoir=$(".mon_file_devoir").length-1;if(index_dernier_devoir>0){var e=$("[id='file_devoir_"+index_dernier_devoir+"']")[0].value.length>0;if(e)var r=confirm("Voulez-vous vraiment supprimer la dernière page?");if(r||!e){$("[id='file_devoir_"+index_dernier_devoir+"']").remove();$("img#result"+index_dernier_devoir).remove();await actualiser_rendu(true)}}}function mode_suppression(){return recuperer("mon_type").includes("Administration")&&window.location.href.endsWith("?delete="+data_etablissement["cr"])}async function valider_suppression_via_mail_si_besoin(){if(mode_suppression()){confirmation=prompt("Vous avez demandé à supprimer Sekooly, ce qui engendre la suppression de TOUTES vos données.\n\nMerci de confirmer cette action en écrivant 'je veux supprimer "+data_etablissement["i"]+"'");console.log(confirmation);if(confirmation==="je veux supprimer "+data_etablissement["i"]){chargement(true);var e=await chercher_lien_script(5);var r="?confirmation="+confirmation;var i="&adresse_mail_suppression="+data_etablissement["dr"];var t="&nom_etablissement="+data_etablissement["i"];var n="&id_etablissement="+data_etablissement["cr"];url=e+r+i+t+n;chargement(true);resultat=await post_resultat_asynchrone(url,{});await supprimer_initial("Etablissements","id",data_etablissement["id"]);setTimeout(function(){window.location.href="https://sekooly.com"},3e3);afficher_alerte(resultat);chargement(false)}else{afficher_alerte("Suppression de votre plateforme Sekooly annulée.");setTimeout(function(){window.location.href="/tele-enseignement"},3e3)}}}function afficher_quiz_option(e){element_DOM("quiz-option").style.display=e?"block":"none"}function quiz_selected(){return $("#liste_quiz").qr()}function edit_quiz(){stocker("tmp_quiz",JSON.stringify({Ht:quiz_selected()}));creer_quiz()}async function delete_quiz(){var e=confirm("⚠️Êtes-vous sûr de vouloir supprimer ce quiz ? Cette action est irréversible.");if(e){var r=quiz_selected();est_publié=await rechercher("Fichiers","id_fichier",r);if(est_publié.length>0){var i=confirm("Le quiz possède peut-être déjà des réponses.\nSi vous le supprimez, vous supprimez toutes les réponses du quiz. Voulez-vous continuer?");if(i)supprimer_quiz(r)}else{supprimer_quiz(r)}}}async function supprimer_quiz(e){await supprimer("Reponses","id_quiz",e);await supprimer("Questions","id_quiz",e);await supprimer("Rendus","id_fichier_sujetdevoir",e);await supprimer("Quiz","id_quiz",e);afficher_alerte("Le quiz a bien été supprimé.");changement_quiz_ou_non()}function ajouter_edit_quiz(e){if(e){if($("#edit-quiz").length===0)$("#mode-quiz").append('<img id="edit-quiz" onclick="edit_quiz()" src="'+prefixe_image+'/img_edit.png" alt="MODIFIER" class="editer">');if($("#delete-quiz").length===0)$("#mode-quiz").append('<img id="delete-quiz" onclick="delete_quiz()" src="'+prefixe_image+'/img_trash.png" alt="SUPPRIMER" class="editer">')}else{$("#edit-quiz").remove()}}async function changement_quiz_ou_non(){$("#liste_quiz").Ve("change");$("#liste_quiz").$("change",function(e){if(e.target.value==="new"){$("#liste_quiz")[0].value="--";ajouter_edit_quiz(false);creer_quiz()}else if(e.target.value==="--"){ajouter_edit_quiz(false)}else{ajouter_edit_quiz(true)}});if($("#categorie_choisie")[0].value==="Quiz"){$("#mode-non-quiz").Mr("display","none");$("#mode-quiz").Mr("display","block");all_quiz=await rechercher("Quiz","id_classe_matiere",recuperer("dossier_chargé"));$(".my-quiz").remove();all_quiz.forEach(e=>{$('<option class="my-quiz" value="'+e.Ht+'">'+e.Ze+"</option>").insertBefore($('[id="new-quiz"]'))});$("#mettre_fichier_en_ligne").$("click",function(){id_quiz=$("#liste_quiz").qr();if(id_quiz!=="--"){var e=$('[value="'+id_quiz+'"]').text()+".quiz";publier_quiz(id_quiz,e);$("#mettre_fichier_en_ligne").Ve("click")}});afficher_checkbox_fichier_telechargeable(false);$("#liste_quiz")[0].value="--"}else{element_DOM("mode-non-quiz").style.display="grid";element_DOM("mode-quiz").style.display="none";afficher_checkbox_fichier_telechargeable(true)}}function initialiser_fenetre_quiz(e,r){var i=e?"prev_question()":"prev_step_quiz()";var t=e?"next_question("+r+")":"next_step_quiz()";$("#fenetre").append('<div class="setup" id="setup"></div>');$("#setup").append('<div id="contenu_etape_quiz"></div>');$("#setup").append('<div id="btn-quiz"></div>');$("#btn-quiz").append('<button onclick="'+i+'" id="btn-previous" class="btn-setup">Précédent</button>');$("#btn-quiz").append('<button onclick="'+t+'" id="bouton_suivant" class="btn-setup">Suivant</button>');$("#btn-quiz").append('<div id="remarque-quiz"></div>')}async function creer_quiz(e){if(recuperer("mon_type").includes("Eleve"))return alert("Vous n'avez pas les droits pour modifier un quiz.");vider_fenetre("Editer un quiz (<span id='etape-quiz'>1</span>/2)",false,"sauvegarder_quiz()");afficher_fenetre(true);initialiser_fenetre_quiz();init_creation_quiz();if(e){for(var r=0;r<e;r++){next_step_quiz()}}}function afficher_donnes_quiz(e,i){e.forEach(r=>{var e=i.filter(e=>e["Ht"]===get_current_quiz()&&e["Qt"]===r["Qt"]);nouvelle_question(r,e)})}async function saisie_des_questions_responses(){var n=[];var _=[];console.log("Enregistrement des questions...");await sauvegarder_le_quiz_dans_la_table_quiz();$(".une_question_quiz").G(async(e,r)=>{var o=r.querySelector(".id_question").value;var i=r.querySelector("#intitule_question").value;var t={Ht:get_current_quiz(),Qt:o,Xt:e,Wt:element_DOM("type_question"+o).innerText,Gt:i};n.push(t);$(".une_question_quiz#"+o+" > .ui-sortable > ").G(async(e,r)=>{var i=r["id"];var t=r.querySelector("[name=reponse]").value;var n=Number(r.querySelector("[name=note_globale]").value);var a=r.querySelector(".remarque_correction").outerHTML;var s={Ht:get_current_quiz(),Qt:o,Zt:i,en:e,rn:t,tn:n,nn:a};_.push(s)})});var e=await stocker_element_server("Questions",n);var r=await stocker_element_server("Reponses",_);return[n,_]}async function init_creation_quiz(){var e=await valeur_par_defaut("*");if(!e){e={};e["Ze"]="";e["description"]=""}element_DOM("contenu_etape_quiz").innerHTML=`
		<span>Vous êtes sur le point de créer un quiz de <b class="sekooly-mode">`+la_matiere_chargee("Matiere")+`</b> dans <b class="sekooly-mode">`+la_matiere_chargee("Classe")+`</b>.</span>
		<form id="quiz-form">
			<input id="titre" name="titre" type="text"  value="`+e["Ze"].split(".quiz")[0]+`" placeholder="Titre de votre quiz">
			<textarea id="description" name="description" type="text"  placeholder="Brève description de votre quiz">`+e["description"]+`</textarea>
		</form>
	`}async function valeur_par_defaut(){try{var e=get_current_quiz();var r=await rechercher("Quiz","id_quiz",e);if(r)r=r[0];var i=r?r:JSON.parse(recuperer("tmp_quiz"));return i}catch(t){return""}}async function crud_questions(){element_DOM("contenu_etape_quiz").innerHTML=`
		<form id="quiz-form">
		</form>
		<bleu class="quiz-options" onclick="nouvelle_question()"><img src="`+prefixe_image+`/img_ajout.png" style="" class="small-icon"> Ajouter une question</bleu>
		<div onclick="run_quiz(true)" class="sekooly-mode quiz-options"><img src="`+prefixe_image+`/img_previz.png" class="small-icon trash"> Prévisualiser le quiz</div>
	`;var e=get_current_quiz();if(e){var r=await rechercher("Questions","id_quiz",get_current_quiz(),"*",false,"position_question.asc");var i=await rechercher("Reponses","id_quiz",get_current_quiz(),"*",false,"position_reponse.asc");afficher_donnes_quiz(r,i)}}async function run_quiz(e,r){var i=r||get_current_quiz();if(e){ma_tentative.U=i;ma_tentative.K=recuperer("identifiant_courant");ma_tentative.L="";sauvegarder_quiz()}accueil_quiz(i,e)}function get_current_question(){return recuperer("current_question")?Number(recuperer("current_question")):-1}function prev_question(){var e=Math.max(-1,get_current_question()-1);go_to_question(e)}function btn_terminer(){var e=quiz_mode_lecture()?"Terminer la relecture":"Tout envoyer et terminer";return e}async function next_question(e){if(element_DOM("bouton_suivant").innerHTML===btn_terminer()){var r=await submit_quiz();if(r)accueil_quiz(get_current_quiz())}var i=Math.min(e,get_current_question()+1);go_to_question(i,e)}async function accueil_quiz(id_quiz,preview_mode,proprietaire_initial){var proprietaire_devoir=recuperer("proprietaire_devoir");var proprietaire=proprietaire_initial?proprietaire_initial:proprietaire_devoir?proprietaire_devoir:recuperer("identifiant_courant");var references={U:id_quiz,K:proprietaire};var mes_tentatives=await rechercher_avec_ces_references("Rendus",references);var tentative_en_cours=mes_tentatives.length>0;if(tentative_en_cours){ma_tentative=mes_tentatives[0];var date_debut_premiere_tentative=ma_tentative["an"]}else{ma_tentative={}}var moimeme=proprietaire.toLowerCase()===recuperer("identifiant_courant");var pronom_utilisateur=!moimeme?proprietaire.toUpperCase():"Vous";var verbe_utilisateur=pronom_utilisateur==="Vous"?"avez":"a";var poss=pronom_utilisateur==="Vous"?"Votre":"Son";var infos_quiz=await rechercher("Quiz","id_quiz",id_quiz,"*");var nb_questions=await rechercher("Questions","id_quiz",id_quiz,"id_question");if(infos_quiz.length>0&&nb_questions.length>0){infos_quiz=infos_quiz[0];nb_questions=nb_questions.length;var bouton_edit=preview_mode||$('[class="editer"]').length>0?'<img onclick="creer_quiz()" src="'+prefixe_image+'/img_edit.png" alt="MODIFIER" class="editer">':"";vider_fenetre(infos_quiz["Ze"]+bouton_edit,false,"sauvegarder_quiz()");initialiser_fenetre_quiz(true,nb_questions);var total_score=await rechercher_avec_ces_references("total_score",{Ht:id_quiz},["score_question"]);if(total_score)total_score=eval(total_score.map(e=>e.sn).join("+"));var fin_quiz=ma_tentative["L"]?"<br>"+pronom_utilisateur+" l'"+verbe_utilisateur+" terminé le "+afficher_date(ma_tentative["L"]):"";var points=ma_tentative["L"]?"<br><b class='sekooly-mode'> "+poss+" score: "+await calculer_mon_score(ma_tentative["on"])+"/"+total_score+"</b>":"";var remarque_quiz=date_debut_premiere_tentative?'<i style="color: #737373;"> '+pronom_utilisateur+" "+verbe_utilisateur+" déjà fait 1 tentative le "+afficher_date(date_debut_premiere_tentative)+" "+fin_quiz+points+" </i>":"";element_DOM("remarque-quiz").innerHTML=remarque_quiz;$("#contenu_etape_quiz").append(infos_quiz["description"]+"<br><br>Ce quiz comporte "+nb_questions+" question"+(nb_questions>1?"s":"")+", et noté sur "+total_score+".");$("#contenu_etape_quiz")._n("resp_zone");stocker("current_question",-1);afficher_fenetre(true);element_DOM("bouton_suivant").innerText=ma_tentative["L"]?"Relecture":date_debut_premiere_tentative?"Reprendre la tentative":"Commencer";element_DOM("btn-previous").setAttribute("style","display: none;")}return true}async function calculer_mon_score(rpses){rspses_t=transform_rsp(rpses);my_id_resp=rspses_t[0];my_str_rsp=rspses_t[1];ref={Ht:get_current_quiz()};total_score=await rechercher_avec_ces_references("Reponses",ref,["id_reponse","score","intitule_reponse"]);var mon_score=total_score.filter(function(e){return my_id_resp.indexOf(e["Zt"])>=0||my_str_rsp.indexOf(e["rn"].trim())>=0});mon_score=mon_score.map(e=>Number(e["tn"]));return eval(mon_score.join("+"))}function transform_rsp(e){var i=[];var t=[];if(typeof e==="string")e=JSON.parse(e);$.G(e,(e,r)=>{if(typeof r==="string"){t.push(r.trim())}else if(r){i.push(r.map(e=>Object.keys(e)).join(","))}});i=i.join(",").split(",");return[i,t]}function initialiser_tentative(){if(Object.keys(ma_tentative).length===0){var e=creer_uuid();ma_tentative={ee:get_current_quiz()+suite_notif(),V:e,K:recuperer("identifiant_courant"),re:recuperer("dossier_chargé"),ie:la_matiere_chargee("Matiere"),U:get_current_quiz(),an:get_date_debut_quiz(),J:"",te:0,P:"Quiz de "+recuperer("identifiant_courant")+".quiz",on:{}}}return ma_tentative}async function go_to_question(e,r){save_current_submition();stocker("current_question",e);chargement(true);await get_nth_question(e,r);chargement(false)}function get_date_debut_quiz(){return recuperer("date_debut_quiz")?recuperer("date_debut_quiz"):maintenant()}async function submit_quiz(e){if(quiz_mode_lecture())return true;if(!e){if(quiz_mode_previz()){alert("Au clic de ce bouton, l'utilisateur aura le score de sa tentative, ainsi que la correction du quiz.\n⚠️Votre tentative n'est pas envoyée car vous êtes éditeur de ce quiz.");return true}var r=confirm("⚠️Êtes-vous sûr de vouloir terminer le quiz ? Cette action est irréversible.");if(!r)return false;ma_tentative["L"]=!quiz_mode_previz()?await maintenant():""}if(Object.keys(ma_tentative.on).length>0){var i=await supabase.from("Rendus").ji(ma_tentative);if(ma_tentative["L"]){mes_donnees=JSON.parse(recuperer("mes_donnees"));id_quiz=get_current_quiz();var t={ne:id_quiz+suite_notif(),ae:ma_tentative["L"],se:"devoir",oe:id_quiz,_e:ma_tentative["P"],ue:recuperer("identifiant_courant"),ce:"Eleve",H:recuperer("identifiant_courant"),X:"Eleve",o:mes_donnees["o"],le:"("+mes_donnees["o"]+"|"+la_matiere_chargee("Matiere")+")",de:recuperer("dossier_chargé"),B:ma_tentative["L"],me:mes_donnees["me"]};var n=await supabase.from("Notifs").ji(t)}}return ma_tentative}function save_current_submition(){var e=recuperer("current_question");var r=get_date_debut_quiz();var i=[];if($(".option-rps").length>0){$(".option-rps:checked").G((e,r)=>{i.push({[r.value]:r.nextSibling.innerText})})}else{i=$(".rps_quiz").qr()}var t={};t[e]=i;initialiser_tentative();if(!ma_tentative.on)ma_tentative.on={};ma_tentative.on[e]=i;submit_quiz(true);return ma_tentative}function reference_question(e,r,i){var t=r?r:e+1;var n=i?","+i:"";return'<a ref="'+e+'"    onclick="go_to_question('+e+n+')"><span>[ '+t+" ]</span></a> "}async function get_nth_question(e,r){if(e<0){return accueil_quiz(get_current_quiz())}else{element_DOM("bouton_suivant").innerText="Suivant";element_DOM("btn-previous").setAttribute("style","");if(r){element_DOM("remarque-quiz").innerHTML=reference_question("-1","Accueil",r);for(var i=0;i<r;i++){element_DOM("remarque-quiz").innerHTML+=reference_question(i)}element_DOM("remarque-quiz").innerHTML+=reference_question(r,"Finaliser",r)}}var t={Ht:get_current_quiz(),Xt:e};var n=await rechercher_avec_ces_references("Questions",t);if(n.length>0){n=n[0];var a=n["Qt"];delete t["Xt"];t["Qt"]=a;var s=await rechercher_avec_ces_references("total_score",t);if(!s)return afficher_alerte("Erreur de connexion, merci de réessayer plus tard.");var o=s[0]["un"];var _=s[0]["sn"];var u=await rechercher_avec_ces_references("Reponses",t,["id_reponse"]);u=u.length;var c=u===1?["id_quiz","id_question","id_reponse"]:["id_quiz","id_question","id_reponse","intitule_reponse"];if(quiz_mode_lecture())c=["*"];var l=await rechercher_avec_ces_references("Reponses",t,c,"position_reponse.asc");if(l){var u=l.length;if(typeof ma_tentative.on==="string")ma_tentative.on=JSON.parse(ma_tentative.on);var d=ma_tentative.on?ma_tentative.on[e]:null;$("#resp_zone").remove();var m=resp_zone(a,l,u,o,d);$(m).insertBefore(element_DOM("btn-quiz"));element_DOM("contenu_etape_quiz").innerHTML=n["Gt"];element_DOM("contenu_etape_quiz").innerHTML+="<br>("+_+" point"+(_>1?"s":"")+")"}}else{element_DOM("contenu_etape_quiz").innerHTML=quiz_mode_lecture()?"Retrouvez ci-dessous le résumé de votre tentative.":"Vous êtes sur le point de terminer le quiz.<br>Retrouvez ci-dessous le résumé de votre tentative.";element_DOM("resp_zone").innerHTML=resume_tentative_quiz(r)}$("#contenu_etape_quiz").Ni("resp_zone");$("span").Ni("current-qst");if($("a[ref='"+e+"']")[0])$("a[ref='"+e+"']")[0].children[0].className="current-qst";if(e===r)element_DOM("bouton_suivant").innerText=btn_terminer();return n}function resume_tentative_quiz(e){var r=get_current_quiz();var i="";var t="";for(var n=0;n<e;n++){if(ma_tentative.on){t=typeof ma_tentative.on[n]==="string"?ma_tentative.on[n]:typeof ma_tentative.on[n]==="object"?JSON.stringify(ma_tentative.on[n]):""}if(t==="[]")t=[];var a="<rouge>❌ Aucune réponse enregistrée</rouge>";if(t){if(t.length>0)a="<bleu>☑️ Réponse enregistrée</bleu>"}i+='<div onclick="go_to_question('+n+")\" class='resume'><br><a>Question n°"+(n+1)+"</a>: "+a+"</div>"}return i}function resp_zone(r,e,i,t,n){var a=ma_tentative["L"]?' disabled  readonly="readonly" ':"";var s=0;var o="";var _="";var u="";var c="Vous avez eu ";if(recuperer("proprietaire_devoir")){c=recuperer("proprietaire_devoir")===recuperer("identifiant_courant")?"Vous avez eu ":recuperer("proprietaire_devoir").toUpperCase()+" a eu "}if(i===1){var l=n?'value="'+n+'"':"";var d=e[0]["rn"]?n.trim()===e[0]["rn"].trim():"";var u=d&&e[0]["nn"]?e[0]["nn"]:!d&&e[0]["rn"]?"<rouge class='remarque_correction'>❌Mauvaise réponse. La réponse était: <b>"+e[0]["rn"]+"</b></rouge>":"";_=!e[0]["rn"]?"":d&&e[0]["tn"]?e[0]["tn"]>0?"+"+e[0]["tn"]:e[0]["tn"]:!d?0:"";o=e[0]["tn"]?c+_+" points pour cette question.":"";return`<form id="resp_zone" class="resp_zone" style="text-align: center;"><input `+l+`     class="rps_quiz"  id_question="`+r+`"  name="qst`+r+`"  id="response`+e[0]["Zt"]+`" placeholder="Votre réponse..."   `+a+`  type="text" name="rsp'+id_question+'"> <div>`+u+`  <span class="points">`+_+`</span></div>  <div class="points" id="rmq'+id_question+'"> `+o+` </div>   </form>`}else{var m=t===1?"radio":"checkbox";var f='<form id="resp_zone" class="resp_zone">';var p=",";if(n){p=typeof n!=="string"?","+n.map(e=>Object.keys(e)).join(",")+",":n}e.forEach(e=>{est_coché="";if(n){est_coché=p.includes(","+e["Zt"]+",")?"  checked  ":"";phrase_reponse_vraie_non_cochee=m==="checkbox"?"<rouge class='remarque_correction'>✅Cette réponse était aussi vraie.</rouge>":"<rouge class='remarque_correction'>✅Celle-ci était la bonne réponse.</rouge>";u=!e["tn"]?"":e["tn"]>0&&est_coché?e["nn"]:e["tn"]<=0&&est_coché?e["nn"]:e["tn"]>0&&!est_coché?phrase_reponse_vraie_non_cochee:"";signe=e["tn"]>=0?"+":"";_=e["tn"]?signe+e["tn"]:"";s=e["tn"]&&est_coché?s+Number(e["tn"]):s;o=e["tn"]?c+s+" points pour cette question.":""}f+=`
				<div>
					<input class="option-rps" type="`+m+`"     `+a+`     id_question="`+r+`"  `+est_coché+` name="qst`+r+`"  value="`+e["Zt"]+`" id="response`+e["Zt"]+`" ><label class="label-check" for="response`+e["Zt"]+`">`+e["rn"]+`</label>
					<span>`+u+`  <span class="points">`+_+`</span></span>
				</div>
			`});f+=' <div class="points" id="rmq'+r+'"> '+o+" </div>    </form>";return f}}function nouvelle_question(e,r){var i=$("#quiz-form").append(une_question_quiz(e));var t=i[0].lastElementChild;$("#quiz-form").It({update:function n(){var e=[];$(".une_question_quiz.ui-sortable-handle").G(function(e,r){nouvelle_position_question_drag=e+1;$(".id_question[value='"+r.getAttribute("name")+"']")[0].value=nouvelle_position_question_drag})}});if(e){t.querySelector("[name='type_question']").innerText=e["Wt"];t.querySelector("[name='intitule_question']").innerText=e["Gt"]}if(!r){add_response(t.id)}else{r.forEach(e=>{add_response(e["Qt"],e)})}}function une_question_quiz(e){var r=e?e["Qt"]:$("[name='intitule_question']").length+1;return`
	<div class="une_question_quiz" id="`+r+`"   name="`+r+`" >
		<input type="text" value="`+r+`" name="id_question" class="id_question">
		<div><rouge class="mini-image" style="font-size: 12px;" onclick="help_quiz_resp()">Besoin d'aide?</rouge></div>
		<div name="type_question" id="type_question`+r+`"></div>
		<textarea id="intitule_question" name="intitule_question" type="text" placeholder="Intitulé de la question..."></textarea>
		<div class="top-qstn">
			<rouge class="foot-element" onclick="supprimer_question(`+r+`)"><img src="`+prefixe_image+`/img_trash.png" alt="SUPPRIMER" class="small-icon trash"></rouge>			
	    </div>
	    <div class="reponses_possibles" name="reponses_possibles`+r+`"></div>
    	<div class="foot-qst" style="font-size: 15px;">
		  <bleu class="foot-element" onclick="add_response(`+r+`)">Ajouter une réponse possible</bleu>
		</div>
	</div>
	`}async function supprimer_question(e){$("[name='reponses_possibles"+e+"'] > .une_reponse_possible > [alt='SUPPRIMER'] ").G((e,r)=>{delete_resp(r,true)});var r=get_current_quiz();var i={Ht:r,Qt:e};retour=await supprimer_avec_ces_references("Questions",i);$('.une_question_quiz[id="'+e+'"]').remove()}async function delete_resp(e,r){var i=e.parentNode.parentNode;var t=i.children.length>1;if(t||r){var n=get_current_quiz();var a=i.parentNode.id;var s=e.parentNode.id;var o={Ht:n,Qt:a,Zt:s};retour=await supprimer_avec_ces_references("Reponses",o);e.parentNode.remove();mettre_type_question(i.parentNode.id);return true}else{alert("Vous devez donner au moins une réponse à la question.");return false}}function add_response(e,r){var i=$("[name='reponses_possibles"+e+"']").append(une_reponse_possible(r));var t=i[0].lastElementChild;$("[name='reponses_possibles"+e+"']").It({update:function n(){var e=[];$(".une_reponse_possible.ui-sortable-handle").G(function(e,r){nouvelle_position_rps_drag=e+1})}});mettre_type_question(e);$("[name=note_globale]").Ve("change");$("[name=note_globale]").$("change",function(e){valeur=Number(e.target.value);e.target.style.color=valeur<0?"red":valeur>0?"green":"";var r=e.target.parentNode.parentNode.parentNode.id;mettre_type_question(r);remarque_par_defaut(e.target)});$("[name=note_globale]").Or();if(r){t.querySelector("[name='reponse']").value=r["rn"];t.querySelector(".remarque_correction").outerHTML=r["nn"]}}function mettre_type_question(e){var r=element_DOM("type_question"+e);var i=$(".une_question_quiz#"+e+" > .reponses_possibles > .une_reponse_possible > [name='note_globale']");var t="Question en saisie libre";var n=$("[name='reponses_possibles"+e+"']");if(n.length===0)return true;n=n[0];var a=n.children.length;if(a>1){t="Question à choix unique";var s=i.filter(function(){return Number($(this).qr())>0}).length;if(s>1){t="Question à choix multiple"}}points_question=0;i.G(function(){valeur=Number($(this).qr());if(valeur>0)points_question+=valeur});var o=t+" sur "+points_question.toFixed(2)+" points ";if(r)r.innerText=o;mettre_score_total(true);return o}function mettre_score_total(e){var t=0;$("[name='note_globale']").G((e,r)=>{var i=Number(r.value);if(i>0)t+=i});element_DOM("remarque-quiz").innerText=e?"Votre quiz est noté sur "+t:"";return t}function une_reponse_possible(e){var r=e?e["Zt"]:creer_uuid();var i=quiz_mode_lecture()?"":' contenteditable="true" onclick="focus_edit(this)"';var t=!e?"0":Number(e["tn"]).toFixed(2);return`<span class="une_reponse_possible" id="`+r+`">
    <input name="reponse" style="width: 55%;" placeholder="Réponse possible et le SCORE de la réponse (liste déroulante)...">`+liste_notes_possibles(true,t,"note_globale")+`
    <img class="small-icon trash" alt="SUPPRIMER" src="`+prefixe_image+`/img_trash.png" onclick="delete_resp(this)">
    <br>
    <bleu class="mini-image remarque_correction wrong" `+i+` >Remarque correction</bleu>
  </span>
  `}function focus_edit(e){setCaret(e)}function setCaret(e){e.focus()}function remarque_par_defaut(e){var r=e.parentNode.querySelector("bleu");var i=r.innerHTML;if(i.length===0||i===valeur_remarque_initiale()||i===valeur_remarque_correct()||i===valeur_remarque_incorrect()){var t=Number(e.value)>0;r.innerHTML=t?valeur_remarque_correct():valeur_remarque_incorrect()}r.style.color=e.style.color}function remarque_correction(e){if(e.innerText.length===0)e.innerText=valeur_remarque_initiale()}function valeur_remarque_correct(){return"✅ Votre réponse est correcte."}function valeur_remarque_incorrect(){return"❌ Votre réponse est incorrecte."}function valeur_remarque_initiale(){return"Remarque correction"}function help_quiz_resp(){if($(".une_reponse_possible").length>0){var e="Le type de question se mettra à jour en fonction du nombre de réponses possibles ET du nombre de réponses justes.\n\n\n";e+="• Score positif=bonne réponse\n• Score nul=mauvaise réponse\n• Score négatif=malus.\n\n\nLa remarque de correction s'affiche lorsque l'utilisateur choisit cette réponse, et peut se personnaliser au clic.";alert(e)}else{alert("Ajoutez d'abord une réponse possible, puis recliquez à nouveau ici.")}}function get_current_quiz(){return recuperer("fichier_ouvert")?recuperer("fichier_ouvert"):recuperer("tmp_quiz")?JSON.parse(recuperer("tmp_quiz"))["Ht"]:null}function go_to_step(e,r){if(!recuperer("tmp_quiz")){resultat={Ht:creer_uuid()};stocker("tmp_quiz",JSON.stringify(resultat))}if(r===2){saisie_des_questions_responses()}else if(r===1){if(!formulaire_rempli_ok("quiz-form")){element_DOM("etape-quiz").innerText=r;return alert("Vous devez remplir tous les champs avant de continuer.")}resultat=objectifyForm("quiz-form")}resultat["Ht"]=JSON.parse(recuperer("tmp_quiz"))["Ht"];resultat["cn"]=recuperer("dossier_chargé");resultat["K"]=recuperer("identifiant_courant");stocker_quiz_local(resultat);if(e===1){init_creation_quiz()}if(e===r){finaliser_edition_quiz()}else if(e===2){crud_questions()}}function finaliser_edition_quiz(){var e=confirm("Êtes-vous sûr d'avoir bien édité les questions-réponses du quiz?");if(e)dernieres_modifs_quiz()}async function dernieres_modifs_quiz(){var e=get_current_quiz();var r={Ht:e,cn:recuperer("dossier_chargé"),K:recuperer("identifiant_courant"),L:maintenant()};await stocker_quiz_local(r);$("#sauvegarder").remove();$("#bye_prev").Qe("click",function(){$("#categorie_choisie").Or();element_DOM("liste_quiz").value=e;effacer("tmp_quiz")});element_DOM("setup").innerText="Vous pouvez fermer cette fenêtre.";await sauvegarde_mode_edit()}function avec_sauvegarde(e){if(e){$("#titre_fenetre").append('<img id="sauvegarder" src="'+prefixe_image+'/img_save.png" alt="💾" onclick="'+e+'" class="icon-save">')}else{$("#sauvegarder").remove()}}function next_step_quiz(){sauvegarder_quiz(true);var e=Number(element_DOM("etape-quiz").innerText);element_DOM("etape-quiz").innerText++;if(element_DOM("etape-quiz").innerText>2)element_DOM("etape-quiz").innerText=2;var r=Number(element_DOM("etape-quiz").innerText);go_to_step(r,e)}function prev_step_quiz(){sauvegarder_quiz(true);var e=Number(element_DOM("etape-quiz").innerText);element_DOM("etape-quiz").innerText--;if(element_DOM("etape-quiz").innerText<1)element_DOM("etape-quiz").innerText=1;var r=Number(element_DOM("etape-quiz").innerText);go_to_step(r,e)}function stocker_quiz_local(r){var e=recuperer("tmp_quiz");if(e&&JSON.parse(e)["Ht"]===r["Ht"]){Object.keys(r).forEach(e=>{modifier_donnee_locale("tmp_quiz","id_quiz",r["Ht"],e,r[e],false)})}else{effacer("tmp_quiz");stocker("tmp_quiz",JSON.stringify(r))}return recuperer("tmp_quiz")}function quiz_mode_run(){return $("[onclick='next_step_quiz()']").length===0}function quiz_mode_lecture(){return quiz_mode_run()&&ma_tentative["L"]?true:false}function quiz_mode_previz(){return $("[onclick='creer_quiz()']").length>0}async function sauvegarder_quiz(e){var r="";var i="";if(quiz_mode_lecture()){i="Vous ne pouvez pas modifier cette tentative.";r=ma_tentative}else if(quiz_mode_run()){i=ma_tentative.on&&Object.keys(ma_tentative.on).length>0?"Votre tentative a bien été sauvegardée.":"";save_current_submition();r=ma_tentative}else{i=await sauvegarde_mode_edit()}if(i&&!e)afficher_alerte(i);return r}async function sauvegarde_mode_edit(){texte_a_afficher="Votre quiz a bien été sauvegardé.";if($(".une_question_quiz").length>0){saisie_des_questions_responses()}else{texte_a_afficher=await sauvegarder_le_quiz_dans_la_table_quiz()}return texte_a_afficher}async function sauvegarder_le_quiz_dans_la_table_quiz(){if(recuperer("tmp_quiz")){try{var e=JSON.parse(recuperer("tmp_quiz"));await stocker_quiz_server(e);retour=e}catch(r){texte_a_afficher="Votre quiz n'a PAS été sauvegardé: merci de réessayer ou de vérifier votre connexion internet."}}else{texte_a_afficher="Aucune donnée de quiz à sauvegarder: appuyez sur suivant avant d'enregistrer."}return texte_a_afficher}function stocker_quiz_server(e){return supabase.from("Quiz").ji(e)}function stocker_element_server(e,r){return supabase.from(e).ji(r)}async function publier_quiz(e,r){date_heure_actuelle=maintenant();mes_donnees=JSON.parse(recuperer("mes_donnees"));la_classe=recuperer("mon_type")==="Eleves"?mes_donnees["o"]:la_matiere_chargee("Classe");la_matiere=recuperer("mon_type")==="Eleves"?$("#accueil_utilisateur")[0].innerText:la_matiere_chargee("Matiere");nouveau_fichier={L:date_heure_actuelle,V:e,P:r,ke:recuperer("dossier_chargé"),K:recuperer("identifiant_courant"),De:"Quiz",ze:element_DOM("date_effet_fichier").value,we:"non",te:0,He:null,Be:null};try{retour1=await ajouter_un_element("Fichiers",nouveau_fichier,e);id_notif=e+suite_notif();nouvelle_notif={ne:id_notif,ae:date_heure_actuelle,se:"fichier",oe:e,_e:r,ue:recuperer("identifiant_courant"),ce:mon_role,H:recuperer("identifiant_courant"),X:mon_role,o:la_classe,le:"("+la_classe+"|"+la_matiere+")",de:recuperer("dossier_chargé"),B:date_heure_actuelle,me:mes_donnees["me"]};retour2=await ajouter_un_element("Notifs",nouvelle_notif,id_notif);afficher_alerte("Votre quiz a bien été publié.",true)}catch(i){console.error(i);afficher_alerte("Erreur de publication du quiz: vérifiez s'il n'est pas déjà publié.")}chargement(false)}function au_clic(selector,callback){$(selector).Ve("click");$(selector).$("click",function(event){eval(callback)})}