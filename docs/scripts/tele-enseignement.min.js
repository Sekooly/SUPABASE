var elements_menu_haut=["Infos √©tablissement","Cycles","Classes","Matieres","Eleves","Profs","Administration","Maintenance","Programme","Alerte","Logs","Conversations","Visio","Notifs","Fichiers","Quiz","Questions","Reponses","Rendus","Topic","Coms","Espace etablissement restant"];var elements_menu_analyses=["Analyses des connexions"];var elements_menu_preferences=["Images","Couleurs","Formes","Police"];var img_dynamiques=["logo-no-background-128x128.png","img_retour.png","default-user.svg","img_reset.png","img_import.png","img_download.png","img_dupliquer.png","img_redtrash.png","img_previz.png","img_pleinecran.png","img_petitecran.png"];img_dynamiques=img_dynamiques.concat(liste_img_extensions());var parametres_automatiques=["Classe_bis","Classe_Matiere","ID_URL","URL","URL_Mapping","URL_agenda","id_googlecalendar","nb_avis_donn√©s","nb_avis_max","nom_fiche","taux_conseil","Matiere_bis","classe_id","classe_bis","type","Derniere_consultation_notifs","id_formulaire_remediation","id_fiche","URL_Mapping","niveau","classe_bis","id_dossier_cycle","dossier_rendus_cycle","liste_notifs_lues","nombre_avis","Numero_telephone","id","Id_classe_matiere","id_notif","Id_source","id_fichier","id_dossier","id_devoir","id_dossier_sujetdevoir","id_fichier_sujetdevoir","Id_topic","id_com","ID_FICHIER","id_msg","id_conv","id_chapitre","id_quiz","id_question","id_reponse"];var elements_menu_haut_avec_modifs=["Classes","Matieres","Eleves","Profs","Administration"];var elements_menu_haut_avec_reset=["Eleves","Profs","Administration"];nom_etablissement=data_etablissement["nom_etablissement"];var champs_avec_listes_dynamiques=["Classe","classe_bis","Classe_principale","Cycle","cycle","Matiere","Matiere_bis"];var champs_oui_ou_non=["Est_d√©l√©gu√©","Reponse_sondage","Ecolage_OK","Droits_modifs","Droit_acces_anticipe_examen","Droit_changer_ecolage","commun_au_cycle","droit_hors_maintenance","Est_d√©l√©gu√©"];var liste_couleurs=["blanc","bleu ciel","bleu fonc√©","gris","jaune","marron","noir","orange","rose","rouge","vert clair","vert fonc√©","violet"];var numero_etape=recuperer("numero_etape")?Number(recuperer("numero_etape")):0;var nb_etapes=8;var nouveau_prof=[];var image_temporaire="";var nom_image_temporaire="";var mes_devoirs_a_faire=[];var mes_devoirs_rendus=[];var tous_les_eleves_de_mon_cycle=[];var mes_discussions=[];var mes_coms=[];var mes_visios=[];var mes_fichiers=[];var liste_notifs_lues="";var mySubscription_notif=null;var mySubscription_conv=null;var ma_tentative={};var mes_reponses={};const{createClient}=supabase;supabase=createClient(racine_data.replace("/rest/v1/",""),data_etablissement["apikey"]);supabaseInit=createClient(racine_initiale.replace("/rest/v1/",""),api_initial.split("=")[1]);function afficher_conseil_de_classe(oui){if(oui){element_DOM("conseil_de_classes").style.display=""}else{charger_classe_conseil(false);element_DOM("conseil_de_classes").style.display="none"}}function charger_classe_conseil(oui){if(impossible_de_cliquer())return-1;if(oui){var classe=la_matiere_chargee("Classe");var mon_type=recuperer("mon_type").split("_")[0];if(mon_type.includes("Eleves")){var classe=JSON.parse(recuperer("mes_donnees"))["Classe"];var je_suis_delegue=JSON.parse(recuperer("mes_donnees"))["Est_d√©l√©gu√©"]?JSON.parse(recuperer("mes_donnees"))["Est_d√©l√©gu√©"]==="oui":false;var maintenant=moment().format("yyyy-MM-DD");if(maintenant==="2020-07-31")je_suis_delegue=true}if(classe){if(mon_type.includes("Admin")||mon_type.includes("Prof")||mon_type.includes("Eleves")&&je_suis_delegue){recuperer_la_fiche_conseil(classe)}else{recuperer_MA_fiche_conseil()}}}else{quitter_previsualisation()}}function recuperer_la_fiche_conseil(classe){var titre="Conseil de classe - "+classe;vider_fenetre(titre);afficher_fenetre(true);chargement(true);var url=racine_data+"Eleves?Classe=eq."+classe+"&"+apikey;liste_eleves=get_resultat(url);liste_eleves=liste_eleves.sort(function(a,b){if(a.Identifiant<b.Identifiant){return-1}if(a.Identifiant>b.Identifiant){return 1}return 0});var id_classe=JSON.parse(recuperer("mes_matieres")).find(e=>e["Classe"]===classe)["classe_id"];url=racine_data+"Fiches?id_classe=eq."+id_classe+"&"+apikey;$.ajax({url:url,type:"GET",success:function(data){chargement(false);data=data[0];afficher_fenetre_conseil_de_classe([[data["id_fiche"],data["nom_fiche"]],liste_eleves],titre,classe)},error:function(data){chargement(false);alert("V√©rifiez que vous √™tes toujours connect√© √† internet.")}})}function afficher_fenetre_conseil_de_classe(data,titre,classe){afficher_visualisation_fiche(data[0],titre);lister_les_eleves(data[1],classe)}function afficher_visualisation_fiche(id_et_nom_fiche,titre){if(id_et_nom_fiche){visualiser(id_et_nom_fiche[1],id_et_nom_fiche[0],"",titre,recuperer("mon_type").includes("Eleves"));$("#previsualisation")[0].style.height="50%"}}function lister_les_eleves(liste_eleves,classe){var liste_eleves_html='<div id="liste_eleves" class="liste_eleves_conseil"></div>';$("#liste_eleves").remove();$("#fenetre").append(liste_eleves_html);$("#liste_eleves")[0].scrollTo(0,0);liste_eleves.forEach(function(valeur,index){var identifiant_eleve=valeur["Identifiant"].toUpperCase();$("#liste_eleves").append('<b style="color: #FF6C00;margin-bottom: 5px;" id="'+identifiant_eleve+'">'+identifiant_eleve+" </b>");var identifiant_eleve_bloc=element_DOM(identifiant_eleve);var oeil_tableau_html='<span><img alt="voir" class="envoi_remarque mini-image" src="'+prefixe_image+'/img_previz.png" onclick="recuperer_details_plateforme(\''+identifiant_eleve+"')\"></span>";var oeil_tableau=document.createElement("div");oeil_tableau.innerHTML=oeil_tableau_html;while(oeil_tableau.firstChild)identifiant_eleve_bloc.appendChild(oeil_tableau.firstChild);var mon_type=recuperer("mon_type").split("_")[0];if(mon_type!=="Eleves"){var mode_edition_html='<span><img alt="remarque" class="envoi_remarque mini-image" src="'+prefixe_image+'/img_remarque.png" onclick="emettre_avis(\''+identifiant_eleve+"','"+classe+"')\"></span>";var mode_edition=document.createElement("div");mode_edition.innerHTML=mode_edition_html;while(mode_edition.firstChild)identifiant_eleve_bloc.appendChild(mode_edition.firstChild)}if(valeur["nombre_avis"]>0){var details_html='<span><img alt="autres avis" class="envoi_remarque mini-image" src="'+prefixe_image+'/img_details.png" onclick="recuperer_autres_avis(\''+identifiant_eleve+"')\"></span>";var details=document.createElement("div");details.innerHTML=details_html;while(details.firstChild)identifiant_eleve_bloc.appendChild(details.firstChild)}})}function recuperer_details_plateforme(identifiant_eleve){dupliquer_visualisation(identifiant_eleve);ajouter_bilan_a_la_fenetre();actualiser_bilan(identifiant_eleve)}function dupliquer_visualisation(identifiant_eleve){var fenetre_bis_html='<div class="ma_fenetre" id="fenetre_bis" style="visibility: visible; opacity:95%; top: 0px; left: 0px; width: 99%; height: 99%;"><div id="entete-fenetre" style="display: inline-flex;float: right;"><img alt="X" src="'+prefixe_image+'/quitter.png" id="bye_prev_bis" onclick="quitter_previsualisation_bis()" style="width: 30px; height: 30px; cursor: pointer; position: fixed; z-index: 3; top: 0px; left: 673px;"></div><div class="titre_fenetre" id="titre_fenetre_bis">D√©tails sur '+identifiant_eleve+'</div><div class="fullscreen-btn" id="conteneur_plein_ecran_bis"> <img alt="plein √©cran" style="position: fixed;" id="pleinecran_bis" src="'+prefixe_image+'/img_petitecran.png" onclick="switch_mode_bis()" class="pleinecran"> </div></div>';var fenetre_bis=document.createElement("div");fenetre_bis.innerHTML=fenetre_bis_html;while(fenetre_bis.firstChild){document.body.appendChild(fenetre_bis.firstChild)}ajuster_boutons_fenetre(true);initialisation_bouton(true);choisir_height_viz_si_pdf()}function ajouter_bilan_a_la_fenetre(){$("#viz1595565163988").remove();var tableau_html="<div class='tableauPlaceholder previz'  id='viz1595565163988' style='position: relative;'>    <noscript>        <a href='#'>            <img alt=' ' src='https:&#47;&#47;public.tableau.com&#47;static&#47;images&#47;H4&#47;H4GNP92BT&#47;1_rss.png' style='border: none' />        </a>    </noscript>    <object class='tableauViz'  style='display:none;'>        <param name='host_url' value='https%3A%2F%2Fpublic.tableau.com%2F' />        <param name='embed_code_version' value='3' />         <param name='site_root' value='' />        <param name='name' value='Bilanplateforme&#47lve' />        <param name='tabs' value='yes' />        <param name='toolbar' value='yes' />=        <param name='animate_transition' value='yes' />        <param name='display_static_image' value='no' />        <param name='display_spinner' value='yes' />        <param name='display_overlay' value='yes' />        <param name='display_count' value='yes' />        <param name='language' value='fr' />        <param id='filtre_identifiant' name='filter'/>    </object></div>   ";var tableau=document.createElement("div");tableau.innerHTML=tableau_html;var la_fenetre=element_DOM("fenetre_bis");la_fenetre.appendChild(tableau.firstChild)}function actualiser_bilan(identifiant_eleve){var divElement=element_DOM("viz1595565163988");var vizElement=divElement.getElementsByTagName("object")[0];element_DOM("filtre_identifiant").value="Identifiant="+identifiant_eleve;vizElement.style.width="100%";vizElement.style.height="100%";var scriptElement=document.createElement("script");scriptElement.src="https://public.tableau.com/javascripts/api/viz_v1.js";vizElement.parentNode.insertBefore(scriptElement,vizElement);$("#fenetre_bis")[0].style.display=""}function emettre_avis(identifiant_eleve,classe){var pop_up_html='<div id="mini_popup"><div id="entete-fenetre" style="display: inline-flex;float: right;"><img alt="X"  src="'+prefixe_image+'/quitter.png" id="bye_prev" onclick="$(\'#mini_popup\').remove()" style="width: 30px; height: 30px;cursor:pointer;position:fixed;z-index:3;transform: translate(-50%, -50%);"> </div><div>Vos observations sur <b>'+identifiant_eleve+'</b>:</div><textarea id="observation" style="width: 80%;resize: none;font-size: 13px;margin-bottom: 5%;"></textarea><div style="">Passage de <b>'+identifiant_eleve+'</b> en classe sup√©rieure:</div><select style="width: 80%;border-color: red;border-style: solid;margin-bottom: 5%;" id="avis_passage" value=""><option value=""></option><option value="Favorable">Favorable</option><option value="Non favorable">Non favorable</option></select><button type="button" class="rendre" onclick="envoyer_avis_conseil(\''+identifiant_eleve+"','"+classe+"')\">Envoyer l'avis</button></div>";var pop_up=document.createElement("div");pop_up.innerHTML=pop_up_html;while(pop_up.firstChild)document.body.appendChild(pop_up.firstChild);$("#avis_passage").on("change",function(e){if(e.target.value==="Favorable"){$("#avis_passage")[0].style.borderColor="green"}else{$("#avis_passage")[0].style.borderColor="red"}})}function envoyer_avis_conseil(identifiant_eleve,classe){var avis_passage=$("#avis_passage")[0].value;var observation=$("#observation")[0].value;if(avis_passage==="")return-1;var matieres=JSON.parse(recuperer("mes_matieres"));var mon_type=recuperer("mon_type").split("_")[0];if(mon_type.includes("Eleves"))var classe=JSON.parse(recuperer("mes_donnees"))["Classe"];var id_classe_eleve="";var ma_matiere="";matieres.some(function(valeur,index){if(valeur["Classe"]===classe){id_classe_eleve=valeur["classe_id"];ma_matiere=valeur["Matiere"];return-1}});var identifiant_courant=recuperer("identifiant_courant").toLowerCase().trim();identifiant_eleve=identifiant_eleve.toLowerCase().trim();nouvel_avis_conseil={Classe:classe,id_classe_eleve:id_classe_eleve,avis_passage:avis_passage,identifiant_remarque:identifiant_courant,identifiant_eleve:identifiant_eleve,observation:observation,matiere:ma_matiere,horodateur:maintenant()};ajouter_un_element("Conseil",nouvel_avis_conseil).then(()=>{url=racine_data+"Eleves?Identifiant=eq."+identifiant_eleve+"&"+apikey;nb_actuel=get_resultat(url)[0]["nombre_avis"];nouvelle_donnee_eleve={nombre_avis:nb_actuel+1};actualiser("Eleves","Identifiant",identifiant_eleve,nouvelle_donnee_eleve).then(()=>{$("#mini_popup").remove();recuperer_la_fiche_conseil(classe);chargement(false)})})}async function recuperer_autres_avis(identifiant_eleve){var resultats=await rechercher("Conseil","identifiant_eleve",identifiant_eleve.toLowerCase(),"");if(resultats.length>0)afficher_toutes_les_observations(resultats,identifiant_eleve)}function afficher_toutes_les_observations(les_observations,identifiant_eleve){$("#ensemble_observations").remove();var ensemble_observations_html="<div id='ensemble_observations'></div>";var ensemble_observations=document.createElement("div");ensemble_observations.innerHTML=ensemble_observations_html;element_DOM(identifiant_eleve).appendChild(ensemble_observations.firstChild);les_observations=les_observations.sort(function tri_ordre_chrono_decroissant(a,b){return convertir_en_date(a.horodateur)-convertir_en_date(b.horodateur)});les_observations.forEach(function(valeur,index){var signe_avis_passage=valeur["avis_passage"]==="Favorable"?"‚úÖ":"‚ùå";var vient_de_moi=valeur["identifiant_remarque"].toUpperCase()===recuperer("identifiant_courant").toUpperCase()?" (Vous)":valeur["matiere"]?" ("+valeur["matiere"]+")":"";une_observation='<div style="color:black;font-size:10px;padding:5px;">'+signe_avis_passage+'<b style="color:#FF6C00;">'+valeur["identifiant_remarque"].toUpperCase()+vient_de_moi+": </b>"+valeur["observation"]+'<i style="color: #bfbfbf;"> '+afficher_date(valeur["horodateur"])+"  </i></div>";$("#ensemble_observations").append(une_observation)})}function recuperer_MA_fiche_conseil(){var identifiant_eleve=recuperer("identifiant_courant").trim().toUpperCase();element_DOM("fenetre").style.overflowY="auto";vider_fenetre("Vos r√©sultats");$("#fenetre").append('<div style="text-align:center;margin-top: 20px;margin-left: 20px;"><b style="color: #FF6C00;margin-bottom: 5px;" id="'+identifiant_eleve+'">'+identifiant_eleve+" </b></div>");var identifiant_eleve_bloc=element_DOM(identifiant_eleve);var oeil_tableau_html='<span><img alt="voir"  class="envoi_remarque mini-image" src="'+prefixe_image+'/img_previz.png" onclick="recuperer_details_plateforme(\''+identifiant_eleve+"')\"></span>";var oeil_tableau=document.createElement("div");oeil_tableau.innerHTML=oeil_tableau_html;while(oeil_tableau.firstChild)identifiant_eleve_bloc.appendChild(oeil_tableau.firstChild);recuperer_autres_avis(identifiant_eleve);afficher_fenetre(true)}function aide_devoirs(){alerte="CONSIGNES POUR METTRE EN LIGNE UN DEVOIR: \n";alerte=alerte+"‚Ä¢ Pour un quiz, il suffit dy r√©pondre en ligne et d'enregistrer vos r√©ponses. Une fois tout valid√©, vous ne pourrez plus modifier vos r√©ponses.\n";alerte=alerte+'‚Ä¢ Vous pouvez rendre uniquement un devoir lorsque l\'enseignant a cat√©goris√© un fichier de "Devoir" ou "Examen".\n';alerte=alerte+"‚Ä¢ Pour rendre un devoir, choisissez le sujet que l'enseignant aura mis en ligne.\n";alerte=alerte+"‚Ä¢ Pour un m√™me devoir, si vous avez plusieurs images, cliquez sur 'Ajouter une page' et choissisez le fichier IMAGE √† rajouter.\n";alerte=alerte+"‚Ä¢ V√©rifiez bien l'ordre des images car cela sera pris en compte dans l'image finale g√©n√©r√©e, que pouvez voir en aper√ßu ci-dessous.\n";alerte=alerte+"‚Ä¢ Si vous √™tes sur ordinateur, vous pouvez √©galement cr√©er un fichier word et y coller toutes vos images. Les fichiers word (doc / docx) sont √©galement support√©s par Sekooly.";alert(alerte)}function afficher_tous_les_fichiers_deja_recup(){$("#alerte_vide").remove();afficher_le_drive(true);Array.from($(".span_un_fichier")).forEach(function(valeur,index,array){element_DOM(valeur.id).style.display="grid"});Array.from(document.getElementsByClassName("ma_liste")).forEach(function(valeur,index,array){element_DOM(valeur.id).style.display="grid"});Array.from($(".titre_drive")).forEach(function(valeur,index,array){element_DOM(valeur.id).style.display="initial"});return 0}function afficher_fenetre_rendudevoir(oui){if(oui){element_DOM("rendu_devoir").style.visibility="visible";initialisation_choix_devoir()}else{element_DOM("rendu_devoir").style.visibility="hidden"}}function initialisation_choix_devoir(){supprimer_div_devoir_choisi();supprimer_rendus_devoirs_affiches();element_DOM("soumettre_devoir").style.display="none";$("#remarque_prof").remove();$("#note_rendu").remove();les_devoirs=element_DOM("drive_devoirs").childNodes;les_examens=element_DOM("drive_examens").childNodes;les_quiz=element_DOM("drive_quiz").childNodes;la_liste_devoirs=element_DOM("devoir_choisi");la_liste_devoirs.innerHTML='<option value="--">--</option>';element_DOM("devoir_choisi").style.borderColor="";for(var i=0;i<les_devoirs.length;i++){var id_devoir=les_devoirs[i]["id"];var nom_fichier=$("span#"+id_devoir+".span_un_fichier").contents().filter(function(){return this.nodeType==3})[0].nodeValue;var un_devoir_html='<option value="'+id_devoir+'">'+nom_fichier+"</option>";var un_devoir=document.createElement("div");un_devoir.innerHTML=un_devoir_html;la_liste_devoirs.appendChild(un_devoir.firstChild)}for(var i=0;i<les_examens.length;i++){var id_examen=les_examens[i]["id"];var nom_fichier=$("span#"+id_examen+".span_un_fichier").contents().filter(function(){return this.nodeType==3})[0].nodeValue;var un_examen_html='<option value="'+id_examen+'" examen="oui">'+nom_fichier+"</option>";var un_examen=document.createElement("div");un_examen.innerHTML=un_examen_html;la_liste_devoirs.appendChild(un_examen.firstChild)}for(var i=0;i<les_quiz.length;i++){var id_quiz=les_quiz[i]["id"];var nom_fichier=$("span#"+id_quiz+".span_un_fichier").contents().filter(function(){return this.nodeType==3})[0].nodeValue;var un_examen_html='<option value="'+id_quiz+'">'+nom_fichier+"</option>";var un_examen=document.createElement("div");un_examen.innerHTML=un_examen_html;la_liste_devoirs.appendChild(un_examen.firstChild)}$("#devoir_choisi").on("change",function(e){supprimer_div_devoir_choisi();supprimer_rendus_devoirs_affiches();afficher_soumettre_devoir(false);changer_couleur_devoir("");$("#remarque_prof").remove();$("#note_rendu").remove();if(recuperer("mon_type")==="Eleves"){if(e.target.value!=="--"){var est_examen=e.target.options[e.target.selectedIndex].getAttribute("examen");var date_debut=$("[id="+e.target.value+"].span_un_fichier")[0].attributes["ma_date_effet"].value;var heure_debut=$("[id="+e.target.value+"].span_un_fichier")[0].attributes["mon_heure_effet"].value;nb_heures_delai_examen=data_etablissement["nb_heures_delai_examen"]||12;var date_fin=moment(date_debut+" "+heure_debut,"yyyy-MM-DD hh:mm").add(nb_heures_delai_examen,"hours")._d;var examen_termin√©=est_examen&&moment(maintenant())>date_fin;if(est_examen==="oui"&&fichier_ouvrable(e.target.value,false)===false&&examen_termin√©===false){alert("Vous ne pouvez pas encore rendre cet examen dont la date d'effet est le "+afficher_date_old(date_debut,true));e.target.value="--"}else{recuperer_mon_devoir(e.target.value,recuperer("identifiant_courant"),examen_termin√©,date_fin)}$("#bouton_rendre_devoir")[0].innerText=est_examen==="oui"?"Rendre l'examen":"Rendre le devoir"}}else{if(e.target.value!=="--"){recuperer_mon_devoir(e.target.value,"")}}})}function recuperer_mon_devoir(id_fichier_sujetdevoir,proprietaire,examen_termin√©,date_fin){chargement(true);supprimer_div_devoir_choisi();supprimer_rendus_devoirs_affiches();afficher_soumettre_devoir(false);changer_couleur_devoir("");$("#remarque_prof").remove();$("#note_rendu").remove();if(recuperer("mon_type")==="Eleves"){element_DOM("rendu_devoir").style.height="";rechercher("Rendus","id_devoir",id_fichier_sujetdevoir+suite_notif(),"").then(snapshot=>{chargement(false);donnees_initiales=snapshot[0];if($("#devoir_choisi")[0].value!==id_fichier_sujetdevoir)return-1;if(donnees_initiales!==undefined){data=donnees_initiales["nom_fichier"];extension=data.split(".").pop();remarque=donnees_initiales["remarque"];id_fichier=extension==="quiz"?donnees_initiales["id_fichier_sujetdevoir"]:donnees_initiales["id_fichier"];changer_couleur_devoir("green");afficher_soumettre_devoir(false);supprimer_div_devoir_choisi();supprimer_rendus_devoirs_affiches();var mon_devoir_rendu=document.createElement("div");var titre=rfc3986EncodeURIComponent(data);var suppression_devoir=examen_termin√©?"":'<img alt="supprimer"  id="'+data+'" src="'+prefixe_image+'/img_trash.png" style="width:15px;height:15px;cursor:pointer;" onclick="supprimer_devoir(this)">';var remarque_non_termine=donnees_initiales["date_publication"]===null?"  <i><gris>non termin√©</gris></i>  ":"";mon_devoir_rendu.innerHTML+='<div id="mon_devoir_rendu"> <div id="'+id_fichier+'">'+data+'<img class="mini-image" onclick="visualiser(\''+titre+"','"+id_fichier+'\')" src="'+prefixe_image+'/img_previz.png" style="padding-left:1%">'+suppression_devoir+remarque_non_termine+"</div></div>";$("#rendu_devoir").append(mon_devoir_rendu.innerHTML);note_rendu=donnees_initiales["note_rendu"];if(note_rendu!==null){$("#note_rendu").remove();remarque=decodeURIComponent(remarque);var remarque_innerHTML='<div id="note_rendu" style="text-align: justify;padding: 2%;"><b style="color: #cc3a22;">Note attribu√©e:</b><br>'+note_rendu+"</div>";var remarque_div=document.createElement("div");remarque_div.innerHTML=remarque_innerHTML;element_DOM("rendu_devoir").appendChild(remarque_div.firstChild)}if(remarque.length>0){$("#remarque_prof").remove();remarque=decodeURIComponent(remarque);var remarque_innerHTML='<div id="remarque_prof" style="text-align: justify;padding: 2%;"><b style="color: #cc3a22;">Remarque du professeur:</b><br>'+remarque+"</div>";var remarque_div=document.createElement("div");remarque_div.innerHTML=remarque_innerHTML;element_DOM("rendu_devoir").appendChild(remarque_div.firstChild)}}else{if(examen_termin√©){alert("Rendre cet examen n'est plus possible depuis le "+moment(date_fin).format("DD/MM/YYYY HH:mm")+".")}else{changer_couleur_devoir("red");supprimer_div_devoir_choisi();supprimer_rendus_devoirs_affiches();gerer_affichage_quiz_devoir(id_fichier_sujetdevoir)}}})["catch"](error=>{console.error(error);alert("Sujet de devoir introuvable.");chargement(false)})}else{rechercher("Rendus","id_fichier_sujetdevoir",id_fichier_sujetdevoir,"").then(snapshot=>{snapshot=snapshot.filter(e=>e["date_publication"]);chargement(false);afficher_rendus_devoirs(snapshot)})}$("#recuperer_devoir").remove()}function gerer_affichage_quiz_devoir(id_fichier_sujetdevoir){var est_quiz=$('[value="'+id_fichier_sujetdevoir+'"]').text().split(".").pop()==="quiz";if(est_quiz&&!element_DOM("mon_devoir_rendu")){element_DOM("soumettre_devoir").style.display="none";element_DOM("soumettre_quiz").style.display="block"}else{element_DOM("soumettre_quiz").style.display="none";element_DOM("soumettre_devoir").style.display=""}}function nom_du_devoir_choisi(){return $('[value="'+element_DOM("devoir_choisi").value+'"]').text()}function afficher_rendus_devoirs(resultats){if(!element_DOM("liste_des_devoirs_rendus")){var liste_des_devoirs_rendus=document.createElement("div");liste_des_devoirs_rendus.id="liste_des_devoirs_rendus";element_DOM("rendu_devoir").appendChild(liste_des_devoirs_rendus)}else{var liste_des_devoirs_rendus=element_DOM("liste_des_devoirs_rendus")}if(resultats.length===0)element_DOM("rendu_devoir").style.height="auto";if(resultats.length===0)return liste_des_devoirs_rendus.innerHTML='<i style="color: #bfbfbf;">Pas encore de rendus pour ce devoir/examen/quiz.</i>';resultats.sort(function tri_ordre_chrono_decroissant(a,b){return new Date(a[0]).getTime()-new Date(b[0]).getTime()});liste_des_devoirs_rendus.innerHTML="";var est_quiz=nom_du_devoir_choisi().split(".").pop()==="quiz";for(var i=0;i<resultats.length;i++){var un_devoir_rendu=document.createElement("div");un_devoir_rendu.id=resultats[i]["id_fichier"];un_devoir_rendu.style="padding: 0.5%;";un_devoir_rendu.innerHTML="Devoir de ";un_devoir_rendu.innerHTML+='<b style="color: #FF6C00;" id="proprietaire'+resultats[i]["id_fichier"]+'">'+resultats[i]["proprietaire"].toUpperCase()+" </b>";var remarque=decodeURIComponent(resultats[i]["remarque"]);remarque=JSON.stringify(remarque).replace(/&/,"&amp;").replace(/"/g,"");remarque=remarque.replace(/'/g,"\\'");if(remarque.length>0){note_si_existante=resultats[i]["note_rendu"]?resultats[i]["note_rendu"]+"\n\n":"";un_devoir_rendu.innerHTML+='<span id="correction_ok"><span class="correction_ok" style="font-size: 8px;color: #5ac55a;font-weight: bold;font-style: italic;" onmouseover="afficher_mon_indication(this)" onmouseout="masquer_mon_indication(this)">Corrig√©</span><span class="indication" style="margin-top:5%;">'+note_si_existante+remarque+"</span></span>"}var titre=rfc3986EncodeURIComponent(resultats[i]["nom_fichier"].trim());var nom_proprio_devoir=" ("+resultats[i]["proprietaire"].trim().toUpperCase()+")";var coefficient_rendu=resultats[i]["coefficient_rendu"];var note_rendu=resultats[i]["note_rendu"];un_devoir_rendu.innerHTML+='<img alt="voir"  class="mini-image" src="'+prefixe_image+'/img_previz.png" onclick="visualiser(\''+titre+"','"+un_devoir_rendu.id+"', '"+nom_proprio_devoir+"')\">";un_devoir_rendu.innerHTML+='<img alt="remarque" class="mini-image envoi_remarque" onclick="mettre_remarque_devoir(this,\''+remarque+"',"+coefficient_rendu+","+note_rendu+');" src="'+prefixe_image+'/img_remarque.png">';un_devoir_rendu.innerHTML+=est_quiz?"":'<a   id="telechargement" href = "https://drive.google.com/uc?export=download&id='+un_devoir_rendu.id+'" download="mon_fichier.txt"><img alt="t√©l√©charger" class="mini-image" src="'+prefixe_image+'/img_download.png"></a>';un_devoir_rendu.innerHTML+='<i style="color: #bfbfbf;">'+afficher_date(resultats[i]["date_publication"])+"  </i>";liste_des_devoirs_rendus.appendChild(un_devoir_rendu)}if(element_DOM("rendu_devoir").offsetHeight>screen.height){element_DOM("rendu_devoir").offsetHeight="90%"}}function mettre_remarque_et_note(id_fichier,remarque,coefficient_rendu,note_rendu){$("#remarque_et_note").remove();html_a_ajouter=fenetre_remarque_note(id_fichier,note_rendu?note_rendu:0,remarque);$("body").append(html_a_ajouter);if(Number(coefficient_rendu)===0){$("#champ_note").remove()}$("#envoyer_note").on("click",function(e){if(Number(coefficient_rendu)>0)note_rendu=$("#note_rendu")[0].value;remarque_prof=$("#remarque")[0].value;$("#remarque_et_note").remove();chargement(true);remarque_prof=encodeURIComponent(remarque_prof);nom_table="Rendus";nom_champ_reference="id_fichier";valeur_champ_reference=id_fichier;if(Number(coefficient_rendu)>0){nouvelle_remarque={note_rendu:note_rendu,remarque:remarque_prof}}else{nouvelle_remarque={remarque:remarque_prof}}actualiser(nom_table,nom_champ_reference,valeur_champ_reference,nouvelle_remarque);if(remarque_prof.length>0){nouvelles_donnees_notif={Date_derniere_modif:maintenant(),Identifiant_derniere_modif:recuperer("identifiant_courant"),Role_derniere_modif:mon_role};var valeur_proprio_devoir=$("#proprietaire"+id_fichier)[0].innerText;var id_notif=$("#devoir_choisi")[0].value+"-"+valeur_proprio_devoir.trim().toLowerCase().replace(".","");actualiser("Notifs","id_notif",id_notif,nouvelles_donnees_notif)}setTimeout(function(){quitter_previsualisation();quitter_previsualisation_bis();recuperer_mon_devoir(element_DOM("devoir_choisi").value)},2e3);chargement(false)})}function fenetre_remarque_note(id_fichier,note_rendu,remarque){nom_proprio_devoir=$("#proprietaire"+id_fichier)[0].innerText.trim().toUpperCase();return'<div class="ma_fenetre" id="remarque_et_note" style="visibility: visible;height: 33%;width: 280px;height: 300px;top: 35%;left: 10%;"><b style="text-align: center;"><div id="titre_fenetre" class="">Note et remarque de '+nom_proprio_devoir+' </div></b><span style=""><form id="mon_formulaire" autocomplete="off" class="edition">\t<div id="champ_note"><label id="label" for="note_rendu">Note (sur 20)</label><input type="number" min=0 max=20 step=0.125 id="note_rendu" maxlength="2" style="width: 100%;" value="'+note_rendu+'"></div><br><label id="label" for="remarque">Votre remarque</label><textarea id="remarque" maxlength="300" style="width: 100%;resize: none;font-size: 13px;height: 50%;">'+remarque+'</textarea><div id="mes_boutons" style="text-align: center;padding: 1%;display: block ruby;"><button class="bouton_sekooly" type="button" id="Annuler" onclick="$(\'#remarque_et_note\').remove()"> Annuler </button><button  class="bouton_sekooly" type="button" id="envoyer_note">Valider</button></div></form></span></div>'}function mettre_remarque_devoir(ceci,remarque,coefficient_rendu,note_rendu){var remarque_decoodee=remarque.replace(/&quot;/g,'"');remarque_decoodee=decodeURIComponent(remarque_decoodee);var id_fichier=ceci.parentNode.id;var id_prof=recuperer("identifiant_courant");var remarque_note_prof=mettre_remarque_et_note(id_fichier,remarque_decoodee,coefficient_rendu,note_rendu)}async function supprimer_devoir(moi,id_fichier_donn√©,id_devoir_donn√©){if(id_fichier_donn√©){var id_fichier=id_fichier_donn√©}else{var id_fichier=moi.parentNode.id}var id_devoir=$("#devoir_choisi")[0].value+suite_notif();if(id_devoir_donn√©)id_devoir=id_devoir_donn√©;if(id_fichier_donn√©||id_devoir_donn√©){var accepter_suppression=true}else{var accepter_suppression=window.confirm("√ätes vous s√ªr de vouloir supprimer ce rendu de devoir?")}if(!accepter_suppression)return-1;stocker("id_devoir",id_devoir);chargement(true);if(nom_du_devoir_choisi().split(".").pop()==="quiz"){return await suppression_devoir_sur_db("Votre tentative du quiz a √©t√© supprim√©e.")}var lien_script="https://script.google.com/macros/s/AKfycbw_04bdiepfQ0P9Ddtn6nyRPjxzxumORN4J8xm7bnmu7yO3HvQ/exec";var bon_API=id_fichier_donn√©||id_devoir_donn√©?"API_KEY_DELETE":"API_KEY_DEVOIR";var html='<form method="post"  action="'+lien_script+'" id="supprimer_devoir" style="display: none;" >';html+='<input type="hidden" name="'+bon_API+'" value="'+recuperer(bon_API)+'" >';html+='<input type="hidden" name="id_fichier" value="'+id_fichier+'" >';html+="</form>";$("body").append(html);var form=$("#supprimer_devoir");$.ajax({type:"POST",url:lien_script,data:form.serialize(),success:suppression_devoir_sur_db,error:erreur_suppression_devoir});$("#supprimer_devoir").remove()}async function suppression_devoir_sur_db(data){var id_devoir=recuperer("id_devoir");await supprimer("Rendus","id_devoir",id_devoir);await supprimer("Notifs","id_notif",id_devoir);effacer("id_devoir");afficher_alerte(data);setTimeout(function(){return recuperer_mon_devoir(element_DOM("devoir_choisi").value,recuperer("identifiant_courant"));chargement(false)},2e3)}function supprimer_div_devoir_choisi(){$(".mon_file_devoir").each(function(index,un_fichier_devoir){un_fichier_devoir.value=""});if(element_DOM("mon_devoir_rendu"))element_DOM("mon_devoir_rendu").remove()}function erreur_suppression_devoir(data){console.error(data);alert("Impossible de supprimer le rendu: v√©rifiez que vous √™tes toujours connect√©.");chargement(false)}function supprimer_rendus_devoirs_affiches(){if(element_DOM("liste_des_devoirs_rendus"))element_DOM("liste_des_devoirs_rendus").remove();vider_previz_devoir_rendu();$(".fichier_supplementaire").remove()}function afficher_soumettre_devoir(oui){if(oui){element_DOM("soumettre_devoir").style.display=""}else{element_DOM("soumettre_devoir").style.display="none";element_DOM("soumettre_quiz").style.display="none"}}function changer_couleur_devoir(couleur){element_DOM("devoir_choisi").style.borderColor=couleur}function rendre_devoir(){if(impossible_de_cliquer())return-1;var le_devoir_choisi=$("#devoir_choisi")[0].value;var le_fichier_choisi=$("#file_devoir")[0].value;if(le_devoir_choisi!=="--"&&le_fichier_choisi!==""){var file=$("#file_devoir")[0].files[0];var fr=new FileReader;fr.onprogress=function(e){chargement(true)};chargement(true);fr.onload=async function(e){var lien_script=await chercher_lien_script(4);var params={};if($("#soumettre_devoir > input").length>1){img_finale=await telecharger_tout(true);img_finale=img_finale.replace(/^.*,/,"");if(!img_finale){chargement(false);return false}else{params.file=img_finale}}else{params.file=e.target.result.replace(/^.*,/,"")}nom_fichier=file.name;coefficient_rendu=Number($("#"+le_devoir_choisi)[0].getAttribute("coefficient_rendu"));taille_fichier=file.size;extension=nom_fichier.split(".").pop().toUpperCase();id_dossier_sujetdevoir=recuperer("dossier_charg√©");id_fichier_sujetdevoir=le_devoir_choisi;proprietaire=recuperer("identifiant_courant");mettre_devoir_en_ligne(lien_script,params,nom_fichier,extension,id_dossier_sujetdevoir,id_fichier_sujetdevoir,proprietaire,coefficient_rendu,taille_fichier)};fr.readAsDataURL(file)}}function mettre_devoir_en_ligne(lien_script,params,nom_fichier,extension,id_dossier_sujetdevoir,id_fichier_sujetdevoir,proprietaire,coefficient_rendu,taille_fichier){var html='<form method="post"  action="'+lien_script+'" id="form_rendu_devoir" style="display: none;" >';html+='<input type="hidden" name="API_KEY_DEVOIR" value="'+recuperer("API_KEY_DEVOIR")+'" >';html+='<input type="hidden" name="nom_fichier" value="'+nom_fichier+'" >';html+='<input type="hidden" name="extension" value="'+extension+'" >';html+='<input type="hidden" name="file" value="'+params.file+'" >';html+='<input type="hidden" name="dossier_rendus_cycle" value="'+recuperer("dossier_rendus_cycle")+'" >';html+='<input type="hidden" name="proprietaire" value="'+proprietaire+'" >';html+="</form>";$("body").append(html);$("#form_rendu_devoir").submit(function(e){e.preventDefault();var form=$(this);var url=form.attr("action");$.ajax({type:"POST",timeout:6e5,url:url,data:form.serialize(),success:function(data){if(data.includes("ERREUR")){afficher_alerte(data,false);return-1}setTimeout(function(){recuperer_mon_devoir(element_DOM("devoir_choisi").value,recuperer("identifiant_courant"))},2e3);date_heure_actuelle=maintenant();nom_table="Rendus";id_devoir=id_fichier_sujetdevoir+suite_notif();la_matiere=la_matiere_chargee("Matiere");nouveau_devoir={id_devoir:id_devoir,date_publication:date_heure_actuelle,id_dossier_sujetdevoir:id_dossier_sujetdevoir,id_fichier_sujetdevoir:id_fichier_sujetdevoir,id_fichier:data,nom_fichier:nom_fichier,proprietaire:recuperer("identifiant_courant"),remarque:"",matiere_rendue:la_matiere,coefficient_rendu:coefficient_rendu,taille_fichier:taille_fichier};ajouter_un_element(nom_table,nouveau_devoir,id_devoir);nom_table="Notifs";mes_donnees=JSON.parse(recuperer("mes_donnees"));nouvelle_notif={id_notif:id_devoir,Horodateur:date_heure_actuelle,Type_notif:"devoir",Id_source:id_fichier_sujetdevoir,"Intitul√©":nom_fichier,Identifiant_originaire:recuperer("identifiant_courant"),Role_originaire:"Eleve",Identifiant_derniere_modif:recuperer("identifiant_courant"),Role_derniere_modif:"Eleve",Classe:mes_donnees["Classe"],Classe_matiere:"("+mes_donnees["Classe"]+"|"+la_matiere+")",Id_classe_matiere:recuperer("dossier_charg√©"),Date_derniere_modif:date_heure_actuelle,Cycle:mes_donnees["Cycle"]};ajouter_un_element(nom_table,nouvelle_notif,id_devoir);afficher_alerte("Votre rendu a bien √©t√© mis en ligne.",false);chargement(false)},error:function(data){chargement(false);data=JSON.parse(data);console.error(data);afficher_alerte("Votre fichier est trop lourd √† mettre en ligne, merci de r√©duire leur taille avant de les mettre en ligne.",false)},done:function(data){chargement(false)}})});$("#form_rendu_devoir").submit();$("#form_rendu_devoir").remove()}function retourner_site(){vider_fenetre("Sekooly");visualiser("Tutoriels d'utilisation.docx","1HnsoX5_NQGhJ34WZ68p9SPvZ30jn4gKpf_cQjz2ZyUo",false,"Tutoriels d'utilisation");$("#telechargement").remove();afficher_fenetre(true)}function afficher_alerte(contenu,actualiser){var msg_alerte=element_DOM("snackbar");msg_alerte.innerHTML=contenu;msg_alerte.className="show";setTimeout(function(){msg_alerte.className="";if(actualiser)location.reload()},3e3)}function afficher_modif_profil(){quitter_previsualisation();vider_fenetre("Votre profil");var mes_donnees=JSON.parse(recuperer("mes_donnees"));var ma_photo_de_profil=mon_detail("Photo de profil",ma_photo());var mon_niveau_XP=mon_detail("Niveau XP",calculer_mes_XP());var mes_details_identifiant=mon_detail("Identifiant",mes_donnees["Identifiant"]);var mes_details_nom=mon_detail("Nom",mes_donnees["Nom"]);var mes_details_prenoms=mon_detail("Pr√©nom(s)",mes_donnees["Pr√©nom(s)"]);var mon_type=recuperer("mon_type");var mon_type_ou_role=mon_type.includes("Admin")?mes_donnees["Role"]:mon_type.substring(0,mon_type.length-1);var mes_details_type=mon_detail("R√¥le du profil",mon_type_ou_role);var mes_classes=mes_donnees["Classe"].replace(/;/g,"<br>");mes_classes=mes_classes.replace(/\(/g,"");mes_classes=mes_classes.replace(/\)/g,"");mes_classes=mes_classes.replace(/\|/g,", ");var mes_details_classe=mon_detail("Classe(s)",mes_classes);var mes_details_contact=mon_detail("Telephone",mes_donnees["Telephone"]);var mes_details_code_acces=mon_detail("Code d'acc√®s",mes_donnees["Code"],true);var boutons='<span id="les_boutons" style="text-align: center;position: relative;display: block;"><button type="button" id="annuler_modifs" onclick="quitter_previsualisation()"> Annuler </button><button type="button" id="valider_modifs" onclick="switch_edition()">Enregistrer</button></span>';var details_profil_html='<div id="mes_details" class="mes_details">'+ma_photo_de_profil+mon_niveau_XP+mes_details_identifiant+mes_details_nom+mes_details_prenoms+mes_details_type+mes_details_classe+mes_details_contact+mes_details_code_acces+"</div>"+boutons;var details_profil=document.createElement("div");details_profil.innerHTML=details_profil_html;while(details_profil.firstChild)element_DOM("fenetre").appendChild(details_profil.firstChild);mode_edition(false,true);afficher_fenetre(true)}function bouton_supprimer_pp(identifiant_courant){identifiant_courant=identifiant_courant?identifiant_courant:recuperer("identifiant_courant");return'<img id="suppr_pp" onclick="supprimer_pp(\''+identifiant_courant+'\')" class="editer" src="'+prefixe_image+'/img_trash.png" alt="supprimer">'}function bouton_modifier_pp(identifiant_courant){identifiant_courant=identifiant_courant?identifiant_courant:recuperer("identifiant_courant");return'<span class="pp-upload"><label for="pp-'+identifiant_courant+'"><img src="'+prefixe_image+'/img_edit.png" alt="MODIFIER" class="editer"></label><input onchange="changer_pp(\''+identifiant_courant+'\')" accept=".png,.jpeg,.jpg,.bmp,.svg,.gif" id="pp-'+identifiant_courant+'" type="file"/> </span>'}function ma_photo(identifiant_optionnel,sans_bouton_modifier){chargement(true);var nom_table="Fichiers";url=racine_data+nom_table;url+="?proprietaire=eq."+(identifiant_optionnel||recuperer("identifiant_courant"));url+="&categorie_fichier=eq.Profil";url+="&"+apikey;id_pp=get_resultat(url)[0];if(id_pp)id_pp=id_pp["id_fichier"];le_lien_pp=lien_pp(id_pp);supprimer_si_pp_existante=id_pp?sans_bouton_modifier?"":bouton_supprimer_pp():"";bouton_modifier=sans_bouton_modifier?"":bouton_modifier_pp();chargement(false);return"<img class='pp' id='pp_"+(identifiant_optionnel||recuperer("identifiant_courant"))+"' src="+le_lien_pp+">"+bouton_modifier+supprimer_si_pp_existante}var basic_croppie;var donnees_pp;var extension_pp="";async function url_pp(){var res=await chercher_lien_script(8);return res}async function supprimer_pp(identifiant_courant,sans_confirmation){if(!sans_confirmation)var confirmation=confirm("‚ö†Ô∏èVoulez-vous supprimer cette photo de profil ? Cette action est irr√©versible.");if(confirmation||sans_confirmation){chargement(true);identifiant_courant=identifiant_courant?identifiant_courant:recuperer("identifiant_courant");var url=await url_pp();url+="?supp_mon_id_pp=true";url+="&nom_etablissement="+data_etablissement["nom_etablissement"];url+="&identifiant="+identifiant_courant;url+="&supp_mon_id_pp=true";return get_resultat_asynchrone(url).then(function(e){if(!sans_confirmation)afficher_alerte(e);nom_table="Fichiers";var url=racine_data+nom_table+"?proprietaire=eq."+identifiant_courant;url+="&categorie_fichier=eq.Profil";url+="&"+apikey;return delete_resultat_asynchrone(url).then(function(){$("[id='pp_"+identifiant_courant+"']")[0].src=prefixe_image+"/default-user.svg";$("#suppr_pp").remove();if(!sans_confirmation)chargement(false)})})}}function changer_pp(identifiant_courant){var reader=new FileReader;identifiant_courant=identifiant_courant?identifiant_courant:"";creer_mini_popup("","<div id='nouvelle_pp' style='overflow: hidden;width: 300px;height:300px;'></div>","Valider la photo","envoyer_pp('"+identifiant_courant+"')");basic_croppie=$("#nouvelle_pp").croppie({viewport:{width:200,height:200,type:"circle"},boundary:{width:300,height:200},enableExif:true});reader.onload=function(results){chargement(false);donnees=reader.result;basic_croppie.croppie("bind",{url:donnees,points:[77,469,280,739]})};extension_pp=$("[id='pp-"+identifiant_courant+"']")[0].files[0].name.split(".").pop();chargement(true);reader.readAsDataURL($("[id='pp-"+identifiant_courant+"']")[0].files[0])}async function envoyer_pp(identifiant_courant){chargement(true);url=await url_pp();identifiant_courant=identifiant_courant?identifiant_courant:recuperer("identifiant_courant");supprimer_pp(identifiant_courant,true).then(function(){basic_croppie.croppie("result",{type:"canvas",size:"viewport"}).then(function(resp){$("#mini_popup").remove();data={nom_etablissement:data_etablissement["nom_etablissement"],identifiant:identifiant_courant,API_KEY_UPLOAD:recuperer("API_KEY_UPLOAD"),API_KEY_DEVOIR:recuperer("API_KEY_DEVOIR"),extension:extension_pp,file:resp.replace(/^.*,/,"")};post_resultat_asynchrone(url,data).then(function(valeur){afficher_alerte(valeur.split("|")[0]);id_pp=valeur.split("|")[1].trim();date_heure_aujourdhui=maintenant();nom_table="Fichiers";mes_donnees={id_fichier:id_pp,categorie_fichier:"Profil",proprietaire:identifiant_courant,nom_fichier:identifiant_courant+"."+extension_pp,date_effet:moment(date_heure_aujourdhui).format("YYYY-MM-DD"),id_dossier:"pp",est_telechargeable:"non",date_publication:date_heure_aujourdhui,taille_fichier:$("[id='pp-"+identifiant_courant+"']")[0].files[0].size};var url=racine_data+nom_table+"?"+apikey;post_resultat_asynchrone(url,mes_donnees).then(function(){$("[id='pp_"+identifiant_courant+"']")[0].src=resp;if($("#suppr_pp").length===0)$("#Photo").append(bouton_supprimer_pp())});chargement(false)})})})}function calculer_mes_XP(){return"En cours de construction."}async function switch_edition(){var est_mode_edition=$("#valider_modifs")[0].innerText==="üíæ";if(!est_mode_edition){var mes_donnees=await recuperer_mes_donnees();var ancien_code=prompt("Indiquez votre code d'acc√®s ACTUEL:");if(!ancien_code)return afficher_alerte("Modification du profil annul√©e.");if(!mes_donnees)return afficher_alerte("Vous devez √™tre connect√© √† internet pour modifier votre profil.");if(code_ok(mes_donnees,ancien_code)){mode_edition(true)}else{if(ancien_code!==null)afficher_alerte("Le code d'acc√®s est erron√©, impossible de modifier votre profil.")}}else{nom_champ="Code";valeur_champ=hasher($("#Code")[0].value);nouveau_data={[nom_champ]:valeur_champ,code_hash:"ok"};mettre_a_jour(nom_champ,valeur_champ)}}function mettre_a_jour(mes_champs_str,mes_valeurs_champ_str){actualiser(recuperer("mon_type"),"Identifiant",recuperer("identifiant_courant"),nouveau_data);var mes_donnees=JSON.parse(recuperer("mes_donnees"));mes_champs_str.split(",").forEach(function(valeur,index){mes_donnees[valeur]=mes_valeurs_champ_str.split(",")[index]});stocker("mes_donnees",JSON.stringify(mes_donnees));afficher_alerte("Votre profil a √©t√© mis √† jour.");mode_edition(false);chargement(false)}function mode_edition(oui,initialement){if(!initialement){var mode=oui?"input":"";changer_element("Code",mode,true)}var texte_boutton=oui?"Enregistrer":"Modifier";$("#valider_modifs")[0].innerText=texte_boutton}function changer_element(id_element,type_element,est_mdp){var valeur_initiale_element=type_element==="input"?$("#"+id_element)[0].innerText:est_mdp?"‚Ä¢".repeat($("#"+id_element)[0].value.length):$("#"+id_element)[0].value;var mode_mdp=est_mdp?'type="password"':"";var element_final_html=type_element==="input"?'<input id="'+id_element+'" value="'+valeur_initiale_element+'" '+mode_mdp+">":'<span id="'+id_element+'">'+valeur_initiale_element+"</span>";var element_final=document.createElement("div");element_final.innerHTML=element_final_html;var parentElement=$("#"+id_element)[0].parentNode;$("#"+id_element).remove();while(element_final.firstChild)parentElement.appendChild(element_final.firstChild);if(type_element==="input"){$("#"+id_element)[0].value=JSON.parse(recuperer("mes_donnees"))["Code"];$("#"+id_element)[0].select();$("#"+id_element)[0].value="";$("#Code").keypress(function(e){if(e.charCode===13)switch_edition();if(e.charCode===38||e.charCode===44||e.charCode===39||e.charCode===34||e.charCode===32){afficher_alerte("Le symbole ' "+String.fromCharCode(e.charCode)+" ' est interdit.");return false}})}}function mon_detail(nom_detail,valeur_detail,mdp){if(mdp)valeur_detail="‚Ä¢".repeat(valeur_detail.length);var resultat='<div class="un_detail"><b style="color:#FF6C00">'+nom_detail+': </b><br><span id="'+nom_detail.split(" ")[0]+'">'+valeur_detail+"</span></div>";return resultat}function sur_mobile_ou_tablette(){return window.innerWidth<=750||window.innerHeight<=750}function filtrer_date_effet(){afficher_tous_les_fichiers_deja_recup();var condition_filtre=element_DOM("la_date_effet").value;$(".span_un_fichier").filter(function(valeur){var la_date=$(this)[0].attributes["ma_date_effet"].value;var date_contenue=la_date.includes(condition_filtre);$(this)[0].style.display=date_contenue||condition_filtre==="Tous"?"grid":"none";return $(this)[0].innerHTML.includes(condition_filtre)});afficher_le_drive(true);garder_les_manuels();masquer_drive_vide()}function filtrer_chapitre(){afficher_tous_les_fichiers_deja_recup();var condition_filtre=element_DOM("filtre_id_chapitre").value;$(".span_un_fichier").filter(function(index,valeur){var le_id_chapitre=$(this)[0].attributes["id_chapitre"].value;var id_ok=le_id_chapitre.includes(condition_filtre);var mode_affichage=id_ok||condition_filtre==="Tous"?"grid":"none";valeur.style.display=mode_affichage;return valeur.innerHTML.includes(condition_filtre)});afficher_le_drive(true);garder_les_manuels();masquer_drive_vide()}function rfc3986EncodeURIComponent(str){return encodeURIComponent(str).replace(/[!'()*]/g,escape)}function afficher_tri_fichiers(oui){element_DOM("span_date_effet").style.display=oui?"block":"none"}function afficher_visio(oui){element_DOM("visioconference").style.display=oui?"block":"none"}function afficher_choix_date(oui){if(oui){element_DOM("choix_date").style.display="grid"}else{element_DOM("choix_date").style.display="none"}}function afficher_choix_coef(oui){if(oui){element_DOM("coef_rendu").style.display=""}else{element_DOM("coef_rendu").style.display="none"}}function afficher_ou_non_choix_fichier(oui,forcing){if(impossible_de_cliquer()&&!forcing)return-1;if(oui&&!recuperer("mon_type").includes("Admin")&&element_DOM("accueil_utilisateur").innerText.includes("Vie scolaire")){alert("Vous n'avez pas les droits pour publier un fichier dans la Vie Scolaire.");return-1}image_temporaire="";nom_image_temporaire="";est_deja_affiche=element_DOM("choix_popup").style.visibility==="visible";if(est_deja_affiche||!oui){element_DOM("choix_popup").style.visibility="hidden";if(!forcing){afficher_choix_date(false);afficher_choix_coef(false)}}else{var autoriser_ajout_fichiers=true;if(!autoriser_ajout_fichiers){alert("Impossible de mettre en ligne des fichiers du lundi 1er au dimanche 7 Juin 2020.");return-1}afficher_fenetre(false);afficher_ou_non_choix_fichier(false);mode_bulletin(false);element_DOM("choix_popup").style.visibility="visible";element_DOM("file").value="";element_DOM("categorie_choisie").value="--";element_DOM("la_date_limite").value="";element_DOM("date_effet_fichier").value=moment().format("yyyy-MM-DD");element_DOM("heure_effet").value="";element_DOM("lheure_limite").value="";element_DOM("id_chapitre").value="--";element_DOM("est_video_youtube").checked=false;element_DOM("est_extrait_manuel").checked=false;element_DOM("est_telechargeable").checked=true;afficher_checkbox("choix_extrait_manuel",les_manuels_de_la_matiere()!=="");mode_fichier_initialement();element_DOM("coef").value=0;element_DOM("mode-non-quiz").style.display="grid";element_DOM("mode-quiz").style.display="none";afficher_choix_date(false);afficher_choix_coef(false)}}function afficher_mon_indication(moi){moi.parentNode.childNodes[1].style.visibility="visible"}function masquer_mon_indication(moi){moi.parentNode.childNodes[1].style.visibility="hidden"}function impossible_de_cliquer(){return element_DOM("img_chargement").style.visibility==="visible"}function deconnexion(){chargement(true);var ma_classe="";mon_role=init_mon_role();tout_effacer_sauf(["identifiant_courant","mode_nuit_oui","notifs_sans_actualiser","date_heure_depassement"]);image_temporaire="";nom_image_temporaire="";supprimer_tous_les_parametres();setTimeout(function(){location.href="/"},1e3);envoyer_log(recuperer("identifiant_courant"),"Deconnexion",ma_classe,mon_role)}function recuperer_devoirs(forcing){if(!recuperer("dossier_charg√©"))return-1;if(impossible_de_cliquer())return-1;afficher_fenetre(false);var est_deja_affiche=element_DOM("rendu_devoir").style.visibility==="visible";if(forcing)est_deja_affiche=false;afficher_fenetre_rendudevoir(!est_deja_affiche)}function afficher_devoirs(oui){if(oui){element_DOM("devoirs_a_rendre").style.visibility="visible"}else{element_DOM("devoirs_a_rendre").style.visibility="hidden"}}function trier_par_identifiant(a,b){var aName=a.Identifiant.toLowerCase();var bName=b.Identifiant.toLowerCase();return aName<bName?-1:aName>bName?1:0}function recuperer_profs(sans_fenetre){var mes_classes_matieres=JSON.parse(recuperer("mes_matieres")).map(e=>e["Classe_Matiere"]).sort();var snapshot=[];url=racine_data+"Trombinoscope_profs"+"?"+apikey;return get_resultat_asynchrone(url).then(function(resultats){var copie_resultats=resultats.sort(trier_par_identifiant);if(recuperer("mon_type")==="Eleves"){mes_classes_matieres.forEach(function(ma_classe_matiere,index_matiere){le_prof=copie_resultats.filter(e=>e["Classe"].includes(ma_classe_matiere));if(le_prof.length>0){le_prof.forEach(function(le_prof_actuel){a_ajouter=snapshot.filter(e=>e["Identifiant"]===le_prof_actuel["Identifiant"]).length===0;le_prof_actuel["Classe"]=ma_classe_matiere;if(a_ajouter)snapshot.push(le_prof_actuel)})}})}else{snapshot=copie_resultats}if(sans_fenetre){chargement(false);return snapshot}else{var titre_fenetre="Liste de vos professeurs";vider_fenetre(titre_fenetre);traitement_trombino(snapshot,true);afficher_fenetre(true)}})}function recuperer_admin(sans_fenetre){if(impossible_de_cliquer())return-1;chargement(true);var le_cycle=JSON.parse(recuperer("mes_donnees"))["Cycle"];nom_table="Trombinoscope_admin";nom_champ_reference="Cycle";valeur_champ_reference=le_cycle;nom_champ_a_chercher="";return rechercher(nom_table,nom_champ_reference,valeur_champ_reference,nom_champ_a_chercher).then(snapshot=>{if(sans_fenetre){chargement(false);return snapshot}else{var titre_fenetre="Membres de l'Administration - "+valeur_champ_reference;vider_fenetre(titre_fenetre);afficher_fenetre(true);traitement_trombino(snapshot,true,true);chargement(false)}})["catch"](error=>{console.error(error);alert("Cycle introuvable, veuillez r√©essayer.");chargement(false)})}function recuperer_eleves(sans_fenetre){if(impossible_de_cliquer())return-1;if(!recuperer("mon_type").includes("Admin")&&element_DOM("accueil_utilisateur").innerText.includes("Vie scolaire")){alert("Vous n'avez pas les droits pour consulter cette liste.");return-1}chargement(true);var classe=recuperer("mon_type").includes("Eleves")?JSON.parse(recuperer("mes_donnees"))["Classe"]:la_matiere_chargee("Classe");if(recuperer("mon_type")==="Administration"&&classe==="classe_matiere_introuvable")classe="Tous";var le_cycle=JSON.parse(recuperer("mes_donnees"))["Cycle"];nom_table="Trombinoscope";nom_champ_reference=classe==="Tous"?"Cycle":"Classe";valeur_champ_reference=classe==="Tous"?le_cycle:classe;nom_champ_a_chercher="";return rechercher(nom_table,nom_champ_reference,valeur_champ_reference,nom_champ_a_chercher).then(snapshot=>{if(sans_fenetre){chargement(false);return snapshot}else{var titre_fenetre="Liste des √©l√®ves en "+valeur_champ_reference;vider_fenetre(titre_fenetre);afficher_fenetre(true);traitement_trombino(snapshot,false);chargement(false)}})["catch"](error=>{console.error(error);alert("Classe introuvable, veuillez r√©essayer.");chargement(false)})}function recuperer_logs(){chargement(true);if(recuperer("mon_type")!=="Profs"){var classe=JSON.parse(recuperer("mes_donnees"))["Classe"];var nom_variable="logs_classe";var titre_fenetre="Historique des connexions"}else{var classe=la_matiere_chargee("Classe");var nom_variable="classe";var titre_fenetre="Liste des √©l√®ves en "+classe}vider_fenetre(titre_fenetre);var bouton_t√©l√©charger='<a id="telechargement" style="position: fixed;z-index:3;" href = "#"><img alt="t√©l√©charger" class="window-btn" id="telechargement" src="'+prefixe_image+'/img_download.png""></a>';var a_ajouter=document.createElement("div");a_ajouter.innerHTML=bouton_t√©l√©charger;while(a_ajouter.firstChild)element_DOM("entete-fenetre").appendChild(a_ajouter.firstChild);ajuster_boutons_fenetre();ajuster_boutons_fenetre(true);choisir_height_viz_si_pdf();afficher_fenetre(true);var lien_script="https://script.google.com/macros/s/AKfycbzEamQPPrrqUl-_ac8Ddqf0cfWq3hPqF1Z-5qJ0JI95w2ybULd8/exec";var html='<form method="post"  action="'+lien_script+'" id="recuperer_logs" style="display: none;" >';html+='<input type="hidden" name="'+nom_variable+'" value="'+classe+'" >';html+="</form>";$("body").append(html);var form=$("#recuperer_logs");$.ajax({type:"POST",url:lien_script,data:form.serialize(),success:function(data){traitement_logs(data["resultats"]);if(element_DOM("telechargement")){element_DOM("telechargement").onclick=function(e){var contenu_fichier=convertir_csv(data["resultats"]);contenu_fichier=encodeURIComponent(contenu_fichier);console.log(contenu_fichier);telecharger("Historique_des_connexions",contenu_fichier)}}$("#recuperer_logs").remove()},error:function(data){console.log("erreur! "+data);alert("V√©rifiez que vous √™tes toujours connect√© √† internet.");chargement(false)}})}function telecharger(nom_fichier,contenu_fichier){var element=document.createElement("a");element.style.display="none";element.setAttribute("href","data:text/csv;charset=utf-8,%EF%BB%BF"+contenu_fichier);element.setAttribute("download",nom_fichier+".csv");document.body.appendChild(element);element.click();document.body.removeChild(element)}var nombre_changement_ecolage=0;function traitement_trombino(resultats,sans_ecolage,avec_role){var liste_des_eleves=document.createElement("div");liste_des_eleves.id="liste_des_eleves";liste_des_eleves.className="liste_des_eleves";element_DOM("fenetre").appendChild(liste_des_eleves);resultats=resultats.filter(function(valeur,index){return valeur["Cycle"]===JSON.parse(recuperer("mes_donnees"))["Cycle"]});resultats.forEach(function(valeur,index){var ecolage_eleve="";var Droit_changer_ecolage=JSON.parse(recuperer("mes_donnees"))["Droit_changer_ecolage"]==="oui"&&recuperer("mon_type").includes("Admin");if(Droit_changer_ecolage&&!sans_ecolage)ecolage_eleve='<span class="toggle"><label class="switch"><input class="ecolage" id="'+valeur["Identifiant"]+'" type="checkbox"><span class="slider round"></span>\t</label></span>';var le_lien_pp=lien_pp(valeur["id_fichier"]);var bouton_modif=recuperer("mon_type").includes("Admin")?bouton_modifier_pp(valeur["Identifiant"]):"";var bouton_suppr=recuperer("mon_type").includes("Admin")&&!le_lien_pp.includes("default-user.svg")?bouton_supprimer_pp(valeur["Identifiant"]):"";var la_classe_utilisateur=!sans_ecolage?valeur["Classe"]:valeur["Classe"].split("|")[1].split(")")[0];if(avec_role)la_classe_utilisateur=valeur["Role"];var un_eleve='<div class="un_eleve"><img class="pp" id="pp_'+valeur["Identifiant"]+'" src='+le_lien_pp+">"+bouton_modif+bouton_suppr+'<div><span class="element_eleve">'+valeur["Nom"]+" "+valeur["Pr√©nom(s)"]+" <b>"+la_classe_utilisateur+"</b></span></div>"+ecolage_eleve+"</div>";var un_bloc_eleve=document.createElement("div");un_bloc_eleve.innerHTML=un_eleve;while(un_bloc_eleve.firstChild)liste_des_eleves.appendChild(un_bloc_eleve.firstChild);if(Droit_changer_ecolage&&!sans_ecolage){var check_ecolage=valeur["Ecolage_OK"]==="oui";element_DOM(valeur["Identifiant"]).checked=check_ecolage}});if(!sans_ecolage){$(".ecolage").on("change",function(e){nombre_changement_ecolage=nombre_changement_ecolage+1;chargement(true);var valeur_ecolage_ok=e.target.checked?"oui":"non";var maj_ecolage_ok={Ecolage_OK:valeur_ecolage_ok};var nom_table="Eleves";var nom_champ_reference="Identifiant";var valeur_champ_reference=e.target.id;actualiser(nom_table,nom_champ_reference,valeur_champ_reference,maj_ecolage_ok);chargement(false)})}element_DOM("titre_fenetre").innerHTML+=" ("+resultats.length+")";if(!recuperer("mon_type").includes("Administration")&&(recuperer("dossier_charg√©")===""||recuperer("dossier_charg√©")===null)&&!sans_ecolage)decharger_dossier_final()}function tri_ordre_chrono_decroissant(a,b){return new Date(b.Horodateur).getTime()-new Date(a.Horodateur).getTime()}function traitement_logs(resultats){var liste_des_logs=document.createElement("div");liste_des_logs.style.position="relative";liste_des_logs.style.overflowX="hidden";liste_des_logs.style.overflowY="auto";liste_des_logs.id="liste_des_logs";liste_des_logs.style.height="90%";element_DOM("fenetre").appendChild(liste_des_logs);resultats.sort(tri_ordre_chrono_decroissant);resultats.forEach(function(valeur,index){var date=afficher_date(valeur["Horodateur"]);var un_log='<div style="padding-left: 2%;padding-bottom: 2%;">'+valeur["Statut"]+" le "+date+" "+valeur["Identifiant"]+" </div>";var un_bloc_log=document.createElement("div");un_bloc_log.innerHTML=un_log;while(un_bloc_log.firstChild)liste_des_logs.appendChild(un_bloc_log.firstChild)});if(element_DOM("titre_fenetre")==="Historique des connexions")element_DOM("titre_fenetre").innerHTML+=" ("+resultats.length+")";chargement(false)}function CreateTableFromJSON(json_object){var col=[];for(var i=0;i<json_object.length;i++){for(var key in json_object[i]){if(col.indexOf(key)===-1){col.push(key)}}}var table=document.createElement("table");var tr=table.insertRow(-1);for(var i=0;i<col.length;i++){var th=document.createElement("th");th.innerHTML=col[i];tr.appendChild(th)}for(var i=0;i<json_object.length;i++){tr=table.insertRow(-1);for(var j=0;j<col.length;j++){var tabCell=tr.insertCell(-1);tabCell.innerHTML=json_object[i][col[j]]}}var divContainer=element_DOM("fenetre");divContainer.appendChild(table)}function initialisation(){chargement(true);var img=masquer_images_initialement();mettre_mon_mode();appliquer_preferences();document.title="Sekooly | "+nom_etablissement.toUpperCase();effacer("date_heure_depassement");if(recuperer("mes_donnees")===""||recuperer("mon_type")===""||recuperer("mes_donnees")===null||recuperer("mon_type")===null){tout_quitter()}else{configurer_profil();mon_role=init_mon_role();return chargement_a_larrivee(img)}chargement(false)}function tout_quitter(){document.body.style.display="none";deconnexion()}function afficher_fenetre(oui){if(oui){element_DOM("fenetre").style.visibility="visible"}else{element_DOM("fenetre").style.visibility="hidden"}}function afficher_logs(oui){if(element_DOM("recup_logs")){if(oui)element_DOM("recup_logs").style.visibility="hidden";if(!oui)element_DOM("recup_logs").style.visibility="hidden"}}function afficher_edt(oui){if(oui){element_DOM("recup_edt").style.display="block";if(JSON.parse(recuperer("mes_donnees"))["Cycle"]==="Primaire")element_DOM("recup_edt").style.display="none"}else{element_DOM("recup_edt").style.display="none"}}function afficher_liste_eleves(oui){if(oui)element_DOM("recup_eleves").style.display="";if(!oui)element_DOM("recup_eleves").style.display="none"}function check_maintenance(){var lien_script="https://script.google.com/macros/s/AKfycbxgtxDhZ9g8-lo5e4aux1otiYyWsgg38TXmZunQ1VnPZ7JpjzA/exec";var moi=recuperer("identifiant_courant");var mon_type=recuperer("mon_type").split("_")[0];var si_moi_existe=moi&&mon_type?"&moi="+moi+"&mon_type="+mon_type:"";var url=lien_script+"?check_maintenance=oui"+si_moi_existe;return $.ajax({url:url})}function mettre_le_contact_etablissement(){var le_contact=contact_etablissement;if($("#contact_etablissement")[0]){$("#contact_etablissement")[0].href="mailto:"+le_contact;$("#contact_etablissement")[0].innerText=le_contact;stocker("contact_etablissement",le_contact)}if($("#logo_etablissement")[0])$("#logo_etablissement")[0].src=prefixe_image+"/"+nom_fichier_logo;if($("#site_etablissement")[0])$("#site_etablissement")[0].href=site_etablissement}function chargement_a_larrivee(img){chargement(true);fermer_side_bar();mettre_le_contact_etablissement();rendre_td_modifiable();mettre_les_soons();ajouter_multi_visio_si_non_eleve();notifs_reelles_ou_non();var mon_cycle=JSON.parse(recuperer("mes_donnees"))["Cycle"];est_en_maintenance().then(function(data){var je_peux=JSON.parse(recuperer("mes_donnees"))["droit_hors_maintenance"];if(data==="oui"&&(!window.location.href.includes("file:///")&&!window.location.href.includes("http://localhost:8000"))&&je_peux!=="oui"){deconnexion()}});if(!mon_ecolage_est_ok())deconnexion();afficher_images_initiales(img);if(!plateforme_prete()){return initialisation_de_la_plateforme()}effacer("nb_clics");effacer("numero_etape");mettre_en_place_les_notifications();var mes_droits=JSON.parse(recuperer("mes_donnees"))["Droits_modifs"];afficher_logs(mes_droits==="oui");if(recuperer("mon_type").includes("Administration")&&mes_droits==="oui"){mes_matieres=get_resultat(racine_data+"/Matieres?Cycle=eq."+mon_cycle+"&"+apikey);mes_matieres=mes_matieres.sort(function(a,b){return a.Classe_Matiere>b.Classe_Matiere});stocker("mes_matieres",JSON.stringify(mes_matieres))}var affichage_icone_edt=recuperer("dossier_charg√©")||recuperer("mon_type")==="Eleves";affichage_liste=recuperer("mon_type").includes("Administration")||recuperer("mon_type")==="Profs"&&recuperer("dossier_charg√©")!==null&&recuperer("dossier_charg√©")!=="";afficher_liste_eleves(affichage_liste);afficher_bulletins(false);if(recuperer("mon_type").includes("Eleve"))afficher_bulletins(true);if(recuperer("mon_type").includes("Prof"))supprimer_bulle_bulletins();afficher_params_si_droits_et_admin();window.scrollTo(0,0);calcul_grid_gap_barre_verticale();gerer_sondage();if((recuperer("dossier_charg√©")===""||recuperer("dossier_charg√©")===null)&&recuperer("mes_donnees")!==""){configurer_profil();afficher_ajout(false);afficher_discussions(false);afficher_devoirs(false);afficher_tri_fichiers(false);afficher_visio(false);if(recuperer("mon_type").includes("Administration"))stocker("mon_type","Administration");ajouter_les_dossiers_dynamiques();afficher_alerte_etablissement()}else{var id_matiere=recuperer("dossier_charg√©");var mes_matieres=JSON.parse(recuperer("mes_matieres"));var la_matiere=mes_matieres.filter(function(element){if(element!==null)return element["ID_URL"]===id_matiere});var titre=la_matiere[0].Classe+"\n"+la_matiere[0].Matiere;if(recuperer("mon_type")==="Eleves")titre=la_matiere[0].Matiere;afficher_alerte_etablissement();return charger_dossier(id_matiere,true,titre).then(function(){if(recuperer("fichier_ouvert")){var fichier_ouvert=recuperer("fichier_ouvert");element_DOM(fichier_ouvert).click()}})}valider_suppression_via_mail_si_besoin();chargement(false)}function afficher_params_si_droits_et_admin(){if(recuperer("mes_donnees")&&recuperer("mon_type")){var mes_droits=JSON.parse(recuperer("mes_donnees"))["Droits_modifs"];var est_admin_avec_droits=recuperer("mon_type").includes("Admin")&&mes_droits==="oui";afficher_parametres(est_admin_avec_droits)}else{afficher_parametres(false)}}function afficher_alerte_etablissement(){$("#texte_alerte")[0].innerText=recuperer_alerte_etablissement()}function afficher_alerte_etablissement_old(){alerte_etablissement().then(snap=>{$("#texte_alerte")[0].innerText=snap})}function calcul_grid_gap_barre_verticale(){la_barre=element_DOM("barre_verticale");if(la_barre){la_barre.style.gridGap=$(window).height()/(element_DOM("barre_verticale").childElementCount+1)+"px"}}function valeursUniquesDeCetteKey(array,key){if(array!=="null"&&array!==null){const key_str=[key];var flags=[],output=[],l=array.length,i;for(i=0;i<l;i++){if(array[i]!==null){if(flags[array[i][key_str]])continue;flags[array[i][key_str]]=true;output.push(array[i][key_str])}}}else{output=[]}return output}function ajouter_les_dossiers_dynamiques(){if($("#liste_matieres")[0].children.length>0)return true;afficher_le_drive(false);var mes_matieres=JSON.parse(recuperer("mes_matieres"));if(recuperer("mon_type")==="Administration"){var les_classes=valeursUniquesDeCetteKey(mes_matieres,"Classe").sort();var lien_classes=[];les_classes.forEach(function(la_classe){lien_classes.push(mes_matieres.find(e=>e["Classe"]===la_classe)["classe_id"])});les_classes.some(function(valeur_classe,index_classe){if(valeur_classe===undefined||index_classe===undefined)return-1;if(valeur_classe!=="Tous")ajouter_le_dossier(valeur_classe,lien_classes[index_classe],recuperer("mon_type"))})}else{ajout_dossiers_matieres(mes_matieres)}stocker_temp("dossier_charg√©","");stocker("les_fichiers","");stocker("fichier_ouvert","");stocker("les_topics","");stocker("les_coms","")}function ajout_dossiers_matieres(mes_matieres){mes_matieres.some(function(arrayItem){if(arrayItem!==null){var ma_classe=arrayItem.Classe;var ma_matiere=arrayItem.Matiere;var couleur_matiere=prefixe_image+"/img_dossier_"+arrayItem.Couleur_matiere.replace(/ /g,"")+".png";if(ma_classe!==undefined&&ma_matiere!==undefined){var mon_url_matiere=arrayItem.URL;var mon_ID_matiere=mon_url_matiere.split("/").pop();if(recuperer("mon_type")==="Profs"||recuperer("mon_type")==="Administration_bis"){ma_matiere=arrayItem.Classe_Matiere}ajouter_le_dossier(ma_matiere,mon_ID_matiere,recuperer("mon_type"),couleur_matiere)}else{return-1}}})}function ajouter_le_dossier(classe_matiere,URL_classe_matiere,type_identifiant,couleur_dossier){if($(".une_matiere_en_dossier#"+URL_classe_matiere).length>0)return-1;if(type_identifiant==="Profs"||type_identifiant==="Administration_bis"){var la_classe=classe_matiere.substring(classe_matiere.lastIndexOf("(")+1,classe_matiere.lastIndexOf("|"));var la_matiere=classe_matiere.substring(classe_matiere.lastIndexOf("|")+1,classe_matiere.lastIndexOf(")"))}else{var la_classe="";var la_matiere=classe_matiere}var nouveau_div=creer_nouveau_dossier();creer_span_div(nouveau_div,URL_classe_matiere,la_classe,la_matiere,couleur_dossier);if(type_identifiant!=="Administration"&&type_identifiant!=="Administration_final"){ajouter_listener_dossier(URL_classe_matiere)}else{ajouter_listener_dossier_non_final(URL_classe_matiere)}}function ajouter_listener_dossier_non_final(id){element_DOM(id).addEventListener("click",function(e){$("#accueil_utilisateur").off("click");if(element_DOM(e.target.id)){element_DOM("accueil_utilisateur").innerHTML=element_DOM(e.target.id).innerText;mettre_infos_matiere(false)}element_DOM("liste_matieres").innerHTML="";stocker("mon_type","Administration_bis");var toutes_mes_matieres=JSON.parse(recuperer("mes_matieres"));var mes_matieres=toutes_mes_matieres.filter(function(element){if(element!==null)return element["classe_id"]===e.target.id});ajout_dossiers_matieres(mes_matieres);avec_bouton_back(true);window.scrollTo(0,0)})}function ajouter_listener_dossier(id){element_DOM(id).addEventListener("click",function(e){$("#pannel_notif")[0].innerHTML="";var titre=$("span[id='"+e.target.id+"']").text().trim();charger_dossier(e.target.id,true,titre)})}function creer_nouveau_dossier(){var mon_div=document.createElement("div");element_DOM("liste_matieres").appendChild(mon_div);return mon_div}function creer_span_div(mon_div,URL_classe_matiere,la_classe,la_matiere,couleur_dossier){if(la_classe!==""){var nom_classe=la_classe+"<br> "}else{var nom_classe=""}if(recuperer("mon_type")!=="Administration"){var icone=couleur_dossier}else{var icone=prefixe_image+"/dossier_drive.png"}mon_div.innerHTML='<a class="une_matiere_en_dossier" id="'+URL_classe_matiere+'" href="javascript:void(0)" > <span id="'+URL_classe_matiere+'"> <img class = image_centre id="'+URL_classe_matiere+'" src="'+icone+'">  '+nom_classe+la_matiere+" </a> </span>"}function mettre_aujourdhui(){element_DOM("la_date_effet").innerHTML="";var maintenant=moment();var id_date=maintenant.format("yyyy-MM-DD");var valeur_date="Aujourd'hui";ajouter_date_filtre(id_date,valeur_date,true)}function ajouter_date_filtre(id_date,valeur_date,valeur_aujd){if(id_date===moment().format("yyyy-MM-DD")&&!valeur_aujd)return-1;var une_date_html='<option value="'+id_date+'">'+valeur_date+"</option>";var une_date=document.createElement("div");une_date.innerHTML=une_date_html;element_DOM("la_date_effet").appendChild(une_date.firstChild)}async function infos_matiere(){id_matiere=recuperer("dossier_charg√©");la_matiere=la_matiere_chargee("Matiere");description=await rechercher("Matieres","ID_URL",id_matiere,"description");if(description){description=description[0]["description"];lire_description(id_matiere,la_matiere,description)}}function lire_description(id_matiere,la_matiere,description){elements_html='<div class="description_matiere" id="content">'+description+"</div>";intitule_bouton=recuperer("mon_type")==="Eleves"?"Fermer":"Editer la description";fonction_bouton=recuperer("mon_type")==="Eleves"?"$('#mini_popup').remove()":"editer_description_matiere('"+id_matiere+"','"+la_matiere+"')";creer_mini_popup(la_matiere,elements_html,intitule_bouton,fonction_bouton,false,false,false,false,"25")}function editer_description_matiere(id_matiere,la_matiere){$("#foot_modifs").remove();description=element_DOM("content").innerHTML;vider_fenetre("Description de "+la_matiere,false,"sauvegarder_description()");afficher_fenetre(true);$("#mini_popup").remove();$("#fenetre").append('<div class="edition"><div id="description_matiere">'+description+"</div></div>");rendre_riche("description_matiere",true)}function saisie_vide(){return'<br data-cke-filler="true">'}function pied_modifs(){var res="<div id='foot_modifs'><br><br><gris><i>Derni√®re modification: "+afficher_date(maintenant());res+="<br>Par: "+recuperer("identifiant_courant").toUpperCase()+"</i></gris></div>";return res}async function sauvegarder_description(){console.log("Enregistrement de la description...");nouvelle_description=recuperer_html_saisie_riche().includes(saisie_vide())?"Aucune description fournie":recuperer_html_saisie_riche();nouvelle_description+=pied_modifs();await supabase.from("Matieres").update({description:nouvelle_description}).match({ID_URL:recuperer("dossier_charg√©")});afficher_alerte("Description de la mati√®re sauvegard√©e.")}function charger_dossier(id_dossier,final_booleen,titre){$("#barre_verticale")[0].style.display="grid";if(id_dossier!==""&&id_dossier!==null){stocker_temp("dossier_charg√©",id_dossier);var mode_prefere=recuperer("mode_prefere")||"par_la_date_effet";choisir_ce_mode($("#"+mode_prefere)[0]);chercher_mes_chapitres(true);$("#accueil_utilisateur").off("click");$("#la_date_effet").on("change click",function(e){filtrer_date_effet()});$("#filtre_id_chapitre").on("change click",function(e){filtrer_chapitre()});stocker("les_topics","");stocker("topic_charg√©","");stocker("nb_com_actuel","");stocker("les_coms","");chargement(true);afficher_les_dossiers_dynamiques(false);element_DOM("accueil_utilisateur").innerHTML=titre;mettre_infos_matiere(true);avec_bouton_back(true);afficher_devoirs(true);afficher_discussions(true);afficher_tri_fichiers(true);afficher_visio(true);if(recuperer("mon_type")==="Profs"){afficher_ajout(true);afficher_liste_eleves(true);afficher_bulletins(false)}else if(recuperer("mon_type").includes("Administration")){var mes_droits=JSON.parse(recuperer("mes_donnees"))["Droits_modifs"];afficher_ajout(mes_droits==="oui");afficher_liste_eleves(true);afficher_bulletins(true)}else{afficher_ajout(false);afficher_liste_eleves(false);afficher_bulletins(true)}if(recuperer("mon_type")==="Administration_bis")stocker("mon_type","Administration_final");afficher_discussions(true);afficher_le_drive(true);return recuperer_les_fichiers(id_dossier)}}function chercher_mes_chapitres(forcing){if(forcing)stocker("mes_chapitres","[]");var mes_chapitres=JSON.parse(recuperer("mes_chapitres"));var id_dossier_actuel=recuperer("dossier_charg√©");if(!mes_chapitres||!mes_chapitres[id_dossier_actuel]){var url=racine_data+"Programme?ID_URL=eq."+id_dossier_actuel+"&limit=150&order=intitule_chapitre.asc"+"&"+apikey;mes_chapitres=get_resultat(url);mes_chapitres_str=JSON.stringify(mes_chapitres);chapitre_a_rajouter={[id_dossier_actuel]:mes_chapitres_str};chapitre_a_rajouter_str=JSON.stringify(chapitre_a_rajouter);if(mes_chapitres.length>0)stocker("mes_chapitres",chapitre_a_rajouter_str)}var mes_chapitres_locaux=recuperer_chapitres_locaux(id_dossier_actuel);mettre_la_liste_de_chapitres();return mes_chapitres_locaux}function recuperer_chapitres_locaux(id_dossier){try{var resultat=JSON.parse(JSON.parse(recuperer("mes_chapitres"))[id_dossier])}catch(e){var resultat=[]}return resultat}function mettre_la_liste_de_chapitres(sans_append){var id_dossier_actuel=recuperer("dossier_charg√©");var mes_chapitres=recuperer_chapitres_locaux(id_dossier_actuel);var liste_de_mes_chapitres="";mes_chapitres.forEach(function(chapitre){liste_de_mes_chapitres+=un_chapitre_liste(chapitre)});if(sans_append){return'<option value="--">(Aucun chapitre)</option>'+liste_de_mes_chapitres}else{$(".un_chapitre_dans_la_liste").remove();liste_de_mes_chapitres_filtre=liste_de_mes_chapitres+'<option class="un_chapitre_dans_la_liste" value="Tous">Tous les fichiers</option>';liste_de_mes_chapitres+='<option class="un_chapitre_dans_la_liste" value="new" style="font-style: oblique;">Nouveau chapitre</option>';$("select#id_chapitre").append(liste_de_mes_chapitres);$("select#filtre_id_chapitre").append(liste_de_mes_chapitres_filtre);$("select#id_chapitre").off("change");$("select#id_chapitre").on("change",function(e){if(e.target.value==="new")creer_chapitre()})}}function un_chapitre_liste(chapitre){return'<option class="un_chapitre_dans_la_liste" value='+chapitre["id_chapitre"]+">"+chapitre["intitule_chapitre"]+"</option>"}function recuperer_les_fichiers(id_dossier){chargement(true);enlever_alerte_vide(false);nom_table="Fichiers";nom_champ_reference="id_dossier";valeur_champ_reference=recuperer("dossier_charg√©");nom_champ_a_chercher="";return rechercher(nom_table,nom_champ_reference,valeur_champ_reference,nom_champ_a_chercher).then(data=>{les_fichiers="[]";if(data.length>0)les_fichiers=JSON.stringify(data);stocker("les_fichiers",les_fichiers);traitement_fichiers_recus();chargement(false)})["catch"](error=>{console.error(error);alert("Erreur : fichiers impossibles √† r√©cup√©rer pour cette classe.");chargement(false)})}function enlever_alerte_vide(garder_liste){if(element_DOM("alerte_vide"))element_DOM("alerte_vide").remove();if(garder_liste===false){Array.from(document.getElementsByClassName("ma_liste")).forEach(function(element,index,array){element.innerHTML="";element_DOM("titre_"+element.id).style.display="none"})}}function dossier_vide(garder_liste){enlever_alerte_vide(garder_liste);var alerte=document.createElement("div");alerte.id="alerte_vide";alerte.style.top="80px";alerte.style.position="relative";var la_date_choisie=$("#la_date_effet").find(":selected").text();var le_chapitre_choisi=$("#filtre_id_chapitre").find(":selected").text();var mode_date=$(".mode_choisi").length>0?$(".mode_choisi")[0].id==="par_la_date_effet":true;var element_choisi=mode_date?la_date_choisie:le_chapitre_choisi;alerte.innerHTML='<i style="width: max-content;color: #d9d8db;">Il n\'y a pas encore de fichiers pour '+element_choisi+".</i>";afficher_le_drive(false);document.body.insertBefore(alerte,element_DOM("gros_conteneur"))}function la_date_yyyy_mm_dd(champ_date){var ma_date=new Date(Date.parse(champ_date));var d=ma_date.getDate();var m=ma_date.getMonth()+1;var y=ma_date.getFullYear();return""+y+"-"+(m<=9?"0"+m:m)+"-"+(d<=9?"0"+d:d)}function initialisation_date_tri(les_fichiers){mettre_aujourdhui();var liste_unique_dates_effet=valeursUniquesDeCetteKey(les_fichiers,"date_effet");var liste_unique_dates_effet=liste_unique_dates_effet.sort();var liste_unique_dates_effet_valeurs=liste_unique_dates_effet.map(element=>afficher_date(element,true));for(var i=0;i<liste_unique_dates_effet.length;i++){var id_date=la_date_yyyy_mm_dd(liste_unique_dates_effet[i]);var valeur_date=liste_unique_dates_effet_valeurs[i];ajouter_date_filtre(id_date,valeur_date)}ajouter_date_filtre("Tous","Tous les fichiers");var date_aujourdhui=moment().format("yyyy-MM-DD");element_DOM("la_date_effet").value=date_aujourdhui}function traitement_fichiers_recus(){var les_fichiers_str=recuperer("les_fichiers");var les_fichiers=JSON.parse(les_fichiers_str);initialisation_date_tri(les_fichiers);if(!recuperer("mon_type").includes("Administration")){les_fichiers=les_fichiers.filter(e=>e["categorie_fichier"]!=="Bulletins")}if(les_fichiers_str===""||les_fichiers.length===0){dossier_vide(false)}else{enlever_alerte_vide(false);les_fichiers.sort(function(a,b){if(a.nom_fichier<b.nom_fichier){return-1}if(a.nom_fichier>b.nom_fichier){return 1}return 0});les_fichiers.forEach(function(valeur){ma_categorie=valeur["categorie_fichier"].toLowerCase();var nom_fichier=valeur["nom_fichier"];var extension_fichier=nom_fichier.split(".").pop().toLowerCase();var la_date_limite=afficher_date(valeur["la_date_limite"],true);var lheure_limite=valeur["lheure_limite"]?" √† "+valeur["lheure_limite"]:"";if(ma_categorie==="examens"&&valeur["la_date_limite"].length===0){date_debut=la_date_yyyy_mm_dd(valeur["date_effet"]);date_debut=moment(date_debut+" "+valeur["heure_effet"]);la_date_limite=date_debut;nb_heures_delai_examen=data_etablissement["nb_heures_delai_examen"]||12;la_date_limite=la_date_limite.add(nb_heures_delai_examen,"hours");lheure_limite=" √† "+la_date_limite.format("YYYY-MM-DD HH:mm").split(" ")[1];la_date_limite=afficher_date(la_date_limite,true)}valeur_coef=valeur["coefficient_rendu"]>0?"<b>Coeff. "+valeur["coefficient_rendu"]+"</b>":"";if(ma_categorie==="devoirs"||ma_categorie==="examens")nom_fichier=valeur["nom_fichier"]+"<rouge><i>(√† rendre avant le "+la_date_limite+lheure_limite+")<br>"+valeur_coef+"</i></rouge>";var nom_drive="drive_"+ma_categorie;ajouter_un_fichier(valeur["id_fichier"],nom_fichier,nom_drive,extension_fichier,valeur["date_effet"],valeur["heure_effet"],valeur["est_telechargeable"],valeur["coefficient_rendu"],valeur["la_date_limite"],valeur["lheure_limite"],valeur["periode_bulletin"],valeur["destinataire_par_page"],valeur["id_chapitre"])});var id_mode=id_mode_affichage();filtrer_avec_le_bon_filtre(id_mode);chargement(false)}if(recuperer("dossier_charg√©")===""||recuperer("dossier_charg√©")===null)decharger_dossier_final();chargement(false)}function id_mode_affichage(){return recuperer("mode_prefere")?recuperer("mode_prefere").replace("par_",""):"la_date_effet"}function garder_les_manuels(){if($("#drive_manuels")[0].children.length>0){$("#titre_drive_manuels")[0].style.display="initial";$("#drive_manuels")[0].style.display="";for(var i=$("#drive_manuels")[0].children.length-1;i>=0;i--){$("#drive_manuels")[0].children[i].style.display=""}}}function highlightDays(dates,date){for(var i=0;i<dates.length;i++){if(dates[i]==date){return[true,"highlight"]}}return[true,""]}function masquer_drive_vide(){Array.from(document.getElementsByClassName("ma_liste")).forEach(function(valeur,index,array){var nombre_de_fils=$("#"+valeur["id"]).find(".span_un_fichier:visible").length;if(nombre_de_fils===0){element_DOM(valeur.id).style.display="none";element_DOM("titre_"+valeur.id).style.display="none"}else{element_DOM(valeur.id).style.display="grid";element_DOM("titre_"+valeur.id).style.display="initial"}});if($("#gros_conteneur").find(".span_un_fichier:visible").length===0)dossier_vide(true)}function ajouter_un_fichier(id_fichier,nom_fichier,nom_drive,extension_fichier,date_effet,heure_effet,est_telechargeable,coefficient_rendu,date_limite,heure_limite,periode_bulletin,destinataire_par_page,id_chapitre){var image_fichier=prefixe_image+"/img_icone_"+extension_fichier+".png";var padding_yt=est_telechargeable==="oui"?"":' style="padding-top: 25%;" ';var telecharger_le_fichier=est_telechargeable==="oui"?'<img alt="t√©l√©charger" src="'+prefixe_image+'/img_download.png" onclick="telecharger_fichier(event,this)" id="telecharger" class="download_fichier">':"";var periode_bulletin=periode_bulletin?" periode_bulletin='"+periode_bulletin+"'":"";var destinataire_par_page=destinataire_par_page?" destinataire_par_page='"+destinataire_par_page+"'":"";var id_chapitre=id_chapitre?" id_chapitre='"+id_chapitre+"'":"";var code_html='<span oncontextmenu="autoriser_clic_droit_supprimer_et_renommer(event,this)" onclick="ouvrir_fichier(this)" class="span_un_fichier" id="'+id_fichier+'" ma_date_effet="'+la_date_yyyy_mm_dd(date_effet)+'" mon_heure_effet="'+heure_effet+'" ma_date_limite="'+la_date_yyyy_mm_dd(date_limite)+'" mon_heure_limite="'+heure_limite+'" est_telechargeable="'+est_telechargeable+'"    coefficient_rendu='+coefficient_rendu+periode_bulletin+destinataire_par_page+id_chapitre+"    >"+telecharger_le_fichier+'<img id="'+id_fichier+'" src="'+image_fichier+'" class="un_fichier" '+padding_yt+">"+nom_fichier+"</span>";var mon_fichier=document.createElement("div");mon_fichier.innerHTML=code_html;while(mon_fichier.firstChild){element_DOM(nom_drive).appendChild(mon_fichier.firstChild)}$("#"+id_fichier+" .un_fichier").one("error",function(e){$("#"+id_fichier+" .un_fichier").attr("src",prefixe_image+"/img_fichier.png")});ajouter_cadenas_examen(id_fichier,nom_drive)}function ajouter_cadenas_examen(id_fichier,nom_drive){if(nom_drive==="drive_examens"){var non_ouvrable=fichier_ouvrable(id_fichier,false)===false;if(non_ouvrable){$(".span_un_fichier#"+id_fichier).append('<img alt="verrouill√©" id="locked" src="'+prefixe_image+'/img_cadenas.png" class="locked">')}}}function bool_examen_termin√©(drive_parent,le_span_un_fichier){var date_debut=le_span_un_fichier.getAttribute("ma_date_effet");var heure_debut=le_span_un_fichier.getAttribute("mon_heure_effet").value;nb_heures_delai_examen=data_etablissement["nb_heures_delai_examen"]||12;var date_fin=moment(date_debut+" "+heure_debut,"yyyy-MM-DD hh:mm").add(nb_heures_delai_examen,"hours")._d;var est_examen=drive_parent==="drive_examens";var examen_termin√©=est_examen&&moment(maintenant())>date_fin;return examen_termin√©}function fichier_ouvrable(id_fichier,bouton_telecharger,ceci_bouton_telecharger){var mon_type=recuperer("mon_type").split("_")[0];if(bouton_telecharger){id_fichier=ceci_bouton_telecharger.parentNode.id}var le_span_un_fichier=$("span#"+id_fichier+".span_un_fichier")[0];var drive_parent=le_span_un_fichier.parentNode.id;var lheure_effet=le_span_un_fichier.getAttribute("mon_heure_effet")?le_span_un_fichier.getAttribute("mon_heure_effet"):"07:30";var la_date_effet=moment(le_span_un_fichier.getAttribute("ma_date_effet")+" "+lheure_effet);var date_heure_aujourdhui=moment(maintenant());if(drive_parent==="drive_corrections"&&(!mon_type.includes("Admin")&&!mon_type.includes("Prof"))&&la_date_effet>date_heure_aujourdhui){return false}var mes_donnees=JSON.parse(recuperer("mes_donnees"));var Droit_acces_anticipe_examen=mes_donnees["Droit_acces_anticipe_examen"]?mes_donnees["Droit_acces_anticipe_examen"]==="oui":mon_type==="Profs";var examen_termin√©=bool_examen_termin√©(drive_parent,le_span_un_fichier);if(drive_parent==="drive_examens"&&!Droit_acces_anticipe_examen&&(la_date_effet>date_heure_aujourdhui||examen_termin√©)){return false}else{}return true}function ouvrir_fichier(ceci){var id_fichier=ceci.id;var le_span_un_fichier=$("[id="+id_fichier+"].span_un_fichier")[0];if(!fichier_ouvrable(id_fichier)){var lheure_effet=le_span_un_fichier.getAttribute("mon_heure_effet")?le_span_un_fichier.getAttribute("mon_heure_effet"):"07:30";var drive_parent=le_span_un_fichier.parentNode.id;if(bool_examen_termin√©(drive_parent,le_span_un_fichier)){alert("Ce sujet d'examen n'est plus disponible.")}else{date_heure_fichier=ceci.attributes["ma_date_effet"].value+" "+lheure_effet;alert("Ce fichier n'est pas disponible avant "+afficher_date_old(moment(date_heure_fichier).format("DD/MM/YYYY HH:mm"))+".")}return-1}else{stocker("fichier_ouvert",id_fichier);var nom_fichier=$("span#"+id_fichier+".span_un_fichier").contents().filter(function(){return this.nodeType==3})[0].nodeValue;nom_fichier=rfc3986EncodeURIComponent(nom_fichier);visualiser(nom_fichier,id_fichier,"","",le_span_un_fichier.getAttribute("est_telechargeable")!=="oui")}}function telecharger_fichier(event,ceci){if(!fichier_ouvrable(id_fichier,true,ceci)){le_span_un_fichier=$("[id="+id_fichier+"].span_un_fichier")[0];var lheure_effet=le_span_un_fichier.getAttribute("mon_heure_effet")?le_span_un_fichier.getAttribute("mon_heure_effet"):"07:30";alert("Ce fichier n'est pas disponible avant "+afficher_date(ceci.parentNode.attributes["ma_date_effet"].value+" "+lheure_effet));return-1}chargement(true);event.stopPropagation();var id_fichier=ceci.parentNode.id;window.location.href="https://drive.google.com/uc?export=download&id="+id_fichier;chargement(false)}function autoriser_clic_droit_supprimer_et_renommer(e,ceci){if(recuperer("mon_type")==="Eleves")return-1;if(recuperer("mon_type").includes("Administration")){var mes_droits=JSON.parse(recuperer("mes_donnees"))["Droits_modifs"];if(mes_droits!=="oui")return-1}if(!recuperer("mon_type").includes("Admin")&&element_DOM("accueil_utilisateur").innerText.includes("Vie scolaire")){return-1}if($("#"+ceci.id)[0].parentNode.id==="drive_manuels"){if(!recuperer("mon_type").includes("Admin")){return-1}else{if(JSON.parse(recuperer("mes_donnees"))["Droits_modifs"]!=="oui")return-1}}e.preventDefault();e.stopPropagation();var id_fichier=ceci.id;$(".clic_droit").remove();ajouter_fonction_clic_droit(e,ceci,0,"renommer_fichier","Renommer",id_fichier);ajouter_fonction_clic_droit(e,ceci,1,"changer_chapitre_fichier","Assigner un chapitre",id_fichier);ajouter_fonction_clic_droit(e,ceci,2,"recategoriser_fichier","Recat√©goriser",id_fichier);ajouter_fonction_clic_droit(e,ceci,3,"changer_date_effet","Date d'effet",id_fichier);if($("#"+ceci.id)[0].parentNode.id==="drive_devoirs"){ajouter_fonction_clic_droit(e,ceci,4,"changer_date_limite_rendu","Date limite de rendu",id_fichier);mon_offset=1}else{mon_offset=0}if($("#"+ceci.id)[0].parentNode.id==="drive_bulletins"){ajouter_fonction_clic_droit(e,ceci,4,"changer_periode_bulletin","P√©riode du bulletin",id_fichier);mon_offset=mon_offset===1?2:1}ajouter_fonction_clic_droit(e,ceci,4+mon_offset,"changer_coef","Coefficient",id_fichier,null,$("#"+id_fichier)[0].getAttribute("coefficient_rendu"));ajouter_fonction_clic_droit(e,ceci,5+mon_offset,"changer_telechargeable","T√©l√©chargeable ou non",id_fichier);ajouter_fonction_clic_droit(e,ceci,6+mon_offset,"supprimer_fichier","Supprimer",id_fichier);$(document).click(function(){$(".clic_droit").remove();$("#clic_droit_titres_param").remove()})}function changer_chapitre_fichier(id_fichier,nom_fichier){var elements_html='<select id="nouveau_chapitre">';elements_html+=mettre_la_liste_de_chapitres(true);elements_html+="</select>";var ancien_chapitre=$(".span_un_fichier[id='"+id_fichier+"']")[0].getAttribute("id_chapitre");creer_mini_popup("Chapitre de <b>"+nom_fichier+"</b>",elements_html,"Assigner le chapitre","changer_chapitre('"+id_fichier+"')",ancien_chapitre,"nouveau_chapitre")}function changer_chapitre(id_fichier){nouveau_chapitre=$("#nouveau_chapitre")[0].value;nouvelle_donnee={id_fichier:id_fichier,id_chapitre:nouveau_chapitre};var url=racine_data+"Fichiers?id_fichier=eq."+id_fichier+"&"+apikey;patch_resultat_asynchrone(url,nouvelle_donnee);afficher_alerte("Le chapitre du fichier a bien √©t√© actualis√©.",true)}function changer_eleve_par_page_bulletin(id_fichier,ancien_destinataire_par_page){chargement(true);nb_pages=recuperer_nb_pages_pdf(id_fichier);chargement(false);ancien_destinataire_par_page='{"nouveau":"1","test":"2"}';elements_html=modif_attribution_page_eleve(nb_pages,ancien_destinataire_par_page);creer_mini_popup("Re-attribuez chaque page:",elements_html,"Attribuer","envoyer_modif_destinataires_bulletins('"+ancien_destinataire_par_page+"')")}function envoyer_modif_destinataires_bulletins(ancien_destinataire_par_page){chargement(true);nouveau_destinataire_par_page={1:"truc"};if(nouveau_destinataire_par_page===ancien_destinataire_par_page)return-1;nom_table="Fichiers";nom_champ_reference="id_fichier";valeur_champ_reference=id_fichier;nouveau_data={destinataire_par_page:nouveau_destinataire_par_page};actualiser(nom_table,nom_champ_reference,valeur_champ_reference,nouveau_data);setTimeout(function(){location.reload()},1e3);chargement(false)}function modif_attribution_page_eleve(nombre_pages,ancien_destinataire_par_page){liste_eleves=JSON.parse(ancien_destinataire_par_page);console.log(liste_eleves);select_liste_eleves='<select style="width: 80%;" name="numero_page" id="numero_page"><option value="eleve_de_cette_page">eleve_de_cette_page</option></select>';attribution='<form id="attribution" style="margin-top: 20px;">';for(numero_page=1;numero_page<=nombre_pages;numero_page++){nom_eleve=Object.keys(liste_eleves).find(key=>liste_eleves[key]===numero_page.toString());attribution=attribution+'<div><label for="'+numero_page+'">Page n¬∞'+numero_page+":"+select_liste_eleves.replace(/"numero_page"/g,numero_page).replace(/"eleve_de_cette_page"/g,nom_eleve)+"</label></div>"}attribution=attribution+"</form>";return attribution}function changer_periode_bulletin(id_fichier,ancienne_periode){ancienne_periode=$("[id='"+id_fichier+"']")[0].getAttribute("periode_bulletin");var elements_html=`<div><label for="periode_bulletin"><select style="width: 60%;" id="periode_bulletin" name="periode_bulletin"><option value="PREMIER TRIMESTRE">PREMIER TRIMESTRE</option><option value="DEUXIEME TRIMESTRE">DEUXIEME TRIMESTRE</option><option value="TROISIEME TRIMESTRE">TROISIEME TRIMESTRE</option><option value="ANNUEL">ANNUEL</option></select></label></div>`;creer_mini_popup("Choisissez la nouvelle p√©riode de ce bulletin:",elements_html,"Modifier la p√©riode","changer_periode('"+id_fichier+"','"+ancienne_periode+"')");$("#periode_bulletin")[0].value=ancienne_periode}function changer_periode(id_fichier,ancienne_periode){nouvelle_periode=$("#periode_bulletin")[0].value;if(nouvelle_periode===ancienne_periode)return-1;chargement(true);nom_table="Fichiers";nom_champ_reference="id_fichier";valeur_champ_reference=id_fichier;nouveau_data={periode_bulletin:nouvelle_periode};actualiser(nom_table,nom_champ_reference,valeur_champ_reference,nouveau_data);setTimeout(function(){location.reload()},1e3);chargement(false)}function changer_telechargeable(id_fichier,ancien_telechargeable){var categorie_actuelle=$("[id='"+id_fichier+"'].span_un_fichier")[0].parentNode.id.split("_")[1];var extension_fichier=$("[id='"+id_fichier+"']")[0].innerText.split(".")[1].split("\n")[0];if(categorie_actuelle.includes("manuels")||categorie_actuelle.includes("quiz")){alert("Impossible de rendre un manuel ou un quiz t√©l√©chargeable.");return-1}else if(categorie_actuelle.includes("bulletins")){alert("Impossible de rendre un fichier de bulletins t√©l√©chargeable.");return-1}else if(extension_fichier==="youtube"){alert("Impossible de rendre une vid√©o youtube t√©l√©chargeable.");return-1}var ancien_telechargeable=$(".span_un_fichier[id='"+id_fichier+"']")[0].children[0].id==="telecharger"?"oui":"non";var nouveau_telechargeable=prompt("Indiquez si 'oui' ou 'non' vous voulez que ce fichier soit t√©l√©chargeable:",ancien_telechargeable);if(nouveau_telechargeable===null)return-1;chargement(true);nouveau_telechargeable=nouveau_telechargeable==="oui"?"oui":"non";if(nouveau_telechargeable===ancien_telechargeable)return-1;nom_table="Fichiers";nom_champ_reference="id_fichier";valeur_champ_reference=id_fichier;nouveau_data={est_telechargeable:nouveau_telechargeable};actualiser(nom_table,nom_champ_reference,valeur_champ_reference,nouveau_data);setTimeout(function(){location.reload()},1e3);chargement(false)}function changer_coef(id_fichier,ancien_coef){var categorie_actuelle=$("[id="+id_fichier+"].span_un_fichier")[0].parentNode.id.split("_")[1];if(!categorie_actuelle.includes("devoirs")&&!categorie_actuelle.includes("examens")&&!categorie_actuelle.includes("quiz")){alert("Impossible de changer le coefficient d'un fichier diff√©rent d'un sujet de devoir/examen.");return-1}var nouveau_coef=prompt("Indiquez le nouveau coefficient du rendu:",ancien_coef);if(nouveau_coef===null)return-1;nouveau_coef=Number(nouveau_coef);if(!(nouveau_coef>=0)){alert("Impossible de changer le coefficient : merci de saisir un coefficient valide (>0).");return-1}if(nouveau_coef===ancien_coef)return-1;chargement(true);nom_table="Fichiers";nom_champ_reference="id_fichier";valeur_champ_reference=id_fichier;nouveau_data={coefficient_rendu:nouveau_coef};actualiser(nom_table,nom_champ_reference,valeur_champ_reference,nouveau_data);setTimeout(function(){location.reload()},1e3);chargement(false)}function ajouter_fonction_clic_droit(e,ceci,position,fonction,affichage_nom_fonction,id_fichier,nom_class_clic_droit,nom_fichier){if(!nom_fichier)nom_fichier=decodeURI(encodeURIComponent(ceci.innerText).split("%0A")[0]);var span_clic_droit=document.createElement("span");if(!nom_class_clic_droit)nom_class_clic_droit="clic_droit";span_clic_droit.setAttribute("class",nom_class_clic_droit);span_clic_droit.setAttribute("id",fonction);span_clic_droit.setAttribute("onclick","event.stopPropagation();"+fonction+'("'+id_fichier+'","'+nom_fichier+'")');var decalage_y=position*40;span_clic_droit.style.top=Number(e.clientY+decalage_y)+"px";span_clic_droit.style.left=e.clientX+"px";span_clic_droit.innerHTML=affichage_nom_fonction;ceci.appendChild(span_clic_droit);$(span_clic_droit).on("mouseover",function(e){span_clic_droit.style.filter="invert(100%)"});$(span_clic_droit).on("mouseout",function(e){span_clic_droit.style.filter=""});$(span_clic_droit).on("click",function(e){$(".clic_droit").remove()});return span_clic_droit}function recategoriser_fichier(id_fichier,nom_fichier){var categorie_actuelle=$("[id="+id_fichier+"].span_un_fichier")[0].parentNode.id.split("_")[1];if(categorie_actuelle.includes("devoirs")){alert("Impossible de recat√©goriser un devoir.");return-1}else if(categorie_actuelle.includes("examen")){alert("Impossible de recat√©goriser un examen.");return-1}else if(categorie_actuelle.includes("quiz")){alert("Impossible de recat√©goriser un quiz.");return-1}else{categorie_actuelle=categorie_actuelle.charAt(0).toUpperCase()+categorie_actuelle.slice(1);var liste_choix_categories=Array.from($("#categorie_choisie")[0].children).map(valeur=>valeur.value);var liste_options=liste_choix_categories.map(valeur=>'<option value="'+valeur+'">'+valeur+"</option>");var ma_liste_categories='<select id="ma_liste_categories" style="width: 80%;">'+liste_options+"</select>";creer_mini_popup(nom_fichier,ma_liste_categories,"Recat√©goriser","mettre_a_jour_categorie('"+id_fichier+"')",categorie_actuelle,"ma_liste_categories")}}function creer_mini_popup(titre,elements_html,nom_bouton,fonction_bouton,valeur_actuelle,id_element_valeur_actuelle,valeur_actuelle_bis,id_element_valeur_actuelle_bis,taille_du_titre,id_bouton){$("#mini_popup").remove();var bouton_quitter='<div id="entete-fenetre" style="display: inline-flex;float: right;"><img  alt="X" src="'+prefixe_image+'/quitter.png" id="bye_prev" onclick="$(\'#mini_popup\').remove()" class="bye_prev"> </div>';var taille=taille_du_titre?'style="border-bottom-style: ridge;font-size: '+taille_du_titre+'px;"':"";var titre_html="<div "+taille+" >"+titre+"</div>";var id_bouton_html=id_bouton?"id='"+id_bouton+"'":"";var valider_changement='<button type="button"  '+id_bouton_html+'  class="rendre" onclick="'+fonction_bouton+'">'+nom_bouton+"</button>";var mini_popup_html='<div id="mini_popup">'+bouton_quitter+titre_html+elements_html+valider_changement+"</div>";var mini_popup=document.createElement("div");mini_popup.innerHTML=mini_popup_html;document.body.appendChild(mini_popup.firstChild);if($("#"+id_element_valeur_actuelle)[0])$("#"+id_element_valeur_actuelle)[0].value=valeur_actuelle;if($("#"+id_element_valeur_actuelle_bis)[0])$("#"+id_element_valeur_actuelle_bis)[0].value=valeur_actuelle_bis;ajuster_boutons_fenetre();ajuster_boutons_fenetre(true);choisir_height_viz_si_pdf()}function mettre_a_jour_categorie(id_fichier_valeur){var nouvelle_categorie_valeur=$("#ma_liste_categories")[0].value;if(impossible_de_cliquer())return-1;if(nouvelle_categorie_valeur==="--")return-1;if(nouvelle_categorie_valeur==="Devoirs"||nouvelle_categorie_valeur==="Examens"){alert("Il est pour l'instant impossible de recat√©goriser un fichier en Devoirs/Examens.");return-1}chargement(true);nom_table="Fichiers";nom_champ_reference="id_fichier";valeur_champ_reference=id_fichier_valeur;nouveau_data={categorie_fichier:nouvelle_categorie_valeur};actualiser(nom_table,nom_champ_reference,valeur_champ_reference,nouveau_data);setTimeout(function(){location.reload()},1e3)}function changer_date_limite_rendu(id_fichier,nom_fichier){var nouvelle_date_effet='<input type="date" id="nouvelle_date_effet" class="date_effet_fichier">';var nouvelle_heure_effet='<input type="time" id="nouvelle_heure_effet" class="la_date_limite">';var ancienne_date_effet=$("[id="+id_fichier+"].span_un_fichier")[0].attributes["ma_date_limite"].value;var ancienne_heure_effet=$("[id="+id_fichier+"].span_un_fichier")[0].attributes["mon_heure_limite"].value?$("[id="+id_fichier+"].span_un_fichier")[0].attributes["mon_heure_limite"].value:"07:30";creer_mini_popup(nom_fichier,nouvelle_date_effet+nouvelle_heure_effet,"Appliquer date limite de rendu","mettre_a_jour_date_limite_rendu('"+id_fichier+"')",ancienne_date_effet,"nouvelle_date_effet",ancienne_heure_effet,"nouvelle_heure_effet");$("#nouvelle_date_effet").on("change",function(){if($("#nouvelle_date_effet")[0].value==="")$("#nouvelle_date_effet")[0].value=ancienne_date_effet});$("#nouvelle_heure_effet").on("change",function(){if($("#nouvelle_heure_effet")[0].value==="")$("#nouvelle_heure_effet")[0].value=ancienne_heure_effet})}function changer_date_effet(id_fichier,nom_fichier){var nouvelle_date_effet='<input type="date" id="nouvelle_date_effet" class="date_effet_fichier">';var nouvelle_heure_effet='<input type="time" id="nouvelle_heure_effet" class="la_date_limite">';var ancienne_date_effet=$("[id="+id_fichier+"].span_un_fichier")[0].attributes["ma_date_effet"].value;var ancienne_heure_effet=$("[id="+id_fichier+"].span_un_fichier")[0].attributes["mon_heure_effet"].value?$("[id="+id_fichier+"].span_un_fichier")[0].attributes["mon_heure_effet"].value:"07:30";creer_mini_popup(nom_fichier,nouvelle_date_effet+nouvelle_heure_effet,"Appliquer date d'effet","mettre_a_jour_date_effet('"+id_fichier+"')",ancienne_date_effet,"nouvelle_date_effet",ancienne_heure_effet,"nouvelle_heure_effet");$("#nouvelle_date_effet").on("change",function(){if($("#nouvelle_date_effet")[0].value==="")$("#nouvelle_date_effet")[0].value=ancienne_date_effet});$("#nouvelle_heure_effet").on("change",function(){if($("#nouvelle_heure_effet")[0].value==="")$("#nouvelle_heure_effet")[0].value=ancienne_heure_effet})}function mettre_a_jour_date_limite_rendu(id_fichier_valeur){var nouvelle_date_effet=$("#nouvelle_date_effet")[0].value;var nouvelle_heure_effet=$("#nouvelle_heure_effet")[0]?$("#nouvelle_heure_effet")[0].value:"";if(impossible_de_cliquer())return-1;if(nouvelle_date_effet==="")return-1;chargement(true);nom_table="Fichiers";nom_champ_reference="id_fichier";valeur_champ_reference=id_fichier_valeur;nouveau_data={la_date_limite:nouvelle_date_effet,lheure_limite:nouvelle_heure_effet};actualiser(nom_table,nom_champ_reference,valeur_champ_reference,nouveau_data);setTimeout(function(){location.reload()},1e3)}function mettre_a_jour_date_effet(id_fichier_valeur){var nouvelle_date_effet=$("#nouvelle_date_effet")[0].value;var nouvelle_heure_effet=$("#nouvelle_heure_effet")[0]?$("#nouvelle_heure_effet")[0].value:"";if(impossible_de_cliquer())return-1;if(nouvelle_date_effet==="")return-1;chargement(true);nom_table="Fichiers";nom_champ_reference="id_fichier";valeur_champ_reference=id_fichier_valeur;nouveau_data={date_effet:nouvelle_date_effet,heure_effet:nouvelle_heure_effet};actualiser(nom_table,nom_champ_reference,valeur_champ_reference,nouveau_data);setTimeout(function(){location.reload()},1e3)}function renommer_fichier(id_fichier,ancien_nom){ancien_nom=decodeURIComponent(ancien_nom);extension_fichier=ancien_nom.split(".").pop();ancien_nom=ancien_nom.split(".").slice(0,-1).join(".");var nouveau_nom=prompt("Indiquez le nouveau nom: ",ancien_nom);if(nouveau_nom===null||nouveau_nom.length===0)return-1;chargement(true);nouveau_nom=nouveau_nom.trim();nouveau_nom=nouveau_nom+"."+extension_fichier;if(nouveau_nom.length>0){var identifiant=recuperer("identifiant_courant");var le_lien_script="https://script.google.com/macros/s/AKfycbzUiqqvttFoMV0SJEjizhDj_vQQdkAYN0ZwS4Yiy3TMgK1ucb8e/exec";var url=le_lien_script+"?method=POST&id_fichier="+id_fichier;var url=url+"&nouveau_nom="+nouveau_nom;var url=url+"&API_KEY_RENAME="+recuperer("API_KEY_RENAME");$.ajax({url:url,type:"POST",success:function(data){console.log(data);var msg_alerte=element_DOM("snackbar");msg_alerte.innerText=data;msg_alerte.className="show";nom_table="Fichiers";nom_champ_reference="id_fichier";valeur_champ_reference=id_fichier;nouveau_data={nom_fichier:nouveau_nom};actualiser(nom_table,nom_champ_reference,valeur_champ_reference,nouveau_data);nom_table="Quiz";nom_champ_reference="id_quiz";valeur_champ_reference=id_fichier;nouveau_data={titre:nouveau_nom};actualiser(nom_table,nom_champ_reference,valeur_champ_reference,nouveau_data);nom_table="Notifs";nom_champ_reference="id_notif";valeur_champ_reference=id_fichier+suite_notif();nouveau_data={"Intitul√©":nouveau_nom};actualiser(nom_table,nom_champ_reference,valeur_champ_reference,nouveau_data);setTimeout(function(){msg_alerte.className="";location.reload()},3e3)},error:function(data){console.log(data)}})}}async function visualiser(nom_fichier,id_fichier,nom_proprio_devoir,titre_initial,pas_de_telechargement,mode_extrait_png_canva,mode_extrait_png_div){chargement(true);nom_fichier=decodeURIComponent(nom_fichier);vider_fenetre(titre_initial?titre_initial:nom_fichier+(nom_proprio_devoir?nom_proprio_devoir:""));afficher_fenetre(true);var bouton_t√©l√©charger=mode_extrait_png_canva?'<a id="telechargement" class="download-btn" download="Bulletin.png" onclick="telecharger_canvas()"><img alt="t√©l√©charger" class="window-btn"  id="'+id_fichier+'" src="'+prefixe_image+'/img_download.png"></a>':pas_de_telechargement?"":'<a id="telechargement" class="download-btn" href = "https://drive.google.com/uc?export=download&id='+id_fichier+'"><img alt="t√©l√©charger" class="window-btn" id="'+id_fichier+'" src="'+prefixe_image+'/img_download.png"></a>';if(nom_proprio_devoir){donnees_devoir_a_corriger=await rechercher("Rendus","id_fichier",id_fichier);remarque=donnees_devoir_a_corriger[0]["remarque"];coefficient_rendu=donnees_devoir_a_corriger[0]["coefficient_rendu"];note_rendu=donnees_devoir_a_corriger[0]["note_rendu"];remarque=decodeURIComponent(remarque);remarque=JSON.stringify(remarque).replace(/&/,"&amp;").replace(/"/g,"");remarque=remarque.replace(/'/g,"\\'");var bouton_corriger='<span id="'+id_fichier+'"><img id="corriger" src="'+prefixe_image+'/img_remarque.png" class="window-btn" style="right: 30px;" onclick="mettre_remarque_devoir(this,\''+remarque+"',"+coefficient_rendu+","+note_rendu+')"></span>'}else{var bouton_corriger=""}var a_ajouter=document.createElement("div");a_ajouter.innerHTML=bouton_corriger+bouton_t√©l√©charger;while(a_ajouter.firstChild)element_DOM("entete-fenetre").appendChild(a_ajouter.firstChild);nom_fichier=nom_fichier.toLowerCase();var extension=nom_fichier.split(".").pop();if(extension==="quiz"){chargement(false);var id_quiz=nom_proprio_devoir?element_DOM("devoir_choisi").value:id_fichier;stocker("fichier_ouvert",id_quiz);nom_proprio_devoir=nom_proprio_devoir?nom_proprio_devoir.toLowerCase().replace("(","").replace(")","").trim():recuperer("identifiant_courant");stocker("proprietaire_devoir",nom_proprio_devoir);return accueil_quiz(id_quiz,recuperer("mon_type")!=="Eleves",nom_proprio_devoir)}var previsualisation='<iframe id="previsualisation" class="previz"></iframe>';if(est_image(extension))previsualisation='<div id="previsualisation" style="width: 100%;height: 85%;"></div>';if(est_youtube(extension))$("#telechargement").remove();if(pas_de_telechargement&&est_youtube(extension)===false&&est_image(extension)===false||mode_extrait_png_div)previsualisation='<div id=previsualisation class="responsive-container">';a_ajouter=document.createElement("div");a_ajouter.innerHTML=previsualisation;element_DOM("fenetre").appendChild(a_ajouter.firstChild);lien_de_visu=calcul_lien_de_visu(extension,id_fichier);if(est_image(extension)&&!mode_extrait_png_div){var viewer=OpenSeadragon({id:"previsualisation",prefixUrl:"https://sekooly.github.io/SUPABASE/openseadragon/images/",tileSources:{type:"image",url:lien_de_visu},showRotationControl:true});chargement(true);viewer.addHandler("open",function(){chargement(false)})}else if(mode_extrait_png_canva){var le_inner_html='<canvas id="vizcanva"> </canvas>';element_DOM("previsualisation").innerHTML=le_inner_html;chargement(false)}else if(mode_extrait_png_div){$("#previsualisation")[0].className="";chargement(false)}else{choisir_height_viz_si_pdf();if(pas_de_telechargement&&est_youtube(extension)===false){var le_inner_html='<iframe id="viz_frame" src="'+lien_de_visu+'"    frameborder="0" scrolling="no" seamless=""></iframe><div style="width: 80px; height: 80px; position: absolute; opacity: 0; right: 0px; top: 0px;"> </div>';element_DOM("previsualisation").innerHTML=le_inner_html;chargement(false)}else{element_DOM("previsualisation").src=lien_de_visu}$("#previsualisation").on("load",function(){chargement(false)});$("#viz_frame").on("load",function(e){chargement(false)});setTimeout(function(){if(impossible_de_cliquer()&&element_DOM("titre_fenetre")===nom_fichier){chargement(false);alert("L'aper√ßu du fichier "+nom_fichier+" n'est peut-√™tre pas disponible. Vous pouvez toutefois le t√©l√©charger.");chargement(false)}},1e4)}ajuster_boutons_fenetre();ajuster_boutons_fenetre(true);choisir_height_viz_si_pdf()}function est_youtube(extension){return extension==="youtube"}function est_image(extension){return extension.includes("bmp")||extension.includes("gif")||extension.includes("jpeg")||extension.includes("jpg")||extension.includes("png")||extension.includes("svg")||extension.includes("bmp")}function calcul_lien_de_visu(extension,id_fichier){var lien_de_visu="https://drive.google.com/uc?id="+id_fichier;if(extension.includes("xls")){lien_de_visu="https://docs.google.com/spreadsheets/preview?id="+id_fichier}else if(extension.includes("doc")){lien_de_visu="https://docs.google.com/document/preview?id="+id_fichier}else if(extension.includes("ppt")){lien_de_visu="https://docs.google.com/presentation/preview?id="+id_fichier}else if(extension.includes("txt")||extension.includes("wav")){lien_de_visu="https://docs.google.com/file/d/"+id_fichier+"/preview"}else if(extension.includes("pdf")||extension.includes("rtf")){lien_de_visu="https://docs.google.com/file/d/"+id_fichier+"/preview"}else if(extension.includes("mp4")){lien_de_visu="https://docs.google.com/file/d/"+id_fichier+"/preview"}else if(est_image(extension)){lien_de_visu="https://drive.google.com/uc?export=preview&id="+id_fichier}else if(est_youtube(extension)){lien_de_visu="https://www.youtube.com/embed/"+id_fichier}return lien_de_visu}function quitter_previsualisation_bis(){$("#fenetre_bis").remove();if(element_DOM("fenetre_bis"))element_DOM("fenetre_bis").style.overflowY=""}function quitter_previsualisation(){if(element_DOM("previsualisation"))element_DOM("previsualisation").src="";if(element_DOM("viz_frame"))element_DOM("viz_frame").src="";if($("#visio")[0])$("#visio")[0].remove();if($(".ecolage"))$(".toggle").remove();stocker("fichier_ouvert","");element_DOM("fenetre").style.overflowY="";if(element_DOM("previsualisation"))element_DOM("previsualisation").setAttribute("style","");afficher_fenetre(false);ma_tentative={};effacer("tmp_quiz");effacer("proprietaire_devoir")}function initialisation_bouton(bis){element_DOM("pleinecran"+(bis?"_bis":"")).src=prefixe_image+"/img_pleinecran.png";if(element_DOM("fenetre"+(bis?"_bis":"")).style.width==="99%")element_DOM("pleinecran"+(bis?"_bis":"")).src=prefixe_image+"/img_petitecran.png"}function switch_mode(forcing){if(!element_DOM("pleinecran"))return-1;var est_plein_ecran=element_DOM("pleinecran").src.includes(prefixe_image+"/img_pleinecran.png");if(est_plein_ecran||forcing){element_DOM("pleinecran").src=prefixe_image+"/img_petitecran.png";element_DOM("fenetre").style.top=0;element_DOM("fenetre").style.left=0;element_DOM("fenetre").style.width="99%";element_DOM("fenetre").style.height="99%"}else{element_DOM("pleinecran").src=prefixe_image+"/img_pleinecran.png";element_DOM("fenetre").style.top="";element_DOM("fenetre").style.left="";element_DOM("fenetre").style.width="";element_DOM("fenetre").style.height=""}ajuster_boutons_fenetre();choisir_height_viz_si_pdf()}function switch_mode_bis(forcing){if(!element_DOM("pleinecran_bis"))return-1;var est_plein_ecran=element_DOM("pleinecran_bis").src.includes(prefixe_image+"/img_pleinecran.png");if(est_plein_ecran||forcing){element_DOM("pleinecran_bis").src=prefixe_image+"/img_petitecran.png";element_DOM("fenetre_bis").style.top=0;element_DOM("fenetre_bis").style.left=0;element_DOM("fenetre_bis").style.width="99%";element_DOM("fenetre_bis").style.height="99%"}else{element_DOM("pleinecran_bis").src=prefixe_image+"/img_pleinecran.png";element_DOM("fenetre_bis").style.top="";element_DOM("fenetre_bis").style.left="";element_DOM("fenetre_bis").style.width="";element_DOM("fenetre_bis").style.height=""}ajuster_boutons_fenetre(true);initialisation_bouton(true);choisir_height_viz_si_pdf()}function ajuster_boutons_fenetre(bis){nom_bouton_plein_ecran="conteneur_plein_ecran";if(bis)nom_bouton_plein_ecran=nom_bouton_plein_ecran+"_bis";nom_fenetre="fenetre";if(bis)nom_fenetre=nom_fenetre+"_bis";nom_bouton_quittter="bye_prev";if(bis)nom_bouton_quittter=nom_bouton_quittter+"_bis";nom_bouton_telecharger="telechargement";if(bis)nom_bouton_telecharger=nom_bouton_telecharger+"_bis";le_bouton_plein_ecran=element_DOM(nom_bouton_plein_ecran);la_fenetre=element_DOM(nom_fenetre);le_bouton_quittter=element_DOM(nom_bouton_quittter);le_bouton_telecharger=element_DOM(nom_bouton_telecharger);le_bouton_corriger=element_DOM("corriger");if(la_fenetre){if(le_bouton_plein_ecran){var le_top=la_fenetre.offsetTop+la_fenetre.offsetHeight-40+"px";var le_left=la_fenetre.offsetLeft+la_fenetre.offsetWidth-50+"px"}if(le_bouton_quittter){var le_top=la_fenetre.offsetTop+"px";var le_left=la_fenetre.offsetLeft+la_fenetre.offsetWidth-le_bouton_quittter.offsetWidth+"px"}if(le_bouton_telecharger){var le_top=la_fenetre.offsetTop+"px";var le_left=la_fenetre.offsetLeft+la_fenetre.offsetWidth-60+"px"}if(le_bouton_corriger){var le_top=la_fenetre.offsetTop+"px";var le_left=la_fenetre.offsetLeft+la_fenetre.offsetWidth-90+"px"}}}window.addEventListener("resize",function(){calcul_grid_gap_barre_verticale();if(element_DOM("conteneur_plein_ecran")||element_DOM("mini_popup")){ajuster_boutons_fenetre();ajuster_boutons_fenetre(true);choisir_height_viz_si_pdf()}});function afficher_discussions(oui){if(oui){element_DOM("afficher").style.display=""}else{element_DOM("afficher").style.display="none"}}function afficher_ajout(oui){if(!oui){element_DOM("img_ajout").style.display="none"}else{element_DOM("img_ajout").style.display=""}}function afficher_les_dossiers_dynamiques(oui){afficher_le_drive(false);if(oui){element_DOM("liste_matieres").style.display="grid"}else{element_DOM("liste_matieres").style.display="none"}}function avec_bouton_back(oui){if(oui){element_DOM("bouton_precedent").innerHTML='<img alt="<<" src="'+prefixe_image+'/img_retour.png" width = 25 height = 25>';element_DOM("bouton_precedent").addEventListener("click",function(e){decharger_dossier_final()})}else{element_DOM("bouton_precedent").innerHTML=""}if(recuperer("mon_type")==="Administration_bis"||recuperer("mon_type")==="Administration_final"){element_DOM("bouton_precedent").onclick=function(){element_DOM("liste_matieres").innerHTML="";stocker("mon_type","Administration");ajouter_les_dossiers_dynamiques();configurer_profil()}}}function decharger_dossier_final(){positionner_bulle_notif();positionner_pannel_notif();chargement(true);$("#barre_verticale")[0].style.display="";if(recuperer("mon_type").includes("Admin")){element_DOM("liste_matieres").innerHTML=""}ajouter_les_dossiers_dynamiques();afficher_les_dossiers_dynamiques(true);quitter_previsualisation();afficher_fenetre_rendudevoir(false);afficher_ou_non_choix_fichier(false,true);avec_bouton_back(false);afficher_ajout(false);afficher_devoirs(false);afficher_discussions(false);afficher_tri_fichiers(false);afficher_visio(false);enlever_alerte_vide(false);var mes_droits=JSON.parse(recuperer("mes_donnees"))["Droits_modifs"];afficher_logs(mes_droits==="oui");afficher_liste_eleves(recuperer("mon_type").includes("Administration"));afficher_bulletins(recuperer("mon_type").includes("Eleves"));afficher_discussions(false);afficher_params_si_droits_et_admin();stocker_temp("dossier_charg√©","");stocker("les_fichiers","");afficher_discussions(false);stocker("les_topics","");stocker("topic_charg√©","");stocker("nb_com_actuel","");stocker("les_coms","");configurer_profil();window.scrollTo(0,0);chargement(false);positionner_bulle_notif();positionner_pannel_notif()}function afficher_le_drive(oui){if(oui){element_DOM("gros_conteneur").style.display=""}else{element_DOM("gros_conteneur").style.display=""}}function renvoyer_lien_embedded(id_du_dossier,grid){if(id_du_dossier==="")return"";if(grid){var mode="grid"}else{var mode="list"}resultat="https://drive.google.com/embeddedfolderview?id="+id_du_dossier+"#"+mode;return resultat}function configurer_profil(){$("#accueil_utilisateur").on("click",function(){afficher_modif_profil()});mes_donnees=JSON.parse(recuperer("mes_donnees"));var affichage_classe="";if(recuperer("mon_type")==="Eleves"){affichage_classe=mes_donnees["Classe"]}else if(recuperer("mon_type").includes("Administration")){affichage_classe=mes_donnees["Role"]}else if(recuperer("mon_type")==="Profs"){affichage_classe="Professeur"}element_DOM("accueil_utilisateur").innerHTML=mes_donnees["Nom"]+" "+mes_donnees["Pr√©nom(s)"]+"  -  "+affichage_classe;mettre_infos_matiere(false)}initialisation();function mettre_infos_matiere(oui){if(oui&&$(".matiere_description").length===0){$("#accueil_utilisateur").append('<div onclick="infos_matiere()" class="matiere_description sekooly-mode">Plus d\'informations</div>')}else{$(".matiere_description").remove()}}function switch_mode_livres(forcing,par_defaut){if(par_defaut){console.log("par d√©faut");var mode_livre=mode_livres()}else{var mode_livre=!forcing}element_DOM("choix_date_effet").style.visibility=mode_livre?"":"hidden";element_DOM("telechargeable").style.visibility=mode_livre?"":"hidden";element_DOM("est_telechargeable").checked=mode_livre}function mode_livres(){return element_DOM("choix_date_effet").style.visibility==="hidden"}function mode_fichier_initialement(){afficher_choix_youtube(false);afficher_choix_extrait_manuel(false)}function switch_affichage_youtube(){var mode_youtube=element_DOM("est_video_youtube").checked;element_DOM("nom_youtube").value="";element_DOM("lien_youtube").value="";afficher_choix_youtube(mode_youtube);afficher_choix_fichier(!mode_youtube);afficher_checkbox("choix_extrait_manuel",!mode_youtube);afficher_checkbox_fichier_telechargeable(!mode_youtube);$("#est_telechargeable")[0].checked=!mode_youtube;if(mode_youtube){$("#mettre_fichier_en_ligne").on("click",function(e){if(!pre_validation("lien_youtube")){}else if(!$("#nom_youtube")[0].value){afficher_alerte("Vous devez fournir un titre repr√©sentatif de la vid√©o youtube.");$("#nom_youtube")[0].focus()}else if(!est_un_lien_drive()&&!est_un_lien_yt()){afficher_alerte("Vous devez fournir un lien youtube valable.");$("#lien_youtube")[0].focus()}else{chargement(true);var id_fichier=id_youtube_video($("#lien_youtube")[0].value);var nom_fichier=$("#nom_youtube")[0].value+(est_un_lien_drive()?"":".youtube");var categorie_fichier=element_DOM("categorie_choisie").value;var la_date_limite=element_DOM("la_date_limite").value;var lheure_limite=element_DOM("lheure_limite").value;var categorie_fichier=$("#categorie_choisie")[0].value;var date_effet_fichier=$("#date_effet_fichier")[0].value;var heure_effet=$("#heure_effet")[0].value;date_heure_actuelle=maintenant();mes_donnees=JSON.parse(recuperer("mes_donnees"));la_classe=recuperer("mon_type")==="Eleves"?mes_donnees["Classe"]:la_matiere_chargee("Classe");la_matiere=recuperer("mon_type")==="Eleves"?$("#accueil_utilisateur")[0].innerText:la_matiere_chargee("Matiere");le_coef=Number($("#coef")[0].value);console.log("le_coef: "+le_coef);nouveau_fichier={date_publication:date_heure_actuelle,id_fichier:id_fichier,nom_fichier:nom_fichier,id_dossier:recuperer("dossier_charg√©"),proprietaire:recuperer("identifiant_courant"),categorie_fichier:categorie_fichier,la_date_limite:la_date_limite,lheure_limite:lheure_limite,date_effet:date_effet_fichier,heure_effet:heure_effet,est_telechargeable:"non",coefficient_rendu:le_coef,taille_fichier:0,id_chapitre:$("select#id_chapitre")[0].value};ajouter_un_element("Fichiers",nouveau_fichier,id_fichier);id_notif=id_fichier+suite_notif();nouvelle_notif={id_notif:id_notif,Horodateur:date_heure_actuelle,Type_notif:"fichier",Id_source:id_fichier,"Intitul√©":nom_fichier,Identifiant_originaire:recuperer("identifiant_courant"),Role_originaire:mon_role,Identifiant_derniere_modif:recuperer("identifiant_courant"),Role_derniere_modif:mon_role,Classe:la_classe,Classe_matiere:"("+la_classe+"|"+la_matiere+")",Id_classe_matiere:recuperer("dossier_charg√©"),Date_derniere_modif:date_heure_actuelle,Cycle:mes_donnees["Cycle"]};ajouter_un_element("Notifs",nouvelle_notif,id_notif);var texte_final=est_un_lien_drive()?"Le fichier drive a bien √©t√© rattach√© √† la plateforme.":"La vid√©o youtube a bien √©t√© partag√©e.";afficher_alerte(texte_final,true)}})}else{$("#mettre_fichier_en_ligne").off("click")}}function id_youtube_video(url){var regExp=/^.*(youtu\.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;var match=url.match(regExp);if(match&&match[2].length==11){return match[2]}else{return id_lien_drive(url)}}function id_lien_drive(url){var regExp=/[-\w]{25,}/;return url.match(regExp)===null?"ERREUR LIEN":url.match(regExp)[0]}function est_un_lien_yt(){var regExp=/^(?:https?:\/\/)?(?:m\.|www\.)?(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))((\w|-){11})(?:\S+)?$/;var valeur_a_comparer=$("#lien_youtube")[0].value;if(valeur_a_comparer!==""){return valeur_a_comparer.match(regExp)!==null}else{return false}}function est_un_lien_drive(){var valeur_a_comparer=$("#lien_youtube")[0].value;var regExp=/[-\w]{25,}/;if(valeur_a_comparer!==""){return valeur_a_comparer.match(regExp)!==null}else{return false}}function afficher_choix_youtube(oui){element_DOM("youtube").style.display=oui?"":"none"}function afficher_checkbox_fichier_telechargeable(oui){element_DOM("telechargeable").style.display=oui?"":"none"}function afficher_choix_fichier(oui){element_DOM("file").style.display=oui?"":"none"}function ne_rien_rendre(){$("#mettre_fichier_en_ligne")[0].disabled=true;$("#mettre_fichier_en_ligne").on("click","")}function activer_envoi_fichier(){$("#mettre_fichier_en_ligne")[0].disabled=false}function afficher_heure_effet_si_examens(){if($("#categorie_choisie")[0].value==="Examens"){$("#titre_date")[0].innerText="Date et heure de l'√©preuve:";$("#heure_effet")[0].style.display="";$("#heure_effet")[0].value="07:30"}else{$("#titre_date")[0].innerText="Date d'effet:";$("#heure_effet")[0].style.display="none";$("#heure_effet")[0].value=""}}function pre_validation(nom_champ_obli){if($("#categorie_choisie")[0].value==="--"){afficher_alerte("Merci de choisir la cat√©gorie de votre fichier.");return false}else{}if(($("#"+nom_champ_obli)[0].value===""||$("#"+nom_champ_obli)[0].value==="--")&&!image_temporaire){afficher_alerte("Merci de choisir le fichier, l'extrait de manuel, ou le lien youtube que vous d√©sirez partager.");return false}if($("#date_effet_fichier")[0].value===""||$("#date_effet_fichier")[0].value===null){afficher_alerte("Merci de choisir la date d'effet de votre fichier.");return false}else{}if($("#categorie_choisie")[0].value==="Examens"){if($("#heure_effet")[0].value===""||$("#heure_effet")[0].value===null){afficher_alerte("Merci de choisir l'heure d'effet de votre fichier d'Examen.");return false}else{}}if($("#categorie_choisie")[0].value==="Devoirs"&&element_DOM("la_date_limite").value===""){afficher_alerte("Merci de choisir la date limite du devoir.");return false}else{}if($("#categorie_choisie")[0].value==="Devoirs"&&element_DOM("lheure_limite").value.length<5){afficher_alerte("Merci de choisir l'heure du devoir.");return false}else{}if(impossible_de_cliquer()){afficher_alerte("Merci de patienter.");return false}return true}function base64toBlob(base64Data,contentType){contentType=contentType||"";var sliceSize=1024;var byteCharacters=atob(base64Data.split(",")[1]);var bytesLength=byteCharacters.length;var slicesCount=Math.ceil(bytesLength/sliceSize);var byteArrays=new Array(slicesCount);for(var sliceIndex=0;sliceIndex<slicesCount;++sliceIndex){var begin=sliceIndex*sliceSize;var end=Math.min(begin+sliceSize,bytesLength);var bytes=new Array(end-begin);for(var offset=begin,i=0;offset<end;++i,++offset){bytes[i]=byteCharacters[offset].charCodeAt(0)}byteArrays[sliceIndex]=new Uint8Array(bytes)}return new Blob(byteArrays,{type:contentType,name:nom_image_temporaire})}$(function charger_fichiers(e){var lien_script="https://script.google.com/macros/s/AKfycbwKm1M_Hm2n8bAyqq3jAcDyL65EqKn1-3VMXIw4jMpzqnIeQQI/exec";var params={};var nom_fichier;var extension;$("#file").on("change",function(){var les_fichiers=this.files;var nb_fichiers=les_fichiers.length;var file=image_temporaire?base64toBlob(image_temporaire,"image/png"):les_fichiers[0];nom_fichier=nom_image_temporaire?nom_image_temporaire:file.name;extension=nom_fichier.split(".").pop().toUpperCase();le_coef=Number($("#coef")[0].value);$("#mettre_fichier_en_ligne").on("click",function(e){e.preventDefault();var categorie_fichier=$("#categorie_choisie")[0].value;var prevalid=pre_validation("file");if(prevalid===false){return-1}if(file.size>25e6){afficher_alerte("Votre fichier exc√®de 25 MO: impossible de le mettre en ligne.");return-1}var fr=new FileReader;fr.onprogress=function(e){chargement(true)};fr.onload=function(e){params.file=e.target.result.replace(/^.*,/,"");categorie_fichier=element_DOM("categorie_choisie").value;la_date_limite=element_DOM("la_date_limite").value;lheure_limite=element_DOM("lheure_limite").value;date_effet_fichier=$("#date_effet_fichier")[0].value;heure_effet=$("#heure_effet")[0].value;if(categorie_fichier==="Bulletins"){if(extension.toLowerCase()!=="pdf"){afficher_alerte("Le fichier de bulletins doit √™tre un fichier pdf.");chargement(false);return-1}liste_destinataires=$("#attribution").serialize().split("&");destinataire_par_page={};liste_destinataires.forEach(function(valeur,index){numero_page=valeur.split("=")[0];id_eleve=decodeURIComponent(valeur.split("=")[1]);if(destinataire_par_page[id_eleve]){destinataire_par_page[id_eleve]=destinataire_par_page[id_eleve]+","+numero_page}else{destinataire_par_page[id_eleve]=numero_page}});destinataire_par_page=JSON.stringify(destinataire_par_page);periode_bulletin=$("[name='periode_bulletin']")[0].value;envoyer_le_fichier(categorie_fichier,la_date_limite,lheure_limite,date_effet_fichier,heure_effet,le_coef,file.size,destinataire_par_page,periode_bulletin)}else{envoyer_le_fichier(categorie_fichier,la_date_limite,lheure_limite,date_effet_fichier,heure_effet,le_coef,file.size)}};fr.readAsDataURL(file)});categorie_fichier=element_DOM("categorie_choisie").value;la_date_limite=element_DOM("la_date_limite").value;lheure_limite=element_DOM("lheure_limite").value;date_effet_fichier=$("#date_effet_fichier")[0].value;heure_effet=$("#heure_effet")[0].value;$("#attribution").remove();$("#trimestre").remove();if(categorie_fichier==="Bulletins"){if(extension.toLowerCase()!=="pdf"){afficher_alerte("Le fichier de bulletins doit √™tre un fichier pdf.");chargement(false);return-1}else{nombre_de_pages_pdf=-1;var fr2=new FileReader;fr2.onload=function(e){nombre_de_pages_pdf=0;pdf=new Uint8Array(e.target.result);try{PDFJS.getDocument({data:pdf}).then(function(pdf){nombre_de_pages_pdf=pdf.pdfInfo.numPages;creer_attribution_page_eleve(nombre_de_pages_pdf,$("#mettre_fichier_en_ligne"))})}catch(e){console.error(e);alert("Impossible de d√©tecter le nombre de pages du pdf : merci de r√©essayer avec un autre fichier.");return 0}};fr2.readAsArrayBuffer(file)}}});$("#categorie_choisie").on("change",function(){afficher_eventuelle_alerte_effet();afficher_eventuelle_alerte_limite();if($("#categorie_choisie")[0].value==="Devoirs"){afficher_choix_date(true)}else{afficher_choix_date(false)}if($("#categorie_choisie")[0].value==="Devoirs"||$("#categorie_choisie")[0].value==="Examens"){afficher_choix_coef(true)}else{afficher_choix_coef(false)}changement_quiz_ou_non();if($("#categorie_choisie")[0].value==="Manuels"){switch_mode_livres(true)}else{switch_mode_livres(false)}afficher_heure_effet_si_examens()});$("#date_effet_fichier").on("change",function(){if($("#date_effet_fichier")[0].value==="")$("#date_effet_fichier")[0].value=moment().format("yyyy-MM-DD");afficher_eventuelle_alerte_effet()});$("#la_date_limite").on("change",function(){afficher_eventuelle_alerte_limite()});$("#heure_effet").on("change",function(){if($("#heure_effet")[0].value===""&&$("#categorie_choisie")[0].value==="Examens"){$("#heure_effet")[0].value="07:30"}});function creer_attribution_page_eleve(nombre_pages,bouton_ok){toutes_les_classes=JSON.parse(recuperer("mes_matieres"));classe_chargee=toutes_les_classes.filter(e=>e["ID_URL"]===recuperer("dossier_charg√©"))[0]["Classe"];url=racine_data+"Eleves?Classe=eq."+classe_chargee+"&"+apikey;liste_eleves=get_resultat(url);liste_eleves=liste_eleves.sort(function(a,b){if(a.Identifiant<b.Identifiant){return-1}if(a.Identifiant>b.Identifiant){return 1}return 0});select_liste_eleves='<select style="width: 80%;" name="numero_page" id="numero_page">';select_liste_eleves=select_liste_eleves+creer_liste_eleves("--","--");liste_eleves.forEach(function(valeur,index){select_liste_eleves=select_liste_eleves+creer_liste_eleves(valeur["Identifiant"],valeur["Nom"]+" "+valeur["Pr√©nom(s)"])});select_liste_eleves=select_liste_eleves+"</select>";attribution='<form id="trimestre" style=""><b><label for="periode_bulletin">Trimestre:<select style="width: 60%;" name="periode_bulletin"><option value="PREMIER TRIMESTRE">PREMIER TRIMESTRE</option><option value="DEUXIEME TRIMESTRE">DEUXIEME TRIMESTRE</option><option value="TROISIEME TRIMESTRE">TROISIEME TRIMESTRE</option><option value="ANNUEL">ANNUEL</option></select></label></b></form>';attribution=attribution+'<form id="attribution" style="margin-top: 20px;">';for(numero_page=1;numero_page<=nombre_pages;numero_page++){attribution=attribution+'<div><label for="'+numero_page+'">Page n¬∞'+numero_page+":"+select_liste_eleves.replace(/"numero_page"/g,numero_page)+"</label></div>"}attribution=attribution+"</form>";$(attribution).insertBefore(bouton_ok);for(numero_page=1;numero_page<=nombre_pages;numero_page++){$("#"+numero_page)[0].value=liste_eleves[numero_page-1]["Identifiant"]}}function creer_liste_eleves(identifiant_eleve,nom_complet_eleve){return'<option value="'+identifiant_eleve+'">'+nom_complet_eleve+"</option>"}function afficher_choix_date(oui){if(oui){element_DOM("choix_date").style.display="grid"}else{element_DOM("choix_date").style.display="none"}}function envoyer_le_fichier(categorie_fichier,la_date_limite,lheure_limite,date_effet_fichier,heure_effet,coefficient_rendu,taille_fichier,destinataire_par_page,periode_bulletin){var html='<form method="post"  action="'+lien_script+'" id="envoyer_le_fichier" style="display: none;" >';html+='<input type="hidden" name="API_KEY_UPLOAD" value="'+recuperer("API_KEY_UPLOAD")+'" >';html+='<input type="hidden" name="nom_fichier" value="'+nom_fichier+'" >';html+='<input type="hidden" name="extension" value="'+extension+'" >';html+='<input type="hidden" name="file" value="'+params.file+'" >';html+='<input type="hidden" name="folderID" value="'+recuperer("dossier_charg√©")+'" >';html+='<input type="hidden" name="proprietaire" value="'+recuperer("identifiant_courant")+'" >';html+='<input type="hidden" name="categorie_fichier" value="'+categorie_fichier+'" >';html+='<input type="hidden" name="la_date_limite" value="'+la_date_limite+'" >';html+='<input type="hidden" name="lheure_limite" value="'+lheure_limite+'" >';html+='<input type="hidden" name="date_effet_fichier" value="'+date_effet_fichier+'" >';html+='<input type="hidden" name="heure_effet" value="'+heure_effet+'" >';html+='<input type="hidden" name="coefficient_rendu" value="'+coefficient_rendu+'" >';html+='<input type="hidden" name="taille_fichier" value="'+taille_fichier+'" >';html+='<input type="hidden" name="destinataire_par_page" value="'+destinataire_par_page?destinataire_par_page:""+'" >';html+='<input type="hidden" name="periode_bulletin" value="'+periode_bulletin?periode_bulletin:""+'" >';html+="</form>";$("body").append(html);$("#envoyer_le_fichier").submit(function(e){e.preventDefault();if(!extension_ok(extension)){alert("L'extension du fichier n'est pas support√© par la plateforme, merci de r√©essayer avec l'un de ces formats: bmp, gif, jpeg, jpg, png, svg, pdf, bmp, xlsx, xls, xlsm, ppt, pptx, doc, docx, txt, html, csv, js, rtf, mp4, mp3, wav");chargement(false);activer_envoi_fichier();return-1}ne_rien_rendre();var form=$(this);var url=form.attr("action");$.ajax({type:"POST",url:url,data:form.serialize(),success:function(data){var msg_alerte=element_DOM("snackbar");msg_alerte.innerText="Votre fichier a bien √©t√© mis en ligne.";msg_alerte.className="show";date_heure_actuelle=maintenant();mes_donnees=JSON.parse(recuperer("mes_donnees"));la_classe=recuperer("mon_type")==="Eleves"?mes_donnees["Classe"]:la_matiere_chargee("Classe");la_matiere=recuperer("mon_type")==="Eleves"?$("#accueil_utilisateur")[0].innerText:la_matiere_chargee("Matiere");est_telechargeable=$("#est_telechargeable")[0].checked?"oui":"non";nouveau_fichier={date_publication:date_heure_actuelle,id_fichier:data,nom_fichier:nom_fichier,id_dossier:recuperer("dossier_charg√©"),proprietaire:recuperer("identifiant_courant"),categorie_fichier:categorie_fichier,la_date_limite:la_date_limite,lheure_limite:lheure_limite,date_effet:date_effet_fichier,heure_effet:heure_effet,est_telechargeable:est_telechargeable,coefficient_rendu:coefficient_rendu,taille_fichier:taille_fichier,destinataire_par_page:destinataire_par_page,periode_bulletin:periode_bulletin};ajouter_un_element("Fichiers",nouveau_fichier,data);id_notif=data+suite_notif();nouvelle_notif={id_notif:id_notif,Horodateur:date_heure_actuelle,Type_notif:"fichier",Id_source:data,"Intitul√©":nom_fichier,Identifiant_originaire:recuperer("identifiant_courant"),Role_originaire:mon_role,Identifiant_derniere_modif:recuperer("identifiant_courant"),Role_derniere_modif:mon_role,Classe:la_classe,Classe_matiere:"("+la_classe+"|"+la_matiere+")",Id_classe_matiere:recuperer("dossier_charg√©"),Date_derniere_modif:date_heure_actuelle,Cycle:mes_donnees["Cycle"]};ajouter_un_element("Notifs",nouvelle_notif,id_notif);setTimeout(function(){msg_alerte.className="";location.reload()},3e3);chargement(false)},error:function(data){var msg_alerte=element_DOM("snackbar");msg_alerte.innerText="Erreur interne du serveur, veuillez r√©essayer. Assurez-vous d'√™tre toujours connect√© √† internet.";msg_alerte.className="show";chargement(false)}})});$("#envoyer_le_fichier").submit();$("#envoyer_le_fichier").remove()}});function fichier_devoir_ou_examen(){var categorie_fichier=$("#categorie_choisie")[0].value;return categorie_fichier==="Devoirs"||categorie_fichier==="Examens"}function afficher_eventuelle_alerte_effet(){if(fichier_devoir_ou_examen()){afficher_les_devoirs_de_la_date("date_effet",$("#date_effet_fichier")[0].value,"mere_effet","nb_devoirs_effet")}else{$("#mere_effet")[0].style.display=""}}function afficher_eventuelle_alerte_limite(){if(fichier_devoir_ou_examen()){afficher_les_devoirs_de_la_date("la_date_limite",$("#la_date_limite")[0].value,"mere_limite","nb_devoirs_limite")}else{$("#mere_limite")[0].style.display=""}}async function afficher_les_devoirs_de_la_date(champ_date_reference,valeur_champ_date_reference,id_mere,id_nb_devoirs){var classe_id=JSON.parse(recuperer("mes_matieres")).find(e=>e["ID_URL"]===recuperer("dossier_charg√©"))["classe_id"];var toutes_les_matieres=await rechercher("Matieres","classe_id",classe_id,"ID_URL");les_id_dossier_classe='("'+toutes_les_matieres.map(e=>e["ID_URL"]).join('","')+'")';url=racine_data+"Fichiers?"+apikey;url+='&categorie_fichier=in.("Devoirs","Examens")';url+="&"+champ_date_reference+"=eq."+valeur_champ_date_reference;url+="&id_dossier=in."+les_id_dossier_classe;var nb_devoirs=get_resultat(url).length;if(nb_devoirs>0){$("[id='"+id_nb_devoirs+"']")[0].innerText=nb_devoirs;$("#"+id_mere)[0].style.display="block"}else{$("#"+id_mere)[0].style.display=""}}document.onclick=function(e){if(e.target.id===""&&e.target.onclick===null&&e.target.classeName===""){quitter_previsualisation()}if(typeof e.target.className==="string"){if(e.target.id!=="bulle_notif"&&e.target.id!=="recup_notifs"&&!e.target.className.includes("notif")&&e.target.id!=="rien_lire"&&e.target.id!=="tout_lire"){virer_le_pannel_notifs()}}if(!e.target.id.toLowerCase().includes("devoir")&&!e.target)afficher_fenetre_rendudevoir(false);if(e.target.nodeName==="BODY"||e.target.id==="gros_conteneur"||e.target.id==="liste_matieres"||e.target.id.includes("drive_")){masquer_config_mode();fermer_side_bar()}};$(document).keyup(function(e){if(e.key==="Escape"){quitter_previsualisation();afficher_fenetre_rendudevoir(false);virer_le_pannel_notifs();afficher_ou_non_choix_fichier(false);masquer_config_mode()}if(e.key==="¬§"){mode_edition_sql()}});async function mode_edition_sql(){if(recuperer("identifiant_courant").includes("admin")){confirmation=prompt("Merci de saisir votre code d'acc√®s.");if(confirmation){c=await recuperer_mes_donnees();if(!code_ok(c,confirmation)){afficher_alerte("Code d'acc√®s erron√©, mode administrateur non activ√©.")}else{zknrsbnfwz()}}}}function zknrsbnfwz(){vider_fenetre("Mode ADMIN - SQL");afficher_fenetre(true);$("#fenetre").append(contenu_admin());$("#query").focus()}function changer_alerte_exe(id_alerte,alerte_exe,couleur_finale,mode_ajout){if(!element_DOM("remarque-exe"))return false;var nouvelle_remarque=document.createElement("div");nouvelle_remarque.id=id_alerte;nouvelle_remarque.innerHTML="<b>"+new Date+"</b> \t"+alerte_exe;nouvelle_remarque.style.color=couleur_finale;nouvelle_remarque.style.paddingBottom="10px";if(!mode_ajout)$("#remarque-exe")[0].innerHTML="";element_DOM("remarque-exe").appendChild(nouvelle_remarque)}function contenu_admin(){return`
				<div id="mode-admin" class="mode-admin"><div id="attention-admin" class="attention-admin">
					<b>
						<rouge>ATTENTION, SI VOUS √äTES ICI SANS LE VOULOIR, QUITTEZ DIRECTEMENT CETTE FEN√äTRE.</rouge>
					</b>
					<div>VOUS √äTES EN MODE ADMINISTRATEUR.</div>
					</div>
					  
					<div>
					  	<label for="query">Votre requ√™te SQL:</label>
					  	<textarea name="query" id="query" class="query"></textarea>
				  	</div>
				</div>

				<div class="au-centre">
					<div>
					  <input type="checkbox" id="mode-select" name="mode-select" checked="">
					  <label for="mode-select">En mode SELECT</label> 
					</div>
					<button class="btn-exe" onclick="exe_sql()" id="exe">Ex√©cuter le code SQL</button>

					<button style="display:none;" class="btn-exe" id="deploy">Continuer</button>
					<div id="remarque-exe"></div>
				</div>

			`}async function exe_sql(){var tous=await recherche_initiale("Etablissements");var data_testo=tous.find(e=>e["nom_etablissement"]==="testo");await exe_sql_unitaire(data_testo);$("#deploy").show();chargement(false);$("#deploy").off("click");$("#deploy").one("click",function(){$("#deploy").hide();$("#deploy").off("click");tous=tous.filter(e=>e["nom_etablissement"]!=="testo");tous.forEach(async function(data){await exe_sql_unitaire(data,true)});chargement(false)})}async function exe_sql_unitaire(data,mode_ajout){chargement(true);var requete_sql=element_DOM("query").value;var id_alerte=data["id_etablissement"];var retour='<span class="affichage_etablissement">'+data["nom_etablissement"]+"</span>"+": ";try{var resultat=await execute_sql(data["racine_data"],requete_sql,element_DOM("mode-select").checked);retour+=JSON.stringify(resultat);var couleur_finale="green"}catch(e){retour+=JSON.stringify(e);var couleur_finale="red"}changer_alerte_exe(id_alerte,retour,couleur_finale,mode_ajout)}function charger_les_topics(forcing){if(impossible_de_cliquer()&&!forcing)return-1;est_deja_ouvert=element_DOM("fenetre").style.visibility==="visible";if(forcing)est_deja_ouvert=false;afficher_fenetre(!est_deja_ouvert);return recuperer_les_topics(false)}function html_boutons_fenetre(nom_fonction_actualiser,nom_fonction_ajouter,texte_aide){return'<div id="entete-fenetre" style="text-align: center;"> <img alt="actualiser"  src="'+prefixe_image+'/img_actualiser.png" onclick="'+nom_fonction_actualiser+'" id="actu_topics" style="width: 30px; cursor: pointer;"> <img alt="ajouter" src="'+prefixe_image+'/img_ajout.png" onclick="'+nom_fonction_ajouter+'" id="nouvelle_discu" style="width: 30px; cursor: pointer;"></div><div id="entete-fenetre" style="text-align: center;color: #c1c1c1;font-size: 13px;border-bottom-width: 1px;border-bottom-style: ridge;">'+texte_aide+"</div>"}function ajouter_une_discu(){var probleme=false;if(probleme){alert("Impossible de cr√©er une question/discussion pour le moment.");return-1}if(impossible_de_cliquer())return-1;if(!recuperer("mon_type").includes("Admin")&&element_DOM("accueil_utilisateur").innerText.includes("Vie scolaire")){alert("Vous n'avez pas les droits pour publier une discussion dans la Vie Scolaire. Pour tout probl√®me constat√© sur la plateforme, envoyez directement un mail √† "+data_etablissement["contact_etablissement"]+".");return-1}vider_fenetre("Nouvelle discussion");element_DOM("maquestion").src="";var nouveau_message='<form id="mon_formulaire" autocomplete="off" class="edition"><label id="label" for="titre_question">Titre: </label><input type="text" id="titre_question" maxlength="50" style="width: 100%;">\t<br><br><label id="label" for="contenu_question">Votre message: </label><textarea id="contenu_question" maxlength="1700" style="width: 100%;height: 70%;resize: none;font-size: 13px;"></textarea><div id="nb_max_div" style="margin-left: 90%;margin-top: 0%;font-size: 10px; display:none;"> <font id="nb_max"> 0 / 1700</font> </div><div id="mes_boutons" style="text-align: center;padding: 1%;display: block ruby;"><button  class="bouton_sekooly" type="button" id="Annuler" onclick="recuperer_les_topics(false)"> Annuler </button><button  class="bouton_sekooly" type="button" id="envoi" onclick="envoyer_le_topic()"> Poster </button></div><div id="msg_erreur" style="text-align: center;padding: 1%;color: green;"> </div></form>';var mon_message=document.createElement("span");mon_message.innerHTML=nouveau_message;element_DOM("fenetre").appendChild(mon_message);rendre_riche("contenu_question",true);element_DOM("titre_question").focus()}function changer_nb_caracteres(){element_DOM("nb_max").innerText=element_DOM("contenu_question").textLength+" / 1700"}function actualiser_topics(){recuperer_les_topics(true)}function actualiser_coms(id_topic){charger_question(id_topic,true)}function envoyer_le_com(id_topic,mon_identifiant,mon_role,contenu_poste_bis,date){var contenu_poste=contenu_poste_bis;var le_mot_interdit=chercher_le_mot_interdit(contenu_poste);if(le_mot_interdit!==""){alert("Vous n'avez pas le droit d'utiliser le terme '"+le_mot_interdit+"' dans le cadre des cours √† "+nom_etablissement+" sur SEKOOLY.");return-1}element_DOM("envoicommentaire").disabled=true;chargement(true);nom_table="Topic";nb_com=nb_coms(id_topic)+1;stocker("nb_com_actuel",nb_com);date_heure_actuelle=maintenant();nouveau_com={Horodateur:date_heure_actuelle,Id_topic:id_topic,Votre_commentaire:recuperer_html_saisie_riche(),Identifiant:recuperer("identifiant_courant"),Role:mon_role};ajouter_un_element("Coms",nouveau_com);actualiser("Topic","Id_topic",id_topic,{Nombre_de_coms:nb_com});nom_table="Notifs";nom_champ_reference="Id_source";valeur_champ_reference=id_topic;nouvelles_donnees_notif={Date_derniere_modif:date_heure_actuelle,Identifiant_derniere_modif:recuperer("identifiant_courant"),Role_derniere_modif:mon_role};actualiser(nom_table,nom_champ_reference,id_topic,nouvelles_donnees_notif);ajouter_un_commentaire(mon_identifiant,mon_role,contenu_poste_bis,date,"nouveau_com");ajouter_bloc_commenter(false,"ajouter_mon_com()","Commenter");ajouter_bloc_commenter(true,"ajouter_mon_com()","Commenter");$("#retour").on("click",function(){recuperer_les_topics(true)});stocker("les_coms","");chargement(false)}function chercher_le_mot_interdit(phrase){if(!data_etablissement["mots_interdits"])return"";var mots_interdits=data_etablissement["mots_interdits"].split(",");var le_mot_interdit="";mots_interdits.some(function(valeur_mot){contient=phrase.toLowerCase().includes(valeur_mot.toLowerCase());le_mot_interdit=contient?valeur_mot:"";return contient});return le_mot_interdit}function envoyer_le_topic(){var mon_titre=encodeURIComponent(element_DOM("titre_question").value.trim());var mon_contenu=recuperer_html_saisie_riche();var mon_identifiant=recuperer("identifiant_courant");var le_mot_interdit=chercher_le_mot_interdit(mon_contenu);if(le_mot_interdit!==""){alert("Vous n'avez pas le droit d'utiliser le terme '"+le_mot_interdit+"' dans le cadre des cours √† "+nom_etablissement+" sur SEKOOLY.");return-1}var mon_id_classe_matiere=recuperer("dossier_charg√©");if(mon_titre!==""&&mon_contenu!==""&&!mon_contenu.includes(saisie_vide())){element_DOM("envoi").disabled=true;nom_table="Topic";date_heure_actuelle=maintenant();id_topic=nouvel_id(nom_table,"Id_topic");nouveau_topic={Id_topic:id_topic,Horodateur:date_heure_actuelle,Titre:$("#titre_question")[0].value,Votre_message:recuperer_html_saisie_riche(),Identifiant:recuperer("identifiant_courant"),Id_classe_matiere:recuperer("dossier_charg√©"),Role:mon_role,Nombre_de_coms:0};ajouter_un_element(nom_table,nouveau_topic,id_topic);nom_table="Notifs";mes_donnees=JSON.parse(recuperer("mes_donnees"));la_classe=recuperer("mon_type")==="Eleves"?mes_donnees["Classe"]:la_matiere_chargee("Classe");la_matiere=recuperer("mon_type")==="Eleves"?$("#accueil_utilisateur")[0].innerText:la_matiere_chargee("Matiere");id_notif=id_topic;nouvelle_notif={id_notif:id_notif,Horodateur:date_heure_actuelle,Type_notif:"discussion",Id_source:id_topic,"Intitul√©":$("#titre_question")[0].value,Identifiant_originaire:recuperer("identifiant_courant"),Role_originaire:mon_role,Identifiant_derniere_modif:recuperer("identifiant_courant"),Role_derniere_modif:mon_role,Classe:la_classe,Classe_matiere:"("+la_classe+"|"+la_matiere+")",Id_classe_matiere:recuperer("dossier_charg√©"),Date_derniere_modif:date_heure_actuelle,Cycle:mes_donnees["Cycle"]};ajouter_un_element(nom_table,nouvelle_notif,id_notif);setTimeout(function(){actualiser_topics()},1500)}else{var msg_erreur="Il faut un titre et un contenu de message.";changer_msg_erreur(msg_erreur,true)}chargement(false);return false}function changer_msg_erreur(msg,erreur){if(erreur)element_DOM("msg_erreur").style.color="red";if(!erreur){vider_fenetre();ajouter_div_msg_erreur();element_DOM("msg_erreur").style.marginTop="20%";element_DOM("msg_erreur").style.color="green";setTimeout(function(){stocker("les_topics","");window.location.href=window.location.href},3e3)}element_DOM("msg_erreur").innerText=msg}function vider_fenetre(titre_fenetre,est_visio,save_button_function){element_DOM("fenetre").innerHTML="";var clique_quitter=est_visio?"":'onclick="quitter_previsualisation()"';var bouton_quitter='<div id="entete-fenetre" style="display: inline-flex;float: right;"><img alt="X" src="'+prefixe_image+'/quitter.png" id="bye_prev" class="bye_prev" '+clique_quitter+" > </div>";var le_titre="";if(titre_fenetre)le_titre='<div class="titre_fenetre" id="titre_fenetre">'+titre_fenetre+"</div>";var plein_ecran='<div class="fullscreen-btn" id="conteneur_plein_ecran" > <img alt="plein √©cran" style="position: fixed;" id="pleinecran" src="'+prefixe_image+'/img_petitecran.png" onclick="switch_mode()" class="pleinecran"> </div>';var elements=document.createElement("div");elements.innerHTML=bouton_quitter+le_titre+plein_ecran;while(elements.firstChild){element_DOM("fenetre").appendChild(elements.firstChild)}avec_sauvegarde(save_button_function);ajuster_boutons_fenetre();initialisation_bouton()}function charger_question(id_topic,forcing,scroller_en_bas){if(id_topic){stocker("topic_charg√©",id_topic);recuperer_les_coms(id_topic,forcing,scroller_en_bas)}return true}function recuperer_les_coms(id_topic_long,forcing,scroller_en_bas){chargement(true);var topic_charg√©=recuperer("topic_charg√©");if(topic_charg√©===null)topic_charg√©="";var le_topic_deja_charge=topic_charg√©.toString();var id_topic=id_topic_long.toString();stocker("nb_com_actuel",$("u#"+id_topic+".nb_com_actuel")[0].innerText);ajouter_poste_initial(id_topic_long);if(id_topic!==le_topic_deja_charge||forcing===true){stocker("les_coms","")}if(recuperer("les_coms")===null||recuperer("les_coms")===""||recuperer("les_coms")==="[]"||forcing){nom_table="Coms";nom_champ_reference="Id_topic";valeur_champ_reference=id_topic;rechercher(nom_table,nom_champ_reference,valeur_champ_reference).then(le_poste=>{les_coms=le_poste;if(les_coms!==undefined&&les_coms!==null&&les_coms.length>0){stocker("topic_charg√©",id_topic.toString());stocker("les_coms",JSON.stringify(les_coms));traitement_coms(id_topic,scroller_en_bas)}})}else{traitement_coms(id_topic,scroller_en_bas)}chargement(false)}function ajouter_poste_initial(id_topic){var les_topics=JSON.parse(recuperer("les_topics"));var le_topic_obj=les_topics.filter(function(valeur){return valeur["Id_topic"].toString()===id_topic.toString()});var le_topic=le_topic_obj[0];vider_fenetre("");var titre_poste=le_topic["Titre"];var auteur_poste=le_topic["Identifiant"].toUpperCase();var role_auteur_poste=le_topic["Role"];var contenu_poste=decodage(le_topic["Votre_message"]);var date=afficher_date(le_topic["Horodateur"]);var entete_poste='\t<div id="entete_poste" style="display: flex;overflow-wrap: anywhere;"><img id="<<" src="'+prefixe_image+'/img_retour.png" style="width: 30px;margin: 2%;cursor:pointer;height: 30px;"  onclick="recuperer_les_topics(false)"> <div id="titre_du_poste" style="font-weight: bold;margin: 2%;font-size: 25px;">'+titre_poste+"</div></div>";var entete=document.createElement("div");entete.innerHTML=entete_poste;element_DOM("fenetre").appendChild(entete);var bloc_poste='<div id="bloc_poste" style="padding: 2%;display: block;overflow-wrap: anywhere;border-bottom-style: solid;"><div class="auteur_du_poste" >'+auteur_poste+" ("+role_auteur_poste+')</div><h id="contenu_poste" style=""> '+contenu_poste+'</h><h style="color: #B5B3B8;" id="date_poste"> '+date+"</h></div>";var emplacement_commentaire='<div id="emplacement_commentaire"></div>';var les_commentaires=document.createElement("div");les_commentaires.id="liste_des_coms";les_commentaires.style.overflow="hidden auto";les_commentaires.style.height="85%";les_commentaires.innerHTML=bloc_poste+emplacement_commentaire;element_DOM("fenetre").appendChild(les_commentaires);ajouter_bloc_commenter(true,"ajouter_mon_com()","Commenter")}function ajouter_bloc_commenter(oui,fonction_ajout_commentaire,intitule_bouton){if(oui){var bloc_commenter='<div id="bloc_commenter"><textarea id="mon_com" style="display:inline-block; width:100%; resize: unset; min-height:200px; overflow-y:hidden;" placeholder="Votre commentaire..." maxlength="1500"></textarea><button id="envoicommentaire" onclick="'+fonction_ajout_commentaire+'" style="height: 30px;background-color: #FF6C00;">'+intitule_bouton+"</button></div>";var le_bloc=document.createElement("div");le_bloc.innerHTML=bloc_commenter;while(le_bloc.firstChild){element_DOM("liste_des_coms").appendChild(le_bloc.firstChild)}rendre_riche("mon_com")}else{if(element_DOM("bloc_commenter")!==null)element_DOM("bloc_commenter").remove()}}function traitement_coms(id_topic_str,scroller_en_bas){chargement(true);var les_coms=JSON.parse(recuperer("les_coms"));les_coms=Object.keys(les_coms).map(i=>les_coms[i]);les_coms=les_coms.sort(function tri_ordre_chrono_croissant(a,b){return convertir_en_date(a.Horodateur)-convertir_en_date(b.Horodateur)});var id_com=0;les_coms.forEach(function(valeur){if(valeur!==null){var auteur_poste=valeur["Identifiant"].toUpperCase();var role_auteur_poste=valeur["Role"];var contenu_poste=valeur["Votre_commentaire"];var date=afficher_date(valeur["Horodateur"]);id_com=valeur["id_com"];ajouter_un_commentaire(auteur_poste,role_auteur_poste,contenu_poste,date,id_com)}});if(scroller_en_bas){var position_scroll=$("#bloc_commenter")[0].offsetTop-$("#bloc_commenter")[0].offsetHeight;$("#liste_des_coms").scrollTop(position_scroll);changer_couleur_temporairement(id_com,"un_commentaire","#5e5e5e",700)}chargement(false)}function ajouter_un_commentaire(auteur_poste,role_auteur_poste,contenu_poste,date,id_com){contenu_poste=decodage(contenu_poste);var un_com='<div id="'+id_com+'" class="un_commentaire"><div class="auteur_du_poste" style="font-weight: bold;color: #FF6C00;">'+auteur_poste+" ("+role_auteur_poste+')</div><h id="contenu_poste" style=""> '+contenu_poste+'</h><h style="color: #B5B3B8;" id="date_poste"> '+date+"</h></div>";var nouveau_com=document.createElement("div");nouveau_com.innerHTML=un_com;if(element_DOM("emplacement_commentaire")){while(nouveau_com.firstChild){element_DOM("emplacement_commentaire").appendChild(nouveau_com.firstChild)}}}function ajouter_mon_com(){chargement(true);var contenu_poste=recuperer_html_saisie_riche().trim();contenu_vide=contenu_poste.includes(saisie_vide());if(contenu_poste!==""&&!contenu_vide){var mon_identifiant=recuperer("identifiant_courant").toUpperCase();var date=afficher_date(maintenant());id_topic=recuperer("topic_charg√©");envoyer_le_com(id_topic,mon_identifiant,mon_role,contenu_poste,date)}else{alert("Votre commentaire ne peut pas √™tre vide.")}chargement(false)}function recuperer_les_topics(forcing){chargement(true);vider_fenetre("");afficher_fenetre(true);element_DOM("fenetre").innerHTML+=html_boutons_fenetre("actualiser_topics()","ajouter_une_discu()","Pour commenter, cliquez sur une question/discussion");if(forcing||recuperer("les_topics")===null||recuperer("les_topics")===""){nom_table="Topic";nom_champ_reference="Id_classe_matiere";valeur_champ_reference=recuperer("dossier_charg√©");nom_champ_a_chercher="";return rechercher(nom_table,nom_champ_reference,valeur_champ_reference,nom_champ_a_chercher).then(les_topics=>{les_topics.sort(function tri_ordre_chrono_decroissant(a,b){return convertir_en_date(b.Horodateur)-convertir_en_date(a.Horodateur)});stocker("les_topics",JSON.stringify(les_topics));traitement_topics();chargement(false)})["catch"](e=>{console.error(e);alert("Impossible de r√©cup√©rer les questions/discussions de cette mati√®re. V√©rifiez que vous √™tes toujours connect√© √† internet, ou r√©essayer plus tard.");chargement(false)})}else{traitement_topics();chargement(false);return true}}function traitement_topics(){stocker("les_coms","");if(recuperer("les_topics").length===0||recuperer("les_topics")==="[]"){commentaire='<div id="vide" style="text-align: center;color: grey;margin: 10%;"> <i id="vide"> Il n\'y a pas encore de questions pos√©es dans ce cours. </i> </div>';var mon_commentaire=document.createElement("div");mon_commentaire.innerHTML=commentaire;while(mon_commentaire.firstChild){element_DOM("fenetre").appendChild(mon_commentaire.firstChild)}}else{var liste_des_topics=JSON.parse(recuperer("les_topics"));if(!element_DOM("div_liste_topics")){var ma_liste=document.createElement("div");ma_liste.style.overflowX="hidden";ma_liste.style.overflowY="auto";ma_liste.id="div_liste_topics";ma_liste.style.height="90%";element_DOM("fenetre").appendChild(ma_liste)}else{var ma_liste=element_DOM("div_liste_topics")}liste_des_topics.forEach(function(valeur){var titre=valeur["Titre"];element_contenu=document.createElement("div");element_contenu.innerHTML=valeur["Votre_message"];var contenu=element_contenu.innerText;var date=afficher_date(valeur["Horodateur"]);var auteur=valeur["Identifiant"]+" ("+valeur["Role"]+")";var id_topic=valeur["Id_topic"];var nb_coms=valeur["Nombre_de_coms"];if(nb_coms===undefined)nb_coms=0;var icone_poubelle='<span id="bye'+id_topic+'"><img alt="supprimer" class="byebye" onclick="event.stopPropagation(); clic_de_poubelle_topic(this)" src="'+prefixe_image+'/img_trash.png" style="width: 20px;position: relative;float: right;" id="bye'+id_topic+'"></span>';if(!recuperer("mon_type").includes("Administration")&&valeur["Identifiant"]!==recuperer("identifiant_courant").trim())icone_poubelle="";var dans_fenetre_str='<ul class="bloc_topic" onclick="clic_de_topic(this)" id="'+id_topic+'"> '+icone_poubelle+' <p id="'+id_topic+'" style="font-size: 25px; margin:0px;"> <b class="contenu_question" id="'+id_topic+'"> '+titre+'  </b> <p id="'+id_topic+'" class="contenu_question"> '+contenu+'</p><i class="petite_ecriture"> <h id="'+id_topic+'"><u id="'+id_topic+'"> Nombre de r√©ponses</u>: <u class="nb_com_actuel" id="'+id_topic+'">'+nb_coms+'</u> </h> <h id="'+id_topic+'">  &emsp; <u id="'+id_topic+'"> Publi√© le</u>: '+date+' </h><h id="'+id_topic+'">  &emsp; <u id="'+id_topic+'"> Publi√© par</u>: '+auteur+" </h></i></ul>";var un_topic=document.createElement("div");un_topic.innerHTML+=dans_fenetre_str;while(un_topic.firstChild)ma_liste.appendChild(un_topic.firstChild)})}}function clic_de_topic(ceci){charger_question(ceci.id,false)}function clic_de_poubelle_topic(ceci){id=ceci.id.split("bye")[1];accepter_suppression=window.confirm("√ätes vous s√ªr de vouloir supprimer ce fil de discussion?");if(accepter_suppression){chargement(true);supprimer("Coms","Id_topic",id);supprimer("Topic","Id_topic",id);supprimer("Notifs","id_notif",id);setTimeout(function(){actualiser_topics()},1500);chargement(false)}}function decodage(text){return text.replace(/(?:\r\n|\r|\n)/g,"<br>")}function impossible_de_cliquer(){return element_DOM("img_chargement").style.visibility==="visible"}function supprimer_topic(id_topic){if(impossible_de_cliquer())return-1;chargement(true);var lien_script="https://script.google.com/macros/s/AKfycbycJOH1smLn37Bk91cp3bmBHbZJmHknSrvTkeBMEqMFMbuRv9k/exec";var html='<form method="post"  action="'+lien_script+'" id="supprimer_un_topic" style="display: none;" >';html+='<input type="hidden" name="mode" value="supprimer" >';html+='<input type="hidden" name="id_topic" value="'+id_topic+'" >';html+="</form>";$("body").append(html);var form=$("#supprimer_un_topic");$.ajax({type:"POST",url:lien_script,data:form.serialize(),success:function(data){actualiser_topics()}});$("#supprimer_un_topic").remove()}function supprimer_fichier(id_fichier){var confirmation_suppression=confirm("‚ö†Ô∏è√ätes-vous s√ªr de vouloir supprimer ce fichier ? Cette action est irr√©versible.");if(!confirmation_suppression)return-1;chargement(true);var lien_script="https://script.google.com/macros/s/AKfycbw_04bdiepfQ0P9Ddtn6nyRPjxzxumORN4J8xm7bnmu7yO3HvQ/exec";if($("#"+id_fichier)[0].parentNode.id==="drive_manuels"){lien_script="https://script.google.com/macros/s/AKfycbzZr7c0Ej4QdA0CxHjXdR35eW6USvpkyBUdBQ8lVygc65vOolA/exec"}var html='<form method="post"  action="'+lien_script+'" id="supprimer_un_fichier" style="display: none;" >';html+='<input type="hidden" name="id_fichier" value="'+id_fichier+'" >';html+='<input type="hidden" name="API_KEY_DELETE" value="'+recuperer("API_KEY_DELETE")+'" >';html+="</form>";$("body").append(html);var form=$("#supprimer_un_fichier");$.ajax({type:"POST",url:lien_script,data:form.serialize(),success:function(data){console.log(data);var msg_alerte=element_DOM("snackbar");msg_alerte.innerText=data;msg_alerte.className="show";supprimer_rendus_du_fichier(id_fichier);supprimer("Notifs","id_notif",id_fichier+suite_notif());supprimer("Fichiers","id_fichier",id_fichier);setTimeout(function(){msg_alerte.className="";window.location.href=window.location.href},4e3);chargement(false)},error:function(data){console.log(data);alert("Impossible de supprimer le fichier. V√©rifiez que vous √™tes toujours connect√© √† internet.")}})}function supprimer_rendus_du_fichier(id_fichier){rechercher("Rendus","id_fichier_sujetdevoir",id_fichier,"").then(les_devoirs=>{if(les_devoirs.length>0){for(var i=les_devoirs.length-1;i>=0;i--){id_fichier_donn√©=les_devoirs[i]["id_fichier"];id_devoir_rendu=les_devoirs[i]["id_devoir"];console.log(les_devoirs[i]);supprimer_devoir("",id_fichier_donn√©,id_devoir_rendu)}}})["catch"](e=>{console.error(e)})}function ajouter_iframe_edt(){var mon_edt_html='<iframe id="calendrier" src="" frameborder="0" scrolling="no"> </iframe>';var mon_edt=document.createElement("div");mon_edt.innerHTML=mon_edt_html;element_DOM("fenetre").appendChild(mon_edt.firstChild)}function recuperer_edt(nom_classe_fournie){chargement(true);vider_fenetre("Emploi du temps");ajouter_iframe_edt();afficher_fenetre(true);var nom_classe="Tous";if(recuperer("mon_type")==="Administration_bis"||recuperer("dossier_charg√©"))nom_classe=la_matiere_chargee("Classe");if(recuperer("mon_type")==="Eleves")nom_classe=JSON.parse(recuperer("mes_donnees"))["Classe"];if(nom_classe_fournie)nom_classe=nom_classe_fournie;var calendrier=element_DOM("calendrier");calendrier.src="";nom_table="Classes";nom_champ_reference="Classe";valeur_champ_reference=nom_classe;nom_champ_a_chercher="id_googlecalendar";console.log({nom_table:nom_table,nom_champ_reference:nom_champ_reference,valeur_champ_reference:valeur_champ_reference,nom_champ_a_chercher:nom_champ_a_chercher});rechercher(nom_table,nom_champ_reference,valeur_champ_reference,nom_champ_a_chercher).then(id_googlecalendar=>{id_googlecalendar=id_googlecalendar[0]["id_googlecalendar"];var la_source="https://calendar.google.com/calendar/embed?wkst=2&bgcolor=%23ffffff&ctz="+my_ctz()+"&src="+id_googlecalendar+"&color=%234285F4&showPrint=0&showTabs=0&showCalendars=0&showTitle=1&mode=WEEK&showTz=0";calendrier.src=la_source;chargement(false)})["catch"](error=>{console.error(error);alert("Calendrier introuvable, veuillez r√©essayer.");chargement(false)})}function supprimer_cookies_google(){var cookies=document.cookie.split(";");for(var i=0;i<cookies.length;i++){console.log("cookie: "+cookies[i]);var equals=cookies[i].indexOf("=");var name=equals>-1?cookies[i].substr(0,equals):cookies[i];document.cookie=name+"=;expires=Thu, 01 Jan 1970 00:00:00 GMT"}}var intervalle_en_ms=6e4;var en_boucle=false;function pannel_notifs_deja_visible(){return $("#pannel_notif").is(":visible")}function virer_le_pannel_notifs(){if(element_DOM("pannel_notif"))element_DOM("pannel_notif").style.display="none"}function switch_pannel_notifs(){if(impossible_de_cliquer())return-1;chargement(true);var afficher_les_notifs=!pannel_notifs_deja_visible();element_DOM("pannel_notif").style.display=afficher_les_notifs?"block":"none";if(afficher_les_notifs){mes_notifs=JSON.parse(recuperer("mes_notifs"));if(!mes_notifs||mes_notifs.length===0)element_DOM("pannel_notif").innerHTML='<i class="notifs_vide"> Vous n\'avez pas encore de notifications.</i>';else vider_les_notifs();mes_notifs.forEach(function(valeur,index){ajouter_la_notif(valeur,index)})}positionner_bulle_notif();positionner_pannel_notif();$("#filtre_tous").click();$(".une_notif").on("contextmenu",function(e){});chargement(false)}function ajouter_la_notif(la_notif,index,mode_notif){var Type_notif=la_notif["Type_notif"];var Id_source=la_notif["Id_source"];var id_notif=la_notif["id_notif"];var Identifiant_derniere_modif=la_notif["Identifiant_derniere_modif"].toUpperCase();var Identifiant_originaire=la_notif["Identifiant_originaire"].toUpperCase();var Role_derniere_modif=la_notif["Role_derniere_modif"];var Horodateur=afficher_date(la_notif["Horodateur"]);var Date_derniere_modif=afficher_date(la_notif["Date_derniere_modif"]);var ouvrir_topic=Type_notif==="discussion"&&Horodateur!==Date_derniere_modif;var la_matiere_concernee=la_notif["Classe_matiere"].substring(la_notif["Classe_matiere"].lastIndexOf("|")+1,la_notif["Classe_matiere"].lastIndexOf(")"));var la_classe_concernee=recuperer("mon_type")!=="Eleves"?la_notif["Classe_matiere"].substring(la_notif["Classe_matiere"].lastIndexOf("(")+1,la_notif["Classe_matiere"].lastIndexOf("|")):"";var intitule_notif=la_notif["Intitul√©"].slice(0,20).trim();if(intitule_notif.length<la_notif["Intitul√©"].length)intitule_notif+="...";var id_dossier=la_notif["Id_classe_matiere"];var ma_notif=document.createElement("div");ma_notif.className="une_notif";ma_notif.id=Type_notif==="visio"?id_notif:Id_source;ma_notif.setAttribute("id_notif",id_notif.toString());ma_notif.onclick=function(e){chargement(true);clic_de_notif(Type_notif,ma_notif.id,id_dossier,ma_notif.getAttribute("id_notif"),ouvrir_topic)};la_date_derniere_modif=convertir_en_date(la_notif["Date_derniere_modif"]);ma_date_consultation=convertir_en_date(recuperer("ma_date_consultation"));ma_notif.className=liste_notifs_lues.includes(","+id_notif+",")&&la_date_derniere_modif<=ma_date_consultation?"une_notif":"non_lu";var identifiant_notif='<b style="color: #FF6C00;">'+Identifiant_derniere_modif+" ("+Role_derniere_modif+") </b>";var contenu_notif=contenu_notification(Type_notif,la_matiere_concernee,la_classe_concernee,Identifiant_originaire,Identifiant_derniere_modif,{Horodateur:Horodateur,Date_derniere_modif:Date_derniere_modif},intitule_notif);var intitule=' - <i><b style="color:#c65e46">'+intitule_notif+"</b></i>";var icone_notif="<span> <img src="+choix_image(Type_notif)+' class="icone_notif"> </span>';var date_grise="<div> "+icone_notif+' <i style="color: #bfbfbf;"> '+Date_derniere_modif+"  </i></div>";ma_notif.innerHTML=identifiant_notif+contenu_notif+intitule+date_grise;element_DOM("pannel_notif").appendChild(ma_notif);if(mode_notif)return ma_notif.innerText}function clic_de_notif(type_notif,id_source,id_dossier,id_notif,ouvrir_topic){envoyer_ma_date_de_consultation();if(id_notif)jai_lu(id_notif,true);$("#mini_popup").remove();setTimeout(function(){chargement(true);virer_le_pannel_notifs();afficher_fenetre_rendudevoir(false);quitter_previsualisation();if(type_notif==="fichier"){notif_fichier(id_source,id_dossier)}else if(type_notif==="discussion"){notif_discussion(id_source,id_dossier,ouvrir_topic)}else if(type_notif==="devoir"){notif_devoir(id_source,id_dossier)}else if(type_notif==="visio"){notif_visio(id_dossier)}var id_mode=id_mode_affichage();filtrer_avec_le_bon_filtre(id_mode);chargement(false)},500)}async function notif_visio(id_dossier){stocker_temp("dossier_charg√©",id_dossier);init=await initialisation();rejoindre_visio()}function notif_fichier(id_source,id_dossier){stocker_temp("dossier_charg√©",id_dossier);stocker("fichier_ouvert",id_source);window.location.href=window.location.href}function notif_discussion(id_source,id_dossier,ouvrir_topic){stocker_temp("dossier_charg√©",id_dossier);stocker("fichier_ouvert","");initialisation().then(function(){charger_les_topics(true).then(async function(){if($("#"+id_source+".bloc_topic").length>0){if(!ouvrir_topic){var position_scroll=$("#"+id_source+".bloc_topic")[0].offsetTop-$("#"+id_source+".bloc_topic")[0].offsetHeight;$("#div_liste_topics").scrollTop(position_scroll);await changer_couleur_temporairement(id_source,"bloc_topic","#ce7470",700)}else{await charger_question(id_source,false,true)}}else{alert("Discussion introuvable: le proprietaire l'a supprim√©.")}})})}function notif_devoir(id_source,id_dossier){stocker_temp("dossier_charg√©",id_dossier);stocker("fichier_ouvert","");initialisation().then(function(){recuperer_devoirs(true);$("#devoir_choisi").val(id_source);$("#devoir_choisi").change()})}function changer_couleur_temporairement(id_element,class_element,couleur_clignotement,duree_une_couleur){$("#"+id_element+"."+class_element).css("background-color",couleur_clignotement);setTimeout(function(){$("#"+id_element+"."+class_element).css("background-color","")},duree_une_couleur)}function choix_image(type_notif){return type_notif==="fichier"?prefixe_image+"/img_ajout.png":type_notif==="discussion"||type_notif==="commentaire"?prefixe_image+"/question.png":type_notif==="visio"||type_notif==="commentaire"?prefixe_image+"/img_visio.png":type_notif==="devoir"?prefixe_image+"/img_devoirs.png":""}function contenu_notification(type_notif,la_matiere_concernee,la_classe_concernee,Identifiant_originaire,Identifiant_derniere_modif,objet_dates,intitule_notif){var phrase_discussion=objet_dates["Horodateur"]===objet_dates["Date_derniere_modif"]?" a cr√©√© une discussion dans ":" a r√©cemment comment√© dans ";var phrase_devoir=Identifiant_originaire===Identifiant_derniere_modif?" a rendu un devoir dans ":" a laiss√© une remarque sur un devoir dans ";var phrase=type_notif==="fichier"?" a publi√© un nouveau fichier dans ":type_notif==="discussion"?phrase_discussion:type_notif==="devoir"?phrase_devoir:type_notif==="visio"?(Identifiant_derniere_modif.includes(",")?" ont ":" a ")+(intitule_notif==="debut"?"rejoint":"quitt√©")+" une visioconf√©rence dans ":" a r√©cemment int√©ragi dans ";if(la_classe_concernee)la_classe_concernee=" ("+la_classe_concernee+")";return phrase+" <b>"+la_matiere_concernee+la_classe_concernee+"</b>"}function vider_les_notifs(){var tout_marquer_html='<div style="display: flex;"><span class="tout_marquer" id="rien_lire" onclick="executer_ne_rien_lire()">Tout marquer comme NON LU‚ùå</span><span class="tout_marquer" id="tout_lire" onclick="executer_tout_lire()">Tout marquer comme LU‚úÖ</span></div>';element_DOM("pannel_notif").innerHTML=tout_marquer_html+'<div class="filtres_notifs un_filtre_notif" height="50px" style=""><div class="un_filtre_notif"  id="filtre_tous">Tous</div><div class="un_filtre_notif"><img alt="Discussions" src="'+prefixe_image+'/question.png" class="icone_filtre_notif"></div><div class="un_filtre_notif" style=""><img alt="Visio" class="icone_filtre_notif" style="" src="'+prefixe_image+'/img_visio.png"></div><div class="un_filtre_notif"><img alt="Devoirs" src="'+prefixe_image+'/img_devoirs.png" class="icone_filtre_notif"></div><div class="un_filtre_notif"><img alt="Fichiers" src="'+prefixe_image+'/img_ajout.png" class="icone_filtre_notif"></div></div>';$(".un_filtre_notif").on("mouseover",function(e){e.target.style.backgroundColor="#ccc"});$(".un_filtre_notif").on("mouseout",function(e){e.target.style.backgroundColor=""});$(".un_filtre_notif").on("click",function(e){e.stopPropagation();activer_filtre(e.target)})}function executer_tout_lire(){$(".non_lu:visible").each(function(index,une_notif){jai_lu(une_notif.getAttribute("id_notif"),false,une_notif)});apres_maj_lecture_notifs()}function executer_ne_rien_lire(){$(".une_notif:visible").each(function(index,une_notif){jai_pas_lu(une_notif.getAttribute("id_notif"),false,une_notif)});apres_maj_lecture_notifs()}function apres_maj_lecture_notifs(){envoyer_ce_que_jai_lu();envoyer_ma_date_de_consultation();recuperer_liste_notifs_lues();afficher_bulle_notifs()}function jai_pas_lu(id_notif,envoyer_cette_non_lecture,une_notif){liste_notifs_lues=liste_notifs_lues.includes(","+id_notif+",")?liste_notifs_lues.replaceAll(id_notif+",",""):liste_notifs_lues;if(une_notif)une_notif.className="non_lu";if(envoyer_cette_non_lecture)envoyer_ce_que_jai_lu()}function jai_lu(id_notif,envoyer_cette_lecture,une_notif){liste_notifs_lues=!liste_notifs_lues.includes(","+id_notif+",")?liste_notifs_lues+id_notif+",":liste_notifs_lues;if(une_notif)une_notif.className="une_notif";if(envoyer_cette_lecture){envoyer_ce_que_jai_lu();envoyer_ma_date_de_consultation()}}function envoyer_ce_que_jai_lu(){nom_table=recuperer("mon_type").split("_")[0];nouvelle_liste={liste_notifs_lues:liste_notifs_lues};url=racine_data+nom_table+"?Identifiant=eq."+recuperer("identifiant_courant")+"&"+apikey;return patch_resultat_asynchrone(url,nouvelle_liste).then(function(e){return liste_notifs_lues})}function activer_filtre(element_filtre){$(".un_filtre_notif").filter(function(valeur){$(this)[0].style.borderStyle=""});if(element_filtre.tagName==="IMG")element_filtre=element_filtre.parentNode;element_filtre.style.borderStyle="double";var nom_filtre=element_filtre.innerHTML;var condition_filtre=nom_filtre.includes("question.png")?"question.png":nom_filtre.includes("img_devoirs")?"img_devoirs":nom_filtre.includes("img_ajout")?"img_ajout":nom_filtre.includes("img_visio")?"img_visio":"div";var nouvelle_liste_notifs=$(".non_lu, .une_notif").filter(function(valeur){$(this)[0].style.display=$(this)[0].innerHTML.includes(condition_filtre)?"":"none";return $(this)[0].innerHTML.includes(condition_filtre)})}function recuperer_notifs(sans_msgs){chargement(true);if(!recuperer("mes_donnees"))return-1;if(!sans_msgs)recuperer_msgs(true,true);var ma_classe=JSON.parse(recuperer("mes_donnees"))["Classe"];var identifiant=recuperer("identifiant_courant");var mon_type=recuperer("mon_type").split("_")[0];if(mon_type.includes("Administration"))mon_type="Administration";var mes_notifs=[];var url=racine_data+mon_type+"?Identifiant=eq."+identifiant+"&"+apikey;try{var ma_date_consultation=get_resultat(url)[0]["Derniere_consultation_notifs"]}catch(e){var ma_date_consultation="30/12/1899 00:00:00"}stocker_ma_date_de_consultation(ma_date_consultation);nom_table="Notifs";nom_champ_reference=mon_type.includes("Admin")?"Cycle":"Classe";valeur_champ_reference=JSON.parse(recuperer("mes_donnees"))[nom_champ_reference];if(mon_type.includes("Profs")){return rechercher_notifs_prof(150).then(les_notifs=>{mes_notifs=les_notifs.filter(function(valeur,index){return valeur["Identifiant_derniere_modif"]!==recuperer("identifiant_courant")});stocker_mes_notifications(mes_notifs);afficher_bulle_notifs()})}else{return rechercher(nom_table,nom_champ_reference,valeur_champ_reference,"",150).then(async function(les_notifs){mes_notifs=les_notifs.filter(function(valeur,index){return valeur["Identifiant_derniere_modif"]!==recuperer("identifiant_courant")});if(mon_role==="Eleve"){mes_notifs=mes_notifs.filter(function(valeur,index){return!(valeur["Identifiant_originaire"]!==recuperer("identifiant_courant")&&valeur["Type_notif"]==="devoir")});mes_notifs=await rajouter_les_notifs_communes(mon_role,mes_notifs)}stocker_mes_notifications(mes_notifs);afficher_bulle_notifs()})}}async function rajouter_les_notifs_communes(mon_role,mes_notifs){if(mon_role==="Eleve"){var notifs_supplementaires=await rechercher("Notifs","Classe",JSON.parse(recuperer("mes_donnees"))["Cycle"],"",50);mes_notifs=[...mes_notifs,...notifs_supplementaires];mes_notifs=mes_notifs.sort(tri_ordre_chrono_decroissant_Date_derniere_modif)}else{var notifs_supplementaires=[]}return mes_notifs}function stocker_mes_notifications(mes_notifs){mes_notifs.sort(function tri_ordre_chrono_decroissant(a,b){modifA=convertir_en_date(a.Date_derniere_modif);modifB=convertir_en_date(b.Date_derniere_modif);return modifB-modifA});stocker("mes_notifs",JSON.stringify(mes_notifs))}function stocker_ma_date_de_consultation(ma_date_consultation){stocker("ma_date_consultation",ma_date_consultation);mes_donnees=JSON.parse(recuperer("mes_donnees"));mes_donnees["Derniere_consultation_notifs"]=ma_date_consultation;stocker("mes_donnees",JSON.stringify(mes_donnees))}function recuperer_ma_date_de_consultation(){chargement(true);var lien_script="https://script.google.com/macros/s/AKfycbxgtxDhZ9g8-lo5e4aux1otiYyWsgg38TXmZunQ1VnPZ7JpjzA/exec";var identifiant=recuperer("identifiant_courant");var mon_type=recuperer("mon_type").split("_")[0];var url=lien_script+"?method=POST&identifiant="+identifiant+"&mon_type="+mon_type+"&ma_consultation=true";return $.ajax({url:url})}function envoyer_ma_date_de_consultation(){chargement(true);mon_type=recuperer("mon_type").includes("Admin")?"Administration":recuperer("mon_type");maintenant_valeur=maintenant();stocker_ma_date_de_consultation(maintenant_valeur);nouveau_data={Derniere_consultation_notifs:maintenant_valeur};actualiser(mon_type,"Identifiant",recuperer("identifiant_courant"),nouveau_data);masquer_bulle_notifs();chargement(false)}function masquer_bulle_notifs(){element_DOM("bulle_notif").style.display=""}function recuperer_liste_notifs_lues(){return get_resultat(racine_data+recuperer("mon_type").split("_")[0]+"?"+"Identifiant=eq."+recuperer("identifiant_courant")+"&"+apikey)[0]["liste_notifs_lues"]}function afficher_bulle_notifs(){chargement(true);positionner_bulle_notif();positionner_pannel_notif();var mes_notifs=JSON.parse(recuperer("mes_notifs"));var ma_date_consultation=recuperer("ma_date_consultation");liste_notifs_lues=recuperer_liste_notifs_lues();if(!liste_notifs_lues)liste_notifs_lues=",";nouvelles_notifs=mes_notifs.filter(function(valeur){Date_derniere_modif=convertir_en_date(valeur["Date_derniere_modif"]);Date_consultation=convertir_en_date(ma_date_consultation);return!liste_notifs_lues.includes(","+valeur["id_notif"]+",")||Date_derniere_modif>Date_consultation});var nombre=nouvelles_notifs.length;if(nombre>99)nombre="+99";element_DOM("bulle_notif").style.display=nombre>0?"block":"";element_DOM("bulle_notif").innerText=nombre;var mes_msgs=JSON.parse(recuperer("mes_msgs"));if(mes_msgs){var nouveaux_msgs=mes_msgs.filter(e=>!liste_notifs_lues.includes(","+e["id_msg"]+","));nombre_msgs=nouveaux_msgs.length;if(nombre_msgs>99)nombre_msgs="+99";element_DOM("bulle_notif_msg").style.display=nombre_msgs>0?"block":"";element_DOM("bulle_notif_msg").innerText=nombre_msgs}else{nombre_msgs=0}chargement(false);return[nombre,nombre_msgs]}function choisir_height_viz_si_pdf(){if($("#previsualisation")[0]){var nom_fichier=$("#titre_fenetre")[0].innerText.toLowerCase();var extension=nom_fichier.split(".").pop();if(extension==="pdf"){if(!navigator.userAgent.includes("Chrome")){var rapport_L_H=$(window).width()/$(window).height();var height_final=rapport_L_H>0&&rapport_L_H<.4?"":rapport_L_H<=.475?"140%":rapport_L_H<=.75?"125%":rapport_L_H<=1.77?Number(-.5*rapport_L_H*100+1.7667)+"%":"";$("#previsualisation")[0].style.height=height_final}}}}function positionner_bulle_notif(){if(element_DOM("bulle_notif"))$("#bulle_notif")[0].style.left=22+$("#recup_notifs")[0].offsetLeft+"px";if(element_DOM("bulle_notif_msg"))$("#bulle_notif_msg")[0].style.left=22+$("#recup_msgs")[0].offsetLeft+"px"}function positionner_pannel_notif(){if($("#pannel_notif")[0]&&$("#recup_notifs")[0]){$("#pannel_notif")[0].style.left=22+$("#recup_notifs")[0].offsetLeft-$("#pannel_notif")[0].offsetWidth+"px";$("#pannel_notif")[0].style.top=$("#recup_notifs")[0].offsetTop}}function mettre_en_place_les_notifications(){recuperer_notifs();positionner_bulle_notif();positionner_pannel_notif();$(window).on("resize",function(){positionner_bulle_notif();positionner_pannel_notif()})}function rejoindre_visio(id_matiere_visio,sans_alerte,valeur_id_div_visio,pas_de_initialisation){var mon_type=recuperer("mon_type").split("_")[0];if(impossible_de_cliquer()&&!sans_alerte)return-1;if(!sans_alerte){var confirmation=confirm("Branchez des √©couteurs pour mieux entendre pendant la visioconf√©rence.");if(!confirmation)return-1}chargement(true);var mes_donnees=JSON.parse(recuperer("mes_donnees"));var identifiant=recuperer("identifiant_courant").toUpperCase();var id_matiere=id_matiere_visio?id_matiere_visio:recuperer("dossier_charg√©");var mes_matieres=JSON.parse(recuperer("mes_matieres"));var la_matiere=mes_matieres.filter(function(element){return element["ID_URL"]===id_matiere});var la_classe=la_matiere[0].Classe+" "+la_matiere[0].Matiere;la_classe=la_classe.normalize("NFD").replace(/&/g," et ");if(!pas_de_initialisation){id_div_visio=initialiser_visio(valeur_id_div_visio)}else{id_div_visio=valeur_id_div_visio}creer_une_visio("100%","100%",identifiant,la_classe,id_div_visio,id_matiere_visio,sans_alerte)}function initialiser_visio(valeur_id_div_visio){vider_fenetre("Visioconf√©rence",true);afficher_fenetre(true);var id_div_visio=valeur_id_div_visio?valeur_id_div_visio:"visio";var visio_html='<div id="'+id_div_visio+'" style="display:none;" class="previz"></div>';var visio=document.createElement("div");visio.innerHTML=visio_html;element_DOM("fenetre").appendChild(visio.firstChild);return id_div_visio}function creer_une_visio(largeur,hauteur,moi,classe,id_div_visio,id_matiere_visio,sans_alerte){chargement(true);id_matiere_visio=id_matiere_visio?id_matiere_visio:recuperer("dossier_charg√©");var enlever_kickout=!recuperer("mon_type").includes("Admin");const domain="meet.jit.si";const options={configOverwrite:{defaultLanguage:"fr",disableDeepLinking:true,SHOW_JITSI_WATERMARK:false,SHOW_WATERMARK_FOR_GUESTS:false,remoteVideoMenu:{disableKick:enlever_kickout}},roomName:id_matiere_visio,width:"100%",height:"100%",parentNode:document.querySelector("#"+id_div_visio+""),userInfo:{email:"",displayName:moi},onload:visio_prete(id_div_visio),interfaceConfigOverwrite:{DEFAULT_REMOTE_DISPLAY_NAME:moi,DEFAULT_LOCAL_DISPLAY_NAME:"Moi",SHOW_JITSI_WATERMARK:false,SHOW_WATERMARK_FOR_GUESTS:false,TOOLBAR_BUTTONS:["microphone","camera","desktop","fullscreen","fodeviceselection","chat","sharedvideo","videoquality"],defaultLanguage:"fr",MOBILE_APP_PROMO:false,SHOW_CHROME_EXTENSION_BANNER:false}};const api=new JitsiMeetExternalAPI(domain,options);api.executeCommand("subject",nom_etablissement.toUpperCase()+" - "+classe);envoyer_mon_log_visio(moi.toLowerCase(),classe.toLowerCase(),"debut",mon_role,id_matiere_visio);var id_notif_visio=id_matiere_visio+"-visio";$("#bye_prev").on("click",function(e){e.preventDefault();var est_premier_visio=id_div_visio==="visio-0"||id_div_visio==="visio";if(est_premier_visio){var confirmation=confirm("√ätes-vous s√ªr de vouloir quitter la visioconf√©rence?");stocker("quitter_multi_visio",confirmation)}if(confirmation||!est_premier_visio&&recuperer("quitter_multi_visio")==="true"){envoyer_mon_log_visio(moi.toLowerCase(),classe,"fin",mon_role,id_matiere_visio);var visio_existante=la_visio_existante(id_notif_visio);if(visio_existante.length>0){visio_existante=visio_existante[0];var je_suis_dernier_participant=api.getNumberOfParticipants()<=1;if(je_suis_dernier_participant){nouvelle_notif={id_notif:id_notif_visio,"Intitul√©":"fin",Identifiant_derniere_modif:recuperer("identifiant_courant"),Role_derniere_modif:mon_role};actualiser("Notifs","id_notif",id_notif_visio,nouvelle_notif)}else{if(visio_existante["Identifiant_derniere_modif"].includes(recuperer("identifiant_courant"))){participants_tableau=visio_existante["Identifiant_derniere_modif"].split(",");var participants=supprimer_element_de_la_liste(participants_tableau,recuperer("identifiant_courant")).join(",");nouvelle_notif={id_notif:id_notif_visio,"Intitul√©":"debut",Identifiant_derniere_modif:participants,Role_derniere_modif:mon_role};actualiser("Notifs","id_notif",id_notif_visio,nouvelle_notif)}}}api.dispose();quitter_previsualisation()}});setTimeout(function(){var date_heure_actuelle=maintenant();var date_actuelle=date_heure_actuelle.split(" ")[0];var mon_cycle=JSON.parse(recuperer("mes_donnees"))["Cycle"];var les_matieres=JSON.parse(recuperer("mes_matieres"));var la_classe_matiere=les_matieres.filter(e=>e["ID_URL"]===id_matiere_visio)[0]["Classe_Matiere"];var nouvelle_notif={id_notif:id_notif_visio,Horodateur:date_heure_actuelle,Type_notif:"visio",Id_source:id_matiere_visio,"Intitul√©":"debut",Identifiant_originaire:recuperer("identifiant_courant"),Role_originaire:mon_role,Identifiant_derniere_modif:recuperer("identifiant_courant"),Role_derniere_modif:mon_role,Classe:la_classe_matiere.split("|")[0].replace("(",""),Classe_matiere:la_classe_matiere,Id_classe_matiere:id_matiere_visio,Date_derniere_modif:date_heure_actuelle,Cycle:mon_cycle};var visio_existante=la_visio_existante(id_notif_visio);var visio_deja_existante=visio_existante.length>0;if(visio_deja_existante){visio_existante=visio_existante[0];delete nouvelle_notif["Horodateur"];delete nouvelle_notif["Type_notif"];delete nouvelle_notif["Id_source"];delete nouvelle_notif["Identifiant_originaire"];delete nouvelle_notif["Role_originaire"];delete nouvelle_notif["Classe"];delete nouvelle_notif["Classe_matiere"];delete nouvelle_notif["Id_classe_matiere"];delete nouvelle_notif["Cycle"];nouvelle_notif["Identifiant_derniere_modif"]=visio_existante["Intitul√©"]==="fin"?recuperer("identifiant_courant"):visio_existante["Identifiant_derniere_modif"].includes(recuperer("identifiant_courant"))?visio_existante["Identifiant_derniere_modif"]:visio_existante["Identifiant_derniere_modif"]+","+recuperer("identifiant_courant");actualiser("Notifs","id_notif",id_notif_visio,nouvelle_notif)}else{ajouter_un_element("Notifs",nouvelle_notif)}$(".mon_logo_jitsi").remove();$('<a target="_blank" class="mon_logo_jitsi" href="https://sekooly.com"></a>').insertBefore("#visio > ")},5e3)}function la_visio_existante(id_notif_visio){var url=racine_data+"Notifs?Type_notif=eq.visio&id_notif=eq."+id_notif_visio+"&"+apikey;return get_resultat(url)}function visio_prete(id_div_visio){chargement(false);element_DOM(id_div_visio).style.display="block"}function envoyer_mon_log_visio(mon_identifiant,ma_classe,mon_statut,mon_role,id_classe_matiere){if(!id_classe_matiere)id_classe_matiere=recuperer("dossier_charg√©");try{var data=get_resultat("https://ipapi.co/json/");var mon_adresse_ip=data["ip"];var ma_ville=data["city"];var mon_pays=data["country_name"];var ma_latitude=data["latitude"];var ma_longitude=data["longitude"];var mon_operateur=data["org"]}catch{var mon_adresse_ip="";var ma_ville="";var mon_pays="";var ma_latitude="";var ma_longitude="";var mon_operateur=""}if(ma_classe.includes("|"))ma_classe="Professeur";if(mon_role)ma_classe=mon_role;nom_table="Visio";var les_matieres=JSON.parse(recuperer("mes_matieres"));var la_classe_matiere=les_matieres.filter(e=>e["ID_URL"]===id_classe_matiere)[0]["Classe_Matiere"];nouveau_visio={Horodateur:maintenant(),Identifiant:mon_identifiant,Type:mon_role,Statut:mon_statut,IP:mon_adresse_ip,Ville:ma_ville,Pays:mon_pays,Latitude:ma_latitude,Longitude:ma_longitude,Operateur:mon_operateur,Id_classe_matiere:id_classe_matiere,Classe_matiere:la_classe_matiere};ajouter_un_element(nom_table,nouveau_visio)}function ajouter_multi_visio_si_non_eleve(){if(!recuperer("mon_type").includes("Eleves")){if($("#multi_visio").length===0){$(".sidebar.left").append('<div id="multi_visio" onclick="multi_visio()">Multi-visio</div>');$("#multi_visio").insertBefore("#dashboard")}}else{if($("#multi_visio").length>0)$("#multi_visio").remove()}}function multi_visio(){les_matieres=JSON.parse(recuperer("mes_matieres"));les_matieres=les_matieres.sort(function(a,b){return a.Classe_Matiere>b.Classe_Matiere});elements_html="<select id='classe_multi_visio' style='width: 90%;' multiple>";for(i=0;i<les_matieres.length;i++){elements_html+='<option value="'+les_matieres[i]["ID_URL"]+'">'+les_matieres[i]["Classe"]+" "+les_matieres[i]["Matiere"]+"</option>"}elements_html+="</select>";creer_mini_popup("Vous vous appr√™tez √† faire une visioconf√©rence avec plusieurs classes en m√™me temps. Pour commencer, choisissez les classes-mati√®res dans lesquels vous voulez int√©ragir simultan√©ment:",elements_html,"Commencer la multi-visioconf√©rence","commencer_multi_visio()")}function commencer_multi_visio(){chargement(true);var liste_classe_multi_visio=$("#classe_multi_visio").val();vider_fenetre("Multi-visioconf√©rence",true);if(liste_classe_multi_visio.length===1){rejoindre_visio(liste_classe_multi_visio[0])}else{$("#fenetre").append('<div id="previsualisation" style="width: 100%;height: 85%;display:grid;grid-template-columns: repeat(2, 1fr);">');liste_classe_multi_visio.forEach(function(id_matiere_visio,numero){chargement(true);$("#previsualisation").append("<div id='visio-"+numero+"' class='une_visio'></div>");sans_alerte=numero<liste_classe_multi_visio.length-1;rejoindre_visio(id_matiere_visio,sans_alerte,"visio-"+numero,true)})}afficher_fenetre(true);$("#mini_popup").remove();chargement(false)}var compteur_suivant=0;function afficher_formulaire_sondage(par_clic){if(recuperer("fichier_ouvert")!=="")return-1;var ma_response_sondage=JSON.parse(recuperer("mes_donnees"))["Reponse_sondage"];var dates_affichage="2020-07-20;2020-07-21;2020-07-22;2020-07-23;2020-07-24;2020-07-25;2020-07-26;2020-07-27";var aujourdhui=moment().format("yyyy-MM-DD");var ma_classe="";if(recuperer("mes_donnees")){var mes_donnees=JSON.parse(recuperer("mes_donnees"));ma_classe=mes_donnees["Classe"];var mon_type=recuperer("mon_type").split("_")[0];if(mon_type.includes("Prof")){if(dates_affichage.includes(aujourdhui)){vider_fenetre("Les examens non rendus");switch_mode(true);afficher_fenetre(true);ajouter_formulaire()}}else{if(par_clic)alert("Aucun questionnaire n'est actuellement en attente de r√©ponse.")}}}function repondre_sondage(oui){chargement(true);var bye=true;if(bye)return-1;var lien_script="https://script.google.com/macros/s/AKfycbxPZ5wQLxdBqB8m2Mri7fZZ5xJtEeTR8MKI30CFTXeUDgE1cH0/exec";var mes_donnees=JSON.parse(recuperer("mes_donnees"));var mon_identifiant=mes_donnees["Identifiant"];var mon_type=recuperer("mon_type").split("_")[0];var identifiant="?identifiant="+mon_identifiant;var mon_type="&mon_type="+mon_type;var reponse_sondage="&reponse_sondage="+(oui?"oui":"non");var url=lien_script+identifiant+mon_type+reponse_sondage;fetch(url).then(function(data){mes_donnees["Reponse_sondage"]=oui?"oui":"non";stocker("mes_donnees",JSON.stringify(mes_donnees));chargement(false)})}function ajouter_formulaire(){var lien_questionnaire="https://docs.google.com/forms/d/e/1FAIpQLSf6RB1PthrIpc1uGHrhTFlW01YnqsppmZF0yXe1JUXGS-yLNw";var questionnaire_html='<iframe id="questionnaire_retours" style="width: 100%;height: 100%;" src="'+lien_questionnaire+'/viewform?embedded=true" frameborder="0"> </iframe>';var questionnaire=document.createElement("div");questionnaire.innerHTML=questionnaire_html;element_DOM("fenetre").appendChild(questionnaire.firstChild)}afficher_formulaire_sondage();function resultats_remed(){var mon_type=recuperer("mon_type").includes("Admin")?"Administration":recuperer("mon_type");var id_formulaire="1FAIpQLSc-oT2cW_UP9ve6nZnIFPvymmcVR-058klZPdLFDKFXlW7LvQ";var identifiant_courant=recuperer("identifiant_courant");if(mon_type==="Eleves"){alert("Les r√©sultats de rem√©diations ne sont pas encore accessibles.")}else{vider_fenetre("R√©sultats des rem√©diations");switch_mode(true);afficher_fenetre(true);ajouter_form(id_formulaire,identifiant_courant)}}function ajouter_form(id_formulaire,valeur_champ_par_defaut){var lien_questionnaire="https://docs.google.com/forms/d/e/"+id_formulaire;var questionnaire_html='<iframe id="questionnaire_retours" style="width: 100%;height: 100%;" src="'+lien_questionnaire+"/viewform?embedded=true&entry.305645047="+valeur_champ_par_defaut+'" frameborder="0"> </iframe>';var questionnaire=document.createElement("div");questionnaire.innerHTML=questionnaire_html;element_DOM("fenetre").appendChild(questionnaire.firstChild)}function afficher_parametres(oui){if(!oui){$("#recup_params").remove();$("#recup_analyses").remove();$("#recup_pref").remove()}else{element_DOM("recup_params").style.display="block";element_DOM("recup_analyses").style.display="block";element_DOM("recup_pref").style.display="block"}}function recuperer_analyses(){vider_fenetre("Analyses");var contenu_menu_haut="";for(var i=0;i<elements_menu_analyses.length;i++){contenu_menu_haut=contenu_menu_haut+'<span class="un_menu" id ="'+elements_menu_analyses[i]+'">'+elements_menu_analyses[i]+"</span>"}var conteneur_menu_html='<div id="conteneur_menu"><div id="menu_haut" class="menu_haut"> '+contenu_menu_haut+'</div><div id="menu_params" class="menu_params"><iframe id="previsualisation" class="previz_analysis" height="90%"></iframe></div></div>';$("#fenetre").append(conteneur_menu_html);$(".un_menu").click(function(e){chargement(true);un_menu_clic(e.target.id);chargement(false)});$("[id='Analyses des connexions']").click();afficher_fenetre(true)}function masquer_images_initialement(){return $("img:visible").hide()}function afficher_images_initiales(img){img.show()}function recuperer_preferences(){vider_fenetre("Pr√©f√©rences",false,"sauvegarder_pref()");var contenu_menu_haut="";for(var i=0;i<elements_menu_preferences.length;i++){contenu_menu_haut=contenu_menu_haut+'<span class="un_menu" id ="'+elements_menu_preferences[i]+'">'+elements_menu_preferences[i]+"</span>"}var conteneur_menu_html='<div id="conteneur_menu"><div id="menu_haut" class="menu_haut"> '+contenu_menu_haut+'</div><div id="menu_params" class="menu_params"><div id="previsualisation" class="previz-pref"></div></div></div>';$("#fenetre").append(conteneur_menu_html);$(".un_menu").click(function(e){chargement(true);un_menu_clic(e.target.id,true);chargement(false)});$("[id='Images']").click();afficher_fenetre(true)}function personnaliser(id_parametre){var conteneur=$("#previsualisation");var contenu_explications="";var callback="";element_DOM("previsualisation").innerHTML="";var mon_hebergeur=hebergeur_actuel();if(id_parametre==="Images"){contenu_explications=`
		<strong>
			<rouge>
				Vous devez avoir votre propre h√©bergeur d'images √† partir duquel SEKOOLY r√©cup√®re les images.<br>
			</rouge>
			Les images que vous h√©bergez <rouge>doivent</rouge> avoir <rouge>le m√™me nom</rouge> que celui cit√© ci-dessous.<br>
		</strong>

		<input id="prefixe_image" class="barre_recherche" name="rechercher" value="`+mon_hebergeur+`" placeholder="Lien de votre h√©bergeur d'images..."><br>
		<button class="rendre" onclick="reinitialiser_images()">R√©initialiser</button> 


		<p>
			Pour convertir vos images vers la bonne extension, vous pouvez utiliser <a target="_blank" href="https://image.online-convert.com/fr/convertir-en-png"><strong>ce site</strong></a>.<br>
			Retrouvez ci-dessous la liste des <span id="nb_images"></span>images personnalisables sur votre plateforme.
		</p>
			
		<p>
			<vert>‚úÖ = image trouv√©e</vert>
			<rouge>‚ùå = image non trouv√©e</rouge>
		</p>
		`;callback="personnaliser_images(conteneur)"}else if(id_parametre==="Couleurs"){contenu_explications="En cours de construction."}else if(id_parametre==="Formes"){contenu_explications="En cours de construction."}else{contenu_explications="En cours de construction."}explications_pref(conteneur,contenu_explications,callback)}function reinitialiser_images(conteneur){element_DOM("prefixe_image").value="";maj_liste_images_pref($("#previsualisation"),hebergeur_defaut())}async function mettre_la_coche(lien_img){var res_lien=await fetch(lien_img);var res=res_lien.status===200?"‚úÖ":"‚ùå";return res}function personnaliser_images(conteneur){$("#prefixe_image").on("keyup",function(e){maj_liste_images_pref(conteneur,e.target.value);afficher_alerte("Vous pouvez soit enregistrer vos pr√©f√©rences, soit cliquer sur R√©initialiser pour avoir les images par d√©faut.")});maj_liste_images_pref(conteneur,hebergeur_actuel(true))}async function maj_liste_images_pref(conteneur,futur_hebergeur){var liste_images="";var liste_images_initiale=[];var liste_name="img_links";var attributeName="href";$.each($("img"),(key,valeur)=>{if(valeur.src&&!liste_images.includes(valeur.src)){liste_images+=valeur.src+"\n"}else{}});liste_images+=liste_couleurs.map(e=>{if(!liste_images.includes(e)){return hebergeur_actuel(true)+"/img_dossier_"+e.replaceAll(" ","")+".png"}else{}}).join("\n");liste_images+=img_dynamiques.map(e=>{if(!liste_images.includes(e)){return"/"+e}else{}}).join("\n");liste_images=liste_images.replaceAll("\n\n","\n").replaceAll("\n","<br>").split("<br>");liste_images=liste_images.filter(function(item,pos){return item&&liste_images.indexOf(item)==pos});liste_images_initiale=liste_images;element_DOM("nb_images").innerText=liste_images.length+" ";liste_images=liste_images.map(e=>{if(e){var mon_hebergeur=futur_hebergeur?futur_hebergeur:hebergeur_defaut();var nom_image="/"+e.split("/").pop();if(nom_image){var une_image='<strong class="sekooly-mode une_image">'+nom_image+'</strong><span class="rmq" id="rmq_'+e.split("/").pop()+'"></span>';return'<a list="'+liste_name+'" href="'+mon_hebergeur+nom_image+'" target="_blank"><span class="content_prefixe_image">'+mon_hebergeur+"</span>"+une_image+"</a>"}}});liste_images=liste_images.join("<br><br>");ajouter_liste_pref(conteneur,liste_images,liste_name,attributeName);appliquer_images();liste_images_initiale.map(async e=>{if(e){var mon_hebergeur=futur_hebergeur?futur_hebergeur:hebergeur_defaut();var nom_fichier=e.split("/").pop();var nom_image="/"+nom_fichier;if(nom_image){la_coche=await mettre_la_coche(mon_hebergeur+nom_image);if(nom_image.includes("bmp")){}$("[id='rmq_"+nom_fichier+"']")[0].innerText=la_coche}}})}function recuperer_autorisations(){url=CryptoJS.AES.decrypt("U2FsdGVkX19VFoAHA6uGaVw+nJmUqMm1V/wAI54lcDrc9CEoJu2NzJntc1jMydf+904/pcwg0f6gbd5g75V1HEIkENqhb4hq5zVqjqLJ/5NFwdd8kzFN7Ls8C2Ig1yKAuEZisjgxM9BrHuAzQ3bZvaJVifOpAi7RJDrRWmJWyAV9bfbIEM4iS/JIE0l7wsVB+Yy0nfXj+PAK6z0tkSfnpYKws7CxDTQvz0+wBeOmee0=","Sekooly").toString(CryptoJS.enc.Utf8);autorisations=get_resultat_brut(url);return autorisations}function explications_pref(conteneur,contenu_explications,callback){$("#explications").remove();conteneur.append('<div class="description_matiere" id="explications">'+contenu_explications+"</div>");eval(callback)}function ajouter_liste_pref(conteneur,liste,liste_name,attributeName){$("#liste_pref").remove();conteneur.append('<div id="liste_pref"><div><button onclick="copier_liste(`[list=\''+liste_name+"']`,'"+attributeName+"')\">COPIER</button></div>"+liste+"</div>")}function appliquer_preferences(){if(data_etablissement["preferences"]){$.each($("img[src]"),(key,img)=>{the_src=decodeURIComponent(img.src);suffixe=the_src.split(hebergeur_defaut())[1];if(!suffixe)suffixe=the_src.split(hebergeur_actuel())[1];img.src=prefixe_image+suffixe});appliquer_images();appliquer_couleurs();appliquer_couleurs()}remplacer_image_par_defaut()}function remplacer_image_par_defaut(){const targetNode=$("body")[0];const config={attributes:true,childList:true,subtree:true};const callback=function(mutationsList,observer){for(const mutation of mutationsList){if(mutation.type==="childList"){}else if(mutation.type==="attributes"){}}};const observer=new MutationObserver(actualiser_image_non_trouvee);observer.observe(targetNode,config)}function actualiser_image_non_trouvee(new_node){$("img").off("error");$("img").on("error",function(e){remplacer_avec_defaut(e)})}function remplacer_avec_defaut(e){a_changer=e.target.src;if(!a_changer.includes("undefined")){var new_link=hebergeur_defaut()+"/"+a_changer.split("/").pop();e.target.src=new_link}}function appliquer_images(){$.each($(".une_image"),(key,img)=>{$.each($("img[src$='"+img.innerText+"']"),(k,img_locale)=>{$(img_locale).one("error",function(e){remplacer_avec_defaut(e)});img_locale.src=img.parentNode.href});if(!data_etablissement["preferences"]){data_etablissement["preferences"]={}}data_etablissement["preferences"]["prefixe_image"]=element_DOM("prefixe_image").value?element_DOM("prefixe_image").value:hebergeur_defaut()})}function appliquer_couleurs(){}function appliquer_couleurs(){}async function sauvegarder_pref(){await actualiser_info_etablissement();afficher_alerte("Vos pr√©f√©rences sont sauvegard√©es.")}function recuperer_parametres(){if(recuperer("liste_params_colonnes_masquees")===null)stocker("liste_params_colonnes_masquees","");vider_fenetre("Param√®tres");var contenu_menu_haut="";for(var i=0;i<elements_menu_haut.length;i++){contenu_menu_haut=contenu_menu_haut+'<span class="un_menu" id ="'+elements_menu_haut[i]+'">'+elements_menu_haut[i]+"</span>"}var nombre_elements='<span style="font-weight: bold;"><span id="nombre_elements_param">'+0+"</span> √©l√©ments</span>";var conteneur_menu_html='<div id="conteneur_menu"><div id="menu_haut" class="menu_haut"> '+contenu_menu_haut+'</div><div id="menu_params" class="menu_params"><div id="conteneur_filtre"><span id="label_filtre_parametre"></span><select id="filtre_parametre" class="filtre_parametre"></select></div><div id="menu_details"></div>'+nombre_elements+"</div></div>";$("#fenetre").append(conteneur_menu_html);$(".un_menu").click(function(e){chargement(true);un_menu_clic(e.target.id);chargement(false)});$("#Alerte").click();afficher_fenetre(true)}function appliquer_filtre_choisi(nom_champ_reference,valeur_champ_reference){var nom_champ_reference=nom_champ_reference?nom_champ_reference:$("#label_filtre_parametre")[0].innerText;var valeur_champ_reference=valeur_champ_reference?valeur_champ_reference:$("#filtre_parametre")[0].value;if(nom_champ_reference!==""&&valeur_champ_reference!==""){if($("#"+nom_champ_reference)[0]){var numero_colonne=$("#"+nom_champ_reference)[0].cellIndex}else if($("#"+nom_champ_reference.toLowerCase())[0]){var numero_colonne=$("#"+nom_champ_reference.toLowerCase())[0].cellIndex}else{var numero_colonne=-1}if(numero_colonne>=0){Array.from($("tbody")[0].children).forEach(function(valeur,index,array){valeur_a_comparer=valeur.children[numero_colonne].innerText;if(valeur_champ_reference==="(Tous)"||valeur_a_comparer===valeur_champ_reference){valeur.style.display=""}else{valeur.style.display="none"}})}}}function url_analysis_iframe(test){return test?"http://localhost:5000/connexions.html":"https://sekooly.com/assets/analysis/connexions"}async function une_analyse_clic(id_parametre){chargement(true);var url=url_analysis_iframe();element_DOM("previsualisation").src=url;var iframe_target=element_DOM("previsualisation").contentWindow;$("#previsualisation").on("load",function(){iframe_target.postMessage({racine_initiale:racine_initiale,nom_etablissement:nom_etablissement,api_initial:api_initial},element_DOM("previsualisation").src);update_viz_logs();chargement(false)})}async function update_viz_logs(){var lien_script=await chercher_lien_script(6);var api_analyses_connexions="94e27fab-46a2-4a3d-949c-0d7b1c65faf3";options={API_ANALYSES_CONNEXIONS:api_analyses_connexions,nom_etablissement:nom_etablissement,type_analyses:"Connexions"};var url=lien_script+json_to_url(options);post_resultat_asynchrone(url)}async function un_menu_clic(id_parametre,mode_pref){$("#mini_popup").remove();mettre_en_forme_onglet_clicked(id_parametre);if(id_parametre.includes("Analyses")){une_analyse_clic(id_parametre)}else if(mode_pref){personnaliser(id_parametre)}else{actualiser_filtre_onglet(id_parametre);await actualiser_details_parametre(id_parametre);await mettre_etat_espace(id_parametre);if($("#boutons_params")){if(elements_menu_haut_avec_modifs.indexOf(id_parametre)===-1){autoriser_les_modifs(false)}else{autoriser_les_modifs(true)}}if($("#boutons_params")){if(elements_menu_haut_avec_reset.indexOf(id_parametre)===-1){autoriser_le_reset(false)}else{autoriser_le_reset(true)}}if($("#boutons_params")){elements_menu_haut_avec_tout_voir=recuperer("liste_params_colonnes_masquees");elements_menu_haut_avec_tout_voir=elements_menu_haut_avec_tout_voir?elements_menu_haut_avec_tout_voir.split(","):[];if(elements_menu_haut_avec_tout_voir.some(e=>e.includes(id_parametre+":"))){autoriser_tout_voir(true)}else{autoriser_tout_voir(false)}}}}function affichage_par_defaut(id_parametre){liste_params_colonnes_masquees_str=recuperer("liste_params_colonnes_masquees");if(liste_params_colonnes_masquees_str){liste_params_colonnes_masquees=liste_params_colonnes_masquees_str.split(",");liste_params_colonnes_masquees=liste_params_colonnes_masquees.filter(e=>e!=="");liste_params_colonnes_masquees=liste_params_colonnes_masquees.filter(e=>e.split(":")[0].includes(id_parametre));liste_colonnes_masquees=liste_params_colonnes_masquees.map(e=>e.split(":")[1]);afficher_colonnes(id_parametre,"");liste_colonnes_masquees.forEach(function(e){masquer_colonne(e)})}}function masquer_params_auto(){parametres_automatiques.forEach(function(e){mon_element=$(".header_table.entete_sticky[id='"+e+"']");if(mon_element.length>0)masquer_colonne(e)})}function autoriser_les_modifs(oui){$("#ajout_param")[0].style.display=oui?"":"none";$("#suppr_param")[0].style.display=oui?"":"none";$("#dupliquer_param")[0].style.display=oui?"":"none"}function autoriser_le_reset(oui){$("#reset_param")[0].style.display=oui?"":"none"}function autoriser_tout_voir(oui){$("#tout_voir")[0].style.display=oui?"":"none"}function mettre_en_forme_onglet_clicked(id_onglet){for(var i=0;i<$(".menu_haut")[0].children.length;i++){id_onglet_courant=$(".menu_haut")[0].children[i].id;if(id_onglet_courant===id_onglet){$('[id="'+id_onglet_courant+'"]')[0].className="un_menu un_menu_orange"}else{$('[id="'+id_onglet_courant+'"]')[0].className="un_menu"}}}function bouton_editer(nom_fonction_clic){return'<img onclick="'+nom_fonction_clic+'" src="'+prefixe_image+'/img_edit.png" alt="MODIFIER" class="editer">'}function bouton_voir(nom_fonction_clic){return'<img alt="voir" class="envoi_remarque mini-image" onclick="'+nom_fonction_clic+'" src="'+prefixe_image+'/img_previz.png"> '}function modifier_info(ceci){id_info=ceci.parentNode.id;etiquette_info=element_DOM(id_info).previousSibling.previousSibling.innerText.replaceAll(":","");var ancienne_valeur=$("[id='"+id_info+"']")[0].innerText;var nouvelle_valeur=prompt("Indiquez la nouvelle valeur de '"+etiquette_info+"':",ancienne_valeur);if(nouvelle_valeur)nouvelle_valeur=nouvelle_valeur.trim();if(nouvelle_valeur&&nouvelle_valeur!==ancienne_valeur){chargement(true);nouveau_data={[id_info]:nouvelle_valeur};actualiser_info(nouveau_data)}else{afficher_alerte("Modification annul√©e.")}}function actualiser_info(nouveau_data){url=racine_initiale+"Etablissements"+"?"+"id"+"=eq."+data_etablissement["id"]+"&"+api_initial;patch_resultat_asynchrone(url,nouveau_data).then(function(){get_resultat_asynchrone(url).then(function(resultats){data_etablissement=resultats[0];un_menu_clic("Infos √©tablissement");chargement(false)})})}function voir_ou_generer_contrat(nom_fichier,valeur_info){if(valeur_info!=="null"&&valeur_info.length>0){visualiser_avec_demande_signature(nom_fichier,valeur_info)}else{generer_contrat()}}function visualiser_avec_demande_signature(nom_fichier,id_fichier){visualiser(nom_fichier,id_fichier);$("#titre_fenetre").append('<span onclick="signer_contrat()" class="sign">Signer contrat</span>')}function contrat_datas(keep_temp){var nb_eleves=compter("Eleves")[0]["result"];var nb_admin=compter("Administration")[0]["result"];var nb_profs=compter("Profs")[0]["result"];var nb_total=nb_eleves+nb_admin+nb_profs;var datas={nom_etablissement:nom_etablissement.toUpperCase(),adresse_etablissement:data_etablissement["adresse_etablissement"],identite_responsable:data_etablissement["identite_responsable"],role:mon_role,montant_par_user:data_etablissement["donnees_contrat"]["montant_par_user"],nb_total:nb_total,nb_eleves:nb_eleves,nb_admin:nb_admin,nb_profs:nb_profs,frequence_paiement:data_etablissement["donnees_contrat"]["frequence_paiement"],duree_contrat_en_mois:data_etablissement["duree_contrat_en_mois"],ville:data_etablissement["adresse_etablissement"],date_premier_abonnement:data_etablissement["date_premier_abonnement"],contact_etablissement:data_etablissement["contact_etablissement"],now:afficher_date(maintenant()),unite_montant_par_user:data_etablissement["donnees_contrat"]["unite_montant_par_user"],keep_temp:keep_temp};if(contrat_avec_signature()){datas["img_paraphe"]=data_etablissement["donnees_contrat"]["img_paraphe"];datas["img_signature"]=data_etablissement["donnees_contrat"]["img_signature"];datas["id_newTempFile"]=data_etablissement["donnees_contrat"]["id_newTempFile"]}return datas}function contrat_avec_signature(){return data_etablissement["donnees_contrat"]["img_signature"]&&data_etablissement["donnees_contrat"]["img_signature"]!==undefined&&data_etablissement["donnees_contrat"]["img_signature"]!==""&&data_etablissement["donnees_contrat"]["img_signature"]!==null&&data_etablissement["donnees_contrat"]["img_signature"]!=="null"}async function generer_contrat(){chargement(true);afficher_alerte("Merci de patienter, nous r√©cup√©rons les donn√©es de votre contrat √† signer...");url_contrat=await chercher_lien_script(7);contrat=contrat_datas(true);var url=url_contrat+"?API_KEY_UPLOAD="+recuperer("API_KEY_UPLOAD");afficher_alerte("R√©cup√©ration du contrat √† signer...");res=await post_resultat_asynchrone(url,JSON.stringify(contrat));if(res){res=JSON.parse(res);id_newTempFile=res["id_fichier"];nom_fichier=res["nom_fichier"]+".doc";visualiser_avec_demande_signature(nom_fichier,id_newTempFile);data_etablissement["donnees_contrat"]["id_newTempFile"]=id_newTempFile;actualiser_info_etablissement();chargement(false)}else{chargement(false)}}async function apposer_la_signature(lien_script){chargement(true);contrat=contrat_datas(false);var url=lien_script;afficher_alerte("C'est bient√¥t termin√©...");chargement(true);res=await post_resultat_asynchrone(url,JSON.stringify(contrat));if(res){res=JSON.parse(res);id_contrat=res["id_fichier"];nom_fichier=res["nom_fichier"]+".pdf";visualiser(nom_fichier,id_contrat);data_etablissement["donnees_contrat"]["id_contrat"]=id_contrat;data_etablissement["donnees_contrat"]["id_newTempFile"]=false;data_etablissement["donnees_contrat"]["img_paraphe"]=false;data_etablissement["donnees_contrat"]["img_signature"]=false;actualiser_info_etablissement();afficher_alerte("Contrat sign√© avec succ√®s.");chargement(false)}else{chargement(false)}}async function actualiser_info_etablissement(){await supabaseInit.from("Etablissements").upsert(data_etablissement)}function effacer_saisie(id_element){$(element_DOM(id_element)).jSignature("reset")}function bouton_effacer_paint(id_element){return`<rouge onclick="effacer_saisie('`+id_element+`')">EFFACER</rouge>`}function recuperer_image(id_image){return $(element_DOM(id_image)).jSignature("getData")}function signer_contrat(){var elements_html=`
	<div class='title_paint'>
		Paraphe
		`+bouton_effacer_paint("paraphe")+`
	</div>
	<div id='paraphe' class='paint_zone'></div>



	<div class='title_paint'>
		Signature
		`+bouton_effacer_paint("signature")+`
	</div>
	<div id='signature' class='paint_zone'></div>
	<input type="checkbox" name="sign" id="sign">
	<label for="sign">Je reconnais avoir lu l'ensemble des termes du pr√©sent contrat et j'accepte de le signer √©lectroniquement.</label>
	`;creer_mini_popup("Paraphe et signature du contrat",elements_html,"Parapher et signer","envoyer_paraphe_signature()",false,false,false,false,false,"sign_contrat");$("#sign").on("change",function(e){if(e.target.checked){$(element_DOM("sign_contrat")).show()}else{$(element_DOM("sign_contrat")).hide()}});$("#sign").change();$("#paraphe").jSignature();$("#signature").jSignature()}function recuperer_paraphe_signature(){return{img_paraphe:data_etablissement["donnees_contrat"]["img_paraphe"],img_paraphe:data_etablissement["donnees_contrat"]["img_signature"],id_newTempFile:data_etablissement["donnees_contrat"]["id_contrat"]}}function data_upload_paint(data_img,nom_fichier){data={file:data_img.replace(/^.*,/,""),nom_fichier:nom_fichier};return data}async function envoyer_paraphe_signature(){chargement(true);lien_script=await chercher_lien_script(7);lien_script+="?API_KEY_UPLOAD="+recuperer("API_KEY_UPLOAD");afficher_alerte("Merci de ne pas fermer l'onglet, votre signature est en cours de traitement...");if(!contrat_avec_signature()){data_img_paraphe=recuperer_image("paraphe");data_img_signature=recuperer_image("signature");lien_script_bis=lien_script+"&fichier=true";afficher_alerte("Publication des paraphes et de la signature...");data_etablissement["donnees_contrat"]["img_paraphe"]=await poster_image(data_img_paraphe,"paraphe",lien_script_bis);data_etablissement["donnees_contrat"]["img_signature"]=await poster_image(data_img_signature,"signature",lien_script_bis);actualiser_info_etablissement();$("#mini_popup").remove()}else{$("#mini_popup").remove()}contrat=contrat_datas(false);afficher_alerte("R√©cup√©ration du contrat en cours...");apposer_la_signature(lien_script)}async function poster_image(data_img,type_fichier,lien_script){var donnees=data_upload_paint(data_img,type_fichier+" "+nom_etablissement+".png");console.log({donnees:donnees});id_img=await post_resultat_asynchrone(lien_script,JSON.stringify(donnees));console.log({id_img:id_img});return id_img}function information_etablissement(id_info,etiquette_info,valeur_info,est_modifiable,est_consultable){crayon=est_modifiable?bouton_editer("modifier_info(this)"):"";nom_fichier=id_info.includes("id_newTempFile")?"Contrat √† signer":"Contrat";oeil=est_consultable?bouton_voir("voir_ou_generer_contrat('"+nom_fichier+".pdf','"+valeur_info+"')"):"";valeur_info=est_consultable?oeil:valeur_info;return'<div class="un_detail"><b style="color:#FF6C00">'+etiquette_info+': </b><br><span id="'+id_info+'">'+valeur_info+crayon+"</span></div>"}function actualiser_details_parametre(id_parametre){chargement(true);$("#menu_details")[0].innerHTML="";if(id_parametre==="Maintenance"){mettre_details_maintenance();$("#nombre_elements_param")[0].innerText=1;return true}else if(id_parametre==="Infos √©tablissement"){var id_contrat=data_etablissement.donnees_contrat.id_newTempFile?"id_newTempFile":"id_contrat";liste_id_infos_etablissement=["nom_etablissement:Nom de l'√©tablissement:false","date_premier_abonnement:Date de d√©but d'abonnement:false","duree_contrat_en_mois:Dur√©e du contrat (en mois):false","adresse_etablissement:Adresse:true","contact_etablissement:Contact de l'Administration:true","contact_economat:Contact de l'Economat:true","mots_interdits:Liste des mots interdits (s√©par√©s par une virgule):true","nb_heures_delai_examen:Nombre d'heures de tol√©rance pour les examens:true","donnees_contrat.montant_par_user:Montant par utilisateur","donnees_contrat.unite_montant_par_user:Devise du montant","donnees_contrat.frequence_paiement:Modalit√©s de paiement","donnees_contrat."+id_contrat+":Voir le contrat:false:true"];var info_etablissement_html="";liste_id_infos_etablissement.forEach(function(info){id_info=info.split(":")[0];etiquette_info=info.split(":")[1];valeur_info=id_info.includes(".")?data_etablissement[id_info.split(".")[0]][id_info.split(".")[1]]:data_etablissement[id_info];info_etablissement_html+=information_etablissement(id_info,etiquette_info,valeur_info,eval(info.split(":")[2]),eval(info.split(":")[3]))});info_etablissement_html+=`
		<details class="un_detail" style="color: #F00;">
		  <summary>ZONE DE DANGER</summary>
		  <span onclick="supprimer_etablissement()">Supprimer mon √©tablissement de Sekooly</span>
		</details>
		`;$("#menu_details").append(info_etablissement_html);return true}else{var identifiant_table=identifiant_par_table(id_parametre);return rechercher_tout(id_parametre).then(function(snapshot){liste_JSON=snapshot;traiter_liste_JSON(id_parametre,liste_JSON,identifiant_table);$("#nombre_elements_param")[0].innerText=liste_JSON.length;affichage_par_defaut(id_parametre);masquer_params_auto();au_changement_du_filtre();return liste_JSON})}}async function supprimer_etablissement(){var mon_type=recuperer("mon_type").split("_")[0];var mes_donnees=await recuperer_mes_donnees();if(mes_donnees){var confirmation=prompt("Merci de saisir votre code d'acc√®s pour d√©marrer le processus de suppression.");if(!confirmation)return afficher_alerte("Demande de suppression annul√©e.");if(code_ok(mes_donnees,confirmation)){var lien_script=await chercher_lien_script(5);var premiere_demande="?premiere_demande=oui";var adresse_mail_suppression="&adresse_mail_suppression="+data_etablissement["contact_etablissement"];var nom_etablissement_str="&nom_etablissement="+data_etablissement["nom_etablissement"];var id_etablissement_str="&id_etablissement="+data_etablissement["id_etablissement"];url=lien_script+premiere_demande+adresse_mail_suppression+nom_etablissement_str+id_etablissement_str;chargement(true);resultat=await post_resultat_asynchrone(url,{});alert(resultat);chargement(false)}else{console.error("Code erron√©.")}}else{return false}}function au_changement_du_filtre(){$("#filtre_parametre").on("change",function(e){compter_nombre_de_lignes()});chargement(false)}function compter_nombre_de_lignes(){$("#nombre_elements_param")[0].innerText=$("tbody").find(".une_ligne_de_donnees:visible").length}function traiter_liste_JSON(id_parametre,liste_JSON,identifiant_table){if(liste_JSON!==null&&liste_JSON!==undefined&&liste_JSON!==""&&liste_JSON.length>0){element_DOM("menu_details").innerHTML=json2Table(liste_JSON,identifiant_table)}else{element_DOM("menu_details").innerHTML='<i style="color: #bfbfbf;">Pas encore de donn√©es dans '+id_parametre+".</i>";effacer(id_parametre)}}function mettre_details_cycle(){filtre_liste=[];rechercher_tout("ID_RENDUS").then(function(snap){var filtre_liste_JSON=snap;for(key in filtre_liste_JSON){filtre_liste.push(key)}})}function mettre_details_maintenance(){var texte_explication="Si la maintenance est activ√©e, seuls certains membres de l'Administration pourront acc√©der √† la plateforme.";var maintenance_intiale=est_en_maintenance();maintenance_intiale.then(function(resultat){var details_maintenance_html='<div style="margin: 5% 5% 0% 5%;">'+texte_explication+'</div> <span class="toggle"><label class="switch"><input type="checkbox" id="changer_maintenance"><span class="slider round"></span></label></span><div id="texte_maintenance" style="color: #c0bdbd;"></div>';$("#menu_details").append(details_maintenance_html);$("#changer_maintenance")[0].checked=resultat==="oui";$("#texte_maintenance")[0].innerText=resultat==="oui"?"Activ√©":"D√©sactiv√©";$("#changer_maintenance").on("change",function(e){switcher_la_maintenance();var texte_maintenance_final=$("#texte_maintenance")[0].innerText==="Activ√©"?"D√©sactiv√©":"Activ√©";$("#texte_maintenance")[0].innerText=texte_maintenance_final})})["catch"](error=>{alert("Impossibile de r√©cup√©rer la valeur de la maintenance :"+error);console.error(error)})}function actualiser_filtre_onglet(id_parametre){var etiquette_filtre="";var filtre_liste=[];$("#filtre_parametre")[0].innerHTML="";var mes_matieres=JSON.parse(recuperer("mes_matieres"));var toutes_les_matieres=recuperer("Matieres")?JSON.parse(recuperer("Matieres")):mes_matieres;if(id_parametre==="Cycles"||id_parametre==="Maintenance"||id_parametre==="Alerte"||id_parametre==="Logs"||id_parametre==="Espace etablissement restant"||id_parametre==="Infos √©tablissement"){etiquette_filtre="Etablissement";filtre_liste=[nom_etablissement]}else{if(id_parametre==="Matieres"||id_parametre==="Eleves"){etiquette_filtre="Classe";filtre_liste=valeursUniquesDeCetteKey(toutes_les_matieres,"Classe")}else{etiquette_filtre="Cycle";filtre_liste=valeursUniquesDeCetteKey(toutes_les_matieres,"Cycle")}}assigner_label_et_liste_parametres(etiquette_filtre,filtre_liste);mettre_barre_recherche()}function assigner_label_et_liste_parametres(etiquette_filtre,filtre_liste){$("#label_filtre_parametre")[0].innerText=etiquette_filtre;$("#filtre_parametre")[0].innerHTML=$("#filtre_parametre")[0].innerHTML+'<option value="(Tous)">(Tous)</option>';for(var i=filtre_liste.length-1;i>=0;i--){$("#filtre_parametre")[0].innerHTML=$("#filtre_parametre")[0].innerHTML+'<option value="'+filtre_liste[i]+'">'+filtre_liste[i]+"</option>"}if($("#boutons_params"))$("#boutons_params").remove();var bouton_actualiser=un_bouton_param("actu_param","actualiser_parametre","Actualiser","img_actualiser.png");var bouton_ajouter=un_bouton_param("ajout_param","ajouter_donnees_parametres","Ajouter","img_ajout.png");var bouton_supprimer=un_bouton_param("suppr_param","supprimer_ligne_parameters","Supprimer","img_redtrash.png");var bouton_dupliquer=un_bouton_param("dupliquer_param","dupliquer_donnees_parametres","Dupliquer","img_dupliquer.png");var bouton_telecharger=un_bouton_param("telecharger_param","telecharger_donnees_parametres","T√©l√©charger","img_download.png");var bouton_import=un_bouton_param("importer_param","importer_parametres","Importer","img_import.png");var bouton_init=un_bouton_param("reset_param","init_donnees","Initialiser","img_reset.png");var bouton_tout_voir=un_bouton_param("tout_voir","afficher_colonnes","Afficher toutes les colonnes","img_previz.png");$("#conteneur_filtre")[0].innerHTML=$("#conteneur_filtre")[0].innerHTML+'<span id="boutons_params" style="cursor: pointer;"> '+bouton_actualiser+bouton_ajouter+bouton_supprimer+bouton_dupliquer+bouton_telecharger+bouton_import+bouton_init+bouton_tout_voir+" </span>";$("#filtre_parametre").on("change",function(e){appliquer_filtre_choisi()})}function mettre_barre_recherche(){$("#zone_recherche").remove();$("#stockage").remove();var zone_recherche='<input id="zone_recherche" type="text" onkeyup="chercher()" placeholder="Rechercher...">';$("#conteneur_filtre").append(zone_recherche)}function mettre_etat_espace(id_parametre,valeur_recherchee){resultat="";if(id_parametre==="Espace etablissement restant"){$("label_filtre_parametre").remove();$("filtre_parametre").remove();$(".stockage").remove();mettre_la_somme(valeur_recherchee);$("#zone_recherche").on("input",function(e){valeur_recherchee=e.target.value;$(".stockage").remove();if(id_parametre==="Espace etablissement restant")mettre_la_somme(valeur_recherchee)});return true}return false}function mettre_la_somme(valeur_recherchee){la_somme=somme("Espace etablissement restant","octets_utilises",valeur_recherchee);valeur_max=5e10;pourcentage=100*(la_somme/valeur_max).toFixed(4);precisions=valeur_recherchee?valeur_recherchee:"total";resultat='<div id="stockage" class="stockage"><i style="margin-left: 50px;"><label>Stockage utilis√© '+precisions+':<progress style="width: 60px;" value="'+la_somme+'" max="'+valeur_max+'"></progress> '+pourcentage.toFixed(2)+"% ("+(la_somme/1e9).toFixed(2)+"/50 Go)</i></span></div>";$("#conteneur_filtre").append(resultat)}function chercher(){table=element_DOM("table_affichee");tr=table.getElementsByTagName("tr");mon_filtre=element_DOM("zone_recherche").value.toUpperCase().trim();if(mon_filtre){for(i=1;i<tr.length;i++){texte_ligne=tr[i].textContent.toUpperCase();tr[i].style.display=texte_ligne.includes(mon_filtre)?"":"none";if(texte_ligne.includes(mon_filtre)&&mon_filtre){for(j=0;j<tr[i].children.length;j++){cellule=tr[i].cells[j];valeur_cellule=cellule.textContent.toUpperCase();if(valeur_cellule.includes(mon_filtre)){cellule.className="trouvee"}else{cellule.className=""}}}}}else{$("tr").show();$("td").removeClass()}compter_nombre_de_lignes()}function un_bouton_param(id_bouton_param,fonction_bouton_param,alt_bouton_param,src_image){return'<img id="'+id_bouton_param+'" onclick="'+fonction_bouton_param+'()" alt="'+alt_bouton_param+'" src="'+prefixe_image+"/"+src_image+'" class="icone_param">'}function json2Table(json,id_table){var id_parametre=$(".un_menu_orange")[0].id;let cols=nom_des_champs(id_parametre);let headerRow=cols.map(col=>`<th id="${col}" oncontextmenu="afficher_clic_droit_param(this)" class="header_table entete_sticky">${col}</th>`).join("");let rows=json.map((row,index)=>{if(row!==null){let tds=cols.map(col=>`<td>${row[col]}</td>`).join("");return`<tr suppression_id="${row[id_table]}" id="${row[id_table]}" onclick="clic_ligne(this)"  class= "border_bottom une_ligne_de_donnees">${tds}</tr>`}}).join("");const table=`
	<table id="table_affichee">
		<thead class="">
			<tr class= "border_bottom">${headerRow}</tr>
		</thead>
		<tbody>
			${rows}
		</tbody>
	</table>`;return table}function clic_ligne(ceci){if($(".une_ligne_de_donnees.selected")[0])$(".une_ligne_de_donnees.selected")[0].className="une_ligne_de_donnees";ceci.className="une_ligne_de_donnees selected"}function supprimer_tous_les_parametres(){for(var i=0;i<elements_menu_haut.length;i++){effacer(elements_menu_haut[i])}}function rendre_td_modifiable(){$(document).on("dblclick","tbody",function(e){fonction_td_modifiable(e)})}function fonction_td_modifiable(e,sans_suite){var ancienne_valeur=e.target.innerText;var id_parametre=$(".un_menu_orange")[0].id;var liste_index_params_auto=","+parametres_automatiques.map(e=>$('[id="'+e+'"].header_table.entete_sticky:visible')).filter(e=>e.length>0).map(e=>e[0].cellIndex).join(",")+",";var liste_index_oui_non=","+champs_oui_ou_non.map(e=>$('[id="'+e+'"].header_table.entete_sticky:visible')).filter(e=>e.length>0).map(e=>e[0].cellIndex).join(",")+",";var est_classe=$("#Classe")[0]?e.target.cellIndex===$("#Classe")[0].cellIndex:false;var est_classe_principale=$("#Classe_principale")[0]?e.target.cellIndex===$("#Classe_principale")[0].cellIndex:false;var est_classe_bis=$("#classe_bis")[0]?e.target.cellIndex===$("#classe_bis")[0].cellIndex:false;var nest_pas_onglet_classes=id_parametre!=="Classes";if(nest_pas_onglet_classes&&(est_classe||est_classe_principale||est_classe_bis)){var les_matieres=JSON.parse(recuperer("Matieres"));if(les_matieres===null){rechercher_tout("Matieres").then(function(snapshot){liste_JSON=snapshot;stocker("Matieres",JSON.stringify(liste_JSON?liste_JSON:""));les_matieres=JSON.parse(recuperer("Matieres"));valeurs_possibles=valeurs_possibles_modification_classes(e,id_parametre,les_matieres);formulaire_choix_checkbox("Classe(s)",e,ancienne_valeur,e.target.parentNode.id,valeurs_possibles,ancienne_valeur.split(";"),id_parametre==="Administration")})}else{valeurs_possibles=valeurs_possibles_modification_classes(e,id_parametre,les_matieres);formulaire_choix_checkbox("Classe(s)",e,ancienne_valeur,e.target.parentNode.id,valeurs_possibles,ancienne_valeur.split(";"),id_parametre==="Administration")}}else if(liste_index_params_auto.includes(","+e.target.cellIndex+",")){alert("Impossible de modifier ce param√®tre car c'est une valeur automatiquement attribu√©e par Sekooly.");return false}else if(liste_couleurs.includes(ancienne_valeur)){formulaire_choix_checkbox("Couleur",e,ancienne_valeur,e.target.parentNode.id,liste_couleurs,ancienne_valeur,true)}else if(liste_index_oui_non.includes(","+e.target.cellIndex+",")){var nom_champ_dblclic=$(".header_table.entete_sticky")[e.target.cellIndex].innerText;formulaire_choix_checkbox(nom_champ_dblclic,e,ancienne_valeur,e.target.parentNode.id,["oui","non"],ancienne_valeur,true)}else{var nouvelle_valeur=prompt("Indiquez la nouvelle valeur",ancienne_valeur);suite_actualiser_double_clic(e,ancienne_valeur,nouvelle_valeur)}}function valeurs_possibles_modification_classes(e,id_parametre,les_matieres){var valeurs_possibles=valeursUniquesDeCetteKey(les_matieres,"Classe_Matiere");if(id_parametre==="Administration"){valeurs_possibles=valeursUniquesDeCetteKey(les_matieres,"Cycle");valeurs_possibles=valeurs_possibles.map(e=>"(Tous|"+e+")")}else{if(id_parametre==="Eleves"||id_parametre==="Matieres"||e.target.cellIndex===$("#Classe_principale")[0].cellIndex){valeurs_possibles=valeursUniquesDeCetteKey(les_matieres,"Classe")}}return valeurs_possibles}async function suite_actualiser_double_clic(e,ancienne_valeur,nouvelle_valeur){if(nouvelle_valeur===null)return-1;chargement(true);var nom_table=$(".un_menu_orange")[0].id;var nom_champ_reference=identifiant_par_table(nom_table);var valeur_champ_reference=e.target.parentNode.id;var numero_colonne=e.target.cellIndex;var champ_actualise=$(".header_table.entete_sticky")[numero_colonne].innerText;var ancien_data={[champ_actualise]:ancienne_valeur};var nouveau_data={[champ_actualise]:nouvelle_valeur};var table_JSON_local=await rechercher_tout(nom_table);if(table_JSON_local!==null){if(champ_actualise===nom_champ_reference){existence_ID=table_JSON_local.filter(a=>a[nom_champ_reference]===nouvelle_valeur).length>0;if(existence_ID){alert("Mise √† jour impossible: cet identifiant '"+nouvelle_valeur+"' existe d√©j√†.");chargement(false);return 0}}}if(valeur_champ_reference.includes("admin")){alert("Impossible de modifier l'admin car cet utilisateur est utile pour administrer votre plateforme sekooly.");chargement(false);return 0}try{actualiser(nom_table,nom_champ_reference,valeur_champ_reference,nouveau_data);e.target.innerText=nouvelle_valeur;if(champ_actualise===nom_champ_reference){e.target.parentNode.id=nouvelle_valeur}actualiser_json_local_et_drive(nom_table,table_JSON_local,champ_actualise,ancienne_valeur,nouvelle_valeur,valeur_champ_reference)}catch(error){alert("Mise √† jour impossible: "+error);e.target.innerText=ancienne_valeur;if(champ_actualise===nom_champ_reference){e.target.parentNode.id=ancienne_valeur}actualiser_json_local_et_drive(nom_table,table_JSON_local,champ_actualise,nouvelle_valeur,ancienne_valeur,valeur_champ_reference);console.error(error)}chargement(false)}function formulaire_choix_checkbox(nom_champ,e,ancienne_valeur,identifiant,liste_en_array,liste_deja_coch√©s,un_seul_choix){$("#mini_popup").remove();var entetes='<div id="mini_popup" style="overflow: hidden auto;"><div id="entete-fenetre" style="display: inline-flex;float: right;"><img alt="X" src="'+prefixe_image+'/quitter.png" id="bye_prev" onclick="$(\'#mini_popup\').remove()" style="width: 30px; height: 30px;cursor:pointer;position:fixed;z-index:3;transform: translate(-50%, -50%);"> </div>';var titre_formulaire="<div>"+nom_champ+" pour <b>"+identifiant+'</b></div><div id="liste_classe_matieres" style="padding-top: 4%;padding-bottom: 4%;text-align: left;"><div>';var les_elements="";for(var i=0;i<liste_en_array.length;i++){est_coch√©=liste_deja_coch√©s?liste_deja_coch√©s.indexOf(liste_en_array[i])>=0?"checked":"":"";classe_initiale=est_coch√©==="checked"?"en_gras":"";type_element=un_seul_choix?"radio":"checkbox";les_elements=les_elements+'<div class="'+classe_initiale+'"><input class="choix_liste_matiere" type="'+type_element+'" id="'+liste_en_array[i]+'" name="choix_liste_matiere" '+est_coch√©+"><label>"+liste_en_array[i]+"</label></div>"}var bouton_assigner='</div></div><button type="button" class="rendre" id="assigner">Assigner</button></div>';var html_final=entetes+titre_formulaire+les_elements+bouton_assigner;$("body").append(html_final);$("#assigner").on("click",function(ceci){suite_actualiser_double_clic(e,ancienne_valeur,retourner_les_coch√©s());$("#mini_popup").remove()});$(".choix_liste_matiere").on("change",function(e){e.target.parentNode.className=e.target.checked?"en_gras":""})}function retourner_les_coch√©s(){var resultat="";Array.from($(".choix_liste_matiere:checked")).forEach(function(valeur,index){resultat=resultat+(resultat===""?"":";")+valeur.id});return resultat}function actualiser_json_local_et_drive(nom_table,table,champ_actualise,ancienne_valeur,nouvelle_valeur,valeur_champ_reference){if(table){table.some(function(valeur,index){if(valeur[champ_actualise]===ancienne_valeur){valeur[champ_actualise]=nouvelle_valeur;return true}});stocker(nom_table,JSON.stringify(table))}else{}if(champ_actualise===nom_table.slice(0,-1)){var id_dossier=valeur_champ_reference;var nom_final=nouvelle_valeur;renommer_sur_drive(id_dossier,nom_final)}}function renommer_sur_drive(id_dossier,nom_final){var lien_script="https://script.google.com/macros/s/AKfycbw4v50VJkia9YfdFkFQIYDTBLqVYmlxEGOuas9tO-PwvuEI63I/exec?";var param_id_dossier="id_dossier="+id_dossier;var param_nom_final="nom_final="+nom_final;var url=lien_script+param_id_dossier+"&"+param_nom_final;try{var retour=get_resultat_brut(url);console.log(retour)}catch(error){alert(error)}}function actualiser_parametre(id_parametre){if(!id_parametre)id_parametre=$(".un_menu_orange")[0].id;effacer(id_parametre);un_menu_clic(id_parametre)}function ajouter_donnees_parametres(id_parametre){if(!id_parametre)id_parametre=$(".un_menu_orange")[0].id;var liste_champs=recuperer_entetes_params(id_parametre);creer_formulaire_ajout_donnee_html(id_parametre,liste_champs)}function dupliquer_donnees_parametres(id_parametre){if(!id_parametre)id_parametre=$(".un_menu_orange")[0].id;id_ligne_dupliquee=0;var liste_champs=recuperer_entetes_params(id_parametre);creer_formulaire_ajout_donnee_html(id_parametre,liste_champs,true)}function supprimer_ligne_parameters(id_parametre){if(!id_parametre)id_parametre=$(".un_menu_orange")[0].id;if(!$(".selected")[0]){confirmer_suppression=prompt("Vous √™tes sur le point de vider TOUTE LA TABLE "+id_parametre+". Pour confirmer la suppression, merci d'√©crire '"+id_parametre+"', sinon cliquez sur Annuler.");if(confirmer_suppression===id_parametre){chargement(true);supprimer_tout(id_parametre);setTimeout(function(){actualiser_parametre();chargement(false)},1500)}return 0}var id_ligne=$(".selected")[0].getAttribute("suppression_id");var validation=confirm("‚ö†Ô∏èVoulez-vous supprimer cette ligne ? Cette action est irr√©versible. ("+id_ligne+")");if(validation){if(id_ligne.includes("admin")){alert("Impossible de supprimer l'admin car cet utilisateur est utile pour administrer votre plateforme sekooly.");chargement(false);return 0}chargement(true);if(id_parametre==="Classes"||id_parametre==="Matieres"){var donnees_parametres=JSON.parse(recuperer(id_parametre));var index_google_calendar=$("#id_googlecalendar").length>0?$("#id_googlecalendar")[0].cellIndex:-1;var id_googlecalendar=index_google_calendar>=0?$(".selected")[0].children[index_google_calendar].innerText:"";var commun=$(".selected")[0].children[$("#commun_au_cycle")[0].cellIndex].innerText;if(commun!=="oui"){var id_dossier=$(".selected")[0].children[$("#ID_URL")[0].cellIndex].innerText;supprimer_dossier(id_dossier,id_googlecalendar);nom_champ_parent=id_parametre==="Classes"?"cycle":"classe_id";valeur_champ_parent=$(".selected")[0].children[$('[id="'+nom_champ_parent+'"]')[0].cellIndex].innerText;elements_similaires=donnees_parametres.filter(e=>e[nom_champ_parent]===valeur_champ_parent);est_le_dernier_dossier=elements_similaires.length===1;if(est_le_dernier_dossier){titre_parent_visible_user=id_parametre==="Classes"?"cycle":"Classe";nom_parent_visible_user=$(".selected")[0].children[$("#"+titre_parent_visible_user)[0].cellIndex].innerText;valeur_ligne_visible_user=$(".selected")[0].children[$("#"+id_parametre.slice(0,-1))[0].cellIndex].innerText;confirmation=confirm("'"+valeur_ligne_visible_user+"' √©tait la seule "+id_parametre.slice(0,-1).toLowerCase()+" dans '"+nom_parent_visible_user+"' ("+titre_parent_visible_user+"). Voulez-vous √©galement supprimer "+nom_parent_visible_user+" ? ("+titre_parent_visible_user+")");if(confirmation){donnees_cycle=id_parametre==="Classes"?get_resultat(racine_data+"Cycles?"+apikey+"&cycle=eq."+valeur_champ_parent):"";id_dossier_parent=id_parametre==="Classes"?donnees_cycle[0]!==undefined?donnees_cycle[0]["id_dossier_cycle"]:"":valeur_champ_parent;console.log("le parent √† supprimer: "+id_dossier_parent);if(id_dossier_parent){supprimer_dossier(id_dossier_parent,id_googlecalendar);nom_table_parent=id_parametre==="Classes"?"ID_RENDUS":"Classes";nom_table=nom_table_parent;nom_champ_reference=identifiant_par_table(nom_table_parent);valeur_champ_reference=valeur_champ_parent;if(nom_table_parent==="ID_RENDUS"){id_dossier_cycle=get_resultat(racine_data+"ID_RENDUS?Cycle=eq."+valeur_champ_parent+"&"+apikey)[0]["id_dossier_cycle"];console.log("on va supprimer le cycle: "+id_dossier_cycle);if(id_dossier_cycle)supprimer_dossier(id_dossier_cycle)}supprimer(nom_table,nom_champ_reference,valeur_champ_reference)}}}}}nom_table=id_parametre;nom_champ_reference=identifiant_par_table(id_parametre);valeur_champ_reference=id_ligne;supprimer(nom_table,nom_champ_reference,valeur_champ_reference);setTimeout(function(){actualiser_parametre();chargement(false)},1e3)}}function supprimer_dossier(id_dossier,id_googlecalendar){var lien_script="https://script.google.com/macros/s/AKfycbyGEGpbPE0WniCcBMbLCar_zGTNwKyABrnmfOE-zfb8TOUH4AY/exec";var id_dossier="&id_dossier="+id_dossier;var id_googlecalendar=id_googlecalendar?"&id_googlecalendar="+id_googlecalendar:"";var url=lien_script+"?suppr=true"+id_dossier+id_googlecalendar;try{var resultat=get_resultat_brut(url);console.log(resultat)}catch(error){console.error(error);alert("Erreur survenue pendant la suppression sur le serveur: "+error)}}function telecharger_donnees_parametres(id_parametre){if(!id_parametre)id_parametre=$(".un_menu_orange")[0].id;var choix_entete_ou_tout_html='<div id="mini_popup">';choix_entete_ou_tout_html=choix_entete_ou_tout_html+'<div id="entete-fenetre" style="display: inline-flex;float: right;">';choix_entete_ou_tout_html=choix_entete_ou_tout_html+'<img alt="X" src="'+prefixe_image+'/quitter.png" id="bye_prev" onclick="$(\'#mini_popup\').remove()" style="width: 30px; height: 30px;cursor:pointer;position:fixed;z-index:3;transform: translate(-50%, -50%);"> </div>';choix_entete_ou_tout_html=choix_entete_ou_tout_html+"<div>T√©l√©charger "+id_parametre+'</div><select style="width: 80%;" id="choix_download_param">';choix_entete_ou_tout_html=choix_entete_ou_tout_html+'<option value="En-t√™tes">En-t√™tes</option>';choix_entete_ou_tout_html=choix_entete_ou_tout_html+'<option value="Tout">Toutes les donn√©es</option></select>';choix_entete_ou_tout_html=choix_entete_ou_tout_html+'<button type="button" class="rendre" onclick="telecharger_parametre()">T√©l√©charger</button></div>';$("#mini_popup").remove();$("body").append(choix_entete_ou_tout_html)}async function telecharger_parametre(id_parametre){if(!id_parametre)id_parametre=$(".un_menu_orange")[0].id;var entetes_seulement=$("#choix_download_param")[0].value==="En-t√™tes";var contenu_recup=entetes_seulement?nom_des_champs(id_parametre):await rechercher_tout(id_parametre);var contenu=convertir_csv(contenu_recup,entetes_seulement);var suite_nom=entetes_seulement?"-modele-":"";var nom_fichier=id_parametre+suite_nom+maintenant_sans_caracteres_speciaux()+".csv";enregistrer_donnees_en_csv(contenu,nom_fichier)}function enregistrer_donnees_en_csv(contenu,nom_fichier){var a=document.createElement("a");document.body.appendChild(a);a.style="display: none";var universalBOM="\ufeff";var blob=new Blob([universalBOM+contenu],{type:"text/csv;charset=utf-8;"});url=window.URL.createObjectURL(blob);a.href=url;a.target="_blank";a.download=nom_fichier;a.click();window.URL.revokeObjectURL(url);a.remove()}function importer_parametres(){$("#fichier_import").remove();var id_parametre=$(".un_menu_orange")[0].id;var champs_initiaux=nom_des_champs(id_parametre);var fichier_html='<input id="fichier_import" type="file" name="fichier_import" accept=".csv" style="display:none;">';$("body").append(fichier_html);$("#fichier_import").on("change",function(e){if(e.target.files[0].name.split(".").pop().trim().toLowerCase()!=="csv"){alert("Erreur: merci de choisir un fichier d'extension .csv");$("#fichier_import").remove();return 0}var reader=new FileReader;reader.onload=function(){var contenu=reader.result;var json_final=csv_en_JSON(contenu);console.log(json_final);if(json_final.length===0){alert("Ce fichier .csv ne contient aucune donn√©e √† importer.");$("#fichier_import").remove();return 0}var probleme="";var cle_problematique=Object.keys(json_final[0]).some(key=>{probleme=key;return champs_initiaux.indexOf(key)<0});if(cle_problematique){alert("Probl√®me d'import: le champ '"+probleme+"' n'est pas reconnu dans la table '"+id_parametre+"'.");$("#fichier_import").remove();return 0}var nombre_lignes=Number(json_final.length);var liste_champs=champs_initiaux;var avec_s=nombre_lignes>1?"s":"";confirmation=confirm("Nous avons d√©tect√© "+nombre_lignes+" ligne"+avec_s+" avec "+Object.keys(json_final[0]).length+" champs. Voulez-vous importer ces donn√©es ?");if(confirmation){chargement(true);for(var i=0;i<json_final.length;i++){afficher_alerte("Progression de l'import: "+Number(100*i/json_final.length).toFixed(2)+"% ("+i+"/"+json_final.length+")");creer_formulaire_ajout_donnee_html(id_parametre,liste_champs,false,json_final[i]?json_final[i]:"");ajouter_donnees_saisies(id_parametre,i<json_final.length-1)}afficher_alerte("Import termin√©.")}$("#fichier_import").remove()};reader.readAsText(e.target.files[0])});$("#fichier_import").click()}function init_donnees(){id_parametre=$(".un_menu_orange")[0].id;if($(".selected")[0]){identifiant_a_init=$(".selected")[0].getAttribute("suppression_id");var confirmation=confirm("√ätes-vous s√ªr de r√©initialiser '"+identifiant_a_init+"' ? Cela remettra son mot de passe par d√©faut, et ignorera toute consultation de notifications.");if(!confirmation)return-1;chargement(true);reinitialiser_unseul_mdp_datenotif(id_parametre,identifiant_a_init);setTimeout(function(){actualiser_parametre()},2e3);chargement(false)}else{var confirmation=prompt("√ätes-vous s√ªr d'initialiser votre plateforme ? Cela remettra TOUS les mots de passe par d√©faut et ignorera toute consultation de notifications. Pour continuer, taper 'reinitialiser'.");if(confirmation==="reinitialiser"){chargement(true);reinitialiser_mdp_datenotif();setTimeout(function(){actualiser_parametre()},2e3);chargement(false)}}}function recuperer_entetes_params(id_parametre){return nom_des_champs(id_parametre)}function creer_formulaire_ajout_donnee_html(id_parametre,liste_champs,avec_duplicata,une_donnee){var entete='<div style="overflow:auto;" id="mini_popup"><div id="entete-fenetre" style="display: inline-flex;float: right;"><img alt="X" src="'+prefixe_image+'/quitter.png" id="bye_prev" onclick="$(\'#mini_popup\').remove()" style="width: 30px; height: 30px;cursor:pointer;position:fixed;z-index:3;transform: translate(-50%, -50%);"> </div><div>Nouvelle donn√©e dans '+id_parametre+'</div><form class="donnees_saisies" id="donnees_saisies" >';var liste_champs_html="";if(liste_champs.length>0){chargement(true);for(var i=0;i<liste_champs.length;i++){disabled=parametres_automatiques.indexOf(liste_champs[i])>=0?"disabled":"";donnee_dupliquee=avec_duplicata?$(".selected")?' value="'+$(".selected")[0].children[i].innerText+'" ':"":une_donnee?' value="'+(une_donnee[liste_champs[i]]?une_donnee[liste_champs[i]]:"")+'" ':"";html_du_input='<input class="donnee" '+donnee_dupliquee.replaceAll('"',"'")+' id="'+liste_champs[i]+'" name="'+liste_champs[i]+'" '+disabled+">";if(!une_donnee){if(liste_champs[i]==="Couleur_matiere"){html_du_input='<select class="donnee" id="'+liste_champs[i]+'" name="'+liste_champs[i]+'" >';for(j=0;j<liste_couleurs.length;j++){selectionner_la_donnee_dupliquee="";if($(".selected")[0])selectionner_la_donnee_dupliquee=liste_couleurs[j]===$(".selected")[0].children[i].innerText?" selected ":"";html_du_input=html_du_input+"<option "+selectionner_la_donnee_dupliquee+' value ="'+liste_couleurs[j]+'">'+liste_couleurs[j]+"</option>"}html_du_input=html_du_input+"</select>"}else if(champs_avec_listes_dynamiques.indexOf(liste_champs[i])>=0){toutes_les_matieres=get_resultat(racine_data+"Matieres"+"?"+apikey);choix_classe_dun_admin=(liste_champs[i]==="Classe"||liste_champs[i]==="classe_bis")&&$(".un_menu_orange")[0].innerText==="Administration";choix_classe_dun_prof=(liste_champs[i]==="Classe"||liste_champs[i]==="classe_bis")&&$(".un_menu_orange")[0].innerText==="Profs";nom_du_champ_cl√©=liste_champs[i]==="cycle"?"Cycle":liste_champs[i]==="classe_bis"||liste_champs[i]==="Classe_principale"?"Classe":choix_classe_dun_admin?"Cycle":choix_classe_dun_prof?"Classe_Matiere":liste_champs[i];valeurs_possibles=valeursUniquesDeCetteKey(toutes_les_matieres,nom_du_champ_cl√©);if(choix_classe_dun_admin)valeurs_possibles=valeurs_possibles.map(e=>"(Tous|"+e+")");multiple_choix_classes=choix_classe_dun_prof?"multiple":"";if(valeurs_possibles.length===0){html_du_input='<input class="donnee" '+donnee_dupliquee+' id="'+liste_champs[i]+'" name="'+liste_champs[i]+'" '+disabled+">"}else{html_du_input='<select class="donnee" id="'+liste_champs[i]+'" name="'+liste_champs[i]+'" '+multiple_choix_classes+" "+disabled+">";for(j=0;j<valeurs_possibles.length;j++){selectionner_la_donnee_dupliquee="";if($(".selected")[0])selectionner_la_donnee_dupliquee=valeurs_possibles[j]===$(".selected")[0].children[i].innerText?" selected ":"";html_du_input=html_du_input+"<option "+selectionner_la_donnee_dupliquee+' value ="'+valeurs_possibles[j]+'">'+valeurs_possibles[j]+"</option>"}html_du_input=html_du_input+'<option value="nouveau" style="font-style: oblique;" >Nouvelle valeur</option>'+"</select>"}}else if(champs_oui_ou_non.indexOf(liste_champs[i])>0){html_du_input='<select class="donnee" value="non" id="'+liste_champs[i]+'" name="'+liste_champs[i]+'" ><option value="non">non</option><option value="oui">oui</option></select>'}}var display_element=" style='display:"+(disabled?"none":"")+"';";liste_champs_html=liste_champs_html+'<div class="une_donnee_saisie" '+display_element+' id="'+liste_champs[i]+'"><label>'+liste_champs[i]+"</label>"+html_du_input+"</div>"}}var boutons_ajouter_annuler='</form><button type="button" class="rendre" onclick="ajouter_donnees_saisies(\''+id_parametre+"')\">Ajouter</button>";boutons_ajouter_annuler=boutons_ajouter_annuler+'<button type="button" class="rendre" onclick="$(\'#mini_popup\').remove()">Annuler</button></div>';boutons_ajouter_annuler=boutons_ajouter_annuler;$("#mini_popup").remove();$("body").append(entete+liste_champs_html+boutons_ajouter_annuler);$("select.donnee").on("change",function(e){if(e.target.value==="nouveau"){transformer_en_simple_input(e.target.id)}});chargement(false)}function transformer_en_simple_input(nom_champ){nouvelle_valeur=prompt("Indiquez la nouvelle valeur de "+nom_champ+": ");if(nouvelle_valeur!==null){$("[id='"+nom_champ+"'].donnee")[0].outerHTML='<input class="donnee" value="'+nouvelle_valeur+'" id="'+nom_champ+'" name="'+nom_champ+'">'}else{$("[id='"+nom_champ+"'].donnee")[0].value=""}}function ajouter_donnees_saisies(id_parametre,ne_pas_actualiser){nom_cycle=$(".donnee#cycle").length>0?$(".donnee#cycle")[0].value:$(".donnee#Cycle").length>0?$(".donnee#Cycle")[0].value:"";nom_classe=$(".donnee#Classe").length>0?$(".donnee#Classe")[0].value.includes("|")?"":$(".donnee#Classe")[0].value:"";nom_matiere=$(".donnee#Matiere").length>0?$(".donnee#Matiere")[0].value:"";if(id_parametre==="Classes"){var donnees_classes=JSON.parse(recuperer("Classes"));if(donnees_classes!==null){var existence_classe=donnees_classes.some(e=>{if(e)return e["Classe"]===nom_classe&&e["cycle"]===nom_cycle});if(existence_classe){alert("Cette classe existe d√©j√† dans ce cycle.");return-1}}}else if(id_parametre==="Matieres"){var donnees_matieres=JSON.parse(recuperer("Matieres"));if(donnees_matieres!==null){var existence_matiere=donnees_matieres.some(e=>{if(e)return e["Classe"]===nom_classe&&e["Matiere"]===nom_matiere+")"});if(existence_matiere){alert("Cette mati√®re existe d√©j√†.");return-1}}}if(id_parametre==="Classes"||id_parametre==="Matieres"){if(formulaire_rempli("donnees_saisies")===false){if(plateforme_prete()===true){alert("Merci de remplir tous les champs.");return-1}}var param_nom_etablissement=nom_etablissement?"?nom_etablissement="+nom_etablissement:"";var param_nom_cycle=nom_cycle?"&nom_cycle="+nom_cycle:"";var param_nom_classe=nom_classe?"&nom_classe="+nom_classe:"";var param_nom_matiere=nom_matiere?"&nom_matiere="+nom_matiere:"";var param_commun_au_cycle=$(".donnee#commun_au_cycle")[0]?"&commun_au_cycle="+$(".donnee#commun_au_cycle")[0].value:"non";id_rendu_actuel=get_resultat(racine_data+"ID_RENDUS?"+apikey+"&Cycle=eq."+nom_cycle);var initier=id_rendu_actuel.length===0;var param_initier="&initier="+initier;var lien_script="https://script.google.com/macros/s/AKfycbyGEGpbPE0WniCcBMbLCar_zGTNwKyABrnmfOE-zfb8TOUH4AY/exec";lien_script=lien_script+param_nom_etablissement;lien_script=lien_script+param_nom_cycle;lien_script=lien_script+param_nom_classe;lien_script=lien_script+param_nom_matiere;lien_script=lien_script+param_commun_au_cycle;lien_script=lien_script+param_initier;chargement(true);var les_ids_recus=get_resultat(lien_script);var la_classe=nom_classe;var id_de_la_classe=get_valeur(les_ids_recus,la_classe);var id_du_cycle=get_valeur(les_ids_recus,nom_cycle);var id_googlecalendar=get_valeur(les_ids_recus,"id_googlecalendar");var la_matiere=nom_matiere;var id_de_la_matiere=get_valeur(les_ids_recus,la_matiere);var id_dossier_rendus=get_valeur(les_ids_recus,"Rendus de devoirs");if(initier){nouveau_data={Cycle:nom_cycle,dossier_rendus_cycle:id_dossier_rendus,id_dossier_cycle:id_du_cycle};post_resultat_asynchrone(racine_data+"ID_RENDUS?"+apikey,nouveau_data)}$(".donnee[id='commun_au_cycle']")[0].value=id_parametre==="Matieres"&&($(".donnee#Cycle")[0].value===$(".donnee#Matiere")[0].value||$(".donnee#Matiere")[0].value==="Vie scolaire")?"oui":"non";if(id_parametre==="Classes"){$(".donnee[id='Classe_bis']")[0].value=la_classe;$(".donnee[id='ID_URL']")[0].value=id_de_la_classe;$(".donnee[id='URL']")[0].value="https://drive.google.com/drive/folders/"+id_de_la_classe;$(".donnee[id='URL_Mapping']")[0].value=id_de_la_classe;$(".donnee[id='id_googlecalendar']")[0].value=id_googlecalendar;$(".donnee[id='URL_agenda']")[0].value="https://calendar.google.com/calendar/embed?src="+id_googlecalendar+"&ctz="+my_ctz()}else if(id_parametre==="Matieres"){$(".donnee[id='Classe_Matiere']")[0].value="("+la_classe+"|"+la_matiere+")";$(".donnee[id='ID_URL']")[0].value=id_de_la_matiere;$(".donnee[id='Matiere_bis']")[0].value=la_matiere;$(".donnee[id='URL']")[0].value="https://drive.google.com/drive/folders/"+id_de_la_matiere;$(".donnee[id='URL_Mapping']")[0].value=id_de_la_matiere;$(".donnee[id='classe_id']")[0].value=id_de_la_classe}}else if(id_parametre==="Eleves"||id_parametre==="Profs"||id_parametre==="Administration"){if(id_parametre.includes("Admin"))$(".donnee[id='Classe']")[0].value="(Tous|"+$(".donnee[id='Cycle']")[0].value+")";$(".donnee[id='Derniere_consultation_notifs']")[0].value="30/12/1899 00:00:00";$(".donnee[id='type']")[0].value=id_parametre.includes("Admin")?"Administration":id_parametre;$(".donnee[id='Droit_acces_anticipe_examen']")[0].value=id_parametre.includes("Eleves")?"non":"oui";if($(".donnee[id='Droit_changer_ecolage']")[0])$(".donnee[id='Droit_changer_ecolage']")[0].value="non";if($(".donnee[id='Droits_modifs']")[0])$(".donnee[id='Droits_modifs']")[0].value="non";$(".donnee[id='Ecolage_OK']")[0].value="oui";$(".donnee[id='code_hash']")[0].value="nok";$(".donnee[id='Reponse_sondage']")[0].value="non";$(".donnee[id='droit_hors_maintenance']")[0].value="non";$(".donnee[id='liste_notifs_lues']")[0].value=",";if($(".donnee[id='Numero_telephone']")[0])$(".donnee[id='Numero_telephone']")[0].value="123456"}var mon_JSON=convertir_saisie_en_JSON("donnees_saisies",id_parametre);var nouvel_id=recuperer(id_parametre)?JSON.parse(recuperer(id_parametre)).length:1;ajouter_un_element(id_parametre,JSON.parse(mon_JSON),nouvel_id);if(!ne_pas_actualiser)actualiser_parametre(id_parametre);vider_les_input();chargement(false);return 0}function get_valeur(liste_initiale,motif){var index_motif=liste_initiale.findIndex(element=>element.includes(motif+":"));return liste_initiale[index_motif].split(motif+":")[1]}function convertir_saisie_en_JSON(id_form,id_parametre){var saisie="{";var liste_champs_saisie=$("#"+id_form)[0].children;id_parametre=id_parametre?id_parametre:$(".un_menu_orange")[0]?$(".un_menu_orange")[0].innerText:"";for(var i=0;i<liste_champs_saisie.length;i++){nom_champ=$("#"+id_form)[0].children[i].children[0].innerText;valeur_saisie=nom_champ==="Classe"&&id_parametre==="Profs"&&$("#Classe.donnee")[0].nodeName!=="INPUT"?$("#Classe.donnee").val().join(";"):$(".donnee[id='"+nom_champ+"']")[0].value;saisie=saisie+'"'+[nom_champ]+'"'+":"+'"'+valeur_saisie+'"';virgule=i===liste_champs_saisie.length-1?"":",";saisie=saisie+virgule}saisie=saisie+"}";return saisie}function formulaire_rempli(nom_formulaire){return!Array.from($("#"+nom_formulaire)[0].children).some(function(valeur,index,array){est_actif=!$(".donnee[id='"+valeur.id+"']")[0].disabled;est_vide=$(".donnee[id='"+valeur.id+"']")[0].value==="";return est_actif&&est_vide})}function formulaire_rempli_ok(nom_formulaire){return!Array.from($("#"+nom_formulaire)[0].children).some(function(valeur,index,array){est_actif=!$("[name='"+valeur.name+"']")[0].disabled;est_vide=$("[name='"+valeur.name+"']")[0].value==="";return est_actif&&est_vide})}function vider_les_input(){Array.from($(".donnee.donnee")).forEach(e=>e.value="")}function afficher_bulletins(oui){if(element_DOM("bulletin"))element_DOM("bulletin").style.display=oui?"":"none"}function supprimer_bulle_bulletins(){if($("#bulletin")[0])$("#bulletin")[0].parentNode.remove();masquer_les_bulletins()}function masquer_les_bulletins(){$("#titre_drive_bulletins")[0].style.display="none";$("#drive_bulletins")[0].style.display="none"}function clic_bulletin(){chargement(true);if(recuperer("mon_type").includes("Administration")){if(recuperer("dossier_charg√©")&&$("#accueil_utilisateur")[0].innerText.includes("Vie de classe")){afficher_ou_non_choix_fichier(true);mode_bulletin(true)}else{alert("Merci d'ouvrir un dossier Vie de classe avant de publier un bulletin.")}chargement(false)}else if(recuperer("mon_type").includes("Eleves")){choisir_periode_bulletin();chargement(false)}else{choisir_periode_et_classe_bulletin();chargement(false)}}function choisir_periode_et_classe_bulletin(){var mes_classes=valeursUniquesDeCetteKey(JSON.parse(recuperer("mes_matieres")),"Classe");var option_classes="";mes_classes.forEach(function(valeur,index_classe){option_classes+='<option value="'+valeur+'">'+valeur+"</option>"});var elements_html=`<div><label for="periode_bulletin"><select style="width: 60%;" id="periode_bulletin" name="periode_bulletin"><option value="PREMIER TRIMESTRE">PREMIER TRIMESTRE</option><option value="DEUXIEME TRIMESTRE">DEUXIEME TRIMESTRE</option><option value="TROISIEME TRIMESTRE">TROISIEME TRIMESTRE</option><option value="ANNUEL">ANNUEL</option></select></label>
		<label for="la_classe"><select style="width: 60%;" id="la_classe_bulletin" name="la_classe">`+option_classes+`</select></label></div>`;creer_mini_popup("Choisissez la p√©riode et la classe du bulletin √† consulter:",elements_html,"Consulter","consulter_bulletin_de_la_classe()")}function id_vie_de_classe(id_classe){url=racine_data+"Matieres?Classe=eq."+id_classe+"&Matiere=eq.Vie de classe"+"&"+apikey;resultat=get_resultat(url);if(resultat)resultat=resultat[0]["ID_URL"];return resultat}function consulter_bulletin_de_la_classe(){chargement(true);periode_bulletin=$("#periode_bulletin")[0].value;nom_classe=$("#la_classe_bulletin")[0].value;id_classe=id_vie_de_classe(nom_classe);url=racine_data+"Fichiers?categorie_fichier=eq.Bulletins&periode_bulletin=eq."+periode_bulletin+"&id_dossier=eq."+id_classe+"&"+apikey;resultat_bulletins=get_resultat(url);if(resultat_bulletins.length===0){alert("Aucun bulletin disponible sur la p√©riode '"+periode_bulletin.toLowerCase()+"' pour la classe de '"+nom_classe+"' pour l'instant.");chargement(false)}else{resultat_bulletins=resultat_bulletins[0];console.log(resultat_bulletins);visualiser(resultat_bulletins["nom_fichier"],resultat_bulletins["id_fichier"],"","",true);$("#mini_popup").remove();chargement(false)}return"Consultation termin√©e.";chargement(false)}function choisir_periode_bulletin(){var elements_html='<label for="periode_bulletin"><select style="width: 60%;" id="periode_bulletin" name="periode_bulletin"><option value="PREMIER TRIMESTRE">PREMIER TRIMESTRE</option><option value="DEUXIEME TRIMESTRE">DEUXIEME TRIMESTRE</option><option value="TROISIEME TRIMESTRE">TROISIEME TRIMESTRE</option><option value="ANNUEL">ANNUEL</option></select></label>';creer_mini_popup("Choisissez la p√©riode du bulletin √† consulter:",elements_html,"Consulter","consulter()")}function consulter(){chargement(true);consulter_mon_bulletin(recuperer("identifiant_courant"));chargement(false)}function choisir_clic_bulletin(){popup_choix='<div id="mini_popup"><div id="entete-fenetre" style="display: inline-flex;float: right;"><img alt="X" src="'+prefixe_image+'/quitter.png" id="bye_prev" onclick="$(\'#mini_popup\').remove()" style="width: 30px; height: 30px;cursor:pointer;position:fixed;z-index:3;transform: translate(-50%, -50%);"> </div><div>Que voulez-vous faire?</div><select style="width: 80%;" id="choix_bulletin"><option value="upload">Mettre en ligne les bulletins</option><option value="voir">Voir les bulletins en ligne</option></select><button type="button" class="rendre" onclick="choix_bulletin_ok()">Valider</button></div>';$("body").append(popup_choix)}function choix_bulletin_ok(){if($("#choix_bulletin")[0].value==="upload"){afficher_ou_non_choix_fichier(true);mode_bulletin(true)}else if($("#choix_bulletin")[0].value==="voir"){consulter_mon_bulletin()}$("#mini_popup").remove()}function consulter_mon_bulletin(identifiant_eleve){motif='*"'+identifiant_eleve+'"*';if(!identifiant_eleve)motif="*";periode_bulletin=$("#periode_bulletin")[0].value;url=racine_data+"Fichiers?categorie_fichier=eq.Bulletins&periode_bulletin=eq."+periode_bulletin+"&destinataire_par_page=like."+motif+"&"+apikey;resultat_bulletins=get_resultat(url);if(resultat_bulletins.length===0){alert("Aucun bulletin disponible √† votre nom sur la p√©riode '"+periode_bulletin.toLowerCase()+"' pour l'instant.");chargement(false)}else{for(numero_bulletin=0;numero_bulletin<resultat_bulletins.length;numero_bulletin++){id_fichier_bulletin=resultat_bulletins[numero_bulletin]["id_fichier"];mon_numero_page=Number(JSON.parse(resultat_bulletins[numero_bulletin]["destinataire_par_page"])[identifiant_eleve]);if(identifiant_eleve){afficher_mon_bulletin(id_fichier_bulletin,mon_numero_page,identifiant_eleve)}else{afficher_mon_bulletin(id_fichier_bulletin,1)}}$("#mini_popup").remove()}return"Consultation termin√©e."}function mode_bulletin(oui){if(oui){$("#categorie_choisie")[0].value="Bulletins";element_DOM("categorie_choisie").disabled=true;element_DOM("choix_youtube").style.display="none";element_DOM("choix_extrait_manuel").style.display="none";element_DOM("choix_date_effet").style.display="none";element_DOM("telechargeable").style.display="none";element_DOM("est_telechargeable").checked=false;element_DOM("file").setAttribute("accept","application/pdf");element_DOM("choix_popup").setAttribute("style","visibility: visible;overflow-y: scroll;width: 450px;max-width: 95%;overflow-x: hidden;");element_DOM("file").value="";$("[value='Bulletins']")[0].style.display=""}else{$("#attribution").remove();$("#trimestre").remove();element_DOM("categorie_choisie").disabled=false;element_DOM("choix_youtube").style.display="";element_DOM("choix_extrait_manuel").style.display="";element_DOM("choix_date_effet").style.display="";element_DOM("telechargeable").style.display="";element_DOM("est_telechargeable").checked=true;element_DOM("file").setAttribute("accept",".txt,.bmp,.gif,.jpeg,.jpg,.png,.png,.pdf,.bmp,.xlsx,.xls,.xlsm,.ppt,.pptx,.doc,.docx,.html,.csv,.js,.rtf,.mp4,.mp3,.wav");element_DOM("choix_popup").setAttribute("style","visibility: visible");$("[value='Bulletins']")[0].style.display="none";$("#categorie_choisie > [value='Manuels']")[0].style.display=!recuperer("mon_type").includes("Administration")?"none":""}}function afficher_mon_bulletin(id_fichier,numero_page,identifiant_eleve){var url="https://www.googleapis.com/drive/v2/files/"+id_fichier+"?key="+google_api_file_access+"&alt=media&source=downloadUrl";PDFJS.getDocument(url).then(function(pdf){visualiser("nom_fichier","","","Bulletin "+identifiant_eleve||" ",true,true);pdf.getPage(numero_page).then(function recuperer_page_utile(page){var scale=2.5;var viewport=page.getViewport(scale);var canvas=document.getElementById("vizcanva");var context=canvas.getContext("2d");canvas.height=viewport.height;canvas.width=viewport.width;$("#vizcanva").on("contextmenu",function(e){return false});var task=page.render({canvasContext:context,viewport:viewport});task.promise.then(function(){element_DOM("previsualisation").setAttribute("style","overflow: scroll;height:60%");chargement(false)})["catch"](e=>console.error(e))})})}function mon_ecolage_est_ok(){if(recuperer("mon_type").includes("Eleves")){identifiant_eleve=recuperer("identifiant_courant");url=racine_data+"Eleves"+"?Identifiant=eq."+identifiant_eleve+"&"+apikey;try{return get_resultat(url)[0]["Ecolage_OK"]==="oui"}catch(e){return false}}else{return true}}function telecharger_canvas(){mon_ecolage_ok=mon_ecolage_est_ok();if(mon_ecolage_ok){var link=document.createElement("a");link.download="Bulletin-"+identifiant_eleve+".png";link.href=document.getElementById("vizcanva").toDataURL();link.click();link.remove()}else{alert("Vous devez r√©gulariser vos frais de scolarit√© pour acc√©der √† votre bulletin complet.")}}a_stocker=recuperer("a_stocker")?JSON.parse(recuperer("a_stocker")):{};function plateforme_prete(){return get_resultat(racine_initiale+"/Etablissements?nom_etablissement=eq."+nom_etablissement+"&"+api_initial)[0]["plateforme_prete"]}function initialisation_de_la_plateforme(){vider_fenetre(progression_initialisation());$("#bye_prev").remove();$("#barre_verticale").remove();$("#mynavbar").remove();$("#span_date_effet").remove();afficher_fenetre(true);contenu="Bonjour <span style='font-weight: bold;color: #FF6C00;'> "+recuperer("identifiant_courant").toUpperCase()+"</span>, et bienvenue sur la plateforme de t√©l√©-enseignement Sekooly!<br><br>";contenu+="Pour mettre en route la plateforme de l'√©tablissement <b>"+nom_etablissement.toUpperCase()+"</b>, nous aurons besoin de quelques informations suppl√©mentaires.<br><br><rouge>Toutes les informations que vous allez saisir seront modifiables plus tard.</rouge><br>";bouton="<button onclick='suivant()' id='bouton_suivant' class='mon_bouton' style='height: 50px;font-size: inherit;'>C'est parti!</button>";conteneur_texte_html='<div class="init" style="overflow: hidden auto;height: 90%;padding: 2%;text-align: center;font-size: 150%;"><div id="contenu_etape">'+contenu+"</div>"+bouton+"</div>";conteneur_texte=document.createElement("div");conteneur_texte.innerHTML=conteneur_texte_html;$("#fenetre")[0].appendChild(conteneur_texte.firstChild);if(numero_etape>0){suivant()}else{chargement(false)}}function suivant(){if(enregistrer_la_saisie()){numero_etape=numero_etape+1;if(numero_etape<nb_etapes){resultat=get_resultat(racine_initiale+"Etapes?id=eq."+numero_etape+"&"+api_initial)[0];changer_contenu_etape(resultat["contenu_etape"]);changer_texte_bouton(resultat["bouton_suivant"]);$("#titre_fenetre")[0].innerHTML=progression_initialisation()}else{chargement(true);changer_contenu_etape("Merci de patienter sans actualiser l'onglet, nous cr√©ons vos donn√©es!");$("#bouton_suivant").remove();$("#titre_fenetre")[0].innerHTML=progression_initialisation();proceder_a_linitialisation()}}else{alert("Vous devez saisir l'information pour continuer.")}chargement(false)}function proceder_a_linitialisation(){a_stocker=JSON.parse(recuperer("a_stocker"));var nouveau_data={Role:a_stocker["Role"],Telephone:a_stocker["Telephone"],Cycle:a_stocker["Cycle"],Classe:"(Tous|"+a_stocker["Cycle"]+")"};url=racine_data+"Administration?Identifiant=eq."+recuperer("identifiant_courant")+"&"+apikey;patch_resultat_asynchrone(url,nouveau_data);chargement(true);var nouveau_data={Cycle:a_stocker["Cycle"],Classe:"(Tous|"+a_stocker["Cycle"]+")"};url=racine_data+"Administration?Identifiant=eq.admin&"+apikey;patch_resultat_asynchrone(url,nouveau_data);chargement(true);nouvelle_classe={Classe:a_stocker["Classe"],Cycle:a_stocker["Cycle"],cycle:a_stocker["Cycle"]};try{creer_formulaire_ajout_donnee_html("Classes",recuperer_entetes_params("Classes"),false,nouvelle_classe);$("#mini_popup")[0].style.display="none";ajouter_donnees_saisies("Classes",true)}catch(error){console.error(error);alert(error)}chargement(true);nouvelle_matiere={Classe:a_stocker["Classe"],Cycle:a_stocker["Cycle"],cycle:a_stocker["Cycle"],Matiere:a_stocker["Matiere"],coefficient_matiere:a_stocker["coefficient_matiere"],Couleur_matiere:"noir",commun_au_cycle:"non"};try{creer_formulaire_ajout_donnee_html("Matieres",recuperer_entetes_params("Matieres"),false,nouvelle_matiere);$("#mini_popup")[0].style.display="none";ajouter_donnees_saisies("Matieres",true)}catch(error){console.error(error);alert(error)}chargement(true);nouveau_prof={Nom:a_stocker["Nom_prof"],"Pr√©nom(s)":a_stocker["Pr√©noms_prof"],Identifiant:a_stocker["Nom_prof"].trim().toLowerCase()+"."+a_stocker["Pr√©noms_prof"].trim().toLowerCase(),Code:"123456",Cycle:a_stocker["Cycle"],Classe:"("+a_stocker["Classe"]+"|"+a_stocker["Matiere"]+")",Nom_complet:a_stocker["Nom_prof"]+" "+a_stocker["Pr√©noms_prof"]};ajouter_un_element("Profs",nouveau_prof);chargement(true);nouveau_eleve={Nom:a_stocker["Nom"],"Pr√©nom(s)":a_stocker["Pr√©nom(s)"],Identifiant:a_stocker["Nom"].trim().toLowerCase()+"."+a_stocker["Pr√©nom(s)"].trim().toLowerCase(),Code:a_stocker["Code"],Cycle:a_stocker["Cycle"],Classe:a_stocker["Classe"]};ajouter_un_element("Eleves",nouveau_eleve);chargement(true);rechercher("Matieres","Cycle",a_stocker["Cycle"]).then(e=>{stocker("mes_matieres",JSON.stringify(e))});rechercher("Administration","Identifiant",recuperer("identifiant_courant")).then(e=>{stocker("mes_donnees",JSON.stringify(e[0]))});nouveau_data={plateforme_prete:true,date_premier_abonnement:moment().format("DD/MM/YYYY")};patch_resultat_asynchrone(racine_initiale+"Etablissements?nom_etablissement=eq."+nom_etablissement+"&"+api_initial,nouveau_data).then(function(data){console.log(data);var msg_alerte=element_DOM("snackbar");msg_alerte.innerText="Votre plateforme est pr√™te.";msg_alerte.className="show";setTimeout(function(){msg_alerte.className="";window.location.href=window.location.href},3e3)})}function enregistrer_la_saisie(){if(numero_etape>0){tout_est_ok=$("#contenu_etape :input")[0]?$("#contenu_etape :input")[0].value.trim()!=="":true;if(tout_est_ok&&$("#contenu_etape :input")[0]){for(i=0;i<$("#contenu_etape :input").length;i++){id=$("#contenu_etape :input")[i].id;a_stocker[id]=$("#contenu_etape :input")[i].value.trim()}stocker("a_stocker",JSON.stringify(a_stocker));stocker("numero_etape",numero_etape)}}else{tout_est_ok=true}return tout_est_ok}function progression_initialisation(){reinit_init=numero_etape>0?'<img id="reset_param" onclick="reinitialiser_init()" alt="Recommencer" src="'+prefixe_image+'/img_reset.png" class="icone_param">':"";return'Bienvenue sur Sekooly <i><progress style="width: 60px;" value="'+numero_etape+'" max="'+nb_etapes+'"></progress>'+numero_etape+"/"+nb_etapes+"</i>"+reinit_init}function changer_contenu_etape(nouveau_texte){$("#contenu_etape")[0].innerHTML=nouveau_texte}function changer_texte_bouton(nouveau_texte){$("#bouton_suivant")[0].innerText=nouveau_texte}function reinitialiser_init(){confirmation=confirm("√ätes-vous s√ªr de r√©initialiser toutes vos saisies et de revenir √† l'√©tape 0 ?");if(confirmation){effacer("numero_etape");effacer("a_stocker");window.location.href=window.location.href}}function rendre_riche(id_text_area,agrandir_zone){ClassicEditor.create(document.querySelector('[id="'+id_text_area+'"]'),config_editor()).then(editor=>{if(agrandir_zone){}})["catch"](error=>{console.error(error)})}function recuperer_html_saisie_riche(){return $("[contenteditable]")[0].innerHTML}function switch_side_bar(){ouvert=$(".sidebar.left")[0].isOpen;if(ouvert){fermer_side_bar()}else{ouvrir_side_bar()}}function switch_side_bar_top(){ouvert=$(".sidebar.top")[0].isOpen;if(ouvert){fermer_side_bar()}else{ouvrir_side_bar_top()}}function ouvrir_side_bar(){$(".sidebar.left")[0].style.display="block";$(".sidebar.left")[0].isOpen=true;$(".sidebar.left").trigger("sidebar:open")}function ouvrir_side_bar_top(){$(".sidebar.top")[0].style.display="block";$(".sidebar.top")[0].isOpen=true;$(".sidebar.top").trigger("sidebar:open")}function fermer_side_bar(){$(".sidebar.left")[0].style.display="none";$(".sidebar.left")[0].isOpen=false;$(".sidebar.left").trigger("sidebar:close");$(".sidebar.top")[0].style.display="none";$(".sidebar.top")[0].isOpen=false;$(".sidebar.top").trigger("sidebar:close")}function fermer_si_non_recherche(e){if(e.target.id!=="rechercher")fermer_side_bar()}function en_cours(){alert("Cette fonctionnalit√© est en cours de mise en place, merci de votre patience.")}function edt(){mon_type=recuperer("mon_type");if(mon_type==="Eleves"){recuperer_edt()}else{if(recuperer("dossier_charg√©")||mon_type.includes("bis")){recuperer_edt()}else{choix_classe_edt()}}}function choix_classe_edt(){les_matieres=JSON.parse(recuperer("mes_matieres"));les_classes=valeursUniquesDeCetteKey(les_matieres,"Classe");les_classes.sort();elements_html="Classe:<select id='classe_edt'>";for(i=0;i<les_classes.length;i++){elements_html+='<option value="'+les_classes[i]+'">'+les_classes[i]+"</option>"}elements_html+="</select>";creer_mini_popup("Choisissez la classe √† consulter",elements_html,"Voir l'emploi du temps","voir_edt_classe_choisie()");var mes_droits=JSON.parse(recuperer("mes_donnees"))["Droits_modifs"];if(recuperer("mon_type").includes("Admin")&&mes_droits==="oui"){$("#ask_edt").remove();$("#mini_popup").append('<div id="ask_edt">'+bouton_demander()+"</div></div>")}}function bouton_demander(){return data_etablissement["edt_envoi_mail"]?edt_deja_envoye():'<button id="bouton_ask_edt" onclick="demander_edt()" class="demander_edt">Demander l\'√©dition des emplois du temps</button>'}async function demander_edt(){if(!data_etablissement["edt_envoi_mail"]){var liste_initiale=await rechercher_tout("Classes");liste_classes=liste_initiale.map(e=>e["cycle"]+" "+e["Classe"]);liste_id_calendar=liste_initiale.map(e=>e["id_googlecalendar"]);var url=await chercher_lien_script(1);url+="?ask_edt=true";url+="&nom_prenom_responsable="+data_etablissement["identite_responsable"];url+="&liste_classes="+JSON.stringify(liste_classes);url+="&liste_id_calendar="+JSON.stringify(liste_id_calendar);url+="&contact_etablissement="+data_etablissement["contact_etablissement"];url+="&nom_etablissement="+data_etablissement["nom_etablissement"];envoyer_mail=get_resultat_asynchrone(url);data_etablissement["edt_envoi_mail"]=true;$("#ask_edt")[0].innerHTML=edt_deja_envoye()}else{$("#ask_edt")[0].innerHTML=edt_deja_envoye()}}function edt_deja_envoye(){return"<vert>‚úîLa liste des liens pour √©diter les emplois du temps a √©t√© envoy√©e par mail (<b>"+data_etablissement["contact_etablissement"]+"</b>).</vert><br><br><i>Si vous n'avez plus acc√®s √† cette adresse mail, merci de mettre √† jour l'adresse mail de votre √©tablissement dans <b>Param√®tres > Infos √©tablissement > Contact de l'Administration</b>, puis re-demandez √† nouveau ici votre liste.</i>"}function voir_edt_classe_choisie(){recuperer_edt($("#classe_edt")[0].value);$("#mini_popup")[0].style.zIndex=2}function ma_journee(){vider_fenetre("Ma journ√©e");var je_suis_eleve=recuperer("mon_type")==="Eleves";var sections_a_ajouter=je_suis_eleve?section_journee("Fichiers"):"";var sections_a_ajouter=section_journee("Fichiers","Les fichiers affich√©s ont pour <b>date d'effet</b> (donc de consultation) la date de la journ√©e choisie.");sections_a_ajouter+=section_journee("Devoirs","Les devoirs affich√©s ont pour <b>date limite de rendu</b> la date de la journ√©e choisie.");sections_a_ajouter+=section_journee("Discussions","Les discussions affich√©es ont pour <b>date de publication</b> la date de la journ√©e choisie.");var menu_journee_html='<div id="menu_journee_haut" style="text-align: center;" class="menu_haut">Date de la journ√©e: <input type="date" id="date_journee" class="date_effet_fichier"></div><div class="section_journee">'+sections_a_ajouter+"</div>";$("#menu_journee_haut").remove();$(".section_journee").remove();$("#fenetre").append(menu_journee_html);$("#date_journee").on("change",maj_date_journee);$("#date_journee")[0].value=moment().format("YYYY-MM-DD");maj_date_journee();afficher_fenetre(true)}function section_journee(nom_section,remarque_section){return'<div id="section_'+nom_section+'" class="titre_section_journee bloc_topic"><span style="font-size: x-large;padding: 5px;">'+nom_section+'<div class="subtitle">'+remarque_section+"</div></span></div>"}function maj_date_journee(){if($("#date_journee")[0].value==="")$("#date_journee")[0].value=moment().format("YYYY-MM-DD");chargement(true);$(".alerte_section_journee").remove();$(".contenu_section_journee").remove();mes_matieres=JSON.parse(recuperer("mes_matieres"));if(!recuperer("mon_type").includes("Admin")){les_id_dossier_classe='("'+mes_matieres.map(e=>e["ID_URL"]).join('","')+'")';url=racine_data+"Fichiers?"+apikey;url+="&categorie_fichier=neq.Devoirs";url+="&categorie_fichier=neq.Examens";url+="&date_effet=eq."+$("#date_journee")[0].value;url+="&id_dossier=in."+les_id_dossier_classe}else{url=racine_data+"Fichiers?"+apikey;url+="&categorie_fichier=neq.Devoirs";url+="&categorie_fichier=neq.Examens";url+="&date_effet=eq."+$("#date_journee")[0].value}url+="&order=date_effet.asc,heure_effet.asc,id_dossier.asc";resultats=get_resultat(url);traiter_section(mes_matieres,"Fichiers",resultats,"date_effet","heure_effet","id_dossier","nom_fichier","id_fichier","fichier");if(!recuperer("mon_type").includes("Admin")){les_id_dossier_classe='("'+mes_matieres.map(e=>e["ID_URL"]).join('","')+'")';url=racine_data+"Fichiers?"+apikey;url+='&categorie_fichier=in.("Devoirs","Examens")';url+="&la_date_limite=eq."+$("#date_journee")[0].value;url+="&id_dossier=in."+les_id_dossier_classe}else{url=racine_data+"Fichiers?"+apikey;url+='&categorie_fichier=in.("Devoirs","Examens")';url+="&la_date_limite=eq."+$("#date_journee")[0].value}url+="&order=la_date_limite.asc,lheure_limite.asc,id_dossier.asc";resultats=get_resultat(url);traiter_section(mes_matieres,"Devoirs",resultats,"la_date_limite","lheure_limite","id_dossier","nom_fichier","id_fichier","devoir",true);if(!recuperer("mon_type").includes("Admin")){url=racine_data+"Topic?"+apikey;url+="&Horodateur=like."+$("#date_journee")[0].value+"*";url+="&Id_classe_matiere=in."+les_id_dossier_classe}else{url=racine_data+"Topic?"+apikey;url+="&Horodateur=like."+$("#date_journee")[0].value+"*"}url+="&order=Horodateur.asc";resultats=get_resultat(url);traiter_section(mes_matieres,"Discussions",resultats,"Horodateur","Horodateur","Id_classe_matiere","Titre","Id_topic","discussion",false,true);chargement(false)}function traiter_section(mes_matieres,nom_section,resultats,nom_champ_date_reference,nom_champ_heure_reference,nom_champ_id_classe_matiere,intitul√©_nom_fichier,nom_champ_id_voir,type_notif,est_devoir,date_heure_ensemble){if(resultats.length===0){$("#section_"+nom_section).append(aucun_element_section())}else{$("#section_"+nom_section).innerHTML="";if(recuperer("mon_type").includes("Admin")){resultats=resultats.filter(e=>JSON.stringify(mes_matieres).includes(e[nom_champ_id_classe_matiere]))}for(var numero_fichier=0;numero_fichier<resultats.length;numero_fichier++){id_classe_matiere=resultats[numero_fichier][nom_champ_id_classe_matiere];if(id_classe_matiere!=="pp"){nom_classe=mes_matieres.filter(e=>e["ID_URL"]===id_classe_matiere)[0]["Classe"];nom_matiere=mes_matieres.filter(e=>e["ID_URL"]===id_classe_matiere)[0]["Matiere"];nom_fichier=resultats[numero_fichier][intitul√©_nom_fichier];if(!recuperer("mon_type").includes("Eleves"))nom_matiere=nom_classe+" - "+nom_matiere;date_reference=resultats[numero_fichier][nom_champ_date_reference];heure_reference=resultats[numero_fichier][nom_champ_heure_reference];if(date_reference===heure_reference&&date_reference.length>0){if(!date_heure_ensemble){date_reference=date_reference.split(" ")[0];heure_reference=heure_reference.split(" ")[1].split(".")[0]}}champ_id=resultats[numero_fichier][nom_champ_id_voir];if(est_devoir){deja_rendu=false;deja_corrig√©=false;if(recuperer("mon_type")==="Eleves"){url=racine_data+"Rendus?proprietaire=eq."+recuperer("identifiant_courant").toLowerCase();url+="&id_fichier_sujetdevoir=eq."+champ_id;url+="&"+apikey;deja_rendu=get_resultat(url).length>0}else if(recuperer("mon_type")==="Profs"||recuperer("mon_type").includes("Admin")){url=racine_data+"Rendus?id_fichier_sujetdevoir=eq."+champ_id;url+="&"+apikey;rendus_recus=get_resultat(url);nb_corrig√©s=rendus_recus.filter(e=>e["remarque"]!=="").length;deja_corrig√©=rendus_recus.length>0?'<progress style="width: 60px;" value="'+nb_corrig√©s+'" max="'+rendus_recus.length+'"></progress> <b><rouge>'+nb_corrig√©s+"/"+rendus_recus.length+"</rouge></b>":false}dej√†_trait√©=deja_rendu||deja_corrig√©}else{dej√†_trait√©=false}element_journee=creer_element_journee(nom_matiere,nom_fichier,date_reference,heure_reference,champ_id,id_classe_matiere,type_notif,dej√†_trait√©,est_devoir,date_heure_ensemble);$("#section_"+nom_section).append(element_journee)}}}ordonner_elements(".contenu_section_journee","innerText")}function creer_element_journee(nom_matiere,nom_fichier,date_reference,heure_reference,champ_id,id_classe_matiere,type_notif,dej√†_trait√©,est_devoir,date_heure_ensemble){if(heure_reference){heure_reference=" √† "+heure_reference}else{heure_reference=""}if(recuperer("mon_type").includes("Eleves")){coche_traitement=dej√†_trait√©?'‚úÖ<i style="color: green;">Rendu</i>':est_devoir?"‚ùå<i><rouge>Pas encore rendu</rouge></i>":""}else{coche_traitement=dej√†_trait√©?dej√†_trait√©:""}affichage_date=date_heure_ensemble?afficher_date(date_reference):afficher_date(date_reference,true)+heure_reference;return'<div class="contenu_section_journee"><b class="nom_matiere_journee">'+nom_matiere+"</b> "+nom_fichier+'<i style="color: #bfbfbf;"> '+affichage_date+' </i><span class="mini-image deja_traite">'+coche_traitement+'</span> <img id="'+champ_id+'" src="'+prefixe_image+'/img_previz.png" alt="voir" onclick="clic_de_notif(\''+type_notif+"','"+champ_id+"','"+id_classe_matiere+'\');" class="mini-image"></div>'}function aucun_element_section(){return'<div class="alerte_section_journee">Aucun √©l√©ment n\'a √©t√© trouv√© pour la date choisie.</div>'}function mettre_les_soons(){if($("#soon").length===0){$("[soon]").append(soon())}}function soon(){return'<rouge id="soon">BIENT√îT</rouge>'}function tableau_de_bord(){var aujourdhui=maintenant();vider_fenetre('<span id="titre-tdb">Tableau de bord - '+afficher_date(aujourdhui)+"</span>"+bouton_actualiser("tdb_tout_actualiser()",20));$("#fenetre").append('<div id="previsualisation" style="width: 100%;height: 85%;overflow-y:auto;text-align: center;"></div>');var mon_type=recuperer("mon_type").split("_")[0];elements_tdb=mon_type==="Eleves"?["Pr√©sence sur la plateforme","Devoirs rendus","Participations","Fichiers √† consulter"]:mon_type==="Profs"?["Pr√©sence sur la plateforme","Devoirs corrig√©s","Participations","Fichiers en ligne"]:mon_type.includes("Admin")?["Pr√©sence sur la plateforme","Devoirs rendus et corrig√©s","Participations","Fichiers en ligne"]:[];for(compteur=1;compteur<=elements_tdb.length;compteur++){bouton_voir_details=compteur!==1?bouton_details(compteur):"";$("#previsualisation").append("<span class='element_tdb'><div class='element_tdb_titre'>"+elements_tdb[compteur-1]+bouton_actualiser(fonction_actualiser_du_tdb(compteur,aujourdhui),15)+bouton_voir_details+"</div><div id='tdb-"+compteur+"' class='graphe_tdb'  style='width:99.9%; height:94%;'></div></span>")}tdb_tout_actualiser(aujourdhui);afficher_fenetre(true)}function fonction_actualiser_du_tdb(compteur,aujourdhui){resultat=compteur===1?"tdb_recuperer_mes_connexions(false,'"+aujourdhui+"')":compteur===2?"tdb_recuperer_devoirs(false,'"+aujourdhui+"')":compteur===3?"tdb_recuperer_participations(false,'"+aujourdhui+"')":compteur===4?"tdb_recuperer_fichiers_a_consulter(false,'"+aujourdhui+"')":"";return resultat}function bouton_details(compteur){return'<span style="padding-left: 10px;"><span onclick="details_tdb_'+compteur+'(this)" style="width: 15px; cursor: pointer;" class="voir_tdb">Voir les d√©tails</span></span>'}function bouton_actualiser(nom_fonction_actualisation,taille_bouton_px){return'<span style="padding-left: 10px;"><img alt="actualiser" src="'+prefixe_image+'/img_actualiser.png" onclick="'+nom_fonction_actualisation+'" style="width: '+taille_bouton_px+'px; cursor: pointer;"></span>'}function tdb_tout_actualiser(){chargement(true);$("#titre-tdb")[0].innerText="Tableau de bord - "+afficher_date(maintenant());aujourdhui=maintenant();tdb_recuperer_mes_connexions(true,aujourdhui);tdb_recuperer_devoirs(true,aujourdhui);tdb_recuperer_participations(true,aujourdhui);tdb_recuperer_fichiers_a_consulter(true,aujourdhui);chargement(false)}function tdb_recuperer_mes_connexions(ne_pas_arreter_chargement,aujourdhui){const el=document.getElementById("tdb-1");el.innerHTML="";var premier_mot_statut=["Connexion","Deconnexion","Code","La","Frais"];var legende=["Connexion","Deconnexion","Code erron√©","Maintenance","Frais non pay√©s"];var series_statuts=[];var url=racine_data+"Logs?Identifiant=eq."+recuperer("identifiant_courant")+"&"+apikey;var mes_connexions=get_resultat(url);les_12_mois=les_12_derniers_mois_en_intervalles_semaines(aujourdhui);var legende_x=les_12_mois.map(e=>"semaine du "+e.split(" ")[0]);premier_mot_statut.forEach(function(valeur_statut,index_statut){les_12_mois.forEach(function(valeur,index){debut=moment(valeur.split(" ")[0]);fin=moment(valeur.split(" ")[1]);logs_avec_ce_statut=mes_connexions.filter(e=>e["Statut"].split(" ")[0]===valeur_statut&&moment(e["Horodateur"]).isBetween(debut,fin,"day","(]"));series_statuts.push({[valeur_statut]:{[valeur]:logs_avec_ce_statut.length}})})});mes_series_finales=[];premier_mot_statut.forEach(function(valeur_statut,index_statut){mes_series_finales.push({name:legende[index_statut],data:series_statuts.filter(e=>e[valeur_statut]).map(e=>e[valeur_statut]).map(e=>Object.values(e)[0]),spline:true})});creer_chart(1,mes_series_finales,legende_x,"Evolution des tentatives de connexions");return mes_series_finales;if(!ne_pas_arreter_chargement)chargement(false)}function tdb_recuperer_devoirs(ne_pas_arreter_chargement,aujourdhui){document.getElementById("tdb-2").innerHTML="";mes_matieres=JSON.parse(recuperer("mes_matieres"));les_id_dossier_classe='("'+mes_matieres.map(e=>e["ID_URL"]).join('","')+'")';if(!recuperer("mon_type").includes("Admin")){url=racine_data+"Fichiers?"+apikey;url+="&categorie_fichier=in.(Devoirs,Examens,Quiz)";url+="&id_dossier=in."+les_id_dossier_classe}else{url=racine_data+"Fichiers?"+apikey;url+="&categorie_fichier=in.(Devoirs,Examens,Quiz)"}url+="&order=date_effet.asc,heure_effet.asc,id_dossier.asc";mes_devoirs_a_faire=get_resultat(url);mes_devoirs_a_faire=mes_devoirs_a_faire.filter(e=>les_id_dossier_classe.includes(e["id_dossier"]));mon_type=recuperer("mon_type");le_proprietaire=mon_type.includes("Admin")||mon_type.includes("Prof")?"":"proprietaire=eq."+recuperer("identifiant_courant");le_titre_moyen=mon_type.includes("Admin")||mon_type.includes("Prof")?"moyen":"";details_rendus=mon_type.includes("Admin")||mon_type.includes("Prof")?"":mes_devoirs_rendus.length+" devoirs rendus sur "+mes_devoirs_a_faire.length;url=racine_data+"Rendus?"+le_proprietaire+"&"+apikey;mes_devoirs_rendus=get_resultat(url);mes_devoirs_rendus=mes_devoirs_rendus.filter(function(valeur){return les_id_dossier_classe.includes(valeur["id_dossier_sujetdevoir"])&&valeur["date_publication"]!==null});var taux_rendu=0;if(mon_type.includes("Eleves")){taux_rendu=100*mes_devoirs_rendus.length/mes_devoirs_a_faire.length}else{var mes_matieres=JSON.parse(recuperer("mes_matieres"));var mes_classes=valeursUniquesDeCetteKey(mes_matieres,"Classe");var mon_cycle=JSON.parse(recuperer("mes_donnees"))["Cycle"];var url=racine_data+"Eleves?Cycle=eq."+mon_cycle+"&"+apikey;tous_les_eleves_de_mon_cycle=get_resultat(url);var nb_eleves=tous_les_eleves_de_mon_cycle.length;nb_total_rendus_attendus=0;var liste_taux=[];mes_devoirs_a_faire.forEach(function(le_devoir,index_devoir){nom_classe_du_devoir=mes_matieres.find(e=>e["ID_URL"]===le_devoir["id_dossier"])["Classe"];nb_eleves=tous_les_eleves_de_mon_cycle.filter(e=>e["Classe"]===nom_classe_du_devoir).length;nb_rendus_ce_devoir=mes_devoirs_rendus.filter(e=>e["id_fichier_sujetdevoir"]===le_devoir["id_fichier"]).length;taux_actuel=100*nb_rendus_ce_devoir/nb_eleves;if(!taux_actuel)taux_actuel=0;nb_total_rendus_attendus+=nb_eleves;liste_taux.push(taux_actuel)});taux_rendu=liste_taux.length>0?liste_taux.reduce((a,b)=>a+b)/liste_taux.length:0;details_rendus=mes_devoirs_rendus.length+" rendus sur "+nb_total_rendus_attendus+" attendus"}mes_series=[{name:"Taux de rendu",data:[taux_rendu]}];creer_chart(2,mes_series,null,"Taux de rendu "+le_titre_moyen+" ("+parseFloat(taux_rendu.toFixed(2))+"%) "+details_rendus);if(!ne_pas_arreter_chargement)chargement(false)}function details_tdb_2(ceci){elements_html="";var titre_mini_popup="";mes_devoirs_a_faire.forEach(function(le_devoir,index){if(recuperer("mon_type")==="Eleves"){dej√†_trait√©=mes_devoirs_rendus.filter(e=>e["id_fichier_sujetdevoir"]===le_devoir["id_fichier"]).length>0;nom_classe_du_devoir="";titre_mini_popup="Devoirs √† faire"}else{nb_corrig√©s=mes_devoirs_rendus.filter(e=>e["id_fichier_sujetdevoir"]===le_devoir["id_fichier"]&&e["remarque"]).length;nb_rendus=mes_devoirs_rendus.filter(e=>e["id_fichier_sujetdevoir"]===le_devoir["id_fichier"]).length;mes_matieres=JSON.parse(recuperer("mes_matieres"));nom_classe_du_devoir=mes_matieres.find(e=>e["ID_URL"]===le_devoir["id_dossier"])["Classe"]+" ";nb_eleves=tous_les_eleves_de_mon_cycle.filter(e=>e["Classe"]===nom_classe_du_devoir.trim()).length;dej√†_trait√©=mes_devoirs_rendus.length>0?'<progress style="width: 60px;" value="'+nb_corrig√©s+'" max="'+nb_rendus+'"></progress> <b><rouge>'+nb_corrig√©s+" corrig√©s sur "+nb_rendus+" rendus, sur "+nb_eleves+" √©l√®ves</rouge></b>":false;nom_classe_du_devoir=nom_classe_du_devoir+" ";titre_mini_popup="Devoirs √† faire et corriger"}nom_matiere=nom_classe_du_devoir+JSON.parse(recuperer("mes_matieres")).filter(e=>e["ID_URL"]===le_devoir["id_dossier"])[0]["Matiere"];elements_html=elements_html+creer_element_journee(nom_matiere,le_devoir["nom_fichier"],le_devoir["la_date_limite"],le_devoir["lheure_limite"],le_devoir["id_fichier"],le_devoir["id_dossier"],"devoir",dej√†_trait√©,true)});if(!titre_mini_popup)titre_mini_popup="Devoirs √† faire";creer_mini_popup(titre_mini_popup,elements_html,"    OK    ","$('#mini_popup').remove();",null,null,null,null,25);$("#mini_popup")[0].style.overflow="auto"}function tdb_recuperer_participations(ne_pas_arreter_chargement,aujourdhui){document.getElementById("tdb-3").innerHTML="";url=racine_data+"Topic?Identifiant=eq."+recuperer("identifiant_courant")+"&"+apikey;mes_discussions=get_resultat(url);url=racine_data+"Coms?Identifiant=eq."+recuperer("identifiant_courant")+"&"+apikey;mes_coms=get_resultat(url);url=racine_data+"Visio?Statut=eq.debut&Identifiant=eq."+recuperer("identifiant_courant")+"&"+apikey;mes_visios=get_resultat(url);var mon_axe_x=["Discussions cr√©√©es","Commentaires envoy√©es","Clics sur visioconf√©rence"];var mes_series=[{name:"Nombre total",data:[mes_discussions.length,mes_coms.length,mes_visios.length]}];creer_chart(3,mes_series,mon_axe_x,"Total des int√©ractions");if(!ne_pas_arreter_chargement)chargement(false)}function details_tdb_3(ceci){var elements_html="";var mes_matieres=JSON.parse(recuperer("mes_matieres"));elements_html+='<br><br><b><div style="background: #bf8a6a;"> MES DISCUSSIONS </div></b><br>';mes_discussions.forEach(function(la_discu,index){la_matiere=mes_matieres.find(e=>e["ID_URL"]===la_discu["Id_classe_matiere"]);nom_matiere=la_matiere?la_matiere["Classe"]+" "+la_matiere["Matiere"]:"Mati√®re inconnue";elements_html+=creer_element_journee(nom_matiere,la_discu["Votre_message"],la_discu["Horodateur"],la_discu["Horodateur"],la_discu["Id_topic"],la_discu["Id_classe_matiere"],"discussion",false,false,true)});elements_html+='<br><br><b><div style="background: #bf8a6a;"> MES COMMENTAIRES </div></b><br>';liste_id_topics="("+mes_coms.map(e=>e["Id_topic"]).join(",")+")";url=racine_data+"Topic?Id_topic=in."+liste_id_topics+"&order=Horodateur.asc"+"&"+apikey;liste_id_classe_matieres_des_coms=get_resultat(url);mes_coms.forEach(function(le_com,index){le_topic_source=liste_id_classe_matieres_des_coms.find(e=>e["Id_topic"]===le_com["Id_topic"]);id_classe_matiere=le_topic_source["Id_classe_matiere"];la_matiere=mes_matieres.find(e=>e["ID_URL"]===id_classe_matiere);nom_matiere=la_matiere?la_matiere["Classe"]+" "+la_matiere["Matiere"]:"Mati√®re inconnue";elements_html+=creer_element_journee(nom_matiere,le_com["Votre_commentaire"],le_com["Horodateur"],le_com["Horodateur"],le_com["Id_topic"],id_classe_matiere,"discussion",false,false,true)});creer_mini_popup("Discussions et commentaires",elements_html,"    OK    ","$('#mini_popup').remove();",null,null,null,null,25);$("#mini_popup")[0].style.overflow="auto"}async function tdb_recuperer_fichiers_a_consulter(ne_pas_arreter_chargement,aujourdhui){document.getElementById("tdb-4").innerHTML="";mes_fichiers=await recuperer_mes_fichiers(true);mes_series=[];categories_de_fichiers=valeursUniquesDeCetteKey(mes_fichiers,"categorie_fichier");categories_de_fichiers.forEach(function(categorie_fichier,index_fichier){part_de_la_categ=mes_fichiers.filter(e=>e["categorie_fichier"]===categorie_fichier).length/mes_fichiers.length;mes_series.push({name:categorie_fichier,data:part_de_la_categ})});creer_chart(4,mes_series,null,"Part des cat√©gories sur "+mes_fichiers.length+" fichiers");if(!ne_pas_arreter_chargement)chargement(false)}function recuperer_mes_fichiers_old(forcing){if(forcing||!recuperer("mes_fichiers")){var mes_matieres=JSON.parse(recuperer("mes_matieres"));var les_id_dossier_classe='("'+mes_matieres.map(e=>e["ID_URL"]).join('","')+'")';if(!recuperer("mon_type").includes("Admin")){url=racine_data+"Fichiers_tout?"+apikey;url+="&id_dossier=in."+les_id_dossier_classe}else{url=racine_data+"Fichiers_tout?"+apikey}url+="&order=date_effet.asc,heure_effet.asc,id_dossier.asc";mes_fichiers=get_resultat(url);mes_fichiers=mes_fichiers.filter(e=>les_id_dossier_classe.includes(e["id_dossier"]));return mes_fichiers}else{return JSON.parse(recuperer("mes_fichiers"))}}async function recuperer_mes_fichiers(forcing){if(forcing||!recuperer("mes_fichiers")){var mes_matieres=JSON.parse(recuperer("mes_matieres"));var les_id_dossier_classe="'"+mes_matieres.map(e=>e["ID_URL"]).join(",")+"'";nom_table='"Fichiers_tout"';url=nom_table;if(!recuperer("mon_type").includes("Admin")){url+="  WHERE "+les_id_dossier_classe+" ~ id_dossier"}return rechercher_tout(url,true).then(function(mes_fichiers){mes_fichiers=mes_fichiers.filter(e=>les_id_dossier_classe.includes(e["id_dossier"]));return mes_fichiers})}else{return JSON.parse(recuperer("mes_fichiers"))}}function details_tdb_4(ceci){var elements_html="";var mes_matieres=JSON.parse(recuperer("mes_matieres"));var mon_type=recuperer("mon_type").split("_")[0];mes_fichiers.forEach(function(le_fichier,index){id_classe_matiere=le_fichier["id_dossier"];nom_classe=mon_type==="Eleves"?"":mes_matieres.filter(e=>e["ID_URL"]===id_classe_matiere)[0]["Classe"]+" ";nom_matiere=mes_matieres.filter(e=>e["ID_URL"]===id_classe_matiere)[0]["Matiere"]+" ("+le_fichier["categorie_fichier"]+")";elements_html+=creer_element_journee(nom_classe+nom_matiere,le_fichier["nom_fichier"],le_fichier["date_effet"],le_fichier["heure_effet"],le_fichier["id_fichier"],id_classe_matiere,"fichier",false,false,false)});creer_mini_popup("Fichiers en ligne",elements_html,"    OK    ","$('#mini_popup').remove();",null,null,null,null,25);$("#mini_popup")[0].style.overflow="auto"}function creer_chart(numero_tdb,mes_series,mon_axe_x,titre_eventuel){const el=document.getElementById("tdb-"+numero_tdb);mes_series_finales=mes_series;if(numero_tdb===1){reduction=reduire_serie(mes_series,mon_axe_x);mon_axe_x=reduction[0];mes_series_finales=reduction[1]}else{mon_axe_x=mon_axe_x;mes_series_finales=mes_series}const data={categories:mon_axe_x,series:mes_series_finales};var options={chart:{width:"auto",height:"auto"}};if(titre_eventuel)options["chart"]["title"]=titre_eventuel;if(numero_tdb===1){options["xAxis"]={pointOnColumn:true,title:{text:"P√©riode"}};options["yAxis"]={title:"Nombre de tentatives de connexions"};const chart=toastui.Chart.areaChart({el:el,data:data,options:options})}else if(numero_tdb===3){options["series"]={dataLabels:{fontFamily:"Arial",fontSize:13,fontWeight:500,color:"#FF6C00",textBubble:{visible:true,arrow:{visible:true}}},stack:{type:"normal"}};const chart=toastui.Chart.barChart({el:el,data:data,options:options})}else if(numero_tdb===4){options["series"]={dataLabels:{visible:true,pieSeriesName:{visible:true}}};const chart=toastui.Chart.pieChart({el:el,data:data,options:options})}else{options["circularAxis"]={scale:{min:0,max:100},title:"%"};options["series"]={angleRange:{start:270,end:90}};options["plot"]={bands:[{range:[0,20],color:"#df5353"},{range:[20,50],color:"#dddf0d"},{range:[50,100],color:"#55bf3b"}]};options["theme"]={plot:{bands:{barWidth:50}}};const chart=toastui.Chart.gaugeChart({el:el,data:data,options:options})}return options}function reduire_serie(mes_series,mon_axe_x){mes_series_finales=mes_series;var sum=(r,a)=>r.map((b,i)=>a[i]+b);somme_series=mes_series.map(e=>e["data"]).reduce(sum);var index_debut=somme_series.findIndex(e=>e)-1;if(index_debut){mon_axe_x=mon_axe_x.slice(index_debut);mes_series.forEach(function(e,index){mes_series_finales[index]["data"]=mes_series[index]["data"].slice(index_debut)})}return[mon_axe_x,mes_series_finales]}function conseils_de_classe(){en_cours()}function remediations(){en_cours()}function langues(){en_cours()}function afficher_choix_extrait_manuel(oui){element_DOM("extrait_manuel").style.display=oui?"":"none"}function les_manuels_de_la_matiere(){resultat="";for(i=0;i<$("#drive_manuels > .span_un_fichier").length;i++){resultat+='<option value="'+$("#drive_manuels > .span_un_fichier")[i].id+'">'+$("#drive_manuels > .span_un_fichier")[i].innerText+"</option>"}return resultat}function afficher_checkbox(nom_div_checkbox,oui){element_DOM(nom_div_checkbox).style.display=oui?"":"none"}function switch_extrait_manuel(){var mode_extrait_manuel=element_DOM("est_extrait_manuel").checked;element_DOM("manuel_choisi").value="";element_DOM("manuel_choisi").innerHTML='<option value="--">--</option>'+les_manuels_de_la_matiere();element_DOM("manuel_choisi").style.display=mode_extrait_manuel?"":"none";afficher_choix_extrait_manuel(mode_extrait_manuel);afficher_checkbox("choix_youtube",!mode_extrait_manuel);afficher_choix_fichier(!mode_extrait_manuel);if(mode_extrait_manuel){$("#manuel_choisi").on("change",function(e){e.preventDefault();if(e.target.value==="--")return true;numeros_pages_str=prompt("Choisissez les num√©ros de pages (s√©par√©s de virgules et SANS ESPACES):","1,2,3");if(!numeros_pages_str){e.target.value="--";element_DOM("file").value="";element_DOM("file").style.display="none";return true}numeros_pages=numeros_pages_str.split(",").map(e=>Number(e));var url="https://www.googleapis.com/drive/v2/files/"+e.target.value+"?key="+google_api_file_access+"&alt=media&source=downloadUrl";var extension=$("#manuel_choisi option:selected").text().split(".").pop();var nom_fichier=$("#manuel_choisi option:selected").text().replace("."+extension," (page "+numeros_pages_str+").png");visualiser("","","",nom_fichier,false,false,true);$("#entete-fenetre")[0].style.display="none";chargement(true);var canvasContainer=document.getElementById("previsualisation");canvasContainer.style["float"]="left";canvasContainer.style.overflow="scroll";canvasContainer.style.textAlign="center";canvasContainer.style.height="80%";canvasContainer.style.maxWidth="100%";render_ces_pages(canvasContainer,url,numeros_pages)});$("#mettre_fichier_en_ligne").on("click",function(e){if(!pre_validation("manuel_choisi")){}else{$("#file").change()}})}else{$("#mettre_fichier_en_ligne").off("click")}}function render_ces_pages(canvasContainer,url,numeros_pages){canvasContainer.innerHTML="";var ma_tache=pdfjsLib.getDocument(url);ma_tache.promise.then(function(pdfDoc){numeros_pages.forEach(function(num){if(num<=pdfDoc._pdfInfo.numPages){pdfDoc.getPage(num).then(function(page){chargement(true);renderPage(canvasContainer,page,num).then(function(){if(num===numeros_pages[numeros_pages.length-1]){$("#choix_pages_pdf").remove();var boutons_valider_ou_annuler='<div id="choix_pages_pdf" style="text-align: center;" class=""><rouge>Voici les pages que vous avez choisies. Voulez-vous valider ou annuler?</rouge><button class="mon_bouton" onclick="annuler_mon_choix()">Annuler</button><button class="mon_bouton" onclick="choisir_ces_pages(\''+numeros_pages.toString()+"')\">Valider</button></div>";$("#fenetre").append(boutons_valider_ou_annuler);chargement(false)}})})}else{alert("Page "+num+" introuvable.")}})})}function choisir_ces_pages(numeros_pages_str){numeros_pages=numeros_pages_str.toString().split(",");mes_cnv=$("canvas");resultat=rendre_canvas_vertical(mes_cnv);image_temporaire=resultat;nom_image_temporaire=$("#titre_fenetre")[0].innerText;$("#nom_fichier_extrait")[0].innerText=$("#titre_fenetre")[0].innerText;$("#file").change();quitter_previsualisation()}function annuler_mon_choix(){$("#manuel_choisi")[0].value="--";quitter_previsualisation()}function rendre_canvas_vertical(liste_cnv){try{somme_des_hauteurs=0;liste_des_canvas_avec_position=[];for(i=0;i<liste_cnv.length;i++){somme_des_hauteurs+=liste_cnv[i].height;valeur_y=i===0?0:liste_cnv[i-1].height*i;liste_des_canvas_avec_position.push({cnv:liste_cnv[i],y:valeur_y})}var newCanvas=document.createElement("canvas"),ctx=newCanvas.getContext("2d"),width=liste_cnv[0].width,height=somme_des_hauteurs;newCanvas.width=width;newCanvas.height=height;liste_des_canvas_avec_position.forEach(function(n){ctx.beginPath();ctx.drawImage(n.cnv,0,n.y,width,n.cnv.height)});return newCanvas.toDataURL()}catch(e){alert("Impossible de choisir les pages.");return false}}function verticalCanvases(cnv1,cnv2,cnv3){var newCanvas=document.createElement("canvas"),ctx=newCanvas.getContext("2d"),width=cnv1.width,height=cnv1.height+cnv2.height+cnv3.height;newCanvas.width=width;newCanvas.height=height;[{cnv:cnv1,y:0},{cnv:cnv2,y:cnv1.height},{cnv:cnv3,y:cnv1.height+cnv2.height}].forEach(function(n){ctx.beginPath();ctx.drawImage(n.cnv,0,n.y,width,n.cnv.height)});return newCanvas.toDataURL()}async function renderPage(canvasContainer,page,num){var scale=1.25;var viewport=page.getViewport({scale:scale});var canvas=document.createElement("canvas");canvas.id=$("#titre_fenetre")[0].innerText+"-"+num;canvasContainer.appendChild(canvas);var context=canvas.getContext("2d");canvas.height=viewport.height;canvas.width=viewport.width;1;var renderContext={canvasContext:context,viewport:viewport};return page.render(renderContext)}function renderPDF(url,options){var options=options||{scale:1};pdfjsLib.disableWorker=true;var ma_tache=pdfjsLib.getDocument(url);ma_tache.promise.then(renderPages)}function canva_scrollable(id_canva){var canvas=document.getElementById(id_canva);var context=canvas.getContext("2d");var dragging=false;var lastX;var marginLeft=0;for(var i=0;i<1e3;i++){context.beginPath();context.arc(Math.random()*1e4,Math.random()*250,20,0,2*Math.PI,false);context.stroke()}canvas.addEventListener("mousedown",function(e){var evt=e||event;dragging=true;lastX=evt.clientX;e.preventDefault()},false);window.addEventListener("mousemove",function(e){var evt=e||event;if(dragging){var delta=evt.clientX-lastX;lastX=evt.clientX;marginLeft+=delta;canvas.style.marginLeft=marginLeft+"px"}e.preventDefault()},false);window.addEventListener("mouseup",function(){dragging=false},false)}let deferredPrompt;const addBtn=$("#a2hs")[0];window.addEventListener("beforeinstallprompt",e=>{e.preventDefault();deferredPrompt=e;addBtn.style.display="block";$("#mynavbar")[0].style.top="20px";$(".alerte#alerte")[0].style.top="95px"});function ajouter_a_laccueil(){$("#a2hs")[0].style.display="none";$("#mynavbar")[0].style.top="";$(".alerte#alerte")[0].style.top="";deferredPrompt.prompt();deferredPrompt.userChoice.then(choiceResult=>{if(choiceResult.outcome==="accepted"){console.log("Accept√©.")}else{console.log("Refus√©.")}deferredPrompt=null})}if("serviceWorker"in navigator){window.addEventListener("load",function(){navigator.serviceWorker.register("../sw.js").then(function(registration){},function(err){console.error("ServiceWorker registration failed: ",err)})})}function lien_pp(id_pp){return id_pp?"https://drive.google.com/uc?export=download&id="+id_pp:prefixe_image+"/default-user.svg"}function recuperer_msgs(forcing,sans_fenetre){chargement(true);if(!sans_fenetre){vider_fenetre("");element_DOM("fenetre").innerHTML+=html_boutons_fenetre("recuperer_msgs(true)","ajouter_un_tout_nouveau_msg()","Pour r√©pondre, cliquez sur le message en question.<br>"+alerte_conv())}else{}if(forcing||recuperer("mes_msgs")===null||recuperer("mes_msgs")===""){nom_table="Conversations";nom_champ_reference="id_conv";valeur_champ_reference="*"+ajouter_motif(recuperer("identifiant_courant"))+"*";nom_champ_a_chercher="";return rechercher_contenant_motif(nom_table,nom_champ_reference,valeur_champ_reference,nom_champ_a_chercher,"Horodateur","desc").then(mes_msgs=>{stocker("mes_msgs",JSON.stringify(mes_msgs));chargement(false);if(!sans_fenetre){return traitement_msgs()}else{return mes_msgs}})["catch"](e=>{console.error(e);alert(e);alert("Impossible de r√©cup√©rer vos messages. V√©rifiez que vous √™tes toujours connect√© √† internet, ou r√©essayer plus tard.");chargement(false);return false})}else{chargement(false);if(!sans_fenetre){return traitement_msgs()}else{return JSON.parse(recuperer("mes_msgs"))}}}function alerte_conv(){return""}function traitement_msgs(){afficher_fenetre(true);if(recuperer("mes_msgs").length===0||recuperer("mes_msgs")==="[]"){commentaire='<div id="vide" style="text-align: center;color: grey;margin: 10%;"> <i id="vide"> Vous n\'avez pas encore de messages priv√©s.<br><br></i> </div>';var mon_commentaire=document.createElement("div");mon_commentaire.innerHTML=commentaire;while(mon_commentaire.firstChild){element_DOM("fenetre").appendChild(mon_commentaire.firstChild)}return commentaire}else{var liste_des_msgs=JSON.parse(recuperer("mes_msgs"));if(!element_DOM("div_liste_msgs")){var ma_liste=document.createElement("div");ma_liste.style.overflowX="hidden";ma_liste.style.overflowY="auto";ma_liste.id="div_liste_msgs";ma_liste.style.height="90%";element_DOM("fenetre").appendChild(ma_liste)}else{var ma_liste=element_DOM("div_liste_msgs")}liste_des_msgs.sort(function tri_ordre_chrono_decroissant(a,b){return convertir_en_date(b.Horodateur)-convertir_en_date(a.Horodateur)});liste_des_msgs.forEach(function(valeur){ajouter_msg(liste_des_msgs,ma_liste,valeur)});return liste_des_msgs}}function ajouter_msg(liste_des_msgs,ma_liste,valeur){var id_topic=valeur["id_conv"];var nb_non_lus=liste_des_msgs.filter(e=>e["id_conv"]===valeur["id_conv"]&&!liste_notifs_lues.includes(","+e["id_msg"]+",")).length;if($("[id='"+id_topic+"']").length>0)return true;var titre=recuperer_destinataire(valeur["id_conv"]);element_contenu=document.createElement("div");element_contenu.innerHTML=valeur["Message"];var contenu=element_contenu.innerText;var horodateur_max=moment.max(liste_des_msgs.filter(e=>e["id_conv"]===valeur["id_conv"]).map(e=>e.Horodateur).map(e=>moment(e))).format("DD/MM/YYY HH:mm");var date=afficher_date(horodateur_max);var nb_coms=liste_des_msgs.filter(e=>e["id_conv"]===valeur["id_conv"]).length;if(nb_coms===undefined)nb_coms=0;var icone_poubelle="";if(!recuperer("mon_type").includes("Administration")&&valeur["Identifiant"]!==recuperer("identifiant_courant").trim())icone_poubelle="";var img_pp=ma_photo(titre.toLowerCase(),true);var span_nb_non_lus=nb_non_lus>0?'<div class="msg_non_lu">'+nb_non_lus+"</div>":"";var dans_fenetre_str='<ul class="bloc_msg" onclick="clic_de_msg(this.id)" id="'+id_topic+'"> '+img_pp+'<span id="details_conv">'+icone_poubelle+' <p id="'+id_topic+'" style="font-size: 25px; margin:0px;"> <b class="contenu_question" id="'+id_topic+'"> '+titre+'  </b> <p id="'+id_topic+'" class="contenu_question"> '+contenu+'</p><i class="petite_ecriture"> <h id="'+id_topic+'"><u id="'+id_topic+'"> Nombre de messages</u>: <u class="nb_com_actuel" id="'+id_topic+'">'+nb_coms+'</u> </h> <h id="'+id_topic+'">  &emsp; <u id="'+id_topic+'"> Dernier message le</u>: '+date+' </h><h id="'+id_topic+'"></h></i></span> '+span_nb_non_lus+" </ul>";var un_msg=document.createElement("div");un_msg.innerHTML+=dans_fenetre_str;while(un_msg.firstChild)ma_liste.appendChild(un_msg.firstChild)}function clic_de_msg(id_conv){chargement(true);stocker("msg_charg√©",id_conv);recuperer_tous_les_msgs(id_conv,false);chargement(false)}function recuperer_tous_les_msgs(id_conv,forcing){var mes_msgs=JSON.parse(recuperer("mes_msgs"));mes_msgs=mes_msgs.sort(function tri_ordre_chrono_decroissant(a,b){return convertir_en_date(a.Horodateur)-convertir_en_date(b.Horodateur)});var nom_destinataire=mes_msgs.find(e=>e["id_conv"].includes(id_conv))["id_conv"];nom_destinataire=recuperer_destinataire(nom_destinataire);try{var src_pp=$("[id='pp_"+nom_destinataire.toLowerCase()+"']")[0].src}catch(e){var src_pp=$("#entete_convo > .retour_msgs")[1].src}var entete_convo='<span id="entete_convo"><img id="<<" class="retour_msgs" src="'+prefixe_image+'/img_retour.png" onclick="recuperer_msgs(true)"> <img class="retour_msgs" src="'+src_pp+'"><div id="Destinataire" class="titre_du_poste">'+nom_destinataire+"</div></span>";$("#div_liste_msgs").remove();vider_fenetre(entete_convo);var emplacement_des_msgs='<div id="emplacement_des_msgs" class="emplacement_des_msgs"></div>';var les_msgs=document.createElement("div");les_msgs.innerHTML=emplacement_des_msgs;element_DOM("fenetre").appendChild(les_msgs.firstChild);mes_msgs=mes_msgs.filter(e=>e["id_conv"]===id_conv);var une_conversation="<div id='conversation' class='conversation'>";mes_msgs.forEach(function(le_msg){msg_html=afficher_msg_conversation(le_msg);une_conversation+=msg_html;jai_lu(le_msg["id_msg"],false)});apres_maj_lecture_notifs();afficher_bulle_notifs();$("#emplacement_des_msgs").append(une_conversation);le_dernier_msg=mes_msgs[mes_msgs.length-1];element_DOM(le_dernier_msg["id_msg"]).scrollIntoView();$("#fenetre").append(zone_envoi(id_conv))}function zone_envoi(id_conv){return'<div id="nouveau_msg_convo"><textarea id="Message" name="Message" placeholder="Ecrivez votre message..."></textarea><button class="bouton_envoi" onclick="envoyer_mon_message(\''+id_conv+'\')"><img alt="Envoyer" class="pp" src="'+prefixe_image+'/img_send.png" style="width: 30px;height: 30px;filter: invert(1);"></button></div>'}function afficher_msg_conversation(le_msg){la_className="un_msg "+(le_msg["Expediteur"]===recuperer("identifiant_courant")?"msg_envoye":"msg_recu");Expediteur=le_msg["Expediteur"]===recuperer("identifiant_courant")?"MOI-M√äME":le_msg["Expediteur"].toUpperCase();return'<div class="'+la_className+'" id="'+le_msg["id_msg"]+'"><div class="auteur_du_poste">'+Expediteur+'</div><h id="contenu_poste"><p data-placeholder="Votre commentaire...">'+le_msg["Message"]+'</p></h><h id="date_poste">'+afficher_date(le_msg["Horodateur"])+"</h></div>"}async function liste_de_mes_destinataires(){var mon_type=recuperer("mon_type").split("_")[0];var liste_eleves=await recuperer_eleves(true);var liste_profs=await recuperer_profs(true);var liste_admins=await recuperer_admin(true);var mes_destinataires=[];mes_destinataires.push(liste_eleves);mes_destinataires.push(liste_profs);mes_destinataires.push(liste_admins);mes_destinataires=[].concat.apply([],mes_destinataires);mes_destinataires=mes_destinataires.map(function(e){le_type=e["type"].includes("Admin")?e["Role"]:e["type"].substring(0,e["type"].length-1);return e["Identifiant"].toUpperCase()+" ("+le_type+")"});stocker("mes_destinataires",mes_destinataires);return mes_destinataires}function ajouter_un_tout_nouveau_msg(){liste_de_mes_destinataires();var probleme=false;if(probleme){alert("Impossible d'envoyer un nouveau message pour le moment.");return-1}if(impossible_de_cliquer())return-1;vider_fenetre("Nouveau message");element_DOM("maquestion").src="";var nouveau_message='<div id="mon_formulaire" autocomplete="off" class="edition"><label id="label" for="Destinataire">Destinataire: </label><div id="div_autocompletion" class="autocompletion"> <input placeholder="Tapez pour chercher le destinataire..." autocomplete="on" onkeyup="validation_par_touche(event)" oninput="faire_autocompletion_input(this,\'Destinataire\')" type="text" name="Destinataire" id="Destinataire" maxlength="50" style="width: 100%;"></div><br><br><label id="label" for="Message">Votre message: </label><textarea id="Message" name="Message" placeholder="Saisissez votre message..." maxlength="1700" style="width: 100%;height: 70%;resize: none;font-size: 13px;"></textarea><div id="nb_max_div" style="margin-left: 90%;margin-top: 0%;font-size: 10px; display:none;"> <font id="nb_max"> 0 / 1700</font> </div><div id="mes_boutons" style="text-align: center;padding: 1%;display: block ruby;"><button class="bouton_sekooly" type="button" id="Annuler" onclick="recuperer_msgs(false)"> Annuler </button><button class="bouton_sekooly" type="button" id="envoi" onclick="envoyer_mon_message()"> Envoyer le message </button></div><div id="msg_erreur" style="text-align: center;padding: 1%;color: green;"> </div></div>';var mon_message=document.createElement("span");mon_message.innerHTML=nouveau_message;element_DOM("fenetre").appendChild(mon_message);$("#div_autocompletion").append('<div id="liste_destinataires"></div>');element_DOM("Destinataire").focus()}function validation_par_touche(e){if(e.keyCode===13)choisir("Destinataire",$("#liste_destinataires")[0].firstChild)}function faire_autocompletion_input(ceci,nom_champ){if(!recuperer("mes_destinataires"))liste_de_mes_destinataires();var mes_destinataires=recuperer("mes_destinataires").split(",");var valeur_du_champ=$("[id='"+nom_champ+"']")[0].value.toUpperCase().replaceAll(" ","");liste_destinataires.innerHTML="";if(valeur_du_champ){mes_destinataires=mes_destinataires.filter(function(e){return e.toUpperCase().replaceAll(" ","").includes(valeur_du_champ)});mes_destinataires.forEach(function(un_destinataire){$("#liste_destinataires").append("<div onclick=\"choisir('"+nom_champ+'\',this)" value="'+un_destinataire+'">'+un_destinataire+"</div>")})}}function choisir(nom_champ,ceci){$("[id='"+nom_champ+"']")[0].value=ceci.getAttribute("value");liste_destinataires.innerHTML="";destinataire=ceci.getAttribute("value").toLowerCase().split(" (")[0];id_conv1=ajouter_motif(destinataire)+ajouter_motif(recuperer("identifiant_courant"));id_conv2=ajouter_motif(recuperer("identifiant_courant"))+ajouter_motif(destinataire);mes_msgs=JSON.parse(recuperer("mes_msgs"));conv_initiale=mes_msgs.find(e=>e["id_conv"]===id_conv1||e["id_conv"]===id_conv2);if(conv_initiale){id_conv=conv_initiale["id_conv"];charger_la_conv(id_conv)}}function charger_la_conv(id_conv){recuperer_msgs(true).then(e=>$("ul[id='"+id_conv+"']").click())}function le_destinataire(){return $("#Destinataire")[0].value||$("#Destinataire")[0].innerText}async function envoyer_mon_message(id_conv){chargement(true);var mode_deja_conv=id_conv?true:false;if(!recuperer("mes_destinataires"))await liste_de_mes_destinataires();mes_destinataires=recuperer("mes_destinataires").split(",");var destinataire=le_destinataire();if(!destinataire||!mes_destinataires.find(e=>e.includes(destinataire))){alert("Votre destinataire n'existe pas, merci de v√©rifier votre saisie.\nIl est possible que la personne ne soit plus inscrite sur la plateforme.");chargement(false);return false}var phrase=$("#Message")[0].value.replaceAll("\n","<br>").trim();if(phrase.length===0){alert("Merci de saisir un message avant de l'envoyer.");chargement(false);return false}var le_mot_interdit=chercher_le_mot_interdit(phrase);if(le_mot_interdit!==""){alert("Vous n'avez pas le droit d'utiliser le terme '"+le_mot_interdit+"' dans le cadre des cours √† "+nom_etablissement+" sur SEKOOLY.");return-1}destinataire=destinataire.split(" (")[0].toLowerCase();id_msg=creer_uuid();var id_conv_vrai=id_conv?id_conv:create_id_conv(destinataire,false);var nouvelle_conversation={Horodateur:maintenant(),Expediteur:recuperer("identifiant_courant"),Destinataire:destinataire,Message:phrase,id_msg:id_msg,id_conv:id_conv_vrai};ajouter_un_element("Conversations",nouvelle_conversation).then(function(e){if(mode_deja_conv){$("#conversation").append(afficher_msg_conversation(nouvelle_conversation));element_DOM(id_msg).scrollIntoView();$("#Message")[0].value="";jai_lu(id_msg,true)}else{charger_la_conv(id_conv_vrai)}chargement(false)})}function supprimer_conversation(ceci){id_convo=ceci.id.split("bye")[1];console.log(id_convo)}function recuperer_programme(){vider_fenetre("Programme scolaire");var mes_matieres=JSON.parse(recuperer("mes_matieres"));var id_matieres=mes_matieres.map(e=>e["ID_URL"]);mes_matieres=mes_matieres.map(e=>e["Classe"]+" "+e["Matiere"]);var liste_matieres="";for(numero_matiere=0;numero_matiere<mes_matieres.length;numero_matiere++){liste_matieres+='<option value="'+id_matieres[numero_matiere]+'">'+mes_matieres[numero_matiere]+"</option>"}var menu_programme='<div id="menu_programme" style="text-align: center;" class="menu_haut">Mati√®re: <select id="ID_URL">'+liste_matieres+"</select> </div>";$("#menu_programme").remove();$("#fenetre").append(menu_programme);$("#ID_URL").on("change",maj_matiere);maj_matiere();afficher_fenetre(true)}function maj_matiere(){chargement(true);var je_suis_eleve=recuperer("mon_type")==="Eleves";var ID_URL=$("#ID_URL")[0].value;le_programme=donnees_programme(ID_URL);$("#programme_scolaire").remove();$(".conteneur_bouton_ajout_chapitre").remove();var programme_scolaire='<div id="programme_scolaire" class="programme_scolaire"></div>';$("#fenetre").append(programme_scolaire);if(!je_suis_eleve){boutons_update_programme=liste_statuts(je_suis_eleve)+bouton_renommer_chapitre()+bouton_supprimer_chapitre();bouton_ajouter_nouveau_chapitre='<div class="conteneur_bouton_ajout_chapitre"><button onclick="ajouter_un_chapitre()" class="bouton_ajout_chapitre">Ajouter un chapitre</button></div>'}else{boutons_update_programme="";bouton_ajouter_nouveau_chapitre=""}if(le_programme.length===0){$("#programme_scolaire").append('<div class="alerte_section_journee">Aucun chapitre n\'a √©t√© trouv√© pour cette mati√®re.</div>')}else{le_programme.forEach(function(un_chapitre){if(je_suis_eleve)boutons_update_programme=liste_statuts(true,un_chapitre["etat"]);date_fin_chapitre=un_chapitre["date_fin"]?'<div class="date_fin">le '+afficher_date(un_chapitre["date_fin"])+"</div>":"";$("#programme_scolaire").append('<div class="un_chapitre" id="'+un_chapitre["id_chapitre"]+'">\x3c!--<span class="titre_chapitre position_chapitre" id="position_chapitre">'+un_chapitre["position_chapitre"]+') </span>--\x3e<span class="titre_chapitre" id="'+un_chapitre["id_chapitre"]+'">'+un_chapitre["intitule_chapitre"]+"</span>"+"<br>"+boutons_update_programme+date_fin_chapitre+"</div>");if(!je_suis_eleve){$("[id='"+un_chapitre["id_chapitre"]+"'] > select").val(un_chapitre["etat"]);actualiser_couleurs($("[id='"+un_chapitre["id_chapitre"]+"'] > select")[0])}});if(!je_suis_eleve){$("#programme_scolaire").sortable({update:function mettre_a_jour_position(){var liste_des_chapitres=[];$(".un_chapitre.ui-sortable-handle").each(function(position_finale,element){nouvelle_position_chapitre_drag=position_finale+1;modifier_chapitre(element.id,"position_chapitre",nouvelle_position_chapitre_drag,false)})}})}}if(bouton_ajouter_nouveau_chapitre){$("#fenetre").append(bouton_ajouter_nouveau_chapitre)}chargement(false);return true}function nouvelle_position_chapitre(){var liste_positions=$(".titre_chapitre.position_chapitre").text().replaceAll(")","").split(" ").map(e=>Number(e));return Math.max.apply(Math,liste_positions)+1}function bouton_renommer_chapitre(){return'<img onclick="renommer_chapitre(this)" src="'+prefixe_image+'/img_edit.png" alt="Renommer" class="editer">'}function bouton_supprimer_chapitre(){return'<img onclick="supprimer_ce_chapitre(this)" src="'+prefixe_image+'/img_trash.png" alt="Supprimer" class="editer">'}function liste_statuts(je_suis_eleve,etat_si_eleve){if(!je_suis_eleve){resultat=`
			<select class="etat_chapitre" onchange="changer_statut_chapitre(this)">
				<option value="Non commenc√©" id="Non commenc√©">Non commenc√©</option>
				<option value="En cours" id="En cours">En cours</option>
				<option value="Termin√©" id="Termin√©">Termin√©</option>
				<option value="Annul√©" id="Annul√©">Annul√©</option>  
			</select>
			`}else{resultat='<span style="background: '+couleur_de_letat(etat_si_eleve)+';" class="etat_chapitre">'+etat_si_eleve+"</span>"}return resultat}function couleur_de_letat(etat){var couleur=etat==="Non commenc√©"?"#848484":etat==="En cours"?"#ffae59":etat==="Termin√©"?"#5d9140":etat==="Annul√©"?"#df756a":"";return couleur}async function ajouter_un_chapitre(){intitule_chapitre=prompt("Indiquez le nom du nouveau chapitre: ");if(!intitule_chapitre)return false;donnees_chapitre={id_chapitre:creer_uuid(),ID_URL:programme_ID_URL_actuel(),Classe_Matiere:programme_classe_matiere_actuel(),intitule_chapitre:intitule_chapitre,position_chapitre:nouvelle_position_chapitre(),etat:"Non commenc√©"};return await ajouter_un_element("Programme",donnees_chapitre).then(function(){maj_matiere();return donnees_chapitre})}function programme_ID_URL_actuel(){return $("#ID_URL")[0].value}function programme_classe_matiere_actuel(){return $("#ID_URL option:selected").text()}function donnees_programme(ID_URL){return get_resultat(racine_data+"Programme?ID_URL=eq."+ID_URL+"&order=position_chapitre.asc&"+apikey)}function renommer_chapitre(ceci){var id_chapitre=le_id_chapitre(ceci);var ancien_nom=$(".titre_chapitre[id='"+id_chapitre+"']")[0].innerText;nouveau_nom=prompt("Indiquez le nouveau nom du chapitre: ",ancien_nom);if(nouveau_nom&&nouveau_nom!==ancien_nom)modifier_chapitre(id_chapitre,"intitule_chapitre",nouveau_nom,maj_matiere)}function changer_statut_chapitre(ceci){actualiser_couleurs(ceci);var id_chapitre=le_id_chapitre(ceci);modifier_chapitre(id_chapitre,"etat",ceci.value);var date_fin=ceci.value==="Termin√©"||ceci.value==="Annul√©"?maintenant():"";modifier_chapitre(id_chapitre,"date_fin",date_fin,maj_matiere)}function actualiser_couleurs(ceci){var la_couleur=couleur_de_letat($("[id='"+ceci.value+"']")[0].value);ceci.style.background=la_couleur}function supprimer_ce_chapitre(ceci){var id_chapitre=le_id_chapitre(ceci);var confirmation=confirm("‚ö†Ô∏èVoulez-vous vraiment supprimer ce chapitre ? Cette action est irr√©versible. ("+id_chapitre+")");if(confirmation){supprimer("Programme","id_chapitre",id_chapitre).then(()=>maj_matiere())}}function le_id_chapitre(ceci){return ceci.parentNode.id}function modifier_chapitre(id_chapitre,champ_du_chapitre,valeur_du_chapitre,callback){var donnees_chapitre={id_chapitre:id_chapitre,[champ_du_chapitre]:valeur_du_chapitre};actualiser("Programme","id_chapitre",id_chapitre,donnees_chapitre).then(()=>callback?callback():"")}function choisir_ce_mode(ceci){if($(".mode_affichage_fichiers")){$(".mode_affichage_fichiers")[0].className="mode_affichage_fichiers";$(".mode_affichage_fichiers")[1].className="mode_affichage_fichiers";var id_mode=ceci.id.replace("par_","");var id_autre_mode=id_autre(id_mode);$("#"+id_mode)[0].style.display="";$("#"+id_autre_mode)[0].style.display="none";ceci.className="mode_affichage_fichiers mode_choisi";masquer_config_mode();stocker("mode_prefere",ceci.id);filtrer_avec_le_bon_filtre(id_mode)}}function filtrer_avec_le_bon_filtre(id_mode){if(id_mode==="la_date_effet"){filtrer_date_effet()}else if(id_mode==="filtre_id_chapitre"){filtrer_chapitre()}}function id_autre(id_actuel){var resultat=id_actuel==="la_date_effet"?"filtre_id_chapitre":"la_date_effet";return resultat}function afficher_config_mode(){if($(".gear-container")[0])$(".gear-container")[0].style.display="block"}function masquer_config_mode(){if($(".gear-container")[0])$(".gear-container")[0].style.display=""}function switch_config_mode(){if($(".gear-container")[0]){deja_visible=$(".gear-container")[0].style.display==="block";if(deja_visible){masquer_config_mode()}else{afficher_config_mode()}}}function creer_chapitre(){recuperer_programme();afficher_fenetre(false);$("select[id='ID_URL']")[0].value=recuperer("dossier_charg√©");ajouter_un_chapitre().then(async function(data){if(data){await chercher_mes_chapitres(true);$("select#id_chapitre")[0].value=data["id_chapitre"]}else{element_DOM("id_chapitre").value="--"}})}function faire_la_recherche_fichier(){var zone_recherche='<input id="rechercher" class="barre_recherche" name="rechercher" placeholder="Rechercher un fichier par mot(s)-cl√©(s)...">';$("#mini_popup").remove();var bouton_aide=help("aide_recherche()");creer_mini_popup(bouton_aide+"<b>Que recherchez-vous?</b>"+zone_recherche,"<div class='liste_resultats' id='liste_resultats'></div>","Rechercher","afficher_resultats_recherche()")}function help(fonction_aide){return'<rouge class="mini-image" onclick="'+fonction_aide+"\">Besoin d'aide?</rouge>"}function aide_recherche(){var contenu_alerte="Un fichier peut √™tre recherch√© par des mots-cl√©s li√©s √† :\n\t‚Ä¢ la mati√®re dans laquelle il est publi√©\n\t‚Ä¢ le nom que l'enseignant lui a donn√©\n\t‚Ä¢ son extension (pdf,png,youtube...)\n\t‚Ä¢ sa cat√©gorie (cours, devoir, ...)\n\t‚Ä¢ l'intitul√© de son chapitre.\nExemple: aucun chapitre";alert(contenu_alerte)}async function afficher_resultats_recherche(){chargement(true);var mot_cle=$("#rechercher")[0].value.trim().toLowerCase().replaceAll(" ","");if(!mot_cle){alert("Merci de d'abord saisir un mot-cl√©.");return false}mes_fichiers=await recuperer_mes_fichiers(true);var mes_fichiers_initiaux=mes_fichiers.filter(e=>e["categorie_fichier"]!=="Profil");var mes_matieres=JSON.parse(recuperer("mes_matieres"));mes_fichiers_intermediaires=mes_fichiers_initiaux.map(e=>Object.assign({},...[e,mes_matieres.find(matiere=>matiere["ID_URL"]===e["id_dossier"])]));var fichiers_trouves=mes_fichiers_intermediaires.filter(function(un_fichier,index){dans_classe_matiere=un_fichier["Classe_Matiere"].toLowerCase().replaceAll(" ","").includes(mot_cle);dans_categorie_fichier=un_fichier["categorie_fichier"].toLowerCase().replaceAll(" ","").includes(mot_cle);dans_nom_fichier=un_fichier["nom_fichier"].toLowerCase().replaceAll(" ","").includes(mot_cle);intitule_chapitre=un_fichier["intitule_chapitre"]===null?"(Aucun chapitre)":un_fichier["intitule_chapitre"];dans_intitule_chapitre=intitule_chapitre.toLowerCase().replaceAll(" ","").includes(mot_cle);return dans_classe_matiere||dans_categorie_fichier||dans_nom_fichier||dans_intitule_chapitre});var liste_des_resultats="";if(fichiers_trouves.length===0){liste_des_resultats='<div class="alerte_section_journee">Aucun r√©sultat trouv√© pour <b>'+mot_cle+"</b>.<br>Merci de r√©essayer.</div>"}else{fichiers_trouves.forEach(function(le_fichier){liste_des_resultats+=creer_element_journee(le_fichier["Classe"]+" "+le_fichier["Matiere"],le_fichier["nom_fichier"],le_fichier["date_effet"],le_fichier["heure_effet"],le_fichier["id_fichier"],le_fichier["ID_URL"],"fichier",false,false,false)})}$("#nb_resultats").remove();$("#liste_resultats")[0].innerHTML="";$("#liste_resultats").append(liste_des_resultats);$("#mini_popup").append('<div id="nb_resultats"><b>'+fichiers_trouves.length+" r√©sultats trouv√©s<b></div>");chargement(false)}async function emettre_avis_sekooly(){var mon_avis=await mon_avis_actuel();var deja_avec_avis=mon_avis.length>0;var nom_bouton=deja_avec_avis?"Modifier mon avis":" Envoyer mon avis ";var fonction_bouton=deja_avec_avis?"fermer_emettre_avis()":"envoyer_avis()";var elements_html=deja_avec_avis?'<div id="avis">'+afficher_avis(mon_avis[0])+"</div>":formulaire_avis();creer_mini_popup("Mon avis sur Sekooly",elements_html,nom_bouton,fonction_bouton,false,false,false,false,25);accepter_cgu_avis()}function avis_good(){return"‚ù§Ô∏èCe que vous aimez le plus"}function avis_bad(){return"üòïCe que vous aimez moins<br>(ou une fonctionnalit√© que vous aimeriez avoir)"}function afficher_avis(mon_avis){return un_element_avis("Note globale",mon_avis["note_globale"],"note_globale")+un_element_avis(avis_good(),mon_avis["commentaire"],"commentaire")+un_element_avis(avis_bad(),mon_avis["ameliorations"],"ameliorations")}function un_element_avis(titre_element,valeur_element,id_element){return'<div><b class="titre_chapitre">'+titre_element+':</b><div class="element_avis" id="'+id_element+'">'+valeur_element+"</div></div>"}function formulaire_avis(){return`<div id="nouvel_avis"><br>		
		<p>Nous serions honor√©s de <span class="titre_chapitre">conna√Ætre en d√©tails</span> ce qui vous pla√Æt! (et m√™me ce qui vous pla√Æt moins üòâ)</p>
		<form onsubmit="event.preventDefault();" id="avis">
			<div>Note globale pour Sekooly (sur 5):`+liste_notes_possibles()+`</div>
			<div>`+avis_good()+`:<textarea id="commentaire" class="texte_avis"></textarea></div>
			<div>`+avis_bad()+`:<textarea id="ameliorations" class="texte_avis"></textarea></div>
		</form>
		<div>
			<label for="cgu_avis"><input onchange="accepter_cgu_avis()" id="cgu_avis" type="checkbox" checked>J'accepte les <a class="titre_chapitre" onclick="alert(CGU_avis(event))">Conditions d'Utilisation</a> du syst√®me d'avis de la plateforme.</label>
		</div>
		</div>
		`}function CGU_avis(e){e.preventDefault();return`
	En cochant cette case, vous acceptez de:

	1¬∞ Mettre en avant votre avis sur sekooly.com sans aucune r√©serve
	2¬∞ Donner l'autorisation totale √† Sekooly d'utiliser le nom de votre √©tablissement, votre r√¥le et vos initiales pour la mise en avant de la plateforme
	3¬∞ C√©der √† Sekooly le droit de diffuser votre avis, dans les termes du point n¬∞2
	4¬∞ Supprimer par vous-m√™me votre avis en cas de besoin, depuis votre espace utilisateur.

	`}function liste_notes_possibles(negatif,default_value,id_note_globale,callback){var fonction_callback=callback?' onchange="'+callback+'(this)"  ':"";var la_liste_de_notes=!id_note_globale?'<select name="note_globale" id="note_globale" value=5>':'<select name="'+id_note_globale+'"  '+fonction_callback+"   >";var note_min=negatif?-5.1:0;for(la_note=5;la_note>note_min;la_note=la_note-.1){la_note=la_note.toFixed(2);selected=la_note===Number(default_value).toFixed(2)?" selected ":"";la_liste_de_notes+=une_note_possible(la_note,selected)}la_liste_de_notes+="</select>";return la_liste_de_notes}function une_note_possible(la_note,selected){return'<option value="'+la_note+'"  '+selected+"  >"+la_note+"</option>"}function fermer_emettre_avis(){var confirmation=confirm("‚ö†Ô∏èCela supprimera votre ancien avis, et cette action est irr√©versible. Voulez-vous continuer ?");if(confirmation){$("#mini_popup").remove();supprimer_initial("Avis","identifiant",recuperer("identifiant_courant")).then(()=>emettre_avis_sekooly())}}async function mon_avis_actuel(){return await get_resultat_asynchrone(racine_initiale+"Avis?identifiant=eq."+recuperer("identifiant_courant")+"&"+api_initial)}function accepter_cgu_avis(){if($("#cgu_avis").length>0){var on_va_afficher_bouton=$("#cgu_avis")[0].checked;afficher_bouton_envoyer_avis(on_va_afficher_bouton)}}function afficher_bouton_envoyer_avis(oui){$("[onclick='envoyer_avis()']")[0].style.display=oui?"":"none"}async function envoyer_avis(){var note_globale=$("#note_globale")[0].value;var nouvel_avis={identifiant:recuperer("identifiant_courant"),nom_etablissement:data_etablissement["nom_etablissement"],mon_type:mon_role,note_globale:note_globale,commentaire:$("#commentaire")[0].value,ameliorations:$("#ameliorations")[0].value,est_visible:false,horodateur:maintenant()};return ajouter_un_element_racine("Avis",nouvel_avis).then(function(){afficher_alerte("Merci infiniment pour votre avis!");emettre_avis_sekooly()})}async function gerer_sondage(){var aujd=maintenant().split(" ")[0];var mes_sondages=get_resultat(racine_initiale+"Sondage?date_fin=gt."+aujd+"&"+api_initial);if(recuperer("identifiant_courant").includes("admin")){var sondages_non_majs=mes_sondages.filter(e=>e["maj_reponse_sondage"]===false);if(sondages_non_majs.length>0){var confirmation=confirm("Mettre √† jour tous les identifiants de tous les √©tablissements Sekooly?");if(!confirmation)return false;var liste_etablissements=get_resultat(racine_initiale+"Etablissements?"+api_initial);liste_etablissements.forEach(function(etablissement){console.log("\n\n\n\n");liste_tables=["Eleves","Profs","Administration"];liste_tables.forEach(function(la_table){nouvelle_donnee={Reponse_sondage:"non"};url=etablissement["racine_data"]+la_table+"?apikey="+etablissement["apikey"];console.log("\n");console.log({url:url,nouvelle_donnee:nouvelle_donnee});patch_resultat_asynchrone(url,nouvelle_donnee)})});url=racine_initiale+"Sondage?"+api_initial;patch_resultat_asynchrone(url,{maj_reponse_sondage:true})}}else{var mon_type=recuperer("mon_type").split("_")[0];var mes_donnees=get_resultat(racine_data+mon_type+"?Identifiant=eq."+recuperer("identifiant_courant")+"&"+apikey)[0];var donnees_actuelles=JSON.parse(recuperer("mes_donnees"));if(!mes_donnees||mes_donnees["Code"]!==donnees_actuelles["Code"]&&mes_donnees["Code"]!==hasher(donnees_actuelles["Code"])){console.log("usurpation d'identit√©.");await tout_quitter()}else{stocker("mes_donnees",JSON.stringify(mes_donnees))}if(mes_donnees["Reponse_sondage"]==="non"){mes_sondages.forEach(async function(sondage){alert(sondage["description"]);await eval(sondage["fonction_a_appeler"]);var element_validation=eval(sondage["selector_element_finalisation"]);element_validation.on("click",function(){var url=racine_data+recuperer("mon_type")+"?Identifiant=eq."+recuperer("identifiant_courant")+"&"+apikey;patch_resultat_asynchrone(url,{Reponse_sondage:"oui"});modifier_donnee_locale("mes_donnees","Identifiant",recuperer("identifiant_courant"),"Reponse_sondage","oui")})})}}}function gerer_notifs_irl(sans_changer){var coche_actuelle=$("#notifs_sans_actualiser")[0].innerText;var valeur_finale_notifs_reelles="";var phrase_finale="";if(coche_actuelle.length>0){valeur_finale_notifs_reelles="";phrase_finale="Notifications et messages en temps r√©el <b><rouge>d√©sactiv√©s</rouge></b> sur cet appareil.";fermer_la_subscription()}else{var confirmation=confirm("üîî En activant les notifications et messages priv√©s en temps r√©el sur cet appareil, vous risquez d'augmenter votre consommation de donn√©es.\n\nVoulez-vous continuer?");if(confirmation){valeur_finale_notifs_reelles=" ‚úì";phrase_finale="Messages priv√©s en temps r√©el <b><rouge>activ√©s</rouge></b> sur cet appareil.";ouvrir_la_subscription()}}stocker("notifs_sans_actualiser",valeur_finale_notifs_reelles);$("#notifs_sans_actualiser")[0].innerText=valeur_finale_notifs_reelles;if(phrase_finale)afficher_alerte(phrase_finale)}function notifs_reelles_ou_non(){var valeur_finale_notifs_reelles="";if(recuperer("notifs_sans_actualiser")){valeur_finale_notifs_reelles=" ‚úì";ouvrir_la_subscription()}else{valeur_finale_notifs_reelles="";fermer_la_subscription()}$("#notifs_sans_actualiser")[0].innerText=valeur_finale_notifs_reelles}function la_notif_me_concerne(mon_type,payload){if(payload.eventType==="UPDATE"||payload.eventType==="INSERT"){var nouvelle_notif=payload["new"];var mes_matieres=JSON.parse(recuperer("mes_matieres"));var de_moimeme=nouvelle_notif["Identifiant_derniere_modif"].includes(recuperer("identifiant_courant"));var resultat_1=mon_type.includes("Profs")&&mes_matieres.filter(e=>e["ID_URL"]===nouvelle_notif["Id_classe_matiere"]).length>0;var resultat_2=mon_type.includes("Eleves")&&mes_matieres.filter(e=>e["ID_URL"]===nouvelle_notif["Id_classe_matiere"]).length>0;var resultat_3=mon_type.includes("Admin")&&nouvelle_notif["Cycle"]===JSON.parse(recuperer("mes_donnees"))["Cycle"];return!de_moimeme&&(resultat_1||resultat_2||resultat_3)}else{return false}}function ouvrir_la_subscription(){if(mySubscription_notif&&mySubscription_conv)return true;var mon_type=recuperer("mon_type").split("_")[0];var conditions_notifs="Notifs";gerer_notifications_appareil();mySubscription_notif=supabase.from(conditions_notifs).on("*",function(payload){console.log("nouvelle notif!",payload);if(la_notif_me_concerne(mon_type,payload)){var affichage=ajouter_la_notif(payload["new"],null,true);var id_notifs_actuels=","+JSON.parse(recuperer("mes_notifs")).map(e=>e.id_notif).join(",")+",";la_date_derniere_modif=convertir_en_date(payload["new"]["Date_derniere_modif"]).seconds(0).milliseconds(0).toISOString();ma_date_consultation=convertir_en_date(recuperer("ma_date_consultation")).seconds(0).milliseconds(0).toISOString();if(!(liste_notifs_lues.includes(","+payload["new"]["id_notif"]+",")&&la_date_derniere_modif<=ma_date_consultation)){afficher_notif(affichage,payload["new"])}recuperer_notifs()}else{}}).subscribe();mySubscription_conv=supabase.from("Conversations:Destinataire=eq."+recuperer("identifiant_courant")).on("*",async function(payload){var fenetre_visible=element_DOM("fenetre").style.visibility==="visible";var liste_msgs_visible=fenetre_visible?$("#div_liste_msgs").length>0?true:false:false;var conversation_visible=$("#Destinataire.titre_du_poste").length>0?$("#Destinataire.titre_du_poste")[0].innerHTML===payload["new"]["Expediteur"].toUpperCase():false;if(conversation_visible){ajouter_donnee_locale("mes_msgs",payload["new"],"id_msg");if($("[id='"+payload["new"].id_msg+"']").length===0){$("#conversation").append(afficher_msg_conversation(payload["new"]));element_DOM(payload["new"].id_msg).scrollIntoView();jai_lu(payload["new"].id_msg,true)}}else if(!liste_msgs_visible){ajouter_donnee_locale("mes_msgs",payload["new"],"id_msg");afficher_bulle_notifs()}else{ajouter_donnee_locale("mes_msgs",payload["new"],"id_msg");recuperer_msgs(false);afficher_bulle_notifs()}}).subscribe();$(window).bind("beforeunload",function(){fermer_la_subscription()})}function fermer_la_subscription(){if(mySubscription_notif)supabase.removeSubscription(mySubscription_notif);if(mySubscription_conv)supabase.removeSubscription(mySubscription_conv)}function gerer_notifications_appareil(){if(mode_test_notif()){if(Notification.permission!=="granted"){Notification.requestPermission().then(function(permission){afficher_notif()})}else{}}}function afficher_notif(contenu,donnees_notifs){if(Notification.permission==="granted"&&mode_test_notif()){popup_notification(contenu,donnees_notifs)}}function mode_test_notif(){return window.location.href.includes("testo")||window.location.href.includes("localhost")}function popup_notification(contenu,donnees_notifs){var content=contenu||"Vous avez activ√© les notifications Sekooly.";const notification=new Notification("Sekooly | Nouvelle notification",{body:content,icon:prefixe_image+"/logo-no-background-128x128.png",vibrate:[100,50,100]});if(donnees_notifs){notification.onclick=function(e){clic_de_notif(donnees_notifs["Type_notif"],donnees_notifs["Id_source"],donnees_notifs["Id_classe_matiere"],donnees_notifs["id_notif"],donnees_notifs["Type_notif"]==="discussion")}}else{}}function ajouter_page_devoir(){nb_pages_devoir=$(".mon_file_devoir").length;if(nb_pages_devoir<8){var copie_fichier=element_DOM("file_devoir").cloneNode(true);copie_fichier.id="file_devoir_"+nb_pages_devoir;copie_fichier.value="";copie_fichier.className="mon_file_devoir fichier_supplementaire";$("#soumettre_devoir")[0].insertBefore(copie_fichier,$("#boutons_devoir")[0]);$(".mon_file_devoir").off("change");$(".mon_file_devoir").on("change",function(e){actualiser_rendu()})}else{alert("Vous ne pouvez pas envoyer un devoir de plus de 8 pages.")}}async function actualiser_rendu(sans_alerte){await rassembler(sans_alerte)}async function supprimer_derniere_page_devoir(){index_dernier_devoir=$(".mon_file_devoir").length-1;if(index_dernier_devoir>0){var avec_fichier_initial=$("[id='file_devoir_"+index_dernier_devoir+"']")[0].value.length>0;if(avec_fichier_initial)var confirmation=confirm("Voulez-vous vraiment supprimer la derni√®re page?");if(confirmation||!avec_fichier_initial){$("[id='file_devoir_"+index_dernier_devoir+"']").remove();$("img#result"+index_dernier_devoir).remove();await actualiser_rendu(true)}}}function mode_suppression(){return recuperer("mon_type").includes("Administration")&&window.location.href.endsWith("?delete="+data_etablissement["id_etablissement"])}async function valider_suppression_via_mail_si_besoin(){if(mode_suppression()){confirmation=prompt("Vous avez demand√© √† supprimer Sekooly, ce qui engendre la suppression de TOUTES vos donn√©es.\n\nMerci de confirmer cette action en √©crivant 'je veux supprimer "+data_etablissement["nom_etablissement"]+"'");console.log(confirmation);if(confirmation==="je veux supprimer "+data_etablissement["nom_etablissement"]){chargement(true);var lien_script=await chercher_lien_script(5);var premiere_demande="?confirmation="+confirmation;var adresse_mail_suppression="&adresse_mail_suppression="+data_etablissement["contact_etablissement"];var nom_etablissement_str="&nom_etablissement="+data_etablissement["nom_etablissement"];var id_etablissement_str="&id_etablissement="+data_etablissement["id_etablissement"];url=lien_script+premiere_demande+adresse_mail_suppression+nom_etablissement_str+id_etablissement_str;chargement(true);resultat=await post_resultat_asynchrone(url,{});await supprimer_initial("Etablissements","id",data_etablissement["id"]);setTimeout(function(){window.location.href="https://sekooly.com"},3e3);afficher_alerte(resultat);chargement(false)}else{afficher_alerte("Suppression de votre plateforme Sekooly annul√©e.");setTimeout(function(){window.location.href="/tele-enseignement"},3e3)}}}function afficher_quiz_option(oui){element_DOM("quiz-option").style.display=oui?"block":"none"}function quiz_selected(){return $("#liste_quiz").val()}function edit_quiz(){stocker("tmp_quiz",JSON.stringify({id_quiz:quiz_selected()}));creer_quiz()}async function delete_quiz(){var confirmation=confirm("‚ö†Ô∏è√ätes-vous s√ªr de vouloir supprimer ce quiz ? Cette action est irr√©versible.");if(confirmation){var id_quiz=quiz_selected();est_publi√©=await rechercher("Fichiers","id_fichier",id_quiz);if(est_publi√©.length>0){var confirmation2=confirm("Le quiz poss√®de peut-√™tre d√©j√† des r√©ponses.\nSi vous le supprimez, vous supprimez toutes les r√©ponses du quiz. Voulez-vous continuer?");if(confirmation2)supprimer_quiz(id_quiz)}else{supprimer_quiz(id_quiz)}}}async function supprimer_quiz(id_quiz){await supprimer("Reponses","id_quiz",id_quiz);await supprimer("Questions","id_quiz",id_quiz);await supprimer("Rendus","id_fichier_sujetdevoir",id_quiz);await supprimer("Quiz","id_quiz",id_quiz);afficher_alerte("Le quiz a bien √©t√© supprim√©.");changement_quiz_ou_non()}function ajouter_edit_quiz(oui){if(oui){if($("#edit-quiz").length===0)$("#mode-quiz").append('<img id="edit-quiz" onclick="edit_quiz()" src="'+prefixe_image+'/img_edit.png" alt="MODIFIER" class="editer">');if($("#delete-quiz").length===0)$("#mode-quiz").append('<img id="delete-quiz" onclick="delete_quiz()" src="'+prefixe_image+'/img_trash.png" alt="SUPPRIMER" class="editer">')}else{$("#edit-quiz").remove()}}async function changement_quiz_ou_non(){$("#liste_quiz").off("change");$("#liste_quiz").on("change",function(e){if(e.target.value==="new"){$("#liste_quiz")[0].value="--";ajouter_edit_quiz(false);creer_quiz()}else if(e.target.value==="--"){ajouter_edit_quiz(false)}else{ajouter_edit_quiz(true)}});if($("#categorie_choisie")[0].value==="Quiz"){$("#mode-non-quiz").css("display","none");$("#mode-quiz").css("display","block");all_quiz=await rechercher("Quiz","id_classe_matiere",recuperer("dossier_charg√©"));$(".my-quiz").remove();all_quiz.forEach(quiz=>{$('<option class="my-quiz" value="'+quiz.id_quiz+'">'+quiz.titre+"</option>").insertBefore($('[id="new-quiz"]'))});$("#mettre_fichier_en_ligne").on("click",function(){id_quiz=$("#liste_quiz").val();if(id_quiz!=="--"){var nom_fichier=$('[value="'+id_quiz+'"]').text()+".quiz";publier_quiz(id_quiz,nom_fichier);$("#mettre_fichier_en_ligne").off("click")}});afficher_checkbox_fichier_telechargeable(false);$("#liste_quiz")[0].value="--"}else{element_DOM("mode-non-quiz").style.display="grid";element_DOM("mode-quiz").style.display="none";afficher_checkbox_fichier_telechargeable(true)}}function initialiser_fenetre_quiz(preview_mode,nb_questions){var fonction_precedent=preview_mode?"prev_question()":"prev_step_quiz()";var fonction_suivant=preview_mode?"next_question("+nb_questions+")":"next_step_quiz()";$("#fenetre").append('<div class="setup" id="setup"></div>');$("#setup").append('<div id="contenu_etape_quiz"></div>');$("#setup").append('<div id="btn-quiz"></div>');$("#btn-quiz").append('<button onclick="'+fonction_precedent+'" id="btn-previous" class="btn-setup">Pr√©c√©dent</button>');$("#btn-quiz").append('<button onclick="'+fonction_suivant+'" id="bouton_suivant" class="btn-setup">Suivant</button>');$("#btn-quiz").append('<div id="remarque-quiz"></div>')}async function creer_quiz(numero_etape){if(recuperer("mon_type").includes("Eleve"))return alert("Vous n'avez pas les droits pour modifier un quiz.");vider_fenetre("Editer un quiz (<span id='etape-quiz'>1</span>/2)",false,"sauvegarder_quiz()");afficher_fenetre(true);initialiser_fenetre_quiz();init_creation_quiz();if(numero_etape){for(var i=0;i<numero_etape;i++){next_step_quiz()}}}function afficher_donnes_quiz(questions_quiz,reponses_quiz){questions_quiz.forEach(une_question=>{var donnees_reponses=reponses_quiz.filter(e=>e["id_quiz"]===get_current_quiz()&&e["id_question"]===une_question["id_question"]);nouvelle_question(une_question,donnees_reponses)})}async function saisie_des_questions_responses(){var les_questions=[];var les_reponses=[];console.log("Enregistrement des questions...");await sauvegarder_le_quiz_dans_la_table_quiz();$(".une_question_quiz").each(async(index,element)=>{var id_question=element.querySelector(".id_question").value;var intitule_question=element.querySelector("#intitule_question").value;var question_quiz={id_quiz:get_current_quiz(),id_question:id_question,position_question:index,type_question:element_DOM("type_question"+id_question).innerText,intitule_question:intitule_question};les_questions.push(question_quiz);$(".une_question_quiz#"+id_question+" > .ui-sortable > ").each(async(index_reponse,une_reponse)=>{var id_reponse=une_reponse["id"];var intitule_reponse=une_reponse.querySelector("[name=reponse]").value;var note_globale=Number(une_reponse.querySelector("[name=note_globale]").value);var remarque_correction=une_reponse.querySelector(".remarque_correction").outerHTML;var reponse_quiz={id_quiz:get_current_quiz(),id_question:id_question,id_reponse:id_reponse,position_reponse:index_reponse,intitule_reponse:intitule_reponse,score:note_globale,remarque_correction:remarque_correction};les_reponses.push(reponse_quiz)})});var retour1=await stocker_element_server("Questions",les_questions);var retour2=await stocker_element_server("Reponses",les_reponses);return[les_questions,les_reponses]}async function init_creation_quiz(){var donnees_quiz=await valeur_par_defaut("*");if(!donnees_quiz){donnees_quiz={};donnees_quiz["titre"]="";donnees_quiz["description"]=""}element_DOM("contenu_etape_quiz").innerHTML=`
		<span>Vous √™tes sur le point de cr√©er un quiz de <b class="sekooly-mode">`+la_matiere_chargee("Matiere")+`</b> dans <b class="sekooly-mode">`+la_matiere_chargee("Classe")+`</b>.</span>
		<form id="quiz-form">
			<input id="titre" name="titre" type="text"  value="`+donnees_quiz["titre"].split(".quiz")[0]+`" placeholder="Titre de votre quiz">
			<textarea id="description" name="description" type="text"  placeholder="Br√®ve description de votre quiz">`+donnees_quiz["description"]+`</textarea>
		</form>
	`}async function valeur_par_defaut(){try{var id_quiz=get_current_quiz();var res2=await rechercher("Quiz","id_quiz",id_quiz);if(res2)res2=res2[0];var res=res2?res2:JSON.parse(recuperer("tmp_quiz"));return res}catch(e){return""}}async function crud_questions(){element_DOM("contenu_etape_quiz").innerHTML=`
		<form id="quiz-form">
		</form>
		<bleu class="quiz-options" onclick="nouvelle_question()"><img src="`+prefixe_image+`/img_ajout.png" style="" class="small-icon"> Ajouter une question</bleu>
		<div onclick="run_quiz(true)" class="sekooly-mode quiz-options"><img src="`+prefixe_image+`/img_previz.png" class="small-icon trash"> Pr√©visualiser le quiz</div>
	`;var current_quiz=get_current_quiz();if(current_quiz){var questions_quiz=await rechercher("Questions","id_quiz",get_current_quiz(),"*",false,"position_question.asc");var reponses_quiz=await rechercher("Reponses","id_quiz",get_current_quiz(),"*",false,"position_reponse.asc");afficher_donnes_quiz(questions_quiz,reponses_quiz)}}async function run_quiz(preview_mode,id_quiz_initial){var id_quiz=id_quiz_initial||get_current_quiz();if(preview_mode){ma_tentative.id_fichier_sujetdevoir=id_quiz;ma_tentative.proprietaire=recuperer("identifiant_courant");ma_tentative.date_publication="";sauvegarder_quiz()}accueil_quiz(id_quiz,preview_mode)}function get_current_question(){return recuperer("current_question")?Number(recuperer("current_question")):-1}function prev_question(){var mon_index=Math.max(-1,get_current_question()-1);go_to_question(mon_index)}function btn_terminer(){var res=quiz_mode_lecture()?"Terminer la relecture":"Tout envoyer et terminer";return res}async function next_question(nb_questions){if(element_DOM("bouton_suivant").innerHTML===btn_terminer()){var retour=await submit_quiz();if(retour)accueil_quiz(get_current_quiz())}var mon_index=Math.min(nb_questions,get_current_question()+1);go_to_question(mon_index,nb_questions)}async function accueil_quiz(id_quiz,preview_mode,proprietaire_initial){var proprietaire_devoir=recuperer("proprietaire_devoir");var proprietaire=proprietaire_initial?proprietaire_initial:proprietaire_devoir?proprietaire_devoir:recuperer("identifiant_courant");var references={id_fichier_sujetdevoir:id_quiz,proprietaire:proprietaire};var mes_tentatives=await rechercher_avec_ces_references("Rendus",references);var tentative_en_cours=mes_tentatives.length>0;if(tentative_en_cours){ma_tentative=mes_tentatives[0];var date_debut_premiere_tentative=ma_tentative["date_debut"]}else{ma_tentative={}}var moimeme=proprietaire.toLowerCase()===recuperer("identifiant_courant");var pronom_utilisateur=!moimeme?proprietaire.toUpperCase():"Vous";var verbe_utilisateur=pronom_utilisateur==="Vous"?"avez":"a";var poss=pronom_utilisateur==="Vous"?"Votre":"Son";var infos_quiz=await rechercher("Quiz","id_quiz",id_quiz,"*");var nb_questions=await rechercher("Questions","id_quiz",id_quiz,"id_question");if(infos_quiz.length>0&&nb_questions.length>0){infos_quiz=infos_quiz[0];nb_questions=nb_questions.length;var bouton_edit=preview_mode||$('[class="editer"]').length>0?'<img onclick="creer_quiz()" src="'+prefixe_image+'/img_edit.png" alt="MODIFIER" class="editer">':"";vider_fenetre(infos_quiz["titre"]+bouton_edit,false,"sauvegarder_quiz()");initialiser_fenetre_quiz(true,nb_questions);var total_score=await rechercher_avec_ces_references("total_score",{id_quiz:id_quiz},["score_question"]);if(total_score)total_score=eval(total_score.map(e=>e.score_question).join("+"));var fin_quiz=ma_tentative["date_publication"]?"<br>"+pronom_utilisateur+" l'"+verbe_utilisateur+" termin√© le "+afficher_date(ma_tentative["date_publication"]):"";var points=ma_tentative["date_publication"]?"<br><b class='sekooly-mode'> "+poss+" score: "+await calculer_mon_score(ma_tentative["reponses"])+"/"+total_score+"</b>":"";var remarque_quiz=date_debut_premiere_tentative?'<i style="color: #737373;"> '+pronom_utilisateur+" "+verbe_utilisateur+" d√©j√† fait 1 tentative le "+afficher_date(date_debut_premiere_tentative)+" "+fin_quiz+points+" </i>":"";element_DOM("remarque-quiz").innerHTML=remarque_quiz;$("#contenu_etape_quiz").append(infos_quiz["description"]+"<br><br>Ce quiz comporte "+nb_questions+" question"+(nb_questions>1?"s":"")+", et not√© sur "+total_score+".");$("#contenu_etape_quiz").addClass("resp_zone");stocker("current_question",-1);afficher_fenetre(true);element_DOM("bouton_suivant").innerText=ma_tentative["date_publication"]?"Relecture":date_debut_premiere_tentative?"Reprendre la tentative":"Commencer";element_DOM("btn-previous").setAttribute("style","display: none;")}return true}async function calculer_mon_score(rpses){rspses_t=transform_rsp(rpses);my_id_resp=rspses_t[0];my_str_rsp=rspses_t[1];ref={id_quiz:get_current_quiz()};total_score=await rechercher_avec_ces_references("Reponses",ref,["id_reponse","score","intitule_reponse"]);var mon_score=total_score.filter(function(a_rsp){return my_id_resp.indexOf(a_rsp["id_reponse"])>=0||my_str_rsp.indexOf(a_rsp["intitule_reponse"].trim())>=0});mon_score=mon_score.map(e=>Number(e["score"]));return eval(mon_score.join("+"))}function transform_rsp(rpses){var my_id_resp=[];var my_str_rsp=[];if(typeof rpses==="string")rpses=JSON.parse(rpses);$.each(rpses,(key,rsp)=>{if(typeof rsp==="string"){my_str_rsp.push(rsp.trim())}else if(rsp){my_id_resp.push(rsp.map(e=>Object.keys(e)).join(","))}});my_id_resp=my_id_resp.join(",").split(",");return[my_id_resp,my_str_rsp]}function initialiser_tentative(){if(Object.keys(ma_tentative).length===0){var id_devoir=creer_uuid();ma_tentative={id_devoir:get_current_quiz()+suite_notif(),id_fichier:id_devoir,proprietaire:recuperer("identifiant_courant"),id_dossier_sujetdevoir:recuperer("dossier_charg√©"),matiere_rendue:la_matiere_chargee("Matiere"),id_fichier_sujetdevoir:get_current_quiz(),date_debut:get_date_debut_quiz(),remarque:"",taille_fichier:0,nom_fichier:"Quiz de "+recuperer("identifiant_courant")+".quiz",reponses:{}}}return ma_tentative}async function go_to_question(mon_index,nb_questions){save_current_submition();stocker("current_question",mon_index);chargement(true);await get_nth_question(mon_index,nb_questions);chargement(false)}function get_date_debut_quiz(){return recuperer("date_debut_quiz")?recuperer("date_debut_quiz"):maintenant()}async function submit_quiz(sans_terminer){if(quiz_mode_lecture())return true;if(!sans_terminer){if(quiz_mode_previz()){alert("Au clic de ce bouton, l'utilisateur aura le score de sa tentative, ainsi que la correction du quiz.\n‚ö†Ô∏èVotre tentative n'est pas envoy√©e car vous √™tes √©diteur de ce quiz.");return true}var confirmation=confirm("‚ö†Ô∏è√ätes-vous s√ªr de vouloir terminer le quiz ? Cette action est irr√©versible.");if(!confirmation)return false;ma_tentative["date_publication"]=!quiz_mode_previz()?await maintenant():""}if(Object.keys(ma_tentative.reponses).length>0){var retour=await supabase.from("Rendus").upsert(ma_tentative);if(ma_tentative["date_publication"]){mes_donnees=JSON.parse(recuperer("mes_donnees"));id_quiz=get_current_quiz();var ma_notif_quiz={id_notif:id_quiz+suite_notif(),Horodateur:ma_tentative["date_publication"],Type_notif:"devoir",Id_source:id_quiz,"Intitul√©":ma_tentative["nom_fichier"],Identifiant_originaire:recuperer("identifiant_courant"),Role_originaire:"Eleve",Identifiant_derniere_modif:recuperer("identifiant_courant"),Role_derniere_modif:"Eleve",Classe:mes_donnees["Classe"],Classe_matiere:"("+mes_donnees["Classe"]+"|"+la_matiere_chargee("Matiere")+")",Id_classe_matiere:recuperer("dossier_charg√©"),Date_derniere_modif:ma_tentative["date_publication"],Cycle:mes_donnees["Cycle"]};var retour2=await supabase.from("Notifs").upsert(ma_notif_quiz)}}return ma_tentative}function save_current_submition(){var current_question=recuperer("current_question");var date_debut=get_date_debut_quiz();var rpse_qst=[];if($(".option-rps").length>0){$(".option-rps:checked").each((name,element)=>{rpse_qst.push({[element.value]:element.nextSibling.innerText})})}else{rpse_qst=$(".rps_quiz").val()}var tmp_quiz_rpse={};tmp_quiz_rpse[current_question]=rpse_qst;initialiser_tentative();if(!ma_tentative.reponses)ma_tentative.reponses={};ma_tentative.reponses[current_question]=rpse_qst;submit_quiz(true);return ma_tentative}function reference_question(mon_index,contenu_ref,nb_questions_str){var index_interne=contenu_ref?contenu_ref:mon_index+1;var nb_questions=nb_questions_str?","+nb_questions_str:"";return'<a ref="'+mon_index+'"    onclick="go_to_question('+mon_index+nb_questions+')"><span>[ '+index_interne+" ]</span></a> "}async function get_nth_question(position_question,nb_questions){if(position_question<0){return accueil_quiz(get_current_quiz())}else{element_DOM("bouton_suivant").innerText="Suivant";element_DOM("btn-previous").setAttribute("style","");if(nb_questions){element_DOM("remarque-quiz").innerHTML=reference_question("-1","Accueil",nb_questions);for(var i=0;i<nb_questions;i++){element_DOM("remarque-quiz").innerHTML+=reference_question(i)}element_DOM("remarque-quiz").innerHTML+=reference_question(nb_questions,"Finaliser",nb_questions)}}var champs_refs={id_quiz:get_current_quiz(),position_question:position_question};var datas=await rechercher_avec_ces_references("Questions",champs_refs);if(datas.length>0){datas=datas[0];var id_question=datas["id_question"];delete champs_refs["position_question"];champs_refs["id_question"]=id_question;var scoring=await rechercher_avec_ces_references("total_score",champs_refs);if(!scoring)return afficher_alerte("Erreur de connexion, merci de r√©essayer plus tard.");var nb_questions_ok=scoring[0]["nb_questions_ok"];var score_question=scoring[0]["score_question"];var nb_reponses_possibles=await rechercher_avec_ces_references("Reponses",champs_refs,["id_reponse"]);nb_reponses_possibles=nb_reponses_possibles.length;var liste_champs_utiles=nb_reponses_possibles===1?["id_quiz","id_question","id_reponse"]:["id_quiz","id_question","id_reponse","intitule_reponse"];if(quiz_mode_lecture())liste_champs_utiles=["*"];var rsp=await rechercher_avec_ces_references("Reponses",champs_refs,liste_champs_utiles,"position_reponse.asc");if(rsp){var nb_reponses_possibles=rsp.length;if(typeof ma_tentative.reponses==="string")ma_tentative.reponses=JSON.parse(ma_tentative.reponses);var valeurs_par_defaut=ma_tentative.reponses?ma_tentative.reponses[position_question]:null;$("#resp_zone").remove();var resp=resp_zone(id_question,rsp,nb_reponses_possibles,nb_questions_ok,valeurs_par_defaut);$(resp).insertBefore(element_DOM("btn-quiz"));element_DOM("contenu_etape_quiz").innerHTML=datas["intitule_question"];element_DOM("contenu_etape_quiz").innerHTML+="<br>("+score_question+" point"+(score_question>1?"s":"")+")"}}else{element_DOM("contenu_etape_quiz").innerHTML=quiz_mode_lecture()?"Retrouvez ci-dessous le r√©sum√© de votre tentative.":"Vous √™tes sur le point de terminer le quiz.<br>Retrouvez ci-dessous le r√©sum√© de votre tentative.";element_DOM("resp_zone").innerHTML=resume_tentative_quiz(nb_questions)}$("#contenu_etape_quiz").removeClass("resp_zone");$("span").removeClass("current-qst");if($("a[ref='"+position_question+"']")[0])$("a[ref='"+position_question+"']")[0].children[0].className="current-qst";if(position_question===nb_questions)element_DOM("bouton_suivant").innerText=btn_terminer();return datas}function resume_tentative_quiz(nb_questions){var id_quiz=get_current_quiz();var res="";var element="";for(var i=0;i<nb_questions;i++){if(ma_tentative.reponses){element=typeof ma_tentative.reponses[i]==="string"?ma_tentative.reponses[i]:typeof ma_tentative.reponses[i]==="object"?JSON.stringify(ma_tentative.reponses[i]):""}if(element==="[]")element=[];var remarque_element="<rouge>‚ùå Aucune r√©ponse enregistr√©e</rouge>";if(element){if(element.length>0)remarque_element="<bleu>‚òëÔ∏è R√©ponse enregistr√©e</bleu>"}res+='<div onclick="go_to_question('+i+")\" class='resume'><br><a>Question n¬∞"+(i+1)+"</a>: "+remarque_element+"</div>"}return res}function resp_zone(id_question,rsp,nb_reponses_possibles,nb_questions_ok,valeurs_par_defaut){var activation=ma_tentative["date_publication"]?' disabled  readonly="readonly" ':"";var score_total=0;var phrase_score="";var score_rpse="";var remarque_rpse="";var pronom_et_verbe="Vous avez eu ";if(recuperer("proprietaire_devoir")){pronom_et_verbe=recuperer("proprietaire_devoir")===recuperer("identifiant_courant")?"Vous avez eu ":recuperer("proprietaire_devoir").toUpperCase()+" a eu "}if(nb_reponses_possibles===1){var val=valeurs_par_defaut?'value="'+valeurs_par_defaut+'"':"";var est_la_bonne_reponse=rsp[0]["intitule_reponse"]?valeurs_par_defaut.trim()===rsp[0]["intitule_reponse"].trim():"";var remarque_rpse=est_la_bonne_reponse&&rsp[0]["remarque_correction"]?rsp[0]["remarque_correction"]:!est_la_bonne_reponse&&rsp[0]["intitule_reponse"]?"<rouge class='remarque_correction'>‚ùåMauvaise r√©ponse. La r√©ponse √©tait: <b>"+rsp[0]["intitule_reponse"]+"</b></rouge>":"";score_rpse=!rsp[0]["intitule_reponse"]?"":est_la_bonne_reponse&&rsp[0]["score"]?rsp[0]["score"]>0?"+"+rsp[0]["score"]:rsp[0]["score"]:!est_la_bonne_reponse?0:"";phrase_score=rsp[0]["score"]?pronom_et_verbe+score_rpse+" points pour cette question.":"";return`<form id="resp_zone" class="resp_zone" style="text-align: center;"><input `+val+`     class="rps_quiz"  id_question="`+id_question+`"  name="qst`+id_question+`"  id="response`+rsp[0]["id_reponse"]+`" placeholder="Votre r√©ponse..."   `+activation+`  type="text" name="rsp'+id_question+'"> <div>`+remarque_rpse+`  <span class="points">`+score_rpse+`</span></div>  <div class="points" id="rmq'+id_question+'"> `+phrase_score+` </div>   </form>`}else{var type_input=nb_questions_ok===1?"radio":"checkbox";var res='<form id="resp_zone" class="resp_zone">';var liste_id_reponses_choisies=",";if(valeurs_par_defaut){liste_id_reponses_choisies=typeof valeurs_par_defaut!=="string"?","+valeurs_par_defaut.map(e=>Object.keys(e)).join(",")+",":valeurs_par_defaut}rsp.forEach(une_rsp=>{est_coch√©="";if(valeurs_par_defaut){est_coch√©=liste_id_reponses_choisies.includes(","+une_rsp["id_reponse"]+",")?"  checked  ":"";phrase_reponse_vraie_non_cochee=type_input==="checkbox"?"<rouge class='remarque_correction'>‚úÖCette r√©ponse √©tait aussi vraie.</rouge>":"<rouge class='remarque_correction'>‚úÖCelle-ci √©tait la bonne r√©ponse.</rouge>";remarque_rpse=!une_rsp["score"]?"":une_rsp["score"]>0&&est_coch√©?une_rsp["remarque_correction"]:une_rsp["score"]<=0&&est_coch√©?une_rsp["remarque_correction"]:une_rsp["score"]>0&&!est_coch√©?phrase_reponse_vraie_non_cochee:"";signe=une_rsp["score"]>=0?"+":"";score_rpse=une_rsp["score"]?signe+une_rsp["score"]:"";score_total=une_rsp["score"]&&est_coch√©?score_total+Number(une_rsp["score"]):score_total;phrase_score=une_rsp["score"]?pronom_et_verbe+score_total+" points pour cette question.":""}res+=`
				<div>
					<input class="option-rps" type="`+type_input+`"     `+activation+`     id_question="`+id_question+`"  `+est_coch√©+` name="qst`+id_question+`"  value="`+une_rsp["id_reponse"]+`" id="response`+une_rsp["id_reponse"]+`" ><label class="label-check" for="response`+une_rsp["id_reponse"]+`">`+une_rsp["intitule_reponse"]+`</label>
					<span>`+remarque_rpse+`  <span class="points">`+score_rpse+`</span></span>
				</div>
			`});res+=' <div class="points" id="rmq'+id_question+'"> '+phrase_score+" </div>    </form>";return res}}function nouvelle_question(donnees_question,donnees_reponses){var formulaire=$("#quiz-form").append(une_question_quiz(donnees_question));var la_nouvelle_question=formulaire[0].lastElementChild;$("#quiz-form").sortable({update:function mettre_a_jour_position_questions(){var liste_des_questions=[];$(".une_question_quiz.ui-sortable-handle").each(function(position_finale,element){nouvelle_position_question_drag=position_finale+1;$(".id_question[value='"+element.getAttribute("name")+"']")[0].value=nouvelle_position_question_drag})}});if(donnees_question){la_nouvelle_question.querySelector("[name='type_question']").innerText=donnees_question["type_question"];la_nouvelle_question.querySelector("[name='intitule_question']").innerText=donnees_question["intitule_question"]}if(!donnees_reponses){add_response(la_nouvelle_question.id)}else{donnees_reponses.forEach(une_reponse=>{add_response(une_reponse["id_question"],une_reponse)})}}function une_question_quiz(donnees_question){var nouvel_id_question=donnees_question?donnees_question["id_question"]:$("[name='intitule_question']").length+1;return`
	<div class="une_question_quiz" id="`+nouvel_id_question+`"   name="`+nouvel_id_question+`" >
		<input type="text" value="`+nouvel_id_question+`" name="id_question" class="id_question">
		<div><rouge class="mini-image" style="font-size: 12px;" onclick="help_quiz_resp()">Besoin d'aide?</rouge></div>
		<div name="type_question" id="type_question`+nouvel_id_question+`"></div>
		<textarea id="intitule_question" name="intitule_question" type="text" placeholder="Intitul√© de la question..."></textarea>
		<div class="top-qstn">
			<rouge class="foot-element" onclick="supprimer_question(`+nouvel_id_question+`)"><img src="`+prefixe_image+`/img_trash.png" alt="SUPPRIMER" class="small-icon trash"></rouge>			
	    </div>
	    <div class="reponses_possibles" name="reponses_possibles`+nouvel_id_question+`"></div>
    	<div class="foot-qst" style="font-size: 15px;">
		  <bleu class="foot-element" onclick="add_response(`+nouvel_id_question+`)">Ajouter une r√©ponse possible</bleu>
		</div>
	</div>
	`}async function supprimer_question(id_question){$("[name='reponses_possibles"+id_question+"'] > .une_reponse_possible > [alt='SUPPRIMER'] ").each((index,element)=>{delete_resp(element,true)});var id_quiz=get_current_quiz();var references={id_quiz:id_quiz,id_question:id_question};retour=await supprimer_avec_ces_references("Questions",references);$('.une_question_quiz[id="'+id_question+'"]').remove()}async function delete_resp(ceci,forcing){var la_reponse_possible=ceci.parentNode.parentNode;var pas_la_seule_reponse=la_reponse_possible.children.length>1;if(pas_la_seule_reponse||forcing){var id_quiz=get_current_quiz();var id_question=la_reponse_possible.parentNode.id;var id_reponse=ceci.parentNode.id;var references={id_quiz:id_quiz,id_question:id_question,id_reponse:id_reponse};retour=await supprimer_avec_ces_references("Reponses",references);ceci.parentNode.remove();mettre_type_question(la_reponse_possible.parentNode.id);return true}else{alert("Vous devez donner au moins une r√©ponse √† la question.");return false}}function add_response(id_question,donnees_reponses){var les_reponses_possibles=$("[name='reponses_possibles"+id_question+"']").append(une_reponse_possible(donnees_reponses));var la_reponse=les_reponses_possibles[0].lastElementChild;$("[name='reponses_possibles"+id_question+"']").sortable({update:function mettre_a_jour_position_reponses(){var liste_des_reponses=[];$(".une_reponse_possible.ui-sortable-handle").each(function(position_finale,element){nouvelle_position_rps_drag=position_finale+1})}});mettre_type_question(id_question);$("[name=note_globale]").off("change");$("[name=note_globale]").on("change",function(e){valeur=Number(e.target.value);e.target.style.color=valeur<0?"red":valeur>0?"green":"";var id_question=e.target.parentNode.parentNode.parentNode.id;mettre_type_question(id_question);remarque_par_defaut(e.target)});$("[name=note_globale]").change();if(donnees_reponses){la_reponse.querySelector("[name='reponse']").value=donnees_reponses["intitule_reponse"];la_reponse.querySelector(".remarque_correction").outerHTML=donnees_reponses["remarque_correction"]}}function mettre_type_question(id_question){var el_type_question=element_DOM("type_question"+id_question);var points_selector=$(".une_question_quiz#"+id_question+" > .reponses_possibles > .une_reponse_possible > [name='note_globale']");var type_question="Question en saisie libre";var responses_wrapper=$("[name='reponses_possibles"+id_question+"']");if(responses_wrapper.length===0)return true;responses_wrapper=responses_wrapper[0];var nb_reponses_possibles=responses_wrapper.children.length;if(nb_reponses_possibles>1){type_question="Question √† choix unique";var nb_reponses_justes=points_selector.filter(function(){return Number($(this).val())>0}).length;if(nb_reponses_justes>1){type_question="Question √† choix multiple"}}points_question=0;points_selector.each(function(){valeur=Number($(this).val());if(valeur>0)points_question+=valeur});var retour_final=type_question+" sur "+points_question.toFixed(2)+" points ";if(el_type_question)el_type_question.innerText=retour_final;mettre_score_total(true);return retour_final}function mettre_score_total(oui){var total_score=0;$("[name='note_globale']").each((e,element)=>{var score=Number(element.value);if(score>0)total_score+=score});element_DOM("remarque-quiz").innerText=oui?"Votre quiz est not√© sur "+total_score:"";return total_score}function une_reponse_possible(donnees_reponses){var prochain_id=donnees_reponses?donnees_reponses["id_reponse"]:creer_uuid();var editable=quiz_mode_lecture()?"":' contenteditable="true" onclick="focus_edit(this)"';var valeur_score=!donnees_reponses?"0":Number(donnees_reponses["score"]).toFixed(2);return`<span class="une_reponse_possible" id="`+prochain_id+`">
    <input name="reponse" style="width: 55%;" placeholder="R√©ponse possible et le SCORE de la r√©ponse (liste d√©roulante)...">`+liste_notes_possibles(true,valeur_score,"note_globale")+`
    <img class="small-icon trash" alt="SUPPRIMER" src="`+prefixe_image+`/img_trash.png" onclick="delete_resp(this)">
    <br>
    <bleu class="mini-image remarque_correction wrong" `+editable+` >Remarque correction</bleu>
  </span>
  `}function focus_edit(ceci){setCaret(ceci)}function setCaret(el){el.focus()}function remarque_par_defaut(ceci){var element_a_maj=ceci.parentNode.querySelector("bleu");var valeur_remarque_actuelle=element_a_maj.innerHTML;if(valeur_remarque_actuelle.length===0||valeur_remarque_actuelle===valeur_remarque_initiale()||valeur_remarque_actuelle===valeur_remarque_correct()||valeur_remarque_actuelle===valeur_remarque_incorrect()){var est_positif=Number(ceci.value)>0;element_a_maj.innerHTML=est_positif?valeur_remarque_correct():valeur_remarque_incorrect()}element_a_maj.style.color=ceci.style.color}function remarque_correction(ceci){if(ceci.innerText.length===0)ceci.innerText=valeur_remarque_initiale()}function valeur_remarque_correct(){return"‚úÖ Votre r√©ponse est correcte."}function valeur_remarque_incorrect(){return"‚ùå Votre r√©ponse est incorrecte."}function valeur_remarque_initiale(){return"Remarque correction"}function help_quiz_resp(){if($(".une_reponse_possible").length>0){var alerte="Le type de question se mettra √† jour en fonction du nombre de r√©ponses possibles ET du nombre de r√©ponses justes.\n\n\n";alerte+="‚Ä¢ Score positif=bonne r√©ponse\n‚Ä¢ Score nul=mauvaise r√©ponse\n‚Ä¢ Score n√©gatif=malus.\n\n\nLa remarque de correction s'affiche lorsque l'utilisateur choisit cette r√©ponse, et peut se personnaliser au clic.";alert(alerte)}else{alert("Ajoutez d'abord une r√©ponse possible, puis recliquez √† nouveau ici.")}}function get_current_quiz(){return recuperer("fichier_ouvert")?recuperer("fichier_ouvert"):recuperer("tmp_quiz")?JSON.parse(recuperer("tmp_quiz"))["id_quiz"]:null}function go_to_step(step_number,prev_step){if(!recuperer("tmp_quiz")){resultat={id_quiz:creer_uuid()};stocker("tmp_quiz",JSON.stringify(resultat))}if(prev_step===2){saisie_des_questions_responses()}else if(prev_step===1){if(!formulaire_rempli_ok("quiz-form")){element_DOM("etape-quiz").innerText=prev_step;return alert("Vous devez remplir tous les champs avant de continuer.")}resultat=objectifyForm("quiz-form")}resultat["id_quiz"]=JSON.parse(recuperer("tmp_quiz"))["id_quiz"];resultat["id_classe_matiere"]=recuperer("dossier_charg√©");resultat["proprietaire"]=recuperer("identifiant_courant");stocker_quiz_local(resultat);if(step_number===1){init_creation_quiz()}if(step_number===prev_step){finaliser_edition_quiz()}else if(step_number===2){crud_questions()}}function finaliser_edition_quiz(){var confirmation=confirm("√ätes-vous s√ªr d'avoir bien √©dit√© les questions-r√©ponses du quiz?");if(confirmation)dernieres_modifs_quiz()}async function dernieres_modifs_quiz(){var id_quiz=get_current_quiz();var nouvel_item={id_quiz:id_quiz,id_classe_matiere:recuperer("dossier_charg√©"),proprietaire:recuperer("identifiant_courant"),date_publication:maintenant()};await stocker_quiz_local(nouvel_item);$("#sauvegarder").remove();$("#bye_prev").one("click",function(){$("#categorie_choisie").change();element_DOM("liste_quiz").value=id_quiz;effacer("tmp_quiz")});element_DOM("setup").innerText="Vous pouvez fermer cette fen√™tre.";await sauvegarde_mode_edit()}function avec_sauvegarde(function_whole_name){if(function_whole_name){$("#titre_fenetre").append('<img id="sauvegarder" src="'+prefixe_image+'/img_save.png" alt="üíæ" onclick="'+function_whole_name+'" class="icon-save">')}else{$("#sauvegarder").remove()}}function next_step_quiz(){sauvegarder_quiz(true);var prev_step=Number(element_DOM("etape-quiz").innerText);element_DOM("etape-quiz").innerText++;if(element_DOM("etape-quiz").innerText>2)element_DOM("etape-quiz").innerText=2;var step_number=Number(element_DOM("etape-quiz").innerText);go_to_step(step_number,prev_step)}function prev_step_quiz(){sauvegarder_quiz(true);var prev_step=Number(element_DOM("etape-quiz").innerText);element_DOM("etape-quiz").innerText--;if(element_DOM("etape-quiz").innerText<1)element_DOM("etape-quiz").innerText=1;var step_number=Number(element_DOM("etape-quiz").innerText);go_to_step(step_number,prev_step)}function stocker_quiz_local(nouvel_item){var tmp_quiz=recuperer("tmp_quiz");if(tmp_quiz&&JSON.parse(tmp_quiz)["id_quiz"]===nouvel_item["id_quiz"]){Object.keys(nouvel_item).forEach(e=>{modifier_donnee_locale("tmp_quiz","id_quiz",nouvel_item["id_quiz"],e,nouvel_item[e],false)})}else{effacer("tmp_quiz");stocker("tmp_quiz",JSON.stringify(nouvel_item))}return recuperer("tmp_quiz")}function quiz_mode_run(){return $("[onclick='next_step_quiz()']").length===0}function quiz_mode_lecture(){return quiz_mode_run()&&ma_tentative["date_publication"]?true:false}function quiz_mode_previz(){return $("[onclick='creer_quiz()']").length>0}async function sauvegarder_quiz(sans_afficher){var retour="";var texte_a_afficher="";if(quiz_mode_lecture()){texte_a_afficher="Vous ne pouvez pas modifier cette tentative.";retour=ma_tentative}else if(quiz_mode_run()){texte_a_afficher=ma_tentative.reponses&&Object.keys(ma_tentative.reponses).length>0?"Votre tentative a bien √©t√© sauvegard√©e.":"";save_current_submition();retour=ma_tentative}else{texte_a_afficher=await sauvegarde_mode_edit()}if(texte_a_afficher&&!sans_afficher)afficher_alerte(texte_a_afficher);return retour}async function sauvegarde_mode_edit(){texte_a_afficher="Votre quiz a bien √©t√© sauvegard√©.";if($(".une_question_quiz").length>0){saisie_des_questions_responses()}else{texte_a_afficher=await sauvegarder_le_quiz_dans_la_table_quiz()}return texte_a_afficher}async function sauvegarder_le_quiz_dans_la_table_quiz(){if(recuperer("tmp_quiz")){try{var donnees_locales=JSON.parse(recuperer("tmp_quiz"));await stocker_quiz_server(donnees_locales);retour=donnees_locales}catch(e){texte_a_afficher="Votre quiz n'a PAS √©t√© sauvegard√©: merci de r√©essayer ou de v√©rifier votre connexion internet."}}else{texte_a_afficher="Aucune donn√©e de quiz √† sauvegarder: appuyez sur suivant avant d'enregistrer."}return texte_a_afficher}function stocker_quiz_server(donnees_locales){return supabase.from("Quiz").upsert(donnees_locales)}function stocker_element_server(nom_table,donnees_locales){return supabase.from(nom_table).upsert(donnees_locales)}async function publier_quiz(id_quiz,nom_fichier){date_heure_actuelle=maintenant();mes_donnees=JSON.parse(recuperer("mes_donnees"));la_classe=recuperer("mon_type")==="Eleves"?mes_donnees["Classe"]:la_matiere_chargee("Classe");la_matiere=recuperer("mon_type")==="Eleves"?$("#accueil_utilisateur")[0].innerText:la_matiere_chargee("Matiere");nouveau_fichier={date_publication:date_heure_actuelle,id_fichier:id_quiz,nom_fichier:nom_fichier,id_dossier:recuperer("dossier_charg√©"),proprietaire:recuperer("identifiant_courant"),categorie_fichier:"Quiz",date_effet:element_DOM("date_effet_fichier").value,est_telechargeable:"non",taille_fichier:0,destinataire_par_page:null,periode_bulletin:null};try{retour1=await ajouter_un_element("Fichiers",nouveau_fichier,id_quiz);id_notif=id_quiz+suite_notif();nouvelle_notif={id_notif:id_notif,Horodateur:date_heure_actuelle,Type_notif:"fichier",Id_source:id_quiz,"Intitul√©":nom_fichier,Identifiant_originaire:recuperer("identifiant_courant"),Role_originaire:mon_role,Identifiant_derniere_modif:recuperer("identifiant_courant"),Role_derniere_modif:mon_role,Classe:la_classe,Classe_matiere:"("+la_classe+"|"+la_matiere+")",Id_classe_matiere:recuperer("dossier_charg√©"),Date_derniere_modif:date_heure_actuelle,Cycle:mes_donnees["Cycle"]};retour2=await ajouter_un_element("Notifs",nouvelle_notif,id_notif);afficher_alerte("Votre quiz a bien √©t√© publi√©.",true)}catch(e){console.error(e);afficher_alerte("Erreur de publication du quiz: v√©rifiez s'il n'est pas d√©j√† publi√©.")}chargement(false)}