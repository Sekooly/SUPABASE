var elements_generiques_en_haut=[{"Général":["Alerte","Espace etablissement restant","Infos établissement","Maintenance","</> Intégrer Sekooly à mon site"]},{Enseignement:["Cycles","Classes","Matieres"]},{Utilisateurs:["Administration","Profs","Eleves"]},{"Activités":["Logs","Visio","Fichiers","Rendus","Topic","Coms","Notifs"]},{Quiz:["Quiz","Questions","Reponses"]}];var elements_menu_haut=elements_generiques_en_haut.map(e=>Object.values(e)).join(",").split(",");var elements_menu_analyses=["Analyses des connexions"];var elements_menu_preferences=["Images","Couleurs","Formes","Police"];var img_dynamiques=["img_background-image.png","logo-no-background-128x128.png","img_retour.png","default-user.svg","img_reset.png","img_import.png","img_download.png","img_dupliquer.png","img_redtrash.png","img_previz.png","img_pleinecran.png","img_petitecran.png"];img_dynamiques=img_dynamiques.concat(liste_img_extensions());var parametres_automatiques=["Classe_bis","Classe_Matiere","ID_URL","URL","URL_Mapping","URL_agenda","id_googlecalendar","nb_avis_donnés","nb_avis_max","nom_fiche","taux_conseil","Matiere_bis","classe_id","classe_bis","type","Derniere_consultation_notifs","id_formulaire_remediation","id_fiche","URL_Mapping","niveau","classe_bis","id_dossier_cycle","dossier_rendus_cycle","liste_notifs_lues","nombre_avis","Numero_telephone","id","Id_classe_matiere","id_notif","Id_source","id_fichier","id_dossier","id_devoir","id_dossier_sujetdevoir","id_fichier_sujetdevoir","Id_topic","id_com","ID_FICHIER","id_msg","id_conv","id_chapitre","id_quiz","id_question","id_reponse","id_classe_matiere","resultat_immediat","nb_tentatives","questions_aleatoires","position_question","1er_Prénom","LV1","LV2","LV3","Option_1","Option_2","Spécialité","Numeros_telephone_original"];var elements_menu_haut_avec_modifs=["Classes","Matieres","Eleves","Profs","Administration"];var elements_menu_haut_avec_reset=["Eleves","Profs","Administration"];nom_etablissement=data_etablissement["nom_etablissement"];var champs_avec_listes_dynamiques=["Classe","classe_bis","Classe_principale","Cycle","cycle","Matiere","Matiere_bis"];var champs_oui_ou_non=["Est_délégué","Reponse_sondage","Ecolage_OK","Droits_modifs","Droit_acces_anticipe_examen","Droit_changer_ecolage","commun_au_cycle","droit_hors_maintenance","Est_délégué"];var liste_couleurs=["blanc","bleu ciel","bleu foncé","gris","jaune","marron","noir","orange","rose","rouge","vert clair","vert foncé","violet"];var numero_etape=recuperer("numero_etape")?Number(recuperer("numero_etape")):0;var nb_etapes=8;var nouveau_prof=[];var image_temporaire="";var nom_image_temporaire="";var mes_devoirs_a_faire=[];var mes_devoirs_rendus=[];var tous_les_eleves_de_mon_cycle=[];var mes_discussions=[];var mes_coms=[];var mes_visios=[];var mes_fichiers=[];var liste_notifs_lues="";var mySubscription_notif=null;var mySubscription_conv=null;var ma_tentative={};var mes_reponses={};const{createClient}=supabase;supabase=createClient(racine_data.replace("/rest/v1/",""),data_etablissement["apikey"]);supabaseInit=createClient(racine_initiale.replace("/rest/v1/",""),api_initial.split("=")[1]);function afficher_conseil_de_classe(e){if(e){element_DOM("conseil_de_classes").style.display=""}else{charger_classe_conseil(false);element_DOM("conseil_de_classes").style.display="none"}}function charger_classe_conseil(e){if(impossible_de_cliquer())return-1;if(e){var i=la_matiere_chargee("Classe");var r=recuperer("mon_type").split("_")[0];if(r.includes("Eleves")){var i=JSON.parse(recuperer("mes_donnees"))["Classe"];var t=JSON.parse(recuperer("mes_donnees"))["Est_délégué"]?JSON.parse(recuperer("mes_donnees"))["Est_délégué"]==="oui":false;var n=moment().format("yyyy-MM-DD");if(n==="2020-07-31")t=true}if(i){if(r.includes("Admin")||r.includes("Prof")||r.includes("Eleves")&&t){recuperer_la_fiche_conseil(i)}else{recuperer_MA_fiche_conseil()}}}else{quitter_previsualisation()}}function recuperer_la_fiche_conseil(i){var r="Conseil de classe - "+i;vider_fenetre(r);afficher_fenetre(true);chargement(true);var e=racine_data+"Eleves?Classe=eq."+i+"&"+apikey;liste_eleves=get_resultat(e);liste_eleves=liste_eleves.sort(function(e,i){if(e.Identifiant<i.Identifiant){return-1}if(e.Identifiant>i.Identifiant){return 1}return 0});var t=JSON.parse(recuperer("mes_matieres")).find(e=>e["Classe"]===i)["classe_id"];e=racine_data+"Fiches?id_classe=eq."+t+"&"+apikey;$.ajax({url:e,type:"GET",success:function(e){chargement(false);e=e[0];afficher_fenetre_conseil_de_classe([[e["id_fiche"],e["nom_fiche"]],liste_eleves],r,i)},error:function(e){chargement(false);alert("Vérifiez que vous êtes toujours connecté à internet.")}})}function afficher_fenetre_conseil_de_classe(e,i,r){afficher_visualisation_fiche(e[0],i);lister_les_eleves(e[1],r)}function afficher_visualisation_fiche(e,i){if(e){visualiser(e[1],e[0],"",i,recuperer("mon_type").includes("Eleves"));$("#previsualisation")[0].style.height="50%"}}function lister_les_eleves(e,u){var i='<div id="liste_eleves" class="liste_eleves_conseil"></div>';$("#liste_eleves").remove();$("#fenetre").append(i);$("#liste_eleves")[0].scrollTo(0,0);e.forEach(function(e,i){var r=e["Identifiant"].toUpperCase();$("#liste_eleves").append('<b  class="sekooly-mode"  style="margin-bottom: 5px;" id="'+r+'">'+r+" </b>");var t=element_DOM(r);var n='<span><img alt="voir" class="envoi_remarque mini-image" src="'+prefixe_image+'/img_previz.png" onclick="recuperer_details_plateforme(\''+r+"')\"></span>";var a=document.createElement("div");a.innerHTML=n;while(a.firstChild)t.appendChild(a.firstChild);var s=recuperer("mon_type").split("_")[0];if(s!=="Eleves"){var o='<span><img alt="remarque" class="envoi_remarque mini-image" src="'+prefixe_image+'/img_remarque.png" onclick="emettre_avis(\''+r+"','"+u+"')\"></span>";var _=document.createElement("div");_.innerHTML=o;while(_.firstChild)t.appendChild(_.firstChild)}if(e["nombre_avis"]>0){var l='<span><img alt="autres avis" class="envoi_remarque mini-image" src="'+prefixe_image+'/img_details.png" onclick="recuperer_autres_avis(\''+r+"')\"></span>";var c=document.createElement("div");c.innerHTML=l;while(c.firstChild)t.appendChild(c.firstChild)}})}function recuperer_details_plateforme(e){dupliquer_visualisation(e);ajouter_bilan_a_la_fenetre();actualiser_bilan(e)}function dupliquer_visualisation(e){var i='<div class="ma_fenetre" id="fenetre_bis" style="visibility: visible; opacity:95%; top: 0px; left: 0px; width: 99%; height: 99%;"><div id="entete-fenetre" style="display: inline-flex;float: right;"><img alt="X" src="'+prefixe_image+'/quitter.png" id="bye_prev_bis" onclick="quitter_previsualisation_bis()" style="width: 30px; height: 30px; cursor: pointer; position: fixed; z-index: 3; top: 0px; left: 673px;"></div><div class="titre_fenetre" id="titre_fenetre_bis">Détails sur '+e+'</div><div class="fullscreen-btn" id="conteneur_plein_ecran_bis"> <img alt="plein écran" style="position: fixed;" id="pleinecran_bis" src="'+prefixe_image+'/img_petitecran.png" onclick="switch_mode_bis()" class="pleinecran"> </div></div>';var r=document.createElement("div");r.innerHTML=i;while(r.firstChild){document.body.appendChild(r.firstChild)}ajuster_boutons_fenetre(true);initialisation_bouton(true);choisir_height_viz_si_pdf()}function ajouter_bilan_a_la_fenetre(){$("#viz1595565163988").remove();var e="<div class='tableauPlaceholder previz'  id='viz1595565163988' style='position: relative;'>    <noscript>        <a href='#'>            <img alt=' ' src='https:&#47;&#47;public.tableau.com&#47;static&#47;images&#47;H4&#47;H4GNP92BT&#47;1_rss.png' style='border: none' />        </a>    </noscript>    <object class='tableauViz'  style='display:none;'>        <param name='host_url' value='https%3A%2F%2Fpublic.tableau.com%2F' />        <param name='embed_code_version' value='3' />         <param name='site_root' value='' />        <param name='name' value='Bilanplateforme&#47lve' />        <param name='tabs' value='yes' />        <param name='toolbar' value='yes' />=        <param name='animate_transition' value='yes' />        <param name='display_static_image' value='no' />        <param name='display_spinner' value='yes' />        <param name='display_overlay' value='yes' />        <param name='display_count' value='yes' />        <param name='language' value='fr' />        <param id='filtre_identifiant' name='filter'/>    </object></div>   ";var i=document.createElement("div");i.innerHTML=e;var r=element_DOM("fenetre_bis");r.appendChild(i.firstChild)}function actualiser_bilan(e){var i=element_DOM("viz1595565163988");var r=i.getElementsByTagName("object")[0];element_DOM("filtre_identifiant").value="Identifiant="+e;r.style.width="100%";r.style.height="100%";var t=document.createElement("script");t.src="https://public.tableau.com/javascripts/api/viz_v1.js";r.parentNode.insertBefore(t,r);$("#fenetre_bis")[0].style.display=""}function emettre_avis(e,i){var r='<div class="mini_popup" id="mini_popup"><div id="entete-fenetre" style="display: inline-flex;float: right;"><img alt="X"  src="'+prefixe_image+'/quitter.png" id="bye_prev" onclick="$(\'#mini_popup\').remove()" style="width: 30px; height: 30px;cursor:pointer;position:fixed;z-index:3;transform: translate(-50%, -50%);"> </div><div>Vos observations sur <b>'+e+'</b>:</div><textarea id="observation" style="width: 80%;resize: none;font-size: 13px;margin-bottom: 5%;"></textarea><div style="">Passage de <b>'+e+'</b> en classe supérieure:</div><select style="width: 80%;border-color: red;border-style: solid;margin-bottom: 5%;" id="avis_passage" value=""><option value=""></option><option value="Favorable">Favorable</option><option value="Non favorable">Non favorable</option></select><button type="button" class="rendre sekooly-mode-background" onclick="envoyer_avis_conseil(\''+e+"','"+i+"')\">Envoyer l'avis</button></div>";var t=document.createElement("div");t.innerHTML=r;while(t.firstChild)document.body.appendChild(t.firstChild);$("#avis_passage").on("change",function(e){if(e.target.value==="Favorable"){$("#avis_passage")[0].style.borderColor="green"}else{$("#avis_passage")[0].style.borderColor="red"}})}function envoyer_avis_conseil(e,r){var i=$("#avis_passage")[0].value;var t=$("#observation")[0].value;if(i==="")return-1;var n=JSON.parse(recuperer("mes_matieres"));var a=recuperer("mon_type").split("_")[0];if(a.includes("Eleves"))var r=JSON.parse(recuperer("mes_donnees"))["Classe"];var s="";var o="";n.some(function(e,i){if(e["Classe"]===r){s=e["classe_id"];o=e["Matiere"];return-1}});var _=recuperer("identifiant_courant").toLowerCase().trim();e=e.toLowerCase().trim();nouvel_avis_conseil={Classe:r,id_classe_eleve:s,avis_passage:i,identifiant_remarque:_,identifiant_eleve:e,observation:t,matiere:o,horodateur:maintenant()};ajouter_un_element("Conseil",nouvel_avis_conseil).then(()=>{url=racine_data+"Eleves?Identifiant=eq."+e+"&"+apikey;nb_actuel=get_resultat(url)[0]["nombre_avis"];nouvelle_donnee_eleve={nombre_avis:nb_actuel+1};actualiser("Eleves","Identifiant",e,nouvelle_donnee_eleve).then(()=>{$("#mini_popup").remove();recuperer_la_fiche_conseil(r);chargement(false)})})}async function recuperer_autres_avis(e){var i=await rechercher("Conseil","identifiant_eleve",e.toLowerCase(),"");if(i.length>0)afficher_toutes_les_observations(i,e)}function afficher_toutes_les_observations(e,i){$("#ensemble_observations").remove();var r="<div id='ensemble_observations'></div>";var t=document.createElement("div");t.innerHTML=r;element_DOM(i).appendChild(t.firstChild);e=e.sort(function tri_ordre_chrono_decroissant(e,i){return convertir_en_date(e.horodateur)-convertir_en_date(i.horodateur)});e.forEach(function(e,i){var r=e["avis_passage"]==="Favorable"?"✅":"❌";var t=e["identifiant_remarque"].toUpperCase()===recuperer("identifiant_courant").toUpperCase()?" (Vous)":e["matiere"]?" ("+e["matiere"]+")":"";une_observation='<div style="color:black;font-size:10px;padding:5px;">'+r+'<b class="sekooly-mode">'+e["identifiant_remarque"].toUpperCase()+t+": </b>"+e["observation"]+'<i class="date_fin"> '+afficher_date(e["horodateur"])+"  </i></div>";$("#ensemble_observations").append(une_observation)})}function recuperer_MA_fiche_conseil(){var e=recuperer("identifiant_courant").trim().toUpperCase();element_DOM("fenetre").style.overflowY="auto";vider_fenetre("Vos résultats");$("#fenetre").append('<div style="text-align:center;margin-top: 20px;margin-left: 20px;"><b  class="sekooly-mode"  style="margin-bottom: 5px;" id="'+e+'">'+e+" </b></div>");var i=element_DOM(e);var r='<span><img alt="voir"  class="envoi_remarque mini-image" src="'+prefixe_image+'/img_previz.png" onclick="recuperer_details_plateforme(\''+e+"')\"></span>";var t=document.createElement("div");t.innerHTML=r;while(t.firstChild)i.appendChild(t.firstChild);recuperer_autres_avis(e);afficher_fenetre(true)}function aide_devoirs(){alerte="CONSIGNES POUR METTRE EN LIGNE UN DEVOIR: \n";alerte=alerte+"• Pour un quiz, il suffit dy répondre en ligne et d'enregistrer vos réponses. Une fois tout validé, vous ne pourrez plus modifier vos réponses.\n";alerte=alerte+'• Vous pouvez rendre uniquement un devoir lorsque l\'enseignant a catégorisé un fichier de "Devoir" ou "Examen".\n';alerte=alerte+"• Pour rendre un devoir, choisissez le sujet que l'enseignant aura mis en ligne.\n";alerte=alerte+"• Pour un même devoir, si vous avez plusieurs images, cliquez sur 'Ajouter une page' et choissisez le fichier IMAGE à rajouter.\n";alerte=alerte+"• Vérifiez bien l'ordre des images car cela sera pris en compte dans l'image finale générée, que pouvez voir en aperçu ci-dessous.\n";alerte=alerte+"• Si vous êtes sur ordinateur, vous pouvez également créer un fichier word et y coller toutes vos images. Les fichiers word (doc / docx) sont également supportés par Sekooly.";alert(alerte)}function afficher_tous_les_fichiers_deja_recup(){$("#alerte_vide").remove();afficher_le_drive(true);Array.from($(".span_un_fichier")).forEach(function(e,i,r){element_DOM(e.id).style.display="grid"});Array.from(document.getElementsByClassName("ma_liste")).forEach(function(e,i,r){element_DOM(e.id).style.display="grid"});Array.from($(".titre_drive")).forEach(function(e,i,r){element_DOM(e.id).style.display="initial"});return 0}function afficher_fenetre_rendudevoir(e){if(e){element_DOM("rendu_devoir").style.visibility="visible";initialisation_choix_devoir()}else{element_DOM("rendu_devoir").style.visibility="hidden"}}function initialisation_choix_devoir(){supprimer_div_devoir_choisi();supprimer_rendus_devoirs_affiches();element_DOM("soumettre_devoir").style.display="none";$("#remarque_prof").remove();$("#note_rendu").remove();les_devoirs=element_DOM("drive_devoirs").childNodes;les_examens=element_DOM("drive_examens").childNodes;les_quiz=element_DOM("drive_quiz").childNodes;la_liste_devoirs=element_DOM("devoir_choisi");la_liste_devoirs.innerHTML='<option value="--">--</option>';element_DOM("devoir_choisi").style.borderColor="";for(var e=0;e<les_devoirs.length;e++){var i=les_devoirs[e]["id"];var r=$("span#"+i+".span_un_fichier").contents().filter(function(){return this.nodeType==3})[0].nodeValue;var t='<option value="'+i+'">'+r+"</option>";var n=document.createElement("div");n.innerHTML=t;la_liste_devoirs.appendChild(n.firstChild)}for(var e=0;e<les_examens.length;e++){var a=les_examens[e]["id"];var r=$("span#"+a+".span_un_fichier").contents().filter(function(){return this.nodeType==3})[0].nodeValue;var s='<option value="'+a+'" examen="oui">'+r+"</option>";var o=document.createElement("div");o.innerHTML=s;la_liste_devoirs.appendChild(o.firstChild)}for(var e=0;e<les_quiz.length;e++){var _=les_quiz[e]["id"];var r=$("span#"+_+".span_un_fichier").contents().filter(function(){return this.nodeType==3})[0].nodeValue;var s='<option value="'+_+'">'+r+"</option>";var o=document.createElement("div");o.innerHTML=s;la_liste_devoirs.appendChild(o.firstChild)}$("#devoir_choisi").on("change",function(e){supprimer_div_devoir_choisi();supprimer_rendus_devoirs_affiches();afficher_soumettre_devoir(false);changer_couleur_devoir("");$("#remarque_prof").remove();$("#note_rendu").remove();if(recuperer("mon_type")==="Eleves"){if(e.target.value!=="--"){var i=e.target.options[e.target.selectedIndex].getAttribute("examen");var r=$("[id="+e.target.value+"].span_un_fichier")[0].attributes["ma_date_effet"].value;var t=$("[id="+e.target.value+"].span_un_fichier")[0].attributes["mon_heure_effet"].value;nb_heures_delai_examen=data_etablissement["nb_heures_delai_examen"]||12;var n=moment(r+" "+t,"yyyy-MM-DD hh:mm").add(nb_heures_delai_examen,"hours")._d;var a=i&&moment(maintenant())>n;if(i==="oui"&&fichier_ouvrable(e.target.value,false)===false&&a===false){alert("Vous ne pouvez pas encore rendre cet examen dont la date d'effet est le "+afficher_date_old(r,true));e.target.value="--"}else{recuperer_mon_devoir(e.target.value,recuperer("identifiant_courant"),a,n)}$("#bouton_rendre_devoir")[0].innerText=i==="oui"?"Rendre l'examen":"Rendre le devoir"}}else{if(e.target.value!=="--"){recuperer_mon_devoir(e.target.value,"")}}})}function recuperer_mon_devoir(o,e,_,l){chargement(true);supprimer_div_devoir_choisi();supprimer_rendus_devoirs_affiches();afficher_soumettre_devoir(false);changer_couleur_devoir("");$("#remarque_prof").remove();$("#note_rendu").remove();if(recuperer("mon_type")==="Eleves"){element_DOM("rendu_devoir").style.height="";rechercher("Rendus","id_devoir",o+suite_notif(),"").then(e=>{chargement(false);donnees_initiales=e[0];if($("#devoir_choisi")[0].value!==o)return-1;if(donnees_initiales!==undefined){data=donnees_initiales["nom_fichier"];extension=data.split(".").pop();remarque=donnees_initiales["remarque"];id_fichier=extension==="quiz"?donnees_initiales["id_fichier_sujetdevoir"]:donnees_initiales["id_fichier"];changer_couleur_devoir("green");afficher_soumettre_devoir(false);supprimer_div_devoir_choisi();supprimer_rendus_devoirs_affiches();var i=document.createElement("div");var r=rfc3986EncodeURIComponent(data);var t=_?"":'<img alt="supprimer"  id="'+data+'" src="'+prefixe_image+'/img_trash.png" style="width:15px;height:15px;cursor:pointer;" onclick="supprimer_devoir(this)">';var n=donnees_initiales["date_publication"]===null?"  <i><gris>non terminé</gris></i>  ":"";i.innerHTML+='<div id="mon_devoir_rendu"> <div id="'+id_fichier+'">'+data+'<img class="mini-image" onclick="visualiser(\''+r+"','"+id_fichier+'\')" src="'+prefixe_image+'/img_previz.png" style="padding-left:1%">'+t+n+"</div></div>";$("#rendu_devoir").append(i.innerHTML);note_rendu=donnees_initiales["note_rendu"];if(note_rendu!==null){$("#note_rendu").remove();remarque=decodeURIComponent(remarque);var a='<div id="note_rendu" style="text-align: justify;padding: 2%;"><b style="color: #cc3a22;">Note attribuée:</b><br>'+note_rendu+"</div>";var s=document.createElement("div");s.innerHTML=a;element_DOM("rendu_devoir").appendChild(s.firstChild)}if(remarque.length>0){$("#remarque_prof").remove();remarque=decodeURIComponent(remarque);var a='<div id="remarque_prof" style="text-align: justify;padding: 2%;"><b style="color: #cc3a22;">Remarque du professeur:</b><br>'+remarque+"</div>";var s=document.createElement("div");s.innerHTML=a;element_DOM("rendu_devoir").appendChild(s.firstChild)}}else{if(_){alert("Rendre cet examen n'est plus possible depuis le "+moment(l).format("DD/MM/YYYY HH:mm")+".")}else{changer_couleur_devoir("red");supprimer_div_devoir_choisi();supprimer_rendus_devoirs_affiches();gerer_affichage_quiz_devoir(o)}}})["catch"](e=>{console.error(e);alert("Sujet de devoir introuvable.");chargement(false)})}else{rechercher("Rendus","id_fichier_sujetdevoir",o,"").then(e=>{e=e.filter(e=>e["date_publication"]);chargement(false);afficher_rendus_devoirs(e)})}$("#recuperer_devoir").remove()}function gerer_affichage_quiz_devoir(e){var i=$('[value="'+e+'"]').text().split(".").pop()==="quiz";if(i&&!element_DOM("mon_devoir_rendu")){element_DOM("soumettre_devoir").style.display="none";element_DOM("soumettre_quiz").style.display="block"}else{element_DOM("soumettre_quiz").style.display="none";element_DOM("soumettre_devoir").style.display=""}}function nom_du_devoir_choisi(){return $('[value="'+element_DOM("devoir_choisi").value+'"]').text()}function afficher_rendus_devoirs(e){if(!element_DOM("liste_des_devoirs_rendus")){var i=document.createElement("div");i.id="liste_des_devoirs_rendus";element_DOM("rendu_devoir").appendChild(i)}else{var i=element_DOM("liste_des_devoirs_rendus")}if(e.length===0)element_DOM("rendu_devoir").style.height="auto";if(e.length===0)return i.innerHTML='<i class="date_fin">Pas encore de rendus pour ce devoir/examen/quiz.</i>';e.sort(function tri_ordre_chrono_decroissant(e,i){return new Date(e[0]).getTime()-new Date(i[0]).getTime()});i.innerHTML="";var r=nom_du_devoir_choisi().split(".").pop()==="quiz";for(var t=0;t<e.length;t++){var n=document.createElement("div");n.id=e[t]["id_fichier"];n.style="padding: 0.5%;";n.innerHTML="Devoir de ";n.innerHTML+='<b  class="sekooly-mode" id="proprietaire'+e[t]["id_fichier"]+'">'+e[t]["proprietaire"].toUpperCase()+" </b>";var a=decodeURIComponent(e[t]["remarque"]);a=JSON.stringify(a).replace(/&/,"&amp;").replace(/"/g,"");a=a.replace(/'/g,"\\'");if(a.length>0){note_si_existante=e[t]["note_rendu"]?e[t]["note_rendu"]+"\n\n":"";n.innerHTML+='<span id="correction_ok"><span class="correction_ok" style="font-size: 8px;color: #5ac55a;font-weight: bold;font-style: italic;" onmouseover="afficher_mon_indication(this)" onmouseout="masquer_mon_indication(this)">Corrigé</span><span class="indication" style="margin-top:5%;">'+note_si_existante+a+"</span></span>"}var s=rfc3986EncodeURIComponent(e[t]["nom_fichier"].trim());var o=" ("+e[t]["proprietaire"].trim().toUpperCase()+")";var _=e[t]["coefficient_rendu"];var l=e[t]["note_rendu"];n.innerHTML+='<img alt="voir"  class="mini-image" src="'+prefixe_image+'/img_previz.png" onclick="visualiser(\''+s+"','"+n.id+"', '"+o+"')\">";n.innerHTML+='<img alt="remarque" class="mini-image envoi_remarque" onclick="mettre_remarque_devoir(this,\''+a+"',"+_+","+l+');" src="'+prefixe_image+'/img_remarque.png">';n.innerHTML+=r?"":'<a   id="telechargement" href = "https://drive.google.com/uc?export=download&id='+n.id+'" download="mon_fichier.txt"><img alt="télécharger" class="mini-image" src="'+prefixe_image+'/img_download.png"></a>';n.innerHTML+='<i class="date_fin">'+afficher_date(e[t]["date_publication"])+"  </i>";i.appendChild(n)}if(element_DOM("rendu_devoir").offsetHeight>screen.height){element_DOM("rendu_devoir").offsetHeight="90%"}}function mettre_remarque_et_note(t,e,n,a){$("#remarque_et_note").remove();html_a_ajouter=fenetre_remarque_note(t,a?a:0,e);$("body").append(html_a_ajouter);if(Number(n)===0){$("#champ_note").remove()}$("#envoyer_note").on("click",function(e){if(Number(n)>0)a=$("#note_rendu")[0].value;remarque_prof=$("#remarque")[0].value;$("#remarque_et_note").remove();chargement(true);remarque_prof=encodeURIComponent(remarque_prof);nom_table="Rendus";nom_champ_reference="id_fichier";valeur_champ_reference=t;if(Number(n)>0){nouvelle_remarque={note_rendu:a,remarque:remarque_prof}}else{nouvelle_remarque={remarque:remarque_prof}}actualiser(nom_table,nom_champ_reference,valeur_champ_reference,nouvelle_remarque);if(remarque_prof.length>0){nouvelles_donnees_notif={Date_derniere_modif:maintenant(),Identifiant_derniere_modif:recuperer("identifiant_courant"),Role_derniere_modif:mon_role};var i=$("#proprietaire"+t)[0].innerText;var r=$("#devoir_choisi")[0].value+"-"+i.trim().toLowerCase().replace(".","");actualiser("Notifs","id_notif",r,nouvelles_donnees_notif)}setTimeout(function(){quitter_previsualisation();quitter_previsualisation_bis();recuperer_mon_devoir(element_DOM("devoir_choisi").value)},2e3);chargement(false)})}function fenetre_remarque_note(e,i,r){nom_proprio_devoir=$("#proprietaire"+e)[0].innerText.trim().toUpperCase();return'<div class="ma_fenetre" id="remarque_et_note" style="visibility: visible;height: 33%;width: 280px;height: 300px;top: 35%;left: 10%;"><b style="text-align: center;"><div id="titre_fenetre" class="">Note et remarque de '+nom_proprio_devoir+' </div></b><span style=""><form id="mon_formulaire" autocomplete="off" class="edition">\t<div id="champ_note"><label id="label" for="note_rendu">Note (sur 20)</label><input type="number" min=0 max=20 step=0.125 id="note_rendu" maxlength="2" style="width: 100%;" value="'+i+'"></div><br><label id="label" for="remarque">Votre remarque</label><textarea id="remarque" maxlength="300" style="width: 100%;resize: none;font-size: 13px;height: 50%;">'+r+'</textarea><div id="mes_boutons" style="text-align: center;padding: 1%;display: block ruby;"><button class="bouton_sekooly sekooly-mode-background" type="button" id="Annuler" onclick="$(\'#remarque_et_note\').remove()"> Annuler </button><button  class="bouton_sekooly sekooly-mode-background" type="button" id="envoyer_note">Valider</button></div></form></span></div>'}function mettre_remarque_devoir(e,i,r,t){var n=i.replace(/&quot;/g,'"');n=decodeURIComponent(n);var a=e.parentNode.id;var s=recuperer("identifiant_courant");var o=mettre_remarque_et_note(a,n,r,t)}async function supprimer_devoir(e,i,r){if(i){var t=i}else{var t=e.parentNode.id}var n=$("#devoir_choisi")[0].value+suite_notif();if(r)n=r;if(i||r){var a=true}else{var a=window.confirm("Êtes vous sûr de vouloir supprimer ce rendu de devoir?")}if(!a)return-1;stocker("id_devoir",n);chargement(true);if(nom_du_devoir_choisi().split(".").pop()==="quiz"){return await suppression_devoir_sur_db("Votre tentative du quiz a été supprimée.")}var s="https://script.google.com/macros/s/AKfycbw_04bdiepfQ0P9Ddtn6nyRPjxzxumORN4J8xm7bnmu7yO3HvQ/exec";var o=i||r?"API_KEY_DELETE":"API_KEY_DEVOIR";var _='<form method="post"  action="'+s+'" id="supprimer_devoir" style="display: none;" >';_+='<input type="hidden" name="'+o+'" value="'+recuperer(o)+'" >';_+='<input type="hidden" name="id_fichier" value="'+t+'" >';_+="</form>";$("body").append(_);var l=$("#supprimer_devoir");$.ajax({type:"POST",url:s,data:l.serialize(),success:suppression_devoir_sur_db,error:erreur_suppression_devoir});$("#supprimer_devoir").remove()}async function suppression_devoir_sur_db(e){var i=recuperer("id_devoir");await supprimer("Rendus","id_devoir",i);await supprimer("Notifs","id_notif",i);effacer("id_devoir");afficher_alerte(e);setTimeout(function(){return recuperer_mon_devoir(element_DOM("devoir_choisi").value,recuperer("identifiant_courant"));chargement(false)},2e3)}function supprimer_div_devoir_choisi(){$(".mon_file_devoir").each(function(e,i){i.value=""});if(element_DOM("mon_devoir_rendu"))element_DOM("mon_devoir_rendu").remove()}function erreur_suppression_devoir(e){console.error(e);alert("Impossible de supprimer le rendu: vérifiez que vous êtes toujours connecté.");chargement(false)}function supprimer_rendus_devoirs_affiches(){if(element_DOM("liste_des_devoirs_rendus"))element_DOM("liste_des_devoirs_rendus").remove();vider_previz_devoir_rendu();$(".fichier_supplementaire").remove()}function afficher_soumettre_devoir(e){if(e){element_DOM("soumettre_devoir").style.display=""}else{element_DOM("soumettre_devoir").style.display="none";element_DOM("soumettre_quiz").style.display="none"}}function changer_couleur_devoir(e){element_DOM("devoir_choisi").style.borderColor=e}function rendre_devoir(){if(impossible_de_cliquer())return-1;var t=$("#devoir_choisi")[0].value;var e=$("#file_devoir")[0].value;if(t!=="--"&&e!==""){var n=$("#file_devoir")[0].files[0];var i=new FileReader;i.onprogress=function(e){chargement(true)};chargement(true);i.onload=async function(e){var i=await chercher_lien_script(4);var r={};if($("#soumettre_devoir > input").length>1){img_finale=await telecharger_tout(true);img_finale=img_finale.replace(/^.*,/,"");if(!img_finale){chargement(false);return false}else{r.file=img_finale}}else{r.file=e.target.result.replace(/^.*,/,"")}nom_fichier=n.name;coefficient_rendu=Number($("#"+t)[0].getAttribute("coefficient_rendu"));taille_fichier=n.size;extension=nom_fichier.split(".").pop().toUpperCase();id_dossier_sujetdevoir=recuperer("dossier_chargé");id_fichier_sujetdevoir=t;proprietaire=recuperer("identifiant_courant");mettre_devoir_en_ligne(i,r,nom_fichier,extension,id_dossier_sujetdevoir,id_fichier_sujetdevoir,proprietaire,coefficient_rendu,taille_fichier)};i.readAsDataURL(n)}}function mettre_devoir_en_ligne(e,i,t,r,n,a,s,o,_){var l='<form method="post"  action="'+e+'" id="form_rendu_devoir" style="display: none;" >';l+='<input type="hidden" name="API_KEY_DEVOIR" value="'+recuperer("API_KEY_DEVOIR")+'" >';l+='<input type="hidden" name="nom_fichier" value="'+t+'" >';l+='<input type="hidden" name="extension" value="'+r+'" >';l+='<input type="hidden" name="file" value="'+i.file+'" >';l+='<input type="hidden" name="dossier_rendus_cycle" value="'+recuperer("dossier_rendus_cycle")+'" >';l+='<input type="hidden" name="proprietaire" value="'+s+'" >';l+="</form>";$("body").append(l);$("#form_rendu_devoir").submit(function(e){e.preventDefault();var i=$(this);var r=i.attr("action");$.ajax({type:"POST",timeout:6e5,url:r,data:i.serialize(),success:function(e){if(e.includes("ERREUR")){afficher_alerte(e,false);return-1}setTimeout(function(){recuperer_mon_devoir(element_DOM("devoir_choisi").value,recuperer("identifiant_courant"))},2e3);date_heure_actuelle=maintenant();nom_table="Rendus";id_devoir=a+suite_notif();la_matiere=la_matiere_chargee("Matiere");nouveau_devoir={id_devoir:id_devoir,date_publication:date_heure_actuelle,id_dossier_sujetdevoir:n,id_fichier_sujetdevoir:a,id_fichier:e,nom_fichier:t,proprietaire:recuperer("identifiant_courant"),remarque:"",matiere_rendue:la_matiere,coefficient_rendu:o,taille_fichier:_};ajouter_un_element(nom_table,nouveau_devoir,id_devoir);nom_table="Notifs";mes_donnees=JSON.parse(recuperer("mes_donnees"));nouvelle_notif={id_notif:id_devoir,Horodateur:date_heure_actuelle,Type_notif:"devoir",Id_source:a,"Intitulé":t,Identifiant_originaire:recuperer("identifiant_courant"),Role_originaire:"Eleve",Identifiant_derniere_modif:recuperer("identifiant_courant"),Role_derniere_modif:"Eleve",Classe:mes_donnees["Classe"],Classe_matiere:"("+mes_donnees["Classe"]+"|"+la_matiere+")",Id_classe_matiere:recuperer("dossier_chargé"),Date_derniere_modif:date_heure_actuelle,Cycle:mes_donnees["Cycle"]};ajouter_un_element(nom_table,nouvelle_notif,id_devoir);afficher_alerte("Votre rendu a bien été mis en ligne.",false);chargement(false)},error:function(e){chargement(false);e=JSON.parse(e);console.error(e);afficher_alerte("Votre fichier est trop lourd à mettre en ligne, merci de réduire leur taille avant de les mettre en ligne.",false)},done:function(e){chargement(false)}})});$("#form_rendu_devoir").submit();$("#form_rendu_devoir").remove()}function retourner_site(){vider_fenetre("Sekooly");visualiser("Tutoriels d'utilisation.docx","1HnsoX5_NQGhJ34WZ68p9SPvZ30jn4gKpf_cQjz2ZyUo",false,"Tutoriels d'utilisation");$("#telechargement").remove();afficher_fenetre(true)}function afficher_alerte(e,i){var r=element_DOM("snackbar");r.innerHTML=e;r.className="show";setTimeout(function(){r.className="";if(i)location.reload()},3e3)}function afficher_modif_profil(){quitter_previsualisation();vider_fenetre("Votre profil");var e=JSON.parse(recuperer("mes_donnees"));var i=mon_detail("Photo de profil",ma_photo());var r=mon_detail("Niveau XP",calculer_mes_XP());var t=mon_detail("Identifiant",e["Identifiant"]);var n=mon_detail("Nom",e["Nom"]);var a=mon_detail("Prénom(s)",e["Prénom(s)"]);var s=recuperer("mon_type");var o=s.includes("Admin")?e["Role"]:s.substring(0,s.length-1);var _=mon_detail("Rôle du profil",o);var l=e["Classe"].replace(/;/g,"<br>");l=l.replace(/\(/g,"");l=l.replace(/\)/g,"");l=l.replace(/\|/g,", ");var c=mon_detail("Classe(s)",l);var u=mon_detail("Telephone",e["Telephone"]);var d=mon_detail("Code d'accès",e["Code"],true);var m='<span id="les_boutons" style="text-align: center;position: relative;display: block;"><button class="rendre sekooly-mode-background" type="button" id="annuler_modifs" onclick="quitter_previsualisation()"> Annuler </button><button class="rendre sekooly-mode-background" type="button" id="valider_modifs" onclick="switch_edition()">Enregistrer</button></span>';var f='<div id="mes_details" class="mes_details">'+i+r+t+n+a+_+c+u+d+"</div>"+m;var p=document.createElement("div");p.innerHTML=f;while(p.firstChild)element_DOM("fenetre").appendChild(p.firstChild);mode_edition(false,true);afficher_fenetre(true)}function bouton_supprimer_pp(e){e=e?e:recuperer("identifiant_courant");return'<img id="suppr_pp" onclick="supprimer_pp(\''+e+'\')" class="editer" src="'+prefixe_image+'/img_trash.png" alt="supprimer">'}function bouton_modifier_pp(e){e=e?e:recuperer("identifiant_courant");return'<span class="pp-upload"><label for="pp-'+e+'"><img src="'+prefixe_image+'/img_edit.png" alt="MODIFIER" class="editer"></label><input onchange="changer_pp(\''+e+'\')" accept=".png,.jpeg,.jpg,.bmp,.svg,.gif" id="pp-'+e+'" type="file"/> </span>'}function ma_photo(e,i){chargement(true);var r="Fichiers";url=racine_data+r;url+="?proprietaire=eq."+(e||recuperer("identifiant_courant"));url+="&categorie_fichier=eq.Profil";url+="&"+apikey;id_pp=get_resultat(url)[0];if(id_pp)id_pp=id_pp["id_fichier"];le_lien_pp=lien_pp(id_pp);supprimer_si_pp_existante=id_pp?i?"":bouton_supprimer_pp():"";bouton_modifier=i?"":bouton_modifier_pp();chargement(false);return"<img class='pp' id='pp_"+(e||recuperer("identifiant_courant"))+"' src="+le_lien_pp+">"+bouton_modifier+supprimer_si_pp_existante}var basic_croppie;var donnees_pp;var extension_pp="";async function url_pp(){var e=await chercher_lien_script(8);return e}async function supprimer_pp(r,t){if(!t)var e=confirm("⚠️Voulez-vous supprimer cette photo de profil ? Cette action est irréversible.");if(e||t){chargement(true);r=r?r:recuperer("identifiant_courant");var i=await url_pp();i+="?supp_mon_id_pp=true";i+="&nom_etablissement="+data_etablissement["nom_etablissement"];i+="&identifiant="+r;i+="&supp_mon_id_pp=true";return get_resultat_asynchrone(i).then(function(e){if(!t)afficher_alerte(e);nom_table="Fichiers";var i=racine_data+nom_table+"?proprietaire=eq."+r;i+="&categorie_fichier=eq.Profil";i+="&"+apikey;return delete_resultat_asynchrone(i).then(function(){$("[id='pp_"+r+"']")[0].src=prefixe_image+"/default-user.svg";$("#suppr_pp").remove();if(!t)chargement(false)})})}}function changer_pp(e){var i=new FileReader;e=e?e:"";creer_mini_popup("","<div id='nouvelle_pp' style='overflow: hidden;width: 300px;height:300px;'></div>","Valider la photo","envoyer_pp('"+e+"')");basic_croppie=$("#nouvelle_pp").croppie({viewport:{width:200,height:200,type:"circle"},boundary:{width:300,height:200},enableExif:true});i.onload=function(e){chargement(false);donnees=i.result;basic_croppie.croppie("bind",{url:donnees,points:[77,469,280,739]})};extension_pp=$("[id='pp-"+e+"']")[0].files[0].name.split(".").pop();chargement(true);i.readAsDataURL($("[id='pp-"+e+"']")[0].files[0])}async function envoyer_pp(t){chargement(true);url=await url_pp();t=t?t:recuperer("identifiant_courant");supprimer_pp(t,true).then(function(){basic_croppie.croppie("result",{type:"canvas",size:"viewport"}).then(function(r){$("#mini_popup").remove();data={nom_etablissement:data_etablissement["nom_etablissement"],identifiant:t,API_KEY_UPLOAD:recuperer("API_KEY_UPLOAD"),API_KEY_DEVOIR:recuperer("API_KEY_DEVOIR"),extension:extension_pp,file:r.replace(/^.*,/,"")};post_resultat_asynchrone(url,data).then(function(e){afficher_alerte(e.split("|")[0]);id_pp=e.split("|")[1].trim();date_heure_aujourdhui=maintenant();nom_table="Fichiers";mes_donnees={id_fichier:id_pp,categorie_fichier:"Profil",proprietaire:t,nom_fichier:t+"."+extension_pp,date_effet:moment(date_heure_aujourdhui).format("YYYY-MM-DD"),id_dossier:"pp",est_telechargeable:"non",date_publication:date_heure_aujourdhui,taille_fichier:$("[id='pp-"+t+"']")[0].files[0].size};var i=racine_data+nom_table+"?"+apikey;post_resultat_asynchrone(i,mes_donnees).then(function(){$("[id='pp_"+t+"']")[0].src=r;if($("#suppr_pp").length===0)$("#Photo").append(bouton_supprimer_pp())});chargement(false)})})})}function calculer_mes_XP(){return"En cours de construction."}async function switch_edition(){var e=$("#valider_modifs")[0].innerText==="Enregistrer";if(!e){var i=await recuperer_mes_donnees();var r=prompt("Indiquez votre code d'accès ACTUEL:");if(!r)return afficher_alerte("Modification du profil annulée.");if(!i)return afficher_alerte("Vous devez être connecté à internet pour modifier votre profil.");if(code_ok(i,r)){mode_edition(true)}else{if(r!==null)afficher_alerte("Le code d'accès est erroné, impossible de modifier votre profil.")}}else{nom_champ="Code";valeur_champ=hasher($("#Code")[0].value);nouveau_data={[nom_champ]:valeur_champ,code_hash:"ok"};mettre_a_jour(nom_champ,valeur_champ)}}function mettre_a_jour(e,r){actualiser(recuperer("mon_type"),"Identifiant",recuperer("identifiant_courant"),nouveau_data);var t=JSON.parse(recuperer("mes_donnees"));e.split(",").forEach(function(e,i){t[e]=r.split(",")[i]});stocker("mes_donnees",JSON.stringify(t));afficher_alerte("Votre profil a été mis à jour.");mode_edition(false);chargement(false)}function mode_edition(e,i){if(!i){var r=e?"input":"";changer_element("Code",r,true)}var t=e?"Enregistrer":"Modifier";$("#valider_modifs")[0].innerText=t}function changer_element(e,i,r){var t=i==="input"?$("#"+e)[0].innerText:r?"•".repeat($("#"+e)[0].value.length):$("#"+e)[0].value;var n=r?'type="password"':"";var a=i==="input"?'<input id="'+e+'" value="'+t+'" '+n+">":'<span id="'+e+'">'+t+"</span>";var s=document.createElement("div");s.innerHTML=a;var o=$("#"+e)[0].parentNode;$("#"+e).remove();while(s.firstChild)o.appendChild(s.firstChild);if(i==="input"){$("#"+e)[0].value=JSON.parse(recuperer("mes_donnees"))["Code"];$("#"+e)[0].select();$("#"+e)[0].value="";$("#Code").keypress(function(e){if(e.charCode===13)switch_edition();if(e.charCode===38||e.charCode===44||e.charCode===39||e.charCode===34||e.charCode===32){afficher_alerte("Le symbole ' "+String.fromCharCode(e.charCode)+" ' est interdit.");return false}})}}function mon_detail(e,i,r){if(r)i="•".repeat(i.length);var t='<div class="un_detail"><b class="sekooly-mode">'+e+': </b><br><span id="'+e.split(" ")[0]+'">'+i+"</span></div>";return t}function sur_mobile_ou_tablette(){return window.innerWidth<=750||window.innerHeight<=750}function filtrer_date_effet(){afficher_tous_les_fichiers_deja_recup();var t=element_DOM("la_date_effet").value;$(".span_un_fichier").filter(function(e){var i=$(this)[0].attributes["ma_date_effet"].value;var r=i.includes(t);$(this)[0].style.display=r||t==="Tous"?"grid":"none";return $(this)[0].innerHTML.includes(t)});afficher_le_drive(true);garder_les_manuels();masquer_drive_vide()}function filtrer_chapitre(){afficher_tous_les_fichiers_deja_recup();var a=element_DOM("filtre_id_chapitre").value;$(".span_un_fichier").filter(function(e,i){var r=$(this)[0].attributes["id_chapitre"].value;var t=r.includes(a);var n=t||a==="Tous"?"grid":"none";i.style.display=n;return i.innerHTML.includes(a)});afficher_le_drive(true);garder_les_manuels();masquer_drive_vide()}function rfc3986EncodeURIComponent(e){return encodeURIComponent(e).replace(/[!'()*]/g,escape)}function afficher_tri_fichiers(e){element_DOM("span_date_effet").style.display=e?"block":"none"}function afficher_visio(e){element_DOM("visioconference").style.display=e?"block":"none"}function afficher_choix_date(e){if(e){element_DOM("choix_date").style.display="grid"}else{element_DOM("choix_date").style.display="none"}}function afficher_choix_coef(e){if(e){element_DOM("coef_rendu").style.display=""}else{element_DOM("coef_rendu").style.display="none"}}function afficher_ou_non_choix_fichier(e,i){if(impossible_de_cliquer()&&!i)return-1;if(e&&!recuperer("mon_type").includes("Admin")&&element_DOM("accueil_utilisateur").innerText.includes("Vie scolaire")){alert("Vous n'avez pas les droits pour publier un fichier dans la Vie Scolaire.");return-1}image_temporaire="";nom_image_temporaire="";est_deja_affiche=element_DOM("choix_popup").style.visibility==="visible";if(est_deja_affiche||!e){element_DOM("choix_popup").style.visibility="hidden";if(!i){afficher_choix_date(false);afficher_choix_coef(false)}}else{var r=true;if(!r){alert("Impossible de mettre en ligne des fichiers du lundi 1er au dimanche 7 Juin 2020.");return-1}afficher_fenetre(false);afficher_ou_non_choix_fichier(false);mode_bulletin(false);element_DOM("choix_popup").style.visibility="visible";element_DOM("file").value="";element_DOM("categorie_choisie").value="--";element_DOM("la_date_limite").value="";element_DOM("date_effet_fichier").value=moment().format("yyyy-MM-DD");element_DOM("heure_effet").value="";element_DOM("lheure_limite").value="";element_DOM("id_chapitre").value="--";element_DOM("est_video_youtube").checked=false;element_DOM("est_extrait_manuel").checked=false;element_DOM("est_telechargeable").checked=true;afficher_checkbox("choix_extrait_manuel",les_manuels_de_la_matiere()!=="");mode_fichier_initialement();element_DOM("coef").value=0;element_DOM("mode-non-quiz").style.display="grid";element_DOM("mode-quiz").style.display="none";afficher_choix_date(false);afficher_choix_coef(false)}}function afficher_mon_indication(e){e.parentNode.childNodes[1].style.visibility="visible"}function masquer_mon_indication(e){e.parentNode.childNodes[1].style.visibility="hidden"}function impossible_de_cliquer(){return element_DOM("img_chargement").style.visibility==="visible"}function deconnexion(){chargement(true);var e="";mon_role=init_mon_role();tout_effacer_sauf(["identifiant_courant","mode_nuit_oui","notifs_sans_actualiser","date_heure_depassement"]);image_temporaire="";nom_image_temporaire="";supprimer_tous_les_parametres();setTimeout(function(){location.href="/"},1e3);envoyer_log(recuperer("identifiant_courant"),"Deconnexion",e,mon_role)}function recuperer_devoirs(e){if(!recuperer("dossier_chargé"))return-1;if(impossible_de_cliquer())return-1;afficher_fenetre(false);var i=element_DOM("rendu_devoir").style.visibility==="visible";if(e)i=false;afficher_fenetre_rendudevoir(!i)}function afficher_devoirs(e){if(e){element_DOM("a-rendre").style.visibility="visible"}else{element_DOM("a-rendre").style.visibility="hidden"}}function trier_par_identifiant(e,i){var r=e.Identifiant.toLowerCase();var t=i.Identifiant.toLowerCase();return r<t?-1:r>t?1:0}function recuperer_profs(t){var n=JSON.parse(recuperer("mes_matieres")).map(e=>e["Classe_Matiere"]).sort();var a=[];url=racine_data+"Trombinoscope_profs"+"?"+apikey;return get_resultat_asynchrone(url).then(function(e){var i=e.sort(trier_par_identifiant);if(recuperer("mon_type")==="Eleves"){n.forEach(function(r,e){le_prof=i.filter(e=>e["Classe"].includes(r));if(le_prof.length>0){le_prof.forEach(function(i){a_ajouter=a.filter(e=>e["Identifiant"]===i["Identifiant"]).length===0;i["Classe"]=r;if(a_ajouter)a.push(i)})}})}else{a=i}if(t){chargement(false);return a}else{var r="Liste de vos professeurs";vider_fenetre(r);traitement_trombino(a,true);afficher_fenetre(true)}})}function recuperer_admin(r){if(impossible_de_cliquer())return-1;chargement(true);var e=JSON.parse(recuperer("mes_donnees"))["Cycle"];nom_table="Trombinoscope_admin";nom_champ_reference="Cycle";valeur_champ_reference=e;nom_champ_a_chercher="";return rechercher(nom_table,nom_champ_reference,valeur_champ_reference,nom_champ_a_chercher).then(e=>{if(r){chargement(false);return e}else{var i="Membres de l'Administration - "+valeur_champ_reference;vider_fenetre(i);afficher_fenetre(true);traitement_trombino(e,true,true);chargement(false)}})["catch"](e=>{console.error(e);alert("Cycle introuvable, veuillez réessayer.");chargement(false)})}function recuperer_eleves(r){if(impossible_de_cliquer())return-1;if(!recuperer("mon_type").includes("Admin")&&element_DOM("accueil_utilisateur").innerText.includes("Vie scolaire")){alert("Vous n'avez pas les droits pour consulter cette liste.");return-1}chargement(true);var e=recuperer("mon_type").includes("Eleves")?JSON.parse(recuperer("mes_donnees"))["Classe"]:la_matiere_chargee("Classe");if(recuperer("mon_type")==="Administration"&&e==="classe_matiere_introuvable")e="Tous";var i=JSON.parse(recuperer("mes_donnees"))["Cycle"];nom_table="Trombinoscope";nom_champ_reference=e==="Tous"?"Cycle":"Classe";valeur_champ_reference=e==="Tous"?i:e;nom_champ_a_chercher="";return rechercher(nom_table,nom_champ_reference,valeur_champ_reference,nom_champ_a_chercher).then(e=>{if(r){chargement(false);return e}else{var i="Liste des élèves en "+valeur_champ_reference;vider_fenetre(i);afficher_fenetre(true);traitement_trombino(e,false);chargement(false)}})["catch"](e=>{console.error(e);alert("Classe introuvable, veuillez réessayer.");chargement(false)})}function recuperer_logs(){chargement(true);if(recuperer("mon_type")!=="Profs"){var e=JSON.parse(recuperer("mes_donnees"))["Classe"];var i="logs_classe";var r="Historique des connexions"}else{var e=la_matiere_chargee("Classe");var i="classe";var r="Liste des élèves en "+e}vider_fenetre(r);var t='<a id="telechargement" style="position: fixed;z-index:3;" href = "#"><img alt="télécharger" class="window-btn" id="telechargement" src="'+prefixe_image+'/img_download.png""></a>';var n=document.createElement("div");n.innerHTML=t;while(n.firstChild)element_DOM("entete-fenetre").appendChild(n.firstChild);ajuster_boutons_fenetre();ajuster_boutons_fenetre(true);choisir_height_viz_si_pdf();afficher_fenetre(true);var a="https://script.google.com/macros/s/AKfycbzEamQPPrrqUl-_ac8Ddqf0cfWq3hPqF1Z-5qJ0JI95w2ybULd8/exec";var s='<form method="post"  action="'+a+'" id="recuperer_logs" style="display: none;" >';s+='<input type="hidden" name="'+i+'" value="'+e+'" >';s+="</form>";$("body").append(s);var o=$("#recuperer_logs");$.ajax({type:"POST",url:a,data:o.serialize(),success:function(r){traitement_logs(r["resultats"]);if(element_DOM("telechargement")){element_DOM("telechargement").onclick=function(e){var i=convertir_csv(r["resultats"]);i=encodeURIComponent(i);console.log(i);telecharger("Historique_des_connexions",i)}}$("#recuperer_logs").remove()},error:function(e){console.log("erreur! "+e);alert("Vérifiez que vous êtes toujours connecté à internet.");chargement(false)}})}function telecharger(e,i){var r=document.createElement("a");r.style.display="none";r.setAttribute("href","data:text/csv;charset=utf-8,%EF%BB%BF"+i);r.setAttribute("download",e+".csv");document.body.appendChild(r);r.click();document.body.removeChild(r)}var nombre_changement_ecolage=0;function traitement_trombino(e,u,d){var m=document.createElement("div");m.id="liste_des_eleves";m.className="liste_des_eleves";element_DOM("fenetre").appendChild(m);e=e.filter(function(e,i){return e["Cycle"]===JSON.parse(recuperer("mes_donnees"))["Cycle"]});e.forEach(function(e,i){var r="";var t=JSON.parse(recuperer("mes_donnees"))["Droit_changer_ecolage"]==="oui"&&recuperer("mon_type").includes("Admin");if(t&&!u)r='<span class="toggle"><label class="switch"><input class="ecolage" id="'+e["Identifiant"]+'" type="checkbox"><span class="slider round"></span>\t</label></span>';var n=lien_pp(e["id_fichier"]);var a=recuperer("mon_type").includes("Admin")?bouton_modifier_pp(e["Identifiant"]):"";var s=recuperer("mon_type").includes("Admin")&&!n.includes("default-user.svg")?bouton_supprimer_pp(e["Identifiant"]):"";var o=!u?e["Classe"]:e["Classe"].split("|")[1].split(")")[0];if(d)o=e["Role"];var _='<div class="un_eleve"><img class="pp" id="pp_'+e["Identifiant"]+'" src='+n+">"+a+s+'<div><span class="element_eleve">'+e["Nom"]+" "+e["Prénom(s)"]+" <b>"+o+"</b></span></div>"+r+"</div>";var l=document.createElement("div");l.innerHTML=_;while(l.firstChild)m.appendChild(l.firstChild);if(t&&!u){var c=e["Ecolage_OK"]==="oui";element_DOM(e["Identifiant"]).checked=c}});if(!u){$(".ecolage").on("change",function(e){nombre_changement_ecolage=nombre_changement_ecolage+1;chargement(true);var i=e.target.checked?"oui":"non";var r={Ecolage_OK:i};var t="Eleves";var n="Identifiant";var a=e.target.id;actualiser(t,n,a,r);chargement(false)})}element_DOM("titre_fenetre").innerHTML+=" ("+e.length+")";if(!recuperer("mon_type").includes("Administration")&&(recuperer("dossier_chargé")===""||recuperer("dossier_chargé")===null)&&!u)decharger_dossier_final()}function tri_ordre_chrono_decroissant(e,i){return new Date(i.Horodateur).getTime()-new Date(e.Horodateur).getTime()}function traitement_logs(e){var a=document.createElement("div");a.style.position="relative";a.style.overflowX="hidden";a.style.overflowY="auto";a.id="liste_des_logs";a.style.height="90%";element_DOM("fenetre").appendChild(a);e.sort(tri_ordre_chrono_decroissant);e.forEach(function(e,i){var r=afficher_date(e["Horodateur"]);var t='<div style="padding-left: 2%;padding-bottom: 2%;">'+e["Statut"]+" le "+r+" "+e["Identifiant"]+" </div>";var n=document.createElement("div");n.innerHTML=t;while(n.firstChild)a.appendChild(n.firstChild)});if(element_DOM("titre_fenetre")==="Historique des connexions")element_DOM("titre_fenetre").innerHTML+=" ("+e.length+")";chargement(false)}function CreateTableFromJSON(e){var i=[];for(var r=0;r<e.length;r++){for(var t in e[r]){if(i.indexOf(t)===-1){i.push(t)}}}var n=document.createElement("table");var a=n.insertRow(-1);for(var r=0;r<i.length;r++){var s=document.createElement("th");s.innerHTML=i[r];a.appendChild(s)}for(var r=0;r<e.length;r++){a=n.insertRow(-1);for(var o=0;o<i.length;o++){var _=a.insertCell(-1);_.innerHTML=e[r][i[o]]}}var l=element_DOM("fenetre");l.appendChild(n)}function initialisation(){chargement(true);attribuer_les_clics();mettre_mon_mode();appliquer_preferences();document.title="Sekooly | "+nom_etablissement.toUpperCase();effacer("date_heure_depassement");if(recuperer("mes_donnees")===""||recuperer("mon_type")===""||recuperer("mes_donnees")===null||recuperer("mon_type")===null){tout_quitter()}else{configurer_profil();mon_role=init_mon_role();return chargement_a_larrivee()}chargement(false)}function tout_quitter(){document.body.style.display="none";deconnexion()}function afficher_fenetre(e){if(e){element_DOM("fenetre").style.visibility="visible"}else{element_DOM("fenetre").style.visibility="hidden"}}function afficher_logs(e){if(element_DOM("recup_logs")){if(e)element_DOM("recup_logs").style.visibility="hidden";if(!e)element_DOM("recup_logs").style.visibility="hidden"}}function afficher_edt(e){if(e){element_DOM("recup_edt").style.display="block";if(JSON.parse(recuperer("mes_donnees"))["Cycle"]==="Primaire")element_DOM("recup_edt").style.display="none"}else{element_DOM("recup_edt").style.display="none"}}function afficher_liste_eleves(e){if(e)element_DOM("recup_eleves").style.display="";if(!e)element_DOM("recup_eleves").style.display="none"}function check_maintenance(){var e="https://script.google.com/macros/s/AKfycbxgtxDhZ9g8-lo5e4aux1otiYyWsgg38TXmZunQ1VnPZ7JpjzA/exec";var i=recuperer("identifiant_courant");var r=recuperer("mon_type").split("_")[0];var t=i&&r?"&moi="+i+"&mon_type="+r:"";var n=e+"?check_maintenance=oui"+t;return $.ajax({url:n})}function mettre_le_contact_etablissement(){var e=contact_etablissement;if($("#contact_etablissement")[0]){$("#contact_etablissement")[0].href="mailto:"+e;$("#contact_etablissement")[0].innerText=e;stocker("contact_etablissement",e)}if($("#logo_etablissement")[0])$("#logo_etablissement")[0].src=prefixe_image+"/"+nom_fichier_logo;if($("#site_etablissement")[0])$("#site_etablissement")[0].href=site_etablissement}function attribuer_les_clics(){au_clic("#a2hs","ajouter_a_laccueil()");au_clic('[class="haut_droite dropdown"]',"switch_side_bar_top()");au_clic("#recup_notifs, #bulle_notif","switch_pannel_notifs()");au_clic("#recup_msgs, #bulle_notif_msg","recuperer_msgs(true)");au_clic("#rechercher_element","faire_la_recherche_fichier()");au_clic("#menu","switch_side_bar()");au_clic('[class="sidebar left"]',"fermer_si_non_recherche(event)");au_clic("#side-bar-profil","afficher_modif_profil()");au_clic("#side-bar-edt","edt()");au_clic("#side-bar-day","ma_journee()");au_clic("#dashboard","tableau_de_bord()");au_clic("#side-bar-prog","recuperer_programme()");au_clic("#side-bar-conseil","conseils_de_classe()");au_clic("#side-bar-remed","remediations()");au_clic("#side-bar-bulletins","clic_bulletin()");au_clic("#side-bar-irl","gerer_notifs_irl()");au_clic("#side-bar-help","retourner_site()");au_clic("#side-bar-night","configurer_mode()");au_clic("#side-bar-review","emettre_avis_sekooly()");au_clic("#side-bar-top-right","fermer_side_bar()");au_clic("#recup_eleves","recuperer_eleves()");au_clic("#recup_profs","recuperer_profs()");au_clic("#recup_admin","recuperer_admin()");au_clic("#recup_params","recuperer_parametres()");au_clic("#recup_pref","recuperer_preferences()");au_clic("#recup_analyses","recuperer_analyses()");au_clic("#disconnect","deconnexion()");au_clic("#afficher","charger_les_topics()");au_clic("#a-rendre","recuperer_devoirs()");au_clic("#visioconference","rejoindre_visio()");au_clic("#gerer-bulletins","clic_bulletin()");au_clic("#img_ajout","afficher_ou_non_choix_fichier(true)");au_clic("#par_la_date_effet, #par_filtre_id_chapitre","choisir_ce_mode(this)");au_clic("#config-date-prog","switch_config_mode()");au_clic("#est_video_youtube","switch_affichage_youtube()");au_clic("#est_extrait_manuel","switch_extrait_manuel()");au_clic("#bye_prev_upload","afficher_ou_non_choix_fichier(false)");au_clic("#bye_prev_rendu","afficher_fenetre_rendudevoir(false)");au_clic("#helper-categ","alert('Si vous attendez un rendu de la part des élèves, catégorisez votre fichier en Devoirs/Examens/Quiz.')");au_clic("#helper-prog","help_chapitre()");au_clic("#helper-coef","alert('Si ce rendu est noté et compte dans le bulletin scolaire, merci de mettre un coefficient > 0.')");au_clic("#helper-dev","aide_devoirs()");au_clic("#supprimer_page","supprimer_derniere_page_devoir()");au_clic("#ajouter_page","ajouter_page_devoir()");au_clic("#bouton_rendre_devoir","rendre_devoir()");au_clic("#run-quiz-dev","$('#'+element_DOM('devoir_choisi').value).click()")}function help_chapitre(){alert("Choisir le chapitre permet de mieux retrouver votre fichier.\nPour gérer les chapitres de votre matière, vous pouvez aller en haut à gauche -> Programme scolaire.")}function chargement_a_larrivee(){chargement(true);fermer_side_bar();mettre_le_contact_etablissement();rendre_td_modifiable();mettre_les_soons();ajouter_multi_visio_si_non_eleve();notifs_reelles_ou_non();var e=JSON.parse(recuperer("mes_donnees"))["Cycle"];est_en_maintenance().then(function(e){var i=JSON.parse(recuperer("mes_donnees"))["droit_hors_maintenance"];if(e==="oui"&&(!window.location.href.includes("file:///")&&!window.location.href.includes("http://localhost:8000"))&&i!=="oui"){deconnexion()}});if(!mon_ecolage_est_ok())deconnexion();if(!plateforme_prete()){return initialisation_de_la_plateforme()}effacer("nb_clics");effacer("numero_etape");mettre_en_place_les_notifications();var i=JSON.parse(recuperer("mes_donnees"))["Droits_modifs"];afficher_logs(i==="oui");if(recuperer("mon_type").includes("Administration")&&i==="oui"){n=get_resultat(racine_data+"/Matieres?Cycle=eq."+e+"&"+apikey);n=n.sort(function(e,i){return e.Classe_Matiere>i.Classe_Matiere});stocker("mes_matieres",JSON.stringify(n))}var r=recuperer("dossier_chargé")||recuperer("mon_type")==="Eleves";affichage_liste=recuperer("mon_type").includes("Administration")||recuperer("mon_type")==="Profs"&&recuperer("dossier_chargé")!==null&&recuperer("dossier_chargé")!=="";afficher_liste_eleves(affichage_liste);afficher_bulletins(false);if(recuperer("mon_type").includes("Eleve"))afficher_bulletins(true);if(recuperer("mon_type").includes("Prof"))supprimer_bulle_bulletins();afficher_params_si_droits_et_admin();window.scrollTo(0,0);calcul_grid_gap_barre_verticale();gerer_sondage();if((recuperer("dossier_chargé")===""||recuperer("dossier_chargé")===null)&&recuperer("mes_donnees")!==""){configurer_profil();afficher_ajout(false);afficher_discussions(false);afficher_devoirs(false);afficher_tri_fichiers(false);afficher_visio(false);if(recuperer("mon_type").includes("Administration"))stocker("mon_type","Administration");ajouter_les_dossiers_dynamiques();afficher_alerte_etablissement()}else{var t=recuperer("dossier_chargé");var n=JSON.parse(recuperer("mes_matieres"));var a=n.filter(function(e){if(e!==null)return e["ID_URL"]===t});if(a.length>0){var s=a[0].Classe+"\n"+a[0].Matiere;if(recuperer("mon_type")==="Eleves")s=a[0].Matiere;afficher_alerte_etablissement();return charger_dossier(t,true,s).then(function(){if(recuperer("fichier_ouvert")){var e=recuperer("fichier_ouvert");element_DOM(e).click()}})}else{if(recuperer("mon_type").includes("Admin"))stocker("mon_type","Administration");ajouter_les_dossiers_dynamiques()}}valider_suppression_via_mail_si_besoin();appliquer_preferences();chargement(false)}function afficher_params_si_droits_et_admin(){if(recuperer("mes_donnees")&&recuperer("mon_type")){var e=JSON.parse(recuperer("mes_donnees"))["Droits_modifs"];var i=recuperer("mon_type").includes("Admin")&&e==="oui";afficher_parametres(i)}else{afficher_parametres(false)}}function afficher_alerte_etablissement(){$("#texte_alerte")[0].innerText=recuperer_alerte_etablissement()}function afficher_alerte_etablissement_old(){alerte_etablissement().then(e=>{$("#texte_alerte")[0].innerText=e})}function calcul_grid_gap_barre_verticale(){la_barre=element_DOM("barre_verticale");if(la_barre){la_barre.style.gridGap=$(window).height()/(element_DOM("barre_verticale").childElementCount+1)+"px"}}function valeursUniquesDeCetteKey(e,i){if(e!=="null"&&e!==null){const s=[i];var r=[],t=[],n=e.length,a;for(a=0;a<n;a++){if(e[a]!==null){if(r[e[a][s]])continue;r[e[a][s]]=true;t.push(e[a][s])}}}else{t=[]}return t}function ajouter_les_dossiers_dynamiques(){if($("#liste_matieres")[0].children.length>0)return true;afficher_le_drive(false);var e=JSON.parse(recuperer("mes_matieres"));if(recuperer("mon_type")==="Administration"){var i=valeursUniquesDeCetteKey(e,"Classe").sort();var r=[];i.forEach(function(i){r.push(e.find(e=>e["Classe"]===i)["classe_id"])});i.some(function(e,i){if(e===undefined||i===undefined)return-1;if(e!=="Tous")ajouter_le_dossier(e,r[i],recuperer("mon_type"))})}else{ajout_dossiers_matieres(e)}stocker_temp("dossier_chargé","");stocker("les_fichiers","");stocker("fichier_ouvert","");stocker("les_topics","");stocker("les_coms","")}function ajout_dossiers_matieres(e){e.some(function(e){if(e!==null){var i=e.Classe;var r=e.Matiere;var t=prefixe_image+"/img_dossier_"+e.Couleur_matiere.replace(/ /g,"")+".png";if(i!==undefined&&r!==undefined){var n=e.URL;var a=n.split("/").pop();if(recuperer("mon_type")==="Profs"||recuperer("mon_type")==="Administration_bis"){r=e.Classe_Matiere}ajouter_le_dossier(r,a,recuperer("mon_type"),t)}else{return-1}}})}function ajouter_le_dossier(e,i,r,t){if($(".une_matiere_en_dossier#"+i).length>0)return-1;if(r==="Profs"||r==="Administration_bis"){var n=e.substring(e.lastIndexOf("(")+1,e.lastIndexOf("|"));var a=e.substring(e.lastIndexOf("|")+1,e.lastIndexOf(")"))}else{var n="";var a=e}var s=creer_nouveau_dossier();creer_span_div(s,i,n,a,t);if(r!=="Administration"&&r!=="Administration_final"){ajouter_listener_dossier(i)}else{ajouter_listener_dossier_non_final(i)}}function ajouter_listener_dossier_non_final(e){element_DOM(e).addEventListener("click",function(i){$("#accueil_utilisateur").off("click");if(element_DOM(i.target.id)){element_DOM("accueil_utilisateur").innerHTML=element_DOM(i.target.id).innerText;mettre_infos_matiere(false)}element_DOM("liste_matieres").innerHTML="";stocker("mon_type","Administration_bis");var e=JSON.parse(recuperer("mes_matieres"));var r=e.filter(function(e){if(e!==null)return e["classe_id"]===i.target.id});ajout_dossiers_matieres(r);avec_bouton_back(true);window.scrollTo(0,0)})}function ajouter_listener_dossier(e){element_DOM(e).addEventListener("click",function(e){$("#pannel_notif")[0].innerHTML="";var i=$("span[id='"+e.target.id+"']").text().trim();charger_dossier(e.target.id,true,i)})}function creer_nouveau_dossier(){var e=document.createElement("div");e.className="card";element_DOM("liste_matieres").appendChild(e);return e}function creer_span_div(e,i,r,t,n){if(r!==""){var a=r+"<br> "}else{var a=""}if(recuperer("mon_type")!=="Administration"){var s=n}else{var s=prefixe_image+"/dossier_drive.png"}e.innerHTML='<a class="une_matiere_en_dossier" id="'+i+'" href="javascript:void(0)" > <span id="'+i+'"> <img class = image_centre id="'+i+'" src="'+s+'">  '+a+t+" </a> </span>"}function mettre_aujourdhui(){element_DOM("la_date_effet").innerHTML="";var e=moment();var i=e.format("yyyy-MM-DD");var r="Aujourd'hui";ajouter_date_filtre(i,r,true)}function ajouter_date_filtre(e,i,r){if(e===moment().format("yyyy-MM-DD")&&!r)return-1;var t='<option value="'+e+'">'+i+"</option>";var n=document.createElement("div");n.innerHTML=t;element_DOM("la_date_effet").appendChild(n.firstChild)}async function infos_matiere(){id_matiere=recuperer("dossier_chargé");la_matiere=la_matiere_chargee("Matiere");description=await rechercher("Matieres","ID_URL",id_matiere,"description");if(description){description=description[0]["description"];lire_description(id_matiere,la_matiere,description)}}function lire_description(e,i,r){elements_html='<div class="description_matiere" id="content">'+r+"</div>";intitule_bouton=recuperer("mon_type")==="Eleves"?"Fermer":"Editer la description";fonction_bouton=recuperer("mon_type")==="Eleves"?"$('#mini_popup').remove()":"editer_description_matiere('"+e+"','"+i+"')";creer_mini_popup(i,elements_html,intitule_bouton,fonction_bouton,false,false,false,false,"25")}function editer_description_matiere(e,i){$("#foot_modifs").remove();description=element_DOM("content").innerHTML;vider_fenetre("Description de "+i,false,"sauvegarder_description()");afficher_fenetre(true);$("#mini_popup").remove();$("#fenetre").append('<div class="edition"><div id="description_matiere">'+description+"</div></div>");rendre_riche("description_matiere",true)}function saisie_vide(){return'<br data-cke-filler="true">'}function pied_modifs(){var e="<div id='foot_modifs'><br><br><gris><i>Dernière modification: "+afficher_date(maintenant());e+="<br>Par: "+recuperer("identifiant_courant").toUpperCase()+"</i></gris></div>";return e}async function sauvegarder_description(){console.log("Enregistrement de la description...");nouvelle_description=recuperer_html_saisie_riche().includes(saisie_vide())?"Aucune description fournie":recuperer_html_saisie_riche();nouvelle_description+=pied_modifs();await supabase.from("Matieres").update({description:nouvelle_description}).match({ID_URL:recuperer("dossier_chargé")});afficher_alerte("Description de la matière sauvegardée.")}function charger_dossier(e,i,r){$("#barre_verticale")[0].style.display="grid";if(e!==""&&e!==null){chargement(true);afficher_les_dossiers_dynamiques(false);stocker_temp("dossier_chargé",e);var t=recuperer("mode_prefere")||"par_la_date_effet";choisir_ce_mode($("#"+t)[0]);chercher_mes_chapitres(true);$("#accueil_utilisateur").off("click");$("#la_date_effet").on("change click",function(e){filtrer_date_effet()});$("#filtre_id_chapitre").on("change click",function(e){filtrer_chapitre()});stocker("les_topics","");stocker("topic_chargé","");stocker("nb_com_actuel","");stocker("les_coms","");element_DOM("accueil_utilisateur").innerHTML=r;mettre_infos_matiere(true);avec_bouton_back(true);afficher_devoirs(true);afficher_discussions(true);afficher_tri_fichiers(true);afficher_visio(true);if(recuperer("mon_type")==="Profs"){afficher_ajout(true);afficher_liste_eleves(true);afficher_bulletins(false)}else if(recuperer("mon_type").includes("Administration")){var n=JSON.parse(recuperer("mes_donnees"))["Droits_modifs"];afficher_ajout(n==="oui");afficher_liste_eleves(true);afficher_bulletins(true)}else{afficher_ajout(false);afficher_liste_eleves(false);afficher_bulletins(true)}if(recuperer("mon_type")==="Administration_bis")stocker("mon_type","Administration_final");afficher_discussions(true);afficher_le_drive(true);return recuperer_les_fichiers(e)}}function chercher_mes_chapitres(e){if(e)stocker("mes_chapitres","[]");var i=JSON.parse(recuperer("mes_chapitres"));var r=recuperer("dossier_chargé");if(!i||!i[r]){var t=racine_data+"Programme?ID_URL=eq."+r+"&limit=150&order=intitule_chapitre.asc"+"&"+apikey;i=get_resultat(t);mes_chapitres_str=JSON.stringify(i);chapitre_a_rajouter={[r]:mes_chapitres_str};chapitre_a_rajouter_str=JSON.stringify(chapitre_a_rajouter);if(i.length>0)stocker("mes_chapitres",chapitre_a_rajouter_str)}var n=recuperer_chapitres_locaux(r);mettre_la_liste_de_chapitres();return n}function recuperer_chapitres_locaux(e){try{var i=JSON.parse(JSON.parse(recuperer("mes_chapitres"))[e])}catch(r){var i=[]}return i}function mettre_la_liste_de_chapitres(e){var i=recuperer("dossier_chargé");var r=recuperer_chapitres_locaux(i);var t="";r.forEach(function(e){t+=un_chapitre_liste(e)});if(e){return'<option value="--">(Aucun chapitre)</option>'+t}else{$(".un_chapitre_dans_la_liste").remove();liste_de_mes_chapitres_filtre=t+'<option class="un_chapitre_dans_la_liste" value="Tous">Tous les fichiers</option>';t+='<option class="un_chapitre_dans_la_liste" value="new" style="font-style: oblique;">Nouveau chapitre</option>';$("select#id_chapitre").append(t);$("select#filtre_id_chapitre").append(liste_de_mes_chapitres_filtre);$("select#id_chapitre").off("change");$("select#id_chapitre").on("change",function(e){if(e.target.value==="new")creer_chapitre()})}}function un_chapitre_liste(e){return'<option class="un_chapitre_dans_la_liste" value='+e["id_chapitre"]+">"+e["intitule_chapitre"]+"</option>"}function recuperer_les_fichiers(e){chargement(true);enlever_alerte_vide(false);nom_table="Fichiers";nom_champ_reference="id_dossier";valeur_champ_reference=recuperer("dossier_chargé");nom_champ_a_chercher="";return rechercher(nom_table,nom_champ_reference,valeur_champ_reference,nom_champ_a_chercher).then(e=>{les_fichiers="[]";if(e.length>0)les_fichiers=JSON.stringify(e);stocker("les_fichiers",les_fichiers);traitement_fichiers_recus();chargement(false)})["catch"](e=>{console.error(e);alert("Erreur : fichiers impossibles à récupérer pour cette classe.");chargement(false)})}function enlever_alerte_vide(e){if(element_DOM("alerte_vide"))element_DOM("alerte_vide").remove();if(e===false){Array.from(document.getElementsByClassName("ma_liste")).forEach(function(e,i,r){e.innerHTML="";element_DOM("titre_"+e.id).style.display="none"})}}function dossier_vide(e){enlever_alerte_vide(e);var i=document.createElement("span");i.id="alerte_vide";i.className="alerte_vide";var r=$("#la_date_effet").find(":selected").text();var t=$("#filtre_id_chapitre").find(":selected").text();var n=$('[id="la_date_effet"]:visible').length>0;var a=n?r:t;i.innerHTML='<i class="contenu_alerte_vide">Il n\'y a pas encore de fichiers pour '+a+".</i>";afficher_le_drive(false);document.body.insertBefore(i,element_DOM("gros_conteneur"))}function la_date_yyyy_mm_dd(e){var i=new Date(Date.parse(e));var r=i.getDate();var t=i.getMonth()+1;var n=i.getFullYear();return""+n+"-"+(t<=9?"0"+t:t)+"-"+(r<=9?"0"+r:r)}function initialisation_date_tri(e){mettre_aujourdhui();var i=valeursUniquesDeCetteKey(e,"date_effet");var i=i.sort();var r=i.map(e=>afficher_date(e,true));for(var t=0;t<i.length;t++){var n=la_date_yyyy_mm_dd(i[t]);var a=r[t];ajouter_date_filtre(n,a)}ajouter_date_filtre("Tous","Tous les fichiers");var s=moment().format("yyyy-MM-DD");element_DOM("la_date_effet").value=s}function traitement_fichiers_recus(){var e=recuperer("les_fichiers");var i=JSON.parse(e);initialisation_date_tri(i);if(!recuperer("mon_type").includes("Administration")){i=i.filter(e=>e["categorie_fichier"]!=="Bulletins")}if(e===""||i.length===0){dossier_vide(false)}else{enlever_alerte_vide(false);i.sort(function(e,i){if(e.nom_fichier<i.nom_fichier){return-1}if(e.nom_fichier>i.nom_fichier){return 1}return 0});i.forEach(function(e){ma_categorie=e["categorie_fichier"].toLowerCase();var i=e["nom_fichier"];var r=i.split(".").pop().toLowerCase();var t=afficher_date(e["la_date_limite"],true);var n=e["lheure_limite"]?" à "+e["lheure_limite"]:"";if(ma_categorie==="examens"&&e["la_date_limite"].length===0){date_debut=la_date_yyyy_mm_dd(e["date_effet"]);date_debut=moment(date_debut+" "+e["heure_effet"]);t=date_debut;nb_heures_delai_examen=data_etablissement["nb_heures_delai_examen"]||12;t=t.add(nb_heures_delai_examen,"hours");n=" à "+t.format("YYYY-MM-DD HH:mm").split(" ")[1];t=afficher_date(t,true)}valeur_coef=e["coefficient_rendu"]>0?"<b>Coeff. "+e["coefficient_rendu"]+"</b>":"";if(ma_categorie==="devoirs"||ma_categorie==="examens")i=e["nom_fichier"]+"<rouge><i>(à rendre avant le "+t+n+")<br>"+valeur_coef+"</i></rouge>";var a="drive_"+ma_categorie;ajouter_un_fichier(e["id_fichier"],i,a,r,e["date_effet"],e["heure_effet"],e["est_telechargeable"],e["coefficient_rendu"],e["la_date_limite"],e["lheure_limite"],e["periode_bulletin"],e["destinataire_par_page"],e["id_chapitre"])});var r=id_mode_affichage();filtrer_avec_le_bon_filtre(r);chargement(false)}if(recuperer("dossier_chargé")===""||recuperer("dossier_chargé")===null)decharger_dossier_final();chargement(false)}function id_mode_affichage(){return recuperer("mode_prefere")?recuperer("mode_prefere").replace("par_",""):"la_date_effet"}function garder_les_manuels(){if($("#drive_manuels")[0].children.length>0){$("#titre_drive_manuels")[0].style.display="initial";$("#drive_manuels")[0].style.display="";for(var e=$("#drive_manuels")[0].children.length-1;e>=0;e--){$("#drive_manuels")[0].children[e].style.display=""}}}function highlightDays(e,i){for(var r=0;r<e.length;r++){if(e[r]==i){return[true,"highlight"]}}return[true,""]}function masquer_drive_vide(){Array.from(document.getElementsByClassName("ma_liste")).forEach(function(e,i,r){var t=$("#"+e["id"]).find(".span_un_fichier:visible").length;if(t===0){element_DOM(e.id).style.display="none";element_DOM("titre_"+e.id).style.display="none"}else{element_DOM(e.id).style.display="grid";element_DOM("titre_"+e.id).style.display="initial"}});if($("#gros_conteneur").find(".span_un_fichier:visible").length===0)dossier_vide(true)}function ajouter_un_fichier(i,e,r,t,n,a,s,o,_,l,c,u,d){var m=prefixe_image+"/img_icone_"+t+".png";var f=s==="oui"?"":' style="padding-top: 25%;" ';var p=s==="oui"?'<img alt="télécharger" src="'+prefixe_image+'/img_download.png" onclick="telecharger_fichier(event,this)" id="telecharger" class="download_fichier">':"";var c=c?" periode_bulletin='"+c+"'":"";var u=u?" destinataire_par_page='"+u+"'":"";var d=d?" id_chapitre='"+d+"'":"";var v='<span oncontextmenu="autoriser_clic_droit_supprimer_et_renommer(event,this)" onclick="ouvrir_fichier(this)" class="span_un_fichier" id="'+i+'" ma_date_effet="'+la_date_yyyy_mm_dd(n)+'" mon_heure_effet="'+a+'" ma_date_limite="'+la_date_yyyy_mm_dd(_)+'" mon_heure_limite="'+l+'" est_telechargeable="'+s+'"    coefficient_rendu='+o+c+u+d+"    >"+p+'<img id="'+i+'" src="'+m+'" class="un_fichier" '+f+">"+e+"</span>";var h=document.createElement("div");h.innerHTML=v;while(h.firstChild){element_DOM(r).appendChild(h.firstChild)}$("#"+i+" .un_fichier").one("error",function(e){$("#"+i+" .un_fichier").attr("src",prefixe_image+"/img_fichier.png")});ajouter_cadenas_examen(i,r)}function ajouter_cadenas_examen(e,i){if(i==="drive_examens"){var r=fichier_ouvrable(e,false)===false;if(r){$(".span_un_fichier#"+e).append('<img alt="verrouillé" id="locked" src="'+prefixe_image+'/img_cadenas.png" class="locked">')}}}function bool_examen_terminé(e,i){var r=i.getAttribute("ma_date_effet");var t=i.getAttribute("mon_heure_effet").value;nb_heures_delai_examen=data_etablissement["nb_heures_delai_examen"]||12;var n=moment(r+" "+t,"yyyy-MM-DD hh:mm").add(nb_heures_delai_examen,"hours")._d;var a=e==="drive_examens";var s=a&&moment(maintenant())>n;return s}function fichier_ouvrable(e,i,r){var t=recuperer("mon_type").split("_")[0];if(i){e=r.parentNode.id}var n=$("span#"+e+".span_un_fichier")[0];var a=n.parentNode.id;var s=n.getAttribute("mon_heure_effet")?n.getAttribute("mon_heure_effet"):"07:30";var o=moment(n.getAttribute("ma_date_effet")+" "+s);var _=moment(maintenant());if(a==="drive_corrections"&&(!t.includes("Admin")&&!t.includes("Prof"))&&o>_){return false}var l=JSON.parse(recuperer("mes_donnees"));var c=l["Droit_acces_anticipe_examen"]?l["Droit_acces_anticipe_examen"]==="oui":t==="Profs";var u=bool_examen_terminé(a,n);if(a==="drive_examens"&&!c&&(o>_||u)){return false}else{}return true}function ouvrir_fichier(e){var i=e.id;var r=$("[id="+i+"].span_un_fichier")[0];if(!fichier_ouvrable(i)){var t=r.getAttribute("mon_heure_effet")?r.getAttribute("mon_heure_effet"):"07:30";var n=r.parentNode.id;if(bool_examen_terminé(n,r)){alert("Ce sujet d'examen n'est plus disponible.")}else{date_heure_fichier=e.attributes["ma_date_effet"].value+" "+t;alert("Ce fichier n'est pas disponible avant "+afficher_date_old(moment(date_heure_fichier).format("DD/MM/YYYY HH:mm"))+".")}return-1}else{stocker("fichier_ouvert",i);var a=$("[id='"+i+"']").clone().children().remove().end().text().trim();a=rfc3986EncodeURIComponent(a);visualiser(a,i,"","",r.getAttribute("est_telechargeable")!=="oui")}}function telecharger_fichier(e,i){if(!fichier_ouvrable(t,true,i)){le_span_un_fichier=$("[id="+t+"].span_un_fichier")[0];var r=le_span_un_fichier.getAttribute("mon_heure_effet")?le_span_un_fichier.getAttribute("mon_heure_effet"):"07:30";alert("Ce fichier n'est pas disponible avant "+afficher_date(i.parentNode.attributes["ma_date_effet"].value+" "+r));return-1}chargement(true);e.stopPropagation();var t=i.parentNode.id;window.location.href="https://drive.google.com/uc?export=download&id="+t;chargement(false)}function autoriser_clic_droit_supprimer_et_renommer(e,i){if(recuperer("mon_type")==="Eleves")return-1;if(recuperer("mon_type").includes("Administration")){var r=JSON.parse(recuperer("mes_donnees"))["Droits_modifs"];if(r!=="oui")return-1}if(!recuperer("mon_type").includes("Admin")&&element_DOM("accueil_utilisateur").innerText.includes("Vie scolaire")){return-1}if($("#"+i.id)[0].parentNode.id==="drive_manuels"){if(!recuperer("mon_type").includes("Admin")){return-1}else{if(JSON.parse(recuperer("mes_donnees"))["Droits_modifs"]!=="oui")return-1}}e.preventDefault();e.stopPropagation();var t=i.id;$(".clic_droit").remove();ajouter_fonction_clic_droit(e,i,0,"renommer_fichier","Renommer",t);ajouter_fonction_clic_droit(e,i,1,"changer_chapitre_fichier","Chapitre",t);ajouter_fonction_clic_droit(e,i,2,"recategoriser_fichier","Recatégoriser",t);ajouter_fonction_clic_droit(e,i,3,"changer_date_effet","Date d'effet",t);if($("#"+i.id)[0].parentNode.id==="drive_devoirs"){ajouter_fonction_clic_droit(e,i,4,"changer_date_limite_rendu","Date limite de rendu",t);mon_offset=1}else{mon_offset=0}if($("#"+i.id)[0].parentNode.id==="drive_bulletins"){ajouter_fonction_clic_droit(e,i,4,"changer_periode_bulletin","Période du bulletin",t);mon_offset=mon_offset===1?2:1}ajouter_fonction_clic_droit(e,i,4+mon_offset,"changer_coef","Coefficient",t,null,$("#"+t)[0].getAttribute("coefficient_rendu"));ajouter_fonction_clic_droit(e,i,5+mon_offset,"changer_telechargeable","Téléchargeable",t);ajouter_fonction_clic_droit(e,i,6+mon_offset,"supprimer_fichier","Supprimer",t);$(document).click(function(){$(".clic_droit").remove();$("#clic_droit_titres_param").remove()})}function changer_chapitre_fichier(e,i){var r='<select id="nouveau_chapitre">';r+=mettre_la_liste_de_chapitres(true);r+="</select>";var t=$(".span_un_fichier[id='"+e+"']")[0].getAttribute("id_chapitre");creer_mini_popup("Chapitre de <b>"+i+"</b>",r,"Assigner le chapitre","changer_chapitre('"+e+"')",t,"nouveau_chapitre")}function changer_chapitre(e){nouveau_chapitre=$("#nouveau_chapitre")[0].value;nouvelle_donnee={id_fichier:e,id_chapitre:nouveau_chapitre};var i=racine_data+"Fichiers?id_fichier=eq."+e+"&"+apikey;patch_resultat_asynchrone(i,nouvelle_donnee);afficher_alerte("Le chapitre du fichier a bien été actualisé.",true)}function changer_eleve_par_page_bulletin(e,i){chargement(true);nb_pages=recuperer_nb_pages_pdf(e);chargement(false);i='{"nouveau":"1","test":"2"}';elements_html=modif_attribution_page_eleve(nb_pages,i);creer_mini_popup("Re-attribuez chaque page:",elements_html,"Attribuer","envoyer_modif_destinataires_bulletins('"+i+"')")}function envoyer_modif_destinataires_bulletins(e){chargement(true);nouveau_destinataire_par_page={1:"truc"};if(nouveau_destinataire_par_page===e)return-1;nom_table="Fichiers";nom_champ_reference="id_fichier";valeur_champ_reference=id_fichier;nouveau_data={destinataire_par_page:nouveau_destinataire_par_page};actualiser(nom_table,nom_champ_reference,valeur_champ_reference,nouveau_data);setTimeout(function(){location.reload()},1e3);chargement(false)}function modif_attribution_page_eleve(e,i){liste_eleves=JSON.parse(i);console.log(liste_eleves);select_liste_eleves='<select style="width: 80%;" name="numero_page" id="numero_page"><option value="eleve_de_cette_page">eleve_de_cette_page</option></select>';attribution='<form id="attribution" style="margin-top: 20px;">';for(numero_page=1;numero_page<=e;numero_page++){nom_eleve=Object.keys(liste_eleves).find(e=>liste_eleves[e]===numero_page.toString());attribution=attribution+'<div><label for="'+numero_page+'">Page n°'+numero_page+":"+select_liste_eleves.replace(/"numero_page"/g,numero_page).replace(/"eleve_de_cette_page"/g,nom_eleve)+"</label></div>"}attribution=attribution+"</form>";return attribution}function changer_periode_bulletin(e,i){i=$("[id='"+e+"']")[0].getAttribute("periode_bulletin");var r=`<div><label for="periode_bulletin"><select style="width: 60%;" id="periode_bulletin" name="periode_bulletin"><option value="PREMIER TRIMESTRE">PREMIER TRIMESTRE</option><option value="DEUXIEME TRIMESTRE">DEUXIEME TRIMESTRE</option><option value="TROISIEME TRIMESTRE">TROISIEME TRIMESTRE</option><option value="ANNUEL">ANNUEL</option></select></label></div>`;creer_mini_popup("Choisissez la nouvelle période de ce bulletin:",r,"Modifier la période","changer_periode('"+e+"','"+i+"')");$("#periode_bulletin")[0].value=i}function changer_periode(e,i){nouvelle_periode=$("#periode_bulletin")[0].value;if(nouvelle_periode===i)return-1;chargement(true);nom_table="Fichiers";nom_champ_reference="id_fichier";valeur_champ_reference=e;nouveau_data={periode_bulletin:nouvelle_periode};actualiser(nom_table,nom_champ_reference,valeur_champ_reference,nouveau_data);setTimeout(function(){location.reload()},1e3);chargement(false)}function changer_telechargeable(e,i){var r=$("[id='"+e+"'].span_un_fichier")[0].parentNode.id.split("_")[1];var t=$("[id='"+e+"']")[0].innerText.split(".")[1].split("\n")[0];if(r.includes("manuels")||r.includes("quiz")){alert("Impossible de rendre un manuel ou un quiz téléchargeable.");return-1}else if(r.includes("bulletins")){alert("Impossible de rendre un fichier de bulletins téléchargeable.");return-1}else if(t==="youtube"){alert("Impossible de rendre une vidéo youtube téléchargeable.");return-1}var i=$(".span_un_fichier[id='"+e+"']")[0].children[0].id==="telecharger"?"oui":"non";var n=prompt("Indiquez si 'oui' ou 'non' vous voulez que ce fichier soit téléchargeable:",i);if(n===null)return-1;chargement(true);n=n==="oui"?"oui":"non";if(n===i)return-1;nom_table="Fichiers";nom_champ_reference="id_fichier";valeur_champ_reference=e;nouveau_data={est_telechargeable:n};actualiser(nom_table,nom_champ_reference,valeur_champ_reference,nouveau_data);setTimeout(function(){location.reload()},1e3);chargement(false)}function changer_coef(e,i){var r=$("[id="+e+"].span_un_fichier")[0].parentNode.id.split("_")[1];if(!r.includes("devoirs")&&!r.includes("examens")&&!r.includes("quiz")){alert("Impossible de changer le coefficient d'un fichier différent d'un sujet de devoir/examen.");return-1}var t=prompt("Indiquez le nouveau coefficient du rendu:",i);if(t===null)return-1;t=Number(t);if(!(t>=0)){alert("Impossible de changer le coefficient : merci de saisir un coefficient valide (>0).");return-1}if(t===i)return-1;chargement(true);nom_table="Fichiers";nom_champ_reference="id_fichier";valeur_champ_reference=e;nouveau_data={coefficient_rendu:t};actualiser(nom_table,nom_champ_reference,valeur_champ_reference,nouveau_data);setTimeout(function(){location.reload()},1e3);chargement(false)}function ajouter_fonction_clic_droit(e,i,r,t,n,a,s,o){if(!o)o=decodeURI(encodeURIComponent(i.innerText).split("%0A")[0]);var _=document.createElement("span");if(!s)s="clic_droit";_.setAttribute("class",s);_.setAttribute("id",t);_.setAttribute("onclick","event.stopPropagation();"+t+'("'+a+'","'+o+'")');var l=r*40;_.style.top=Number(e.clientY+l)+"px";_.style.left=e.clientX+"px";_.innerHTML=n;i.appendChild(_);$(_).on("mouseover",function(e){_.style.filter="invert(100%)"});$(_).on("mouseout",function(e){_.style.filter=""});$(_).on("click",function(e){$(".clic_droit").remove()});return _}function recategoriser_fichier(e,i){var r=$("[id="+e+"].span_un_fichier")[0].parentNode.id.split("_")[1];if(r.includes("devoirs")){alert("Impossible de recatégoriser un devoir.");return-1}else if(r.includes("examen")){alert("Impossible de recatégoriser un examen.");return-1}else if(r.includes("quiz")){alert("Impossible de recatégoriser un quiz.");return-1}else{r=r.charAt(0).toUpperCase()+r.slice(1);var t=Array.from($("#categorie_choisie")[0].children).map(e=>e.value);var n=t.map(e=>'<option value="'+e+'">'+e+"</option>");var a='<select id="ma_liste_categories" style="width: 80%;">'+n+"</select>";creer_mini_popup(i,a,"Recatégoriser","mettre_a_jour_categorie('"+e+"')",r,"ma_liste_categories")}}function creer_mini_popup(e,i,r,t,n,a,s,o,_,l){$("#mini_popup").remove();var c='<div id="entete-fenetre" style="display: inline-flex;float: right;"><img  alt="X" src="'+prefixe_image+'/quitter.png" id="bye_prev" onclick="$(\'#mini_popup\').remove()" class="bye_prev"> </div>';var u=_?'style="border-bottom-style: ridge;font-size: '+_+'px;"':"";var d="<div "+u+" >"+e+"</div>";var m=l?"id='"+l+"'":"";var f='<button type="button"  '+m+'  class="rendre sekooly-mode-background" onclick="'+t+'">'+r+"</button>";var p='<div class="mini_popup" id="mini_popup">'+c+d+i+f+"</div>";var v=document.createElement("div");v.innerHTML=p;document.body.appendChild(v.firstChild);if($("#"+a)[0])$("#"+a)[0].value=n;if($("#"+o)[0])$("#"+o)[0].value=s;ajuster_boutons_fenetre();ajuster_boutons_fenetre(true);choisir_height_viz_si_pdf()}function mettre_a_jour_categorie(e){var i=$("#ma_liste_categories")[0].value;if(impossible_de_cliquer())return-1;if(i==="--")return-1;if(i==="Devoirs"||i==="Examens"){alert("Il est pour l'instant impossible de recatégoriser un fichier en Devoirs/Examens.");return-1}chargement(true);nom_table="Fichiers";nom_champ_reference="id_fichier";valeur_champ_reference=e;nouveau_data={categorie_fichier:i};actualiser(nom_table,nom_champ_reference,valeur_champ_reference,nouveau_data);setTimeout(function(){location.reload()},1e3)}function changer_date_limite_rendu(e,i){var r='<input type="date" id="nouvelle_date_effet" class="date_effet_fichier">';var t='<input type="time" id="nouvelle_heure_effet" class="la_date_limite">';var n=$("[id="+e+"].span_un_fichier")[0].attributes["ma_date_limite"].value;var a=$("[id="+e+"].span_un_fichier")[0].attributes["mon_heure_limite"].value?$("[id="+e+"].span_un_fichier")[0].attributes["mon_heure_limite"].value:"07:30";creer_mini_popup(i,r+t,"Appliquer date limite de rendu","mettre_a_jour_date_limite_rendu('"+e+"')",n,"nouvelle_date_effet",a,"nouvelle_heure_effet");$("#nouvelle_date_effet").on("change",function(){if($("#nouvelle_date_effet")[0].value==="")$("#nouvelle_date_effet")[0].value=n});$("#nouvelle_heure_effet").on("change",function(){if($("#nouvelle_heure_effet")[0].value==="")$("#nouvelle_heure_effet")[0].value=a})}function changer_date_effet(e,i){var r='<input type="date" id="nouvelle_date_effet" class="date_effet_fichier">';var t='<input type="time" id="nouvelle_heure_effet" class="la_date_limite">';var n=$("[id="+e+"].span_un_fichier")[0].attributes["ma_date_effet"].value;var a=$("[id="+e+"].span_un_fichier")[0].attributes["mon_heure_effet"].value?$("[id="+e+"].span_un_fichier")[0].attributes["mon_heure_effet"].value:"07:30";creer_mini_popup(i,r+t,"Appliquer date d'effet","mettre_a_jour_date_effet('"+e+"')",n,"nouvelle_date_effet",a,"nouvelle_heure_effet");$("#nouvelle_date_effet").on("change",function(){if($("#nouvelle_date_effet")[0].value==="")$("#nouvelle_date_effet")[0].value=n});$("#nouvelle_heure_effet").on("change",function(){if($("#nouvelle_heure_effet")[0].value==="")$("#nouvelle_heure_effet")[0].value=a})}function mettre_a_jour_date_limite_rendu(e){var i=$("#nouvelle_date_effet")[0].value;var r=$("#nouvelle_heure_effet")[0]?$("#nouvelle_heure_effet")[0].value:"";if(impossible_de_cliquer())return-1;if(i==="")return-1;chargement(true);nom_table="Fichiers";nom_champ_reference="id_fichier";valeur_champ_reference=e;nouveau_data={la_date_limite:i,lheure_limite:r};actualiser(nom_table,nom_champ_reference,valeur_champ_reference,nouveau_data);setTimeout(function(){location.reload()},1e3)}function mettre_a_jour_date_effet(e){var i=$("#nouvelle_date_effet")[0].value;var r=$("#nouvelle_heure_effet")[0]?$("#nouvelle_heure_effet")[0].value:"";if(impossible_de_cliquer())return-1;if(i==="")return-1;chargement(true);nom_table="Fichiers";nom_champ_reference="id_fichier";valeur_champ_reference=e;nouveau_data={date_effet:i,heure_effet:r};actualiser(nom_table,nom_champ_reference,valeur_champ_reference,nouveau_data);setTimeout(function(){location.reload()},1e3)}function renommer_fichier(r,e){e=decodeURIComponent(e);extension_fichier=e.split(".").pop();e=e.split(".").slice(0,-1).join(".");var t=prompt("Indiquez le nouveau nom: ",e);if(t===null||t.length===0)return-1;chargement(true);t=t.trim();t=t+"."+extension_fichier;if(t.length>0){var i=recuperer("identifiant_courant");var n="https://script.google.com/macros/s/AKfycbzUiqqvttFoMV0SJEjizhDj_vQQdkAYN0ZwS4Yiy3TMgK1ucb8e/exec";var a=n+"?method=POST&id_fichier="+r;var a=a+"&nouveau_nom="+t;var a=a+"&API_KEY_RENAME="+recuperer("API_KEY_RENAME");$.ajax({url:a,type:"POST",success:function(e){console.log(e);var i=element_DOM("snackbar");i.innerText=e;i.className="show";nom_table="Fichiers";nom_champ_reference="id_fichier";valeur_champ_reference=r;nouveau_data={nom_fichier:t};actualiser(nom_table,nom_champ_reference,valeur_champ_reference,nouveau_data);nom_table="Quiz";nom_champ_reference="id_quiz";valeur_champ_reference=r;nouveau_data={titre:t};actualiser(nom_table,nom_champ_reference,valeur_champ_reference,nouveau_data);nom_table="Notifs";nom_champ_reference="id_notif";valeur_champ_reference=r+suite_notif();nouveau_data={"Intitulé":t};actualiser(nom_table,nom_champ_reference,valeur_champ_reference,nouveau_data);setTimeout(function(){i.className="";location.reload()},3e3)},error:function(e){console.log(e)}})}}async function visualiser(e,i,r,t,n,a,s){chargement(true);e=decodeURIComponent(e);vider_fenetre(t?t:e+(r?r:""));afficher_fenetre(true);var o=a?'<a id="telechargement" class="download-btn" download="Bulletin.png" onclick="telecharger_canvas()"><img alt="télécharger" class="window-btn"  id="'+i+'" src="'+prefixe_image+'/img_download.png"></a>':n?"":'<a id="telechargement" class="download-btn" href = "https://drive.google.com/uc?export=download&id='+i+'"><img alt="télécharger" class="window-btn" id="'+i+'" src="'+prefixe_image+'/img_download.png"></a>';if(r){donnees_devoir_a_corriger=await rechercher("Rendus","id_fichier",i);remarque=donnees_devoir_a_corriger[0]["remarque"];coefficient_rendu=donnees_devoir_a_corriger[0]["coefficient_rendu"];note_rendu=donnees_devoir_a_corriger[0]["note_rendu"];remarque=decodeURIComponent(remarque);remarque=JSON.stringify(remarque).replace(/&/,"&amp;").replace(/"/g,"");remarque=remarque.replace(/'/g,"\\'");var _='<span id="'+i+'"><img id="corriger" src="'+prefixe_image+'/img_remarque.png" class="window-btn" style="right: 30px;" onclick="mettre_remarque_devoir(this,\''+remarque+"',"+coefficient_rendu+","+note_rendu+')"></span>'}else{var _=""}var l=document.createElement("div");l.innerHTML=_+o;while(l.firstChild)element_DOM("entete-fenetre").appendChild(l.firstChild);e=e.toLowerCase();var c=e.split(".").pop();if(c==="quiz"){chargement(false);var u=r?element_DOM("devoir_choisi").value:i;stocker("fichier_ouvert",u);r=r?r.toLowerCase().replace("(","").replace(")","").trim():recuperer("identifiant_courant");stocker("proprietaire_devoir",r);return accueil_quiz(u,recuperer("mon_type")!=="Eleves",r)}var d='<iframe id="previsualisation" class="previz"></iframe>';if(est_image(c))d='<div id="previsualisation" style="width: 100%;height: 85%;"></div>';if(est_youtube(c))$("#telechargement").remove();if(n&&est_youtube(c)===false&&est_image(c)===false||s)d='<div id=previsualisation class="responsive-container">';l=document.createElement("div");l.innerHTML=d;element_DOM("fenetre").appendChild(l.firstChild);lien_de_visu=calcul_lien_de_visu(c,i);if(est_image(c)&&!s){var m=OpenSeadragon({id:"previsualisation",prefixUrl:"https://sekooly.github.io/SUPABASE/openseadragon/images/",tileSources:{type:"image",url:lien_de_visu},showRotationControl:true});chargement(true);m.addHandler("open",function(){chargement(false)})}else if(a){var f='<canvas id="vizcanva"> </canvas>';element_DOM("previsualisation").innerHTML=f;chargement(false)}else if(s){$("#previsualisation")[0].className="";chargement(false)}else{choisir_height_viz_si_pdf();if(n&&est_youtube(c)===false){var f='<iframe id="viz_frame" src="'+lien_de_visu+'"    frameborder="0" scrolling="no" seamless=""></iframe><div style="width: 80px; height: 80px; position: absolute; opacity: 0; right: 0px; top: 0px;"> </div>';element_DOM("previsualisation").innerHTML=f;chargement(false)}else{element_DOM("previsualisation").src=lien_de_visu}$("#previsualisation").on("load",function(){chargement(false)});$("#viz_frame").on("load",function(e){chargement(false)});setTimeout(function(){if(impossible_de_cliquer()&&element_DOM("titre_fenetre")===e){chargement(false);alert("L'aperçu du fichier "+e+" n'est peut-être pas disponible. Vous pouvez toutefois le télécharger.");chargement(false)}},1e4)}au_clic_droit("#previsualisation","clic_droit_interdit(event)");ajuster_boutons_fenetre();ajuster_boutons_fenetre(true);choisir_height_viz_si_pdf()}function clic_droit_interdit(e){e.preventDefault();e.stopPropagation();return false}function est_youtube(e){return e==="youtube"}function est_image(e){return e.includes("bmp")||e.includes("gif")||e.includes("jpeg")||e.includes("jpg")||e.includes("png")||e.includes("svg")||e.includes("bmp")}function calcul_lien_de_visu(e,i){var r="https://drive.google.com/uc?id="+i;if(e.includes("xls")){r="https://docs.google.com/spreadsheets/preview?id="+i}else if(e.includes("doc")){r="https://docs.google.com/document/preview?id="+i}else if(e.includes("ppt")){r="https://docs.google.com/presentation/preview?id="+i}else if(e.includes("txt")||e.includes("wav")){r="https://docs.google.com/file/d/"+i+"/preview"}else if(e.includes("pdf")||e.includes("rtf")){r="https://docs.google.com/file/d/"+i+"/preview"}else if(e.includes("mp4")){r="https://docs.google.com/file/d/"+i+"/preview"}else if(est_image(e)){r="https://drive.google.com/uc?export=preview&id="+i}else if(est_youtube(e)){r="https://www.youtube.com/embed/"+i+"?fs=1&loop=1&rel=0&showinfo=0&modestbranding=1"}return r}function quitter_previsualisation_bis(){$("#fenetre_bis").remove();if(element_DOM("fenetre_bis"))element_DOM("fenetre_bis").style.overflowY=""}function quitter_previsualisation(){if(element_DOM("previsualisation"))element_DOM("previsualisation").src="";if(element_DOM("viz_frame"))element_DOM("viz_frame").src="";if($("#visio")[0])$("#visio")[0].remove();if($(".ecolage"))$(".toggle").remove();stocker("fichier_ouvert","");element_DOM("fenetre").style.overflowY="";if(element_DOM("previsualisation"))element_DOM("previsualisation").setAttribute("style","");afficher_fenetre(false);ma_tentative={};effacer("tmp_quiz");effacer("proprietaire_devoir")}function initialisation_bouton(e){element_DOM("pleinecran"+(e?"_bis":"")).src=prefixe_image+"/img_pleinecran.png";if(element_DOM("fenetre"+(e?"_bis":"")).style.width==="99%")element_DOM("pleinecran"+(e?"_bis":"")).src=prefixe_image+"/img_petitecran.png"}function switch_mode(e){if(!element_DOM("pleinecran"))return-1;mode_petitecran=$("[src$='img_petitecran.png']").length===0;if(mode_petitecran&&!e){element_DOM("pleinecran").src=prefixe_image+"/img_petitecran.png";$("#fenetre").addClass("big-window")}else{element_DOM("pleinecran").src=prefixe_image+"/img_pleinecran.png";$("#fenetre").removeClass("big-window")}choisir_height_viz_si_pdf()}function switch_mode_bis(e){if(!element_DOM("pleinecran_bis"))return-1;var i=element_DOM("pleinecran_bis").src.includes(prefixe_image+"/img_pleinecran.png");if(i||e){element_DOM("pleinecran_bis").src=prefixe_image+"/img_petitecran.png";element_DOM("fenetre_bis").style.top=0;element_DOM("fenetre_bis").style.left=0;element_DOM("fenetre_bis").style.width="99%";element_DOM("fenetre_bis").style.height="99%"}else{element_DOM("pleinecran_bis").src=prefixe_image+"/img_pleinecran.png";element_DOM("fenetre_bis").style.top="";element_DOM("fenetre_bis").style.left="";element_DOM("fenetre_bis").style.width="";element_DOM("fenetre_bis").style.height=""}ajuster_boutons_fenetre(true);initialisation_bouton(true);choisir_height_viz_si_pdf()}function ajuster_boutons_fenetre(e){nom_bouton_plein_ecran="conteneur_plein_ecran";if(e)nom_bouton_plein_ecran=nom_bouton_plein_ecran+"_bis";nom_fenetre="fenetre";if(e)nom_fenetre=nom_fenetre+"_bis";nom_bouton_quittter="bye_prev";if(e)nom_bouton_quittter=nom_bouton_quittter+"_bis";nom_bouton_telecharger="telechargement";if(e)nom_bouton_telecharger=nom_bouton_telecharger+"_bis";le_bouton_plein_ecran=element_DOM(nom_bouton_plein_ecran);la_fenetre=element_DOM(nom_fenetre);le_bouton_quittter=element_DOM(nom_bouton_quittter);le_bouton_telecharger=element_DOM(nom_bouton_telecharger);le_bouton_corriger=element_DOM("corriger");if(la_fenetre){if(le_bouton_plein_ecran){var i=la_fenetre.offsetTop+la_fenetre.offsetHeight-40+"px";var r=la_fenetre.offsetLeft+la_fenetre.offsetWidth-50+"px"}if(le_bouton_quittter){var i=la_fenetre.offsetTop+"px";var r=la_fenetre.offsetLeft+la_fenetre.offsetWidth-le_bouton_quittter.offsetWidth+"px"}if(le_bouton_telecharger){var i=la_fenetre.offsetTop+"px";var r=la_fenetre.offsetLeft+la_fenetre.offsetWidth-60+"px"}if(le_bouton_corriger){var i=la_fenetre.offsetTop+"px";var r=la_fenetre.offsetLeft+la_fenetre.offsetWidth-90+"px"}}}window.addEventListener("resize",function(){calcul_grid_gap_barre_verticale();if(element_DOM("conteneur_plein_ecran")||element_DOM("mini_popup")){ajuster_boutons_fenetre();ajuster_boutons_fenetre(true);choisir_height_viz_si_pdf()}});function afficher_discussions(e){if(e){element_DOM("afficher").style.display=""}else{element_DOM("afficher").style.display="none"}}function afficher_ajout(e){if(!e){element_DOM("img_ajout").style.display="none"}else{element_DOM("img_ajout").style.display=""}}function afficher_les_dossiers_dynamiques(e){afficher_le_drive(false);if(e){element_DOM("liste_matieres").style.display="grid"}else{element_DOM("liste_matieres").style.display="none"}}function avec_bouton_back(e){if(e){element_DOM("bouton_precedent").innerHTML='<img alt="<<" src="'+prefixe_image+'/img_retour.png" width = 25 height = 25>';element_DOM("bouton_precedent").addEventListener("click",function(e){decharger_dossier_final()})}else{element_DOM("bouton_precedent").innerHTML=""}if(recuperer("mon_type")==="Administration_bis"||recuperer("mon_type")==="Administration_final"){element_DOM("bouton_precedent").onclick=function(){element_DOM("liste_matieres").innerHTML="";stocker("mon_type","Administration");ajouter_les_dossiers_dynamiques();configurer_profil()}}}function decharger_dossier_final(){positionner_bulle_notif();positionner_pannel_notif();chargement(true);$("#barre_verticale")[0].style.display="";if(recuperer("mon_type").includes("Admin")){element_DOM("liste_matieres").innerHTML=""}ajouter_les_dossiers_dynamiques();afficher_les_dossiers_dynamiques(true);quitter_previsualisation();afficher_fenetre_rendudevoir(false);afficher_ou_non_choix_fichier(false,true);avec_bouton_back(false);afficher_ajout(false);afficher_devoirs(false);afficher_discussions(false);afficher_tri_fichiers(false);afficher_visio(false);enlever_alerte_vide(false);var e=JSON.parse(recuperer("mes_donnees"))["Droits_modifs"];afficher_logs(e==="oui");afficher_liste_eleves(recuperer("mon_type").includes("Administration"));afficher_bulletins(recuperer("mon_type").includes("Eleves"));afficher_discussions(false);afficher_params_si_droits_et_admin();stocker_temp("dossier_chargé","");stocker("les_fichiers","");afficher_discussions(false);stocker("les_topics","");stocker("topic_chargé","");stocker("nb_com_actuel","");stocker("les_coms","");configurer_profil();window.scrollTo(0,0);chargement(false);positionner_bulle_notif();positionner_pannel_notif()}function afficher_le_drive(e){if(e){element_DOM("gros_conteneur").style.display=""}else{element_DOM("gros_conteneur").style.display=""}}function renvoyer_lien_embedded(e,i){if(e==="")return"";if(i){var r="grid"}else{var r="list"}resultat="https://drive.google.com/embeddedfolderview?id="+e+"#"+r;return resultat}function configurer_profil(){$("#accueil_utilisateur").on("click",function(){afficher_modif_profil()});mes_donnees=JSON.parse(recuperer("mes_donnees"));var e="";if(recuperer("mon_type")==="Eleves"){e=mes_donnees["Classe"]}else if(recuperer("mon_type").includes("Administration")){e=mes_donnees["Role"]}else if(recuperer("mon_type")==="Profs"){e="Professeur"}element_DOM("accueil_utilisateur").innerHTML=mes_donnees["Nom"]+" "+mes_donnees["Prénom(s)"]+"  -  "+e;mettre_infos_matiere(false)}initialisation();function mettre_infos_matiere(e){if(e&&$(".matiere_description").length===0){$("#accueil_utilisateur").append('<div onclick="infos_matiere()" class="matiere_description sekooly-mode">Plus d\'informations</div>')}else{$(".matiere_description").remove()}}function switch_mode_livres(e,i){if(i){console.log("par défaut");var r=mode_livres()}else{var r=!e}element_DOM("choix_date_effet").style.visibility=r?"":"hidden";element_DOM("telechargeable").style.visibility=r?"":"hidden";element_DOM("est_telechargeable").checked=r}function mode_livres(){return element_DOM("choix_date_effet").style.visibility==="hidden"}function mode_fichier_initialement(){afficher_choix_youtube(false);afficher_choix_extrait_manuel(false)}function switch_affichage_youtube(){var e=element_DOM("est_video_youtube").checked;element_DOM("nom_youtube").value="";element_DOM("lien_youtube").value="";afficher_choix_youtube(e);afficher_choix_fichier(!e);afficher_checkbox("choix_extrait_manuel",!e);afficher_checkbox_fichier_telechargeable(!e);$("#est_telechargeable")[0].checked=!e;if(e){$("#mettre_fichier_en_ligne").on("click",function(e){if(!pre_validation("lien_youtube")){}else if(!$("#nom_youtube")[0].value){afficher_alerte("Vous devez fournir un titre représentatif de la vidéo youtube.");$("#nom_youtube")[0].focus()}else if(!est_un_lien_drive()&&!est_un_lien_yt()){afficher_alerte("Vous devez fournir un lien youtube valable.");$("#lien_youtube")[0].focus()}else{chargement(true);var i=id_youtube_video($("#lien_youtube")[0].value);var r=$("#nom_youtube")[0].value+(est_un_lien_drive()?"":".youtube");var t=element_DOM("categorie_choisie").value;var n=element_DOM("la_date_limite").value;var a=element_DOM("lheure_limite").value;var t=$("#categorie_choisie")[0].value;var s=$("#date_effet_fichier")[0].value;var o=$("#heure_effet")[0].value;date_heure_actuelle=maintenant();mes_donnees=JSON.parse(recuperer("mes_donnees"));la_classe=recuperer("mon_type")==="Eleves"?mes_donnees["Classe"]:la_matiere_chargee("Classe");la_matiere=recuperer("mon_type")==="Eleves"?$("#accueil_utilisateur")[0].innerText:la_matiere_chargee("Matiere");le_coef=Number($("#coef")[0].value);console.log("le_coef: "+le_coef);nouveau_fichier={date_publication:date_heure_actuelle,id_fichier:i,nom_fichier:r,id_dossier:recuperer("dossier_chargé"),proprietaire:recuperer("identifiant_courant"),categorie_fichier:t,la_date_limite:n,lheure_limite:a,date_effet:s,heure_effet:o,est_telechargeable:"non",coefficient_rendu:le_coef,taille_fichier:0,id_chapitre:$("select#id_chapitre")[0].value};ajouter_un_element("Fichiers",nouveau_fichier,i);id_notif=i+suite_notif();nouvelle_notif={id_notif:id_notif,Horodateur:date_heure_actuelle,Type_notif:"fichier",Id_source:i,"Intitulé":r,Identifiant_originaire:recuperer("identifiant_courant"),Role_originaire:mon_role,Identifiant_derniere_modif:recuperer("identifiant_courant"),Role_derniere_modif:mon_role,Classe:la_classe,Classe_matiere:"("+la_classe+"|"+la_matiere+")",Id_classe_matiere:recuperer("dossier_chargé"),Date_derniere_modif:date_heure_actuelle,Cycle:mes_donnees["Cycle"]};ajouter_un_element("Notifs",nouvelle_notif,id_notif);var _=est_un_lien_drive()?"Le fichier drive a bien été rattaché à la plateforme.":"La vidéo youtube a bien été partagée.";afficher_alerte(_,true)}})}else{$("#mettre_fichier_en_ligne").off("click")}}function id_youtube_video(e){var i=/^.*(youtu\.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;var r=e.match(i);if(r&&r[2].length==11){return r[2]}else{return id_lien_drive(e)}}function id_lien_drive(e){var i=/[-\w]{25,}/;return e.match(i)===null?"ERREUR LIEN":e.match(i)[0]}function est_un_lien_yt(){var e=/^(?:https?:\/\/)?(?:m\.|www\.)?(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))((\w|-){11})(?:\S+)?$/;var i=$("#lien_youtube")[0].value;if(i!==""){return i.match(e)!==null}else{return false}}function est_un_lien_drive(){var e=$("#lien_youtube")[0].value;var i=/[-\w]{25,}/;if(e!==""){return e.match(i)!==null}else{return false}}function afficher_choix_youtube(e){element_DOM("youtube").style.display=e?"":"none"}function afficher_checkbox_fichier_telechargeable(e){element_DOM("telechargeable").style.display=e?"":"none"}function afficher_choix_fichier(e){element_DOM("file").style.display=e?"":"none"}function ne_rien_rendre(){$("#mettre_fichier_en_ligne")[0].disabled=true;$("#mettre_fichier_en_ligne").on("click","")}function activer_envoi_fichier(){$("#mettre_fichier_en_ligne")[0].disabled=false}function afficher_heure_effet_si_examens(){if($("#categorie_choisie")[0].value==="Examens"){$("#titre_date")[0].innerText="Date et heure de l'épreuve:";$("#heure_effet")[0].style.display="";$("#heure_effet")[0].value="07:30"}else{$("#titre_date")[0].innerText="Date d'effet:";$("#heure_effet")[0].style.display="none";$("#heure_effet")[0].value=""}}function pre_validation(e){if($("#categorie_choisie")[0].value==="--"){afficher_alerte("Merci de choisir la catégorie de votre fichier.");return false}else{}if(($("#"+e)[0].value===""||$("#"+e)[0].value==="--")&&!image_temporaire){afficher_alerte("Merci de choisir le fichier, l'extrait de manuel, ou le lien youtube que vous désirez partager.");return false}if($("#date_effet_fichier")[0].value===""||$("#date_effet_fichier")[0].value===null){afficher_alerte("Merci de choisir la date d'effet de votre fichier.");return false}else{}if($("#categorie_choisie")[0].value==="Examens"){if($("#heure_effet")[0].value===""||$("#heure_effet")[0].value===null){afficher_alerte("Merci de choisir l'heure d'effet de votre fichier d'Examen.");return false}else{}}if($("#categorie_choisie")[0].value==="Devoirs"&&element_DOM("la_date_limite").value===""){afficher_alerte("Merci de choisir la date limite du devoir.");return false}else{}if($("#categorie_choisie")[0].value==="Devoirs"&&element_DOM("lheure_limite").value.length<5){afficher_alerte("Merci de choisir l'heure du devoir.");return false}else{}if(impossible_de_cliquer()){afficher_alerte("Merci de patienter.");return false}return true}function base64toBlob(e,i){i=i||"";var r=1024;var t=atob(e.split(",")[1]);var n=t.length;var a=Math.ceil(n/r);var s=new Array(a);for(var o=0;o<a;++o){var _=o*r;var l=Math.min(_+r,n);var c=new Array(l-_);for(var u=_,d=0;u<l;++d,++u){c[d]=t[u].charCodeAt(0)}s[o]=new Uint8Array(c)}return new Blob(s,{type:i,name:nom_image_temporaire})}$(function charger_fichiers(e){var i="https://script.google.com/macros/s/AKfycbwKm1M_Hm2n8bAyqq3jAcDyL65EqKn1-3VMXIw4jMpzqnIeQQI/exec";var d={};var m;var f;$("#file").on("change",function(){var e=this.files;var i=e.length;var n=image_temporaire?base64toBlob(image_temporaire,"image/png"):e[0];m=nom_image_temporaire?nom_image_temporaire:n.name;f=m.split(".").pop().toUpperCase();le_coef=Number($("#coef")[0].value);$("#mettre_fichier_en_ligne").on("click",function(e){e.preventDefault();var i=$("#categorie_choisie")[0].value;var r=pre_validation("file");if(r===false){return-1}if(n.size>25e6){afficher_alerte("Votre fichier excède 25 MO: impossible de le mettre en ligne.");return-1}var t=new FileReader;t.onprogress=function(e){chargement(true)};t.onload=function(e){d.file=e.target.result.replace(/^.*,/,"");i=element_DOM("categorie_choisie").value;la_date_limite=element_DOM("la_date_limite").value;lheure_limite=element_DOM("lheure_limite").value;date_effet_fichier=$("#date_effet_fichier")[0].value;heure_effet=$("#heure_effet")[0].value;if(i==="Bulletins"){if(f.toLowerCase()!=="pdf"){afficher_alerte("Le fichier de bulletins doit être un fichier pdf.");chargement(false);return-1}liste_destinataires=$("#attribution").serialize().split("&");destinataire_par_page={};liste_destinataires.forEach(function(e,i){numero_page=e.split("=")[0];id_eleve=decodeURIComponent(e.split("=")[1]);if(destinataire_par_page[id_eleve]){destinataire_par_page[id_eleve]=destinataire_par_page[id_eleve]+","+numero_page}else{destinataire_par_page[id_eleve]=numero_page}});destinataire_par_page=JSON.stringify(destinataire_par_page);periode_bulletin=$("[name='periode_bulletin']")[0].value;a(i,la_date_limite,lheure_limite,date_effet_fichier,heure_effet,le_coef,n.size,destinataire_par_page,periode_bulletin)}else{a(i,la_date_limite,lheure_limite,date_effet_fichier,heure_effet,le_coef,n.size)}};t.readAsDataURL(n)});categorie_fichier=element_DOM("categorie_choisie").value;la_date_limite=element_DOM("la_date_limite").value;lheure_limite=element_DOM("lheure_limite").value;date_effet_fichier=$("#date_effet_fichier")[0].value;heure_effet=$("#heure_effet")[0].value;$("#attribution").remove();$("#trimestre").remove();if(categorie_fichier==="Bulletins"){if(f.toLowerCase()!=="pdf"){afficher_alerte("Le fichier de bulletins doit être un fichier pdf.");chargement(false);return-1}else{nombre_de_pages_pdf=-1;var r=new FileReader;r.onload=function(e){nombre_de_pages_pdf=0;pdf=new Uint8Array(e.target.result);try{PDFJS.getDocument({data:pdf}).then(function(e){nombre_de_pages_pdf=e.pdfInfo.numPages;t(nombre_de_pages_pdf,$("#mettre_fichier_en_ligne"))})}catch(e){console.error(e);alert("Impossible de détecter le nombre de pages du pdf : merci de réessayer avec un autre fichier.");return 0}};r.readAsArrayBuffer(n)}}});$("#categorie_choisie").on("change",function(){afficher_eventuelle_alerte_effet();afficher_eventuelle_alerte_limite();if($("#categorie_choisie")[0].value==="Devoirs"){n(true)}else{n(false)}if($("#categorie_choisie")[0].value==="Devoirs"||$("#categorie_choisie")[0].value==="Examens"){afficher_choix_coef(true)}else{afficher_choix_coef(false)}changement_quiz_ou_non();if($("#categorie_choisie")[0].value==="Manuels"){switch_mode_livres(true)}else{switch_mode_livres(false)}afficher_heure_effet_si_examens()});$("#date_effet_fichier").on("change",function(){if($("#date_effet_fichier")[0].value==="")$("#date_effet_fichier")[0].value=moment().format("yyyy-MM-DD");afficher_eventuelle_alerte_effet()});$("#la_date_limite").on("change",function(){afficher_eventuelle_alerte_limite()});$("#heure_effet").on("change",function(){if($("#heure_effet")[0].value===""&&$("#categorie_choisie")[0].value==="Examens"){$("#heure_effet")[0].value="07:30"}});function t(e,i){toutes_les_classes=JSON.parse(recuperer("mes_matieres"));classe_chargee=toutes_les_classes.filter(e=>e["ID_URL"]===recuperer("dossier_chargé"))[0]["Classe"];url=racine_data+"Eleves?Classe=eq."+classe_chargee+"&"+apikey;liste_eleves=get_resultat(url);liste_eleves=liste_eleves.sort(function(e,i){if(e.Identifiant<i.Identifiant){return-1}if(e.Identifiant>i.Identifiant){return 1}return 0});select_liste_eleves='<select style="width: 80%;" name="numero_page" id="numero_page">';select_liste_eleves=select_liste_eleves+r("--","--");liste_eleves.forEach(function(e,i){select_liste_eleves=select_liste_eleves+r(e["Identifiant"],e["Nom"]+" "+e["Prénom(s)"])});select_liste_eleves=select_liste_eleves+"</select>";attribution='<form id="trimestre" style=""><b><label for="periode_bulletin">Trimestre:<select style="width: 60%;" name="periode_bulletin"><option value="PREMIER TRIMESTRE">PREMIER TRIMESTRE</option><option value="DEUXIEME TRIMESTRE">DEUXIEME TRIMESTRE</option><option value="TROISIEME TRIMESTRE">TROISIEME TRIMESTRE</option><option value="ANNUEL">ANNUEL</option></select></label></b></form>';attribution=attribution+'<form id="attribution" style="margin-top: 20px;">';for(numero_page=1;numero_page<=e;numero_page++){attribution=attribution+'<div><label for="'+numero_page+'">Page n°'+numero_page+":"+select_liste_eleves.replace(/"numero_page"/g,numero_page)+"</label></div>"}attribution=attribution+"</form>";$(attribution).insertBefore(i);for(numero_page=1;numero_page<=e;numero_page++){$("#"+numero_page)[0].value=liste_eleves[numero_page-1]["Identifiant"]}}function r(e,i){return'<option value="'+e+'">'+i+"</option>"}function n(e){if(e){element_DOM("choix_date").style.display="grid"}else{element_DOM("choix_date").style.display="none"}}function a(t,n,a,s,o,_,l,c,u){var e='<form method="post"  action="'+i+'" id="envoyer_le_fichier" style="display: none;" >';e+='<input type="hidden" name="API_KEY_UPLOAD" value="'+recuperer("API_KEY_UPLOAD")+'" >';e+='<input type="hidden" name="nom_fichier" value="'+m+'" >';e+='<input type="hidden" name="extension" value="'+f+'" >';e+='<input type="hidden" name="file" value="'+d.file+'" >';e+='<input type="hidden" name="folderID" value="'+recuperer("dossier_chargé")+'" >';e+='<input type="hidden" name="proprietaire" value="'+recuperer("identifiant_courant")+'" >';e+='<input type="hidden" name="categorie_fichier" value="'+t+'" >';e+='<input type="hidden" name="la_date_limite" value="'+n+'" >';e+='<input type="hidden" name="lheure_limite" value="'+a+'" >';e+='<input type="hidden" name="date_effet_fichier" value="'+s+'" >';e+='<input type="hidden" name="heure_effet" value="'+o+'" >';e+='<input type="hidden" name="coefficient_rendu" value="'+_+'" >';e+='<input type="hidden" name="taille_fichier" value="'+l+'" >';e+='<input type="hidden" name="destinataire_par_page" value="'+c?c:""+'" >';e+='<input type="hidden" name="periode_bulletin" value="'+u?u:""+'" >';e+="</form>";$("body").append(e);$("#envoyer_le_fichier").submit(function(e){e.preventDefault();if(!extension_ok(f)){alert("L'extension du fichier n'est pas supporté par la plateforme, merci de réessayer avec l'un de ces formats: bmp, gif, jpeg, jpg, png, svg, pdf, bmp, xlsx, xls, xlsm, ppt, pptx, doc, docx, txt, html, csv, js, rtf, mp4, mp3, wav");chargement(false);activer_envoi_fichier();return-1}ne_rien_rendre();var i=$(this);var r=i.attr("action");$.ajax({type:"POST",url:r,data:i.serialize(),success:function(e){var i=element_DOM("snackbar");i.innerText="Votre fichier a bien été mis en ligne.";i.className="show";date_heure_actuelle=maintenant();mes_donnees=JSON.parse(recuperer("mes_donnees"));la_classe=recuperer("mon_type")==="Eleves"?mes_donnees["Classe"]:la_matiere_chargee("Classe");la_matiere=recuperer("mon_type")==="Eleves"?$("#accueil_utilisateur")[0].innerText:la_matiere_chargee("Matiere");est_telechargeable=$("#est_telechargeable")[0].checked?"oui":"non";nouveau_fichier={date_publication:date_heure_actuelle,id_fichier:e,nom_fichier:m,id_dossier:recuperer("dossier_chargé"),proprietaire:recuperer("identifiant_courant"),categorie_fichier:t,la_date_limite:n,lheure_limite:a,date_effet:s,heure_effet:o,est_telechargeable:est_telechargeable,coefficient_rendu:_,taille_fichier:l,destinataire_par_page:c,periode_bulletin:u};ajouter_un_element("Fichiers",nouveau_fichier,e);id_notif=e+suite_notif();nouvelle_notif={id_notif:id_notif,Horodateur:date_heure_actuelle,Type_notif:"fichier",Id_source:e,"Intitulé":m,Identifiant_originaire:recuperer("identifiant_courant"),Role_originaire:mon_role,Identifiant_derniere_modif:recuperer("identifiant_courant"),Role_derniere_modif:mon_role,Classe:la_classe,Classe_matiere:"("+la_classe+"|"+la_matiere+")",Id_classe_matiere:recuperer("dossier_chargé"),Date_derniere_modif:date_heure_actuelle,Cycle:mes_donnees["Cycle"]};ajouter_un_element("Notifs",nouvelle_notif,id_notif);setTimeout(function(){i.className="";location.reload()},3e3);chargement(false)},error:function(e){var i=element_DOM("snackbar");i.innerText="Erreur interne du serveur, veuillez réessayer. Assurez-vous d'être toujours connecté à internet.";i.className="show";chargement(false)}})});$("#envoyer_le_fichier").submit();$("#envoyer_le_fichier").remove()}});function fichier_devoir_ou_examen(){var e=$("#categorie_choisie")[0].value;return e==="Devoirs"||e==="Examens"}function afficher_eventuelle_alerte_effet(){if(fichier_devoir_ou_examen()){afficher_les_devoirs_de_la_date("date_effet",$("#date_effet_fichier")[0].value,"mere_effet","nb_devoirs_effet")}else{$("#mere_effet")[0].style.display=""}}function afficher_eventuelle_alerte_limite(){if(fichier_devoir_ou_examen()){afficher_les_devoirs_de_la_date("la_date_limite",$("#la_date_limite")[0].value,"mere_limite","nb_devoirs_limite")}else{$("#mere_limite")[0].style.display=""}}async function afficher_les_devoirs_de_la_date(e,i,r,t){var n=JSON.parse(recuperer("mes_matieres")).find(e=>e["ID_URL"]===recuperer("dossier_chargé"))["classe_id"];var a=await rechercher("Matieres","classe_id",n,"ID_URL");les_id_dossier_classe='("'+a.map(e=>e["ID_URL"]).join('","')+'")';url=racine_data+"Fichiers?"+apikey;url+='&categorie_fichier=in.("Devoirs","Examens")';url+="&"+e+"=eq."+i;url+="&id_dossier=in."+les_id_dossier_classe;var s=get_resultat(url).length;if(s>0){$("[id='"+t+"']")[0].innerText=s;$("#"+r)[0].style.display="block"}else{$("#"+r)[0].style.display=""}}document.onclick=function(e){if(e.target.id===""&&e.target.onclick===null&&e.target.classeName===""){quitter_previsualisation()}if(typeof e.target.className==="string"){if(e.target.id!=="bulle_notif"&&e.target.id!=="recup_notifs"&&!e.target.className.includes("notif")&&e.target.id!=="rien_lire"&&e.target.id!=="tout_lire"){virer_le_pannel_notifs()}}if(!e.target.id.toLowerCase().includes("devoir")&&!e.target)afficher_fenetre_rendudevoir(false);if(e.target.nodeName==="BODY"||e.target.id==="gros_conteneur"||e.target.id==="liste_matieres"||e.target.id.includes("drive_")){masquer_config_mode();fermer_side_bar()}};$(document).keyup(function(e){if(e.key==="Escape"){quitter_previsualisation();afficher_fenetre_rendudevoir(false);virer_le_pannel_notifs();afficher_ou_non_choix_fichier(false);masquer_config_mode()}if(e.key==="¤"){mode_edition_sql()}});async function mode_edition_sql(){if(recuperer("identifiant_courant").includes("admin")){confirmation=prompt("Merci de saisir votre code d'accès.");if(confirmation){c=await recuperer_mes_donnees();if(!code_ok(c,confirmation)){afficher_alerte("Code d'accès erroné, mode administrateur non activé.")}else{zknrsbnfwz()}}}}function zknrsbnfwz(){vider_fenetre("Mode ADMIN - SQL");afficher_fenetre(true);$("#fenetre").append(contenu_admin());$("#query").focus()}function changer_alerte_exe(e,i,r,t){if(!element_DOM("remarque-exe"))return false;var n=document.createElement("div");n.id=e;n.innerHTML="<b>"+new Date+"</b> \t"+i;n.style.color=r;n.style.paddingBottom="10px";if(!t)$("#remarque-exe")[0].innerHTML="";element_DOM("remarque-exe").appendChild(n)}function contenu_admin(){return`
				<div id="mode-admin" class="mode-admin"><div id="attention-admin" class="attention-admin">
					<b>
						<rouge>ATTENTION, SI VOUS ÊTES ICI SANS LE VOULOIR, QUITTEZ DIRECTEMENT CETTE FENÊTRE.</rouge>
					</b>
					<div>VOUS ÊTES EN MODE ADMINISTRATEUR.</div>
					</div>
					  
					<div>
					  	<label for="query">Votre requête SQL:</label>
					  	<textarea name="query" id="query" class="query"></textarea>
				  	</div>
				</div>

				<div class="au-centre">
					<div>
					  <input type="checkbox" id="mode-select" name="mode-select" checked="">
					  <label for="mode-select">En mode SELECT</label> 
					</div>
					<button class="btn-exe" onclick="exe_sql()" id="exe">Exécuter le code SQL</button>

					<button style="display:none;" class="btn-exe" id="deploy">Continuer</button>
					<div id="remarque-exe"></div>
				</div>

			`}async function exe_sql(){var e=await recherche_initiale("Etablissements");var i=e.find(e=>e["nom_etablissement"]==="testo");await exe_sql_unitaire(i);$("#deploy").show();chargement(false);$("#deploy").off("click");$("#deploy").one("click",function(){$("#deploy").hide();$("#deploy").off("click");e=e.filter(e=>e["nom_etablissement"]!=="testo");e.forEach(async function(e){await exe_sql_unitaire(e,true)});chargement(false)})}async function exe_sql_unitaire(e,i){chargement(true);var r=element_DOM("query").value;var t=e["id_etablissement"];var n='<span class="affichage_etablissement">'+e["nom_etablissement"]+"</span>"+": ";try{var a=await execute_sql(e["racine_data"],r,element_DOM("mode-select").checked);n+=JSON.stringify(a);var s="green"}catch(o){n+=JSON.stringify(o);var s="red"}changer_alerte_exe(t,n,s,i)}function charger_les_topics(e){if(impossible_de_cliquer()&&!e)return-1;est_deja_ouvert=element_DOM("fenetre").style.visibility==="visible";if(e)est_deja_ouvert=false;afficher_fenetre(!est_deja_ouvert);return recuperer_les_topics(false)}function html_boutons_fenetre(e,i,r){return'<div id="entete-fenetre" style="text-align: center;"> <img alt="actualiser"  src="'+prefixe_image+'/img_actualiser.png" onclick="'+e+'" id="actu_topics" class="image-en-haut-fenetre"> <img alt="ajouter" src="'+prefixe_image+'/img_ajout.png" onclick="'+i+'" id="nouvelle_discu" class="image-en-haut-fenetre"></div><div id="entete-fenetre" style="text-align: center;color: #c1c1c1;font-size: 13px;border-bottom-width: 1px;border-bottom-style: ridge;">'+r+"</div>"}function ajouter_une_discu(){var e=false;if(e){alert("Impossible de créer une question/discussion pour le moment.");return-1}if(impossible_de_cliquer())return-1;if(!recuperer("mon_type").includes("Admin")&&element_DOM("accueil_utilisateur").innerText.includes("Vie scolaire")){alert("Vous n'avez pas les droits pour publier une discussion dans la Vie Scolaire. Pour tout problème constaté sur la plateforme, envoyez directement un mail à "+data_etablissement["contact_etablissement"]+".");return-1}vider_fenetre("Nouvelle discussion");element_DOM("maquestion").src="";var i='<form id="mon_formulaire" autocomplete="off" class="edition"><label id="label" for="titre_question">Titre: </label><input type="text" id="titre_question" maxlength="50" style="width: 100%;">\t<br><br><label id="label" for="contenu_question">Votre message: </label><textarea id="contenu_question" maxlength="1700" style="width: 100%;height: 70%;resize: none;font-size: 13px;"></textarea><div id="nb_max_div" style="margin-left: 90%;margin-top: 0%;font-size: 10px; display:none;"> <font id="nb_max"> 0 / 1700</font> </div><div id="mes_boutons" style="text-align: center;padding: 1%;display: block ruby;"><button  class="bouton_sekooly sekooly-mode-background" type="button" id="Annuler" onclick="recuperer_les_topics(false)"> Annuler </button><button  class="bouton_sekooly sekooly-mode-background" type="button" id="envoi" onclick="envoyer_le_topic()"> Poster </button></div><div id="msg_erreur" style="text-align: center;padding: 1%;color: green;"> </div></form>';var r=document.createElement("span");r.innerHTML=i;element_DOM("fenetre").appendChild(r);rendre_riche("contenu_question",true);element_DOM("titre_question").focus()}function changer_nb_caracteres(){element_DOM("nb_max").innerText=element_DOM("contenu_question").textLength+" / 1700"}function actualiser_topics(){recuperer_les_topics(true)}function actualiser_coms(e){charger_question(e,true)}function envoyer_le_com(e,i,r,t,n){var a=t;var s=chercher_le_mot_interdit(a);if(s!==""){alert("Vous n'avez pas le droit d'utiliser le terme '"+s+"' dans le cadre des cours à "+nom_etablissement+" sur SEKOOLY.");return-1}element_DOM("envoicommentaire").disabled=true;chargement(true);nom_table="Topic";nb_com=nb_coms(e)+1;stocker("nb_com_actuel",nb_com);date_heure_actuelle=maintenant();nouveau_com={Horodateur:date_heure_actuelle,Id_topic:e,Votre_commentaire:recuperer_html_saisie_riche(),Identifiant:recuperer("identifiant_courant"),Role:r};ajouter_un_element("Coms",nouveau_com);actualiser("Topic","Id_topic",e,{Nombre_de_coms:nb_com});nom_table="Notifs";nom_champ_reference="Id_source";valeur_champ_reference=e;nouvelles_donnees_notif={Date_derniere_modif:date_heure_actuelle,Identifiant_derniere_modif:recuperer("identifiant_courant"),Role_derniere_modif:r};actualiser(nom_table,nom_champ_reference,e,nouvelles_donnees_notif);ajouter_un_commentaire(i,r,t,n,"nouveau_com");ajouter_bloc_commenter(false,"ajouter_mon_com()","Commenter");ajouter_bloc_commenter(true,"ajouter_mon_com()","Commenter");$("#retour").on("click",function(){recuperer_les_topics(true)});stocker("les_coms","");chargement(false)}function chercher_le_mot_interdit(i){if(!data_etablissement["mots_interdits"])return"";var e=data_etablissement["mots_interdits"].split(",");var r="";e.some(function(e){contient=i.toLowerCase().includes(e.toLowerCase());r=contient?e:"";return contient});return r}function envoyer_le_topic(){var e=encodeURIComponent(element_DOM("titre_question").value.trim());var i=recuperer_html_saisie_riche();var r=recuperer("identifiant_courant");var t=chercher_le_mot_interdit(i);if(t!==""){alert("Vous n'avez pas le droit d'utiliser le terme '"+t+"' dans le cadre des cours à "+nom_etablissement+" sur SEKOOLY.");return-1}var n=recuperer("dossier_chargé");if(e!==""&&i!==""&&!i.includes(saisie_vide())){element_DOM("envoi").disabled=true;nom_table="Topic";date_heure_actuelle=maintenant();id_topic=nouvel_id(nom_table,"Id_topic");nouveau_topic={Id_topic:id_topic,Horodateur:date_heure_actuelle,Titre:$("#titre_question")[0].value,Votre_message:recuperer_html_saisie_riche(),Identifiant:recuperer("identifiant_courant"),Id_classe_matiere:recuperer("dossier_chargé"),Role:mon_role,Nombre_de_coms:0};ajouter_un_element(nom_table,nouveau_topic,id_topic);nom_table="Notifs";mes_donnees=JSON.parse(recuperer("mes_donnees"));la_classe=recuperer("mon_type")==="Eleves"?mes_donnees["Classe"]:la_matiere_chargee("Classe");la_matiere=recuperer("mon_type")==="Eleves"?$("#accueil_utilisateur")[0].innerText:la_matiere_chargee("Matiere");id_notif=id_topic;nouvelle_notif={id_notif:id_notif,Horodateur:date_heure_actuelle,Type_notif:"discussion",Id_source:id_topic,"Intitulé":$("#titre_question")[0].value,Identifiant_originaire:recuperer("identifiant_courant"),Role_originaire:mon_role,Identifiant_derniere_modif:recuperer("identifiant_courant"),Role_derniere_modif:mon_role,Classe:la_classe,Classe_matiere:"("+la_classe+"|"+la_matiere+")",Id_classe_matiere:recuperer("dossier_chargé"),Date_derniere_modif:date_heure_actuelle,Cycle:mes_donnees["Cycle"]};ajouter_un_element(nom_table,nouvelle_notif,id_notif);setTimeout(function(){actualiser_topics()},1500)}else{var a="Il faut un titre et un contenu de message.";changer_msg_erreur(a,true)}chargement(false);return false}function changer_msg_erreur(e,i){if(i)element_DOM("msg_erreur").style.color="red";if(!i){vider_fenetre();ajouter_div_msg_erreur();element_DOM("msg_erreur").style.marginTop="20%";element_DOM("msg_erreur").style.color="green";setTimeout(function(){stocker("les_topics","");window.location.href=window.location.href},3e3)}element_DOM("msg_erreur").innerText=e}function vider_fenetre(e,i,r){element_DOM("fenetre").innerHTML="";var t=i?"":'onclick="quitter_previsualisation()"';var n='<div id="entete-fenetre" style="display: inline-flex;float: right;"><img alt="X" src="'+prefixe_image+'/quitter.png" id="bye_prev" class="bye_prev" '+t+" > </div>";var a="";if(e)a='<div class="titre_fenetre" id="titre_fenetre">'+e+"</div>";var s='<div class="fullscreen-btn" id="conteneur_plein_ecran" > <img alt="plein écran" style="position: fixed;" id="pleinecran" src="'+prefixe_image+'/img_petitecran.png" onclick="switch_mode()" class="pleinecran"> </div>';var o=document.createElement("div");o.innerHTML=n+a+s;while(o.firstChild){element_DOM("fenetre").appendChild(o.firstChild)}avec_sauvegarde(r);ajuster_boutons_fenetre();initialisation_bouton()}function charger_question(e,i,r){if(e){stocker("topic_chargé",e);recuperer_les_coms(e,i,r)}return true}function recuperer_les_coms(e,i,r){chargement(true);var t=recuperer("topic_chargé");if(t===null)t="";var n=t.toString();var a=e.toString();stocker("nb_com_actuel",$("u#"+a+".nb_com_actuel")[0].innerText);ajouter_poste_initial(e);if(a!==n||i===true){stocker("les_coms","")}if(recuperer("les_coms")===null||recuperer("les_coms")===""||recuperer("les_coms")==="[]"||i){nom_table="Coms";nom_champ_reference="Id_topic";valeur_champ_reference=a;rechercher(nom_table,nom_champ_reference,valeur_champ_reference).then(e=>{les_coms=e;if(les_coms!==undefined&&les_coms!==null&&les_coms.length>0){stocker("topic_chargé",a.toString());stocker("les_coms",JSON.stringify(les_coms));traitement_coms(a,r)}})}else{traitement_coms(a,r)}chargement(false)}function ajouter_poste_initial(i){var e=JSON.parse(recuperer("les_topics"));var r=e.filter(function(e){return e["Id_topic"].toString()===i.toString()});var t=r[0];vider_fenetre("");var n=t["Titre"];var a=t["Identifiant"].toUpperCase();var s=t["Role"];var o=decodage(t["Votre_message"]);var _=afficher_date(t["Horodateur"]);var l='\t<div id="entete_poste" style="display: flex;overflow-wrap: anywhere;"><img id="<<" src="'+prefixe_image+'/img_retour.png" style="width: 30px;margin: 2%;cursor:pointer;height: 30px;"  onclick="recuperer_les_topics(false)"> <div id="titre_du_poste" style="font-weight: bold;margin: 2%;font-size: 25px;">'+n+"</div></div>";var c=document.createElement("div");c.innerHTML=l;element_DOM("fenetre").appendChild(c);var u='<div id="bloc_poste" style="padding: 2%;display: block;overflow-wrap: anywhere;border-bottom-style: solid;"><div class="auteur_du_poste sekooly-mode" >'+a+" ("+s+')</div><h id="contenu_poste" style=""> '+o+'</h><h class="date_poste"> '+_+"</h></div>";var d='<div id="emplacement_commentaire"></div>';var m=document.createElement("div");m.id="liste_des_coms";m.style.overflow="hidden auto";m.style.height="85%";m.innerHTML=u+d;element_DOM("fenetre").appendChild(m);ajouter_bloc_commenter(true,"ajouter_mon_com()","Commenter")}function ajouter_bloc_commenter(e,i,r){if(e){var t='<div id="bloc_commenter"><textarea id="mon_com" style="display:inline-block; width:100%; resize: unset; min-height:200px; overflow-y:hidden;" placeholder="Votre commentaire..." maxlength="1500"></textarea><button class="sekooly-mode-background" id="envoicommentaire" onclick="'+i+'" style="height: 30px;">'+r+"</button></div>";var n=document.createElement("div");n.innerHTML=t;while(n.firstChild){element_DOM("liste_des_coms").appendChild(n.firstChild)}rendre_riche("mon_com")}else{if(element_DOM("bloc_commenter")!==null)element_DOM("bloc_commenter").remove()}}function traitement_coms(e,i){chargement(true);var r=JSON.parse(recuperer("les_coms"));r=Object.keys(r).map(e=>r[e]);r=r.sort(function n(e,i){return convertir_en_date(e.Horodateur)-convertir_en_date(i.Horodateur)});var a=0;r.forEach(function(e){if(e!==null){var i=e["Identifiant"].toUpperCase();var r=e["Role"];var t=e["Votre_commentaire"];var n=afficher_date(e["Horodateur"]);a=e["id_com"];ajouter_un_commentaire(i,r,t,n,a)}});if(i){var t=$("#bloc_commenter")[0].offsetTop-$("#bloc_commenter")[0].offsetHeight;$("#liste_des_coms").scrollTop(t);changer_couleur_temporairement(a,"un_commentaire","#5e5e5e",700)}chargement(false)}function ajouter_un_commentaire(e,i,r,t,n){r=decodage(r);var a='<div id="'+n+'" class="un_commentaire"><div class="auteur_du_poste sekooly-mode">'+e+" ("+i+')</div><h id="contenu_poste" style=""> '+r+'</h><h class="date_poste"> '+t+"</h></div>";var s=document.createElement("div");s.innerHTML=a;if(element_DOM("emplacement_commentaire")){while(s.firstChild){element_DOM("emplacement_commentaire").appendChild(s.firstChild)}}}function ajouter_mon_com(){chargement(true);var e=recuperer_html_saisie_riche().trim();contenu_vide=e.includes(saisie_vide());if(e!==""&&!contenu_vide){var i=recuperer("identifiant_courant").toUpperCase();var r=afficher_date(maintenant());id_topic=recuperer("topic_chargé");envoyer_le_com(id_topic,i,mon_role,e,r)}else{alert("Votre commentaire ne peut pas être vide.")}chargement(false)}function recuperer_les_topics(e){chargement(true);vider_fenetre("");afficher_fenetre(true);element_DOM("fenetre").innerHTML+=html_boutons_fenetre("actualiser_topics()","ajouter_une_discu()","Pour commenter, cliquez sur une question/discussion");if(e||recuperer("les_topics")===null||recuperer("les_topics")===""){nom_table="Topic";nom_champ_reference="Id_classe_matiere";valeur_champ_reference=recuperer("dossier_chargé");nom_champ_a_chercher="";return rechercher(nom_table,nom_champ_reference,valeur_champ_reference,nom_champ_a_chercher).then(e=>{e.sort(function tri_ordre_chrono_decroissant(e,i){return convertir_en_date(i.Horodateur)-convertir_en_date(e.Horodateur)});stocker("les_topics",JSON.stringify(e));traitement_topics();chargement(false)})["catch"](e=>{console.error(e);alert("Impossible de récupérer les questions/discussions de cette matière. Vérifiez que vous êtes toujours connecté à internet, ou réessayer plus tard.");chargement(false)})}else{traitement_topics();chargement(false);return true}}function traitement_topics(){stocker("les_coms","");if(recuperer("les_topics").length===0||recuperer("les_topics")==="[]"){commentaire='<div id="vide" style="text-align: center;color: grey;margin: 10%;"> <i id="vide"> Il n\'y a pas encore de questions posées dans ce cours. </i> </div>';var e=document.createElement("div");e.innerHTML=commentaire;while(e.firstChild){element_DOM("fenetre").appendChild(e.firstChild)}}else{var i=JSON.parse(recuperer("les_topics"));if(!element_DOM("div_liste_topics")){var c=document.createElement("div");c.style.overflowX="hidden";c.style.overflowY="auto";c.id="div_liste_topics";c.style.height="90%";element_DOM("fenetre").appendChild(c)}else{var c=element_DOM("div_liste_topics")}i.forEach(function(e){var i=e["Titre"];element_contenu=document.createElement("div");element_contenu.innerHTML=e["Votre_message"];var r=element_contenu.innerText;var t=afficher_date(e["Horodateur"]);var n=e["Identifiant"]+" ("+e["Role"]+")";var a=e["Id_topic"];var s=e["Nombre_de_coms"];if(s===undefined)s=0;var o='<span id="bye'+a+'"><img alt="supprimer" class="byebye" onclick="event.stopPropagation(); clic_de_poubelle_topic(this)" src="'+prefixe_image+'/img_trash.png" style="width: 20px;position: relative;float: right;" id="bye'+a+'"></span>';if(!recuperer("mon_type").includes("Administration")&&e["Identifiant"]!==recuperer("identifiant_courant").trim())o="";var _='<ul class="bloc_topic" onclick="clic_de_topic(this)" id="'+a+'"> '+o+' <p id="'+a+'" style="font-size: 25px; margin:0px;"> <b class="contenu_question" id="'+a+'"> '+i+'  </b> <p id="'+a+'" class="contenu_question"> '+r+'</p><i class="petite_ecriture"> <h id="'+a+'"><u id="'+a+'"> Nombre de réponses</u>: <u class="nb_com_actuel" id="'+a+'">'+s+'</u> </h> <h id="'+a+'">  &emsp; <u id="'+a+'"> Publié le</u>: '+t+' </h><h id="'+a+'">  &emsp; <u id="'+a+'"> Publié par</u>: '+n+" </h></i></ul>";var l=document.createElement("div");l.innerHTML+=_;while(l.firstChild)c.appendChild(l.firstChild)})}}function clic_de_topic(e){charger_question(e.id,false)}function clic_de_poubelle_topic(e){id=e.id.split("bye")[1];accepter_suppression=window.confirm("Êtes vous sûr de vouloir supprimer ce fil de discussion?");if(accepter_suppression){chargement(true);supprimer("Coms","Id_topic",id);supprimer("Topic","Id_topic",id);supprimer("Notifs","id_notif",id);setTimeout(function(){actualiser_topics()},1500);chargement(false)}}function decodage(e){return e.replace(/(?:\r\n|\r|\n)/g,"<br>")}function impossible_de_cliquer(){return element_DOM("img_chargement").style.visibility==="visible"}function supprimer_topic(e){if(impossible_de_cliquer())return-1;chargement(true);var i="https://script.google.com/macros/s/AKfycbycJOH1smLn37Bk91cp3bmBHbZJmHknSrvTkeBMEqMFMbuRv9k/exec";var r='<form method="post"  action="'+i+'" id="supprimer_un_topic" style="display: none;" >';r+='<input type="hidden" name="mode" value="supprimer" >';r+='<input type="hidden" name="id_topic" value="'+e+'" >';r+="</form>";$("body").append(r);var t=$("#supprimer_un_topic");$.ajax({type:"POST",url:i,data:t.serialize(),success:function(e){actualiser_topics()}});$("#supprimer_un_topic").remove()}function supprimer_fichier(r){var e=confirm("⚠️Êtes-vous sûr de vouloir supprimer ce fichier ? Cette action est irréversible.");if(!e)return-1;chargement(true);var i="https://script.google.com/macros/s/AKfycbw_04bdiepfQ0P9Ddtn6nyRPjxzxumORN4J8xm7bnmu7yO3HvQ/exec";if($("#"+r)[0].parentNode.id==="drive_manuels"){i="https://script.google.com/macros/s/AKfycbzZr7c0Ej4QdA0CxHjXdR35eW6USvpkyBUdBQ8lVygc65vOolA/exec"}var t='<form method="post"  action="'+i+'" id="supprimer_un_fichier" style="display: none;" >';t+='<input type="hidden" name="id_fichier" value="'+r+'" >';t+='<input type="hidden" name="API_KEY_DELETE" value="'+recuperer("API_KEY_DELETE")+'" >';t+="</form>";$("body").append(t);var n=$("#supprimer_un_fichier");$.ajax({type:"POST",url:i,data:n.serialize(),success:function(e){console.log(e);var i=element_DOM("snackbar");i.innerText=e;i.className="show";supprimer_rendus_du_fichier(r);supprimer("Notifs","id_notif",r+suite_notif());supprimer("Fichiers","id_fichier",r);setTimeout(function(){i.className="";window.location.href=window.location.href},4e3);chargement(false)},error:function(e){console.log(e);alert("Impossible de supprimer le fichier. Vérifiez que vous êtes toujours connecté à internet.")}})}function supprimer_rendus_du_fichier(e){rechercher("Rendus","id_fichier_sujetdevoir",e,"").then(e=>{if(e.length>0){for(var i=e.length-1;i>=0;i--){id_fichier_donné=e[i]["id_fichier"];id_devoir_rendu=e[i]["id_devoir"];console.log(e[i]);supprimer_devoir("",id_fichier_donné,id_devoir_rendu)}}})["catch"](e=>{console.error(e)})}function ajouter_iframe_edt(){var e='<iframe id="calendrier" src="" frameborder="0" scrolling="no"> </iframe>';var i=document.createElement("div");i.innerHTML=e;element_DOM("fenetre").appendChild(i.firstChild)}function recuperer_edt(e){chargement(true);vider_fenetre("Emploi du temps");ajouter_iframe_edt();afficher_fenetre(true);var i="Tous";if(recuperer("mon_type")==="Administration_bis"||recuperer("dossier_chargé"))i=la_matiere_chargee("Classe");if(recuperer("mon_type")==="Eleves")i=JSON.parse(recuperer("mes_donnees"))["Classe"];if(e)i=e;var r=element_DOM("calendrier");r.src="";nom_table="Classes";nom_champ_reference="Classe";valeur_champ_reference=i;nom_champ_a_chercher="id_googlecalendar";rechercher(nom_table,nom_champ_reference,valeur_champ_reference,nom_champ_a_chercher).then(e=>{e=e[0]["id_googlecalendar"];var i="https://calendar.google.com/calendar/embed?wkst=2&bgcolor=%23ffffff&ctz="+my_ctz()+"&src="+e+"&color=%234285F4&showPrint=0&showTabs=0&showCalendars=0&showTitle=1&mode=WEEK&showTz=0";r.src=i;chargement(false)})["catch"](e=>{console.error(e);alert("Calendrier introuvable, veuillez réessayer.");chargement(false)})}function supprimer_cookies_google(){var e=document.cookie.split(";");for(var i=0;i<e.length;i++){console.log("cookie: "+e[i]);var r=e[i].indexOf("=");var t=r>-1?e[i].substr(0,r):e[i];document.cookie=t+"=;expires=Thu, 01 Jan 1970 00:00:00 GMT"}}var intervalle_en_ms=6e4;var en_boucle=false;function pannel_notifs_deja_visible(){return $("#pannel_notif").is(":visible")}function virer_le_pannel_notifs(){if(element_DOM("pannel_notif"))element_DOM("pannel_notif").style.display="none"}function switch_pannel_notifs(){if(impossible_de_cliquer())return-1;chargement(true);var e=!pannel_notifs_deja_visible();element_DOM("pannel_notif").style.display=e?"block":"none";if(e){mes_notifs=JSON.parse(recuperer("mes_notifs"));if(!mes_notifs||mes_notifs.length===0)element_DOM("pannel_notif").innerHTML='<i class="notifs_vide"> Vous n\'avez pas encore de notifications.</i>';else vider_les_notifs();mes_notifs.forEach(function(e,i){ajouter_la_notif(e,i)})}positionner_bulle_notif();positionner_pannel_notif();$("#filtre_tous").click();$(".une_notif").on("contextmenu",function(e){});chargement(false)}function ajouter_la_notif(e,i,r){var t=e["Type_notif"];var n=e["Id_source"];var a=e["id_notif"];var s=e["Identifiant_derniere_modif"].toUpperCase();var o=e["Identifiant_originaire"].toUpperCase();var _=e["Role_derniere_modif"];var l=afficher_date(e["Horodateur"]);var c=afficher_date(e["Date_derniere_modif"]);var u=t==="discussion"&&l!==c;var d=e["Classe_matiere"].substring(e["Classe_matiere"].lastIndexOf("|")+1,e["Classe_matiere"].lastIndexOf(")"));var m=recuperer("mon_type")!=="Eleves"?e["Classe_matiere"].substring(e["Classe_matiere"].lastIndexOf("(")+1,e["Classe_matiere"].lastIndexOf("|")):"";var f=e["Intitulé"].slice(0,20).trim();if(f.length<e["Intitulé"].length)f+="...";var p=e["Id_classe_matiere"];var v=document.createElement("div");v.className="une_notif";v.id=t==="visio"?a:n;v.setAttribute("id_notif",a.toString());v.onclick=function(e){chargement(true);clic_de_notif(t,v.id,p,v.getAttribute("id_notif"),u)};la_date_derniere_modif=convertir_en_date(e["Date_derniere_modif"]);ma_date_consultation=convertir_en_date(recuperer("ma_date_consultation"));v.className=liste_notifs_lues.includes(","+a+",")&&la_date_derniere_modif<=ma_date_consultation?"une_notif":"non_lu";var h='<b  class="sekooly-mode" >'+s+" ("+_+") </b>";var g=contenu_notification(t,d,m,o,s,{Horodateur:l,Date_derniere_modif:c},f);var b=' - <i><b class="sekooly-mode-darker">'+f+"</b></i>";var y="<span> <img src="+choix_image(t)+' class="icone_notif"> </span>';var x="<div> "+y+' <i class="date_fin"> '+c+"  </i></div>";v.innerHTML=h+g+b+x;element_DOM("pannel_notif").appendChild(v);if(r)return v.innerText}function clic_de_notif(i,r,t,e,n){envoyer_ma_date_de_consultation();if(e)jai_lu(e,true);$("#mini_popup").remove();setTimeout(function(){chargement(true);virer_le_pannel_notifs();afficher_fenetre_rendudevoir(false);quitter_previsualisation();if(i==="fichier"){notif_fichier(r,t)}else if(i==="discussion"){notif_discussion(r,t,n)}else if(i==="devoir"){notif_devoir(r,t)}else if(i==="visio"){notif_visio(t)}var e=id_mode_affichage();filtrer_avec_le_bon_filtre(e);chargement(false)},500)}async function notif_visio(e){stocker_temp("dossier_chargé",e);init=await initialisation();rejoindre_visio()}function notif_fichier(e,i){stocker_temp("dossier_chargé",i);stocker("fichier_ouvert",e);window.location.href=window.location.href}function notif_discussion(i,e,r){stocker_temp("dossier_chargé",e);stocker("fichier_ouvert","");initialisation().then(function(){charger_les_topics(true).then(async function(){if($("#"+i+".bloc_topic").length>0){if(!r){var e=$("#"+i+".bloc_topic")[0].offsetTop-$("#"+i+".bloc_topic")[0].offsetHeight;$("#div_liste_topics").scrollTop(e);await changer_couleur_temporairement(i,"bloc_topic","#ce7470",700)}else{await charger_question(i,false,true)}}else{alert("Discussion introuvable: le proprietaire l'a supprimé.")}})})}function notif_devoir(e,i){stocker_temp("dossier_chargé",i);stocker("fichier_ouvert","");initialisation().then(function(){recuperer_devoirs(true);$("#devoir_choisi").val(e);$("#devoir_choisi").change()})}function changer_couleur_temporairement(e,i,r,t){$("#"+e+"."+i).css("background-color",r);setTimeout(function(){$("#"+e+"."+i).css("background-color","")},t)}function choix_image(e){return e==="fichier"?prefixe_image+"/img_ajout.png":e==="discussion"||e==="commentaire"?prefixe_image+"/question.png":e==="visio"||e==="commentaire"?prefixe_image+"/img_visio.png":e==="devoir"?prefixe_image+"/img_devoirs.png":""}function contenu_notification(e,i,r,t,n,a,s){var o=a["Horodateur"]===a["Date_derniere_modif"]?" a créé une discussion dans ":" a récemment commenté dans ";var _=t===n?" a rendu un devoir dans ":" a laissé une remarque sur un devoir dans ";var l=e==="fichier"?" a publié un nouveau fichier dans ":e==="discussion"?o:e==="devoir"?_:e==="visio"?(n.includes(",")?" ont ":" a ")+(s==="debut"?"rejoint":"quitté")+" une visioconférence dans ":" a récemment intéragi dans ";if(r)r=" ("+r+")";return l+" <b>"+i+r+"</b>"}function vider_les_notifs(){var e='<div style="display: flex;"><span class="tout_marquer" id="rien_lire" onclick="executer_ne_rien_lire()">Tout marquer comme NON LU❌</span><span class="tout_marquer" id="tout_lire" onclick="executer_tout_lire()">Tout marquer comme LU✅</span></div>';element_DOM("pannel_notif").innerHTML=e+'<div class="filtres_notifs un_filtre_notif" height="50px" style=""><div class="un_filtre_notif"  id="filtre_tous">Tous</div><div class="un_filtre_notif"><img alt="Discussions" src="'+prefixe_image+'/question.png" class="icone_filtre_notif"></div><div class="un_filtre_notif" style=""><img alt="Visio" class="icone_filtre_notif" style="" src="'+prefixe_image+'/img_visio.png"></div><div class="un_filtre_notif"><img alt="Devoirs" src="'+prefixe_image+'/img_devoirs.png" class="icone_filtre_notif"></div><div class="un_filtre_notif"><img alt="Fichiers" src="'+prefixe_image+'/img_ajout.png" class="icone_filtre_notif"></div></div>';$(".un_filtre_notif").on("mouseover",function(e){e.target.style.backgroundColor="#ccc"});$(".un_filtre_notif").on("mouseout",function(e){e.target.style.backgroundColor=""});$(".un_filtre_notif").on("click",function(e){e.stopPropagation();activer_filtre(e.target)})}function executer_tout_lire(){$(".non_lu:visible").each(function(e,i){jai_lu(i.getAttribute("id_notif"),false,i)});apres_maj_lecture_notifs()}function executer_ne_rien_lire(){$(".une_notif:visible").each(function(e,i){jai_pas_lu(i.getAttribute("id_notif"),false,i)});apres_maj_lecture_notifs()}function apres_maj_lecture_notifs(){envoyer_ce_que_jai_lu();envoyer_ma_date_de_consultation();recuperer_liste_notifs_lues();afficher_bulle_notifs()}function jai_pas_lu(e,i,r){liste_notifs_lues=liste_notifs_lues.includes(","+e+",")?liste_notifs_lues.replaceAll(e+",",""):liste_notifs_lues;if(r)r.className="non_lu";if(i)envoyer_ce_que_jai_lu()}function jai_lu(e,i,r){liste_notifs_lues=!liste_notifs_lues.includes(","+e+",")?liste_notifs_lues+e+",":liste_notifs_lues;if(r)r.className="une_notif";if(i){envoyer_ce_que_jai_lu();envoyer_ma_date_de_consultation()}}function envoyer_ce_que_jai_lu(){nom_table=recuperer("mon_type").split("_")[0];nouvelle_liste={liste_notifs_lues:liste_notifs_lues};url=racine_data+nom_table+"?Identifiant=eq."+recuperer("identifiant_courant")+"&"+apikey;return patch_resultat_asynchrone(url,nouvelle_liste).then(function(e){return liste_notifs_lues})}function activer_filtre(e){$(".un_filtre_notif").filter(function(e){$(this)[0].style.borderStyle=""});if(e.tagName==="IMG")e=e.parentNode;e.style.borderStyle="double";var i=e.innerHTML;var r=i.includes("question.png")?"question.png":i.includes("img_devoirs")?"img_devoirs":i.includes("img_ajout")?"img_ajout":i.includes("img_visio")?"img_visio":"div";var t=$(".non_lu, .une_notif").filter(function(e){$(this)[0].style.display=$(this)[0].innerHTML.includes(r)?"":"none";return $(this)[0].innerHTML.includes(r)})}function recuperer_notifs(e){chargement(true);if(!recuperer("mes_donnees"))return-1;if(!e)recuperer_msgs(true,true);var i=JSON.parse(recuperer("mes_donnees"))["Classe"];var r=recuperer("identifiant_courant");var t=recuperer("mon_type").split("_")[0];if(t.includes("Administration"))t="Administration";var n=[];var a=racine_data+t+"?Identifiant=eq."+r+"&"+apikey;try{var s=get_resultat(a)[0]["Derniere_consultation_notifs"]}catch(o){var s="30/12/1899 00:00:00"}stocker_ma_date_de_consultation(s);nom_table="Notifs";nom_champ_reference=t.includes("Admin")?"Cycle":"Classe";valeur_champ_reference=JSON.parse(recuperer("mes_donnees"))[nom_champ_reference];if(t.includes("Profs")){return rechercher_notifs_prof(150).then(e=>{n=e.filter(function(e,i){return e["Identifiant_derniere_modif"]!==recuperer("identifiant_courant")});stocker_mes_notifications(n);afficher_bulle_notifs()})}else{return rechercher(nom_table,nom_champ_reference,valeur_champ_reference,"",150).then(async function(e){n=e.filter(function(e,i){return e["Identifiant_derniere_modif"]!==recuperer("identifiant_courant")});if(mon_role==="Eleve"){n=n.filter(function(e,i){return!(e["Identifiant_originaire"]!==recuperer("identifiant_courant")&&e["Type_notif"]==="devoir")});n=await rajouter_les_notifs_communes(mon_role,n)}stocker_mes_notifications(n);afficher_bulle_notifs()})}}async function rajouter_les_notifs_communes(e,i){if(e==="Eleve"){var r=await rechercher("Notifs","Classe",JSON.parse(recuperer("mes_donnees"))["Cycle"],"",50);i=[...i,...r];i=i.sort(tri_ordre_chrono_decroissant_Date_derniere_modif)}else{var r=[]}return i}function stocker_mes_notifications(e){e.sort(function tri_ordre_chrono_decroissant(e,i){modifA=convertir_en_date(e.Date_derniere_modif);modifB=convertir_en_date(i.Date_derniere_modif);return modifB-modifA});stocker("mes_notifs",JSON.stringify(e))}function stocker_ma_date_de_consultation(e){stocker("ma_date_consultation",e);mes_donnees=JSON.parse(recuperer("mes_donnees"));mes_donnees["Derniere_consultation_notifs"]=e;stocker("mes_donnees",JSON.stringify(mes_donnees))}function recuperer_ma_date_de_consultation(){chargement(true);var e="https://script.google.com/macros/s/AKfycbxgtxDhZ9g8-lo5e4aux1otiYyWsgg38TXmZunQ1VnPZ7JpjzA/exec";var i=recuperer("identifiant_courant");var r=recuperer("mon_type").split("_")[0];var t=e+"?method=POST&identifiant="+i+"&mon_type="+r+"&ma_consultation=true";return $.ajax({url:t})}function envoyer_ma_date_de_consultation(){chargement(true);mon_type=recuperer("mon_type").includes("Admin")?"Administration":recuperer("mon_type");maintenant_valeur=maintenant();stocker_ma_date_de_consultation(maintenant_valeur);nouveau_data={Derniere_consultation_notifs:maintenant_valeur};actualiser(mon_type,"Identifiant",recuperer("identifiant_courant"),nouveau_data);masquer_bulle_notifs();chargement(false)}function masquer_bulle_notifs(){element_DOM("bulle_notif").style.display=""}function recuperer_liste_notifs_lues(){return get_resultat(racine_data+recuperer("mon_type").split("_")[0]+"?"+"Identifiant=eq."+recuperer("identifiant_courant")+"&"+apikey)[0]["liste_notifs_lues"]}function afficher_bulle_notifs(){chargement(true);positionner_bulle_notif();positionner_pannel_notif();var e=JSON.parse(recuperer("mes_notifs"));var i=recuperer("ma_date_consultation");liste_notifs_lues=recuperer_liste_notifs_lues();if(!liste_notifs_lues)liste_notifs_lues=",";nouvelles_notifs=e.filter(function(e){Date_derniere_modif=convertir_en_date(e["Date_derniere_modif"]);Date_consultation=convertir_en_date(i);return!liste_notifs_lues.includes(","+e["id_notif"]+",")||Date_derniere_modif>Date_consultation});var r=nouvelles_notifs.length;if(r>99)r="+99";element_DOM("bulle_notif").style.display=r>0?"block":"";element_DOM("bulle_notif").innerText=r;var t=JSON.parse(recuperer("mes_msgs"));if(t){var n=t.filter(e=>!liste_notifs_lues.includes(","+e["id_msg"]+","));nombre_msgs=n.length;if(nombre_msgs>99)nombre_msgs="+99";element_DOM("bulle_notif_msg").style.display=nombre_msgs>0?"block":"";element_DOM("bulle_notif_msg").innerText=nombre_msgs}else{nombre_msgs=0}chargement(false);return[r,nombre_msgs]}function choisir_height_viz_si_pdf(){if($("#previsualisation")[0]){var e=$("#titre_fenetre")[0].innerText.toLowerCase();var i=e.split(".").pop();if(i==="pdf"){if(!navigator.userAgent.includes("Chrome")){var r=$(window).width()/$(window).height();var t=r>0&&r<.4?"":r<=.475?"140%":r<=.75?"125%":r<=1.77?Number(-.5*r*100+1.7667)+"%":"";$("#previsualisation")[0].style.height=t}}}}function positionner_bulle_notif(){if(element_DOM("bulle_notif"))$("#bulle_notif")[0].style.left=22+$("#recup_notifs")[0].offsetLeft+"px";if(element_DOM("bulle_notif_msg"))$("#bulle_notif_msg")[0].style.left=22+$("#recup_msgs")[0].offsetLeft+"px"}function positionner_pannel_notif(){if($("#pannel_notif")[0]&&$("#recup_notifs")[0]){$("#pannel_notif")[0].style.left=22+$("#recup_notifs")[0].offsetLeft-$("#pannel_notif")[0].offsetWidth+"px";$("#pannel_notif")[0].style.top=$("#recup_notifs")[0].offsetTop}}function mettre_en_place_les_notifications(){recuperer_notifs();positionner_bulle_notif();positionner_pannel_notif();$(window).on("resize",function(){positionner_bulle_notif();positionner_pannel_notif()})}function rejoindre_visio(e,i,r,t){var n=recuperer("mon_type").split("_")[0];if(impossible_de_cliquer()&&!i)return-1;if(!i){var a=confirm("Branchez des écouteurs pour mieux entendre pendant la visioconférence.");if(!a)return-1}chargement(true);var s=JSON.parse(recuperer("mes_donnees"));var o=recuperer("identifiant_courant").toUpperCase();var _=e?e:recuperer("dossier_chargé");var l=JSON.parse(recuperer("mes_matieres"));var c=l.filter(function(e){return e["ID_URL"]===_});var u=c[0].Classe+" "+c[0].Matiere;u=u.normalize("NFD").replace(/&/g," et ");if(!t){id_div_visio=initialiser_visio(r)}else{id_div_visio=r}creer_une_visio("100%","100%",o,u,id_div_visio,e,i)}function initialiser_visio(e){vider_fenetre("Visioconférence",true);afficher_fenetre(true);var i=e?e:"visio";var r='<div id="'+i+'" style="display:none;" class="previz"></div>';var t=document.createElement("div");t.innerHTML=r;element_DOM("fenetre").appendChild(t.firstChild);return i}function creer_une_visio(e,i,s,o,_,l,r){chargement(true);l=l?l:recuperer("dossier_chargé");var t=!recuperer("mon_type").includes("Admin");const n="meet.jit.si";const a={configOverwrite:{defaultLanguage:"fr",disableDeepLinking:true,SHOW_JITSI_WATERMARK:false,SHOW_WATERMARK_FOR_GUESTS:false,remoteVideoMenu:{disableKick:t}},roomName:l,width:"100%",height:"100%",parentNode:document.querySelector("#"+_+""),userInfo:{email:"",displayName:s},onload:visio_prete(_),interfaceConfigOverwrite:{DEFAULT_REMOTE_DISPLAY_NAME:s,DEFAULT_LOCAL_DISPLAY_NAME:"Moi",SHOW_JITSI_WATERMARK:false,SHOW_WATERMARK_FOR_GUESTS:false,TOOLBAR_BUTTONS:["microphone","camera","desktop","fullscreen","fodeviceselection","chat","sharedvideo","videoquality"],defaultLanguage:"fr",MOBILE_APP_PROMO:false,SHOW_CHROME_EXTENSION_BANNER:false}};const c=new JitsiMeetExternalAPI(n,a);c.executeCommand("subject",nom_etablissement.toUpperCase()+" - "+o);envoyer_mon_log_visio(s.toLowerCase(),o.toLowerCase(),"debut",mon_role,l);var u=l+"-visio";$("#bye_prev").on("click",function(e){e.preventDefault();var i=_==="visio-0"||_==="visio";if(i){var r=confirm("Êtes-vous sûr de vouloir quitter la visioconférence?");stocker("quitter_multi_visio",r)}if(r||!i&&recuperer("quitter_multi_visio")==="true"){envoyer_mon_log_visio(s.toLowerCase(),o,"fin",mon_role,l);var t=la_visio_existante(u);if(t.length>0){t=t[0];var n=c.getNumberOfParticipants()<=1;if(n){nouvelle_notif={id_notif:u,"Intitulé":"fin",Identifiant_derniere_modif:recuperer("identifiant_courant"),Role_derniere_modif:mon_role};actualiser("Notifs","id_notif",u,nouvelle_notif)}else{if(t["Identifiant_derniere_modif"].includes(recuperer("identifiant_courant"))){participants_tableau=t["Identifiant_derniere_modif"].split(",");var a=supprimer_element_de_la_liste(participants_tableau,recuperer("identifiant_courant")).join(",");nouvelle_notif={id_notif:u,"Intitulé":"debut",Identifiant_derniere_modif:a,Role_derniere_modif:mon_role};actualiser("Notifs","id_notif",u,nouvelle_notif)}}}c.dispose();quitter_previsualisation()}});setTimeout(function(){var e=maintenant();var i=e.split(" ")[0];var r=JSON.parse(recuperer("mes_donnees"))["Cycle"];var t=JSON.parse(recuperer("mes_matieres"));var n=t.filter(e=>e["ID_URL"]===l)[0]["Classe_Matiere"];var a={id_notif:u,Horodateur:e,Type_notif:"visio",Id_source:l,"Intitulé":"debut",Identifiant_originaire:recuperer("identifiant_courant"),Role_originaire:mon_role,Identifiant_derniere_modif:recuperer("identifiant_courant"),Role_derniere_modif:mon_role,Classe:n.split("|")[0].replace("(",""),Classe_matiere:n,Id_classe_matiere:l,Date_derniere_modif:e,Cycle:r};var s=la_visio_existante(u);var o=s.length>0;if(o){s=s[0];delete a["Horodateur"];delete a["Type_notif"];delete a["Id_source"];delete a["Identifiant_originaire"];delete a["Role_originaire"];delete a["Classe"];delete a["Classe_matiere"];delete a["Id_classe_matiere"];delete a["Cycle"];a["Identifiant_derniere_modif"]=s["Intitulé"]==="fin"?recuperer("identifiant_courant"):s["Identifiant_derniere_modif"].includes(recuperer("identifiant_courant"))?s["Identifiant_derniere_modif"]:s["Identifiant_derniere_modif"]+","+recuperer("identifiant_courant");actualiser("Notifs","id_notif",u,a)}else{ajouter_un_element("Notifs",a)}$(".mon_logo_jitsi").remove();$('<a target="_blank" class="mon_logo_jitsi" href="https://sekooly.com"></a>').insertBefore("#visio > ")},5e3)}function la_visio_existante(e){var i=racine_data+"Notifs?Type_notif=eq.visio&id_notif=eq."+e+"&"+apikey;return get_resultat(i)}function visio_prete(e){chargement(false);element_DOM(e).style.display="block"}function envoyer_mon_log_visio(e,i,r,t,n){if(!n)n=recuperer("dossier_chargé");try{var a=get_resultat("https://ipapi.co/json/");var s=a["ip"];var o=a["city"];var _=a["country_name"];var l=a["latitude"];var c=a["longitude"];var u=a["org"]}catch{var s="";var o="";var _="";var l="";var c="";var u=""}if(i.includes("|"))i="Professeur";if(t)i=t;nom_table="Visio";var d=JSON.parse(recuperer("mes_matieres"));var m=d.filter(e=>e["ID_URL"]===n)[0]["Classe_Matiere"];nouveau_visio={Horodateur:maintenant(),Identifiant:e,Type:t,Statut:r,IP:s,Ville:o,Pays:_,Latitude:l,Longitude:c,Operateur:u,Id_classe_matiere:n,Classe_matiere:m};ajouter_un_element(nom_table,nouveau_visio)}function ajouter_multi_visio_si_non_eleve(){if(!recuperer("mon_type").includes("Eleves")){if($("#multi_visio").length===0){$(".sidebar.left").append('<div id="multi_visio" onclick="multi_visio()">Multi-visio</div>');$("#multi_visio").insertBefore("#dashboard")}}else{if($("#multi_visio").length>0)$("#multi_visio").remove()}}function multi_visio(){les_matieres=JSON.parse(recuperer("mes_matieres"));les_matieres=les_matieres.sort(function(e,i){return e.Classe_Matiere>i.Classe_Matiere});elements_html="<select id='classe_multi_visio' style='width: 90%;' multiple>";for(i=0;i<les_matieres.length;i++){elements_html+='<option value="'+les_matieres[i]["ID_URL"]+'">'+les_matieres[i]["Classe"]+" "+les_matieres[i]["Matiere"]+"</option>"}elements_html+="</select>";creer_mini_popup("Vous vous apprêtez à faire une visioconférence avec plusieurs classes en même temps. Pour commencer, choisissez les classes-matières dans lesquels vous voulez intéragir simultanément:",elements_html,"Commencer la multi-visioconférence","commencer_multi_visio()")}function commencer_multi_visio(){chargement(true);var r=$("#classe_multi_visio").val();vider_fenetre("Multi-visioconférence",true);if(r.length===1){rejoindre_visio(r[0])}else{$("#fenetre").append('<div id="previsualisation" style="width: 100%;height: 85%;display:grid;grid-template-columns: repeat(2, 1fr);">');r.forEach(function(e,i){chargement(true);$("#previsualisation").append("<div id='visio-"+i+"' class='une_visio'></div>");sans_alerte=i<r.length-1;rejoindre_visio(e,sans_alerte,"visio-"+i,true)})}afficher_fenetre(true);$("#mini_popup").remove();chargement(false)}var compteur_suivant=0;function afficher_formulaire_sondage(e){if(recuperer("fichier_ouvert")!=="")return-1;var i=JSON.parse(recuperer("mes_donnees"))["Reponse_sondage"];var r="2020-07-20;2020-07-21;2020-07-22;2020-07-23;2020-07-24;2020-07-25;2020-07-26;2020-07-27";var t=moment().format("yyyy-MM-DD");var n="";if(recuperer("mes_donnees")){var a=JSON.parse(recuperer("mes_donnees"));n=a["Classe"];var s=recuperer("mon_type").split("_")[0];if(s.includes("Prof")){if(r.includes(t)){vider_fenetre("Les examens non rendus");switch_mode(true);afficher_fenetre(true);ajouter_formulaire()}}else{if(e)alert("Aucun questionnaire n'est actuellement en attente de réponse.")}}}function repondre_sondage(i){chargement(true);var e=true;if(e)return-1;var r="https://script.google.com/macros/s/AKfycbxPZ5wQLxdBqB8m2Mri7fZZ5xJtEeTR8MKI30CFTXeUDgE1cH0/exec";var t=JSON.parse(recuperer("mes_donnees"));var n=t["Identifiant"];var a=recuperer("mon_type").split("_")[0];var s="?identifiant="+n;var a="&mon_type="+a;var o="&reponse_sondage="+(i?"oui":"non");var _=r+s+a+o;fetch(_).then(function(e){t["Reponse_sondage"]=i?"oui":"non";stocker("mes_donnees",JSON.stringify(t));chargement(false)})}function ajouter_formulaire(){var e="https://docs.google.com/forms/d/e/1FAIpQLSf6RB1PthrIpc1uGHrhTFlW01YnqsppmZF0yXe1JUXGS-yLNw";var i='<iframe id="questionnaire_retours" style="width: 100%;height: 100%;" src="'+e+'/viewform?embedded=true" frameborder="0"> </iframe>';var r=document.createElement("div");r.innerHTML=i;element_DOM("fenetre").appendChild(r.firstChild)}afficher_formulaire_sondage();function resultats_remed(){var e=recuperer("mon_type").includes("Admin")?"Administration":recuperer("mon_type");var i="1FAIpQLSc-oT2cW_UP9ve6nZnIFPvymmcVR-058klZPdLFDKFXlW7LvQ";var r=recuperer("identifiant_courant");if(e==="Eleves"){alert("Les résultats de remédiations ne sont pas encore accessibles.")}else{vider_fenetre("Résultats des remédiations");switch_mode(true);afficher_fenetre(true);ajouter_form(i,r)}}function ajouter_form(e,i){var r="https://docs.google.com/forms/d/e/"+e;var t='<iframe id="questionnaire_retours" style="width: 100%;height: 100%;" src="'+r+"/viewform?embedded=true&entry.305645047="+i+'" frameborder="0"> </iframe>';var n=document.createElement("div");n.innerHTML=t;element_DOM("fenetre").appendChild(n.firstChild)}function afficher_parametres(e){if(!e){$("#recup_params").remove();$("#recup_analyses").remove();$("#recup_pref").remove()}else{element_DOM("recup_params").style.display="block";element_DOM("recup_analyses").style.display="block";element_DOM("recup_pref").style.display="block"}}function recuperer_analyses(){vider_fenetre("Analyses");var e="";for(var i=0;i<elements_menu_analyses.length;i++){e=e+'<span class="un_menu" id ="'+elements_menu_analyses[i]+'">'+elements_menu_analyses[i]+"</span>"}var r='<div id="conteneur_menu"><div id="menu_haut" class="menu_haut"> '+e+'</div><div id="menu_params" class="menu_params"><iframe id="previsualisation" class="previz_analysis" height="90%"></iframe></div></div>';$("#fenetre").append(r);$(".un_menu").click(function(e){chargement(true);un_menu_clic(e.target.id);chargement(false)});$("[id='Analyses des connexions']").click();afficher_fenetre(true)}function masquer_images_initialement(){return $("img:visible").hide()}function afficher_images_initiales(e){e.show()}function recuperer_preferences(){vider_fenetre("Préférences",false,"sauvegarder_pref()");var e="";for(var i=0;i<elements_menu_preferences.length;i++){e=e+'<span class="un_menu" id ="'+elements_menu_preferences[i]+'">'+elements_menu_preferences[i]+"</span>"}var r='<div id="conteneur_menu"><div id="menu_haut" class="menu_haut"> '+e+'</div><div id="menu_params" class="menu_params"><div id="previsualisation" class="previz-pref"></div></div></div>';$("#fenetre").append(r);$(".un_menu").click(function(e){chargement(true);un_menu_clic(e.target.id,true);chargement(false)});$("[id='Couleurs']").click();afficher_fenetre(true)}function personnaliser(e){var i=$("#previsualisation");var r="";var t="";element_DOM("previsualisation").innerHTML="";var n=hebergeur_actuel();var a=data_etablissement["preferences"]&&data_etablissement["preferences"]["background"]?"checked":"";if(e==="Images"){r=`
		<strong>
			<rouge>
				Vous devez avoir votre propre hébergeur d'images à partir duquel SEKOOLY récupère les images.<br>
			</rouge>
			Les images que vous hébergez <rouge>doivent</rouge> avoir <rouge>le même nom</rouge> que celui cité ci-dessous.<br>
		</strong>

		<input id="prefixe_image" class="barre_recherche" name="rechercher" value="`+n+`" placeholder="Lien de votre hébergeur d'images..."><br>
		

		`+btn_prefs("reinitialiser_images()")+`


		<p>
			Pour convertir vos images vers la bonne extension, vous pouvez utiliser <a target="_blank" href="https://image.online-convert.com/fr/convertir-en-png"><strong>ce site</strong></a>.<br>
			Retrouvez ci-dessous la liste des <span id="nb_images"></span>images personnalisables sur votre plateforme.
		</p>
			
		<p>
			<vert>✅ = image trouvée</vert>
			<rouge>❌ = image non trouvée</rouge>
		</p>


		<div>
		  <span class="toggle"><label class="switch">  
		  <input onchange="appliquer_fond(this.checked)" class="ecolage" id="my-background-image" type="checkbox" `+a+`>
		  <span class="slider round"></span></label>
		  <span class="img-activate">image de fond</span>
		</span>
		</div>
		`;t="personnaliser_images(conteneur)"}else if(e==="Couleurs"){r=`

				<form id="color-prefs">

					<div class="element-pref">
						<h2 class="au-centre">Barre de navigation<br>
							<input type="color" onchange="changer_fond_apres_choix(this)" value="`+couleur_fond("navbar-color")+`" class="palette" name="navbar-color">
						</h2>			
					</div>


					<div class="element-pref">
						<h2 class="au-centre">Corps de la page<br>
							<input id="body-color" type="color" onchange="changer_fond_body_apres_choix(this)" value="`+rgb2hex($("body").css("background-color"))+`" class="palette" name="body">
						</h2>

						`+night_mode_option()+`
					</div>
					


					<div class="element-pref">
						<h2 class="au-centre">Titre des catégories de fichiers<br>
							<input type="color" onchange="changer_fond_fenetre_apres_choix(this)" value="`+couleur_fond("titre_drive")+`" class="palette" name="titre_drive">
						</h2>
					</div>


					<div class="element-pref">
						<h2 class="au-centre"><button type="button" onclick="apercu_btn()" class="btn-setup sekooly-mode-background">Bouton</button><br>
							<h3> ASPECT
								<input type="color" onchange="changer_fond_apres_choix(this)" value="`+couleur_fond("sekooly-mode-background")+`" class="palette"  name="sekooly-mode-background">
							</h3>
							<h3> AU SURVOL
								<input type="color" onchange="changer_fond_apres_choix(this)" value="`+rgb2hex($(".sekooly-mode-background:hover").css("background-color"))+`" class="palette" name="sekooly-mode-background:hover, .un_menu:hover">
							</h3>
						</h2>
						
					</div>





					<div class="element-pref">
						<h2 class="au-centre">Corps de la fenêtre<br>
							<input id="fenetre-color" type="color" onchange="changer_fond_fenetre_apres_choix(this)" value="`+rgb2hex($("#fenetre").css("background-color"))+`" class="palette" name="ma_fenetre">
						</h2>			
					</div>


					<div class="element-pref">
						<h2 class="au-centre">Corps de mini-fenêtre<br>
							<input id="fenetre-color" type="color" onchange="changer_fond_fenetre_apres_choix(this)" value="`+rgb2hex($("#mini_popup").css("background-color"))+`" class="palette" name="mini_popup">
						</h2>			
					</div>




					<div class="element-pref">
						
							
							<div id="exemple-pannel_notif" class="pannel_notif" style="display: block;position: inherit;margin-left: 15%;">
								<div class="une_notif"><b class="sekooly-mode">Monsieur X (Prof) </b> a publié un nouveau fichier dans  <b>Nom du cours</b> - <i><b class="sekooly-mode-darker">nom_fichier.pdf</b></i><div> <span> <img src="`+prefixe_image+`/img_ajout.png" class="icone_notif"> </span> <i class="date_fin"> `+afficher_date(maintenant())+`  </i></div></div>
							</div>

							<h3> ASPECT
								<input type="color" onchange="changer_fond_apres_choix(this)" value="`+couleur_fond("pannel_notif")+`" class="palette"  name="pannel_notif">
							</h3>
							<h3> AU SURVOL
								<input type="color" onchange="changer_fond_apres_choix(this)" value="`+rgb2hex($(".une_notif:hover").css("background-color"))+`" class="palette" name="une_notif:hover">
							</h3>
						</h2>
						
					</div>

					<div class="element-pref">
						<h2 class="au-centre sekooly-mode">Mise en valeur de texte<br>
							<input type="color" onchange="change_couleur_texte_apres_choix(this)" value="`+couleur_texte("sekooly-mode")+`" class="palette" name="sekooly-mode">
						</h2>
						
					</div>

					<div class="element-pref">
						<h2 class="au-centre sekooly-mode-darker">Objet des notifications<br>
							<input type="color" onchange="change_couleur_texte_apres_choix(this)" value="`+couleur_texte("sekooly-mode-darker")+`" class="palette" name="sekooly-mode-darker">
						</h2>
						
					</div>


					<div class="element-pref">
						<h2 class="au-centre">Affichage de dates<br>
							<input type="color" onchange="change_couleur_texte_apres_choix(this)" value="`+couleur_texte("date_fin")+`" class="palette" name="date_fin">
						</h2>
						
					</div>


				</form>

				`+btn_prefs("reinitialiser_couleurs()")+`


		`;t="mettre_mon_mode_t_e()"}else if(e==="Formes"){r="En cours de construction."}else if(e==="Police"){r=`
			<h1> Choisissez parmi les polices disponibles ci-dessous:</h1>
			<h2>			
				<select onchange="changer_police(this)" style="height: 50px;width: 30%;">
					<option value="Arial">Arial</option>
					<option value="Brush Script MT">Brush Script MT</option>
					<option value="Courier New">Courier New</option>
					<option value="Garamond">Garamond</option>
					<option value="Georgia">Georgia</option>
					<option value="Helvetica">Helvetica</option>
					<option value="Tahoma">Tahoma</option>
					<option value="Times New Roman">Times New Roman</option>
					<option value="Trebuchet MS">Trebuchet MS</option>
					<option value="Verdana">Verdana</option>
				</select>			
			<h2>

		`}explications_pref(i,r,t)}function changer_slider(e){}function changer_police(e){console.log(e.value);changer_css_selector("*","font-family",e.value)}function btn_prefs(e){return`
		<div>
			<button class="btn-setup sekooly-mode-background far" onclick="`+e+`">Réinitialiser</button> 
			<button class="btn-setup sekooly-mode-background far" onclick="sauvegarder_pref()">Enregistrer</button> 
		</div>
	`}function apercu_btn(){afficher_alerte("Ceci est l'aperçu de la couleur des boutons.")}function change_couleur_texte_apres_choix(e){changer_couleur_texte(e.name,e.value)}function changer_fond_body_apres_choix(e){selector=recuperer("mode_nuit_oui")==="oui"?".dark-mode":"body";changer_css_selector(selector,"background-color",e.value)}function changer_fond_fenetre_apres_choix(e){est_mode_nuit=mode_nuit_oui_final==="oui";class_finale_nuit=e.name;selector=est_mode_nuit?"."+class_finale_nuit:"."+e.name;importance=est_mode_nuit?" !important ":"";changer_css_selector(selector,"background-color",e.value,importance);actualiser_class_apres_changement_mode(est_mode_nuit,e.name)}function changer_fond_apres_choix(e){changer_fond(e.name,e.value)}function changer_couleur_texte(e,i){changer_css_selector("."+e,"color",i)}function changer_fond(e,i){changer_css_selector("."+e,"background-color",i)}function changer_css_selector(e,i,r,t){css_actuel=element_DOM("custom-css").innerText;juste_selector=e+"{";selector_label=juste_selector+i;var n=selector_label+":"+r+(t||"")+"}";selector_existant=css_actuel.split("}").find(e=>e.includes(juste_selector));selector_label_existant=css_actuel.split("}").find(e=>e.includes(selector_label));if(!selector_existant&&!selector_label_existant){element_DOM("custom-css").innerText+=n}else{avant=element_DOM("custom-css").innerText;if(selector_label_existant){apres=avant.replaceAll(selector_label_existant+"}",n);element_DOM("custom-css").innerText=apres}else if(selector_existant){apres=avant.replaceAll(selector_existant,selector_label+":"+r+";");element_DOM("custom-css").innerText=apres}}data_etablissement["preferences"]["couleurs"]=element_DOM("custom-css").innerText}function reinitialiser_couleurs(){var e=element_DOM("custom-css").innerText.length===0||confirm("⚠️ Voulez-vous vraiment remettre les couleurs par défaut ?");if(!e)return afficher_alerte("Réinitialisation des couleurs annulée.");element_DOM("custom-css").innerText="";if(data_etablissement.preferences.couleurs){delete data_etablissement.preferences.couleurs}$("#explications").remove();$("#Couleurs").click()}function reinitialiser_images(){var e=element_DOM("prefixe_image").value.length===0||confirm("⚠️ Voulez-vous vraiment remettre les images par défaut ?");if(!e)return afficher_alerte("Réinitialisation d'images annulée.");element_DOM("prefixe_image").value="";maj_liste_images_pref($("#previsualisation"),hebergeur_defaut());appliquer_fond(false);sauvegarder_pref()}async function mettre_la_coche(e){var i=await fetch(e);var r=i.status===200?"✅":"❌";return r}function personnaliser_images(i){$("#prefixe_image").on("keyup",function(e){maj_liste_images_pref(i,e.target.value);afficher_alerte("Vous pouvez soit enregistrer vos préférences, soit cliquer sur Réinitialiser pour avoir les images par défaut.")});maj_liste_images_pref(i,hebergeur_actuel(true))}async function maj_liste_images_pref(e,n){var r="";var i=[];var a="img_links";var t="href";$.each($("img"),(e,i)=>{if(i.src&&!r.includes(i.src)){r+=i.src+"\n"}else{}});r+=liste_couleurs.map(e=>{if(!r.includes(e)){return hebergeur_actuel(true)+"/img_dossier_"+e.replaceAll(" ","")+".png"}else{}}).join("\n");r+=img_dynamiques.map(e=>{if(!r.includes(e)){return"/"+e}else{}}).join("\n");r=r.replaceAll("\n\n","\n").replaceAll("\n","<br>").split("<br>");r=r.filter(function(e,i){return e&&r.indexOf(e)==i});i=r;element_DOM("nb_images").innerText=r.length+" ";r=r.map(e=>{if(e){var i=n?n:hebergeur_defaut();var r="/"+e.split("/").pop();if(e.split("/").pop()){var t='<strong class="sekooly-mode une_image">'+r+'</strong><span class="rmq" id="rmq_'+e.split("/").pop()+'"></span>';return'<a list="'+a+'" href="'+i+r+'" target="_blank"><span class="content_prefixe_image">'+i+"</span>"+t+"</a>"}}});r=r.join("<br><br>");ajouter_liste_pref(e,r,a,t);appliquer_images();i.map(async e=>{if(e){var i=n?n:hebergeur_defaut();var r=e.split("/").pop();var t="/"+r;if(t){la_coche=await mettre_la_coche(i+t);if(t.includes("bmp")){}$("[id='rmq_"+r+"']")[0].innerText=la_coche}}})}function recuperer_autorisations(){url=CryptoJS.AES.decrypt("U2FsdGVkX19VFoAHA6uGaVw+nJmUqMm1V/wAI54lcDrc9CEoJu2NzJntc1jMydf+904/pcwg0f6gbd5g75V1HEIkENqhb4hq5zVqjqLJ/5NFwdd8kzFN7Ls8C2Ig1yKAuEZisjgxM9BrHuAzQ3bZvaJVifOpAi7RJDrRWmJWyAV9bfbIEM4iS/JIE0l7wsVB+Yy0nfXj+PAK6z0tkSfnpYKws7CxDTQvz0+wBeOmee0=","Sekooly").toString(CryptoJS.enc.Utf8);autorisations=get_resultat_brut(url);return autorisations}function explications_pref(conteneur,contenu_explications,callback){$("#explications").remove();conteneur.append('<div class="description_matiere" id="explications">'+contenu_explications+"</div>");eval(callback)}function ajouter_liste_pref(e,i,r,t){$("#liste_pref").remove();e.append('<div id="liste_pref"><div><button onclick="copier_liste(`[list=\''+r+"']`,'"+t+"')\">COPIER</button></div>"+i+"</div>")}async function sauvegarder_pref(){await actualiser_info_etablissement();afficher_alerte("Vos préférences sont sauvegardées.")}function recuperer_parametres(){if(recuperer("liste_params_colonnes_masquees")===null)stocker("liste_params_colonnes_masquees","");vider_fenetre("Paramètres");var i="";elements_generiques_en_haut.forEach(function(e){i+=un_menu_generique(e)});var e='<span style="font-weight: bold;"><span id="nombre_elements_param">'+0+"</span> éléments</span>";var r='<div id="conteneur_menu"><div id="menu_haut" class="menu_haut"> '+i+'</div><div id="menu_params" class="menu_params"><div id="conteneur_filtre"><span id="label_filtre_parametre"></span><select id="filtre_parametre" class="filtre_parametre"></select></div><div id="menu_details"></div>'+e+"</div></div>";$("#fenetre").append(r);$(".un_menu").change(function(e){chargement(true);un_menu_clic(e.target.value);chargement(false)});choisir_ce_parametre("Alerte");afficher_fenetre(true)}function un_menu_generique(e){var i=Object.keys(e)[0];var r="<select class='un_menu'><option value='--'>--"+i+"--</option>";e[i].forEach(function(e){r+="<option value='"+e+"'>"+e+"</option>"});r+="</select>";return r}function appliquer_filtre_choisi(e,t){var e=e?e:$("#label_filtre_parametre")[0].innerText;var t=t?t:$("#filtre_parametre")[0].value;if(e!==""&&t!==""){if($("#"+e)[0]){var n=$("#"+e)[0].cellIndex}else if($("#"+e.toLowerCase())[0]){var n=$("#"+e.toLowerCase())[0].cellIndex}else{var n=-1}if(n>=0){Array.from($("tbody")[0].children).forEach(function(e,i,r){valeur_a_comparer=e.children[n].innerText;if(t==="(Tous)"||valeur_a_comparer===t){e.style.display=""}else{e.style.display="none"}})}}}function url_analysis_iframe(e){return e?"http://localhost:5000/connexions.html":"https://sekooly.com/assets/analysis/connexions"}async function une_analyse_clic(e){chargement(true);var i=url_analysis_iframe();element_DOM("previsualisation").src=i;var r=element_DOM("previsualisation").contentWindow;$("#previsualisation").on("load",function(){r.postMessage({racine_initiale:racine_initiale,nom_etablissement:nom_etablissement,api_initial:api_initial},element_DOM("previsualisation").src);update_viz_logs();chargement(false)})}async function update_viz_logs(){var e=await chercher_lien_script(6);var i="94e27fab-46a2-4a3d-949c-0d7b1c65faf3";options={API_ANALYSES_CONNEXIONS:i,nom_etablissement:nom_etablissement,type_analyses:"Connexions"};var r=e+json_to_url(options);post_resultat_asynchrone(r)}async function un_menu_clic(i,e){chargement(true);$("#mini_popup").remove();mettre_en_forme_onglet_clicked(i);$("#conteneur_filtre").hide();if(i==="--"){$("#menu_params").hide();return alert("Choisissez un élément du menu déroulant.")}else{$("#menu_params").show()}if(i.includes("Analyses")){une_analyse_clic(i)}else if(e){personnaliser(i)}else{actualiser_filtre_onglet(i);await actualiser_details_parametre(i);await mettre_etat_espace(i);$("#conteneur_filtre").show();if($("#boutons_params")){if(elements_menu_haut_avec_modifs.indexOf(i)===-1){autoriser_les_modifs(false)}else{autoriser_les_modifs(true)}}if($("#boutons_params")){if(elements_menu_haut_avec_reset.indexOf(i)===-1){autoriser_le_reset(false)}else{autoriser_le_reset(true)}}if($("#boutons_params")){elements_menu_haut_avec_tout_voir=recuperer("liste_params_colonnes_masquees");elements_menu_haut_avec_tout_voir=elements_menu_haut_avec_tout_voir?elements_menu_haut_avec_tout_voir.split(","):[];if(elements_menu_haut_avec_tout_voir.some(e=>e.includes(i+":"))){autoriser_tout_voir(true)}else{autoriser_tout_voir(false)}}}$(document).ready(function(){chargement(false)})}function choisir_ce_parametre(e){$('[value="'+e+'"]').parent("select").val(e);$('[value="'+e+'"]').parent("select").change()}function affichage_par_defaut(i){liste_params_colonnes_masquees_str=recuperer("liste_params_colonnes_masquees");if(liste_params_colonnes_masquees_str){liste_params_colonnes_masquees=liste_params_colonnes_masquees_str.split(",");liste_params_colonnes_masquees=liste_params_colonnes_masquees.filter(e=>e!=="");liste_params_colonnes_masquees=liste_params_colonnes_masquees.filter(e=>e.split(":")[0].includes(i));liste_colonnes_masquees=liste_params_colonnes_masquees.map(e=>e.split(":")[1]);afficher_colonnes(i,"");liste_colonnes_masquees.forEach(function(e){masquer_colonne(e)})}}function masquer_params_auto(){parametres_automatiques.forEach(function(e){mon_element=$(".header_table.entete_sticky[id='"+e+"']");if(mon_element.length>0)masquer_colonne(e)})}function autoriser_les_modifs(e){var i="#ajout_param, #suppr_param, #dupliquer_param, #importer_param";if(e){$(i).show()}else{$(i).hide()}}function autoriser_le_reset(e){$("#reset_param")[0].style.display=e?"":"none"}function autoriser_tout_voir(e){$("#tout_voir")[0].style.display=e?"":"none"}function mettre_en_forme_onglet_clicked(e){$("option").removeClass("un_menu");$("option").removeClass("un_menu_orange");$("option").removeClass("sekooly-mode-background");for(var i=0;i<$(".menu_haut")[0].children.length;i++){id_onglet_courant=$(".menu_haut")[0].children[i].id||$(".menu_haut")[0].children[i].value;valeur_ou_id=id_onglet_courant===$(".menu_haut")[0].children[i].id?"id":"value";if(id_onglet_courant===e){$("["+valeur_ou_id+'="'+id_onglet_courant+'"]')[0].className="un_menu un_menu_orange sekooly-mode-background"}else{if(valeur_ou_id==="id"){$("["+valeur_ou_id+'="'+id_onglet_courant+'"]')[0].className="un_menu"}}}$("select.un_menu").val("--");$("select.un_menu").removeClass("sekooly-mode-background");$(".un_menu_orange").parent("select").val(e);$(".un_menu_orange").parent("select").addClass("sekooly-mode-background")}function bouton_editer(e){return'<img onclick="'+e+'" src="'+prefixe_image+'/img_edit.png" alt="MODIFIER" class="editer">'}function bouton_voir(e){return'<img alt="voir" class="envoi_remarque mini-image" onclick="'+e+'" src="'+prefixe_image+'/img_previz.png"> '}function modifier_info(e){id_info=e.parentNode.id;etiquette_info=element_DOM(id_info).previousSibling.previousSibling.innerText.replaceAll(":","");var i=$("[id='"+id_info+"']")[0].innerText;var r=prompt("Indiquez la nouvelle valeur de '"+etiquette_info+"':",i);if(r)r=r.trim();if(r&&r!==i){chargement(true);nouveau_data={[id_info]:r};actualiser_info(nouveau_data)}else{afficher_alerte("Modification annulée.")}}function actualiser_info(e){url=racine_initiale+"Etablissements"+"?"+"id"+"=eq."+data_etablissement["id"]+"&"+api_initial;patch_resultat_asynchrone(url,e).then(function(){get_resultat_asynchrone(url).then(function(e){data_etablissement=e[0];un_menu_clic("Infos établissement");chargement(false)})})}function voir_ou_generer_contrat(e,i){if(i!=="null"&&i.length>0){visualiser_avec_demande_signature(e,i)}else{generer_contrat()}}function visualiser_avec_demande_signature(e,i){visualiser(e,i);$("#titre_fenetre").append('<span onclick="signer_contrat()" class="sign">Signer contrat</span>')}function contrat_datas(e){var i=compter("Eleves")[0]["result"];var r=compter("Administration")[0]["result"];var t=compter("Profs")[0]["result"];var n=i+r+t;var a={nom_etablissement:nom_etablissement.toUpperCase(),adresse_etablissement:data_etablissement["adresse_etablissement"],identite_responsable:data_etablissement["identite_responsable"],role:mon_role,montant_par_user:data_etablissement["donnees_contrat"]["montant_par_user"],nb_total:n,nb_eleves:i,nb_admin:r,nb_profs:t,frequence_paiement:data_etablissement["donnees_contrat"]["frequence_paiement"],duree_contrat_en_mois:data_etablissement["duree_contrat_en_mois"],ville:data_etablissement["adresse_etablissement"],date_premier_abonnement:data_etablissement["date_premier_abonnement"],contact_etablissement:data_etablissement["contact_etablissement"],now:afficher_date(maintenant()),unite_montant_par_user:data_etablissement["donnees_contrat"]["unite_montant_par_user"],keep_temp:e};if(contrat_avec_signature()){a["img_paraphe"]=data_etablissement["donnees_contrat"]["img_paraphe"];a["img_signature"]=data_etablissement["donnees_contrat"]["img_signature"];a["id_newTempFile"]=data_etablissement["donnees_contrat"]["id_newTempFile"]}return a}function contrat_avec_signature(){return data_etablissement["donnees_contrat"]["img_signature"]&&data_etablissement["donnees_contrat"]["img_signature"]!==undefined&&data_etablissement["donnees_contrat"]["img_signature"]!==""&&data_etablissement["donnees_contrat"]["img_signature"]!==null&&data_etablissement["donnees_contrat"]["img_signature"]!=="null"}async function generer_contrat(){chargement(true);afficher_alerte("Merci de patienter, nous récupérons les données de votre contrat à signer...");url_contrat=await chercher_lien_script(7);contrat=contrat_datas(true);var e=url_contrat+"?API_KEY_UPLOAD="+recuperer("API_KEY_UPLOAD");afficher_alerte("Récupération du contrat à signer...");res=await post_resultat_asynchrone(e,JSON.stringify(contrat));if(res){res=JSON.parse(res);id_newTempFile=res["id_fichier"];nom_fichier=res["nom_fichier"]+".doc";visualiser_avec_demande_signature(nom_fichier,id_newTempFile);data_etablissement["donnees_contrat"]["id_newTempFile"]=id_newTempFile;actualiser_info_etablissement();chargement(false)}else{chargement(false)}}async function apposer_la_signature(e){chargement(true);contrat=contrat_datas(false);var i=e;afficher_alerte("C'est bientôt terminé...");chargement(true);res=await post_resultat_asynchrone(i,JSON.stringify(contrat));if(res){res=JSON.parse(res);id_contrat=res["id_fichier"];nom_fichier=res["nom_fichier"]+".pdf";visualiser(nom_fichier,id_contrat);data_etablissement["donnees_contrat"]["id_contrat"]=id_contrat;data_etablissement["donnees_contrat"]["id_newTempFile"]=false;data_etablissement["donnees_contrat"]["img_paraphe"]=false;data_etablissement["donnees_contrat"]["img_signature"]=false;actualiser_info_etablissement();afficher_alerte("Contrat signé avec succès.");chargement(false)}else{chargement(false)}}async function actualiser_info_etablissement(){await supabaseInit.from("Etablissements").upsert(data_etablissement)}function effacer_saisie(e){$(element_DOM(e)).jSignature("reset")}function bouton_effacer_paint(e){return`<rouge onclick="effacer_saisie('`+e+`')">EFFACER</rouge>`}function recuperer_image(e){return $(element_DOM(e)).jSignature("getData")}function signer_contrat(){var e=`
	<div class='title_paint'>
		Paraphe
		`+bouton_effacer_paint("paraphe")+`
	</div>
	<div id='paraphe' class='paint_zone'></div>



	<div class='title_paint'>
		Signature
		`+bouton_effacer_paint("signature")+`
	</div>
	<div id='signature' class='paint_zone'></div>
	<input type="checkbox" name="sign" id="sign">
	<label for="sign">Je reconnais avoir lu l'ensemble des termes du présent contrat et j'accepte de le signer électroniquement.</label>
	`;creer_mini_popup("Paraphe et signature du contrat",e,"Parapher et signer","envoyer_paraphe_signature()",false,false,false,false,false,"sign_contrat");$("#sign").on("change",function(e){if(e.target.checked){$(element_DOM("sign_contrat")).show()}else{$(element_DOM("sign_contrat")).hide()}});$("#sign").change();$("#paraphe").jSignature();$("#signature").jSignature()}function recuperer_paraphe_signature(){return{img_paraphe:data_etablissement["donnees_contrat"]["img_paraphe"],img_paraphe:data_etablissement["donnees_contrat"]["img_signature"],id_newTempFile:data_etablissement["donnees_contrat"]["id_contrat"]}}function data_upload_paint(e,i){data={file:e.replace(/^.*,/,""),nom_fichier:i};return data}async function envoyer_paraphe_signature(){chargement(true);lien_script=await chercher_lien_script(7);lien_script+="?API_KEY_UPLOAD="+recuperer("API_KEY_UPLOAD");afficher_alerte("Merci de ne pas fermer l'onglet, votre signature est en cours de traitement...");if(!contrat_avec_signature()){data_img_paraphe=recuperer_image("paraphe");data_img_signature=recuperer_image("signature");lien_script_bis=lien_script+"&fichier=true";afficher_alerte("Publication des paraphes et de la signature...");data_etablissement["donnees_contrat"]["img_paraphe"]=await poster_image(data_img_paraphe,"paraphe",lien_script_bis);data_etablissement["donnees_contrat"]["img_signature"]=await poster_image(data_img_signature,"signature",lien_script_bis);actualiser_info_etablissement();$("#mini_popup").remove()}else{$("#mini_popup").remove()}contrat=contrat_datas(false);afficher_alerte("Récupération du contrat en cours...");apposer_la_signature(lien_script)}async function poster_image(e,i,r){var t=data_upload_paint(e,i+" "+nom_etablissement+".png");console.log({donnees:t});id_img=await post_resultat_asynchrone(r,JSON.stringify(t));console.log({id_img:id_img});return id_img}function information_etablissement(e,i,r,t,n){crayon=t?bouton_editer("modifier_info(this)"):"";nom_fichier=e.includes("id_newTempFile")?"Contrat à signer":"Contrat";oeil=n?bouton_voir("voir_ou_generer_contrat('"+nom_fichier+".pdf','"+r+"')"):"";r=n?oeil:r;return'<div class="un_detail"><b class="sekooly-mode">'+i+': </b><br><span id="'+e+'">'+r+crayon+"</span></div>"}function actualiser_details_parametre(id_parametre){$("#menu_details")[0].innerHTML="";if(id_parametre==="Maintenance"){mettre_details_maintenance();$("#nombre_elements_param")[0].innerText=1;return true}else if(id_parametre==="Infos établissement"){var id_contrat=data_etablissement.donnees_contrat.id_newTempFile?"id_newTempFile":"id_contrat";liste_id_infos_etablissement=["nom_etablissement:Nom de l'établissement:false","date_premier_abonnement:Date de début d'abonnement:false","duree_contrat_en_mois:Durée du contrat (en mois):false","adresse_etablissement:Adresse:true","contact_etablissement:Contact de l'Administration:true","contact_economat:Contact de l'Economat:true","mots_interdits:Liste des mots interdits (séparés par une virgule):true","nb_heures_delai_examen:Nombre d'heures de tolérance pour les examens:true","donnees_contrat.montant_par_user:Montant par utilisateur","donnees_contrat.unite_montant_par_user:Devise du montant","donnees_contrat.frequence_paiement:Modalités de paiement","donnees_contrat."+id_contrat+":Voir le contrat:false:true"];var info_etablissement_html="";liste_id_infos_etablissement.forEach(function(info){id_info=info.split(":")[0];etiquette_info=info.split(":")[1];valeur_info=id_info.includes(".")?data_etablissement[id_info.split(".")[0]][id_info.split(".")[1]]:data_etablissement[id_info];info_etablissement_html+=information_etablissement(id_info,etiquette_info,valeur_info,eval(info.split(":")[2]),eval(info.split(":")[3]))});info_etablissement_html+=`
		<details class="un_detail" style="color: #F00;">
		  <summary>ZONE DE DANGER</summary>
		  <span onclick="supprimer_etablissement()">Supprimer mon établissement de Sekooly</span>
		</details>
		`;$("#menu_details").append(info_etablissement_html);return true}else if(id_parametre==="</> Intégrer Sekooly à mon site"){$("#menu_details").append(`<blockquote style="padding: 5%;" id="contenu_code_iframe" onclick="copier_liste('#contenu_code_iframe','contenu_code_iframe')"></blockquote>
			<h3>
				Pour intégrer Sekooly à votre site web, vous pouvez copier le code ci-dessus, puis le coller dans votre page html.
			</h3>
			<button onclick="copier_liste('#contenu_code_iframe','contenu_code_iframe')">COPIER LE CODE</button>`);var code_iframe=`
	<!DOCTYPE html>
	<html>
	<head>
		<link rel="icon" href="https://`+nom_etablissement+`.sekooly.com/favicon.ico">
		<meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=1">
		<title>Sekooly | `+nom_etablissement.toUpperCase()+`</title>
	</head>
	<body style="margin:0px;padding:0px;overflow:hidden;height: 100vh;width: 100vw;">
		<iframe src="https://`+nom_etablissement+`.sekooly.com/tele-enseignement" frameborder="0" style="overflow:hidden;height:100%;width:100%" height="100%" width="100%"></iframe>
	</body>
	</html>

		`;$("#contenu_code_iframe").text(code_iframe);$("#contenu_code_iframe").attr("contenu_code_iframe",code_iframe)}else{var identifiant_table=identifiant_par_table(id_parametre);return rechercher_tout(id_parametre).then(function(e){liste_JSON=e;traiter_liste_JSON(id_parametre,liste_JSON,identifiant_table);$("#nombre_elements_param")[0].innerText=liste_JSON.length;affichage_par_defaut(id_parametre);masquer_params_auto();au_changement_du_filtre();return liste_JSON})}}async function supprimer_etablissement(){var e=recuperer("mon_type").split("_")[0];var i=await recuperer_mes_donnees();if(i){var r=prompt("Merci de saisir votre code d'accès pour démarrer le processus de suppression.");if(!r)return afficher_alerte("Demande de suppression annulée.");if(code_ok(i,r)){var t=await chercher_lien_script(5);var n="?premiere_demande=oui";var a="&adresse_mail_suppression="+data_etablissement["contact_etablissement"];var s="&nom_etablissement="+data_etablissement["nom_etablissement"];var o="&id_etablissement="+data_etablissement["id_etablissement"];url=t+n+a+s+o;chargement(true);resultat=await post_resultat_asynchrone(url,{});alert(resultat);chargement(false)}else{console.error("Code erroné.")}}else{return false}}function au_changement_du_filtre(){$("#filtre_parametre").on("change",function(e){compter_nombre_de_lignes()})}function compter_nombre_de_lignes(){$("#nombre_elements_param")[0].innerText=$("tbody").find(".une_ligne_de_donnees:visible").length}function traiter_liste_JSON(e,i,r){if(i!==null&&i!==undefined&&i!==""&&i.length>0){$("#menu_details").append(json2Table(i,r));au_clic("[suppression_id]","clic_ligne(this)")}else{element_DOM("menu_details").innerHTML='<i class="date_fin">Pas encore de données dans '+e+".</i>";effacer(e)}}function mettre_details_cycle(){filtre_liste=[];rechercher_tout("ID_RENDUS").then(function(e){var i=e;for(key in i){filtre_liste.push(key)}})}function mettre_details_maintenance(){var r="Si la maintenance est activée, seuls certains membres de l'Administration pourront accéder à la plateforme.";var e=est_en_maintenance();e.then(function(e){var i='<div style="margin: 5% 5% 0% 5%;">'+r+'</div> <span class="toggle"><label class="switch"><input type="checkbox" id="changer_maintenance"><span class="slider round"></span></label></span><div id="texte_maintenance" style="color: #c0bdbd;"></div>';$("#menu_details").append(i);$("#changer_maintenance")[0].checked=e==="oui";$("#texte_maintenance")[0].innerText=e==="oui"?"Activé":"Désactivé";$("#changer_maintenance").on("change",function(e){switcher_la_maintenance();var i=$("#texte_maintenance")[0].innerText==="Activé"?"Désactivé":"Activé";$("#texte_maintenance")[0].innerText=i})})["catch"](e=>{alert("Impossibile de récupérer la valeur de la maintenance :"+e);console.error(e)})}function actualiser_filtre_onglet(e){var i="";var r=[];$("#filtre_parametre")[0].innerHTML="";var t=JSON.parse(recuperer("mes_matieres"));var n=recuperer("Matieres")?JSON.parse(recuperer("Matieres")):t;if(e==="Cycles"||e==="Maintenance"||e==="Alerte"||e==="Logs"||e==="Espace etablissement restant"||e==="Infos établissement"){i="Etablissement";r=[nom_etablissement]}else{if(e==="Matieres"||e==="Eleves"){i="Classe";r=valeursUniquesDeCetteKey(n,"Classe")}else{i="Cycle";r=valeursUniquesDeCetteKey(n,"Cycle")}}assigner_label_et_liste_parametres(i,r);mettre_barre_recherche()}function assigner_label_et_liste_parametres(e,i){$("#label_filtre_parametre")[0].innerText=e;$("#filtre_parametre")[0].innerHTML=$("#filtre_parametre")[0].innerHTML+'<option value="(Tous)">(Tous)</option>';for(var r=i.length-1;r>=0;r--){$("#filtre_parametre")[0].innerHTML=$("#filtre_parametre")[0].innerHTML+'<option value="'+i[r]+'">'+i[r]+"</option>"}if($("#boutons_params"))$("#boutons_params").remove();var t=un_bouton_param("actu_param","actualiser_parametre","Actualiser","img_actualiser.png");var n=un_bouton_param("ajout_param","ajouter_donnees_parametres","Ajouter","img_ajout.png");var a=un_bouton_param("suppr_param","supprimer_ligne_parameters","Supprimer","img_redtrash.png");var s=un_bouton_param("dupliquer_param","dupliquer_donnees_parametres","Dupliquer","img_dupliquer.png");var o=un_bouton_param("telecharger_param","telecharger_donnees_parametres","Télécharger","img_download.png");var _=un_bouton_param("importer_param","importer_parametres","Importer","img_import.png");var l=un_bouton_param("reset_param","init_donnees","Initialiser","img_reset.png");var c=un_bouton_param("tout_voir","afficher_colonnes","Afficher toutes les colonnes","img_previz.png");$("#conteneur_filtre")[0].innerHTML=$("#conteneur_filtre")[0].innerHTML+'<span id="boutons_params"> '+t+n+a+s+o+_+l+c+" </span>";$("#filtre_parametre").on("change",function(e){appliquer_filtre_choisi()})}function mettre_barre_recherche(){$("#zone_recherche").remove();$("#stockage").remove();var e='<input id="zone_recherche" type="text" onkeyup="chercher()" placeholder="Rechercher...">';$("#conteneur_filtre").append(e)}function mettre_etat_espace(i,r){resultat="";if(i==="Espace etablissement restant"){$("label_filtre_parametre").remove();$("filtre_parametre").remove();$(".stockage").remove();mettre_la_somme(r);$("#zone_recherche").on("input",function(e){r=e.target.value;$(".stockage").remove();if(i==="Espace etablissement restant")mettre_la_somme(r)});return true}return false}function mettre_la_somme(e){la_somme=somme("Espace etablissement restant","octets_utilises",e);valeur_max=5e10;pourcentage=100*(la_somme/valeur_max).toFixed(4);precisions=e?e:"total";resultat='<div id="stockage" class="stockage"><i style="margin-left: 50px;"><label>Stockage utilisé '+precisions+':<progress style="width: 60px;" value="'+la_somme+'" max="'+valeur_max+'"></progress> '+pourcentage.toFixed(2)+"% ("+(la_somme/1e9).toFixed(2)+"/50 Go)</i></span></div>";$("#conteneur_filtre").append(resultat)}function chercher(){table=element_DOM("table_affichee");tr=table.getElementsByTagName("tr");mon_filtre=element_DOM("zone_recherche").value.toUpperCase().trim();if(mon_filtre){for(i=1;i<tr.length;i++){texte_ligne=tr[i].textContent.toUpperCase();tr[i].style.display=texte_ligne.includes(mon_filtre)?"":"none";if(texte_ligne.includes(mon_filtre)&&mon_filtre){for(j=0;j<tr[i].children.length;j++){cellule=tr[i].cells[j];valeur_cellule=cellule.textContent.toUpperCase();if(valeur_cellule.includes(mon_filtre)){cellule.className="trouvee"}else{cellule.className=""}}}}}else{$("tr").show();$("td").removeClass()}compter_nombre_de_lignes()}function un_bouton_param(e,i,r,t){return'<img id="'+e+'" onclick="'+i+'()" alt="'+r+'" src="'+prefixe_image+"/"+t+'" class="icone_param">'}function json2Table(e,r){var i=$(".un_menu_orange")[0].id||$(".un_menu_orange")[0].value;let t=nom_des_champs(i);let n=t.map(e=>`<th id="${e}" oncontextmenu="afficher_clic_droit_param(this)" class="header_table entete_sticky sekooly-mode-background">${e}</th>`).join("");let a=e.map((i,e)=>{if(i!==null){let e=t.map(e=>`<td>${i[e]}</td>`).join("");return`<tr suppression_id="${i[r]}" id="${i[r]}"  class= "border_bottom une_ligne_de_donnees">${e}</tr>`}}).join("");const s=`
	<table id="table_affichee">
		<thead class="">
			<tr class= "border_bottom">${n}</tr>
		</thead>
		<tbody style="transform: rotateX(0deg);">
			${a}
		</tbody>
	</table>`;return s}function clic_ligne(e){if($(".une_ligne_de_donnees.selected")[0])$(".une_ligne_de_donnees.selected")[0].className="une_ligne_de_donnees";e.className="une_ligne_de_donnees selected"}function supprimer_tous_les_parametres(){for(var e=0;e<elements_menu_haut.length;e++){effacer(elements_menu_haut[e])}}function rendre_td_modifiable(){$(document).on("dblclick","tbody",function(e){fonction_td_modifiable(e)})}function fonction_td_modifiable(i,e){var r=i.target.innerText;var t=$(".un_menu_orange")[0].id||$(".un_menu_orange")[0].value;var n=","+parametres_automatiques.map(e=>$('[id="'+e+'"].header_table.entete_sticky:visible')).filter(e=>e.length>0).map(e=>e[0].cellIndex).join(",")+",";var a=","+champs_oui_ou_non.map(e=>$('[id="'+e+'"].header_table.entete_sticky:visible')).filter(e=>e.length>0).map(e=>e[0].cellIndex).join(",")+",";var s=$("#Classe")[0]?i.target.cellIndex===$("#Classe")[0].cellIndex:false;var o=$("#Classe_principale")[0]?i.target.cellIndex===$("#Classe_principale")[0].cellIndex:false;var _=$("#classe_bis")[0]?i.target.cellIndex===$("#classe_bis")[0].cellIndex:false;var l=t!=="Classes";if(l&&(s||o||_)){var c=JSON.parse(recuperer("Matieres"));if(c===null){rechercher_tout("Matieres").then(function(e){liste_JSON=e;stocker("Matieres",JSON.stringify(liste_JSON?liste_JSON:""));c=JSON.parse(recuperer("Matieres"));valeurs_possibles=valeurs_possibles_modification_classes(i,t,c);formulaire_choix_checkbox("Classe(s)",i,r,i.target.parentNode.id,valeurs_possibles,r.split(";"),t==="Administration")})}else{valeurs_possibles=valeurs_possibles_modification_classes(i,t,c);formulaire_choix_checkbox("Classe(s)",i,r,i.target.parentNode.id,valeurs_possibles,r.split(";"),t==="Administration")}}else if(n.includes(","+i.target.cellIndex+",")){alert("Impossible de modifier ce paramètre car c'est une valeur automatiquement attribuée par Sekooly.");return false}else if(liste_couleurs.includes(r)){formulaire_choix_checkbox("Couleur",i,r,i.target.parentNode.id,liste_couleurs,r,true)}else if(a.includes(","+i.target.cellIndex+",")){var u=$(".header_table.entete_sticky")[i.target.cellIndex].innerText;formulaire_choix_checkbox(u,i,r,i.target.parentNode.id,["oui","non"],r,true)}else{var d=prompt("Indiquez la nouvelle valeur",r);suite_actualiser_double_clic(i,r,d)}}function valeurs_possibles_modification_classes(e,i,r){var t=valeursUniquesDeCetteKey(r,"Classe_Matiere");if(i==="Administration"){t=valeursUniquesDeCetteKey(r,"Cycle");t=t.map(e=>"(Tous|"+e+")")}else{if(i==="Eleves"||i==="Matieres"||e.target.cellIndex===$("#Classe_principale")[0].cellIndex){t=valeursUniquesDeCetteKey(r,"Classe")}}return t}async function suite_actualiser_double_clic(e,i,r){if(r===null)return-1;chargement(true);var t=$(".un_menu_orange")[0].id||$(".un_menu_orange")[0].value;var n=identifiant_par_table(t);var a=e.target.closest("td").parentNode.id;var s=e.target.closest("td").cellIndex;var o=$(".header_table.entete_sticky")[s].innerText;var _={[o]:i};var l={[o]:r};var c=await rechercher_tout(t);if(c!==null){if(o===n){existence_ID=c.filter(e=>e[n]===r).length>0;if(existence_ID){alert("Mise à jour impossible: cet identifiant '"+r+"' existe déjà.");chargement(false);return 0}}}if(a.includes("admin")){alert("Impossible de modifier l'admin car cet utilisateur est utile pour administrer votre plateforme sekooly.");chargement(false);return 0}try{actualiser(t,n,a,l);e.target.closest("td").innerText=r;if(o===n){e.target.closest("td").parentNode.id=r}actualiser_json_local_et_drive(t,c,o,i,r,a)}catch(u){alert("Mise à jour impossible: "+u);e.target.closest("td").innerText=i;if(o===n){e.target.closest("td").parentNode.id=i}actualiser_json_local_et_drive(t,c,o,r,i,a);console.error(u)}chargement(false)}function formulaire_choix_checkbox(e,i,r,t,n,a,s){$("#mini_popup").remove();var o='<div id="mini_popup" class="mini_popup" style="overflow: hidden auto;"><div id="entete-fenetre" style="display: inline-flex;float: right;"><img alt="X" src="'+prefixe_image+'/quitter.png" id="bye_prev" onclick="$(\'#mini_popup\').remove()" style="width: 30px; height: 30px;cursor:pointer;position:fixed;z-index:3;transform: translate(-50%, -50%);"> </div>';var _="<div>"+e+" pour <b>"+t+'</b></div><div id="liste_classe_matieres" style="padding-top: 4%;padding-bottom: 4%;text-align: left;"><div>';var l="";for(var c=0;c<n.length;c++){est_coché=a?a.indexOf(n[c])>=0?"checked":"":"";classe_initiale=est_coché==="checked"?"en_gras":"";type_element=s?"radio":"checkbox";l=l+'<div class="'+classe_initiale+'"><input class="choix_liste_matiere" type="'+type_element+'" id="'+n[c]+'" name="choix_liste_matiere" '+est_coché+"><label>"+n[c]+"</label></div>"}var u='</div></div><button type="button" class="rendre sekooly-mode-background" id="assigner">Assigner</button></div>';var d=o+_+l+u;$("body").append(d);$("#assigner").on("click",function(e){suite_actualiser_double_clic(i,r,retourner_les_cochés());$("#mini_popup").remove()});$(".choix_liste_matiere").on("change",function(e){e.target.parentNode.className=e.target.checked?"en_gras":""})}function retourner_les_cochés(){var r="";Array.from($(".choix_liste_matiere:checked")).forEach(function(e,i){r=r+(r===""?"":";")+e.id});return r}function actualiser_json_local_et_drive(e,i,r,t,n,a){if(i){i.some(function(e,i){if(e[r]===t){e[r]=n;return true}});stocker(e,JSON.stringify(i))}else{}if(r===e.slice(0,-1)){var s=a;var o=n;renommer_sur_drive(s,o)}}function renommer_sur_drive(e,i){var r="https://script.google.com/macros/s/AKfycbw4v50VJkia9YfdFkFQIYDTBLqVYmlxEGOuas9tO-PwvuEI63I/exec?";var t="id_dossier="+e;var n="nom_final="+i;var a=r+t+"&"+n;try{var s=get_resultat_brut(a);console.log(s)}catch(o){alert(o)}}function actualiser_parametre(e){if(!e)e=$(".un_menu_orange")[0].id||$(".un_menu_orange")[0].value;effacer(e);un_menu_clic(e)}function ajouter_donnees_parametres(e){if(!e)e=$(".un_menu_orange")[0].id||$(".un_menu_orange")[0].value;var i=recuperer_entetes_params(e);creer_formulaire_ajout_donnee_html(e,i)}function dupliquer_donnees_parametres(e){if(!e)e=$(".un_menu_orange")[0].id||$(".un_menu_orange")[0].value;id_ligne_dupliquee=0;var i=recuperer_entetes_params(e);creer_formulaire_ajout_donnee_html(e,i,true)}async function supprimer_ligne_parameters(e){if(!e)e=$(".un_menu_orange")[0].id||$(".un_menu_orange")[0].value;if(!$(".selected")[0]){confirmer_suppression=prompt("Vous êtes sur le point de vider TOUTE LA TABLE "+e+". Pour confirmer la suppression, merci d'écrire '"+e+"', sinon cliquez sur Annuler.");if(confirmer_suppression===e){chargement(true);supprimer_tout(e);setTimeout(function(){actualiser_parametre();chargement(false)},1500)}return 0}var i=$(".selected")[0].getAttribute("suppression_id");var r=confirm("⚠️Voulez-vous supprimer cette ligne ? Cette action est irréversible. ("+i+")");if(r){if(i.includes("admin")){alert("Impossible de supprimer l'admin car cet utilisateur est utile pour administrer votre plateforme sekooly.");chargement(false);return 0}chargement(true);if(e==="Classes"||e==="Matieres"){var t=await rechercher_tout(e);var n=$("#id_googlecalendar").length>0?$("#id_googlecalendar")[0].cellIndex:-1;var a=n>=0?$(".selected")[0].children[n].innerText:"";var s=$(".selected")[0].children[$("#commun_au_cycle")[0].cellIndex].innerText;if(s!=="oui"){var o=$(".selected")[0].children[$("#ID_URL")[0].cellIndex].innerText;supprimer_dossier(o,a);nom_champ_parent=e==="Classes"?"cycle":"classe_id";valeur_champ_parent=$(".selected")[0].children[$('[id="'+nom_champ_parent+'"]')[0].cellIndex].innerText;elements_similaires=t.filter(e=>e[nom_champ_parent]===valeur_champ_parent);est_le_dernier_dossier=elements_similaires.length===1;if(est_le_dernier_dossier){titre_parent_visible_user=e==="Classes"?"cycle":"Classe";nom_parent_visible_user=$(".selected")[0].children[$("#"+titre_parent_visible_user)[0].cellIndex].innerText;valeur_ligne_visible_user=$(".selected")[0].children[$("#"+e.slice(0,-1))[0].cellIndex].innerText;confirmation=confirm("'"+valeur_ligne_visible_user+"' était la seule "+e.slice(0,-1).toLowerCase()+" dans '"+nom_parent_visible_user+"' ("+titre_parent_visible_user+"). Voulez-vous également supprimer "+nom_parent_visible_user+" ? ("+titre_parent_visible_user+")");if(confirmation){donnees_cycle=e==="Classes"?get_resultat(racine_data+"Cycles?"+apikey+"&cycle=eq."+valeur_champ_parent):"";id_dossier_parent=e==="Classes"?donnees_cycle[0]!==undefined?donnees_cycle[0]["id_dossier_cycle"]:"":valeur_champ_parent;console.log("le parent à supprimer: "+id_dossier_parent);if(id_dossier_parent){supprimer_dossier(id_dossier_parent,a);nom_table_parent=e==="Classes"?"ID_RENDUS":"Classes";nom_table=nom_table_parent;nom_champ_reference=identifiant_par_table(nom_table_parent);valeur_champ_reference=valeur_champ_parent;if(nom_table_parent==="ID_RENDUS"){id_dossier_cycle=get_resultat(racine_data+"ID_RENDUS?Cycle=eq."+valeur_champ_parent+"&"+apikey)[0]["id_dossier_cycle"];console.log("on va supprimer le cycle: "+id_dossier_cycle);if(id_dossier_cycle)supprimer_dossier(id_dossier_cycle)}supprimer(nom_table,nom_champ_reference,valeur_champ_reference)}}}}}nom_table=e;nom_champ_reference=identifiant_par_table(e);valeur_champ_reference=i;supprimer(nom_table,nom_champ_reference,valeur_champ_reference);setTimeout(function(){actualiser_parametre();chargement(false)},1e3)}}function supprimer_dossier(e,i){var r="https://script.google.com/macros/s/AKfycbyGEGpbPE0WniCcBMbLCar_zGTNwKyABrnmfOE-zfb8TOUH4AY/exec";var e="&id_dossier="+e;var i=i?"&id_googlecalendar="+i:"";var t=r+"?suppr=true"+e+i;try{var n=get_resultat_brut(t);console.log(n)}catch(a){console.error(a);alert("Erreur survenue pendant la suppression sur le serveur: "+a)}}function telecharger_donnees_parametres(e){if(!e)e=$(".un_menu_orange")[0].id||$(".un_menu_orange")[0].value;var i='<div id="mini_popup" class="mini_popup">';i=i+'<div id="entete-fenetre" style="display: inline-flex;float: right;">';i=i+'<img alt="X" src="'+prefixe_image+'/quitter.png" id="bye_prev" onclick="$(\'#mini_popup\').remove()" style="width: 30px; height: 30px;cursor:pointer;position:fixed;z-index:3;transform: translate(-50%, -50%);"> </div>';i=i+"<div>Télécharger "+e+'</div><select style="width: 80%;" id="choix_download_param">';i=i+'<option value="En-têtes">En-têtes</option>';i=i+'<option value="Tout">Toutes les données</option></select>';i=i+'<button type="button" class="rendre sekooly-mode-background" onclick="telecharger_parametre()">Télécharger</button></div>';$("#mini_popup").remove();$("body").append(i)}async function telecharger_parametre(e){if(!e)e=$(".un_menu_orange")[0].id||$(".un_menu_orange")[0].value;var i=$("#choix_download_param")[0].value==="En-têtes";var r=i?nom_des_champs(e):await rechercher_tout(e);if(i){r=r.filter(e=>parametres_automatiques.indexOf(e)<0)}var t=convertir_csv(r,i);var n=i?"-modele-":"";var a=e+n+maintenant_sans_caracteres_speciaux()+".csv";enregistrer_donnees_en_csv(t,a)}function enregistrer_donnees_en_csv(e,i){var r=document.createElement("a");document.body.appendChild(r);r.style="display: none";var t="\ufeff";var n=new Blob([t+e],{type:"text/csv;charset=utf-8;"});url=window.URL.createObjectURL(n);r.href=url;r.target="_blank";r.download=i;r.click();window.URL.revokeObjectURL(url);r.remove()}function importer_parametres(){$("#fichier_import").remove();var l=$(".un_menu_orange")[0].id||$(".un_menu_orange")[0].value;var c=nom_des_champs(l);var e='<input id="fichier_import" type="file" name="fichier_import" accept=".csv" style="display:none;">';$("body").append(e);$("#fichier_import").on("change",function(e){if(e.target.files[0].name.split(".").pop().trim().toLowerCase()!=="csv"){alert("Erreur: merci de choisir un fichier d'extension .csv");$("#fichier_import").remove();return 0}var _=new FileReader;_.onload=function(){var e=_.result;var i=csv_en_JSON(e);console.log(i);if(i.length===0){alert("Ce fichier .csv ne contient aucune donnée à importer.");$("#fichier_import").remove();return 0}var r="";var t=Object.keys(i[0]).some(e=>{r=e;return c.indexOf(e)<0});if(t){alert("Problème d'import: le champ '"+r+"' n'est pas reconnu dans la table '"+l+"'.");$("#fichier_import").remove();return 0}var n=Number(i.length);var a=c;var s=n>1?"s":"";confirmation=confirm("Nous avons détecté "+n+" ligne"+s+" avec "+Object.keys(i[0]).length+" champs. Voulez-vous importer ces données ?");if(confirmation){chargement(true);for(var o=0;o<i.length;o++){afficher_alerte("Progression de l'import: "+Number(100*o/i.length).toFixed(2)+"% ("+o+"/"+i.length+")");creer_formulaire_ajout_donnee_html(l,a,false,i[o]?i[o]:"");ajouter_donnees_saisies(l,o<i.length-1)}afficher_alerte("Import terminé.")}$("#fichier_import").remove()};_.readAsText(e.target.files[0])});$("#fichier_import").click()}function init_donnees(){id_parametre=$(".un_menu_orange")[0].id||$(".un_menu_orange")[0].value;if($(".selected")[0]){identifiant_a_init=$(".selected")[0].getAttribute("suppression_id");var e=confirm("Êtes-vous sûr de réinitialiser '"+identifiant_a_init+"' ? Cela remettra son mot de passe par défaut, et ignorera toute consultation de notifications.");if(!e)return-1;chargement(true);reinitialiser_unseul_mdp_datenotif(id_parametre,identifiant_a_init);setTimeout(function(){actualiser_parametre()},2e3);chargement(false)}else{var e=prompt("Êtes-vous sûr d'initialiser votre plateforme ? Cela remettra TOUS les mots de passe par défaut et ignorera toute consultation de notifications. Pour continuer, taper 'reinitialiser'.");if(e==="reinitialiser"){chargement(true);reinitialiser_mdp_datenotif();setTimeout(function(){actualiser_parametre()},2e3);chargement(false)}}}function recuperer_entetes_params(e){return nom_des_champs(e)}function creer_formulaire_ajout_donnee_html(e,i,r,t){var n='<div class="mini_popup" style="overflow:auto;" id="mini_popup"><div id="entete-fenetre" style="display: inline-flex;float: right;"><img alt="X" src="'+prefixe_image+'/quitter.png" id="bye_prev" onclick="$(\'#mini_popup\').remove()" style="width: 30px; height: 30px;cursor:pointer;position:fixed;z-index:3;transform: translate(-50%, -50%);"> </div><div>Nouvelle donnée dans '+e+'</div><form class="donnees_saisies" id="donnees_saisies" >';var a="";if(i.length>0){chargement(true);for(var s=0;s<i.length;s++){disabled=parametres_automatiques.indexOf(i[s])>=0?"disabled":"";donnee_dupliquee=r?$(".selected")?' value="'+$(".selected")[0].children[s].innerText+'" ':"":t?' value="'+(t[i[s]]?t[i[s]]:"")+'" ':"";html_du_input='<input class="donnee" '+donnee_dupliquee.replaceAll('"',"'")+' id="'+i[s]+'" name="'+i[s]+'" '+disabled+">";if(!t){if(i[s]==="Couleur_matiere"){html_du_input='<select class="donnee" id="'+i[s]+'" name="'+i[s]+'" >';for(j=0;j<liste_couleurs.length;j++){selectionner_la_donnee_dupliquee="";if($(".selected")[0])selectionner_la_donnee_dupliquee=liste_couleurs[j]===$(".selected")[0].children[s].innerText?" selected ":"";html_du_input=html_du_input+"<option "+selectionner_la_donnee_dupliquee+' value ="'+liste_couleurs[j]+'">'+liste_couleurs[j]+"</option>"}html_du_input=html_du_input+"</select>"}else if(champs_avec_listes_dynamiques.indexOf(i[s])>=0){toutes_les_matieres=get_resultat(racine_data+"Matieres"+"?"+apikey);choix_classe_dun_admin=(i[s]==="Classe"||i[s]==="classe_bis")&&$(".un_menu_orange")[0].innerText==="Administration";choix_classe_dun_prof=(i[s]==="Classe"||i[s]==="classe_bis")&&$(".un_menu_orange")[0].innerText==="Profs";nom_du_champ_clé=i[s]==="cycle"?"Cycle":i[s]==="classe_bis"||i[s]==="Classe_principale"?"Classe":choix_classe_dun_admin?"Cycle":choix_classe_dun_prof?"Classe_Matiere":i[s];valeurs_possibles=valeursUniquesDeCetteKey(toutes_les_matieres,nom_du_champ_clé);if(choix_classe_dun_admin)valeurs_possibles=valeurs_possibles.map(e=>"(Tous|"+e+")");multiple_choix_classes=choix_classe_dun_prof?"multiple":"";if(valeurs_possibles.length===0){html_du_input='<input class="donnee" '+donnee_dupliquee+' id="'+i[s]+'" name="'+i[s]+'" '+disabled+">"}else{html_du_input='<select class="donnee" id="'+i[s]+'" name="'+i[s]+'" '+multiple_choix_classes+" "+disabled+">";for(j=0;j<valeurs_possibles.length;j++){selectionner_la_donnee_dupliquee="";if($(".selected")[0])selectionner_la_donnee_dupliquee=valeurs_possibles[j]===$(".selected")[0].children[s].innerText?" selected ":"";html_du_input=html_du_input+"<option "+selectionner_la_donnee_dupliquee+' value ="'+valeurs_possibles[j]+'">'+valeurs_possibles[j]+"</option>"}html_du_input=html_du_input+'<option value="nouveau" style="font-style: oblique;" >Nouvelle valeur</option>'+"</select>"}}else if(champs_oui_ou_non.indexOf(i[s])>0){selected_oui=donnee_dupliquee.includes("oui")?" selected ":"";selected_non=donnee_dupliquee.includes("non")?" selected ":"";html_du_input='<select class="donnee" value="non" id="'+i[s]+'" name="'+i[s]+'" ><option value="non" '+selected_non+'>non</option><option value="oui" '+selected_oui+">oui</option></select>"}}var o=" style='display:"+(disabled?"none":"")+"';";a=a+'<div class="une_donnee_saisie" '+o+' id="'+i[s]+'"><label>'+i[s]+"</label>"+html_du_input+"</div>"}}var _='</form><button type="button" class="rendre sekooly-mode-background" onclick="ajouter_donnees_saisies(\''+e+"')\">Ajouter</button>";_=_+'<button type="button" class="rendre sekooly-mode-background" onclick="$(\'#mini_popup\').remove()">Annuler</button></div>';_=_;$("#mini_popup").remove();$("body").append(n+a+_);$("select.donnee").on("change",function(e){if(e.target.value==="nouveau"){transformer_en_simple_input(e.target.id)}});chargement(false)}function transformer_en_simple_input(e){nouvelle_valeur=prompt("Indiquez la nouvelle valeur de "+e+": ");if(nouvelle_valeur!==null){$("[id='"+e+"'].donnee")[0].outerHTML='<input class="donnee" value="'+nouvelle_valeur+'" id="'+e+'" name="'+e+'">'}else{$("[id='"+e+"'].donnee")[0].value=""}}function ajouter_donnees_saisies(e,i){nom_cycle=$(".donnee#cycle").length>0?$(".donnee#cycle")[0].value:$(".donnee#Cycle").length>0?$(".donnee#Cycle")[0].value:"";nom_classe=$(".donnee#Classe").length>0?$(".donnee#Classe")[0].value.includes("|")?"":$(".donnee#Classe")[0].value:"";nom_matiere=$(".donnee#Matiere").length>0?$(".donnee#Matiere")[0].value:"";if(e==="Classes"){var r=JSON.parse(recuperer("Classes"));if(r!==null){var t=r.some(e=>{if(e)return e["Classe"]===nom_classe&&e["cycle"]===nom_cycle});if(t){alert("Cette classe existe déjà dans ce cycle.");return-1}}}else if(e==="Matieres"){var n=JSON.parse(recuperer("Matieres"));if(n!==null){var a=n.some(e=>{if(e)return e["Classe"]===nom_classe&&e["Matiere"]===nom_matiere+")"});if(a){alert("Cette matière existe déjà.");return-1}}}if(e==="Classes"||e==="Matieres"){if(formulaire_rempli("donnees_saisies")===false){if(plateforme_prete()===true&&!i){alert("Merci de remplir tous les champs.");return-1}}var s=nom_etablissement?"?nom_etablissement="+nom_etablissement:"";var o=nom_cycle?"&nom_cycle="+nom_cycle:"";var _=nom_classe?"&nom_classe="+nom_classe:"";var l=nom_matiere?"&nom_matiere="+nom_matiere:"";var c=$(".donnee#commun_au_cycle")[0]?"&commun_au_cycle="+$(".donnee#commun_au_cycle")[0].value:"non";id_rendu_actuel=get_resultat(racine_data+"ID_RENDUS?"+apikey+"&Cycle=eq."+nom_cycle);var u=id_rendu_actuel.length===0;var d="&initier="+u;var m="https://script.google.com/macros/s/AKfycbyGEGpbPE0WniCcBMbLCar_zGTNwKyABrnmfOE-zfb8TOUH4AY/exec";m=m+s;m=m+o;m=m+_;m=m+l;m=m+c;m=m+d;chargement(true);var f=get_resultat(m);var p=nom_classe;var v=get_valeur(f,p);var h=get_valeur(f,nom_cycle);var g=get_valeur(f,"id_googlecalendar");var b=nom_matiere;var y=get_valeur(f,b);var x=get_valeur(f,"Rendus de devoirs");if(u){nouveau_data={Cycle:nom_cycle,dossier_rendus_cycle:x,id_dossier_cycle:h};post_resultat_asynchrone(racine_data+"ID_RENDUS?"+apikey,nouveau_data)}$(".donnee[id='commun_au_cycle']")[0].value=e==="Matieres"&&($(".donnee#Cycle")[0].value===$(".donnee#Matiere")[0].value||$(".donnee#Matiere")[0].value==="Vie scolaire")?"oui":"non";if(e==="Classes"){$(".donnee[id='Classe_bis']")[0].value=p;$(".donnee[id='ID_URL']")[0].value=v;$(".donnee[id='URL']")[0].value="https://drive.google.com/drive/folders/"+v;$(".donnee[id='URL_Mapping']")[0].value=v;$(".donnee[id='id_googlecalendar']")[0].value=g;$(".donnee[id='URL_agenda']")[0].value="https://calendar.google.com/calendar/embed?src="+g+"&ctz="+my_ctz()}else if(e==="Matieres"){$(".donnee[id='Classe_Matiere']")[0].value="("+p+"|"+b+")";$(".donnee[id='ID_URL']")[0].value=y;$(".donnee[id='Matiere_bis']")[0].value=b;$(".donnee[id='URL']")[0].value="https://drive.google.com/drive/folders/"+y;$(".donnee[id='URL_Mapping']")[0].value=y;$(".donnee[id='classe_id']")[0].value=v}}else if(e==="Eleves"||e==="Profs"||e==="Administration"){if(e.includes("Admin"))$(".donnee[id='Classe']")[0].value="(Tous|"+$(".donnee[id='Cycle']")[0].value+")";$(".donnee[id='Derniere_consultation_notifs']")[0].value="30/12/1899 00:00:00";$(".donnee[id='type']")[0].value=e.includes("Admin")?"Administration":e;$(".donnee[id='Droit_acces_anticipe_examen']")[0].value=e.includes("Eleves")?"non":"oui";if($(".donnee[id='Droit_changer_ecolage']")[0])$(".donnee[id='Droit_changer_ecolage']")[0].value="non";if($(".donnee[id='Droits_modifs']")[0])$(".donnee[id='Droits_modifs']")[0].value="non";$(".donnee[id='Ecolage_OK']")[0].value="oui";$(".donnee[id='code_hash']")[0].value="nok";$(".donnee[id='Reponse_sondage']")[0].value="non";$(".donnee[id='droit_hors_maintenance']")[0].value="non";$(".donnee[id='liste_notifs_lues']")[0].value=",";if($(".donnee[id='Numero_telephone']")[0])$(".donnee[id='Numero_telephone']")[0].value="123456"}var q=convertir_saisie_en_JSON("donnees_saisies",e);var M=recuperer(e)?JSON.parse(recuperer(e)).length:1;ajouter_un_element(e,JSON.parse(q),M);if(!i)actualiser_parametre(e);vider_les_input();chargement(false);return 0}function get_valeur(e,i){var r=e.findIndex(e=>e.includes(i+":"));return e[r].split(i+":")[1]}function convertir_saisie_en_JSON(e,i){var r="{";var t=$("#"+e)[0].children;i=i?i:$(".un_menu_orange")[0]?$(".un_menu_orange")[0].innerText:"";for(var n=0;n<t.length;n++){nom_champ=$("#"+e)[0].children[n].children[0].innerText;valeur_saisie=nom_champ==="Classe"&&i==="Profs"&&$("#Classe.donnee")[0].nodeName!=="INPUT"?$("#Classe.donnee").val().join(";"):$(".donnee[id='"+nom_champ+"']")[0].value;r=r+'"'+[nom_champ]+'"'+":"+'"'+valeur_saisie+'"';virgule=n===t.length-1?"":",";r=r+virgule}r=r+"}";return r}function formulaire_rempli(e){return!Array.from($("#"+e)[0].children).some(function(e,i,r){est_actif=!$(".donnee[id='"+e.id+"']")[0].disabled;est_vide=$(".donnee[id='"+e.id+"']")[0].value==="";return est_actif&&est_vide})}function formulaire_rempli_ok(e){return!Array.from($("#"+e)[0].children).some(function(e,i,r){est_actif=!$("[name='"+e.name+"']")[0].disabled;est_vide=$("[name='"+e.name+"']")[0].value==="";return est_actif&&est_vide})}function vider_les_input(){Array.from($(".donnee.donnee")).forEach(e=>e.value="")}function afficher_bulletins(e){if(element_DOM("bulletin"))element_DOM("bulletin").style.display=e?"":"none"}function supprimer_bulle_bulletins(){if($("#bulletin")[0])$("#bulletin")[0].parentNode.remove();masquer_les_bulletins()}function masquer_les_bulletins(){$("#titre_drive_bulletins")[0].style.display="none";$("#drive_bulletins")[0].style.display="none"}function clic_bulletin(){chargement(true);if(recuperer("mon_type").includes("Administration")){if(recuperer("dossier_chargé")&&$("#accueil_utilisateur")[0].innerText.includes("Vie de classe")){afficher_ou_non_choix_fichier(true);mode_bulletin(true)}else{alert("Merci d'ouvrir un dossier Vie de classe avant de publier un bulletin.")}chargement(false)}else if(recuperer("mon_type").includes("Eleves")){choisir_periode_bulletin();chargement(false)}else{choisir_periode_et_classe_bulletin();chargement(false)}}function choisir_periode_et_classe_bulletin(){var e=valeursUniquesDeCetteKey(JSON.parse(recuperer("mes_matieres")),"Classe");var r="";e.forEach(function(e,i){r+='<option value="'+e+'">'+e+"</option>"});var i=`<div><label for="periode_bulletin"><select style="width: 60%;" id="periode_bulletin" name="periode_bulletin"><option value="PREMIER TRIMESTRE">PREMIER TRIMESTRE</option><option value="DEUXIEME TRIMESTRE">DEUXIEME TRIMESTRE</option><option value="TROISIEME TRIMESTRE">TROISIEME TRIMESTRE</option><option value="ANNUEL">ANNUEL</option></select></label>
		<label for="la_classe"><select style="width: 60%;" id="la_classe_bulletin" name="la_classe">`+r+`</select></label></div>`;creer_mini_popup("Choisissez la période et la classe du bulletin à consulter:",i,"Consulter","consulter_bulletin_de_la_classe()")}function id_vie_de_classe(e){url=racine_data+"Matieres?Classe=eq."+e+"&Matiere=eq.Vie de classe"+"&"+apikey;resultat=get_resultat(url);if(resultat)resultat=resultat[0]["ID_URL"];return resultat}function consulter_bulletin_de_la_classe(){chargement(true);periode_bulletin=$("#periode_bulletin")[0].value;nom_classe=$("#la_classe_bulletin")[0].value;id_classe=id_vie_de_classe(nom_classe);url=racine_data+"Fichiers?categorie_fichier=eq.Bulletins&periode_bulletin=eq."+periode_bulletin+"&id_dossier=eq."+id_classe+"&"+apikey;resultat_bulletins=get_resultat(url);if(resultat_bulletins.length===0){alert("Aucun bulletin disponible sur la période '"+periode_bulletin.toLowerCase()+"' pour la classe de '"+nom_classe+"' pour l'instant.");chargement(false)}else{resultat_bulletins=resultat_bulletins[0];console.log(resultat_bulletins);visualiser(resultat_bulletins["nom_fichier"],resultat_bulletins["id_fichier"],"","",true);$("#mini_popup").remove();chargement(false)}return"Consultation terminée.";chargement(false)}function choisir_periode_bulletin(){var e='<label for="periode_bulletin"><select style="width: 60%;" id="periode_bulletin" name="periode_bulletin"><option value="PREMIER TRIMESTRE">PREMIER TRIMESTRE</option><option value="DEUXIEME TRIMESTRE">DEUXIEME TRIMESTRE</option><option value="TROISIEME TRIMESTRE">TROISIEME TRIMESTRE</option><option value="ANNUEL">ANNUEL</option></select></label>';creer_mini_popup("Choisissez la période du bulletin à consulter:",e,"Consulter","consulter()")}function consulter(){chargement(true);consulter_mon_bulletin(recuperer("identifiant_courant"));chargement(false)}function choisir_clic_bulletin(){popup_choix='<div class="mini_popup" id="mini_popup"><div id="entete-fenetre" style="display: inline-flex;float: right;"><img alt="X" src="'+prefixe_image+'/quitter.png" id="bye_prev" onclick="$(\'#mini_popup\').remove()" style="width: 30px; height: 30px;cursor:pointer;position:fixed;z-index:3;transform: translate(-50%, -50%);"> </div><div>Que voulez-vous faire?</div><select style="width: 80%;" id="choix_bulletin"><option value="upload">Mettre en ligne les bulletins</option><option value="voir">Voir les bulletins en ligne</option></select><button type="button" class="rendre sekooly-mode-background" onclick="choix_bulletin_ok()">Valider</button></div>';$("body").append(popup_choix)}function choix_bulletin_ok(){if($("#choix_bulletin")[0].value==="upload"){afficher_ou_non_choix_fichier(true);mode_bulletin(true)}else if($("#choix_bulletin")[0].value==="voir"){consulter_mon_bulletin()}$("#mini_popup").remove()}function consulter_mon_bulletin(e){motif='*"'+e+'"*';if(!e)motif="*";periode_bulletin=$("#periode_bulletin")[0].value;url=racine_data+"Fichiers?categorie_fichier=eq.Bulletins&periode_bulletin=eq."+periode_bulletin+"&destinataire_par_page=like."+motif+"&"+apikey;resultat_bulletins=get_resultat(url);if(resultat_bulletins.length===0){alert("Aucun bulletin disponible à votre nom sur la période '"+periode_bulletin.toLowerCase()+"' pour l'instant.");chargement(false)}else{for(numero_bulletin=0;numero_bulletin<resultat_bulletins.length;numero_bulletin++){id_fichier_bulletin=resultat_bulletins[numero_bulletin]["id_fichier"];mon_numero_page=Number(JSON.parse(resultat_bulletins[numero_bulletin]["destinataire_par_page"])[e]);if(e){afficher_mon_bulletin(id_fichier_bulletin,mon_numero_page,e)}else{afficher_mon_bulletin(id_fichier_bulletin,1)}}$("#mini_popup").remove()}return"Consultation terminée."}function mode_bulletin(e){if(e){$("#categorie_choisie")[0].value="Bulletins";element_DOM("categorie_choisie").disabled=true;element_DOM("choix_youtube").style.display="none";element_DOM("choix_extrait_manuel").style.display="none";element_DOM("choix_date_effet").style.display="none";element_DOM("telechargeable").style.display="none";element_DOM("est_telechargeable").checked=false;element_DOM("file").setAttribute("accept","application/pdf");element_DOM("choix_popup").setAttribute("style","visibility: visible;overflow-y: scroll;width: 450px;max-width: 95%;overflow-x: hidden;");element_DOM("file").value="";$("[value='Bulletins']")[0].style.display="";element_DOM("choix_chapitre").style.display="none"}else{$("#attribution").remove();$("#trimestre").remove();element_DOM("categorie_choisie").disabled=false;element_DOM("choix_youtube").style.display="";element_DOM("choix_extrait_manuel").style.display="";element_DOM("choix_date_effet").style.display="";element_DOM("telechargeable").style.display="";element_DOM("est_telechargeable").checked=true;element_DOM("file").setAttribute("accept",".txt,.bmp,.gif,.jpeg,.jpg,.png,.png,.pdf,.bmp,.xlsx,.xls,.xlsm,.ppt,.pptx,.doc,.docx,.html,.csv,.js,.rtf,.mp4,.mp3,.wav");element_DOM("choix_popup").setAttribute("style","visibility: visible");$("[value='Bulletins']")[0].style.display="none";$("#categorie_choisie > [value='Manuels']")[0].style.display=!recuperer("mon_type").includes("Administration")?"none":"";element_DOM("choix_chapitre").style.display=""}}function afficher_mon_bulletin(e,i,r){var t="https://www.googleapis.com/drive/v2/files/"+e+"?key="+google_api_file_access+"&alt=media&source=downloadUrl";PDFJS.getDocument(t).then(function(e){visualiser("nom_fichier","","","Bulletin "+r||" ",true,true);e.getPage(i).then(function s(e){var i=2.5;var r=e.getViewport(i);var t=document.getElementById("vizcanva");var n=t.getContext("2d");t.height=r.height;t.width=r.width;$("#vizcanva").on("contextmenu",function(e){return false});var a=e.render({canvasContext:n,viewport:r});a.promise.then(function(){element_DOM("previsualisation").setAttribute("style","overflow: scroll;height:60%");chargement(false)})["catch"](e=>console.error(e))})})}function mon_ecolage_est_ok(){if(recuperer("mon_type").includes("Eleves")){identifiant_eleve=recuperer("identifiant_courant");url=racine_data+"Eleves"+"?Identifiant=eq."+identifiant_eleve+"&"+apikey;try{return get_resultat(url)[0]["Ecolage_OK"]==="oui"}catch(e){return false}}else{return true}}function telecharger_canvas(){mon_ecolage_ok=mon_ecolage_est_ok();if(mon_ecolage_ok){var e=document.createElement("a");e.download="Bulletin-"+identifiant_eleve+".png";e.href=document.getElementById("vizcanva").toDataURL();e.click();e.remove()}else{alert("Vous devez régulariser vos frais de scolarité pour accéder à votre bulletin complet.")}}a_stocker=recuperer("a_stocker")?JSON.parse(recuperer("a_stocker")):{};function plateforme_prete(){return get_resultat(racine_initiale+"/Etablissements?nom_etablissement=eq."+nom_etablissement+"&"+api_initial)[0]["plateforme_prete"]}function initialisation_de_la_plateforme(){vider_fenetre(progression_initialisation());$("#bye_prev").remove();$("#barre_verticale").remove();$("#mynavbar").remove();$("#span_date_effet").remove();afficher_fenetre(true);contenu="Bonjour <span  class='sekooly-mode' > "+recuperer("identifiant_courant").toUpperCase()+"</span>, et bienvenue sur la plateforme de télé-enseignement Sekooly!<br><br>";contenu+="Pour mettre en route la plateforme de l'établissement <b>"+nom_etablissement.toUpperCase()+"</b>, nous aurons besoin de quelques informations supplémentaires.<br><br><rouge>Toutes les informations que vous allez saisir seront modifiables plus tard.</rouge><br>";bouton="<button onclick='suivant()' id='bouton_suivant' class='mon_bouton sekooly-mode-background' style='height: 50px;font-size: inherit;'>C'est parti!</button>";conteneur_texte_html='<div class="init" style="overflow: hidden auto;height: 90%;padding: 2%;text-align: center;font-size: 150%;"><div id="contenu_etape">'+contenu+"</div>"+bouton+"</div>";conteneur_texte=document.createElement("div");conteneur_texte.innerHTML=conteneur_texte_html;$("#fenetre")[0].appendChild(conteneur_texte.firstChild);if(numero_etape>0){suivant()}else{chargement(false)}}function suivant(){if(enregistrer_la_saisie()){numero_etape=numero_etape+1;if(numero_etape<nb_etapes){resultat=get_resultat(racine_initiale+"Etapes?id=eq."+numero_etape+"&"+api_initial)[0];changer_contenu_etape(resultat["contenu_etape"]);changer_texte_bouton(resultat["bouton_suivant"]);$("#titre_fenetre")[0].innerHTML=progression_initialisation()}else{chargement(true);changer_contenu_etape("Merci de patienter sans actualiser l'onglet, nous créons vos données!");$("#bouton_suivant").remove();$("#titre_fenetre")[0].innerHTML=progression_initialisation();proceder_a_linitialisation()}}else{alert("Vous devez saisir l'information pour continuer.")}chargement(false)}function proceder_a_linitialisation(){a_stocker=JSON.parse(recuperer("a_stocker"));var e={Role:a_stocker["Role"],Telephone:a_stocker["Telephone"],Cycle:a_stocker["Cycle"],Classe:"(Tous|"+a_stocker["Cycle"]+")"};url=racine_data+"Administration?Identifiant=eq."+recuperer("identifiant_courant")+"&"+apikey;patch_resultat_asynchrone(url,e);chargement(true);var e={Cycle:a_stocker["Cycle"],Classe:"(Tous|"+a_stocker["Cycle"]+")"};url=racine_data+"Administration?Identifiant=eq.admin&"+apikey;patch_resultat_asynchrone(url,e);chargement(true);nouvelle_classe={Classe:a_stocker["Classe"],Cycle:a_stocker["Cycle"],cycle:a_stocker["Cycle"]};try{creer_formulaire_ajout_donnee_html("Classes",recuperer_entetes_params("Classes"),false,nouvelle_classe);$("#mini_popup")[0].style.display="none";ajouter_donnees_saisies("Classes",true)}catch(i){console.error(i);alert(i)}chargement(true);nouvelle_matiere={Classe:a_stocker["Classe"],Cycle:a_stocker["Cycle"],cycle:a_stocker["Cycle"],Matiere:a_stocker["Matiere"],coefficient_matiere:a_stocker["coefficient_matiere"],Couleur_matiere:"noir",commun_au_cycle:"non"};try{creer_formulaire_ajout_donnee_html("Matieres",recuperer_entetes_params("Matieres"),false,nouvelle_matiere);$("#mini_popup")[0].style.display="none";ajouter_donnees_saisies("Matieres",true)}catch(i){console.error(i);alert(i)}chargement(true);nouveau_prof={Nom:a_stocker["Nom_prof"],"Prénom(s)":a_stocker["Prénoms_prof"],Identifiant:a_stocker["Nom_prof"].trim().toLowerCase()+"."+a_stocker["Prénoms_prof"].trim().toLowerCase(),Code:"123456",Cycle:a_stocker["Cycle"],Classe:"("+a_stocker["Classe"]+"|"+a_stocker["Matiere"]+")",Nom_complet:a_stocker["Nom_prof"]+" "+a_stocker["Prénoms_prof"]};ajouter_un_element("Profs",nouveau_prof);chargement(true);nouveau_eleve={Nom:a_stocker["Nom"],"Prénom(s)":a_stocker["Prénom(s)"],Identifiant:a_stocker["Nom"].trim().toLowerCase()+"."+a_stocker["Prénom(s)"].trim().toLowerCase(),Code:a_stocker["Code"],Cycle:a_stocker["Cycle"],Classe:a_stocker["Classe"]};ajouter_un_element("Eleves",nouveau_eleve);chargement(true);rechercher("Matieres","Cycle",a_stocker["Cycle"]).then(e=>{stocker("mes_matieres",JSON.stringify(e))});rechercher("Administration","Identifiant",recuperer("identifiant_courant")).then(e=>{stocker("mes_donnees",JSON.stringify(e[0]))});e={plateforme_prete:true,date_premier_abonnement:moment().format("DD/MM/YYYY")};patch_resultat_asynchrone(racine_initiale+"Etablissements?nom_etablissement=eq."+nom_etablissement+"&"+api_initial,e).then(function(e){console.log(e);var i=element_DOM("snackbar");i.innerText="Votre plateforme est prête.";i.className="show";setTimeout(function(){i.className="";window.location.href=window.location.href},3e3)})}function enregistrer_la_saisie(){if(numero_etape>0){tout_est_ok=$("#contenu_etape :input")[0]?$("#contenu_etape :input")[0].value.trim()!=="":true;if(tout_est_ok&&$("#contenu_etape :input")[0]){for(i=0;i<$("#contenu_etape :input").length;i++){id=$("#contenu_etape :input")[i].id;a_stocker[id]=$("#contenu_etape :input")[i].value.trim()}stocker("a_stocker",JSON.stringify(a_stocker));stocker("numero_etape",numero_etape)}}else{tout_est_ok=true}return tout_est_ok}function progression_initialisation(){reinit_init=numero_etape>0?'<img id="reset_param" onclick="reinitialiser_init()" alt="Recommencer" src="'+prefixe_image+'/img_reset.png" class="icone_param">':"";return'Bienvenue sur Sekooly <i><progress style="width: 60px;" value="'+numero_etape+'" max="'+nb_etapes+'"></progress>'+numero_etape+"/"+nb_etapes+"</i>"+reinit_init}function changer_contenu_etape(e){$("#contenu_etape")[0].innerHTML=e}function changer_texte_bouton(e){$("#bouton_suivant")[0].innerText=e}function reinitialiser_init(){confirmation=confirm("Êtes-vous sûr de réinitialiser toutes vos saisies et de revenir à l'étape 0 ?");if(confirmation){effacer("numero_etape");effacer("a_stocker");window.location.href=window.location.href}}function rendre_riche(e,i){ClassicEditor.create(document.querySelector('[id="'+e+'"]'),config_editor()).then(e=>{if(i){}})["catch"](e=>{console.error(e)})}function recuperer_html_saisie_riche(){return $("[contenteditable]")[0].innerHTML}function switch_side_bar(){ouvert=$(".sidebar.left")[0].isOpen;if(ouvert){fermer_side_bar()}else{ouvrir_side_bar()}}function switch_side_bar_top(){ouvert=$(".sidebar.top")[0].isOpen;if(ouvert){fermer_side_bar()}else{ouvrir_side_bar_top()}}function ouvrir_side_bar(){$(".sidebar.left")[0].style.display="block";$(".sidebar.left")[0].isOpen=true;$(".sidebar.left").trigger("sidebar:open")}function ouvrir_side_bar_top(){$(".sidebar.top")[0].style.display="block";$(".sidebar.top")[0].isOpen=true;$(".sidebar.top").trigger("sidebar:open")}function fermer_side_bar(){$(".sidebar.left")[0].style.display="none";$(".sidebar.left")[0].isOpen=false;$(".sidebar.left").trigger("sidebar:close");$(".sidebar.top")[0].style.display="none";$(".sidebar.top")[0].isOpen=false;$(".sidebar.top").trigger("sidebar:close")}function fermer_si_non_recherche(e){if(e.target.id!=="rechercher")fermer_side_bar()}function en_cours(){alert("Cette fonctionnalité est en cours de mise en place, merci de votre patience.")}function edt(){mon_type=recuperer("mon_type");if(mon_type==="Eleves"){recuperer_edt()}else{if(recuperer("dossier_chargé")||mon_type.includes("bis")){recuperer_edt()}else{choix_classe_edt()}}}function choix_classe_edt(){les_matieres=JSON.parse(recuperer("mes_matieres"));les_classes=valeursUniquesDeCetteKey(les_matieres,"Classe");les_classes.sort();elements_html="Classe:<select id='classe_edt'>";for(i=0;i<les_classes.length;i++){elements_html+='<option value="'+les_classes[i]+'">'+les_classes[i]+"</option>"}elements_html+="</select>";creer_mini_popup("Choisissez la classe à consulter",elements_html,"Voir l'emploi du temps","voir_edt_classe_choisie()");var e=JSON.parse(recuperer("mes_donnees"))["Droits_modifs"];if(recuperer("mon_type").includes("Admin")&&e==="oui"){$("#ask_edt").remove();$("#mini_popup").append('<div id="ask_edt">'+bouton_demander()+"</div></div>")}}function bouton_demander(){return data_etablissement["edt_envoi_mail"]?edt_deja_envoye():'<button id="bouton_ask_edt" onclick="demander_edt()" class="demander_edt">Demander l\'édition des emplois du temps</button>'}async function demander_edt(){if(!data_etablissement["edt_envoi_mail"]){var e=await rechercher_tout("Classes");liste_classes=e.map(e=>e["cycle"]+" "+e["Classe"]);liste_id_calendar=e.map(e=>e["id_googlecalendar"]);var i=await chercher_lien_script(1);i+="?ask_edt=true";i+="&nom_prenom_responsable="+data_etablissement["identite_responsable"];i+="&liste_classes="+JSON.stringify(liste_classes);i+="&liste_id_calendar="+JSON.stringify(liste_id_calendar);i+="&contact_etablissement="+data_etablissement["contact_etablissement"];i+="&nom_etablissement="+data_etablissement["nom_etablissement"];envoyer_mail=get_resultat_asynchrone(i);data_etablissement["edt_envoi_mail"]=true;$("#ask_edt")[0].innerHTML=edt_deja_envoye()}else{$("#ask_edt")[0].innerHTML=edt_deja_envoye()}}function edt_deja_envoye(){return"<vert>✔La liste des liens pour éditer les emplois du temps a été envoyée par mail (<b>"+data_etablissement["contact_etablissement"]+"</b>).</vert><br><br><i>Si vous n'avez plus accès à cette adresse mail, merci de mettre à jour l'adresse mail de votre établissement dans <b>Paramètres > Infos établissement > Contact de l'Administration</b>, puis re-demandez à nouveau ici votre liste.</i>"}function voir_edt_classe_choisie(){recuperer_edt($("#classe_edt")[0].value);$("#mini_popup")[0].style.zIndex=2}function ma_journee(){vider_fenetre("Ma journée");var e=recuperer("mon_type")==="Eleves";var i=e?section_journee("Fichiers"):"";var i=section_journee("Fichiers","Les fichiers affichés ont pour <b>date d'effet</b> (donc de consultation) la date de la journée choisie.");i+=section_journee("Devoirs","Les devoirs affichés ont pour <b>date limite de rendu</b> la date de la journée choisie.");i+=section_journee("Discussions","Les discussions affichées ont pour <b>date de publication</b> la date de la journée choisie.");var r='<div id="menu_journee_haut" style="text-align: center;" class="menu_haut">Date de la journée: <input type="date" id="date_journee" class="date_effet_fichier"></div><div class="section_journee">'+i+"</div>";$("#menu_journee_haut").remove();$(".section_journee").remove();$("#fenetre").append(r);$("#date_journee").on("change",maj_date_journee);$("#date_journee")[0].value=moment().format("YYYY-MM-DD");maj_date_journee();afficher_fenetre(true)}function section_journee(e,i){return'<div id="section_'+e+'" class="titre_section_journee bloc_topic"><span style="font-size: x-large;padding: 5px;">'+e+'<div class="subtitle">'+i+"</div></span></div>"}function maj_date_journee(){if($("#date_journee")[0].value==="")$("#date_journee")[0].value=moment().format("YYYY-MM-DD");chargement(true);$(".alerte_section_journee").remove();$(".contenu_section_journee").remove();mes_matieres=JSON.parse(recuperer("mes_matieres"));if(!recuperer("mon_type").includes("Admin")){les_id_dossier_classe='("'+mes_matieres.map(e=>e["ID_URL"]).join('","')+'")';url=racine_data+"Fichiers?"+apikey;url+="&categorie_fichier=neq.Devoirs";url+="&categorie_fichier=neq.Examens";url+="&date_effet=eq."+$("#date_journee")[0].value;url+="&id_dossier=in."+les_id_dossier_classe}else{url=racine_data+"Fichiers?"+apikey;url+="&categorie_fichier=neq.Devoirs";url+="&categorie_fichier=neq.Examens";url+="&date_effet=eq."+$("#date_journee")[0].value}url+="&order=date_effet.asc,heure_effet.asc,id_dossier.asc";resultats=get_resultat(url);traiter_section(mes_matieres,"Fichiers",resultats,"date_effet","heure_effet","id_dossier","nom_fichier","id_fichier","fichier");if(!recuperer("mon_type").includes("Admin")){les_id_dossier_classe='("'+mes_matieres.map(e=>e["ID_URL"]).join('","')+'")';url=racine_data+"Fichiers?"+apikey;url+='&categorie_fichier=in.("Devoirs","Examens")';url+="&la_date_limite=eq."+$("#date_journee")[0].value;url+="&id_dossier=in."+les_id_dossier_classe}else{url=racine_data+"Fichiers?"+apikey;url+='&categorie_fichier=in.("Devoirs","Examens")';url+="&la_date_limite=eq."+$("#date_journee")[0].value}url+="&order=la_date_limite.asc,lheure_limite.asc,id_dossier.asc";resultats=get_resultat(url);traiter_section(mes_matieres,"Devoirs",resultats,"la_date_limite","lheure_limite","id_dossier","nom_fichier","id_fichier","devoir",true);if(!recuperer("mon_type").includes("Admin")){url=racine_data+"Topic?"+apikey;url+="&Horodateur=like."+$("#date_journee")[0].value+"*";url+="&Id_classe_matiere=in."+les_id_dossier_classe}else{url=racine_data+"Topic?"+apikey;url+="&Horodateur=like."+$("#date_journee")[0].value+"*"}url+="&order=Horodateur.asc";resultats=get_resultat(url);traiter_section(mes_matieres,"Discussions",resultats,"Horodateur","Horodateur","Id_classe_matiere","Titre","Id_topic","discussion",false,true);chargement(false)}function traiter_section(i,e,r,t,n,a,s,o,_,l,c){if(r.length===0){$("#section_"+e).append(aucun_element_section())}else{$("#section_"+e).innerHTML="";if(recuperer("mon_type").includes("Admin")){r=r.filter(e=>JSON.stringify(i).includes(e[a]))}for(var u=0;u<r.length;u++){id_classe_matiere=r[u][a];if(id_classe_matiere!=="pp"){nom_classe=i.filter(e=>e["ID_URL"]===id_classe_matiere)[0]["Classe"];nom_matiere=i.filter(e=>e["ID_URL"]===id_classe_matiere)[0]["Matiere"];nom_fichier=r[u][s];if(!recuperer("mon_type").includes("Eleves"))nom_matiere=nom_classe+" - "+nom_matiere;date_reference=r[u][t];heure_reference=r[u][n];if(date_reference===heure_reference&&date_reference.length>0){if(!c){date_reference=date_reference.split(" ")[0];heure_reference=heure_reference.split(" ")[1].split(".")[0]}}champ_id=r[u][o];if(l){deja_rendu=false;deja_corrigé=false;if(recuperer("mon_type")==="Eleves"){url=racine_data+"Rendus?proprietaire=eq."+recuperer("identifiant_courant").toLowerCase();url+="&id_fichier_sujetdevoir=eq."+champ_id;url+="&"+apikey;deja_rendu=get_resultat(url).length>0}else if(recuperer("mon_type")==="Profs"||recuperer("mon_type").includes("Admin")){url=racine_data+"Rendus?id_fichier_sujetdevoir=eq."+champ_id;url+="&"+apikey;rendus_recus=get_resultat(url);nb_corrigés=rendus_recus.filter(e=>e["remarque"]!=="").length;deja_corrigé=rendus_recus.length>0?'<progress style="width: 60px;" value="'+nb_corrigés+'" max="'+rendus_recus.length+'"></progress> <b><rouge>'+nb_corrigés+"/"+rendus_recus.length+"</rouge></b>":false}dejà_traité=deja_rendu||deja_corrigé}else{dejà_traité=false}element_journee=creer_element_journee(nom_matiere,nom_fichier,date_reference,heure_reference,champ_id,id_classe_matiere,_,dejà_traité,l,c);$("#section_"+e).append(element_journee)}}}ordonner_elements(".contenu_section_journee","innerText")}function creer_element_journee(e,i,r,t,n,a,s,o,_,l){if(t){t=" à "+t}else{t=""}if(recuperer("mon_type").includes("Eleves")){coche_traitement=o?'✅<i style="color: green;">Rendu</i>':_?"❌<i><rouge>Pas encore rendu</rouge></i>":""}else{coche_traitement=o?o:""}affichage_date=l?afficher_date(r):afficher_date(r,true)+t;return'<div class="contenu_section_journee"><b class="nom_matiere_journee sekooly-mode">'+e+"</b> "+i+'<i class="date_fin"> '+affichage_date+' </i><span class="mini-image deja_traite">'+coche_traitement+'</span> <img id="'+n+'" src="'+prefixe_image+'/img_previz.png" alt="voir" onclick="clic_de_notif(\''+s+"','"+n+"','"+a+'\');" class="mini-image"></div>'}function aucun_element_section(){return'<div class="alerte_section_journee">Aucun élément n\'a été trouvé pour la date choisie.</div>'}function mettre_les_soons(){if($("#soon").length===0){$("[soon]").append(soon())}}function soon(){return'<rouge id="soon">BIENTÔT</rouge>'}function tableau_de_bord(){var e=maintenant();vider_fenetre('<span id="titre-tdb">Tableau de bord - '+afficher_date(e)+"</span>"+bouton_actualiser("tdb_tout_actualiser()",20));$("#fenetre").append('<div id="previsualisation" style="width: 100%;height: 85%;overflow-y:auto;text-align: center;"></div>');var i=recuperer("mon_type").split("_")[0];elements_tdb=i==="Eleves"?["Présence sur la plateforme","Devoirs rendus","Participations","Fichiers à consulter"]:i==="Profs"?["Présence sur la plateforme","Devoirs corrigés","Participations","Fichiers en ligne"]:i.includes("Admin")?["Présence sur la plateforme","Devoirs rendus et corrigés","Participations","Fichiers en ligne"]:[];for(compteur=1;compteur<=elements_tdb.length;compteur++){bouton_voir_details=compteur!==1?bouton_details(compteur):"";$("#previsualisation").append("<span class='element_tdb'><div class='element_tdb_titre'>"+elements_tdb[compteur-1]+bouton_actualiser(fonction_actualiser_du_tdb(compteur,e),15)+bouton_voir_details+"</div><div id='tdb-"+compteur+"' class='graphe_tdb'  style='width:99.9%; height:94%;'></div></span>")}tdb_tout_actualiser(e);afficher_fenetre(true)}function fonction_actualiser_du_tdb(e,i){resultat=e===1?"tdb_recuperer_mes_connexions(false,'"+i+"')":e===2?"tdb_recuperer_devoirs(false,'"+i+"')":e===3?"tdb_recuperer_participations(false,'"+i+"')":e===4?"tdb_recuperer_fichiers_a_consulter(false,'"+i+"')":"";return resultat}function bouton_details(e){return'<span style="padding-left: 10px;"><span onclick="details_tdb_'+e+'(this)" style="width: 15px; cursor: pointer;" class="voir_tdb">Voir les détails</span></span>'}function bouton_actualiser(e,i){return'<span style="padding-left: 10px;"><img alt="actualiser" src="'+prefixe_image+'/img_actualiser.png" onclick="'+e+'" style="width: '+i+'px; cursor: pointer;"></span>'}function tdb_tout_actualiser(){chargement(true);$("#titre-tdb")[0].innerText="Tableau de bord - "+afficher_date(maintenant());aujourdhui=maintenant();tdb_recuperer_mes_connexions(true,aujourdhui);tdb_recuperer_devoirs(true,aujourdhui);tdb_recuperer_participations(true,aujourdhui);tdb_recuperer_fichiers_a_consulter(true,aujourdhui);chargement(false)}function tdb_recuperer_mes_connexions(e,i){const r=document.getElementById("tdb-1");r.innerHTML="";var t=["Connexion","Deconnexion","Code","La","Frais"];var n=["Connexion","Deconnexion","Code erroné","Maintenance","Frais non payés"];var a=[];var s=racine_data+"Logs?Identifiant=eq."+recuperer("identifiant_courant")+"&"+apikey;var o=get_resultat(s);les_12_mois=les_12_derniers_mois_en_intervalles_semaines(i);var _=les_12_mois.map(e=>"semaine du "+e.split(" ")[0]);t.forEach(function(r,e){les_12_mois.forEach(function(e,i){debut=moment(e.split(" ")[0]);fin=moment(e.split(" ")[1]);logs_avec_ce_statut=o.filter(e=>e["Statut"].split(" ")[0]===r&&moment(e["Horodateur"]).isBetween(debut,fin,"day","(]"));a.push({[r]:{[e]:logs_avec_ce_statut.length}})})});mes_series_finales=[];t.forEach(function(i,e){mes_series_finales.push({name:n[e],data:a.filter(e=>e[i]).map(e=>e[i]).map(e=>Object.values(e)[0]),spline:true})});creer_chart(1,mes_series_finales,_,"Evolution des tentatives de connexions");return mes_series_finales;if(!e)chargement(false)}function tdb_recuperer_devoirs(e,i){document.getElementById("tdb-2").innerHTML="";t=JSON.parse(recuperer("mes_matieres"));les_id_dossier_classe='("'+t.map(e=>e["ID_URL"]).join('","')+'")';if(!recuperer("mon_type").includes("Admin")){s=racine_data+"Fichiers?"+apikey;s+="&categorie_fichier=in.(Devoirs,Examens,Quiz)";s+="&id_dossier=in."+les_id_dossier_classe}else{s=racine_data+"Fichiers?"+apikey;s+="&categorie_fichier=in.(Devoirs,Examens,Quiz)"}s+="&order=date_effet.asc,heure_effet.asc,id_dossier.asc";mes_devoirs_a_faire=get_resultat(s);mes_devoirs_a_faire=mes_devoirs_a_faire.filter(e=>les_id_dossier_classe.includes(e["id_dossier"]));mon_type=recuperer("mon_type");le_proprietaire=mon_type.includes("Admin")||mon_type.includes("Prof")?"":"proprietaire=eq."+recuperer("identifiant_courant");le_titre_moyen=mon_type.includes("Admin")||mon_type.includes("Prof")?"moyen":"";details_rendus=mon_type.includes("Admin")||mon_type.includes("Prof")?"":mes_devoirs_rendus.length+" devoirs rendus sur "+mes_devoirs_a_faire.length;s=racine_data+"Rendus?"+le_proprietaire+"&"+apikey;mes_devoirs_rendus=get_resultat(s);mes_devoirs_rendus=mes_devoirs_rendus.filter(function(e){return les_id_dossier_classe.includes(e["id_dossier_sujetdevoir"])&&e["date_publication"]!==null});var r=0;if(mon_type.includes("Eleves")){r=100*mes_devoirs_rendus.length/mes_devoirs_a_faire.length}else{var t=JSON.parse(recuperer("mes_matieres"));var n=valeursUniquesDeCetteKey(t,"Classe");var a=JSON.parse(recuperer("mes_donnees"))["Cycle"];var s=racine_data+"Eleves?Cycle=eq."+a+"&"+apikey;tous_les_eleves_de_mon_cycle=get_resultat(s);var o=tous_les_eleves_de_mon_cycle.length;nb_total_rendus_attendus=0;var _=[];mes_devoirs_a_faire.forEach(function(i,e){nom_classe_du_devoir=t.find(e=>e["ID_URL"]===i["id_dossier"])["Classe"];o=tous_les_eleves_de_mon_cycle.filter(e=>e["Classe"]===nom_classe_du_devoir).length;nb_rendus_ce_devoir=mes_devoirs_rendus.filter(e=>e["id_fichier_sujetdevoir"]===i["id_fichier"]).length;taux_actuel=100*nb_rendus_ce_devoir/o;if(!taux_actuel)taux_actuel=0;nb_total_rendus_attendus+=o;_.push(taux_actuel)});r=_.length>0?_.reduce((e,i)=>e+i)/_.length:0;details_rendus=mes_devoirs_rendus.length+" rendus sur "+nb_total_rendus_attendus+" attendus"}mes_series=[{name:"Taux de rendu",data:[r]}];creer_chart(2,mes_series,null,"Taux de rendu "+le_titre_moyen+" ("+parseFloat(r.toFixed(2))+"%) "+details_rendus);if(!e)chargement(false)}function details_tdb_2(e){elements_html="";var r="";mes_devoirs_a_faire.forEach(function(i,e){if(recuperer("mon_type")==="Eleves"){dejà_traité=mes_devoirs_rendus.filter(e=>e["id_fichier_sujetdevoir"]===i["id_fichier"]).length>0;nom_classe_du_devoir="";r="Devoirs à faire"}else{nb_corrigés=mes_devoirs_rendus.filter(e=>e["id_fichier_sujetdevoir"]===i["id_fichier"]&&e["remarque"]).length;nb_rendus=mes_devoirs_rendus.filter(e=>e["id_fichier_sujetdevoir"]===i["id_fichier"]).length;mes_matieres=JSON.parse(recuperer("mes_matieres"));nom_classe_du_devoir=mes_matieres.find(e=>e["ID_URL"]===i["id_dossier"])["Classe"]+" ";nb_eleves=tous_les_eleves_de_mon_cycle.filter(e=>e["Classe"]===nom_classe_du_devoir.trim()).length;dejà_traité=mes_devoirs_rendus.length>0?'<progress style="width: 60px;" value="'+nb_corrigés+'" max="'+nb_rendus+'"></progress> <b><rouge>'+nb_corrigés+" corrigés sur "+nb_rendus+" rendus, sur "+nb_eleves+" élèves</rouge></b>":false;nom_classe_du_devoir=nom_classe_du_devoir+" ";r="Devoirs à faire et corriger"}nom_matiere=nom_classe_du_devoir+JSON.parse(recuperer("mes_matieres")).filter(e=>e["ID_URL"]===i["id_dossier"])[0]["Matiere"];elements_html=elements_html+creer_element_journee(nom_matiere,i["nom_fichier"],i["la_date_limite"],i["lheure_limite"],i["id_fichier"],i["id_dossier"],"devoir",dejà_traité,true)});if(!r)r="Devoirs à faire";creer_mini_popup(r,elements_html,"    OK    ","$('#mini_popup').remove();",null,null,null,null,25);$("#mini_popup")[0].style.overflow="auto"}function tdb_recuperer_participations(e,i){document.getElementById("tdb-3").innerHTML="";url=racine_data+"Topic?Identifiant=eq."+recuperer("identifiant_courant")+"&"+apikey;mes_discussions=get_resultat(url);url=racine_data+"Coms?Identifiant=eq."+recuperer("identifiant_courant")+"&"+apikey;mes_coms=get_resultat(url);url=racine_data+"Visio?Statut=eq.debut&Identifiant=eq."+recuperer("identifiant_courant")+"&"+apikey;mes_visios=get_resultat(url);var r=["Discussions créées","Commentaires envoyées","Clics sur visioconférence"];var t=[{name:"Nombre total",data:[mes_discussions.length,mes_coms.length,mes_visios.length]}];creer_chart(3,t,r,"Total des intéractions");if(!e)chargement(false)}function details_tdb_3(e){var r="";var t=JSON.parse(recuperer("mes_matieres"));r+='<br><br><b><div style="background: #bf8a6a;"> MES DISCUSSIONS </div></b><br>';mes_discussions.forEach(function(i,e){la_matiere=t.find(e=>e["ID_URL"]===i["Id_classe_matiere"]);nom_matiere=la_matiere?la_matiere["Classe"]+" "+la_matiere["Matiere"]:"Matière inconnue";r+=creer_element_journee(nom_matiere,i["Votre_message"],i["Horodateur"],i["Horodateur"],i["Id_topic"],i["Id_classe_matiere"],"discussion",false,false,true)});r+='<br><br><b><div style="background: #bf8a6a;"> MES COMMENTAIRES </div></b><br>';liste_id_topics="("+mes_coms.map(e=>e["Id_topic"]).join(",")+")";url=racine_data+"Topic?Id_topic=in."+liste_id_topics+"&order=Horodateur.asc"+"&"+apikey;liste_id_classe_matieres_des_coms=get_resultat(url);mes_coms.forEach(function(i,e){le_topic_source=liste_id_classe_matieres_des_coms.find(e=>e["Id_topic"]===i["Id_topic"]);id_classe_matiere=le_topic_source["Id_classe_matiere"];la_matiere=t.find(e=>e["ID_URL"]===id_classe_matiere);nom_matiere=la_matiere?la_matiere["Classe"]+" "+la_matiere["Matiere"]:"Matière inconnue";r+=creer_element_journee(nom_matiere,i["Votre_commentaire"],i["Horodateur"],i["Horodateur"],i["Id_topic"],id_classe_matiere,"discussion",false,false,true)});creer_mini_popup("Discussions et commentaires",r,"    OK    ","$('#mini_popup').remove();",null,null,null,null,25);$("#mini_popup")[0].style.overflow="auto"}async function tdb_recuperer_fichiers_a_consulter(e,i){document.getElementById("tdb-4").innerHTML="";mes_fichiers=await recuperer_mes_fichiers(true);mes_series=[];categories_de_fichiers=valeursUniquesDeCetteKey(mes_fichiers,"categorie_fichier");categories_de_fichiers.forEach(function(i,e){part_de_la_categ=mes_fichiers.filter(e=>e["categorie_fichier"]===i).length/mes_fichiers.length;mes_series.push({name:i,data:part_de_la_categ})});creer_chart(4,mes_series,null,"Part des catégories sur "+mes_fichiers.length+" fichiers");if(!e)chargement(false)}function recuperer_mes_fichiers_old(e){if(e||!recuperer("mes_fichiers")){var i=JSON.parse(recuperer("mes_matieres"));var r='("'+i.map(e=>e["ID_URL"]).join('","')+'")';if(!recuperer("mon_type").includes("Admin")){url=racine_data+"Fichiers_tout?"+apikey;url+="&id_dossier=in."+r}else{url=racine_data+"Fichiers_tout?"+apikey}url+="&order=date_effet.asc,heure_effet.asc,id_dossier.asc";mes_fichiers=get_resultat(url);mes_fichiers=mes_fichiers.filter(e=>r.includes(e["id_dossier"]));return mes_fichiers}else{return JSON.parse(recuperer("mes_fichiers"))}}async function recuperer_mes_fichiers(e){if(e||!recuperer("mes_fichiers")){var i=JSON.parse(recuperer("mes_matieres"));var r="'"+i.map(e=>e["ID_URL"]).join(",")+"'";nom_table='"Fichiers_tout"';url=nom_table;if(!recuperer("mon_type").includes("Admin")){url+="  WHERE "+r+" ~ id_dossier"}return rechercher_tout(url,true).then(function(e){e=e.filter(e=>r.includes(e["id_dossier"]));return e})}else{return JSON.parse(recuperer("mes_fichiers"))}}function details_tdb_4(e){var r="";var t=JSON.parse(recuperer("mes_matieres"));var n=recuperer("mon_type").split("_")[0];mes_fichiers.forEach(function(e,i){id_classe_matiere=e["id_dossier"];nom_classe=n==="Eleves"?"":t.filter(e=>e["ID_URL"]===id_classe_matiere)[0]["Classe"]+" ";nom_matiere=t.filter(e=>e["ID_URL"]===id_classe_matiere)[0]["Matiere"]+" ("+e["categorie_fichier"]+")";r+=creer_element_journee(nom_classe+nom_matiere,e["nom_fichier"],e["date_effet"],e["heure_effet"],e["id_fichier"],id_classe_matiere,"fichier",false,false,false)});creer_mini_popup("Fichiers en ligne",r,"    OK    ","$('#mini_popup').remove();",null,null,null,null,25);$("#mini_popup")[0].style.overflow="auto"}function creer_chart(e,i,r,t){const n=document.getElementById("tdb-"+e);mes_series_finales=i;if(e===1){reduction=reduire_serie(i,r);r=reduction[0];mes_series_finales=reduction[1]}else{r=r;mes_series_finales=i}const a={categories:r,series:mes_series_finales};var s={chart:{width:"auto",height:"auto"}};if(t)s["chart"]["title"]=t;if(e===1){s["xAxis"]={pointOnColumn:true,title:{text:"Période"}};s["yAxis"]={title:"Nombre de tentatives de connexions"};const o=toastui.Chart.areaChart({el:n,data:a,options:s})}else if(e===3){s["series"]={dataLabels:{fontFamily:"Arial",fontSize:13,fontWeight:500,color:"#FF6C00",textBubble:{visible:true,arrow:{visible:true}}},stack:{type:"normal"}};const o=toastui.Chart.barChart({el:n,data:a,options:s})}else if(e===4){s["series"]={dataLabels:{visible:true,pieSeriesName:{visible:true}}};const o=toastui.Chart.pieChart({el:n,data:a,options:s})}else{s["circularAxis"]={scale:{min:0,max:100},title:"%"};s["series"]={angleRange:{start:270,end:90}};s["plot"]={bands:[{range:[0,20],color:"#df5353"},{range:[20,50],color:"#dddf0d"},{range:[50,100],color:"#55bf3b"}]};s["theme"]={plot:{bands:{barWidth:50}}};const o=toastui.Chart.gaugeChart({el:n,data:a,options:s})}return s}function reduire_serie(r,e){mes_series_finales=r;var i=(e,r)=>e.map((e,i)=>r[i]+e);somme_series=r.map(e=>e["data"]).reduce(i);var t=somme_series.findIndex(e=>e)-1;if(t){e=e.slice(t);r.forEach(function(e,i){mes_series_finales[i]["data"]=r[i]["data"].slice(t)})}return[e,mes_series_finales]}function conseils_de_classe(){en_cours()}function remediations(){en_cours()}function langues(){en_cours()}function afficher_choix_extrait_manuel(e){element_DOM("extrait_manuel").style.display=e?"":"none"}function les_manuels_de_la_matiere(){resultat="";for(i=0;i<$("#drive_manuels > .span_un_fichier").length;i++){resultat+='<option value="'+$("#drive_manuels > .span_un_fichier")[i].id+'">'+$("#drive_manuels > .span_un_fichier")[i].innerText+"</option>"}return resultat}function afficher_checkbox(e,i){element_DOM(e).style.display=i?"":"none"}function switch_extrait_manuel(){var e=element_DOM("est_extrait_manuel").checked;element_DOM("manuel_choisi").value="";element_DOM("manuel_choisi").innerHTML='<option value="--">--</option>'+les_manuels_de_la_matiere();element_DOM("manuel_choisi").style.display=e?"":"none";afficher_choix_extrait_manuel(e);afficher_checkbox("choix_youtube",!e);afficher_choix_fichier(!e);if(e){$("#manuel_choisi").on("change",function(e){e.preventDefault();if(e.target.value==="--")return true;numeros_pages_str=prompt("Choisissez les numéros de pages (séparés de virgules et SANS ESPACES):","1,2,3");if(!numeros_pages_str){e.target.value="--";element_DOM("file").value="";element_DOM("file").style.display="none";return true}numeros_pages=numeros_pages_str.split(",").map(e=>Number(e));var i="https://www.googleapis.com/drive/v2/files/"+e.target.value+"?key="+google_api_file_access+"&alt=media&source=downloadUrl";var r=$("#manuel_choisi option:selected").text().split(".").pop();var t=$("#manuel_choisi option:selected").text().replace("."+r," (page "+numeros_pages_str+").png");visualiser("","","",t,false,false,true);$("#entete-fenetre")[0].style.display="none";chargement(true);var n=document.getElementById("previsualisation");n.style["float"]="left";n.style.overflow="scroll";n.style.textAlign="center";n.style.height="80%";n.style.maxWidth="100%";render_ces_pages(n,i,numeros_pages)});$("#mettre_fichier_en_ligne").on("click",function(e){if(!pre_validation("manuel_choisi")){}else{$("#file").change()}})}else{$("#mettre_fichier_en_ligne").off("click")}}function render_ces_pages(r,e,t){r.innerHTML="";var i=pdfjsLib.getDocument(e);i.promise.then(function(e){t.forEach(function(i){if(i<=e._pdfInfo.numPages){e.getPage(i).then(function(e){chargement(true);renderPage(r,e,i).then(function(){if(i===t[t.length-1]){$("#choix_pages_pdf").remove();var e='<div id="choix_pages_pdf" style="text-align: center;" class=""><rouge>Voici les pages que vous avez choisies. Voulez-vous valider ou annuler?</rouge><button class="mon_bouton sekooly-mode-background" onclick="annuler_mon_choix()">Annuler</button><button class="mon_bouton sekooly-mode-background" onclick="choisir_ces_pages(\''+t.toString()+"')\">Valider</button></div>";$("#fenetre").append(e);chargement(false)}})})}else{alert("Page "+i+" introuvable.")}})})}function choisir_ces_pages(e){numeros_pages=e.toString().split(",");mes_cnv=$("canvas");resultat=rendre_canvas_vertical(mes_cnv);image_temporaire=resultat;nom_image_temporaire=$("#titre_fenetre")[0].innerText;$("#nom_fichier_extrait")[0].innerText=$("#titre_fenetre")[0].innerText;$("#file").change();quitter_previsualisation()}function annuler_mon_choix(){$("#manuel_choisi")[0].value="--";quitter_previsualisation()}function rendre_canvas_vertical(e){try{somme_des_hauteurs=0;liste_des_canvas_avec_position=[];for(i=0;i<e.length;i++){somme_des_hauteurs+=e[i].height;valeur_y=i===0?0:e[i-1].height*i;liste_des_canvas_avec_position.push({cnv:e[i],y:valeur_y})}var r=document.createElement("canvas"),t=r.getContext("2d"),n=e[0].width,a=somme_des_hauteurs;r.width=n;r.height=a;liste_des_canvas_avec_position.forEach(function(e){t.beginPath();t.drawImage(e.cnv,0,e.y,n,e.cnv.height)});return r.toDataURL()}catch(s){alert("Impossible de choisir les pages.");return false}}function verticalCanvases(e,i,r){var t=document.createElement("canvas"),n=t.getContext("2d"),a=e.width,s=e.height+i.height+r.height;t.width=a;t.height=s;[{cnv:e,y:0},{cnv:i,y:e.height},{cnv:r,y:e.height+i.height}].forEach(function(e){n.beginPath();n.drawImage(e.cnv,0,e.y,a,e.cnv.height)});return t.toDataURL()}async function renderPage(e,i,r){var t=1.25;var n=i.getViewport({scale:t});var a=document.createElement("canvas");a.id=$("#titre_fenetre")[0].innerText+"-"+r;e.appendChild(a);var s=a.getContext("2d");a.height=n.height;a.width=n.width;1;var o={canvasContext:s,viewport:n};return i.render(o)}function renderPDF(e,i){var i=i||{scale:1};pdfjsLib.disableWorker=true;var r=pdfjsLib.getDocument(e);r.promise.then(renderPages)}function canva_scrollable(e){var t=document.getElementById(e);var i=t.getContext("2d");var n=false;var a;var s=0;for(var r=0;r<1e3;r++){i.beginPath();i.arc(Math.random()*1e4,Math.random()*250,20,0,2*Math.PI,false);i.stroke()}t.addEventListener("mousedown",function(e){var i=e||event;n=true;a=i.clientX;e.preventDefault()},false);window.addEventListener("mousemove",function(e){var i=e||event;if(n){var r=i.clientX-a;a=i.clientX;s+=r;t.style.marginLeft=s+"px"}e.preventDefault()},false);window.addEventListener("mouseup",function(){n=false},false)}let deferredPrompt;const addBtn=$("#a2hs")[0];window.addEventListener("beforeinstallprompt",e=>{e.preventDefault();deferredPrompt=e;addBtn.style.display="block";$("#mynavbar")[0].style.top="20px";$(".alerte#alerte")[0].style.top="95px";if($("#alerte_vide")[0])$("#alerte_vide")[0].style.top="100px"});function ajouter_a_laccueil(){$("#a2hs")[0].style.display="none";$("#mynavbar")[0].style.top="";$(".alerte#alerte")[0].style.top="";deferredPrompt.prompt();deferredPrompt.userChoice.then(e=>{if(e.outcome==="accepted"){console.log("Accepté.")}else{console.log("Refusé.")}deferredPrompt=null})}if("serviceWorker"in navigator){window.addEventListener("load",function(){navigator.serviceWorker.register("../sw.js").then(function(e){},function(e){console.error("ServiceWorker registration failed: ",e)})})}function lien_pp(e){return e?"https://drive.google.com/uc?export=download&id="+e:prefixe_image+"/default-user.svg"}function recuperer_msgs(e,i){chargement(true);if(!i){vider_fenetre("");element_DOM("fenetre").innerHTML+=html_boutons_fenetre("recuperer_msgs(true)","ajouter_un_tout_nouveau_msg()","Pour répondre, cliquez sur le message en question.<br>"+alerte_conv())}else{}if(e||recuperer("mes_msgs")===null||recuperer("mes_msgs")===""){nom_table="Conversations";nom_champ_reference="id_conv";valeur_champ_reference="*"+ajouter_motif(recuperer("identifiant_courant"))+"*";nom_champ_a_chercher="";return rechercher_contenant_motif(nom_table,nom_champ_reference,valeur_champ_reference,nom_champ_a_chercher,"Horodateur","desc").then(e=>{stocker("mes_msgs",JSON.stringify(e));chargement(false);if(!i){return traitement_msgs()}else{return e}})["catch"](e=>{console.error(e);alert(e);alert("Impossible de récupérer vos messages. Vérifiez que vous êtes toujours connecté à internet, ou réessayer plus tard.");chargement(false);return false})}else{chargement(false);if(!i){return traitement_msgs()}else{return JSON.parse(recuperer("mes_msgs"))}}}function alerte_conv(){return""}function traitement_msgs(){afficher_fenetre(true);if(recuperer("mes_msgs").length===0||recuperer("mes_msgs")==="[]"){commentaire='<div id="vide" style="text-align: center;color: grey;margin: 10%;"> <i id="vide"> Vous n\'avez pas encore de messages privés.<br><br></i> </div>';var e=document.createElement("div");e.innerHTML=commentaire;while(e.firstChild){element_DOM("fenetre").appendChild(e.firstChild)}return commentaire}else{var i=JSON.parse(recuperer("mes_msgs"));if(!element_DOM("div_liste_msgs")){var r=document.createElement("div");r.style.overflowX="hidden";r.style.overflowY="auto";r.id="div_liste_msgs";r.style.height="90%";element_DOM("fenetre").appendChild(r)}else{var r=element_DOM("div_liste_msgs")}i.sort(function tri_ordre_chrono_decroissant(e,i){return convertir_en_date(i.Horodateur)-convertir_en_date(e.Horodateur)});i.forEach(function(e){ajouter_msg(i,r,e)});return i}}function ajouter_msg(e,i,r){var t=r["id_conv"];var n=e.filter(e=>e["id_conv"]===r["id_conv"]&&!liste_notifs_lues.includes(","+e["id_msg"]+",")).length;if($("[id='"+t+"']").length>0)return true;var a=recuperer_destinataire(r["id_conv"]);element_contenu=document.createElement("div");element_contenu.innerHTML=r["Message"];var s=element_contenu.innerText;var o=moment.max(e.filter(e=>e["id_conv"]===r["id_conv"]).map(e=>e.Horodateur).map(e=>moment(e))).format("DD/MM/YYY HH:mm");var _=afficher_date(o);var l=e.filter(e=>e["id_conv"]===r["id_conv"]).length;if(l===undefined)l=0;var c="";if(!recuperer("mon_type").includes("Administration")&&r["Identifiant"]!==recuperer("identifiant_courant").trim())c="";var u=ma_photo(a.toLowerCase(),true);var d=n>0?'<div class="msg_non_lu">'+n+"</div>":"";var m='<ul class="bloc_msg" onclick="clic_de_msg(this.id)" id="'+t+'"> '+u+'<span id="details_conv">'+c+' <p id="'+t+'" style="font-size: 25px; margin:0px;"> <b class="contenu_question sekooly-mode" id="'+t+'"> '+a+'  </b> <p id="'+t+'" class="contenu_question"> '+s+'</p><i class="petite_ecriture"> <h id="'+t+'"><u id="'+t+'"> Nombre de messages</u>: <u class="nb_com_actuel" id="'+t+'">'+l+'</u> </h> <h id="'+t+'">  &emsp; <u id="'+t+'"> Dernier message le</u>: '+_+' </h><h id="'+t+'"></h></i></span> '+d+" </ul>";var f=document.createElement("div");f.innerHTML+=m;while(f.firstChild)i.appendChild(f.firstChild)}function clic_de_msg(e){chargement(true);stocker("msg_chargé",e);recuperer_tous_les_msgs(e,false);chargement(false)}function recuperer_tous_les_msgs(i,e){var r=JSON.parse(recuperer("mes_msgs"));r=r.sort(function tri_ordre_chrono_decroissant(e,i){return convertir_en_date(e.Horodateur)-convertir_en_date(i.Horodateur)});var t=r.find(e=>e["id_conv"].includes(i))["id_conv"];t=recuperer_destinataire(t);try{var n=$("[id='pp_"+t.toLowerCase()+"']")[0].src}catch(l){var n=$("#entete_convo > .retour_msgs")[1].src}var a='<span id="entete_convo"><img id="<<" class="retour_msgs" src="'+prefixe_image+'/img_retour.png" onclick="recuperer_msgs(true)"> <img class="retour_msgs" src="'+n+'"><div id="Destinataire" class="titre_du_poste sekooly-mode">'+t+"</div></span>";$("#div_liste_msgs").remove();vider_fenetre(a);var s='<div id="emplacement_des_msgs" class="emplacement_des_msgs"></div>';var o=document.createElement("div");o.innerHTML=s;element_DOM("fenetre").appendChild(o.firstChild);r=r.filter(e=>e["id_conv"]===i);var _="<div id='conversation' class='conversation'>";r.forEach(function(e){msg_html=afficher_msg_conversation(e);_+=msg_html;jai_lu(e["id_msg"],false)});apres_maj_lecture_notifs();afficher_bulle_notifs();$("#emplacement_des_msgs").append(_);le_dernier_msg=r[r.length-1];element_DOM(le_dernier_msg["id_msg"]).scrollIntoView();$("#fenetre").append(zone_envoi(i))}function zone_envoi(e){return'<div id="nouveau_msg_convo"><textarea id="Message" name="Message" placeholder="Ecrivez votre message..."></textarea><button class="bouton_envoi sekooly-mode-background" onclick="envoyer_mon_message(\''+e+'\')"><img alt="Envoyer" class="pp" src="'+prefixe_image+'/img_send.png" style="width: 30px;height: 30px;filter: invert(1);"></button></div>'}function afficher_msg_conversation(e){la_className="un_msg "+(e["Expediteur"]===recuperer("identifiant_courant")?"msg_envoye":"msg_recu");Expediteur=e["Expediteur"]===recuperer("identifiant_courant")?"MOI-MÊME":e["Expediteur"].toUpperCase();return'<div class="'+la_className+'" id="'+e["id_msg"]+'"><div class="auteur_du_poste sekooly-mode">'+Expediteur+'</div><h id="contenu_poste"><p data-placeholder="Votre commentaire...">'+e["Message"]+'</p></h><h class="date_poste">'+afficher_date(e["Horodateur"])+"</h></div>"}async function liste_de_mes_destinataires(){var e=recuperer("mon_type").split("_")[0];var i=await recuperer_eleves(true);var r=await recuperer_profs(true);var t=await recuperer_admin(true);var n=[];n.push(i);n.push(r);n.push(t);n=[].concat.apply([],n);n=n.map(function(e){le_type=e["type"].includes("Admin")?e["Role"]:e["type"].substring(0,e["type"].length-1);return e["Identifiant"].toUpperCase()+" ("+le_type+")"});stocker("mes_destinataires",n);return n}function ajouter_un_tout_nouveau_msg(){liste_de_mes_destinataires();var e=false;if(e){alert("Impossible d'envoyer un nouveau message pour le moment.");return-1}if(impossible_de_cliquer())return-1;vider_fenetre("Nouveau message");element_DOM("maquestion").src="";var i='<div id="mon_formulaire" autocomplete="off" class="edition"><label id="label" for="Destinataire">Destinataire: </label><div id="div_autocompletion" class="autocompletion"> <input placeholder="Tapez pour chercher le destinataire..." autocomplete="on" onkeyup="validation_par_touche(event)" oninput="faire_autocompletion_input(this,\'Destinataire\')" type="text" name="Destinataire" id="Destinataire" maxlength="50" style="width: 100%;"></div><br><br><label id="label" for="Message">Votre message: </label><textarea id="Message" name="Message" placeholder="Saisissez votre message..." maxlength="1700" style="width: 100%;height: 70%;resize: none;font-size: 13px;"></textarea><div id="nb_max_div" style="margin-left: 90%;margin-top: 0%;font-size: 10px; display:none;"> <font id="nb_max"> 0 / 1700</font> </div><div id="mes_boutons" style="text-align: center;padding: 1%;display: block ruby;"><button class="bouton_sekooly sekooly-mode-background" type="button" id="Annuler" onclick="recuperer_msgs(false)"> Annuler </button><button class="bouton_sekooly sekooly-mode-background" type="button" id="envoi" onclick="envoyer_mon_message()"> Envoyer le message </button></div><div id="msg_erreur" style="text-align: center;padding: 1%;color: green;"> </div></div>';var r=document.createElement("span");r.innerHTML=i;element_DOM("fenetre").appendChild(r);$("#div_autocompletion").append('<div id="liste_destinataires"></div>');element_DOM("Destinataire").focus()}function validation_par_touche(e){if(e.keyCode===13)choisir("Destinataire",$("#liste_destinataires")[0].firstChild)}function faire_autocompletion_input(e,i){if(!recuperer("mes_destinataires"))liste_de_mes_destinataires();var r=recuperer("mes_destinataires").split(",");var t=$("[id='"+i+"']")[0].value.toUpperCase().replaceAll(" ","");liste_destinataires.innerHTML="";if(t){r=r.filter(function(e){return e.toUpperCase().replaceAll(" ","").includes(t)});r.forEach(function(e){$("#liste_destinataires").append("<div onclick=\"choisir('"+i+'\',this)" value="'+e+'">'+e+"</div>")})}}function choisir(e,i){$("[id='"+e+"']")[0].value=i.getAttribute("value");liste_destinataires.innerHTML="";destinataire=i.getAttribute("value").toLowerCase().split(" (")[0];id_conv1=ajouter_motif(destinataire)+ajouter_motif(recuperer("identifiant_courant"));id_conv2=ajouter_motif(recuperer("identifiant_courant"))+ajouter_motif(destinataire);mes_msgs=JSON.parse(recuperer("mes_msgs"));conv_initiale=mes_msgs.find(e=>e["id_conv"]===id_conv1||e["id_conv"]===id_conv2);if(conv_initiale){id_conv=conv_initiale["id_conv"];charger_la_conv(id_conv)}}function charger_la_conv(i){recuperer_msgs(true).then(e=>$("ul[id='"+i+"']").click())}function le_destinataire(){return $("#Destinataire")[0].value||$("#Destinataire")[0].innerText}async function envoyer_mon_message(e){chargement(true);var i=e?true:false;if(!recuperer("mes_destinataires"))await liste_de_mes_destinataires();mes_destinataires=recuperer("mes_destinataires").split(",");var r=le_destinataire();if(!r||!mes_destinataires.find(e=>e.includes(r))){alert("Votre destinataire n'existe pas, merci de vérifier votre saisie.\nIl est possible que la personne ne soit plus inscrite sur la plateforme.");chargement(false);return false}var t=$("#Message")[0].value.replaceAll("\n","<br>").trim();if(t.length===0){alert("Merci de saisir un message avant de l'envoyer.");chargement(false);return false}var n=chercher_le_mot_interdit(t);if(n!==""){alert("Vous n'avez pas le droit d'utiliser le terme '"+n+"' dans le cadre des cours à "+nom_etablissement+" sur SEKOOLY.");return-1}r=r.split(" (")[0].toLowerCase();id_msg=creer_uuid();var a=e?e:create_id_conv(r,false);var s={Horodateur:maintenant(),Expediteur:recuperer("identifiant_courant"),Destinataire:r,Message:t,id_msg:id_msg,id_conv:a};ajouter_un_element("Conversations",s).then(function(e){if(i){$("#conversation").append(afficher_msg_conversation(s));element_DOM(id_msg).scrollIntoView();$("#Message")[0].value="";jai_lu(id_msg,true)}else{charger_la_conv(a)}chargement(false)})}function supprimer_conversation(e){id_convo=e.id.split("bye")[1];console.log(id_convo)}function recuperer_programme(){vider_fenetre("Programme scolaire");var e=JSON.parse(recuperer("mes_matieres"));var i=e.map(e=>e["ID_URL"]);e=e.map(e=>e["Classe"]+" "+e["Matiere"]);var r="";for(numero_matiere=0;numero_matiere<e.length;numero_matiere++){r+='<option value="'+i[numero_matiere]+'">'+e[numero_matiere]+"</option>"}var t='<div id="menu_programme" style="text-align: center;" class="menu_haut">Matière: <select id="ID_URL">'+r+"</select> </div>";$("#menu_programme").remove();$("#fenetre").append(t);$("#ID_URL").on("change",maj_matiere);maj_matiere();afficher_fenetre(true)}function maj_matiere(){chargement(true);var i=recuperer("mon_type")==="Eleves";var e=$("#ID_URL")[0].value;le_programme=donnees_programme(e);$("#programme_scolaire").remove();$(".conteneur_bouton_ajout_chapitre").remove();var r='<div id="programme_scolaire" class="programme_scolaire"></div>';$("#fenetre").append(r);if(!i){boutons_update_programme=liste_statuts(i)+bouton_renommer_chapitre()+bouton_supprimer_chapitre();bouton_ajouter_nouveau_chapitre='<img class="conteneur_bouton_ajout_chapitre image-en-haut-fenetre" onclick="ajouter_un_chapitre()" src="'+prefixe_image+'/img_ajout.png">'}else{boutons_update_programme="";bouton_ajouter_nouveau_chapitre=""}if(le_programme.length===0){$("#programme_scolaire").append('<div class="alerte_section_journee">Aucun chapitre n\'a été trouvé pour cette matière.</div>')}else{le_programme.forEach(function(e){if(i)boutons_update_programme=liste_statuts(true,e["etat"]);date_fin_chapitre=e["date_fin"]?'<div class="date_fin">le '+afficher_date(e["date_fin"])+"</div>":"";$("#programme_scolaire").append('<div class="un_chapitre" id="'+e["id_chapitre"]+'">\x3c!--<span class="titre_chapitre sekooly-mode position_chapitre " id="position_chapitre">'+e["position_chapitre"]+') </span>--\x3e<span class="titre_chapitre sekooly-mode" id="'+e["id_chapitre"]+'">'+e["intitule_chapitre"]+"</span>"+"<br>"+boutons_update_programme+date_fin_chapitre+"</div>");if(!i){$("[id='"+e["id_chapitre"]+"'] > select").val(e["etat"]);actualiser_couleurs($("[id='"+e["id_chapitre"]+"'] > select")[0])}});if(!i){$("#programme_scolaire").sortable({update:function t(){var e=[];$(".un_chapitre.ui-sortable-handle").each(function(e,i){nouvelle_position_chapitre_drag=e+1;modifier_chapitre(i.id,"position_chapitre",nouvelle_position_chapitre_drag,false)})}})}}if(bouton_ajouter_nouveau_chapitre){$("#menu_programme").append(bouton_ajouter_nouveau_chapitre)}chargement(false);return true}function nouvelle_position_chapitre(){var e=$(".titre_chapitre.position_chapitre").text().replaceAll(")","").split(" ").map(e=>Number(e));return Math.max.apply(Math,e)+1}function bouton_renommer_chapitre(){return'<img onclick="renommer_chapitre(this)" src="'+prefixe_image+'/img_edit.png" alt="Renommer" class="editer">'}function bouton_supprimer_chapitre(){return'<img onclick="supprimer_ce_chapitre(this)" src="'+prefixe_image+'/img_trash.png" alt="Supprimer" class="editer">'}function liste_statuts(e,i){if(!e){resultat=`
			<select class="etat_chapitre" onchange="changer_statut_chapitre(this)">
				<option value="Non commencé" id="Non commencé">Non commencé</option>
				<option value="En cours" id="En cours">En cours</option>
				<option value="Terminé" id="Terminé">Terminé</option>
				<option value="Annulé" id="Annulé">Annulé</option>  
			</select>
			`}else{resultat='<span style="background: '+couleur_de_letat(i)+';" class="etat_chapitre">'+i+"</span>"}return resultat}function couleur_de_letat(e){var i=e==="Non commencé"?"#848484":e==="En cours"?"#ffae59":e==="Terminé"?"#5d9140":e==="Annulé"?"#df756a":"";return i}async function ajouter_un_chapitre(){intitule_chapitre=prompt("Indiquez le nom du nouveau chapitre: ");if(!intitule_chapitre)return false;donnees_chapitre={id_chapitre:creer_uuid(),ID_URL:programme_ID_URL_actuel(),Classe_Matiere:programme_classe_matiere_actuel(),intitule_chapitre:intitule_chapitre,position_chapitre:nouvelle_position_chapitre(),etat:"Non commencé"};return await ajouter_un_element("Programme",donnees_chapitre).then(function(){maj_matiere();return donnees_chapitre})}function programme_ID_URL_actuel(){return $("#ID_URL")[0].value}function programme_classe_matiere_actuel(){return $("#ID_URL option:selected").text()}function donnees_programme(e){return get_resultat(racine_data+"Programme?ID_URL=eq."+e+"&order=position_chapitre.asc&"+apikey)}function renommer_chapitre(e){var i=le_id_chapitre(e);var r=$(".titre_chapitre[id='"+i+"']")[0].innerText;nouveau_nom=prompt("Indiquez le nouveau nom du chapitre: ",r);if(nouveau_nom&&nouveau_nom!==r)modifier_chapitre(i,"intitule_chapitre",nouveau_nom,maj_matiere)}function changer_statut_chapitre(e){actualiser_couleurs(e);var i=le_id_chapitre(e);modifier_chapitre(i,"etat",e.value);var r=e.value==="Terminé"||e.value==="Annulé"?maintenant():"";modifier_chapitre(i,"date_fin",r,maj_matiere)}function actualiser_couleurs(e){var i=couleur_de_letat($("[id='"+e.value+"']")[0].value);e.style.background=i}function supprimer_ce_chapitre(e){var i=le_id_chapitre(e);var r=confirm("⚠️Voulez-vous vraiment supprimer ce chapitre ? Cette action est irréversible. ("+i+")");if(r){supprimer("Programme","id_chapitre",i).then(()=>maj_matiere())}}function le_id_chapitre(e){return e.parentNode.id}function modifier_chapitre(e,i,r,t){var n={id_chapitre:e,[i]:r};actualiser("Programme","id_chapitre",e,n).then(()=>t?t():"")}function choisir_ce_mode(e){if($(".mode_affichage_fichiers")){$(".mode_affichage_fichiers")[0].className="mode_affichage_fichiers";$(".mode_affichage_fichiers")[1].className="mode_affichage_fichiers";var i=e.id.replace("par_","");var r=id_autre(i);$("#"+i)[0].style.display="";$("#"+r)[0].style.display="none";e.className="mode_affichage_fichiers sekooly-mode-background";masquer_config_mode();stocker("mode_prefere",e.id);filtrer_avec_le_bon_filtre(i)}}function filtrer_avec_le_bon_filtre(e){if(e==="la_date_effet"){filtrer_date_effet()}else if(e==="filtre_id_chapitre"){filtrer_chapitre()}}function id_autre(e){var i=e==="la_date_effet"?"filtre_id_chapitre":"la_date_effet";return i}function afficher_config_mode(){if($(".gear-container")[0])$(".gear-container")[0].style.display="block"}function masquer_config_mode(){if($(".gear-container")[0])$(".gear-container")[0].style.display=""}function switch_config_mode(){if($(".gear-container")[0]){deja_visible=$(".gear-container")[0].style.display==="block";if(deja_visible){masquer_config_mode()}else{afficher_config_mode()}}}function creer_chapitre(){recuperer_programme();afficher_fenetre(false);$("select[id='ID_URL']")[0].value=recuperer("dossier_chargé");ajouter_un_chapitre().then(async function(e){if(e){await chercher_mes_chapitres(true);$("select#id_chapitre")[0].value=e["id_chapitre"]}else{element_DOM("id_chapitre").value="--"}})}function faire_la_recherche_fichier(){var e='<input id="rechercher" class="barre_recherche" name="rechercher" placeholder="Rechercher un fichier par mot(s)-clé(s)...">';$("#mini_popup").remove();var i=help("aide_recherche()");creer_mini_popup(i+"<b>Que recherchez-vous?</b>"+e,"<div class='liste_resultats' id='liste_resultats'></div>","Rechercher","afficher_resultats_recherche()")}function help(e){return'<rouge class="mini-image" onclick="'+e+"\">Besoin d'aide?</rouge>"}function aide_recherche(){var e="Un fichier peut être recherché par des mots-clés liés à :\n\t• la matière dans laquelle il est publié\n\t• le nom que l'enseignant lui a donné\n\t• son extension (pdf,png,youtube...)\n\t• sa catégorie (cours, devoir, ...)\n\t• l'intitulé de son chapitre.\nExemple: aucun chapitre";alert(e)}async function afficher_resultats_recherche(){chargement(true);var r=$("#rechercher")[0].value.trim().toLowerCase().replaceAll(" ","");if(!r){alert("Merci de d'abord saisir un mot-clé.");return false}mes_fichiers=await recuperer_mes_fichiers(true);var e=mes_fichiers.filter(e=>e["categorie_fichier"]!=="Profil");var t=JSON.parse(recuperer("mes_matieres"));mes_fichiers_intermediaires=e.map(i=>Object.assign({},...[i,t.find(e=>e["ID_URL"]===i["id_dossier"])]));var i=mes_fichiers_intermediaires.filter(function(e,i){dans_classe_matiere=e["Classe_Matiere"].toLowerCase().replaceAll(" ","").includes(r);dans_categorie_fichier=e["categorie_fichier"].toLowerCase().replaceAll(" ","").includes(r);dans_nom_fichier=e["nom_fichier"].toLowerCase().replaceAll(" ","").includes(r);intitule_chapitre=e["intitule_chapitre"]===null?"(Aucun chapitre)":e["intitule_chapitre"];dans_intitule_chapitre=intitule_chapitre.toLowerCase().replaceAll(" ","").includes(r);return dans_classe_matiere||dans_categorie_fichier||dans_nom_fichier||dans_intitule_chapitre});var n="";if(i.length===0){n='<div class="alerte_section_journee">Aucun résultat trouvé pour <b>'+r+"</b>.<br>Merci de réessayer.</div>"}else{i.forEach(function(e){n+=creer_element_journee(e["Classe"]+" "+e["Matiere"],e["nom_fichier"],e["date_effet"],e["heure_effet"],e["id_fichier"],e["ID_URL"],"fichier",false,false,false)})}$("#nb_resultats").remove();$("#liste_resultats")[0].innerHTML="";$("#liste_resultats").append(n);$("#mini_popup").append('<div id="nb_resultats"><b>'+i.length+" résultats trouvés<b></div>");chargement(false)}async function emettre_avis_sekooly(){var e=await mon_avis_actuel();var i=e.length>0;var r=i?"Modifier mon avis":" Envoyer mon avis ";var t=i?"fermer_emettre_avis()":"envoyer_avis()";var n=i?'<div id="avis">'+afficher_avis(e[0])+"</div>":formulaire_avis();creer_mini_popup("Mon avis sur Sekooly",n,r,t,false,false,false,false,25);accepter_cgu_avis()}function avis_good(){return"❤️Ce que vous aimez le plus"}function avis_bad(){return"😕Ce que vous aimez moins<br>(ou une fonctionnalité que vous aimeriez avoir)"}function afficher_avis(e){return un_element_avis("Note globale",e["note_globale"],"note_globale")+un_element_avis(avis_good(),e["commentaire"],"commentaire")+un_element_avis(avis_bad(),e["ameliorations"],"ameliorations")}function un_element_avis(e,i,r){return'<div><b class="titre_chapitre sekooly-mode">'+e+':</b><div class="element_avis" id="'+r+'">'+i+"</div></div>"}function formulaire_avis(){return`<div id="nouvel_avis"><br>		
		<p>Nous serions honorés de <span class="titre_chapitre sekooly-mode">connaître en détails</span> ce qui vous plaît! (et même ce qui vous plaît moins 😉)</p>
		<form onsubmit="event.preventDefault();" id="avis">
			<div>Note globale pour Sekooly (sur 5):`+liste_notes_possibles()+`</div>
			<div>`+avis_good()+`:<textarea id="commentaire" class="texte_avis"></textarea></div>
			<div>`+avis_bad()+`:<textarea id="ameliorations" class="texte_avis"></textarea></div>
		</form>
		<div>
			<label for="cgu_avis"><input onchange="accepter_cgu_avis()" id="cgu_avis" type="checkbox" checked>J'accepte les <a class="titre_chapitre sekooly-mode" onclick="alert(CGU_avis(event))">Conditions d'Utilisation</a> du système d'avis de la plateforme.</label>
		</div>
		</div>
		`}function CGU_avis(e){e.preventDefault();return`
	En cochant cette case, vous acceptez de:

	1° Mettre en avant votre avis sur sekooly.com sans aucune réserve
	2° Donner l'autorisation totale à Sekooly d'utiliser le nom de votre établissement, votre rôle et vos initiales pour la mise en avant de la plateforme
	3° Céder à Sekooly le droit de diffuser votre avis, dans les termes du point n°2
	4° Supprimer par vous-même votre avis en cas de besoin, depuis votre espace utilisateur.

	`}function liste_notes_possibles(e,i,r,t){var n=t?' onchange="'+t+'(this)"  ':"";var a=!r?'<select name="note_globale" id="note_globale" value=5>':'<select name="'+r+'"  '+n+"   >";var s=e?-5.1:0;for(la_note=5;la_note>s;la_note=la_note-.1){la_note=la_note.toFixed(2);selected=la_note===Number(i).toFixed(2)?" selected ":"";a+=une_note_possible(la_note,selected)}a+="</select>";return a}function une_note_possible(e,i){return'<option value="'+e+'"  '+i+"  >"+e+"</option>"}function fermer_emettre_avis(){var e=confirm("⚠️Cela supprimera votre ancien avis, et cette action est irréversible. Voulez-vous continuer ?");if(e){$("#mini_popup").remove();supprimer_initial("Avis","identifiant",recuperer("identifiant_courant")).then(()=>emettre_avis_sekooly())}}async function mon_avis_actuel(){return await get_resultat_asynchrone(racine_initiale+"Avis?identifiant=eq."+recuperer("identifiant_courant")+"&"+api_initial)}function accepter_cgu_avis(){if($("#cgu_avis").length>0){var e=$("#cgu_avis")[0].checked;afficher_bouton_envoyer_avis(e)}}function afficher_bouton_envoyer_avis(e){$("[onclick='envoyer_avis()']")[0].style.display=e?"":"none"}async function envoyer_avis(){var e=$("#note_globale")[0].value;var i={identifiant:recuperer("identifiant_courant"),nom_etablissement:data_etablissement["nom_etablissement"],mon_type:mon_role,note_globale:e,commentaire:$("#commentaire")[0].value,ameliorations:$("#ameliorations")[0].value,est_visible:false,horodateur:maintenant()};return ajouter_un_element_racine("Avis",i).then(function(){afficher_alerte("Merci infiniment pour votre avis!");emettre_avis_sekooly()})}async function gerer_sondage(){var aujd=maintenant().split(" ")[0];var mes_sondages=get_resultat(racine_initiale+"Sondage?date_fin=gt."+aujd+"&"+api_initial);if(recuperer("identifiant_courant").includes("admin.tech")){var sondages_non_majs=mes_sondages.filter(e=>e["maj_reponse_sondage"]===false);if(sondages_non_majs.length>0){var confirmation=confirm("Mettre à jour tous les identifiants de tous les établissements Sekooly?");if(!confirmation)return false;var liste_etablissements=get_resultat(racine_initiale+"Etablissements?"+api_initial);liste_etablissements.forEach(function(i){console.log("\n\n\n\n");liste_tables=["Eleves","Profs","Administration"];liste_tables.forEach(function(e){nouvelle_donnee={Reponse_sondage:"non"};url=i["racine_data"]+e+"?apikey="+i["apikey"];console.log("\n");console.log({url:url,nouvelle_donnee:nouvelle_donnee});patch_resultat_asynchrone(url,nouvelle_donnee)})});url=racine_initiale+"Sondage?"+api_initial;patch_resultat_asynchrone(url,{maj_reponse_sondage:true})}}else{var mon_type=recuperer("mon_type").split("_")[0];var mes_donnees=get_resultat(racine_data+mon_type+"?Identifiant=eq."+recuperer("identifiant_courant")+"&"+apikey)[0];var donnees_actuelles=JSON.parse(recuperer("mes_donnees"));if(!mes_donnees||mes_donnees["Code"]!==donnees_actuelles["Code"]&&mes_donnees["Code"]!==hasher(donnees_actuelles["Code"])){console.log("usurpation d'identité.");await tout_quitter()}else{stocker("mes_donnees",JSON.stringify(mes_donnees))}if(mes_donnees["Reponse_sondage"]==="non"){mes_sondages.forEach(async function(sondage){alert(sondage["description"]);await eval(sondage["fonction_a_appeler"]);var element_validation=eval(sondage["selector_element_finalisation"]);element_validation.on("click",function(){var e=racine_data+recuperer("mon_type")+"?Identifiant=eq."+recuperer("identifiant_courant")+"&"+apikey;patch_resultat_asynchrone(e,{Reponse_sondage:"oui"});modifier_donnee_locale("mes_donnees","Identifiant",recuperer("identifiant_courant"),"Reponse_sondage","oui")})})}}}function gerer_notifs_irl(e){var i=$("#notifs_sans_actualiser")[0].innerText;var r="";var t="";if(i.length>0){r="";t="Notifications et messages en temps réel <b><rouge>désactivés</rouge></b> sur cet appareil.";fermer_la_subscription()}else{var n=confirm("🔔 En activant les notifications et messages privés en temps réel sur cet appareil, vous risquez d'augmenter votre consommation de données.\n\nVoulez-vous continuer?");if(n){r=" ✓";t="Messages privés en temps réel <b><rouge>activés</rouge></b> sur cet appareil.";ouvrir_la_subscription()}}stocker("notifs_sans_actualiser",r);$("#notifs_sans_actualiser")[0].innerText=r;if(t)afficher_alerte(t)}function notifs_reelles_ou_non(){var e="";if(recuperer("notifs_sans_actualiser")){e=" ✓";ouvrir_la_subscription()}else{e="";fermer_la_subscription()}$("#notifs_sans_actualiser")[0].innerText=e}function la_notif_me_concerne(e,i){if(i.eventType==="UPDATE"||i.eventType==="INSERT"){var r=i["new"];var t=JSON.parse(recuperer("mes_matieres"));var n=r["Identifiant_derniere_modif"].includes(recuperer("identifiant_courant"));var a=e.includes("Profs")&&t.filter(e=>e["ID_URL"]===r["Id_classe_matiere"]).length>0;var s=e.includes("Eleves")&&t.filter(e=>e["ID_URL"]===r["Id_classe_matiere"]).length>0;var o=e.includes("Admin")&&r["Cycle"]===JSON.parse(recuperer("mes_donnees"))["Cycle"];return!n&&(a||s||o)}else{return false}}function ouvrir_la_subscription(){if(mySubscription_notif&&mySubscription_conv)return true;var t=recuperer("mon_type").split("_")[0];var e="Notifs";gerer_notifications_appareil();mySubscription_notif=supabase.from(e).on("*",function(e){console.log("nouvelle notif!",e);if(la_notif_me_concerne(t,e)){var i=ajouter_la_notif(e["new"],null,true);var r=","+JSON.parse(recuperer("mes_notifs")).map(e=>e.id_notif).join(",")+",";la_date_derniere_modif=convertir_en_date(e["new"]["Date_derniere_modif"]).seconds(0).milliseconds(0).toISOString();ma_date_consultation=convertir_en_date(recuperer("ma_date_consultation")).seconds(0).milliseconds(0).toISOString();if(!(liste_notifs_lues.includes(","+e["new"]["id_notif"]+",")&&la_date_derniere_modif<=ma_date_consultation)){afficher_notif(i,e["new"])}recuperer_notifs()}else{}}).subscribe();mySubscription_conv=supabase.from("Conversations:Destinataire=eq."+recuperer("identifiant_courant")).on("*",async function(e){var i=element_DOM("fenetre").style.visibility==="visible";var r=i?$("#div_liste_msgs").length>0?true:false:false;var t=$("#Destinataire.titre_du_poste").length>0?$("#Destinataire.titre_du_poste")[0].innerHTML===e["new"]["Expediteur"].toUpperCase():false;if(t){ajouter_donnee_locale("mes_msgs",e["new"],"id_msg");if($("[id='"+e["new"].id_msg+"']").length===0){$("#conversation").append(afficher_msg_conversation(e["new"]));element_DOM(e["new"].id_msg).scrollIntoView();jai_lu(e["new"].id_msg,true)}}else if(!r){ajouter_donnee_locale("mes_msgs",e["new"],"id_msg");afficher_bulle_notifs()}else{ajouter_donnee_locale("mes_msgs",e["new"],"id_msg");recuperer_msgs(false);afficher_bulle_notifs()}}).subscribe();$(window).bind("beforeunload",function(){fermer_la_subscription()})}function fermer_la_subscription(){if(mySubscription_notif)supabase.removeSubscription(mySubscription_notif);if(mySubscription_conv)supabase.removeSubscription(mySubscription_conv)}function gerer_notifications_appareil(){if(mode_test_notif()){if(Notification.permission!=="granted"){Notification.requestPermission().then(function(e){afficher_notif()})}else{}}}function afficher_notif(e,i){if(Notification.permission==="granted"&&mode_test_notif()){popup_notification(e,i)}}function mode_test_notif(){return window.location.href.includes("testo")||window.location.href.includes("localhost")}function popup_notification(e,i){var r=e||"Vous avez activé les notifications Sekooly.";const t=new Notification("Sekooly | Nouvelle notification",{body:r,icon:prefixe_image+"/logo-no-background-128x128.png",vibrate:[100,50,100]});if(i){t.onclick=function(e){clic_de_notif(i["Type_notif"],i["Id_source"],i["Id_classe_matiere"],i["id_notif"],i["Type_notif"]==="discussion")}}else{}}function ajouter_page_devoir(){nb_pages_devoir=$(".mon_file_devoir").length;if(nb_pages_devoir<8){var e=element_DOM("file_devoir").cloneNode(true);e.id="file_devoir_"+nb_pages_devoir;e.value="";e.className="mon_file_devoir fichier_supplementaire";$("#soumettre_devoir")[0].insertBefore(e,$("#boutons_devoir")[0]);$(".mon_file_devoir").off("change");$(".mon_file_devoir").on("change",function(e){actualiser_rendu()})}else{alert("Vous ne pouvez pas envoyer un devoir de plus de 8 pages.")}}async function actualiser_rendu(e){await rassembler(e)}async function supprimer_derniere_page_devoir(){index_dernier_devoir=$(".mon_file_devoir").length-1;if(index_dernier_devoir>0){var e=$("[id='file_devoir_"+index_dernier_devoir+"']")[0].value.length>0;if(e)var i=confirm("Voulez-vous vraiment supprimer la dernière page?");if(i||!e){$("[id='file_devoir_"+index_dernier_devoir+"']").remove();$("img#result"+index_dernier_devoir).remove();await actualiser_rendu(true)}}}function mode_suppression(){return recuperer("mon_type").includes("Administration")&&window.location.href.endsWith("?delete="+data_etablissement["id_etablissement"])}async function valider_suppression_via_mail_si_besoin(){if(mode_suppression()){confirmation=prompt("Vous avez demandé à supprimer Sekooly, ce qui engendre la suppression de TOUTES vos données.\n\nMerci de confirmer cette action en écrivant 'je veux supprimer "+data_etablissement["nom_etablissement"]+"'");console.log(confirmation);if(confirmation==="je veux supprimer "+data_etablissement["nom_etablissement"]){chargement(true);var e=await chercher_lien_script(5);var i="?confirmation="+confirmation;var r="&adresse_mail_suppression="+data_etablissement["contact_etablissement"];var t="&nom_etablissement="+data_etablissement["nom_etablissement"];var n="&id_etablissement="+data_etablissement["id_etablissement"];url=e+i+r+t+n;chargement(true);resultat=await post_resultat_asynchrone(url,{});await supprimer_initial("Etablissements","id",data_etablissement["id"]);setTimeout(function(){window.location.href="https://sekooly.com"},3e3);afficher_alerte(resultat);chargement(false)}else{afficher_alerte("Suppression de votre plateforme Sekooly annulée.");setTimeout(function(){window.location.href="/tele-enseignement"},3e3)}}}function afficher_quiz_option(e){element_DOM("quiz-option").style.display=e?"block":"none"}function quiz_selected(){return $("#liste_quiz").val()}function edit_quiz(){stocker("tmp_quiz",JSON.stringify({id_quiz:quiz_selected()}));creer_quiz()}async function delete_quiz(){var e=confirm("⚠️Êtes-vous sûr de vouloir supprimer ce quiz ? Cette action est irréversible.");if(e){var i=quiz_selected();est_publié=await rechercher("Fichiers","id_fichier",i);if(est_publié.length>0){var r=confirm("Le quiz possède peut-être déjà des réponses.\nSi vous le supprimez, vous supprimez toutes les réponses du quiz. Voulez-vous continuer?");if(r)supprimer_quiz(i)}else{supprimer_quiz(i)}}}async function supprimer_quiz(e){await supprimer("Reponses","id_quiz",e);await supprimer("Questions","id_quiz",e);await supprimer("Rendus","id_fichier_sujetdevoir",e);await supprimer("Quiz","id_quiz",e);afficher_alerte("Le quiz a bien été supprimé.");changement_quiz_ou_non()}function ajouter_edit_quiz(e){if(e){if($("#edit-quiz").length===0)$("#mode-quiz").append('<img id="edit-quiz" onclick="edit_quiz()" src="'+prefixe_image+'/img_edit.png" alt="MODIFIER" class="editer">');if($("#delete-quiz").length===0)$("#mode-quiz").append('<img id="delete-quiz" onclick="delete_quiz()" src="'+prefixe_image+'/img_trash.png" alt="SUPPRIMER" class="editer">')}else{$("#edit-quiz").remove()}}async function changement_quiz_ou_non(){$("#liste_quiz").off("change");$("#liste_quiz").on("change",function(e){if(e.target.value==="new"){$("#liste_quiz")[0].value="--";ajouter_edit_quiz(false);creer_quiz()}else if(e.target.value==="--"){ajouter_edit_quiz(false)}else{ajouter_edit_quiz(true)}});if($("#categorie_choisie")[0].value==="Quiz"){$("#mode-non-quiz").css("display","none");$("#mode-quiz").css("display","block");all_quiz=await rechercher("Quiz","id_classe_matiere",recuperer("dossier_chargé"));$(".my-quiz").remove();all_quiz.forEach(e=>{$('<option class="my-quiz" value="'+e.id_quiz+'">'+e.titre+"</option>").insertBefore($('[id="new-quiz"]'))});$("#mettre_fichier_en_ligne").on("click",function(){id_quiz=$("#liste_quiz").val();if(id_quiz!=="--"){var e=$('[value="'+id_quiz+'"]').text()+".quiz";publier_quiz(id_quiz,e);$("#mettre_fichier_en_ligne").off("click")}});afficher_checkbox_fichier_telechargeable(false);$("#liste_quiz")[0].value="--"}else{element_DOM("mode-non-quiz").style.display="grid";element_DOM("mode-quiz").style.display="none";afficher_checkbox_fichier_telechargeable(true)}}function initialiser_fenetre_quiz(e,i){var r=e?"prev_question()":"prev_step_quiz()";var t=e?"next_question("+i+")":"next_step_quiz()";$("#fenetre").append('<div class="setup" id="setup"></div>');$("#setup").append('<div id="contenu_etape_quiz"></div>');$("#setup").append('<div id="btn-quiz"></div>');$("#btn-quiz").append('<button onclick="'+r+'" id="btn-previous" class="btn-setup sekooly-mode-background">Précédent</button>');$("#btn-quiz").append('<button onclick="'+t+'" id="bouton_suivant" class="btn-setup sekooly-mode-background">Suivant</button>');$("#btn-quiz").append('<div id="remarque-quiz"></div>')}async function creer_quiz(e){if(recuperer("mon_type").includes("Eleve"))return alert("Vous n'avez pas les droits pour modifier un quiz.");vider_fenetre("Editer un quiz (<span id='etape-quiz'>1</span>/2)",false,"sauvegarder_quiz()");afficher_fenetre(true);initialiser_fenetre_quiz();init_creation_quiz();if(e){for(var i=0;i<e;i++){next_step_quiz()}}}function afficher_donnes_quiz(e,r){e.forEach(i=>{var e=r.filter(e=>e["id_quiz"]===get_current_quiz()&&e["id_question"]===i["id_question"]);nouvelle_question(i,e)})}async function saisie_des_questions_responses(){var n=[];var _=[];console.log("Enregistrement des questions...");await sauvegarder_le_quiz_dans_la_table_quiz();$(".une_question_quiz").each(async(e,i)=>{var o=i.querySelector(".id_question").value;var r=i.querySelector("#intitule_question").value;var t={id_quiz:get_current_quiz(),id_question:o,position_question:e,type_question:element_DOM("type_question"+o).innerText,intitule_question:r};n.push(t);$(".une_question_quiz#"+o+" > .ui-sortable > ").each(async(e,i)=>{var r=i["id"];var t=i.querySelector("[name=reponse]").value;var n=Number(i.querySelector("[name=note_globale]").value);var a=i.querySelector(".remarque_correction").outerHTML;var s={id_quiz:get_current_quiz(),id_question:o,id_reponse:r,position_reponse:e,intitule_reponse:t,score:n,remarque_correction:a};_.push(s)})});var e=await stocker_element_server("Questions",n);var i=await stocker_element_server("Reponses",_);return[n,_]}async function init_creation_quiz(){var e=await valeur_par_defaut("*");if(!e){e={};e["titre"]="";e["description"]=""}element_DOM("contenu_etape_quiz").innerHTML=`
		<span>Vous êtes sur le point de créer un quiz de <b class="sekooly-mode">`+la_matiere_chargee("Matiere")+`</b> dans <b class="sekooly-mode">`+la_matiere_chargee("Classe")+`</b>.</span>
		<form id="quiz-form">
			<input id="titre" name="titre" type="text"  value="`+e["titre"].split(".quiz")[0]+`" placeholder="Titre de votre quiz">
			<textarea id="description" name="description" type="text"  placeholder="Brève description de votre quiz">`+e["description"]+`</textarea>
		</form>
	`}async function valeur_par_defaut(){try{var e=get_current_quiz();var i=await rechercher("Quiz","id_quiz",e);if(i)i=i[0];var r=i?i:JSON.parse(recuperer("tmp_quiz"));return r}catch(t){return""}}async function crud_questions(){element_DOM("contenu_etape_quiz").innerHTML=`
		<form id="quiz-form">
		</form>
		<bleu class="quiz-options" onclick="nouvelle_question()"><img src="`+prefixe_image+`/img_ajout.png" style="" class="small-icon"> Ajouter une question</bleu>
		<div onclick="run_quiz(true)" class="sekooly-mode quiz-options"><img src="`+prefixe_image+`/img_previz.png" class="small-icon trash"> Prévisualiser le quiz</div>
	`;var e=get_current_quiz();if(e){var i=await rechercher("Questions","id_quiz",get_current_quiz(),"*",false,"position_question.asc");var r=await rechercher("Reponses","id_quiz",get_current_quiz(),"*",false,"position_reponse.asc");afficher_donnes_quiz(i,r)}}async function run_quiz(e,i){var r=i||get_current_quiz();if(e){ma_tentative.id_fichier_sujetdevoir=r;ma_tentative.proprietaire=recuperer("identifiant_courant");ma_tentative.date_publication="";sauvegarder_quiz()}accueil_quiz(r,e)}function get_current_question(){return recuperer("current_question")?Number(recuperer("current_question")):-1}function prev_question(){var e=Math.max(-1,get_current_question()-1);go_to_question(e)}function btn_terminer(){var e=quiz_mode_lecture()?"Terminer la relecture":"Tout envoyer et terminer";return e}async function next_question(e){if(element_DOM("bouton_suivant").innerHTML===btn_terminer()){var i=await submit_quiz();if(i)accueil_quiz(get_current_quiz())}var r=Math.min(e,get_current_question()+1);go_to_question(r,e)}async function accueil_quiz(id_quiz,preview_mode,proprietaire_initial){var proprietaire_devoir=recuperer("proprietaire_devoir");var proprietaire=proprietaire_initial?proprietaire_initial:proprietaire_devoir?proprietaire_devoir:recuperer("identifiant_courant");var references={id_fichier_sujetdevoir:id_quiz,proprietaire:proprietaire};var mes_tentatives=await rechercher_avec_ces_references("Rendus",references);var tentative_en_cours=mes_tentatives.length>0;if(tentative_en_cours){ma_tentative=mes_tentatives[0];var date_debut_premiere_tentative=ma_tentative["date_debut"]}else{ma_tentative={}}var moimeme=proprietaire.toLowerCase()===recuperer("identifiant_courant");var pronom_utilisateur=!moimeme?proprietaire.toUpperCase():"Vous";var verbe_utilisateur=pronom_utilisateur==="Vous"?"avez":"a";var poss=pronom_utilisateur==="Vous"?"Votre":"Son";var infos_quiz=await rechercher("Quiz","id_quiz",id_quiz,"*");var nb_questions=await rechercher("Questions","id_quiz",id_quiz,"id_question");if(infos_quiz.length>0&&nb_questions.length>0){infos_quiz=infos_quiz[0];nb_questions=nb_questions.length;var bouton_edit=preview_mode||$('[class="editer"]').length>0?'<img onclick="creer_quiz()" src="'+prefixe_image+'/img_edit.png" alt="MODIFIER" class="editer">':"";vider_fenetre(infos_quiz["titre"]+bouton_edit,false,"sauvegarder_quiz()");initialiser_fenetre_quiz(true,nb_questions);var total_score=await rechercher_avec_ces_references("total_score",{id_quiz:id_quiz},["score_question"]);if(total_score)total_score=eval(total_score.map(e=>e.score_question).join("+"));var fin_quiz=ma_tentative["date_publication"]?"<br>"+pronom_utilisateur+" l'"+verbe_utilisateur+" terminé le "+afficher_date(ma_tentative["date_publication"]):"";var points=ma_tentative["date_publication"]?"<br><b class='sekooly-mode'> "+poss+" score: "+await calculer_mon_score(ma_tentative["reponses"])+"/"+total_score+"</b>":"";var remarque_quiz=date_debut_premiere_tentative?'<i style="color: #737373;"> '+pronom_utilisateur+" "+verbe_utilisateur+" déjà fait 1 tentative le "+afficher_date(date_debut_premiere_tentative)+" "+fin_quiz+points+" </i>":"";element_DOM("remarque-quiz").innerHTML=remarque_quiz;$("#contenu_etape_quiz").append(infos_quiz["description"]+"<br><br>Ce quiz comporte "+nb_questions+" question"+(nb_questions>1?"s":"")+", et noté sur "+total_score+".");$("#contenu_etape_quiz").addClass("resp_zone");stocker("current_question",-1);afficher_fenetre(true);element_DOM("bouton_suivant").innerText=ma_tentative["date_publication"]?"Relecture":date_debut_premiere_tentative?"Reprendre la tentative":"Commencer";element_DOM("btn-previous").setAttribute("style","display: none;")}return true}async function calculer_mon_score(rpses){rspses_t=transform_rsp(rpses);my_id_resp=rspses_t[0];my_str_rsp=rspses_t[1];ref={id_quiz:get_current_quiz()};total_score=await rechercher_avec_ces_references("Reponses",ref,["id_reponse","score","intitule_reponse"]);var mon_score=total_score.filter(function(e){return my_id_resp.indexOf(e["id_reponse"])>=0||my_str_rsp.indexOf(e["intitule_reponse"].trim())>=0});mon_score=mon_score.map(e=>Number(e["score"]));return eval(mon_score.join("+"))}function transform_rsp(e){var r=[];var t=[];if(typeof e==="string")e=JSON.parse(e);$.each(e,(e,i)=>{if(typeof i==="string"){t.push(i.trim())}else if(i){r.push(i.map(e=>Object.keys(e)).join(","))}});r=r.join(",").split(",");return[r,t]}function initialiser_tentative(){if(Object.keys(ma_tentative).length===0){var e=creer_uuid();ma_tentative={id_devoir:get_current_quiz()+suite_notif(),id_fichier:e,proprietaire:recuperer("identifiant_courant"),id_dossier_sujetdevoir:recuperer("dossier_chargé"),matiere_rendue:la_matiere_chargee("Matiere"),id_fichier_sujetdevoir:get_current_quiz(),date_debut:get_date_debut_quiz(),remarque:"",taille_fichier:0,nom_fichier:"Quiz de "+recuperer("identifiant_courant")+".quiz",reponses:{}}}return ma_tentative}async function go_to_question(e,i){save_current_submition();stocker("current_question",e);chargement(true);await get_nth_question(e,i);chargement(false)}function get_date_debut_quiz(){return recuperer("date_debut_quiz")?recuperer("date_debut_quiz"):maintenant()}async function submit_quiz(e){if(quiz_mode_lecture())return true;if(!e){if(quiz_mode_previz()){alert("Au clic de ce bouton, l'utilisateur aura le score de sa tentative, ainsi que la correction du quiz.\n⚠️Votre tentative n'est pas envoyée car vous êtes éditeur de ce quiz.");return true}var i=confirm("⚠️Êtes-vous sûr de vouloir terminer le quiz ? Cette action est irréversible.");if(!i)return false;ma_tentative["date_publication"]=!quiz_mode_previz()?await maintenant():""}if(Object.keys(ma_tentative.reponses).length>0){var r=await supabase.from("Rendus").upsert(ma_tentative);if(ma_tentative["date_publication"]){mes_donnees=JSON.parse(recuperer("mes_donnees"));id_quiz=get_current_quiz();var t={id_notif:id_quiz+suite_notif(),Horodateur:ma_tentative["date_publication"],Type_notif:"devoir",Id_source:id_quiz,"Intitulé":ma_tentative["nom_fichier"],Identifiant_originaire:recuperer("identifiant_courant"),Role_originaire:"Eleve",Identifiant_derniere_modif:recuperer("identifiant_courant"),Role_derniere_modif:"Eleve",Classe:mes_donnees["Classe"],Classe_matiere:"("+mes_donnees["Classe"]+"|"+la_matiere_chargee("Matiere")+")",Id_classe_matiere:recuperer("dossier_chargé"),Date_derniere_modif:ma_tentative["date_publication"],Cycle:mes_donnees["Cycle"]};var n=await supabase.from("Notifs").upsert(t)}}return ma_tentative}function save_current_submition(){var e=recuperer("current_question");var i=get_date_debut_quiz();var r=[];if($(".option-rps").length>0){$(".option-rps:checked").each((e,i)=>{r.push({[i.value]:i.nextSibling.innerText})})}else{r=$(".rps_quiz").val()}var t={};t[e]=r;initialiser_tentative();if(!ma_tentative.reponses)ma_tentative.reponses={};ma_tentative.reponses[e]=r;submit_quiz(true);return ma_tentative}function reference_question(e,i,r){var t=i?i:e+1;var n=r?","+r:"";return'<a ref="'+e+'"    onclick="go_to_question('+e+n+')"><span>[ '+t+" ]</span></a> "}async function get_nth_question(e,i){if(e<0){return accueil_quiz(get_current_quiz())}else{element_DOM("bouton_suivant").innerText="Suivant";element_DOM("btn-previous").setAttribute("style","");if(i){element_DOM("remarque-quiz").innerHTML=reference_question("-1","Accueil",i);for(var r=0;r<i;r++){element_DOM("remarque-quiz").innerHTML+=reference_question(r)}element_DOM("remarque-quiz").innerHTML+=reference_question(i,"Finaliser",i)}}var t={id_quiz:get_current_quiz(),position_question:e};var n=await rechercher_avec_ces_references("Questions",t);if(n.length>0){n=n[0];var a=n["id_question"];delete t["position_question"];t["id_question"]=a;var s=await rechercher_avec_ces_references("total_score",t);if(!s)return afficher_alerte("Erreur de connexion, merci de réessayer plus tard.");var o=s[0]["nb_questions_ok"];var _=s[0]["score_question"];var l=await rechercher_avec_ces_references("Reponses",t,["id_reponse"]);l=l.length;var c=l===1?["id_quiz","id_question","id_reponse"]:["id_quiz","id_question","id_reponse","intitule_reponse"];if(quiz_mode_lecture())c=["*"];var u=await rechercher_avec_ces_references("Reponses",t,c,"position_reponse.asc");if(u){var l=u.length;if(typeof ma_tentative.reponses==="string")ma_tentative.reponses=JSON.parse(ma_tentative.reponses);var d=ma_tentative.reponses?ma_tentative.reponses[e]:null;$("#resp_zone").remove();var m=resp_zone(a,u,l,o,d);$(m).insertBefore(element_DOM("btn-quiz"));element_DOM("contenu_etape_quiz").innerHTML=n["intitule_question"];element_DOM("contenu_etape_quiz").innerHTML+="<br>("+_+" point"+(_>1?"s":"")+")"}}else{element_DOM("contenu_etape_quiz").innerHTML=quiz_mode_lecture()?"Retrouvez ci-dessous le résumé de votre tentative.":"Vous êtes sur le point de terminer le quiz.<br>Retrouvez ci-dessous le résumé de votre tentative.";element_DOM("resp_zone").innerHTML=resume_tentative_quiz(i)}$("#contenu_etape_quiz").removeClass("resp_zone");$("span").removeClass("sekooly-mode");if($("a[ref='"+e+"']")[0])$("a[ref='"+e+"']")[0].children[0].className="sekooly-mode";if(e===i)element_DOM("bouton_suivant").innerText=btn_terminer();return n}function resume_tentative_quiz(e){var i=get_current_quiz();var r="";var t="";for(var n=0;n<e;n++){if(ma_tentative.reponses){t=typeof ma_tentative.reponses[n]==="string"?ma_tentative.reponses[n]:typeof ma_tentative.reponses[n]==="object"?JSON.stringify(ma_tentative.reponses[n]):""}if(t==="[]")t=[];var a="<rouge>❌ Aucune réponse enregistrée</rouge>";if(t){if(t.length>0)a="<bleu>☑️ Réponse enregistrée</bleu>"}r+='<div onclick="go_to_question('+n+")\" class='resume'><br><a>Question n°"+(n+1)+"</a>: "+a+"</div>"}return r}function resp_zone(i,e,r,t,n){var a=ma_tentative["date_publication"]?' disabled  readonly="readonly" ':"";var s=0;var o="";var _="";var l="";var c="Vous avez eu ";if(recuperer("proprietaire_devoir")){c=recuperer("proprietaire_devoir")===recuperer("identifiant_courant")?"Vous avez eu ":recuperer("proprietaire_devoir").toUpperCase()+" a eu "}if(r===1){var u=n?'value="'+n+'"':"";var d=e[0]["intitule_reponse"]?n.trim()===e[0]["intitule_reponse"].trim():"";var l=d&&e[0]["remarque_correction"]?e[0]["remarque_correction"]:!d&&e[0]["intitule_reponse"]?"<rouge class='remarque_correction'>❌Mauvaise réponse. La réponse était: <b>"+e[0]["intitule_reponse"]+"</b></rouge>":"";_=!e[0]["intitule_reponse"]?"":d&&e[0]["score"]?e[0]["score"]>0?"+"+e[0]["score"]:e[0]["score"]:!d?0:"";o=e[0]["score"]?c+_+" points pour cette question.":"";return`<form id="resp_zone" class="resp_zone" style="text-align: center;"><input `+u+`     class="rps_quiz"  id_question="`+i+`"  name="qst`+i+`"  id="response`+e[0]["id_reponse"]+`" placeholder="Votre réponse..."   `+a+`  type="text" name="rsp'+id_question+'"> <div>`+l+`  <span class="points">`+_+`</span></div>  <div class="points" id="rmq'+id_question+'"> `+o+` </div>   </form>`}else{var m=t===1?"radio":"checkbox";var f='<form id="resp_zone" class="resp_zone">';var p=",";if(n){p=typeof n!=="string"?","+n.map(e=>Object.keys(e)).join(",")+",":n}e.forEach(e=>{est_coché="";if(n){est_coché=p.includes(","+e["id_reponse"]+",")?"  checked  ":"";phrase_reponse_vraie_non_cochee=m==="checkbox"?"<rouge class='remarque_correction'>✅Cette réponse était aussi vraie.</rouge>":"<rouge class='remarque_correction'>✅Celle-ci était la bonne réponse.</rouge>";l=!e["score"]?"":e["score"]>0&&est_coché?e["remarque_correction"]:e["score"]<=0&&est_coché?e["remarque_correction"]:e["score"]>0&&!est_coché?phrase_reponse_vraie_non_cochee:"";signe=e["score"]>=0?"+":"";_=e["score"]?signe+e["score"]:"";s=e["score"]&&est_coché?s+Number(e["score"]):s;o=e["score"]?c+s+" points pour cette question.":""}f+=`
				<div>
					<input class="option-rps" type="`+m+`"     `+a+`     id_question="`+i+`"  `+est_coché+` name="qst`+i+`"  value="`+e["id_reponse"]+`" id="response`+e["id_reponse"]+`" ><label class="label-check" for="response`+e["id_reponse"]+`">`+e["intitule_reponse"]+`</label>
					<span>`+l+`  <span class="points">`+_+`</span></span>
				</div>
			`});f+=' <div class="points" id="rmq'+i+'"> '+o+" </div>    </form>";return f}}function nouvelle_question(e,i){var r=$("#quiz-form").append(une_question_quiz(e));var t=r[0].lastElementChild;$("#quiz-form").sortable({update:function n(){var e=[];$(".une_question_quiz.ui-sortable-handle").each(function(e,i){nouvelle_position_question_drag=e+1;$(".id_question[value='"+i.getAttribute("name")+"']")[0].value=nouvelle_position_question_drag})}});if(e){t.querySelector("[name='type_question']").innerText=e["type_question"];t.querySelector("[name='intitule_question']").innerText=e["intitule_question"]}if(!i){add_response(t.id)}else{i.forEach(e=>{add_response(e["id_question"],e)})}}function une_question_quiz(e){var i=e?e["id_question"]:$("[name='intitule_question']").length+1;return`
	<div class="une_question_quiz" id="`+i+`"   name="`+i+`" >
		<input type="text" value="`+i+`" name="id_question" class="id_question">
		<div><rouge class="mini-image" style="font-size: 12px;" onclick="help_quiz_resp()">Besoin d'aide?</rouge></div>
		<div name="type_question" id="type_question`+i+`"></div>
		<textarea id="intitule_question" name="intitule_question" type="text" placeholder="Intitulé de la question..."></textarea>
		<div class="top-qstn">
			<rouge class="foot-element" onclick="supprimer_question(`+i+`)"><img src="`+prefixe_image+`/img_trash.png" alt="SUPPRIMER" class="small-icon trash"></rouge>			
	    </div>
	    <div class="reponses_possibles" name="reponses_possibles`+i+`"></div>
    	<div class="foot-qst" style="font-size: 15px;">
		  <bleu class="foot-element" onclick="add_response(`+i+`)">Ajouter une réponse possible</bleu>
		</div>
	</div>
	`}async function supprimer_question(e){$("[name='reponses_possibles"+e+"'] > .une_reponse_possible > [alt='SUPPRIMER'] ").each((e,i)=>{delete_resp(i,true)});var i=get_current_quiz();var r={id_quiz:i,id_question:e};retour=await supprimer_avec_ces_references("Questions",r);$('.une_question_quiz[id="'+e+'"]').remove()}async function delete_resp(e,i){var r=e.parentNode.parentNode;var t=r.children.length>1;if(t||i){var n=get_current_quiz();var a=r.parentNode.id;var s=e.parentNode.id;var o={id_quiz:n,id_question:a,id_reponse:s};retour=await supprimer_avec_ces_references("Reponses",o);e.parentNode.remove();mettre_type_question(r.parentNode.id);return true}else{alert("Vous devez donner au moins une réponse à la question.");return false}}function add_response(e,i){var r=$("[name='reponses_possibles"+e+"']").append(une_reponse_possible(i));var t=r[0].lastElementChild;$("[name='reponses_possibles"+e+"']").sortable({update:function n(){var e=[];$(".une_reponse_possible.ui-sortable-handle").each(function(e,i){nouvelle_position_rps_drag=e+1})}});mettre_type_question(e);$("[name=note_globale]").off("change");$("[name=note_globale]").on("change",function(e){valeur=Number(e.target.value);e.target.style.color=valeur<0?"red":valeur>0?"green":"";var i=e.target.parentNode.parentNode.parentNode.id;mettre_type_question(i);remarque_par_defaut(e.target)});$("[name=note_globale]").change();if(i){t.querySelector("[name='reponse']").value=i["intitule_reponse"];t.querySelector(".remarque_correction").outerHTML=i["remarque_correction"]}}function mettre_type_question(e){var i=element_DOM("type_question"+e);var r=$(".une_question_quiz#"+e+" > .reponses_possibles > .une_reponse_possible > [name='note_globale']");var t="Question en saisie libre";var n=$("[name='reponses_possibles"+e+"']");if(n.length===0)return true;n=n[0];var a=n.children.length;if(a>1){t="Question à choix unique";var s=r.filter(function(){return Number($(this).val())>0}).length;if(s>1){t="Question à choix multiple"}}points_question=0;r.each(function(){valeur=Number($(this).val());if(valeur>0)points_question+=valeur});var o=t+" sur "+points_question.toFixed(2)+" points ";if(i)i.innerText=o;mettre_score_total(true);return o}function mettre_score_total(e){var t=0;$("[name='note_globale']").each((e,i)=>{var r=Number(i.value);if(r>0)t+=r});element_DOM("remarque-quiz").innerText=e?"Votre quiz est noté sur "+t:"";return t}function une_reponse_possible(e){var i=e?e["id_reponse"]:creer_uuid();var r=quiz_mode_lecture()?"":' contenteditable="true" onclick="focus_edit(this)"';var t=!e?"0":Number(e["score"]).toFixed(2);return`<span class="une_reponse_possible" id="`+i+`">
    <input name="reponse" style="width: 55%;" placeholder="Réponse possible et le SCORE de la réponse (liste déroulante)...">`+liste_notes_possibles(true,t,"note_globale")+`
    <img class="small-icon trash" alt="SUPPRIMER" src="`+prefixe_image+`/img_trash.png" onclick="delete_resp(this)">
    <br>
    <bleu class="mini-image remarque_correction wrong" `+r+` >Remarque correction</bleu>
  </span>
  `}function focus_edit(e){setCaret(e)}function setCaret(e){e.focus()}function remarque_par_defaut(e){var i=e.parentNode.querySelector("bleu");var r=i.innerHTML;if(r.length===0||r===valeur_remarque_initiale()||r===valeur_remarque_correct()||r===valeur_remarque_incorrect()){var t=Number(e.value)>0;i.innerHTML=t?valeur_remarque_correct():valeur_remarque_incorrect()}i.style.color=e.style.color}function remarque_correction(e){if(e.innerText.length===0)e.innerText=valeur_remarque_initiale()}function valeur_remarque_correct(){return"✅ Votre réponse est correcte."}function valeur_remarque_incorrect(){return"❌ Votre réponse est incorrecte."}function valeur_remarque_initiale(){return"Remarque correction"}function help_quiz_resp(){if($(".une_reponse_possible").length>0){var e="Le type de question se mettra à jour en fonction du nombre de réponses possibles ET du nombre de réponses justes.\n\n\n";e+="• Score positif=bonne réponse\n• Score nul=mauvaise réponse\n• Score négatif=malus.\n\n\nLa remarque de correction s'affiche lorsque l'utilisateur choisit cette réponse, et peut se personnaliser au clic.";alert(e)}else{alert("Ajoutez d'abord une réponse possible, puis recliquez à nouveau ici.")}}function get_current_quiz(){return recuperer("fichier_ouvert")?recuperer("fichier_ouvert"):recuperer("tmp_quiz")?JSON.parse(recuperer("tmp_quiz"))["id_quiz"]:null}function go_to_step(e,i){if(!recuperer("tmp_quiz")){resultat={id_quiz:creer_uuid()};stocker("tmp_quiz",JSON.stringify(resultat))}if(i===2){saisie_des_questions_responses()}else if(i===1){if(!formulaire_rempli_ok("quiz-form")){element_DOM("etape-quiz").innerText=i;return alert("Vous devez remplir tous les champs avant de continuer.")}resultat=objectifyForm("quiz-form")}resultat["id_quiz"]=JSON.parse(recuperer("tmp_quiz"))["id_quiz"];resultat["id_classe_matiere"]=recuperer("dossier_chargé");resultat["proprietaire"]=recuperer("identifiant_courant");stocker_quiz_local(resultat);if(e===1){init_creation_quiz()}if(e===i){finaliser_edition_quiz()}else if(e===2){crud_questions()}}function finaliser_edition_quiz(){var e=confirm("Êtes-vous sûr d'avoir bien édité les questions-réponses du quiz?");if(e)dernieres_modifs_quiz()}async function dernieres_modifs_quiz(){var e=get_current_quiz();var i={id_quiz:e,id_classe_matiere:recuperer("dossier_chargé"),proprietaire:recuperer("identifiant_courant"),date_publication:maintenant()};await stocker_quiz_local(i);$("#sauvegarder").remove();$("#bye_prev").one("click",function(){$("#categorie_choisie").change();element_DOM("liste_quiz").value=e;effacer("tmp_quiz")});element_DOM("setup").innerText="Vous pouvez fermer cette fenêtre.";await sauvegarde_mode_edit()}function avec_sauvegarde(e){if(e){$("#titre_fenetre").append('<img id="sauvegarder" src="'+prefixe_image+'/img_save.png" alt="💾" onclick="'+e+'" class="icon-save">')}else{$("#sauvegarder").remove()}}function next_step_quiz(){sauvegarder_quiz(true);var e=Number(element_DOM("etape-quiz").innerText);element_DOM("etape-quiz").innerText++;if(element_DOM("etape-quiz").innerText>2)element_DOM("etape-quiz").innerText=2;var i=Number(element_DOM("etape-quiz").innerText);go_to_step(i,e)}function prev_step_quiz(){sauvegarder_quiz(true);var e=Number(element_DOM("etape-quiz").innerText);element_DOM("etape-quiz").innerText--;if(element_DOM("etape-quiz").innerText<1)element_DOM("etape-quiz").innerText=1;var i=Number(element_DOM("etape-quiz").innerText);go_to_step(i,e)}function stocker_quiz_local(i){var e=recuperer("tmp_quiz");if(e&&JSON.parse(e)["id_quiz"]===i["id_quiz"]){Object.keys(i).forEach(e=>{modifier_donnee_locale("tmp_quiz","id_quiz",i["id_quiz"],e,i[e],false)})}else{effacer("tmp_quiz");stocker("tmp_quiz",JSON.stringify(i))}return recuperer("tmp_quiz")}function quiz_mode_run(){return $("[onclick='next_step_quiz()']").length===0}function quiz_mode_lecture(){return quiz_mode_run()&&ma_tentative["date_publication"]?true:false}function quiz_mode_previz(){return $("[onclick='creer_quiz()']").length>0}async function sauvegarder_quiz(e){var i="";var r="";if(quiz_mode_lecture()){r="Vous ne pouvez pas modifier cette tentative.";i=ma_tentative}else if(quiz_mode_run()){r=ma_tentative.reponses&&Object.keys(ma_tentative.reponses).length>0?"Votre tentative a bien été sauvegardée.":"";save_current_submition();i=ma_tentative}else{r=await sauvegarde_mode_edit()}if(r&&!e)afficher_alerte(r);return i}async function sauvegarde_mode_edit(){texte_a_afficher="Votre quiz a bien été sauvegardé.";if($(".une_question_quiz").length>0){saisie_des_questions_responses()}else{texte_a_afficher=await sauvegarder_le_quiz_dans_la_table_quiz()}return texte_a_afficher}async function sauvegarder_le_quiz_dans_la_table_quiz(){if(recuperer("tmp_quiz")){try{var e=JSON.parse(recuperer("tmp_quiz"));await stocker_quiz_server(e);retour=e}catch(i){texte_a_afficher="Votre quiz n'a PAS été sauvegardé: merci de réessayer ou de vérifier votre connexion internet."}}else{texte_a_afficher="Aucune donnée de quiz à sauvegarder: appuyez sur suivant avant d'enregistrer."}return texte_a_afficher}function stocker_quiz_server(e){return supabase.from("Quiz").upsert(e)}function stocker_element_server(e,i){return supabase.from(e).upsert(i)}async function publier_quiz(e,i){date_heure_actuelle=maintenant();mes_donnees=JSON.parse(recuperer("mes_donnees"));la_classe=recuperer("mon_type")==="Eleves"?mes_donnees["Classe"]:la_matiere_chargee("Classe");la_matiere=recuperer("mon_type")==="Eleves"?$("#accueil_utilisateur")[0].innerText:la_matiere_chargee("Matiere");nouveau_fichier={date_publication:date_heure_actuelle,id_fichier:e,nom_fichier:i,id_dossier:recuperer("dossier_chargé"),proprietaire:recuperer("identifiant_courant"),categorie_fichier:"Quiz",date_effet:element_DOM("date_effet_fichier").value,est_telechargeable:"non",taille_fichier:0,destinataire_par_page:null,periode_bulletin:null};try{retour1=await ajouter_un_element("Fichiers",nouveau_fichier,e);id_notif=e+suite_notif();nouvelle_notif={id_notif:id_notif,Horodateur:date_heure_actuelle,Type_notif:"fichier",Id_source:e,"Intitulé":i,Identifiant_originaire:recuperer("identifiant_courant"),Role_originaire:mon_role,Identifiant_derniere_modif:recuperer("identifiant_courant"),Role_derniere_modif:mon_role,Classe:la_classe,Classe_matiere:"("+la_classe+"|"+la_matiere+")",Id_classe_matiere:recuperer("dossier_chargé"),Date_derniere_modif:date_heure_actuelle,Cycle:mes_donnees["Cycle"]};retour2=await ajouter_un_element("Notifs",nouvelle_notif,id_notif);afficher_alerte("Votre quiz a bien été publié.",true)}catch(r){console.error(r);afficher_alerte("Erreur de publication du quiz: vérifiez s'il n'est pas déjà publié.")}chargement(false)}function au_clic(selector,callback){$(selector).off("click");$(selector).on("click",function(event){eval(callback)})}function au_clic_droit(selector,callback){$(selector).off("contextmenu");$(selector).on("contextmenu",function(event){eval(callback)})}function clic_utilisateur(e){creer_mini_popup(e.toUpperCase(),"","Contacter","alert('Vous allez le contacter!')",false,false,false,false,"15","truc")}function ecrire_a(e){ajouter_un_tout_nouveau_msg();$("#Destinataire").val(e);faire_autocompletion_input(null,"Destinataire");$("[onclick=\"choisir('Destinataire',this)\"]").click();afficher_fenetre(true)}